<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>BtrustOn</title>
<!-- UX STABILITY FIXES (prevents horizontal jump on refresh / scroll lock) -->
<style id="ux-stability-fixes">
/* Layout: bring content slightly closer to the edges (outer container only) */
:root{
  --bton-shell-max: 85rem;   /* was Tailwind 7xl = 80rem */
  --bton-shell-vw: 96vw;     /* keep a soft margin on ultra-wide screens */
}
.max-w-7xl{
  max-width: min(var(--bton-shell-max), var(--bton-shell-vw)) !important;
}

    html { scrollbar-gutter: stable; }
    html, body { overflow-x: hidden; }
  
    /* --- Overview: soft + minimal + premium --- */
    .bton-overview-tagline{
      color: rgba(15,23,42,.78);
      letter-spacing: .01em;
    }
    .bton-overview-desc{
      color: rgba(15,23,42,.72);
      font-size: 15px;
      line-height: 1.85;
      font-weight: 400;
    }
    @media (min-width: 768px){
      .bton-overview-desc{ font-size: 16px; }
    }
    .bton-chip-soft{
      display: inline-flex;
      align-items: center;
      gap: .55rem;
      padding: .55rem 1rem;
      border-radius: 9999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .bton-chip-soft:hover{
      border-color: rgba(15,23,42,.14);
      background: rgba(255,255,255,.72);
      transform: translateY(-1px);
    }
    .bton-chip-soft i{
      color: var(--bton-accent);
      opacity: .9;
      font-size: .9rem;
    }


/* --- Soft focus inputs (Partner Login) --- */
.bton-login-input{
  width:100%;
  border:1px solid rgba(148,163,184,.42); /* slate */
  background: rgba(255,255,255,.72);
  border-radius: 14px;
  padding: 12px 14px;
  font-size: 14px;
  line-height: 1.2;
  outline: none;
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.bton-login-input::placeholder{ color: rgba(100,116,139,.75); }
/* calmer focus (no turquoise) */
.bton-login-input:focus,
.bton-login-input:focus-visible{
  border-color: rgba(100,116,139,.55); /* slate */
  box-shadow: 0 0 0 3px rgba(15,23,42,.06); /* soft gray ring */
  background: rgba(255,255,255,.92);
}
/* --- Mobile cleanup: keep Updates header compact --- */
@media (max-width: 640px){
  .bton-hide-mobile{ display:none !important; }
}



    /* --- Mobile: Edit button under location/sector chips (icon-only, avoids name wrap issues) --- */
#btn-edit-profile .bton-edit-label{ display:none; }
#p-edit-mobile-slot:empty{ display:none; }
@media (max-width: 640px){
  #p-edit-mobile-slot{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    margin-top: 8px;
  }
  #btn-edit-profile.bton-edit-pill{
    width:42px !important;
    height:42px !important;
    padding:0 !important;
    border-radius:9999px !important;
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    gap:0 !important;
  }
    /* tighten vertical space under the mobile edit icon */
  #profile-header-wrap{ padding-bottom: 24px !important; }
  #profile-header-wrap + main{ padding-top: 20px !important; }
#btn-edit-profile.bton-edit-pill .bton-edit-label{ display:none !important; }
}

/* --- Mobile: Profile tabs 2x2 grid (no horizontal scroll) --- */
    @media (max-width: 640px){
      .bton-profile-tabbar{
        display:grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap:12px !important;
        overflow: visible !important;
        border-bottom: 0 !important;
        padding-bottom: 10px;
      }
      .bton-profile-tabbar > button{
        width:100% !important;
        justify-content:center !important;
        border-radius:9999px !important;
        border: 1px solid rgba(0,0,0,.10) !important;
        border-bottom-width:1px !important;
      }
      .bton-profile-tabbar > button[class*="border-BTrustOn-accent"]{
        border-color: var(--BTrustOn-accent, #0ea5e9) !important;
      }
    }


  /* Long text wrap helpers */
  .bton-wrap-anywhere{ overflow-wrap:anywhere; word-break:break-word; }


/* Inbox tab icon: show on desktop, hide on mobile */
.bton-inbox-tab-icon{display:inline-block;vertical-align:middle;}
@media (max-width: 640px){
  .bton-inbox-tab-icon{display:none !important;}
}
</style>
<style id="bton-apple-premium-skin">
  :root{
    --bton-apple-bg:#f5f5f7;
    --bton-apple-text:#1d1d1f;
    --bton-apple-sub:#6e6e73;
    --bton-apple-border:rgba(15,23,42,.10);
  }

  /* Apple-like backdrop (subtle, calm) */
  body{
    background:
      radial-gradient(1100px 520px at 50% -20%, rgba(255,255,255,.98), rgba(245,245,247,1) 60%),
      #f5f5f7 !important;
  }

  /* HERO: premium / Apple-ish */
  header{
    padding-top: 26px !important;
    padding-bottom: 22px !important;
    border-bottom: 1px solid rgba(15,23,42,.06);
    background: radial-gradient(900px 420px at 50% 0%, rgba(255,255,255,.95), rgba(245,245,247,0) 68%);
  }
  header .pointer-events-none{ opacity:.28; filter: saturate(.65); }
/* Profile Editor: subtle premium stripe (only in editor header) */
.bton-editor-hero{
  position: relative;
  overflow: hidden;
  background:
    linear-gradient(90deg,
      rgba(14,165,233,.10) 0%,
      rgba(99,102,241,.08) 45%,
      rgba(236,72,153,.06) 100%),
    radial-gradient(900px 340px at 30% 0%,
      rgba(255,255,255,.88) 0%,
      rgba(255,255,255,0) 70%),
    #f8fafc;
}
.bton-editor-hero::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:-1px;
  height:88px;
  background: linear-gradient(to bottom, rgba(248,250,252,0), rgba(248,250,252,1));
  pointer-events:none;
}
/* Keep editor title/subtitle crisp */
.bton-editor-hero h1{ color: rgba(15,23,42,.92); }
.bton-editor-hero p{ color: rgba(51,65,85,.86); }
.bton-editor-hero button{ color: rgba(51,65,85,.88); }

  /* Signed-in HERO: compact (less vertical space) */
  header.bton-hero-compact{
    /* Signed-in hero: still minimal, but a touch more breathing room */
    padding-top: 22px !important;
    padding-bottom: 16px !important;
  }
  header.bton-hero-compact #hero-title{
    font-size: clamp(1.65rem, 2.35vw, 2.55rem) !important;
    line-height: 1.12 !important;
    margin-bottom: 12px !important;
  }
  /* Small gap between "Improve Profile" and search */
  header.bton-hero-compact #hero-cta{
    margin-bottom: 10px !important;
  }

  header.bton-hero-compact #hero-search-wrap{
    margin-top: 0 !important;
    margin-bottom: 12px !important;
  }


  /* Apple-style hero search bar */
  #hero-search-wrap .bton-apple-search-halo{
    opacity: .22 !important;
    filter: blur(18px) !important;
  }
  #hero-search-wrap .bton-apple-search{
    background: rgba(255,255,255,.72) !important;
    border: 1px solid rgba(15,23,42,.10) !important;
    border-radius: 9999px !important;
    box-shadow: 0 14px 34px -26px rgba(15,23,42,.55) !important;
    backdrop-filter: blur(18px) !important;
    transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
  }
  #hero-search-wrap .bton-apple-search:focus-within{
    border-color: rgba(14,165,233,.35) !important;
    box-shadow: 0 18px 44px -28px rgba(14,165,233,.55) !important;
    transform: translateY(-1px);
  }
  #hero-search-wrap .bton-apple-search i{
    animation: none !important;
    opacity: .72 !important;
    filter: none !important;
  }
  #hero-search-wrap .bton-apple-search-input{
    font-weight: 500 !important;
    letter-spacing: -0.01em !important;
    color: rgba(15,23,42,.92) !important;
  }
  #hero-search-wrap .bton-apple-search-input::placeholder{
    color: rgba(15,23,42,.45) !important;
    font-weight: 500 !important;
  }
  #hero-search-wrap .bton-apple-search-btn{
    position: relative;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    background: linear-gradient(180deg, rgba(6,182,212,.92), rgba(8,145,178,.92)) !important;
    border: 1px solid rgba(255,255,255,.18) !important;
    color: rgba(255,255,255,.98) !important;
    border-radius: 9999px !important;
    box-shadow: 0 10px 26px rgba(6,182,212,.28), 0 1px 0 rgba(255,255,255,.18) inset !important;
    transition: filter .18s ease, transform .18s ease, box-shadow .18s ease;
    will-change: transform, box-shadow, filter;
  }
  #hero-search-wrap .bton-apple-search-btn::before{
    content:"";
    position:absolute;
    inset:0;
    background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.24), rgba(255,255,255,0) 55%);
    opacity:0;
    transition: opacity .18s ease;
    pointer-events:none;
  }
  #hero-search-wrap .bton-apple-search-btn::after{
    content:"";
    position:absolute;
    top:-60%;
    left:-65%;
    width:45%;
    height:220%;
    transform: rotate(20deg) translateX(-40%);
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.38), rgba(255,255,255,0));
    opacity:0;
    transition: transform .65s ease, opacity .22s ease;
    pointer-events:none;
  }
  #hero-search-wrap .bton-apple-search-btn:hover{
    filter: brightness(1.06) saturate(1.08);
    box-shadow: 0 16px 36px rgba(6,182,212,.38), 0 1px 0 rgba(255,255,255,.20) inset !important;
    transform: translateY(-1px);
  }
  #hero-search-wrap .bton-apple-search-btn:hover::before{ opacity:1; }
  #hero-search-wrap .bton-apple-search-btn:hover::after{
    opacity:1;
    transform: rotate(20deg) translateX(260%);
  }
  #hero-search-wrap .bton-apple-search-btn:active{
    transform: translateY(0) scale(.985);
    filter: brightness(.98) saturate(1.02);
    box-shadow: 0 10px 22px rgba(6,182,212,.26), 0 1px 0 rgba(255,255,255,.14) inset !important;
  }
  #hero-search-wrap .bton-apple-search-btn:focus-visible{
    outline: none !important;
    box-shadow: 0 0 0 4px rgba(6,182,212,.22), 0 10px 26px rgba(6,182,212,.28), 0 1px 0 rgba(255,255,255,.18) inset !important;
  }
  @media (pointer: coarse){
    /* Avoid "sticky hover" on touch devices */
    #hero-search-wrap .bton-apple-search-btn:hover{ transform: none; }
    #hero-search-wrap .bton-apple-search-btn:hover::after{
      opacity:0;
      transform: rotate(20deg) translateX(-40%);
    }
  }

#hero-title{
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif !important;
    letter-spacing: -0.035em;
    color: var(--bton-apple-text) !important;
    text-shadow: none !important;
  }
  #hero-title, #hero-title *{
    color: var(--bton-apple-text) !important;
  }
  #hero-desc{
    color: var(--bton-apple-sub) !important;
    line-height: 1.65 !important;
  }

  /* CTA: calmer shadow */
  #hero-cta .bton-pill-primary{
    box-shadow: 0 14px 30px -18px rgba(15,23,42,.55);
  }

  /* --- MOBILE: hide "live showcase" until search (clean feed-first UX) --- */
@media (max-width: 768px){
  /* Mobile: feed-first. Show filters + results only after search becomes active */
  body:not(.bton-mobile-search-active) #live-showcase{
    display:none !important;
  }
  body.bton-mobile-search-active #live-showcase{
    display:flex !important;
    flex-direction:column;
    gap:10px;
    margin-top:12px !important;
    padding:10px 12px;
    border-radius:16px;
    background: rgba(255,255,255,.62);
    border: 1px solid rgba(15,23,42,.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* Hide company cards by default; show only after user searches */
  body:not(.bton-mobile-search-active) #card-container{
    display:none !important;
  }

  /* When showing results, keep spacing tight & readable */
  body.bton-mobile-search-active #card-container{
    margin-top: 10px !important;
    margin-bottom: 18px !important;
  }

  /* Mobile filter layout: bigger tap targets, less cramping */
  #live-showcase > div:first-child{
    font-size: 14px;
    line-height: 1.2;
    opacity: .9;
  }
  #live-showcase .flex.flex-wrap{
    display:grid !important;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    width:100%;
  }
  @media (max-width: 420px){
    #live-showcase .flex.flex-wrap{
      grid-template-columns: 1fr;
    }
  }
  #live-showcase select{
    width:100% !important;
    min-height:44px;
    padding-top: 10px !important;
    padding-bottom: 10px !important;
    border-radius:14px !important;
    font-size:14px !important;
  }
}

/* HOME UPDATES rail: looks like an Apple cards shelf */
  .bton-updates-wrap::before,
  .bton-updates-wrap::after{
    content:"";
    position:absolute;
    top:0; bottom:0;
    width:56px;
    pointer-events:none;
    z-index:5;
  }
  .bton-updates-wrap::before{
    left:0;
    background: linear-gradient(90deg, rgba(245,245,247,1), rgba(245,245,247,0));
  }
  .bton-updates-wrap::after{
    right:0;
    background: linear-gradient(270deg, rgba(245,245,247,1), rgba(245,245,247,0));
  }
  .bton-updates-rail{
    scroll-padding-left: 14px;
    scroll-padding-right: 14px;
    -webkit-overflow-scrolling: touch;
  }

  .bton-updates-nav{
    position:absolute;
    top:50%;
    transform: translateY(-50%);
    z-index:6;
    width:38px;
    height:38px;
    border-radius:9999px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,.82);
    border: 1px solid rgba(15,23,42,.10);
    box-shadow: 0 12px 30px -22px rgba(15,23,42,.65);
    backdrop-filter: blur(12px);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    transition: transform .18s ease, background .18s ease, box-shadow .18s ease, opacity .18s ease;
  }
  .bton-updates-nav:hover{ background: rgba(255,255,255,.92); }
  .bton-updates-nav:active{ transform: translateY(-50%) scale(.96); }
  .bton-updates-nav:disabled{ opacity:.35; cursor:not-allowed; }
  .bton-updates-nav-left{ left: 6px; }
  .bton-updates-nav-right{ right: 6px; }

  /* Cards */
  .bton-upd-card{ border-radius: 18px !important; }
  .bton-upd-card:focus-visible{
    outline:none;
    box-shadow: 0 0 0 4px rgba(59,130,246,.14), 0 20px 45px -28px rgba(15,23,42,.60);
  }
  .bton-upd-note{
    background: rgba(255,255,255,.86) !important;
    border-color: rgba(15,23,42,.10) !important;
  }

  
  /* Auto-flow mode: disable snap & smooth to allow continuous movement */
  .bton-updates-autoflow{
    scroll-snap-type: none !important;
    scroll-behavior: auto !important;
  }

  @media (max-width: 640px){
    header{ padding-top: 18px !important; }
    .bton-updates-wrap::before, .bton-updates-wrap::after{ width: 34px; }
    .bton-updates-nav{ width:34px; height:34px; }
    .bton-updates-nav-left{ left: 4px; }
    .bton-updates-nav-right{ right: 4px; }
  
/* Company Updates â€“ mobile touch optimization */
#home-updates-head{
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 10px !important;
  margin-bottom: 10px !important;
}
/* Filter pills */
#home-updates-filter{
  width: 100% !important;
  display: flex !important;
  gap: 6px !important;
  padding: 4px !important;
  border-radius: 9999px !important;
}
#home-updates-filter button{
  flex: 1 1 0% !important;
  min-height: 42px !important; /* bigger tap target */
  padding: 10px 12px !important;
  font-size: 12.5px !important;
  line-height: 1 !important;
  border-radius: 9999px !important;
  -webkit-tap-highlight-color: transparent !important;
}

/* Post Update button (if visible) */
#btn-open-post-update{
  width: 100% !important;
  justify-content: center !important;
  min-height: 44px !important;
  padding: 12px 14px !important;
  border-radius: 16px !important;
  font-size: 13px !important;
  letter-spacing: .01em !important;
}

/* Updates shelf: bigger cards, easier swipe */
#home-updates{
  gap: 12px !important;
  padding-left: 12px !important;
  padding-right: 12px !important;
  scroll-padding-left: 12px !important;
  scroll-padding-right: 12px !important;
}
#home-updates .bton-upd-card{
  min-width: 86vw !important;
  max-width: 86vw !important;
}

/* On mobile, rely on swipe (avoid accidental taps on arrows) */
#home-updates-left, #home-updates-right{
  display: none !important;
}
}
</style>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Oswald:wght@500;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
/* =========================
   TIME TRAVEL (TESTING)
   - Leave __TEST_NOW_ISO__ = null for real time
   - Or set to an ISO string, e.g. "2027-01-10T12:00:00+03:00"
   - Optional: set localStorage key STRABON_TEST_NOW to an ISO string to override without editing code
   - To turn off localStorage override: localStorage.setItem("STRABON_TEST_NOW","off")
========================= */
const __TEST_NOW_ISO__ = null;
const __REAL_DATE_NOW__ = Date.now.bind(Date);

function _getTestNowISO() {
  try {
    const v = localStorage.getItem("STRABON_TEST_NOW");
    if (v && v !== "off" && v !== "null") return v;
  } catch(e) {}
  return __TEST_NOW_ISO__;
}
function nowTs() {
  const iso = _getTestNowISO();
  return iso ? new Date(iso).getTime() : __REAL_DATE_NOW__();
}
function nowDate() { return new Date(nowTs()); }
function nowISO() { return nowDate().toISOString(); }


function getUILang() {
  try {
    return (window.currentLang || localStorage.getItem("bton_lang") || localStorage.getItem("lang") || document.documentElement.lang || "en");
  } catch (e) { return "en"; }
}
function formatMsgClock(dateLike) {
  const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
  const lang = (getUILang() || "en").toLowerCase();
  const isTR = lang.startsWith("tr");
  // For Turkish we still show 12h with Ã–Ã–/Ã–S as requested (AM/PM in Turkish)
  const opts = { hour: "2-digit", minute: "2-digit", hour12: true };
  let s = d.toLocaleTimeString(isTR ? "tr-TR" : undefined, opts);
  if (isTR) s = s.replace(/\bAM\b/i, "Ã–Ã–").replace(/\bPM\b/i, "Ã–S");
  return s;
}

function formatDateTimeMeridiemTR(dateLike){
  try {
    const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
    if (isNaN(d.getTime())) return "";
    const lang = (getUILang() || currentLang || "en").toLowerCase();
    const isTR = lang.startsWith("tr");
    const datePart = d.toLocaleDateString(isTR ? "tr-TR" : undefined);
    return datePart + " " + formatMsgClock(d);
  } catch(e){ return ""; }
}



// ==== TIME TRAVEL: Console helpers + visible badge ====
try {
  window.__STRABON_nowISO = nowISO;
  window.__STRABON_nowTs = nowTs;
  window.__STRABON_setTestNow = (iso)=>{ localStorage.setItem("STRABON_TEST_NOW", iso); location.reload(); };
  window.__STRABON_clearTestNow = ()=>{ localStorage.setItem("STRABON_TEST_NOW","off"); location.reload(); };
} catch(e) {}

/* =========================
   HARDENING: ACTION LOCKS + SUB/INTERVAL DEDUPE
   - Prevents double-click/double-submit duplicates
   - Ensures realtime channels/intervals don't stack
========================= */
const __BTON_LOCKS = new Map();
function btonLockKey(key, ttlMs = 12000) {
  try {
    const now = Date.now();
    const until = __BTON_LOCKS.get(key);
    if (until && until > now) return false;
    __BTON_LOCKS.set(key, now + ttlMs);
    return true;
  } catch (e) { return true; }
}
function btonUnlockKey(key) {
  try { __BTON_LOCKS.delete(key); } catch (e) {}
}
async function btonWithLock(key, fn, opts) {
  const o = opts || {};
  const ttl = (typeof o.ttlMs === "number") ? o.ttlMs : 12000;
  const el = o.el || null;
  const busyHTML = (typeof o.busyHTML === "string") ? o.busyHTML : null;

  if (!btonLockKey(key, ttl)) return;

  let prev = null;
  try {
    if (el) {
      prev = { disabled: !!el.disabled, html: el.innerHTML, text: el.textContent };
      el.disabled = true;
      el.setAttribute("aria-busy", "true");
      if (busyHTML) el.innerHTML = busyHTML;
    }
    return await fn();
  } finally {
    try {
      if (el && prev) {
        el.disabled = prev.disabled;
        el.removeAttribute("aria-busy");
        if (busyHTML) el.innerHTML = prev.html;
      }
    } catch (e) {}
    btonUnlockKey(key);
  }
}

// Interval registry (guards accidental double-start)
window.__BTON_INTERVALS = window.__BTON_INTERVALS || Object.create(null);
function btonSetInterval(name, fn, ms) {
  const reg = window.__BTON_INTERVALS;
  if (reg[name]) { try { clearInterval(reg[name]); } catch (e) {} }
  reg[name] = setInterval(fn, ms);
  return reg[name];
}
function btonClearInterval(name) {
  const reg = window.__BTON_INTERVALS;
  if (reg && reg[name]) { try { clearInterval(reg[name]); } catch (e) {} delete reg[name]; }
}

// Channel registry (guards accidental double-subscribe)
window.__BTON_CHANNELS = window.__BTON_CHANNELS || Object.create(null);
function btonSetChannel(name, channel) {
  const reg = window.__BTON_CHANNELS;
  if (reg[name]) {
    try {
      if (typeof supabaseClient !== "undefined" && supabaseClient && typeof supabaseClient.removeChannel === "function") {
        supabaseClient.removeChannel(reg[name]);
      }
    } catch (e) {}
  }
  reg[name] = channel;
  return channel;
}
function btonClearChannel(name) {
  const reg = window.__BTON_CHANNELS;
  if (reg && reg[name]) {
    try {
      if (typeof supabaseClient !== "undefined" && supabaseClient && typeof supabaseClient.removeChannel === "function") {
        supabaseClient.removeChannel(reg[name]);
      }
    } catch (e) {}
    delete reg[name];
  }
}

document.addEventListener("DOMContentLoaded", () => {
  try {
    const iso = _getTestNowISO();
    if (!iso) return;

    const b = document.createElement("div");
    b.className = "fixed top-3 right-3 z-[9999] rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-900 shadow";
    const dt = new Date(iso);
    b.innerHTML = `
      <div class="font-semibold tracking-wide">TEST TIME ACTIVE</div>
      <div class="mt-0.5">Now: <span class="font-mono">${dt.toLocaleString()}</span></div>
      <button id="tt-off" class="mt-2 inline-flex items-center justify-center rounded-lg bg-amber-900 px-2 py-1 text-[11px] font-semibold text-amber-50">Turn off</button>
    `;
    document.body.appendChild(b);
    b.querySelector("#tt-off")?.addEventListener("click", () => {
      localStorage.setItem("STRABON_TEST_NOW","off");
      location.reload();
    });
  } catch(e) {}
});

    tailwind.config = {
      theme: {
        extend: {
          colors: {
            BTrustOn: {
              primary: "#0F172A",
              accent: "#06b6d4",
              darkAccent: "#0891b2",
              surface: "#F8FAFC",
              border: "#E2E8F0",
              text: "#334155",
            },
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
            header: ["Oswald", "sans-serif"],
          },
          boxShadow: {
            glass: "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
            float: "0 20px 40px -5px rgba(6, 182, 212, 0.15)",
            glow: "0 0 15px rgba(6, 182, 212, 0.4)",
          },
        },
      },
    };

  </script>
<style>
    .hidden-view {
      display: none !important;
    }
/* Marka Rengi Stili */
.toast.brand { border-color: #06b6d4 !important; }
.toast.brand i { color: #06b6d4 !important; }
    .fade-in {
      animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Text clamp helpers (Tailwind-like line-clamp utilities) */
    .line-clamp-1,
    .line-clamp-2,
    .line-clamp-3,
    .line-clamp-4,
    .line-clamp-5,
    .clamp-4{
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .line-clamp-1{ -webkit-line-clamp: 1; }
    .line-clamp-2{ -webkit-line-clamp: 2; }
    .line-clamp-3{ -webkit-line-clamp: 3; }
    .line-clamp-4, .clamp-4{ -webkit-line-clamp: 4; }
    .line-clamp-5{ -webkit-line-clamp: 5; }

    /* Hover hint for clickable cards */
    .bton-view-hint{
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .18s ease, transform .18s ease, background-color .18s ease, color .18s ease, border-color .18s ease;
    }
    .group:hover .bton-view-hint,
    .group:focus-within .bton-view-hint{
      opacity: 1;
      transform: translateY(0);
    }
.modal {
      transition: opacity 0.25s ease;
    }
    body.modal-active {
      overflow-x: hidden;
      overflow-y: visible !important;
    }
    /* Cropper: allow pan/zoom without the page stealing the gesture */
    #modal-cropper .cropper-container { touch-action: none; }
    #modal-cropper .cropper-face, #modal-cropper .cropper-view-box { cursor: grab; }
    #modal-cropper .cropper-face:active { cursor: grabbing; }
    .dot-map-bg {
      background-image: radial-gradient(rgba(148,163,184,.55) 1px, transparent 1px);
      background-size: 32px 32px;
    }
    /* EditÃ¶r input stilleri */
    .input-field:focus {
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.1);
        border-color: #06b6d4;
    }

    /* --- Editor section focus flash (used when jumping directly to Services & Capabilities etc.) --- */
    .bton-focus-flash { position: relative; }
    .bton-focus-flash::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius: 18px;
      pointer-events:none;
      box-shadow: 0 0 0 3px rgba(6,182,212,0.22), 0 18px 44px rgba(6,182,212,0.10);
      animation: btonFlash 1.25s ease-out forwards;
    }
    @keyframes btonFlash{
      0% { opacity: 1; transform: scale(0.995); }
      100% { opacity: 0; transform: scale(1.01); }
    }

/* Ã–zel Scrollbar TasarÄ±mÄ± */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
/* TOAST NOTIFICATION STYLES */
    #toast-container {
      position: fixed;
      top: max(20px, calc(var(--bton-nav-h) + 12px));
      right: 20px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      min-width: 300px;
      background: white;
      border-left: 4px solid;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out forwards;
      opacity: 0;
      transform: translateX(100%);
    }

    /* --- Mobile polish: toast + panels + iOS input zoom --- */
    @media (max-width: 420px){
      #toast-container{ left: 12px; right: 12px; }
      .toast{ min-width: 0 !important; width: 100% !important; border-radius: 14px; }
    }
    @media (max-width: 640px){
      #inbox-panel, #saved-panel{ width: 100vw !important; max-width: 100vw !important; height: 100dvh !important; border-radius: 0 !important; }
      input, textarea, select{ font-size: 16px !important; }
    }


    .toast.success { border-color: #10b981; } /* YeÅŸil */
    .toast.error { border-color: #ef4444; }   /* KÄ±rmÄ±zÄ± */

    .toast i { font-size: 18px; }
    .toast.success i { color: #10b981; }
    .toast.error i { color: #ef4444; }

    .toast-content { flex: 1; }
    .toast-title { font-weight: bold; font-size: 14px; color: #1f2937; display: block; margin-bottom: 2px;}
    .toast-msg { font-size: 12px; color: #6b7280; }

    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(10px); }
    }
/* ... BurasÄ± eski CSS kodlarÄ±nÄ±zÄ±n bittiÄŸi yer ... */

    /* ðŸ‘‡ðŸ‘‡ðŸ‘‡ BURAYA YAPIÅžTIRIN ðŸ‘‡ðŸ‘‡ðŸ‘‡ */

    /* --- SIGNATURE INBOX STYLES --- */
    #inbox-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px); /* Buzlu cam efekti */
      border-left: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: -10px 0 30px rgba(15, 23, 42, 0.15);
      z-index: 9999;
      transform: translateX(100%); /* BaÅŸlangÄ±Ã§ta gizli */
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    #inbox-panel.open {
      transform: translateX(0); /* AÃ§Ä±lÄ±nca gelir */
    }

    /* --- SAVED PANEL (Saved & Following) --- */
    #saved-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 420px;
      max-width: 92vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(12px);
      border-left: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: -10px 0 30px rgba(15, 23, 42, 0.15);
      z-index: 9989;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #saved-panel.open { transform: translateX(0); }

    .saved-item {
      border: 1px solid rgba(226, 232, 240, 0.9);
      background: rgba(255,255,255,0.9);
      transition: all 0.2s ease;
    }
    .saved-item:hover {
      border-color: rgba(6, 182, 212, 0.45);
      background: rgba(6, 182, 212, 0.04);
    }
    .saved-note {
      background: rgba(241, 245, 249, 0.65);
      border: 1px solid rgba(226, 232, 240, 0.9);
    }
    .saved-note:focus {
      outline: none;
      border-color: rgba(6, 182, 212, 0.7);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15);
    }


    .inbox-item {
      position: relative;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .inbox-item:hover {
      background: rgba(6, 182, 212, 0.05); /* Hoverda hafif turkuaz */
    }

    .inbox-item.unread {
      background: white;
      border-left-color: #06b6d4; /* OkunmamÄ±ÅŸsa sol taraf turkuaz */
    }
    
    .inbox-item.unread::after {
      content: '';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 8px;
      height: 8px;
      background: #ef4444; /* KÄ±rmÄ±zÄ± nokta */
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
      animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* ðŸ‘†ðŸ‘†ðŸ‘† BURADA BÄ°TÄ°YOR ðŸ‘†ðŸ‘†ðŸ‘† */

  

    /* =========================================================
       BTrustOn â€“ Premium UI Refresh (Messages + My Lists)
       Scope: navbar buttons + Inbox/Saved panels
       ========================================================= */

    :root{
      --bton-primary: #0F172A;
      --bton-accent:  #06b6d4;
      --bton-accent-dark: #0891b2;

      --bton-ink: rgba(15,23,42,.88);
      --bton-ink-soft: rgba(15,23,42,.68);

      --bton-line: rgba(15,23,42,.10);
      --bton-line-2: rgba(15,23,42,.14);

      --bton-surface: rgba(255,255,255,.86);
      --bton-surface-strong: rgba(255,255,255,.94);
      --bton-surface-soft: rgba(248,250,252,.78);

      --bton-shadow: 0 26px 70px rgba(2,6,23,.20);
      --bton-shadow-sm: 0 14px 34px rgba(2,6,23,.12);

      --bton-focus: 0 0 0 4px rgba(6,182,212,.18);
    }

    
    /* Hero subtle gradient (logo-aligned) */
    .bton-hero-gradient{
      position:absolute; inset:0;
      background:
        radial-gradient(860px 380px at 18% 0%, rgba(6,182,212,.11), transparent 65%),
        radial-gradient(640px 340px at 82% 6%, rgba(8,145,178,.09), transparent 62%),
        linear-gradient(180deg, rgba(15,23,42,.03), rgba(255,255,255,0));
      pointer-events:none;
    }
    /* Hero title: premium subtle gradient text */
    .bton-hero-title-grad{
      background: linear-gradient(90deg, rgba(15,23,42,1) 0%, rgba(15,23,42,1) 72%, rgba(8,145,178,.70) 110%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Hero title lockup (B2B emphasized) */
    .bton-hero-h1{
      display:inline-flex;
      align-items:baseline;
      justify-content:center;
      gap:.45rem;
      flex-wrap:wrap;
    }
    .bton-hero-h1-b2b{
      position:relative;
      background: linear-gradient(90deg, rgba(6,182,212,1) 0%, rgba(8,145,178,1) 62%, rgba(15,23,42,1) 155%);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .bton-hero-h1-b2b::after{
      content:'';
      position:absolute;
      left:.08em; right:.08em;
      bottom:-.16em;
      height:3px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(6,182,212,.85), rgba(8,145,178,.55));
      opacity:.55;
    }
    .bton-hero-h1-rest{
      color: rgba(15,23,42,.92);
    }
    .bton-hero-h1-sep{
      color: rgba(15,23,42,.38);
      font-weight: 800;
      margin: 0 .08rem;
    }
    .bton-hero-h1-action{
      background: linear-gradient(90deg, rgba(15,23,42,1) 0%, rgba(8,145,178,.96) 110%);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
/* --- Profile Tabs: unified premium typography --- */
    .bton-tab-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .bton-tab-title{
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--bton-primary);
    }
    @media (min-width: 768px){
      .bton-tab-title{ font-size: 14px; }
    }
    .bton-panel{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.70));
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(2,6,23,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .bton-accent-line{
      position:absolute;
      top:0; left:0; right:0;
      height:2px;
      background: linear-gradient(90deg, rgba(6,182,212,.75), rgba(56,189,248,.35), transparent);
      opacity:.85;
      pointer-events:none;
    }

    /* --- Add buttons: minimal premium (Projects / Certificates / Assets) --- */
    .bton-add-btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 9px 14px 9px 10px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(15,23,42,.72);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, color .18s ease;
      user-select:none;
      white-space: nowrap;
    }
    .bton-add-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(6,182,212,.28);
      background: rgba(236,254,255,.50);
      box-shadow: 0 16px 38px rgba(2,6,23,.10);
      color: rgba(15,23,42,.92);
    }
    .bton-add-btn:active{
      transform: translateY(0);
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
    }
    .bton-add-btn:focus{
      outline: none;
      border-color: rgba(6,182,212,.40);
      box-shadow: var(--bton-focus), 0 16px 38px rgba(2,6,23,.10);
    }
    .bton-add-ic{
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(15,23,42,.98), rgba(15,23,42,.86));
      color: rgba(255,255,255,.95);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 10px 18px rgba(2,6,23,.16);
      position: relative;
      flex: 0 0 auto;
    }
    .bton-add-ic::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: 13px;
      border: 1px solid rgba(6,182,212,.22);
      opacity:.45;
      pointer-events:none;
    }
    .bton-add-btn:hover .bton-add-ic{
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 14px 24px rgba(2,6,23,.20);
    }
    .bton-add-ic i{ font-size: 13px; }
    .bton-add-txt{ line-height: 1; }


    /* --- Navbar: premium icon (Messages) --- */
    .bton-nav-icon{
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.72));
      border: 1px solid var(--bton-line);
      box-shadow: 0 10px 26px rgba(2,6,23,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      color: var(--bton-ink-soft);
    }
    .bton-nav-icon:hover{
      transform: translateY(-1px);
      border-color: rgba(6,182,212,.36);
      box-shadow: 0 16px 40px rgba(2,6,23,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(241,245,249,.72));
    }
    .bton-nav-icon:active{ transform: translateY(0px); }
    .bton-nav-icon:focus-visible{
      outline: none;
      box-shadow: 0 16px 40px rgba(2,6,23,.14), var(--bton-focus);
    }
    .bton-nav-icon i{
      transition: transform .18s ease, color .18s ease, filter .18s ease;
      filter: drop-shadow(0 6px 18px rgba(2,6,23,.08));
    }
    .bton-nav-icon:hover i{
      color: var(--bton-accent);
      transform: rotate(-8deg) scale(1.02);
    }

    /* --- Navbar: premium pill (My Lists) --- */
    .bton-nav-pill{
      border: 1px solid var(--bton-line);
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(248,250,252,.70));
      box-shadow: 0 10px 26px rgba(2,6,23,.09);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      color: var(--bton-ink);
      letter-spacing: .02em;
    }
    .bton-nav-pill:hover{
      transform: translateY(-1px);
      border-color: rgba(6,182,212,.32);
      box-shadow: 0 16px 40px rgba(2,6,23,.13);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(241,245,249,.72));
    }
    .bton-nav-pill:focus-visible{
      outline: none;
      box-shadow: 0 16px 40px rgba(2,6,23,.13), var(--bton-focus);
    }
    .bton-nav-pill i{
      color: var(--bton-accent);
      filter: drop-shadow(0 6px 18px rgba(2,6,23,.10));
    }
    .bton-nav-pill span{
      font-weight: 800;
    }


    /* --- Navbar: mini icon wrapper (My Company) --- */
    .bton-nav-mini-ic{
      width: 30px;
      height: 30px;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,.72);
      border: 1px solid var(--bton-line);
      box-shadow: 0 10px 22px rgba(2,6,23,.08);
      color: var(--bton-ink-soft);
      transition: border-color .18s ease, transform .18s ease, box-shadow .18s ease;
    }
    .bton-nav-pill:hover .bton-nav-mini-ic{
      border-color: rgba(6,182,212,.32);
      box-shadow: 0 14px 30px rgba(2,6,23,.12);
      transform: translateY(-1px);
    }
    .bton-nav-mini-ic i{ font-size: 14px; color: var(--bton-accent); }/* --- Guest CTAs: minimal + premium (Partner Login / Join) --- */
.bton-pill-muted{
  color: var(--bton-ink-soft);
}
.bton-pill-primary{
  border-color: rgba(6,182,212,.40) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(236,254,255,.74)) !important;
}
.bton-pill-primary:hover{
  border-color: rgba(6,182,212,.55) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(224,255,255,.78)) !important;
}
.bton-pill-primary .bton-nav-mini-ic{
  background: rgba(236,254,255,.70);
  border-color: rgba(6,182,212,.28);
}
.bton-pill-primary:hover .bton-nav-mini-ic{
  border-color: rgba(6,182,212,.40);
}
.bton-pill-label{
  font-weight: 900;
  letter-spacing: .12em;
}
.bton-cta-ic{ width: 36px; height: 36px; }

    /* --- My Company premium media --- */
    .bton-avatar-premium{
      position: relative;
      border: 1px solid rgba(15,23,42,.10) !important;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.76)) !important;
      box-shadow: 0 20px 55px rgba(2,6,23,.14) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .bton-avatar-premium::before{
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, rgba(6,182,212,.55), rgba(0,120,255,.30), rgba(168,85,247,.16));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events: none;
      opacity: .95;
    }

    .bton-avatar-ring{
      position: relative;
      border: 1px solid rgba(15,23,42,.10) !important;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.78)) !important;
      box-shadow: 0 12px 30px rgba(2,6,23,.10) !important;
    }
    .bton-avatar-ring::before{
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, rgba(6,182,212,.50), rgba(0,120,255,.24), rgba(168,85,247,.12));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events: none;
      opacity: .85;
    }

    /* Editor: make upload previews softer/premium */
    #edit-logo-preview-container{
      border-style: solid !important;
      border-width: 1px !important;
      border-color: rgba(15,23,42,.14) !important;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.80)) !important;
      box-shadow: 0 18px 46px rgba(2,6,23,.10) !important;
    }

    /* --- Editor header: premium top block --- */
    .bton-editor-header{
      background:
        radial-gradient(900px 220px at 10% 0%, rgba(255,255,255,.92), rgba(255,255,255,0) 62%),
        linear-gradient(180deg, rgba(248,250,252,.92), rgba(255,255,255,0));
      border: 1px solid rgba(15,23,42,.08) !important;
      border-radius: 20px !important;
      padding: 18px 18px 22px !important;
      margin-top: 6px !important;
      box-shadow: 0 14px 36px rgba(2,6,23,.07) !important;
    }
    .bton-editor-header #edit-logo-preview-container{
      margin-top: 0 !important;
      border-radius: 24px !important;
    }
    @media (min-width: 1024px){
      .bton-editor-header #edit-logo-preview-container{
        width: 112px !important;
        height: 112px !important;
      }
    }

    /* Sidebar nav: drop the first tab a bit for nicer balance */
    #view-editor .bg-slate-50 nav.sticky{
      margin-top: 14px !important;
    }
    @media (min-width: 768px){
      #view-editor .bg-slate-50 nav.sticky{
        margin-top: 18px !important;
      }
    }

    /* Make section dividers match the header line */
    #editor-form #section-general > h3,
    #editor-form [id^="section-"] > h3{
      border-bottom-color: rgba(15,23,42,.10) !important;
      padding-bottom: 12px !important;
    }


    
    .bton-avatar-uploader{
      border-style: solid !important;
      border-width: 1px !important;
      border-color: rgba(15,23,42,.14) !important;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.82)) !important;
      box-shadow: 0 16px 40px rgba(2,6,23,.09) !important;
    }
    .bton-avatar-uploader i{ color: rgba(15,23,42,.28) !important; }
/* --- Premium badges (navbar) --- */
    .bton-badge{
      position: absolute;
      top: -6px;
      right: -6px;

      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 9999px;

      display: inline-flex;
      align-items: center;
      justify-content: center;

      font-size: 11px;
      font-weight: 900;
      letter-spacing: -0.2px;
      color: #fff;

      /* default (neutral) */
      background: linear-gradient(180deg, rgba(15,23,42,.86) 0%, rgba(15,23,42,.72) 100%);
      border: 1px solid rgba(255,255,255,.72);
      box-shadow: 0 12px 26px rgba(2,6,23,.14);

      transform-origin: center;
      animation: btonBadgeIn .22s ease-out;
    }

    /* Notifications badge: premium jewel red */
    #nav-badge, #mobile-nav-badge{
      background: linear-gradient(180deg, #E52B50 0%, #C81D3E 100%);
      border: 1px solid rgba(255,255,255,.42);
      box-shadow:
        0 6px 14px rgba(200, 29, 62, .22),
        0 14px 30px rgba(200, 29, 62, .18),
        inset 0 1px 0 rgba(255,255,255,.22);
    }

    /* Lists badge: brand accent (calm) */
    #saved-badge{
      background: linear-gradient(180deg, rgba(6,182,212,.92) 0%, rgba(59,130,246,.86) 100%);
      border: 1px solid rgba(255,255,255,.38);
      box-shadow:
        0 10px 26px rgba(6,182,212,.18),
        inset 0 1px 0 rgba(255,255,255,.18);
    }

    @keyframes btonBadgeIn{
      from{ transform: scale(.86); opacity: 0; }
      to{ transform: scale(1); opacity: 1; }
    }
    @keyframes btonBadgePop{
      0%{ transform: scale(.85); }
      55%{ transform: scale(1.08); }
      100%{ transform: scale(1); }
    }
    .bton-badge.bton-pop{ animation: btonBadgePop 220ms ease-out; }


/* --- Premium Pro pill (badges) --- */
.bton-pro-pill{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 9999px;
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .08em;
  text-transform: uppercase;

  /* Minimal + brand-consistent (BTrustOn cyan) */
  color: #0f172a;
  background: linear-gradient(135deg, rgba(6,182,212,.16), rgba(59,130,246,.08));
  border: 1px solid rgba(6,182,212,.28);
  box-shadow: 0 10px 26px rgba(2,6,23,.10);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  white-space: nowrap;
}
.bton-pro-pill i{ font-size: 11px; line-height: 1; }
.bton-pro-pill--mini{ padding: 3px 8px; font-size: 9px; letter-spacing: .06em; }
.bton-pro-pill--sm{ padding: 4px 10px; font-size: 10px; }
.bton-pro-pill--dark{
  color: rgba(255,255,255,.96);
  background: linear-gradient(135deg, rgba(15,23,42,.84), rgba(2,6,23,.78));
  border: 1px solid rgba(6,182,212,.22);
  box-shadow: 0 16px 40px rgba(2,6,23,.34);
}
.bton-pro-pill__ico{
  width: 18px;
  height: 18px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  background: rgba(6,182,212,.14);
  border: 1px solid rgba(6,182,212,.22);
  color: #0891b2;
}
.bton-pro-pill--dark .bton-pro-pill__ico{
  background: rgba(6,182,212,.16);
  border-color: rgba(6,182,212,.22);
  color: #67e8f9;
}
/* Search results scroll alignment */
#live-showcase{ scroll-margin-top: calc(var(--bton-nav-h) + 22px); }
html{ scroll-padding-top: calc(var(--bton-nav-h) + 22px); }

/* Overlay: darker + cleaner cinematic feel */
    #inbox-overlay, #saved-overlay{
      background: rgba(2,6,23,.40) !important;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }

    /* --- Panels: consistent premium surface --- */
    #inbox-panel, #saved-panel{
      background: linear-gradient(180deg, var(--bton-surface), var(--bton-surface-soft)) !important;
      border-left: 1px solid var(--bton-line) !important;
      box-shadow: var(--bton-shadow) !important;
      backdrop-filter: blur(14px) !important;
      -webkit-backdrop-filter: blur(14px) !important;

      transform: translateX(104%) scale(.985) !important;
      transition: transform .42s cubic-bezier(0.16, 1, 0.3, 1) !important;
      will-change: transform;
    }
    #inbox-panel.open, #saved-panel.open{
      transform: translateX(0) scale(1) !important;
    }

    /* Panel width harmony */
    #inbox-panel{ width: 420px !important; max-width: 92vw !important; }
    #saved-panel{ width: 420px !important; max-width: 92vw !important; }

    /* Header: premium deep navy with subtle accent bloom */
    #inbox-panel > div:first-child,
    #saved-panel > div:first-child{
      background:
        radial-gradient(900px 320px at 0% 0%, rgba(6,182,212,.22), transparent 60%),
        radial-gradient(900px 320px at 100% 0%, rgba(59,130,246,.18), transparent 58%),
        linear-gradient(135deg, rgba(11,21,48,.98), rgba(15,23,42,.96) 55%, rgba(11,21,48,.98)) !important;
      border-bottom: 1px solid rgba(255,255,255,.10) !important;
    }
    #inbox-panel > div:first-child::after,
    #saved-panel > div:first-child::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-1px;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(6,182,212,.55), transparent);
      opacity:.9;
      pointer-events:none;
    }

    /* Header close button refinement */
    #inbox-panel > div:first-child button[onclick="toggleInbox()"],
    #saved-panel > div:first-child button[onclick="toggleSavedPanel()"]{
      background: rgba(255,255,255,.10) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      border-radius: 12px !important;
      width: 38px !important;
      height: 38px !important;
      display:flex; align-items:center; justify-content:center;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    #inbox-panel > div:first-child button[onclick="toggleInbox()"]:hover,
    #saved-panel > div:first-child button[onclick="toggleSavedPanel()"]:hover{
      background: rgba(255,255,255,.14) !important;
      border-color: rgba(6,182,212,.34) !important;
      transform: rotate(2deg);
    }

    /* Inbox tabs: segmented premium pills (active state driven by JS classes) */
    #btn-tab-inbox, #btn-tab-sent, #btn-tab-notif{
      padding: 8px 12px !important;
      border-radius: 9999px !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      background: rgba(255,255,255,.06) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    #btn-tab-inbox:hover, #btn-tab-sent:hover, #btn-tab-notif:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10) !important;
    }
    #btn-tab-inbox.border-BTrustOn-accent,
    #btn-tab-sent.border-BTrustOn-accent,
    #btn-tab-notif.border-BTrustOn-accent{
      border-color: rgba(6,182,212,.44) !important;
      background: rgba(255,255,255,.14) !important;
      box-shadow: var(--bton-focus);
    }

    /* Saved tabs: use aria-pressed */
    #saved-tab-btn, #following-tab-btn{
      border-radius: 9999px !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      background: rgba(255,255,255,.06) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 9px 12px !important;
      transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    #saved-tab-btn:hover, #following-tab-btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10) !important;
    }
    #saved-tab-btn[aria-pressed="true"],
    #following-tab-btn[aria-pressed="true"]{
      border-color: rgba(6,182,212,.44) !important;
      background: rgba(255,255,255,.14) !important;
      box-shadow: var(--bton-focus);
    }

    /* Tab counts â€“ crisp */
    #saved-panel-count, #saved-tab-count, #following-tab-count, #inbox-badge-count, #notif-tab-badge, #inbox-tab-badge, #sent-tab-badge{
      border-radius: 9999px !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      background: rgba(255,255,255,.14) !important;
      box-shadow: 0 12px 26px rgba(2,6,23,.16);
    }

    /* Content backgrounds */
    #inbox-content{
      background: linear-gradient(180deg, rgba(248,250,252,.65), rgba(241,245,249,.35)) !important;
    }
    #saved-list, #following-list{
      background: transparent !important;
    }

    /* Inbox/Saved cards: premium lift + calm borders */
    .inbox-item, .saved-item{
      border: 1px solid rgba(15,23,42,.08) !important;
      background: rgba(255,255,255,.92) !important;
      box-shadow: 0 8px 22px rgba(2,6,23,.08) !important;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .inbox-item:hover, .saved-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(2,6,23,.12) !important;
      border-color: rgba(6,182,212,.22) !important;
      background: rgba(255,255,255,.96) !important;
    }

    /* Unread dot: more premium glow */
    .inbox-item.unread::after{
      box-shadow: 0 0 0 2px rgba(255,255,255,.9), 0 0 18px rgba(239,68,68,.55) !important;
    }

    /* Saved search: more product-like */
    #saved-search{
      color: rgba(255,255,255,.92) !important;
      caret-color: var(--bton-accent);
    }
    #saved-search::placeholder{ color: rgba(255,255,255,.60) !important; }

    /* Scrollbar: subtle */
    .custom-scrollbar::-webkit-scrollbar{ width: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track{ background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb{
      background: rgba(15,23,42,.12);
      border-radius: 9999px;
      border: 3px solid rgba(255,255,255,.30);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{
      background: rgba(15,23,42,.18);
    }
    #inbox-content, #saved-panel{ scrollbar-width: thin; scrollbar-color: rgba(15,23,42,.18) transparent; }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .bton-nav-icon, .bton-nav-pill, .inbox-item, .saved-item{ transition: none !important; }
      #inbox-panel, #saved-panel{ transition: none !important; }
      .bton-badge{ animation: none !important; }
    }



  /* ==============================
     MOBILE NAV (HAMBURGER MENU)
     ============================== */
  @media (max-width: 640px){
    /* Hide crowded top actions on mobile; use hamburger instead */
    #guest-actions, #user-actions { display: none !important; }
    #nav-right { gap: 10px !important; }
  }

  /* Hamburger dropdown animation */
  #mobile-nav-menu { transform-origin: top right; }
  #mobile-nav-menu.bton-open { animation: btonMenuIn 0.14s ease-out both; }
  @keyframes btonMenuIn {
    from { opacity: 0; transform: translateY(-6px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Tiny badge on hamburger */
  #mobile-nav-badge {
    position: absolute;
    top: -6px;
    right: -6px;
  }

  /* Extra-compact logo on very small phones */
  @media (max-width: 420px){
    #nav-left img{
      max-width: 128px !important;
      height: 34px !important;
    }
  }

</style>

<!-- Supabase Auth client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    window.__BTON_BUILD="updated15";
    const SUPABASE_URL = "https://ncssozhpwzvzeneaumlz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jc3Nvemhwd3p2emVuZWF1bWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzkyMjgsImV4cCI6MjA4MDQxNTIyOH0.pk9p8_KRcmcbzhulo4dA06uk_3FOFXwVT1vNiYOEfck";

    const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

    window.supabaseClient = supabaseClient;
    window.__PV_NOTIF_DB_ONLY = true; // DB trigger handles profile-view notifications

</script>
<!-- Boot overlay: prevents dashboard flash on refresh -->
<style>
    /* ===== APP SHELL (LinkedIn-like) ===== */
    :root{ --bton-nav-h: calc(96px + env(safe-area-inset-top)); }
    @media (max-width: 640px){
      :root{ --bton-nav-h: calc(80px + env(safe-area-inset-top)); }
    }
    #bton-nav{ height: var(--bton-nav-h) !important; box-sizing: border-box; padding-top: env(safe-area-inset-top); }

    /* Ensure anchor scrolling accounts for the fixed header */
    #how-section { scroll-margin-top: calc(var(--bton-nav-h) + 18px); }

    /* Subtle arrival highlight (soft, premium) */
    .bton-spotlight {
      animation: btonSpotlight 900ms ease-out 1;
    }
    @keyframes btonSpotlight {
      0%   { box-shadow: 0 0 0 0 rgba(34, 211, 238, .0); }
      35%  { box-shadow: 0 18px 60px rgba(34, 211, 238, .18); }
      100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, .0); }
    }

    body { padding-top: var(--bton-nav-h); }

    html.booting body { overflow-y: scroll; }

    /* During boot we always prevent Dashboard flash */
    html.booting #view-dashboard,
    html.booting #view-editor,
    html.booting #view-message,
    html.booting #view-admin { display: none !important; }

    /* Only hide profile view on "home boot". On company-route boot we want skeleton to be visible. */
    html.booting:not(.route-company) #view-profile { display: none !important; }

    #boot-overlay {
      position: fixed;
      top: var(--bton-nav-h);
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 45; /* under nav (z-50) */
      display: none;
      background: linear-gradient(to bottom, rgba(248,250,252,0.88), rgba(255,255,255,0.72));
      backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .18s ease, transform .18s ease;
      overflow: hidden;
    }
    html.booting.boot-show #boot-overlay { display: block; opacity: 1; transform: translateY(0); }
    #boot-overlay.boot-out { opacity: 0; transform: translateY(4px); }

    .boot-topbar{
      position: sticky;
      top: 0;
      height: 3px;
      background: rgba(15,23,42,.06);
      overflow: hidden;
      z-index: 1;
    }
    .boot-topbar > span{
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 38%;
      background: linear-gradient(90deg, transparent, rgba(0,120,255,.55), transparent);
      transform: translateX(-35%);
      animation: boot-topbar-sweep 1.05s ease-in-out infinite;
    }
    @keyframes boot-topbar-sweep { to { transform: translateX(260%); } }

    .boot-shell{
      height: 100%;
      overflow-y: auto;
      padding: 18px 0 26px;
    }
    .boot-shell .boot-wrap{
      max-width: 80rem; /* 7xl */
      margin: 0 auto;
      padding: 0 1rem;
    }
    @media (min-width: 768px){
      .boot-shell .boot-wrap{ padding: 0 1.5rem; }
    }
    .boot-s-row{ display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .boot-s-left{ display:flex; gap:12px; align-items:center; }
    .boot-avatar{ width: 44px; height:44px; border-radius: 999px; }
    .boot-pill{ height: 14px; border-radius: 999px; }
    .boot-card-s{
      border-radius: 18px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(148,163,184,.25);
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
      padding: 14px;
    }

    .boot-card {
      width: min(520px, 92vw);
      border: 1px solid rgba(226,232,240,0.9);
      background: rgba(255,255,255,0.9);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.12);
      padding: 20px 18px;
    }
    .boot-title {
      font-family: Oswald, sans-serif;
      font-weight: 700;
      letter-spacing: .03em;
      color: #0F172A;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .boot-sub {
      color: #64748B;
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 14px;
    }
    .boot-bar {
      width: 100%;
      height: 8px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }
    .boot-bar::after{
      content:"";
      position:absolute;
      inset:0;
      transform: translateX(-55%);
      background: linear-gradient(90deg, transparent, rgba(6,182,212,0.55), transparent);
      animation: boot-sweep 1.05s ease-in-out infinite;
    }
    @keyframes boot-sweep { to { transform: translateX(55%); } }
  
/* ===== PROFILE SKELETON (BTrustOn O loader) ===== */
#profile-skeleton.hidden { display: none !important; }

/* âœ… GLOBAL SKELETON BASE (akÄ±cÄ± shimmer: transform) */
.skel{
  position: relative;
  overflow: hidden;
  border-radius: 18px;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(148,163,184,.25);
  box-shadow: 0 12px 30px rgba(2,6,23,.06);
}
.skel::after{
  content:"";
  position:absolute;
  inset:-40% -60%;
  transform: translateX(-60%);
  background: linear-gradient(90deg, transparent, rgba(15,23,42,.10), transparent);
  animation: skelSweep 1.05s ease-in-out infinite;
  will-change: transform;
}
@keyframes skelSweep { to { transform: translateX(60%); } }

@media (prefers-reduced-motion: reduce){
  .skel::after{ animation:none !important; }
}

#profile-skeleton .skel-card { background-clip: padding-box; }
@keyframes btonShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

</style>
<script>
    (function(){
      try{
        const h = (window.location.hash || "").trim();
        const root = document.documentElement;
        if (h.startsWith("#company=")) root.classList.add('booting','route-company');
        else root.classList.add('booting');

        // Show skeleton only if boot takes longer than 250ms (prevents flicker)
        setTimeout(() => {
          try{
            if (root.classList.contains('booting')) root.classList.add('boot-show');
          }catch(e){}
        }, 250);
      }catch(e){}
    })();
  </script>

<style id="bton-mobile-pricing-minimal">
@media (max-width: 640px){
  /* ---- MOBILE: make Free/Pro payment info cards more minimal ---- */
  #pricing-plans-wrap{ gap: 14px !important; }
  #pricing-plans-wrap > div{
    padding: 16px !important;
    border-radius: 22px !important;
  }
  #pricing-plans-wrap .text-4xl{ font-size: 32px !important; line-height: 1.05 !important; }
  #pricing-plans-wrap .mb-6{ margin-bottom: 14px !important; }
  #pricing-plans-wrap .mb-5{ margin-bottom: 12px !important; }
  #pricing-plans-wrap .space-y-3 > :not([hidden]) ~ :not([hidden]){ margin-top: 10px !important; }
  #pricing-plans-wrap li{ gap: 10px !important; }
  #pricing-plans-wrap li > div:first-child{
    width: 32px !important;
    height: 32px !important;
    border-radius: 14px !important;
  }
  #pricing-plans-wrap button{
    padding-top: 10px !important;
    padding-bottom: 10px !important;
    border-radius: 16px !important;
  }

  /* Pro active status (when already Pro) */
  #pricing-pro-state > div{
    padding: 14px !important;
    border-radius: 20px !important;
  }
  #pricing-pro-state .w-11, #pricing-pro-state .h-11{
    width: 40px !important;
    height: 40px !important;
    border-radius: 16px !important;
  }

  /* Upgrade modal (payment explanation) compact */
  #modal-upgrade .px-6{ padding-left: 16px !important; padding-right: 16px !important; }
  #modal-upgrade .pt-6{ padding-top: 16px !important; }
  #modal-upgrade .pb-5{ padding-bottom: 14px !important; }
  #modal-upgrade .p-6{ padding: 16px !important; }
  #modal-upgrade .p-5{ padding: 14px !important; }
  #modal-upgrade .w-12, #modal-upgrade .h-12{
    width: 40px !important;
    height: 40px !important;
    border-radius: 16px !important;
  }
  #modal-upgrade h3.text-base{ font-size: 15px !important; }
  #modal-upgrade .rounded-3xl{ border-radius: 22px !important; }
  #modal-upgrade .rounded-2xl{ border-radius: 20px !important; }
  #modal-upgrade ul.grid{ gap: 10px !important; }
}
</style>

<style id="bton-pro-apple-style">
/* Pro pricing card: premium + aligned with site palette (BTrustOn primary + turquoise accent) */
:root{
  /* Uses the same turquoise family as the site (accent / darkAccent) */
  --bton-pro-accent: #06b6d4;
  --bton-pro-accent2:#0891b2;
  --bton-pro-ink: #0F172A;
}

/* Card shell (more neutral, â€œpremium paperâ€ + subtle cyan halo) */
.bton-pro-card{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow:
    0 18px 60px rgba(15,23,42,.12),
    0 0 0 1px rgba(6,182,212,.10) inset;
  backdrop-filter: blur(12px);
}

.bton-pro-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(85% 65% at 12% 0%, rgba(6,182,212,.14), rgba(6,182,212,0) 62%),
    radial-gradient(70% 60% at 98% 18%, rgba(8,145,178,.14), rgba(8,145,178,0) 58%),
    linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
  pointer-events:none;
}
.bton-pro-card > *{ position:relative; z-index:1; }

/* Text + pills */
.bton-pro-muted{ color: rgba(15,23,42,.60) !important; }

.bton-pro-pill-apple{
  background: rgba(6,182,212,.08);
  border: 1px solid rgba(6,182,212,.22);
  color: var(--bton-pro-accent);
}

/* Feature icons */
.bton-pro-iconbox{
  background: rgba(6,182,212,.07);
  border: 1px solid rgba(6,182,212,.16);
}
.bton-pro-icon{ color: var(--bton-pro-accent) !important; }

/* CTA: black (premium) â†’ turquoise on hover (matches your login button behavior) */
.bton-pro-cta{
  background: linear-gradient(180deg, rgba(15,23,42,1), rgba(2,6,23,1));
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 14px 34px rgba(15,23,42,.22);
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
}
.bton-pro-cta:hover{
  background: linear-gradient(135deg, var(--bton-pro-accent), var(--bton-pro-accent2));
  box-shadow: 0 14px 34px rgba(6,182,212,.22);
  border-color: rgba(6,182,212,.35);
  transform: translateY(-1px);
}
.bton-pro-cta:active{ transform: translateY(0); }
.bton-pro-cta:focus-visible{
  outline: none;
  box-shadow:
    0 14px 34px rgba(6,182,212,.18),
    0 0 0 4px rgba(6,182,212,.18);
}
</style>


</head>
<body class="bg-gray-50 text-BTrustOn-text font-sans antialiased relative">
<!-- SAVED COMPANIES OVERLAY + PANEL -->
<div class="fixed inset-0 bg-black/40 backdrop-blur-[2px] z-[9988] hidden transition-opacity opacity-0" id="saved-overlay" onclick="toggleSavedPanel()"></div>
<div class="flex flex-col" id="saved-panel">
<div class="bg-gradient-to-r from-BTrustOn-primary to-slate-900 text-white pt-6 px-6 shadow-lg relative overflow-hidden shrink-0 z-20">
<div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
<div class="relative z-10 flex items-center justify-between">
<div>
<div class="text-[11px] uppercase tracking-wider text-white/70 font-bold" data-i18n="ui_my_lists_b684e8">My Lists</div>
<div class="text-lg font-extrabold flex items-center gap-2"><span data-i18n="ui_saved_following_e73c20">Saved &amp; Following</span><span class="text-[11px] font-black px-2 py-0.5 rounded-full bg-white/15 border border-white/20" id="saved-panel-count">0</span>
</div>
</div>
<button class="w-9 h-9 rounded-xl bg-white/10 hover:bg-white/20 transition flex items-center justify-center" data-i18n-title="attr_close_d3d2e6" onclick="toggleSavedPanel()" title="Close">
<i class="fa-solid fa-xmark"></i>
</button>
</div>
<!-- Tabs -->
<div class="relative z-10 mt-4 flex items-center gap-2">
<button aria-pressed="true" class="px-3 py-1.5 rounded-full text-xs font-black border border-white/20 bg-white/15 text-white hover:bg-white/20 transition flex items-center gap-2" id="saved-tab-btn" onclick="setSavedPanelTab('saved')">
<i class="fa-regular fa-bookmark text-white/90"></i>
<span data-i18n="ui_saved_248336">Saved</span>
<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-white/15 border border-white/20" id="saved-tab-count">0</span>
</button>
<button aria-pressed="false" class="px-3 py-1.5 rounded-full text-xs font-black border border-white/20 bg-white/5 text-white/90 hover:bg-white/15 transition flex items-center gap-2" id="following-tab-btn" onclick="setSavedPanelTab('following')">
<i class="fa-solid fa-tower-broadcast text-white/90"></i>
<span data-i18n="updates_following">Following</span>
<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-white/10 border border-white/15" id="following-tab-count">0</span>
</button>
</div>
<div class="relative z-10 mt-3 pb-5">
<div class="bg-white/10 border border-white/15 rounded-2xl px-3 py-2 flex items-center gap-2">
<i class="fa-solid fa-magnifying-glass text-white/70 text-sm"></i>
<input class="w-full bg-transparent outline-none text-sm placeholder:text-white/60" data-i18n-placeholder="ph_saved_search" id="saved-search" oninput="renderSavedPanelActive()" data-i18n-placeholder="saved_search_ph" placeholder=""/>
</div>
</div>
</div>
<div class="flex-1 overflow-y-auto p-4 space-y-3">
<div class="hidden" id="saved-empty">
  <div class="bton-empty-card">
    <div class="bton-empty-ic"><i class="fa-regular fa-bookmark"></i></div>
    <div class="min-w-0">
      <div class="bton-empty-title" data-i18n="empty_saved_title">No saved companies yet</div>
      <div class="bton-empty-desc" data-i18n="empty_saved_desc">No saved companies yet. Use the bookmark icon on company cards to save.</div>
      <button class="bton-empty-action" type="button" onclick="try{ toggleSavedPanel(); }catch(e){} try{ document.getElementById('search-input')?.focus(); }catch(e){}">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span data-i18n="empty_browse_companies_btn">Browse companies</span>
      </button>
    </div>
  </div>
</div>
<div class="space-y-3" id="saved-list"></div>
<div class="hidden text-sm text-gray-500 bg-white/70 border border-gray-200 rounded-2xl p-4" id="following-empty"><span data-i18n="ui_no_followed_companies_yet_use_th_bfe54b">No followed companies yet. Use the Follow</span><span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-900/5 border border-slate-900/10 align-middle mx-0.5"><i class="fa-solid fa-tower-broadcast text-[11px] text-slate-600"></i></span><span data-i18n="ui_icon_on_company_cards_or_profile_808d3c">icon on company cards or profiles.</span></div>
<div class="hidden space-y-3" id="following-list"></div>
</div>
</div>
<!-- /SAVED COMPANIES PANEL -->
<div id="toast-container"></div>
<div aria-busy="true" aria-live="polite" id="boot-overlay">
<span class="sr-only" data-i18n="ui_loading_5f02f0">Loadingâ€¦</span>
<div aria-hidden="true" class="boot-topbar"><span></span></div>
<div aria-hidden="true" class="boot-shell">
<div class="boot-wrap space-y-4">
<!-- â€œSearch / composerâ€ row -->
<div class="boot-card-s">
<div class="boot-s-row">
<div class="boot-s-left">
<div class="skel boot-avatar"></div>
<div class="space-y-2 w-[min(520px,68vw)]">
<div class="skel boot-pill w-40 h-3"></div>
<div class="skel h-10 rounded-full"></div>
</div>
</div>
<div class="skel h-9 w-32 rounded-full hidden md:block"></div>
</div>
</div>
<!-- Feed cards -->
<div class="boot-card-s">
<div class="boot-s-row mb-3">
<div class="boot-s-left">
<div class="skel boot-avatar"></div>
<div class="space-y-2">
<div class="skel h-3 w-44 rounded-full"></div>
<div class="skel h-3 w-28 rounded-full"></div>
</div>
</div>
<div class="skel h-8 w-24 rounded-full"></div>
</div>
<div class="space-y-2">
<div class="skel h-3 w-11/12 rounded-full"></div>
<div class="skel h-3 w-9/12 rounded-full"></div>
<div class="skel h-44 w-full rounded-2xl"></div>
</div>
</div>
<div class="boot-card-s">
<div class="boot-s-row mb-3">
<div class="boot-s-left">
<div class="skel boot-avatar"></div>
<div class="space-y-2">
<div class="skel h-3 w-40 rounded-full"></div>
<div class="skel h-3 w-24 rounded-full"></div>
</div>
</div>
<div class="skel h-8 w-24 rounded-full"></div>
</div>
<div class="space-y-2">
<div class="skel h-3 w-10/12 rounded-full"></div>
<div class="skel h-3 w-7/12 rounded-full"></div>
<div class="skel h-3 w-9/12 rounded-full"></div>
</div>
</div>
<div class="boot-card-s">
<div class="boot-s-row mb-3">
<div class="boot-s-left">
<div class="skel boot-avatar"></div>
<div class="space-y-2">
<div class="skel h-3 w-48 rounded-full"></div>
<div class="skel h-3 w-32 rounded-full"></div>
</div>
</div>
<div class="skel h-8 w-24 rounded-full"></div>
</div>
<div class="space-y-2">
<div class="skel h-3 w-8/12 rounded-full"></div>
<div class="skel h-3 w-10/12 rounded-full"></div>
<div class="skel h-32 w-full rounded-2xl"></div>
</div>
</div>
<div class="text-xs text-gray-500/80 px-1" data-i18n="ui_loading_your_network_495790">
        Loading your networkâ€¦
      </div>
</div>
</div>
</div>
<div class="fixed top-0 left-0 right-0 h-[820px] md:h-[740px] z-[-1] dot-map-bg opacity-[0.14] pointer-events-none"></div>
<div class="fixed top-0 left-0 right-0 h-[820px] md:h-[740px] z-[-2] bton-hero-aura pointer-events-none"></div>
<nav id="bton-nav" class="fixed top-0 left-0 right-0 z-50 bg-white/70 backdrop-blur-md border-b border-white/50 h-24">
<div class="max-w-7xl mx-auto px-4 h-full flex items-center gap-3 flex-nowrap">
<div class="flex items-center gap-3 shrink-0" id="nav-left">
<button class="hidden hidden-view inline-flex items-center gap-2 pr-4 mr-1 border-r border-gray-200/80 text-gray-500 hover:text-BTrustOn-primary transition px-3 py-2 rounded-lg hover:bg-gray-100" id="back-btn" onclick="showMainView()">
<i class="fa-solid fa-arrow-left"></i>
<span class="hidden md:inline" data-i18n="back">BACK TO LIST</span>
</button>
<div class="cursor-pointer select-none flex items-center h-full gap-2.5 shrink-0" onclick="showMainView()">
<!-- Premium Full Logo (new) -->
<img alt="BTrustOn" class="h-10 md:h-11 w-auto block max-w-[250px] drop-shadow-[0_6px_14px_rgba(2,6,23,0.14)]" decoding="async" loading="eager" src="data:image/png;base64,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"/>
</div>
</div>
<div class="ml-auto flex items-center gap-3 text-sm font-medium flex-nowrap" id="nav-right">

<div class="relative" id="lang-menu">
  <button id="lang-menu-toggle"
          type="button"
          class="bton-nav-icon w-10 h-10 rounded-full grid place-items-center"
          aria-haspopup="menu"
          aria-expanded="false"
          aria-label="Language"
          data-i18n-aria="lang_menu"
          title="Language"
          data-i18n-title="lang_menu"
          onclick="toggleLangMenu()">
    <i class="fa-solid fa-globe text-lg text-slate-700 hover:text-BTrustOn-primary transition"></i>
  </button>

  <div id="lang-menu-dropdown"
       class="hidden absolute right-0 mt-2 min-w-[180px] bg-white/95 backdrop-blur-xl border border-white/70 shadow-xl rounded-2xl p-1 overflow-hidden z-[80]">
    <button id="lang-en"
            type="button"
            class="w-full flex items-center justify-between px-3 py-2 rounded-xl text-xs font-extrabold tracking-wide text-gray-600 hover:bg-slate-50 transition"
            onclick="switchLanguage('en'); closeLangMenu();">
      <span class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-lg bg-slate-900/5 text-slate-700">
          <i class="fa-solid fa-language"></i>
        </span>
        <span>English</span>
      </span>
      <span class="text-[11px] font-black text-slate-500">EN</span>
    </button>

    <button id="lang-tr"
            type="button"
            class="w-full flex items-center justify-between px-3 py-2 rounded-xl text-xs font-extrabold tracking-wide text-gray-600 hover:bg-slate-50 transition"
            onclick="switchLanguage('tr'); closeLangMenu();">
      <span class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-lg bg-slate-900/5 text-slate-700">
          <i class="fa-solid fa-language"></i>
        </span>
        <span>TÃ¼rkÃ§e</span>
      </span>
      <span class="text-[11px] font-black text-slate-500">TR</span>
    </button>

<button id="lang-es"
        type="button"
        class="w-full flex items-center justify-between px-3 py-2 rounded-xl text-xs font-extrabold tracking-wide text-gray-600 hover:bg-slate-50 transition"
        onclick="switchLanguage('es'); closeLangMenu();">
  <span class="flex items-center gap-2">
    <span class="inline-flex items-center justify-center w-6 h-6 rounded-lg bg-slate-900/5 text-slate-700">
      <i class="fa-solid fa-language"></i>
    </span>
    <span>EspaÃ±ol</span>
  </span>
  <span class="text-[11px] font-black text-slate-500">ES</span>
</button>

    <div class="px-3 py-2 text-[11px] text-slate-500" data-i18n="lang_more_soon">More languages soon</div>
  
</div>
</div>

<!-- Mobile quick (authed) -->
<button id="mobile-quick-my-company"
        type="button"
        class="hidden md:hidden bton-nav-icon w-10 h-10 rounded-full grid place-items-center"
        aria-label="My Company"
        title="My Company"
        onclick="openMyCompanyIfExists()">
  <i class="fa-regular fa-building text-lg text-slate-700 hover:text-BTrustOn-primary transition"></i>
</button>

<!-- Mobile Menu (Hamburger) -->
<div class="relative md:hidden" id="mobile-nav">
  <button id="mobile-nav-toggle"
          type="button"
          class="bton-nav-icon w-10 h-10 rounded-full grid place-items-center relative"
          aria-haspopup="menu"
          aria-expanded="false"
          aria-label="Menu"
          title="Menu"
          onclick="toggleMobileNavMenu(event)">
    <i class="fa-solid fa-bars text-lg text-slate-700 hover:text-BTrustOn-primary transition"></i>
    <span class="bton-badge hidden" id="mobile-nav-badge">0</span>
  </button>

  <div class="hidden absolute right-0 mt-2 w-72 max-w-[88vw] rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden z-[80]"
       id="mobile-nav-menu"
       role="menu"
       aria-label="Menu">
    <div class="px-4 py-3 border-b border-slate-100">
      <div class="text-[11px] font-black tracking-wider text-slate-600">MENU</div>
    </div>

    <div class="p-2">
      <!-- Guest -->
      <div id="mobile-guest-actions" class="flex flex-col gap-1">
        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); openLoginModal();">
          <span class="w-9 h-9 rounded-xl bg-slate-900/5 text-slate-700 grid place-items-center">
            <i class="fa-solid fa-key"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="login_title">Login</span>
        </button>

        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); openJoinModal('free');">
          <span class="w-9 h-9 rounded-xl bg-cyan-50 text-cyan-700 grid place-items-center">
            <i class="fa-solid fa-paper-plane"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="join">JOIN NETWORK</span>
        </button>
      </div>

      <!-- Logged in -->
      <div id="mobile-user-actions" class="hidden flex-col gap-1">
        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); openMyCompanyIfExists();">
          <span class="w-9 h-9 rounded-xl bg-slate-900/5 text-slate-700 grid place-items-center">
            <i class="fa-regular fa-building"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="nav_my_company">MY COMPANY</span>
        </button>

        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); toggleInbox();">
          <span class="w-9 h-9 rounded-xl bg-slate-900/5 text-slate-700 grid place-items-center">
            <i class="fa-solid fa-bell"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="ui_inbox_7e3342">INBOX</span>
          <span class="ml-auto text-[11px] font-black px-2 py-1 rounded-full bg-slate-900/5 text-slate-700 hidden" id="mobile-inbox-badge">0</span>
        </button>

        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); toggleSavedPanel();">
          <span class="w-9 h-9 rounded-xl bg-slate-900/5 text-slate-700 grid place-items-center">
            <i class="fa-regular fa-bookmark"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="nav_lists">LISTS</span>
        </button>

        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-50 transition"
                onclick="closeMobileNavMenu(); openUpgradeModal();">
          <span class="w-9 h-9 rounded-xl bg-amber-50 text-amber-700 grid place-items-center">
            <i class="fa-solid fa-gem"></i>
          </span>
          <span class="font-extrabold text-slate-800" data-i18n="btn_upgrade_pro">Upgrade to Pro</span>
        </button>

        <div class="h-px my-1 bg-slate-100"></div>

        <button class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-red-50 transition"
                onclick="closeMobileNavMenu(); partnerLogout();">
          <span class="w-9 h-9 rounded-xl bg-red-50 text-red-700 grid place-items-center">
            <i class="fa-solid fa-right-from-bracket"></i>
          </span>
          <span class="font-extrabold text-red-700">Logout</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="flex items-center gap-2 md:gap-3" id="guest-actions">

<button aria-label="Login" class="bton-nav-pill bton-pill-muted inline-flex items-center gap-2 px-3.5 py-2 rounded-full text-[11px] md:text-xs font-extrabold uppercase tracking-[.12em]" data-i18n-aria="login_title" id="btn-partner-login" onclick="openLoginModal()">
<span class="bton-nav-mini-ic"><i class="fa-solid fa-key"></i></span>
<span class="hidden sm:inline" data-i18n="login_title">Login</span>
<span class="sm:hidden" data-i18n="nav_login_short">Login</span>
</button>
<button class="bton-nav-pill bton-pill-primary inline-flex items-center gap-2 px-4 py-2 rounded-full text-[11px] md:text-xs font-extrabold uppercase tracking-[.12em]" id="btn-join-network" onclick="openJoinModal('free')">
<span class="bton-nav-mini-ic"><i class="fa-solid fa-paper-plane"></i></span>
<span class="bton-pill-label hidden sm:inline" data-i18n="join">JOIN NETWORK</span>
            <span class="bton-pill-label sm:hidden">JOIN</span>
</button>
</div>
<div class="hidden flex items-center gap-3" id="user-actions">
<div class="relative mr-2" id="nav-plan-wrap">
<button class="hidden flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-extrabold border transition shadow-sm" data-i18n-title="attr_plan_0b6cbd" id="btn-nav-upgrade" onclick="togglePlanMenu()" title="Plan">
<span class="w-6 h-6 rounded-lg flex items-center justify-center bg-white/70 border border-white/60 shadow-sm" id="nav-plan-icon-wrap">
<i class="fa-solid fa-gem" id="nav-plan-icon"></i>
</span>
<span class="hidden md:inline" id="nav-plan-label" data-i18n="updates_upgrade">Upgrade</span>
<i class="fa-solid fa-chevron-down text-[10px] opacity-60 ml-0.5"></i>
</button>
<div class="hidden absolute right-0 mt-2 w-64 rounded-2xl border border-gray-200 bg-white shadow-xl overflow-hidden z-[60]" id="nav-plan-menu">
<div class="px-4 py-3 border-b border-gray-100">
<div class="text-xs font-extrabold text-slate-900" data-i18n="attr_plan_0b6cbd" id="nav-plan-menu-title">Plan</div>
<div class="text-[11px] text-gray-500 mt-0.5" data-i18n="ui_upgrade_to_unlock_pro_features_7bc2e8" id="nav-plan-menu-sub">Upgrade to unlock Pro features.</div>
</div>
<div class="p-2">
<button class="w-full flex items-center gap-2 px-3 py-2.5 rounded-xl hover:bg-cyan-50 transition text-left" id="plan-menu-upgrade" onclick="closePlanMenu(); openUpgradeModal();">
<i class="fa-solid fa-arrow-up-right-dots text-cyan-600"></i>
<div class="flex-1">
<div class="text-xs font-extrabold text-slate-900" data-i18n="plan_upgrade_title">Upgrade to Pro</div>
<div class="text-[11px] text-gray-500" data-i18n="plan_upgrade_desc">Unlimited uploads, updates &amp; priority visibility.</div>
</div>
</button>
<button class="hidden w-full flex items-center gap-2 px-3 py-2.5 rounded-xl hover:bg-red-50 transition text-left" id="plan-menu-cancel" onclick="closePlanMenu(); cancelProSubscription();">
<i class="fa-solid fa-ban text-red-500"></i>
<div class="flex-1">
<div class="text-xs font-extrabold text-red-600" data-i18n="plan_cancel_title">Cancel Pro</div>
<div class="text-[11px] text-gray-500" data-i18n="plan_cancel_desc">Stop renewal and return to Free.</div>
</div>
</button>
</div>
</div>
</div>
<button data-i18n-aria="nav_messages_aria" aria-label="" class="bton-nav-icon w-10 h-10 rounded-full grid place-items-center" data-i18n-aria="attr_messages_41de6d" data-i18n-title="attr_messages_41de6d" id="btn-inbox" onclick="toggleInbox()" data-i18n-title="nav_messages_title" title="">
<i class="fa-solid fa-bell text-lg group-hover:animate-swing"></i>
<span class="bton-badge hidden" id="nav-badge">
        0
      </span>
</button>
<button data-i18n-aria="nav_lists_aria" aria-label="" class="bton-nav-pill relative flex items-center gap-2 px-3 py-2 rounded-full" data-i18n-aria="nav_lists" data-i18n-title="nav_lists" id="btn-saved-companies" onclick="toggleSavedPanel()" data-i18n-title="nav_lists_title" title="">
<i class="fa-regular fa-bookmark text-BTrustOn-accent"></i>
<span class="hidden md:inline" data-i18n="nav_lists">LISTS</span>
<span class="bton-badge hidden" id="saved-badge">
        0
      </span>
</button>
<button aria-label="My Company" class="bton-nav-pill relative flex items-center gap-2 px-3 py-2 rounded-full" data-i18n-aria="nav_my_company" data-i18n-title="nav_my_company" id="btn-my-company" onclick="openMyCompanyIfExists()" title="My Company">
<span aria-hidden="true" class="bton-nav-mini-ic">
<i class="fa-regular fa-building"></i>
</span>
<span class="hidden md:inline" data-i18n="nav_my_company">MY COMPANY</span>
</button>
<div class="flex items-center gap-2 ml-auto">
<button class="hidden flex items-center gap-2 px-3 py-2 bg-slate-800 text-white border border-slate-700 rounded-lg text-xs font-bold hover:bg-slate-700 transition shadow-sm mr-2" id="btn-admin-panel" onclick="showAdminView()">
<i class="fa-solid fa-user-shield"></i><span data-i18n="ui_admin_73acd9">ADMIN</span></button>
<button class="text-gray-400 hover:text-red-500 transition px-2 py-2" data-i18n-title="attr_logout_0323de" id="btn-partner-logout" onclick="partnerLogout()" title="Logout">
<i class="fa-solid fa-right-from-bracket text-lg"></i>
</button>
</div>
</div>
</div>
</div>
</nav>
<div class="fade-in" id="view-dashboard">
<header class="pt-4 pb-4 px-4 text-center relative overflow-hidden z-10">
<div class="bton-hero-gradient"></div>

<div class="pointer-events-none absolute left-1/2 -translate-x-1/2 -top-28 w-[760px] h-[760px] bg-gradient-to-br from-cyan-200/45 via-blue-200/25 to-purple-200/15 blur-3xl rounded-full"></div>


<h1 class="text-3xl md:text-5xl font-header font-extrabold mb-3 leading-[1.05] tracking-tight drop-shadow-sm py-1 max-w-4xl mx-auto" id="hero-title"></h1>
<p class="text-lg md:text-xl text-slate-600 mb-6 max-w-3xl mx-auto font-normal leading-relaxed" id="hero-desc"></p>
<div class="flex flex-col md:flex-row items-center justify-center gap-3 mb-2" id="hero-cta">
<button class="bton-nav-pill bton-pill-primary inline-flex items-center gap-3 px-6 py-3 rounded-full font-extrabold text-xs md:text-sm shadow-sm" id="hero-btn-join" onclick="openJoinModal('free')" type="button">
<span class="bton-nav-mini-ic bton-cta-ic"><i class="fa-solid fa-paper-plane"></i></span>
<span data-i18n="hero_cta_join">Join as a Company</span>
</button>
<button class="inline-flex items-center gap-2 bg-BTrustOn-primary text-white px-6 py-3 rounded-full font-extrabold text-xs md:text-sm shadow-lg shadow-blue-900/20 hover:bg-BTrustOn-accent transition" id="hero-btn-post" onclick="openPostUpdateModal()" style="display:none" type="button">
<i class="fa-solid fa-pen-to-square" id="hero-post-icon"></i>
<span data-i18n="hero_cta_post" id="hero-post-label">Post an Update</span>
</button>
<button class="text-xs md:text-sm font-bold text-gray-500 hover:text-BTrustOn-accent underline underline-offset-4 transition" id="hero-btn-how" onclick="scrollToHowSection();" type="button">
<span data-i18n="hero_cta_how">How BTrustOn Works</span>
</button>
</div>
<p class="text-xs md:text-sm text-gray-500 mb-6 max-w-3xl mx-auto" id="hero-proof">
<span data-i18n="hero_proof">Show proof, not promises. Verified badge after review.</span>
</p>
<div id="hero-search-wrap" class="w-[95%] md:max-w-3xl mx-auto relative mb-6 z-20 transition-all duration-300">
<div class="bton-apple-search-halo absolute inset-0 bg-BTrustOn-accent/12 blur-xl rounded-full opacity-0 hover:opacity-100 transition-opacity duration-500"></div>
<div class="bton-apple-search relative bg-white/90 backdrop-blur-xl p-1.5 md:p-2 rounded-full shadow-2xl flex items-center border border-white/80 ring-4 ring-transparent focus-within:ring-cyan-50/50 focus-within:scale-[1.02] transition-all duration-300">
<div class="pl-4 pr-3 text-BTrustOn-accent shrink-0">
<i class="fa-solid fa-magnifying-glass text-lg md:text-xl animate-pulse"></i>
</div>
<input class="bton-apple-search-input w-full bg-transparent outline-none text-gray-700 text-sm md:text-base placeholder:text-[12px] md:placeholder:text-sm placeholder-gray-400 font-light h-10 md:h-12" id="search-input" onkeydown="if(event.key === 'Enter') { event.preventDefault(); handleSearchInput(this.value); scrollToResults(); }" onkeyup="handleSearchInput(this.value)" data-i18n-placeholder="search_ph" placeholder="" type="text"/>
<button class="bton-apple-search-btn shrink-0 inline-flex items-center justify-center gap-2 bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white rounded-full w-10 h-10 md:w-auto md:h-12 md:px-6 font-bold transition shadow-lg shadow-cyan-500/30 group" onclick="handleSearchInput(document.getElementById('search-input')?.value || ''); scrollToResults();">
<span class="hidden md:inline whitespace-nowrap" data-i18n="btn_discover">DISCOVER</span>
<i class="fa-solid fa-compass text-lg group-hover:rotate-45 transition-transform duration-300"></i>
</button>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-6 md:px-12 py-6 pb-24">
<div class="flex flex-col gap-4 mb-5 border-b border-gray-200/50 pb-4">
<div class="bg-white/70 border border-white/60 rounded-2xl shadow-glass px-4 py-4">
<div id="home-updates-head" class="flex items-start justify-between gap-3 mb-3">
<div class="min-w-0">
<h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider flex items-center gap-2">
<i class="fa-solid fa-bolt text-cyan-500"></i>
<span data-i18n="updates_title">Company Updates</span>
</h3>
<div class="flex items-center gap-2 mt-1">
<span class="bton-hide-mobile text-[11px] text-gray-400" data-i18n="updates_sub">Last 7 days â€¢ posted by companies</span>
<div class="inline-flex items-center rounded-full border border-gray-200 bg-white/80 backdrop-blur px-1 py-1 shadow-sm" id="home-updates-filter">
<button class="px-2.5 py-1 rounded-full text-[11px] font-extrabold transition" id="upd-filter-all" onclick="setHomeUpdatesFilter('all')" type="button">
<span data-i18n="updates_filter_all">All updates</span>
</button>
<button class="px-2.5 py-1 rounded-full text-[11px] font-extrabold transition" id="upd-filter-followed" onclick="setHomeUpdatesFilter('followed')" type="button">
<span data-i18n="updates_filter_followed">Only followed</span>
</button>
</div>
<span class="bton-hide-mobile text-[11px] text-gray-400 hidden md:inline" id="home-updates-active-wrap"><span data-i18n="ui_53fe08">â€¢</span><span data-i18n="updates_active_label">Most active:</span> <span class="font-extrabold text-gray-500" id="home-updates-active-count">0</span></span>
<span class="bton-hide-mobile inline-flex items-center gap-1 text-[10px] text-emerald-600 font-bold hidden" id="home-updates-dot">
<span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span><span data-i18n="ui_live_f35d25"></span></span>
</div>
</div>
<button class="shrink-0 inline-flex items-center gap-2 bg-white border border-gray-200 hover:border-BTrustOn-accent text-gray-700 hover:text-BTrustOn-primary text-[11px] font-extrabold px-3 py-2 rounded-xl shadow-sm transition" id="btn-open-post-update" onclick="openPostUpdateModal()">
<i class="fa-solid fa-square-plus text-BTrustOn-accent"></i>
<span data-i18n="btn_post_update">POST UPDATE</span>
</button>
</div>
<div class="relative bton-updates-wrap">
  <button type="button" class="bton-updates-nav bton-updates-nav-left flex" id="home-updates-left" aria-label="Scroll updates left">
    <i class="fa-solid fa-chevron-left text-xs"></i>
  </button>
  <button type="button" class="bton-updates-nav bton-updates-nav-right flex" id="home-updates-right" aria-label="Scroll updates right">
    <i class="fa-solid fa-chevron-right text-xs"></i>
  </button>
  <div class="flex items-start gap-4 overflow-x-auto no-scrollbar pb-2 pr-2 scroll-smooth snap-x snap-proximity bton-updates-rail" id="home-updates"></div>
<div class="hidden" id="home-updates-empty">
  <div class="bton-empty-card bton-empty-card--soft">
    <div class="bton-empty-ic"><i class="fa-regular fa-newspaper"></i></div>
    <div class="min-w-0">
      <div class="bton-empty-title" data-i18n="updates_empty_title">No company updates in 7 days</div>
      <div class="bton-empty-desc"><span data-i18n="updates_empty">No company updates posted in the last 7 days.</span></div>
    </div>
  </div>
</div>
<div class="hidden mt-3 text-[10px] text-gray-400 flex items-center justify-between gap-2 bg-cyan-50/60 border border-cyan-100 rounded-xl px-3 py-2" id="home-updates-prohint">
<div class="flex items-center gap-2 min-w-0">
<i class="fa-solid fa-lock text-cyan-500"></i>
<span class="truncate" data-i18n="updates_pro_hint">Posting updates is a Pro feature.</span>
</div>
<button class="shrink-0 text-[10px] font-extrabold text-cyan-700 hover:text-cyan-900 underline underline-offset-2" data-i18n="updates_upgrade" onclick="openUpgradeModal()">Upgrade</button>
</div>
</div>
</div>
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-4" id="live-showcase">
<div>
<span class="text-2xl font-bold text-BTrustOn-primary tracking-tight" data-i18n="ui_loading_8524de" id="result-count">Loading...</span>
</div>
<div class="flex flex-wrap gap-3">
<div class="relative group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="fa-solid fa-layer-group text-gray-400 text-xs"></i>
</div>
<select class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition min-w-[140px]" id="sector-filter" onchange="filterSector(this.value)">
<option data-i18n="sec_all" value="all">All Sectors</option>
<option data-i18n="sec_const" value="construction">Construction &amp; Infrastructure</option>
<option data-i18n="sec_energy" value="energy">Energy &amp; Oil/Gas</option>
<option data-i18n="sec_mine" value="mining">Mining &amp; Metals</option>
<option data-i18n="sec_manu" value="manufacturing">Manufacturing &amp; Machinery</option>
<option data-i18n="sec_tech" value="technology">Technology &amp; Automation</option>
<option data-i18n="sec_logi" value="logistics">Logistics &amp; Trade</option>
<option data-i18n="sec_eng" value="engineering">Engineering &amp; Services</option> </select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
</div>
</div>
<div class="relative group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="fa-solid fa-earth-americas text-gray-400 text-xs"></i>
</div>
<select class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition min-w-[140px]" id="country-filter" onchange="handleCountryChange(this.value)">
<option data-i18n="filter_all_countries" value="all">All Countries</option>
</select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
</div>
</div>
<div class="relative group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="fa-solid fa-arrow-down-short-wide text-gray-400 text-xs"></i>
</div>
<select class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition" id="sort-select" onchange="handleSortChange(this.value)">
<option data-i18n="sort_recommended" value="recommended">Recommended</option>
<option data-i18n="sort_verified_first" value="verified_first">Verified: First</option>
<option data-i18n="sort_year_oldest" value="year_oldest">Experience: Oldest First</option>
<option data-i18n="sort_year_newest" value="year_newest">Experience: Newest First</option>
<option data-i18n="sort_name_asc" value="name_asc">Name: A to Z</option>
<option data-i18n="sort_name_desc" value="name_desc">Name: Z to A</option>
</select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
</div>
</div>
</div>
</div>
<div class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-16" id="card-container"></div>
<section class="mt-6 mb-10 scroll-mt-24" id="how-section">
<div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
<div>
<h2 class="text-2xl md:text-3xl font-header font-bold text-BTrustOn-primary mb-2" data-i18n="how_title">How BTrustOn Works</h2>
<p class="text-sm text-gray-500 max-w-2xl" data-i18n="how_sub">
        A simple workflow for companies and buyersâ€”prove capability, find verified partners, and move fast.
      </p>
</div>
</div>
<div class="grid lg:grid-cols-2 gap-6">
<!-- For Companies -->
<div class="bg-white/85 border border-gray-100 rounded-2xl p-6 shadow-glass">
<div class="flex items-start justify-between gap-4 mb-5">
<div class="flex items-center gap-3">
<div class="w-11 h-11 rounded-2xl bg-BTrustOn-primary/10 flex items-center justify-center text-BTrustOn-primary">
<i class="fa-solid fa-building text-base"></i>
</div>
<div>
<h3 class="text-sm font-extrabold text-BTrustOn-primary" data-i18n="how_for_companies">For Companies</h3>
<p class="text-xs text-gray-500" data-i18n="how_for_companies_sub">Join, showcase proof, get verified.</p>
</div>
</div>
<span class="text-[10px] font-extrabold px-2.5 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-200" data-i18n="how_badge_company">SUPPLIER</span>
</div>
<ol class="space-y-3">
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-gray-600">1</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_c1_t">Join &amp; create your profile</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_c1_d">Add services, sectors, location, and key contacts.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-cyan-50 border border-cyan-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-cyan-700">2</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_c2_t">Add proof: projects, certificates, assets</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_c2_d">Publish references and industrial inventory to show capability.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-indigo-700">3</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_c3_t">Post company updates</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_c3_d">Share progress, milestones, and new assets in a structured format.</div>
</div>
</li>
</ol>
<!-- Verification -->
<div class="mt-5 rounded-2xl border border-blue-100 bg-blue-50/60 p-5" id="how-verification">
<div class="flex items-center gap-2 mb-3">
<div class="w-9 h-9 rounded-xl bg-white/70 border border-blue-100 flex items-center justify-center text-blue-600">
<i class="fa-solid fa-circle-check"></i>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_verif_title">How BTrustOn Works</div>
<div class="text-[11px] text-gray-500" data-i18n="how_verif_sub">A quick review to unlock the blue tick.</div>
</div>
</div>
<div class="grid sm:grid-cols-3 gap-3">
<div class="bg-white/80 border border-blue-100 rounded-xl p-3">
<div class="text-[10px] font-extrabold text-blue-700 mb-1" data-i18n="how_v1_t">Submit verification</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_v1_d">Provide your business ID and request a review.</div>
</div>
<div class="bg-white/80 border border-blue-100 rounded-xl p-3">
<div class="text-[10px] font-extrabold text-blue-700 mb-1" data-i18n="how_v2_t">Review &amp; approval</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_v2_d">We check consistency and approve verified companies.</div>
</div>
<div class="bg-white/80 border border-blue-100 rounded-xl p-3">
<div class="text-[10px] font-extrabold text-blue-700 mb-1" data-i18n="how_v3_t">Get the blue tick</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_v3_d">Verified badge becomes visible to everyone.</div>
</div>
</div>
</div>
</div>
<!-- For Buyers -->
<div class="bg-white/85 border border-gray-100 rounded-2xl p-6 shadow-glass">
<div class="flex items-start justify-between gap-4 mb-5">
<div class="flex items-center gap-3">
<div class="w-11 h-11 rounded-2xl bg-emerald-50 flex items-center justify-center text-emerald-700 border border-emerald-100">
<i class="fa-solid fa-magnifying-glass text-base"></i>
</div>
<div>
<h3 class="text-sm font-extrabold text-BTrustOn-primary" data-i18n="how_for_buyers">For Buyers</h3>
<p class="text-xs text-gray-500" data-i18n="how_for_buyers_sub">Search, compare, save, and follow.</p>
</div>
</div>
<span class="text-[10px] font-extrabold px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200" data-i18n="how_badge_buyer">BUYER</span>
</div>
<ol class="space-y-3">
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-emerald-50 border border-emerald-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-emerald-700">1</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_b1_t">Search verified partners</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_b1_d">Filter by sector, location, services, projects, assets.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-cyan-50 border border-cyan-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-cyan-700">2</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_b2_t">Validate quickly</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_b2_d">Review project references, certificates, and asset lists.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-indigo-700">3</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_b3_t">Join to save &amp; add notes</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_b3_d">Create a free account to bookmark companies and keep private notes for your team.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-amber-50 border border-amber-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-amber-700">4</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_b4_t">Follow updates &amp; stay in touch</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_b4_d">After joining, follow companies to get notified on new posts, request quotes, and message via inbox.</div>
</div>
</li>
<li class="flex gap-3">
<div class="w-8 h-8 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0">
<span class="text-[11px] font-extrabold text-gray-600">5</span>
</div>
<div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="how_b5_t">Request quotes</div>
<div class="text-xs text-gray-500 leading-relaxed" data-i18n="how_b5_d">Contact the right partner with one request.</div>
</div>
</li>
</ol>
<div class="mt-5 grid md:grid-cols-3 gap-3">
<div class="rounded-xl border border-gray-100 bg-white/80 p-4">
<div class="flex items-center gap-2 mb-1">
<i class="fa-solid fa-bullhorn text-indigo-600 text-sm"></i>
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="how_feature_updates_title">Company Updates</div>
</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_feature_updates_desc">Structured posts keep profiles active and easier to evaluate.</div>
</div>
<div class="rounded-xl border border-gray-100 bg-white/80 p-4">
<div class="flex items-center gap-2 mb-1">
<i class="fa-solid fa-bookmark text-emerald-600 text-sm"></i>
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="how_feature_saved_title">Saved &amp; Notes</div>
</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_feature_saved_desc">Save companies and add private notes for follow-up.</div>
</div>
<div class="rounded-xl border border-gray-100 bg-white/80 p-4">
<div class="flex items-center gap-2 mb-1">
<i class="fa-solid fa-shield-halved text-blue-600 text-sm"></i>
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="how_feature_verified_title">Verified Badge</div>
</div>
<div class="text-[11px] text-gray-500 leading-snug" data-i18n="how_feature_verified_desc">Buyers spot verified partners instantly in search.</div>
</div>
</div>
</div>
</div>
</section>
<section class="mt-6" id="pricing-section">
<!-- Soft payment note -->
<div class="max-w-5xl mx-auto mb-4 flex items-center justify-center px-4" id="pricing-pay-note">
<div class="inline-flex items-center gap-2 rounded-2xl border border-[rgba(15,23,42,.10)] bg-white/60 backdrop-blur px-4 py-2 shadow-glass">
<span class="w-7 h-7 rounded-full bg-cyan-50 border border-cyan-100 grid place-items-center text-cyan-700">
<i class="fa-solid fa-lock text-[11px] leading-none"></i>
</span>
<span class="text-[11px] font-semibold text-slate-700" data-i18n="pricing_pay_note">Simple &amp; secure payment â€” cancel anytime.</span>
</div>
</div>
<!-- If user is already Pro, show a simple status card (no prices) -->
<div class="hidden max-w-3xl mx-auto mb-6" id="pricing-pro-state">
<div class="rounded-2xl border border-cyan-100 bg-cyan-50/60 p-6 shadow-glass flex items-start gap-4">
<div class="w-11 h-11 rounded-2xl bg-BTrustOn-accent text-white flex items-center justify-center shadow-lg shadow-cyan-600/20 shrink-0">
<i class="fa-solid fa-gem"></i>
</div>
<div class="flex-1">
<div class="text-sm font-extrabold text-slate-900" data-i18n="pricing_pro_active_title">You're on Pro</div>
<div class="text-xs text-slate-600 mt-1" data-i18n="pricing_pro_active_desc" id="pricing-pro-active-desc">Your plan is active.</div>
</div>
<button class="px-4 py-2 rounded-xl bg-white border border-cyan-200 text-cyan-700 text-xs font-extrabold hover:bg-cyan-100/50 transition" data-i18n="pricing_pro_active_cta" onclick="openPostUpdateModal()">Post an Update</button>
</div>
</div>
<div class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto" id="pricing-plans-wrap">
<!-- FREE -->
<div class="bg-white/80 backdrop-blur border border-[rgba(15,23,42,.10)] rounded-3xl p-7 shadow-glass flex flex-col">
<div class="flex items-start justify-between gap-3 mb-5">
<div>
<div class="flex items-center gap-2">
<h3 class="text-sm font-extrabold text-slate-900 mb-0" data-i18n="pricing_plan_free">Free</h3>
<span class="text-[10px] font-extrabold bg-slate-50 text-slate-700 border border-slate-200 px-2 py-1 rounded-full" data-i18n="badge_starter">STARTER</span>
</div>
<p class="text-xs text-slate-500 mt-1" data-i18n="price_free_tag">For teams getting started.</p>
</div>
<span class="inline-flex items-center gap-1.5 text-[10px] font-extrabold text-slate-600 bg-white border border-slate-200 px-2.5 py-1 rounded-full">
<i class="fa-solid fa-lock-open text-[10px] opacity-70"></i>
<span data-i18n="price_no_payment">NO PAYMENT</span>
</span>
</div>
<div class="mb-6 flex items-end gap-2">
<span class="text-4xl font-header font-bold text-slate-900" data-i18n="ui_0_d0a872">$0</span>
<span class="text-xs text-slate-400 mb-1" data-i18n="price_month">/month</span>
</div>
<ul class="text-xs text-slate-600 space-y-3 mb-6">
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bg-slate-50 border border-slate-200 grid place-items-center shrink-0">
<i class="fa-solid fa-check text-emerald-600 text-[11px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_free_1">Create a public company profile</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bg-slate-50 border border-slate-200 grid place-items-center shrink-0">
<i class="fa-solid fa-check text-emerald-600 text-[11px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_free_2">Limited projects, certificates &amp; assets</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bg-slate-50 border border-slate-200 grid place-items-center shrink-0">
<i class="fa-solid fa-check text-emerald-600 text-[11px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_free_3">Follow &amp; save companies + private notes</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bg-slate-50 border border-slate-200 grid place-items-center shrink-0">
<i class="fa-solid fa-check text-emerald-600 text-[11px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_free_4">Appear in search results</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bg-slate-50 border border-slate-200 grid place-items-center shrink-0">
<i class="fa-solid fa-check text-emerald-600 text-[11px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_free_5">Receive quote requests &amp; chat</span>
</li>
</ul>
<button class="mt-auto w-full border border-slate-200 bg-white text-xs font-extrabold text-slate-800 py-3 rounded-xl hover:bg-slate-50 hover:border-slate-300 transition" data-i18n="btn_join_free" id="btn-pricing-free" onclick="pricingChooseFree()">JOIN FREE</button>
</div>
<!-- PRO -->
<div class="relative rounded-3xl p-7 overflow-hidden flex flex-col bton-pro-card">

<div class="relative z-10 flex items-start justify-between gap-3 mb-5">
<div>
<div class="flex items-center gap-2">
<h3 class="text-sm font-extrabold mb-0" data-i18n="pricing_plan_pro">Pro</h3>
<span class="text-[10px] font-extrabold bg-amber-400 text-slate-900 px-2 py-1 rounded-full" data-i18n="badge_trial">3-MO FREE</span>
</div>
<p class="text-xs bton-pro-muted mt-1" data-i18n="price_pro_tag">For suppliers who want to win more work.</p>
</div>
<span class="text-[10px] font-extrabold bton-pro-pill-apple px-2 py-1 rounded-full" data-i18n="badge_popular">MOST POPULAR</span>
</div>
<div class="relative z-10 mb-5">
<div class="flex items-end gap-2">
<span class="text-4xl font-header font-bold" data-i18n="pricing_price_19">$19</span>
<span class="text-xs bton-pro-muted mb-1" data-i18n="price_month">/month</span>
</div>
<div class="mt-2 inline-flex items-center gap-2 rounded-full bton-pro-pill-apple px-3 py-1.5">
<i class="fa-solid fa-lock text-[10px] bton-pro-icon"></i>
<span class="text-[11px] bton-pro-muted">
<span data-i18n="price_trial_note">3 months free trial</span>
<span class="opacity-50" data-i18n="ui_53fe08"> â€¢ </span>
<span data-i18n="price_no_card">No card required</span>
</span>
</div>
</div>
<ul class="relative z-10 text-xs text-slate-700 space-y-3 mb-6">
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-circle-check bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_1">Verified badge after approval</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-infinity bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_2">Unlimited projects, certificates &amp; assets</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-bullhorn bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_3">Post Company Updates</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-images bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_4">Albums (galleries) for projects &amp; assets</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-arrow-up-right-dots bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_5">Priority visibility in search</span>
</li>
<li class="flex items-center gap-3">
<div class="w-8 h-8 rounded-xl bton-pro-iconbox grid place-items-center shrink-0">
<i class="fa-solid fa-bolt bton-pro-icon text-[12px] leading-none"></i>
</div>
<span class="leading-tight" data-i18n="price_pro_6">Easier access for buyers after verification</span>
</li>
</ul>
<button class="relative z-10 mt-auto w-full bton-pro-cta text-white text-xs font-extrabold py-3 rounded-xl hover:brightness-[0.98] transition" data-i18n="btn_start_trial" id="btn-pricing-pro" onclick="pricingChoosePro()">START FREE TRIAL</button>
</div>
</div>
</section>
</div></main>
</div>
<div class="hidden-view fade-in min-h-screen bg-gray-50 pb-20" id="view-editor">
<div class="bton-editor-hero text-slate-900 pt-24 pb-10 px-4 border-b border-slate-200/70">
<div class="max-w-4xl mx-auto">
<button class="mb-6 flex items-center gap-2 text-slate-600 hover:text-slate-900 transition text-xs font-bold tracking-wider group" onclick="openProfile(selectedCompany.id)">
<i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i><span data-i18n="ui_back_to_profile_92158f">BACK TO PROFILE</span></button>
<div class="flex items-center gap-4 mb-4">
<div class="w-12 h-12 rounded-full bg-slate-900/5 ring-1 ring-slate-900/5 flex items-center justify-center text-BTrustOn-accent text-xl">
<i class="fa-solid fa-user-pen"></i>
</div>
<div>
<h1 class="text-3xl font-header font-bold" data-i18n="ui_profile_editor_3714b1">Profile Editor</h1>
<p class="text-slate-600 text-sm" data-i18n="ui_manage_your_company_presence_on_92751f">Manage your company presence on BTrustOn</p>
</div>
</div>
</div>
</div>
<div class="max-w-4xl mx-auto px-4 -mt-8">
<div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
<div class="grid grid-cols-1 md:grid-cols-3 min-h-[600px]">
<div class="bg-slate-50 border-r border-gray-200 p-6">
<nav class="space-y-2 sticky top-6">
<button class="w-full text-left px-4 py-3 rounded-lg bg-white shadow-sm border border-gray-200 text-sm font-bold text-BTrustOn-primary border-l-4 border-l-BTrustOn-accent hover:bg-gray-50 transition" onclick="scrollToSection('section-general')">
<i class="fa-solid fa-building w-6 text-gray-400"></i><span data-i18n="ui_general_info_b3f8f8">General Info</span></button>

<button class="w-full text-left px-4 py-3 rounded-lg bg-white shadow-sm border border-gray-200 text-sm font-bold text-gray-700 border-l-4 border-l-transparent hover:border-l-BTrustOn-accent hover:bg-gray-50 transition" onclick="scrollToSection('section-services')">
<i class="fa-solid fa-screwdriver-wrench w-6 text-gray-400"></i><span data-i18n="ui_services_capabilities_724c56">Services &amp; Capabilities</span></button>

<div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-100">
<div class="flex justify-between items-center mb-2">
<h4 class="text-xs font-bold text-blue-800" data-i18n="ui_profile_strength_6ef8db">Profile Strength</h4>
<span class="text-xs font-bold text-blue-600" id="status-percent">0%</span>
</div>
<div class="w-full bg-blue-200 h-1.5 rounded-full mb-2 overflow-hidden">
<div class="bg-blue-600 h-1.5 rounded-full transition-all duration-700" id="progress-bar" style="width: 0%"></div>
</div>
<p class="text-[10px] text-blue-600" data-i18n="ui_complete_all_fields_to_strengthe_cd7669" id="status-text">Complete all fields to strengthen your profile.</p>
</div>
</nav>
</div>
<div class="col-span-2 p-8">
<form id="editor-form" onsubmit="event.preventDefault(); saveProfileData();">
<div class="bton-editor-header flex items-start gap-6 mb-10 pb-8">
<div class="w-24 h-24 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center overflow-hidden relative shadow-sm group" id="edit-logo-preview-container">
<i class="fa-solid fa-building text-3xl text-gray-300" id="edit-logo-icon"></i>
<img class="hidden w-full h-full object-cover" id="edit-logo-img"/>
<div class="absolute inset-0 bg-slate-900/60 hidden group-hover:flex flex-col items-center justify-center text-white transition-all backdrop-blur-[1px] cursor-pointer z-10" onclick="document.getElementById('edit-logo-input').click()">
<i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
<span class="text-[9px] font-bold uppercase tracking-widest" data-i18n="ui_change_421cfd">CHANGE</span>
</div>
</div>
<div class="flex flex-col gap-2">
<div>
<h4 class="text-sm font-bold text-gray-700" data-i18n="ui_company_logo_d32b09">Company Logo</h4>
<p class="text-xs text-gray-400" data-i18n="ui_recommended_400x400px_png_or_jpg_fdd2a8">Recommended: 400x400px, PNG or JPG.</p>
</div>
<input accept="image/*" class="hidden" id="edit-logo-input" onchange="handleLogoFromEdit(this)" type="file"/>
<div class="flex gap-2">
<button class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 hover:border-gray-400 transition" onclick="document.getElementById('edit-logo-input').click()" type="button">
<i class="fa-solid fa-upload mr-1"></i><span data-i18n="ui_upload_914124">Upload</span></button>
<button class="bg-red-50 border border-red-100 text-red-500 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition" data-i18n-title="attr_remove_logo_b1d721" onclick="deleteLogo()" data-i18n-title="ui_remove_logo" title="Remove Logo" type="button">
<i class="fa-solid fa-trash"></i>
</button>
</div>
</div>
</div>
<div class="space-y-12">
<div class="space-y-6 scroll-mt-6" id="section-general">
<h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 pb-2">
<span data-i18n="mc_section_general">General Information</span>
</h3>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
<span data-i18n="mc_field_company_name">Company Name</span> <span class="text-red-500" data-i18n="ui_3389da">*</span>
</label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 font-bold focus:outline-none transition" data-i18n-placeholder="mc_ph_company_name" id="edit-name" placeholder="e.g. Acme Construction" required="" type="text">
</input></div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="mc_field_country">Country</span> <span class="text-red-500" data-i18n="ui_3389da">*</span></label>
<select class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition bg-white" id="edit-country" required="">
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="mc_field_state_city">State/Province &amp; City</span> <span class="text-red-500" data-i18n="ui_3389da">*</span></label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" data-i18n-placeholder="ph_edit_state_city" id="edit-city" placeholder="e.g., San Francisco, CA" required="" type="text"/>
<p class="text-[11px] text-gray-400 mt-1 leading-tight" data-i18n="help_state_city">Use city + state/province abbreviation when available.</p>
</div>
</div>
<div class="mt-4">
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_address">
        Official Address
    </label>
<textarea class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition resize-none" id="edit-address" data-i18n-placeholder="ui_placeholder_official_address_full_7c2a1a" placeholder="Headquarters full address (Street, No, District...)" rows="2"></textarea>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="field_sector">Sector</span><span class="text-red-500" data-i18n="ui_3389da">*</span></label>
<select class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition bg-white" id="edit-sector" required="">
<option data-i18n="ui_select_sector_ecf146" value="">Select sectorâ€¦</option>
<option data-i18n="sec_const" value="construction">Construction &amp; Infrastructure</option>
<option data-i18n="sec_energy" value="energy">Energy &amp; Oil/Gas</option>
<option data-i18n="sec_mine" value="mining">Mining &amp; Metals</option>
<option data-i18n="sec_manu" value="manufacturing">Manufacturing &amp; Machinery</option>
<option data-i18n="sec_tech" value="technology">Technology &amp; Automation</option>
<option data-i18n="sec_logi" value="logistics">Logistics &amp; Trade</option>
<option data-i18n="sec_eng" value="engineering">Engineering &amp; Services</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="mc_field_tagline">Tagline (Slogan)</span></label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" data-i18n-placeholder="mc_ph_tagline" id="edit-tagline" placeholder="e.g. Building the Future" type="text"/>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="mc_field_website">Website</span></label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" data-i18n-placeholder="mc_ph_website" id="edit-website" placeholder="www.example.com" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="mc_field_phone">Phone</span></label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" data-i18n-placeholder="mc_ph_phone" id="edit-phone" placeholder="+ (Country Code) Phone Number" type="text"/>
</div>
</div>
<div class="mt-4">
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
<span data-i18n="mc_field_public_email">Public Contact Email</span> <span class="text-gray-400 font-normal lowercase" data-i18n="ui_optional_f53d1c">(optional)</span>
</label>
<input class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" data-i18n-placeholder="ph_edit_email" id="edit-email" placeholder="info@company.com (If different from login email)" type="email"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_desc">Description</label>
<textarea class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" id="edit-desc" data-i18n-placeholder="ui_placeholder_describe_company_3f91b2" placeholder="Describe your company's core capabilities..." rows="4"></textarea>
</div>
<div class="grid grid-cols-3 gap-4">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_type">Type</label>
<select class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-white outline-none text-sm" id="edit-type">
<option data-i18n="join_type_operator" value="Operator">Operator / Asset Owner</option>
<option data-i18n="join_type_contractor" value="EPC Contractor">EPC / General Contractor</option>
<option data-i18n="join_type_subcontractor" value="Subcontractor">Subcontractor / Specialist</option>
<option data-i18n="join_type_manufacturer" value="Manufacturer">Manufacturer / OEM</option>
<option data-i18n="join_type_distributor" value="Distributor">Distributor / Supplier</option>
<option data-i18n="join_type_engineering_consultancy" value="Engineering">Engineering &amp; Consultancy</option>
<option data-i18n="join_type_technology_software" value="Technology">Technology &amp; Software</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_size">Size</label>
<select class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-white outline-none text-sm" id="edit-size">
<option data-i18n="ui_1_10_dd56b7" value="1-10 employees">1-10</option>
<option data-i18n="ui_10_50_1d0a71" value="10-50 employees">10-50</option>
<option data-i18n="ui_50_100_2e2327" value="50-100 employees">50-100</option>
<option data-i18n="ui_100_250_a70da8" value="100-250 employees">100-250</option>
<option data-i18n="ui_250_0e702a" value="250+ employees">250+</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_year">Year</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none text-sm" id="edit-year" placeholder="2012" type="number"/>
</div>
</div>
</div>
<div class="space-y-6 scroll-mt-6" id="section-services">
<h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 pb-2" data-i18n="ui_services_capabilities_724c56">
      Services &amp; Capabilities
    </h3>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_services">
          Core Competencies (Tags)
        </label>
<p class="text-[11px] text-gray-400 mb-2" data-i18n="ui_comma_separated_keywords_e_g_epc_411422">Comma separated keywords. e.g. EPC, Excavation, Maintenance</p>
<input id="edit-services" type="hidden">
<input id="edit-services-featured" type="hidden"/>
<div class="mt-3">
<div class="flex items-center justify-between mb-2">
<div class="text-[11px] text-gray-400"><span data-i18n="ui_tip_add_services_as_tags_a9d576">Tip: Add services as tags.</span><span class="font-bold" data-i18n="ui_drag_b8a4d4">Drag</span><span data-i18n="ui_to_reorder_and_click_to_mark_any_ed0079">to reorder, and click â­ to mark any item as</span><span class="font-bold" data-i18n="svc_featured">Featured</span><span data-i18n="ui_we_show_up_to_17909e">. We show up to</span><span class="font-bold">5</span><span data-i18n="ui_featured_items_on_the_profile_he_b9fe8e">featured items on the profile header.</span></div>
<button class="text-[10px] font-bold text-gray-400 hover:text-red-500 transition" data-i18n="ui_clear_dc30bc" onclick="clearServiceTags()" type="button">
              Clear
            </button>
</div>
<div class="flex flex-wrap gap-2" id="svc-tags"></div>
<div class="relative mt-3">
<i class="fa-solid fa-plus absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
<input autocomplete="off" class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2.5 text-sm text-gray-700 font-semibold focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition bg-white" data-i18n-placeholder="ph_svc_add_input" id="svc-add-input" oninput="serviceSuggest(this.value)" onkeydown="serviceAddKeydown(event)" placeholder="Add a service (type and press Enter)â€¦" type="text"/>
<div class="absolute z-30 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden hidden" id="svc-suggest"></div>
</div>
<p class="text-[10px] text-gray-400 mt-2" data-i18n="ui_examples_epc_drilling_crushing_s_a0e593">
            Examples: EPC, Drilling, Crushing &amp; Screening, Equipment Rental, Maintenance, Engineering Design.
          </p>
</div>
</input></div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_service_details">
          Detailed Service Description
        </label>
<p class="text-[11px] text-gray-400 mb-2" data-i18n="ui_explain_your_capabilities_capaci_234d0e">Explain your capabilities, capacity, and technical approach.</p>
<textarea class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" id="edit-service-details" data-i18n-placeholder="ph_edit_service_details" placeholder="e.g. Our excavation team operates with a capacity of 5000m3/day..." rows="5"></textarea>
</div>
</div>
<div class="mt-5 pt-5 border-t border-gray-200 mb-6">
<div class="flex items-center justify-between mb-6">
<div>
<h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
<i class="fa-solid fa-user-tie text-BTrustOn-accent"></i><span data-i18n="ui_key_contact_owner_cf53cd">Key Contact / Owner</span></h3>
<p class="text-xs text-gray-500 mt-1" data-i18n="ui_optional_introduce_the_person_be_6b0677">Optional: Introduce the person behind the business.</p>
</div>
<label class="relative inline-flex items-center cursor-pointer group">
<input class="sr-only peer" id="edit-owner-toggle" onchange="toggleOwnerSection()" type="checkbox"/>
<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-BTrustOn-accent shadow-inner"></div>
<span class="ml-3 text-xs font-bold text-gray-400 group-hover:text-gray-600 transition" data-i18n="lbl_edit_owner_toggle">Show</span>
</label>
</div>
<div class="hidden space-y-5 bg-white p-6 rounded-2xl border border-gray-200 shadow-sm transition-all relative overflow-hidden" id="owner-inputs">
<div class="absolute top-0 right-0 w-32 h-32 bg-gray-50 rounded-bl-full -mr-10 -mt-10 z-0 pointer-events-none"></div>
<div class="flex flex-col md:flex-row items-start gap-6 relative z-10">
<div class="shrink-0 flex flex-col items-center gap-2">
<div class="bton-avatar-uploader w-20 h-20 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group cursor-pointer hover:border-BTrustOn-accent transition-colors" onclick="triggerOwnerPhotoUpload('edit')">
<img class="hidden w-full h-full object-cover" id="preview-owner-img"/>
<i class="fa-solid fa-camera text-gray-300 text-2xl group-hover:text-BTrustOn-accent transition-colors" id="icon-owner-img"></i>
</div>
<input accept="image/*" class="hidden" id="edit-owner-photo" onchange="handleOwnerPhotoPicked(this)" type="file"/>
<button class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:underline transition" data-i18n="ui_remove_photo_bbcb29" onclick="deleteOwnerPhoto()" type="button">
                    Remove Photo
                 </button>
</div>
<div class="flex-1 w-full space-y-4">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5" data-i18n="lbl_edit_owner_name">Full Name</label>
<div class="relative">
<i class="fa-solid fa-signature absolute left-3 top-3 text-gray-400"></i>
<input class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2.5 text-sm font-semibold text-gray-700 focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" data-i18n-placeholder="ph_edit_owner_name" id="edit-owner-name" placeholder="e.g. John Doe" type="text"/>
</div>
</div>
<div>
<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5" data-i18n="lbl_edit_owner_role">Role / Title</label>
<div class="relative">
<i class="fa-solid fa-briefcase absolute left-3 top-3 text-gray-400"></i>
<input class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2.5 text-sm text-gray-700 focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" data-i18n-placeholder="ph_edit_owner_role" id="edit-owner-role" placeholder="e.g. Founder &amp; CEO" type="text"/>
</div>
</div>
</div>
<div>
<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5" data-i18n="lbl_edit_owner_linkedin">LinkedIn Profile</label>
<div class="relative group/link">
<div class="absolute left-3 top-2.5 bg-white rounded-full z-10">
<i class="fa-brands fa-linkedin text-blue-600 text-lg"></i>
</div>
<input class="w-full border border-gray-300 rounded-lg pl-10 pr-3 py-2.5 text-sm text-blue-700 font-medium placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" id="edit-owner-linkedin" placeholder="https://linkedin.com/in/username" type="text"/>
<div class="absolute right-3 top-3 opacity-0 group-hover/link:opacity-100 transition text-[10px] text-gray-400 font-bold pointer-events-none">
<i class="fa-solid fa-link"></i><span data-i18n="ui_public_url_38a243">Public URL</span></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="mt-8 border border-blue-100 rounded-xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md">
<div class="bg-gradient-to-br from-slate-50 to-white p-6 text-center" id="verify-locked-view">
<div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
<i class="fa-solid fa-lock"></i>
</div>
<h3 class="text-sm font-bold text-gray-800 mb-2" data-i18n="ui_get_verified_status_706b0e">Get Verified Status</h3>
<p class="text-xs text-gray-500 mb-5 max-w-xs mx-auto leading-relaxed"><span data-i18n="ui_gain_trust_instantly_with_a_d6e1c8">Gain trust instantly with a</span><i class="fa-solid fa-circle-check text-blue-500"></i> <strong data-i18n="celebration_badge_label">Blue Badge</strong><span data-i18n="ui_exclusive_to_pro_plan_members_2d54f9">. Exclusive to Pro Plan members.</span></p>
<button class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-6 py-3 rounded-full text-xs font-bold hover:shadow-lg hover:scale-105 transition transform" data-i18n="ui_verify_my_business_189794" onclick="handleVerifyClick()" type="button">
            VERIFY MY BUSINESS
        </button>
</div>
<div class="hidden bg-blue-50/50 p-6" id="verify-form-view">
<div class="flex items-start gap-4">
<div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 grid place-items-center shrink-0">
<i class="fa-solid fa-shield-check"></i>
</div>
<div class="flex-1">
<h3 class="text-sm font-bold text-gray-800 mb-1" data-i18n="ui_official_verification_28c101">Official Verification</h3>
<p class="text-xs text-gray-500 mb-4" data-i18n="ui_submit_your_official_tax_details_4f896b">
                    Submit your official tax details. Our compliance team will verify within 24h.
                </p>
<div class="hidden mb-4 p-3 rounded-lg text-[11px] font-bold border flex items-center gap-2" id="verify-status-alert"></div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="md:col-span-2">
  <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_reg_no">Registration No.</label>
  <input class="input-field w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" id="edit-reg-no" placeholder="Registration / Entity number" type="text"/>
  <p class="text-[10px] text-gray-400 mt-1 leading-snug" id="edit-regno-help"></p>
</div>

<div id="edit-regregion-wrap" class="hidden">
  <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1" id="edit-regregion-label">State</label>
  <input class="input-field w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" id="edit-reg-region" placeholder="e.g., Delaware" type="text"/>
</div>

<div>
  <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_registry_link_optional">Registry link (optional)</label>
  <input class="input-field w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" id="edit-reg-url" placeholder="Official registry URL (optional)" type="text"/>
</div>
</div>
<div class="mt-4 flex justify-end">
<button class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 transition" data-i18n="ui_submit_documentation_4aed11" id="btn-verify-submit" onclick="submitVerificationRequest()" type="button">
                        SUBMIT DOCUMENTATION
                    </button>
</div>
</div>
</div>
</div>
</div>
<div class="pt-6 border-t border-gray-100 flex items-center justify-end gap-3 sticky bottom-0 bg-white pb-2">
<button class="px-6 py-3 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition" data-i18n="btn_cancel" onclick="openProfile(selectedCompany.id)" type="button">
                                  Cancel
                                </button>
<button class="bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-cyan-500/30 transition transform hover:-translate-y-0.5" type="submit">
<i class="fa-solid fa-save mr-2"></i><span data-i18n="ui_save_preview_0bbe54">Save &amp; Preview</span></button>
</div>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
<div class="hidden-view fade-in min-h-screen bg-white/50 backdrop-blur-sm" id="view-profile">
<!-- âœ… PROFILE SKELETON OVERLAY -->
<div class="hidden fixed inset-0 z-[9998] bg-white/90 backdrop-blur-md" id="profile-skeleton">
<span class="sr-only" data-i18n="ui_loading_5f02f0">Loadingâ€¦</span>
<div class="max-w-6xl mx-auto px-6 py-10">
<div class="flex items-center justify-between">
<div class="skel h-6 w-40"></div>
<div aria-hidden="true" class="flex items-center gap-3">
  <div class="skel h-8 w-8 rounded-full"></div>
  <div class="skel h-4 w-16 rounded"></div>
</div>
</div>
<div class="mt-6 skel h-44 w-full rounded-3xl"></div>
<div class="mt-6 flex gap-4 items-start">
<div class="skel w-24 h-24 rounded-2xl"></div>
<div class="flex-1 space-y-3">
<div class="skel h-6 w-64"></div>
<div class="skel h-4 w-[28rem] max-w-full"></div>
<div class="flex gap-2 mt-2">
<div class="skel h-7 w-24 rounded-full"></div>
<div class="skel h-7 w-28 rounded-full"></div>
<div class="skel h-7 w-20 rounded-full"></div>
</div>
</div>
</div>
<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="skel h-28 rounded-2xl"></div>
<div class="skel h-28 rounded-2xl"></div>
<div class="skel h-28 rounded-2xl"></div>
</div>
</div>
</div>
<div id="profile-header-wrap" class="bg-gradient-to-r from-slate-50 via-white to-cyan-50/60 border-b border-BTrustOn-border pb-12 pt-12 relative overflow-hidden backdrop-blur-xl">
<div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row gap-8 items-start relative z-10">
<div class="bton-avatar-premium w-32 h-32 rounded-2xl border border-transparent shadow-xl flex items-center justify-center bg-white/90 shrink-0 overflow-hidden relative transition-all" id="p-logo-container">
<i class="fa-solid fa-building text-5xl text-gray-300" id="p-default-icon"></i>
<img alt="Company Logo" class="hidden w-full h-full object-cover" id="p-logo-image">
<div class="hidden" id="p-logo-overlay">
<i class="fa-solid fa-camera text-2xl mb-1"></i>
<span class="text-[9px] font-bold uppercase tracking-widest" data-i18n="ui_update_15a802">UPDATE</span>
</div>
<input accept="image/*" class="hidden" id="profile-logo-input" onchange="handleLogoFromProfile(this)" onclick="event.stopPropagation()" type="file"/>
</img></div>
<div class="flex-grow">
<div class="flex flex-wrap items-center gap-4 mb-3 company-name-row" id="p-name-row">
<h1 class="text-4xl font-header font-bold text-BTrustOn-primary" id="p-name">
            Company Name
          </h1>
<div class="flex flex-wrap items-center gap-2">
<div class="flex flex-wrap gap-2" id="p-badge"></div>
</div>
</div>
<div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 mb-4">
<span class="font-semibold text-gray-700" id="p-type-tag">
            Industrial Supplier
          </span>
<span data-i18n="ui_53fe08">â€¢</span>
<span id="p-size-tag">â€”</span>
<span data-i18n="ui_53fe08">â€¢</span>
<span id="p-year-tag">â€”</span>
</div>
<div class="hidden mb-8 relative pl-6 border-l-4 border-BTrustOn-accent/40 mt-2" id="p-tagline-container">
<i class="fa-solid fa-quote-left absolute -top-3 -left-3 text-3xl text-BTrustOn-accent/10 bg-white/50 backdrop-blur-sm p-1 rounded-full"></i>
<p class="text-base md:text-lg font-semibold italic bton-overview-tagline leading-relaxed" id="p-tagline">
</p>
</div>
<p class="bton-overview-desc mb-5 max-w-3xl whitespace-pre-line break-words" id="p-desc">
  Description
</p>
<div class="flex flex-wrap gap-4 text-sm" id="p-chips-row">
<span class="bton-chip-soft">
<i class="fa-solid fa-location-dot text-BTrustOn-accent"></i>
<span class="font-semibold text-gray-700" id="p-city">City</span>
</span>
<span class="bton-chip-soft">
<i class="fa-solid fa-layer-group text-BTrustOn-accent"></i>
<span class="capitalize font-semibold text-gray-700" id="p-sector">Sector</span>
</span>
</div>
<div id="p-edit-mobile-slot" class="flex justify-end"></div>
</div>
<div class="flex items-center gap-3 shrink-0 relative z-20">
<button class="hidden-view w-12 h-12 rounded-full bg-white text-gray-500 border border-gray-200 hover:bg-BTrustOn-accent hover:text-white hover:border-BTrustOn-accent transition shadow-sm flex items-center justify-center text-lg group relative" data-i18n-title="attr_edit_profile_1860fb" id="btn-edit-profile" onclick="editMyProfile()" title="Edit Profile">
<i class="fa-solid fa-pen"></i>
<span class="bton-edit-label" data-i18n="ui_edit">Edit</span>
</button>
<button class="hidden w-12 h-12 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-slate-50 hover:border-BTrustOn-accent transition shadow-sm flex items-center justify-center text-lg group relative" data-i18n-title="attr_save_company_ce1325" id="btn-save-company" onclick="toggleSaveCompany(selectedCompany &amp;&amp; selectedCompany.id)" title="Save company" data-i18n-title="ui_save_company">
<i class="fa-regular fa-bookmark text-BTrustOn-accent" id="icon-save-company"></i>
</button>
<button class="hidden w-12 h-12 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-slate-50 hover:border-BTrustOn-accent transition shadow-sm flex items-center justify-center text-lg group relative" data-i18n-title="attr_follow_company_730ad4" id="btn-follow-company" onclick="toggleCompanyFollow(event, selectedCompany &amp;&amp; selectedCompany.id, selectedCompany &amp;&amp; (selectedCompany.name || selectedCompany.company_name || ''))" title="Follow company">
<i class="fa-solid fa-tower-broadcast text-BTrustOn-accent opacity-40" id="icon-follow-company"></i>
</button>
<button class="bton-nav-pill bton-pill-primary inline-flex items-center gap-3 px-5 py-3 rounded-xl text-[11px] font-extrabold uppercase tracking-[.12em]" id="btn-req-quote" onclick="openQuoteModal(selectedCompany.id, selectedCompany.name)">
<span class="bton-nav-mini-ic"><i class="fa-solid fa-paper-plane"></i></span>
<span class="bton-pill-label" data-i18n="req_quote">REQUEST QUOTE</span>
</button>
</div>
</div>
</div>
<main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 sm:grid-cols-12 gap-8">
<div class="sm:col-span-8 space-y-8">
<div class="bton-profile-tabbar border-b border-gray-200 flex gap-1 text-xs font-bold text-gray-500 overflow-x-auto no-scrollbar">
<button class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-BTrustOn-accent bg-cyan-50/50 transition whitespace-nowrap" id="tab-overview" onclick="switchProfileTab('overview')">
<i class="fa-solid fa-building text-[11px]"></i>
<span data-i18n="tab_overview">OVERVIEW</span>
</button>
<button class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap" id="tab-projects" onclick="switchProfileTab('projects')">
<i class="fa-solid fa-diagram-project text-[11px]"></i>
<span data-i18n="tab_projects">PROJECTS</span>
</button>
<button class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap" id="tab-certs" onclick="switchProfileTab('certs')">
<i class="fa-solid fa-certificate text-[11px]"></i>
<span data-i18n="tab_certs">CERTIFICATES</span>
</button>
<button class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap" id="tab-assets" onclick="switchProfileTab('assets')">
<i class="fa-solid fa-boxes-stacked text-[11px]"></i>
<span data-i18n="tab_assets">ASSETS</span>
</button>
</div>
<div id="content-overview">
<div class="bton-tab-head"><h3 class="bton-tab-title font-header" data-i18n="lbl_services">
            Core Services
          </h3></div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8" id="p-services-grid"></div>
</div>
<div class="hidden-view" id="content-projects">
<div class="bton-tab-head flex items-center justify-between">
<div>
<h3 class="bton-tab-title font-header" data-i18n="proj_key_ref">Key Reference Projects</h3>
<span class="text-[11px] text-gray-400" data-i18n="proj_selected_from_supplier">Selected projects from this company</span>
</div>
<button class="hidden-view bton-add-btn" id="btn-add-project" onclick="openProjectModal()" type="button"><span class="bton-add-ic"><i class="fa-solid fa-plus"></i></span><span class="bton-add-txt" data-i18n="ui_add_new_project_17bde1">Add New Project</span></button>
</div>
<div class="relative bg-white/80 backdrop-blur rounded-2xl border border-[rgba(15,23,42,.08)] overflow-hidden shadow-sm">
<div class="bton-accent-line"></div>
<div class="p-4 md:p-5">
<div class="flex flex-col md:flex-row md:items-center gap-3">
<div class="relative w-full md:w-80">
<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
<input class="w-full pl-9 pr-3 py-2 rounded-xl border border-[rgba(15,23,42,.10)] bg-white/70 text-[12px] font-semibold text-slate-700 placeholder:text-slate-400 focus:outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent transition" data-i18n-placeholder="ph_proj_search" id="proj-search" placeholder="Search projectsâ€¦" type="text"/>
</div>
<div class="flex-1"></div>
<div class="relative w-full md:w-52">
<select class="w-full border border-[rgba(15,23,42,.10)] bg-white/70 rounded-xl px-3 py-2 text-[12px] font-semibold text-slate-700 outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer" id="proj-sort" onchange="sortProjectsUI(this.value)">
<option data-i18n="ui_newest_first_88241d" value="newest">Newest first</option>
<option data-i18n="ui_oldest_first_799c95" value="oldest">Oldest first</option>
<option data-i18n="ui_title_a_z_455e15" value="az">Title A â†’ Z</option>
</select>
<i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] pointer-events-none"></i>
</div>
</div>
<div class="mt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="p-projects-list"></div>
</div>
</div>
</div>
<div class="hidden-view" id="content-certs">
<div class="bton-tab-head flex items-center justify-between">
<div>
<h3 class="bton-tab-title font-header" data-i18n="certs_title">Certifications</h3>
<span class="text-[11px] text-gray-400" data-i18n="certs_sub">Declared certificates</span>
</div>
<button class="hidden-view bton-add-btn" id="btn-add-cert" onclick="openCertModal()" type="button"><span class="bton-add-ic"><i class="fa-solid fa-plus"></i></span><span class="bton-add-txt" data-i18n="ui_add_certificate_7159a1">Add Certificate</span></button>
</div>
<div class="relative bg-white/80 backdrop-blur rounded-2xl border border-[rgba(15,23,42,.08)] overflow-hidden shadow-sm">
<div class="bton-accent-line"></div>
<div class="p-4 md:p-5">
<div class="flex flex-col md:flex-row md:items-center gap-3 mb-4" id="cert-controls">
<div class="flex flex-wrap items-center gap-2">
<button class="cert-filter-btn px-3 py-2 rounded-full border border-[rgba(15,23,42,.10)] bg-white/70 backdrop-blur text-[11px] font-extrabold text-slate-600 hover:bg-white hover:border-cyan-200 hover:text-slate-800 transition shadow-sm" data-filter="all" data-i18n="ui_all_b1c94c" type="button">All</button>
<button class="cert-filter-btn px-3 py-2 rounded-full border border-[rgba(15,23,42,.10)] bg-white/70 backdrop-blur text-[11px] font-extrabold text-slate-600 hover:bg-white hover:border-cyan-200 hover:text-slate-800 transition shadow-sm" data-filter="valid" data-i18n="ui_valid_3ac705" type="button">Valid</button>
<button class="cert-filter-btn px-3 py-2 rounded-full border border-[rgba(15,23,42,.10)] bg-white/70 backdrop-blur text-[11px] font-extrabold text-slate-600 hover:bg-white hover:border-cyan-200 hover:text-slate-800 transition shadow-sm" data-filter="expired" data-i18n="ui_expired_24fe48" type="button">Expired</button>
<button class="cert-filter-btn px-3 py-2 rounded-full border border-[rgba(15,23,42,.10)] bg-white/70 backdrop-blur text-[11px] font-extrabold text-slate-600 hover:bg-white hover:border-cyan-200 hover:text-slate-800 transition shadow-sm" data-filter="docs" data-i18n="ui_with_document_8ef28a" type="button">With Document</button>
</div>
<div class="flex-1"></div>
<div class="relative w-full md:w-80">
<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
<input class="w-full border border-[rgba(15,23,42,.10)] bg-white/80 backdrop-blur rounded-xl shadow-sm pl-9 pr-3 py-2.5 text-[12px] text-gray-700 font-semibold outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent transition" data-i18n-placeholder="ph_cert_search" id="cert-search" placeholder="Search certificates (name or issuer)â€¦" type="text"/>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="p-certs-list"></div>
</div>
</div>
</div>
<div class="hidden-view" id="content-assets">
<div class="bton-tab-head flex items-center justify-between">
<div>
<h3 class="bton-tab-title font-header" data-i18n="assets_title">Equipment &amp; Assets</h3>
<span class="text-[11px] text-gray-400" data-i18n="assets_sub">Declared assets of this company</span>
</div>
<button class="hidden-view bton-add-btn" id="btn-add-asset" onclick="openAssetModal()" type="button"><span class="bton-add-ic"><i class="fa-solid fa-plus"></i></span><span class="bton-add-txt" data-i18n="ui_add_new_asset_3632ed">Add New Asset</span></button>
</div>
<div class="relative bg-white/80 backdrop-blur rounded-2xl border border-[rgba(15,23,42,.08)] overflow-hidden shadow-sm">
<div class="bton-accent-line"></div>
<div class="p-4 md:p-5">
<!-- Controls -->
<div class="flex flex-col md:flex-row md:items-center gap-3">
<div class="relative w-full md:w-80">
<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
<input class="w-full pl-9 pr-3 py-2 rounded-xl border border-[rgba(15,23,42,.10)] bg-white/70 text-[12px] font-semibold text-slate-700 placeholder:text-slate-400 focus:outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent transition" data-i18n-placeholder="ph_asset_search" id="asset-search" oninput="filterAssetsUI()" placeholder="Search assetsâ€¦" type="text"/>
</div>
<div class="flex-1"></div>
<div class="relative w-full md:w-52">
<select class="w-full border border-[rgba(15,23,42,.10)] bg-white/70 rounded-xl px-3 py-2 text-[12px] font-semibold text-slate-700 outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer" id="asset-filter-status" onchange="filterAssetsUI()">
<option data-i18n="asset_status_all" value="all">All Status</option>
<option data-i18n="asset_status_available" value="available">Available</option>
<option data-i18n="asset_status_maintenance" value="maintenance">Under Maintenance</option>
<option data-i18n="asset_status_out" value="out">Out of Service</option>
</select>
<i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] pointer-events-none"></i>
</div>
<div class="relative w-full md:w-52">
<select class="w-full border border-[rgba(15,23,42,.10)] bg-white/70 rounded-xl px-3 py-2 text-[12px] font-semibold text-slate-700 outline-none focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer" id="asset-sort" onchange="sortAssetsUI(this.value)">
<option data-i18n="ui_newest_first_88241d" value="newest">Newest first</option>
<option data-i18n="ui_oldest_first_799c95" value="oldest">Oldest first</option>
<option data-i18n="ui_name_a_z_d1c4c3" value="az">Name A â†’ Z</option>
<option data-i18n="ui_status_available_first_bc5a8a" value="status">Status (Available first)</option>
<option data-i18n="ui_qty_high_low_3e8a18" value="qtydesc">Qty: High â†’ Low</option>
</select>
<i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] pointer-events-none"></i>
</div>
</div>
<div class="mt-4">
<div class="hidden" id="p-assets-empty">
<div class="rounded-2xl border border-[rgba(15,23,42,.08)] bg-white/70 backdrop-blur px-5 py-4 shadow-sm">
<div class="flex items-start gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-slate-50/80 border border-slate-200 text-slate-700 shadow-sm items-center justify-center shrink-0">
<i class="fa-solid fa-boxes-stacked text-[13px] opacity-90"></i>
</span>
<div class="min-w-0">
<div class="text-[13px] font-extrabold text-slate-800" data-i18n="ui_no_assets_found_73e934">No assets found</div>
<div class="mt-1 text-[11px] text-slate-500" data-i18n="ui_this_company_hasn_t_listed_any_a_410cda">This company hasnâ€™t listed any assets yet.</div>
<button class="bton-empty-action hidden" id="p-assets-empty-cta" type="button" onclick="openAssetModal()">
  <i class="fa-solid fa-plus"></i>
  <span data-i18n="empty_add_asset_btn">Add asset</span>
</button>
</div>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="p-assets-grid"></div>
</div>
</div>
</div>
</div>
</div> <div class="sm:col-span-4 space-y-6">
<div class="sticky top-28 space-y-6">
<div class="hidden bg-white border border-blue-100 rounded-2xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md relative group" id="profile-verify-widget">
<div class="bg-gradient-to-br from-slate-50 to-white p-5 text-center relative" id="widget-locked-view">
<div class="absolute top-2 right-2 text-gray-300"><i class="fa-solid fa-crown"></i></div>
<div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full grid place-items-center mx-auto mb-2 shadow-sm">
<i class="fa-solid fa-lock text-sm"></i>
</div>
<h3 class="text-xs font-bold text-gray-800 mb-1" data-i18n="ui_get_verified_badge_0be08e">Get Verified Badge</h3>
<p class="text-[10px] text-gray-500 mb-3 leading-relaxed px-2"><span data-i18n="ui_unlock_the_91a490">Unlock the</span><i class="fa-solid fa-circle-check text-blue-500"></i><span data-i18n="ui_badge_exclusive_to_pro_members_20cf16">badge. Exclusive to Pro members.</span></p>
<button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-[10px] font-bold transition shadow-lg shadow-blue-600/20" data-i18n="ui_verify_my_business_189794" onclick="handleVerifyClick()">
                        VERIFY MY BUSINESS
                    </button>
</div>
<div class="hidden bg-white p-5" id="widget-form-view">
<div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-3">
<div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0">
<i class="fa-solid fa-shield-check text-sm"></i>
</div>
<div>
<h3 class="text-xs font-bold text-gray-800" data-i18n="ui_official_verification_28c101">Official Verification</h3>
<p class="text-[9px] text-gray-400" data-i18n="ui_submit_tax_details_a51891">Submit tax details.</p>
</div>
</div>
<div class="hidden mb-3 p-2 rounded-lg text-[10px] font-bold border flex items-center gap-2" id="widget-status-alert"></div>
<div class="space-y-3">
<div>
  <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_reg_no">Registration No.</label>
  <input class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" id="widget-reg-no" placeholder="Registration / Entity number" type="text"/>
  <p class="text-[9px] text-gray-400 mt-1 leading-snug" id="widget-regno-help"></p>
</div>

<div id="widget-regregion-wrap" class="hidden">
  <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-1" id="widget-regregion-label">State</label>
  <input class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" id="widget-reg-region" placeholder="e.g., Delaware" type="text"/>
</div>

<div>
  <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_registry_link_optional">Registry link (optional)</label>
  <input class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" id="widget-reg-url" placeholder="Official registry URL (optional)" type="text"/>
</div>
<button class="w-full bg-slate-800 text-white py-2.5 rounded-lg text-[10px] font-bold hover:bg-slate-900 transition" data-i18n="ui_submit_82b1fb" id="btn-widget-submit" onclick="submitVerificationRequest('widget')" type="button">
                            SUBMIT
                        </button>
</div>
</div>
</div>
<div class="hidden bg-white rounded-2xl p-6 shadow-[0_10px_40px_-15px_rgba(0,0,0,0.1)] border border-gray-100 relative overflow-visible group hover:shadow-[0_20px_50px_-20px_rgba(6,182,212,0.15)] transition-all duration-500" id="profile-analytics-card">
<div class="absolute top-0 right-0 w-64 h-64 bg-cyan-50/50 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
<div class="relative z-10">
<div class="flex items-center justify-between mb-6">
<h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
<i class="fa-solid fa-chart-line text-BTrustOn-accent"></i>
<span data-i18n="profile_analytics">Profile Analytics</span>
</h3>
<div class="flex items-center gap-2">
<button class="hidden items-center gap-2 px-3 py-2 rounded-xl text-[10px] font-extrabold border border-slate-700 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 text-white shadow-sm hover:shadow-md hover:scale-[1.01] transition transform" id="btn-card-upgrade" onclick="openUpgradeModal()">
<span class="w-6 h-6 rounded-lg flex items-center justify-center bg-white/10 border border-white/15 shadow-sm">
<i class="fa-solid fa-gem text-emerald-200 text-[11px]"></i>
</span>
<span class="tracking-wide" data-i18n="btn_upgrade_pro">GO PRO</span>
</button>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div class="relative group/list">
<div class="bg-gradient-to-br from-white to-cyan-50 border border-cyan-100 p-4 rounded-xl text-center cursor-default transition hover:border-cyan-300 hover:shadow-md">
<div class="text-3xl font-header font-bold text-BTrustOn-primary mb-1" id="stat-partner-count">-</div>
<div class="text-[10px] font-bold text-cyan-600 uppercase tracking-wide" data-i18n="ui_partners_fd6df3">Partners</div>
<div class="text-[9px] text-gray-400 mt-1" data-i18n="ui_registered_companies_d7e0de">Registered Companies</div>
</div>
<div class="absolute left-0 bottom-full mb-3 w-64 bg-white/95 backdrop-blur-xl border border-gray-200 rounded-xl shadow-2xl opacity-0 invisible group-hover/list:opacity-100 group-hover/list:visible transition-all duration-300 transform translate-y-2 group-hover/list:translate-y-0 z-50 overflow-hidden">
<div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
<span class="text-[10px] font-bold text-gray-500 uppercase" data-i18n="ui_recent_viewers_31361c">Recent Viewers</span>
<i class="fa-solid fa-eye text-cyan-400 text-xs"></i>
</div>
<div class="max-h-48 overflow-y-auto custom-scrollbar p-1" id="stat-partner-list">
<div class="p-3 text-center text-[10px] text-gray-400 italic" data-i18n="ui_no_views_yet_a35854">No views yet.</div>
</div>
<div class="absolute -bottom-2 left-8 w-4 h-4 bg-white border-b border-r border-gray-200 transform rotate-45"></div>
</div>
</div>
<div class="bg-white border border-gray-100 p-4 rounded-xl text-center">
<div class="text-3xl font-header font-bold text-gray-400 mb-1" id="stat-guest-count">-</div>
<div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide" data-i18n="ui_guests_4229e0">Guests</div>
<div class="text-[9px] text-gray-400 mt-1" data-i18n="ui_unregistered_users_af0593">Unregistered Users</div>
</div>
</div>
<p class="text-[10px] text-gray-400 mt-5 leading-relaxed text-center"><span data-i18n="ui_verified_profiles_rank_higher_in_4967d9">Verified profiles rank higher in search results.</span> <span class="text-BTrustOn-accent font-bold" data-i18n="plan_upgrade_title">Upgrade to Pro</span> <span data-i18n="ui_to_maximize_your_visibility_and_80eaa3">to maximize your visibility and reach more partners.</span></p>
</div>
</div>
<div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4" data-i18n="ui_contact_info_dbeeb2">Contact Info</h4>
<div class="space-y-4 text-sm text-gray-600">
<div class="flex items-center gap-3">
<div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
<i class="fa-solid fa-globe"></i>
</div>
<a class="text-BTrustOn-accent font-semibold hover:underline truncate flex-1 min-w-0" href="#" id="p-website-link" target="_blank">-</a>
</div>
<div class="flex items-center gap-3">
<div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
<i class="fa-solid fa-envelope"></i>
</div>
<span class="truncate flex-1 min-w-0" id="p-email-text">-</span>
</div>
<div class="flex items-center gap-3">
<div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
<i class="fa-solid fa-phone"></i>
</div>
<span class="truncate flex-1 min-w-0" id="p-phone-text">-</span>
</div>
<div class="flex items-start gap-3 pt-3 border-t border-gray-100 mt-3 hidden">
<div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 shrink-0 mt-0.5">
<i class="fa-solid fa-map-location-dot"></i>
</div>
<span class="text-xs text-gray-500 leading-relaxed italic flex-1 break-words min-w-0" id="p-address-text">
                            -
                        </span>
</div>
</div>
</div>
<div class="hidden animate-fade-in" id="sidebar-owner-view">
</div>
</div>
</div>
</main>
</div>
<!-- =========================
       CROPPER MODAL (Logo & Owner Photo)
       ========================= -->
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[99998]" id="modal-cropper">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCropperModal()"></div>
<div class="relative bg-white w-[95%] max-w-6xl rounded-2xl shadow-2xl border border-white/50 max-h-[92vh] overflow-hidden flex flex-col">
<div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-slate-50 to-white">
<div class="min-w-0">
<h3 class="text-sm md:text-base font-bold text-gray-900 truncate" data-i18n="cropper_title" id="cropper-title">Adjust Photo</h3>
<p class="text-[11px] text-gray-500" data-i18n="cropper_help">Drag to reposition, use the handles to zoom.</p>
</div>
<button class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-500 grid place-items-center transition" data-i18n-title="attr_close_d3d2e6" onclick="closeCropperModal()" title="Close" type="button">
<i class="fa-solid fa-xmark"></i>
</button>
</div>
<div class="p-6 grid grid-cols-1 md:grid-cols-12 gap-6 flex-1 overflow-y-auto">
<div class="md:col-span-8">
<div class="bg-gray-50 border border-gray-200 rounded-2xl overflow-hidden h-[72vh] md:h-[76vh] flex items-center justify-center">
<img alt="Crop" class="max-w-full max-h-full block" id="cropper-image"/>
</div>
</div>
<div class="md:col-span-4 space-y-4">
<div class="bg-white border border-gray-200 rounded-2xl p-4">
<div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2" data-i18n="cropper_cancel">Preview</div>
<div class="cropper-preview w-36 h-36 rounded-2xl border border-gray-200 bg-gray-50 overflow-hidden" id="cropper-preview-square"></div>
<div class="cropper-preview w-full rounded-2xl border border-gray-200 bg-gray-50 overflow-hidden hidden" id="cropper-preview-rect" style="aspect-ratio: 16 / 9;"></div>
<div class="cropper-preview w-36 h-36 rounded-full border border-gray-200 bg-gray-50 overflow-hidden hidden" id="cropper-preview-circle"></div>
<div class="mt-4">
<label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider" data-i18n="cropper_save">Zoom</label>
<input class="w-full mt-2" id="cropper-zoom" max="100" min="0" oninput="onCropperZoom(this.value)" type="range" value="0"/>
</div>
<div class="mt-4 flex items-center gap-2">
<button class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-xs font-bold text-gray-600 hover:bg-gray-50 transition" onclick="cropperRotate(-90)" type="button">
<i class="fa-solid fa-rotate-left mr-1"></i><span data-i18n="ui_rotate_8d2de5">Rotate</span></button>
<button class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-xs font-bold text-gray-600 hover:bg-gray-50 transition" onclick="cropperReset()" type="button">
<i class="fa-solid fa-arrow-rotate-left mr-1"></i><span data-i18n="ui_reset_526d68">Reset</span></button>
</div>
<p class="mt-4 text-[10px] text-gray-500 leading-relaxed" data-i18n="ui_tip_choose_a_clear_image_we_ll_c_d09c5d" id="cropper-tip">Tip: Choose a clear image. We'll crop it to fit.</p>
</div>
</div>
</div>
<div class="px-6 py-4 border-t border-gray-100 bg-white flex items-center justify-end gap-3">
<button class="px-5 py-2.5 rounded-xl border border-gray-200 text-xs font-bold text-gray-600 hover:bg-gray-50 transition" data-i18n="btn_cancel" onclick="closeCropperModal()" type="button">
          Cancel
        </button>
<button class="px-6 py-2.5 rounded-xl bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white text-xs font-bold shadow-lg shadow-cyan-500/25 transition" data-i18n="ui_crop_save_eee98f" onclick="confirmCropper()" type="button">
          Crop &amp; Save
        </button>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50" id="modal-join">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm"></div>
<div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in">
<div class="py-8 px-8">
<div class="flex justify-between items-start pb-4 border-b border-gray-100 mb-6">
<div class="flex items-start gap-3">
<div class="w-11 h-11 rounded-2xl bg-cyan-50/80 border border-cyan-100 grid place-items-center shadow-sm">
<i class="fa-solid fa-paper-plane text-cyan-700"></i>
</div>
<div>
<p class="text-2xl font-header font-bold text-BTrustOn-primary" data-i18n="join_title">
        Join the Network
      </p>
<p class="text-[11px] text-gray-500 mt-1" data-i18n="join_desc">
        Create your company profile.
      </p>
</div>
</div>
<button aria-label="Close" class="w-10 h-10 rounded-xl bg-white/80 border border-gray-200 hover:bg-gray-50 text-gray-400 hover:text-red-500 grid place-items-center transition" data-i18n-aria="attr_close_d3d2e6" onclick="toggleModal('modal-join')" type="button">
<i class="fa-solid fa-xmark text-lg"></i>
</button>
</div>
<form class="space-y-5" id="join-form" onsubmit="event.preventDefault(); handleJoin();">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_company">Company Name</label>
<input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" id="join-companyName" required="" type="text">
</input></div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_email">Email</label><input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" id="join-email" required="" type="email">
</input></div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_password">Password</label>
<input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" data-i18n-placeholder="ph_join_password" id="join-password" placeholder="******" required="" type="password">
</input></div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_primary_sector">Primary Sector</label>
<select class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700" id="join-sector">
<option data-i18n="join_sector_construction" value="construction">Construction &amp; Infrastructure</option>
<option data-i18n="join_sector_energy" value="energy">Energy &amp; Oil/Gas</option>
<option data-i18n="join_sector_mining" value="mining">Mining &amp; Metals</option>
<option data-i18n="join_sector_manufacturing" value="manufacturing">Manufacturing &amp; Machinery</option>
<option data-i18n="join_sector_technology" value="technology">Technology &amp; Automation</option>
<option data-i18n="join_sector_logistics" value="logistics">Logistics &amp; Trade</option>
<option data-i18n="join_sector_engineering" value="engineering">Engineering &amp; Services</option>
</select>
<p class="text-[10px] text-gray-400 mt-1 leading-tight" data-i18n="join_sector_hint">Select your main field of activity.</p>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="join_field_business_type">Business Type</label>
<select class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700" id="join-type">
<option data-i18n="join_type_operator" value="Operator">Operator / Asset Owner</option>
<option data-i18n="join_type_contractor" value="EPC Contractor">EPC / General Contractor</option>
<option data-i18n="join_type_subcontractor" value="Subcontractor">Subcontractor / Specialist</option>
<option data-i18n="join_type_manufacturer" value="Manufacturer">Manufacturer / OEM</option>
<option data-i18n="join_type_distributor" value="Distributor">Distributor / Supplier</option>
<option data-i18n="join_type_engineering_consultancy" value="Engineering">Engineering &amp; Consultancy</option>
<option data-i18n="join_type_technology_software" value="Technology">Technology &amp; Software</option>
</select>
<p class="text-[10px] text-gray-400 mt-1 leading-tight" data-i18n="join_type_hint">Select your role in the supply chain.</p>
</div>
</div>
<div class="grid grid-cols-2 gap-4 mt-4">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="join_field_country">Country</label>
<select class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700" id="join-country" required="">
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_state_city">State/Province &amp; City</label>
<input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" data-i18n-placeholder="ph_join_state_city" id="join-city" placeholder="e.g., San Francisco, CA" required="" type="text">
</input>
<p class="text-[10px] text-gray-400 mt-1 leading-tight" data-i18n="help_state_city_join">Use city + state/province abbreviation when available.</p></div>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_services">Core Services</label>
<textarea class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" id="join-services" placeholder="EPC, Excavation..." rows="2"></textarea>
</div>
<div class="flex items-start gap-3 mt-4 mb-2">
<div class="flex items-center h-5">
<input class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-blue-300 focus:ring-opacity-50 transition cursor-pointer" id="join-terms" required="" type="checkbox"/>
</div>
<label class="text-xs text-gray-500 leading-snug" for="join-terms"><span data-i18n="join_terms_prefix">I agree to the</span><a class="text-BTrustOn-accent font-bold hover:underline" data-i18n="join_terms_terms" href="javascript:void(0)" onclick="toggleModal('modal-terms')">Terms of Service</a><span data-i18n="join_terms_and">and</span><a class="text-BTrustOn-accent font-bold hover:underline" data-i18n="join_terms_privacy" href="javascript:void(0)" onclick="toggleModal('modal-privacy')">Privacy Policy</a><span data-i18n="join_acknowledge">. I acknowledge that BTrustOn is a verification platform and does not guarantee the performance of any listed company.</span></label>
</div>
<div class="pt-2">
<button class="w-full bg-BTrustOn-primary text-white font-bold py-4 rounded-xl hover:bg-BTrustOn-accent transition" data-i18n="join_cta_create" type="submit">
      CREATE ACCOUNT &amp; PROFILE
    </button>
</div>
<p class="text-xs text-red-500 text-center hidden" id="join-error"></p>
</form>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50" id="modal-quote">
<div class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm"></div>
<div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in">
<div class="py-8 px-8">
<div class="flex justify-between items-center pb-4 border-b border-gray-100 mb-6">
<div class="flex flex-col">
<p class="text-2xl font-header font-bold text-BTrustOn-primary" data-i18n="quote_title">
              Request Quote
            </p>
<p class="text-xs text-BTrustOn-accent font-bold mt-1" data-i18n="quote_field_target_company" id="quote-target-company">
              Target Company
            </p>
</div>
<div class="cursor-pointer z-50" onclick="toggleModal('modal-quote')">
<i class="fa-solid fa-xmark text-gray-400 hover:text-red-500 text-xl"></i>
</div>
</div>
<form class="space-y-5" onsubmit="event.preventDefault(); handleQuoteSubmit();">
<input id="input-target-id" type="hidden">
<input name="form_type" type="hidden" value="Quote_Request">
<input id="input-target-company" name="target_company" type="hidden">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_your_name">Your Name</label>
<input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" name="name" required="" type="text">
</input></div>
<div id="quote-email-row">
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="join_field_email">Email</label>
<input id="quote-email-input" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" name="email" required="" type="email">
</input></div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="lbl_quote_subject">Subject</label>
<input class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none font-bold text-gray-700" data-i18n-placeholder="ph_quote_subject" id="quote-subject" name="subject" placeholder="e.g. Excavator Rental Request" required="" type="text">
</input></div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="ui_details_3ec365">Details</label>
<textarea class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" name="message" required="" rows="4"></textarea>
</div>
<div class="mt-3">
<label class="block text-xs font-bold text-gray-600 mb-1.5">
<i class="fa-solid fa-paperclip mr-1 text-gray-400"></i><span data-i18n="lbl_quote_file">Attach Document (Optional)</span></label>
<div class="flex items-center gap-3">
<label class="cursor-pointer bg-white border border-gray-200 rounded-lg px-4 py-2 text-xs font-bold text-gray-500 hover:bg-gray-50 hover:border-BTrustOn-accent transition flex items-center gap-2">
<span data-i18n="quote_select_file">Select File</span>
<input class="hidden" id="quote-file" onchange="document.getElementById('quote-file-name').textContent = this.files[0]?.name || ''" type="file"/>
</label>
<span class="text-[10px] text-gray-400 italic truncate max-w-[150px]" id="quote-file-name"></span>
</div>
</div>
<div class="pt-2">
<button class="w-full bg-BTrustOn-accent text-white font-bold py-4 rounded-xl hover:bg-blue-600 transition" data-i18n="btn_send_quote" type="submit">
              SEND REQUEST
            </button>
</div>
</input></input></input></form>
</div>
</div>
</div>
<footer class="border-t border-gray-200 bg-white/80 mt-4">
<div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-gray-500">
<div class="flex items-center gap-2 shrink-0">
<span class="font-header font-bold text-BTrustOn-primary text-sm">BTrustOn</span>
<span class="text-gray-300" data-i18n="ui_b99834">|</span>
<span><span data-i18n="ui_a541ec">Â©</span><span id="year-span"></span><span data-i18n="ui_176848">Â·</span><span data-i18n="footer_rights">All rights reserved.</span></span>
</div>
<div class="flex items-center gap-6 md:gap-8">
<a class="hover:text-BTrustOn-primary transition" data-i18n="footer_about" href="javascript:void(0)" onclick="toggleModal('modal-about')">About</a>
<a class="hover:text-BTrustOn-primary transition" data-i18n="footer_pricing" href="javascript:void(0)" onclick="toggleModal('modal-pricing')">Pricing</a>
<a class="hover:text-BTrustOn-primary transition" data-i18n="footer_privacy" href="javascript:void(0)" onclick="toggleModal('modal-privacy')">Privacy</a>
<a class="hover:text-BTrustOn-primary transition" data-i18n="footer_terms" href="javascript:void(0)" onclick="toggleModal('modal-terms')">Terms</a>
</div>
</div>
</footer>
<!-- Partner Login Modal -->
<div class="fixed inset-0 hidden items-center justify-center z-50" id="login-modal">
<div class="absolute inset-0 bg-slate-900/55 backdrop-blur-sm" onclick="closeLoginModal()"></div>
<div class="relative bg-white/90 backdrop-blur-xl w-11/12 max-w-sm mx-auto rounded-2xl shadow-2xl border border-white/70 overflow-hidden animate-fade-in">
<div class="px-6 py-5 border-b border-gray-100 flex items-start justify-between">
<div class="flex items-start gap-3">
<div class="w-11 h-11 rounded-2xl bg-white/80 border border-gray-200 grid place-items-center shadow-sm">
<i class="fa-solid fa-key text-cyan-700"></i>
</div>
<div>
<h2 class="text-base font-extrabold text-slate-900 leading-tight" data-i18n="login_title">Login</h2>
<p class="text-[11px] text-gray-500 mt-0.5" data-i18n="login_desc">Access your company dashboard.</p>
</div>
</div>
<button aria-label="Close" class="w-10 h-10 rounded-xl bg-white/80 border border-gray-200 hover:bg-gray-50 text-gray-400 hover:text-red-500 grid place-items-center transition" data-i18n-aria="attr_close_d3d2e6" onclick="closeLoginModal()" type="button">
<i class="fa-solid fa-xmark text-lg"></i>
</button>
</div>
<div class="p-6">
<form class="space-y-4" id="login-form">
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_email">Email</label>
<input autocomplete="email" class="bton-login-input" data-i18n-placeholder="attr_name_company_com_8c0cb4" name="email" placeholder="name@company.com" required="" type="email">
</input></div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_password">Password</label>
<input autocomplete="current-password" class="bton-login-input" data-i18n-placeholder="attr_ca4d66" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required="" type="password">
</input></div>
<p class="text-xs text-red-500 hidden" id="login-error"></p>
<div class="flex justify-end gap-2 pt-2">
<button class="px-4 py-2.5 rounded-xl border border-gray-200 text-xs font-extrabold text-gray-600 hover:bg-gray-50 transition" onclick="closeLoginModal()" type="button"><span data-i18n="btn_cancel">Cancel</span></button>
<button class="px-4 py-2.5 rounded-xl bg-BTrustOn-primary hover:bg-BTrustOn-accent text-white text-xs font-extrabold shadow-lg shadow-slate-900/15 hover:shadow-cyan-500/20 transition" type="submit"><span data-i18n="btn_login">Login</span></button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" id="asset-modal">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAssetModal()"></div>
<div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
<div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
<h3 class="font-bold font-header tracking-wide" data-i18n="ui_add_new_asset_3632ed" id="asset-modal-title">Add New Asset</h3>
<button class="text-white/70 hover:text-white transition" onclick="closeAssetModal()">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
</div>
<div class="p-6">
<form class="space-y-4" id="asset-form" onsubmit="event.preventDefault(); saveAsset();">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_item">Item Name</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" data-i18n-placeholder="ph_asset_item" id="asset-item" placeholder="e.g. Liebherr LR 11000 Crawler Crane" required="" type="text"/>
</div>
<div class="grid grid-cols-3 gap-4">
<div class="col-span-2">
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_specs">Specs</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" data-i18n-placeholder="ph_asset_specs" id="asset-specs" placeholder="e.g. 1000 Ton Capacity, 2023 Model" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_qty">Qty</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" id="asset-qty" type="number" value="1"/>
</div>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_location">Location</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" data-i18n-placeholder="ph_asset_location" id="asset-location" placeholder="e.g. Rotterdam Logistics Hub, NL" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_status">Status</label>
<select class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm bg-white outline-none transition" id="asset-status">
<option data-i18n="asset_status_available" value="Available">Available</option>
<option data-i18n="asset_status_maintenance" value="Under Maintenance">Under Maintenance</option>
<option data-i18n="asset_status_out" value="Out of Service">Out of Service</option>
</select>
</div>
<div class="pt-2">
<div class="flex justify-between items-center mb-1">
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider"><span data-i18n="ui_technical_document_26b178">Technical Document</span><span class="text-gray-300 font-normal lowercase" data-i18n="ui_pdf_img_62ae83">(pdf, img)</span>
</label>
<span class="hidden bton-pro-pill bton-pro-pill--mini" id="asset-file-pro-badge">
<span class="bton-pro-pill__ico"><i class="fa-solid fa-gem"></i></span>
<span data-i18n="ui_pro_feature_63d8b6">PRO FEATURE</span>
</span>
</div>
<div class="flex items-center gap-3">
<label class="flex-1 cursor-pointer bg-gray-50 border border-dashed border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-2 hover:bg-gray-100 hover:border-BTrustOn-accent transition group relative overflow-hidden" id="asset-file-label">
<input accept=".pdf,.jpg,.jpeg,.png,.webp" multiple class="hidden" id="asset-file-input" onchange="handleAssetFileSelect(this)" type="file"/>
<i class="fa-solid fa-cloud-arrow-up text-gray-400 group-hover:text-BTrustOn-accent"></i>
<span class="text-xs font-bold text-gray-500 group-hover:text-gray-700 truncate" data-i18n="lbl_asset_file_input" id="asset-file-text">Attach File (Max 5MB)</span>
<div class="hidden absolute inset-0 bg-gray-100/80 flex items-center justify-center cursor-not-allowed" id="asset-file-lock">
<i class="fa-solid fa-lock text-gray-400"></i>
</div>
</label>
<button class="hidden w-10 h-10 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 grid place-items-center transition" data-i18n-title="attr_remove_file_46330f" id="btn-remove-asset-file" onclick="removeAssetFile()" title="Remove File" type="button">
<i class="fa-solid fa-trash text-xs"></i>
</button>
</div>
<div id="asset-file-list" class="mt-2 space-y-2"></div>
</div>
<div class="pt-4 flex gap-3">
<button class="flex-1 px-4 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold text-xs hover:bg-gray-50 transition" data-i18n="post_cancel" onclick="closeAssetModal()" type="button">
        CANCEL
      </button>
<button class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20" data-i18n="ui_save_asset_25e345" type="submit">
        SAVE ASSET
      </button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" id="project-modal">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeProjectModal()"></div>
<div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
<div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
<h3 class="font-bold font-header tracking-wide" data-i18n="ui_add_new_project_17bde1" id="project-modal-title">Add New Project</h3>
<button class="text-white/70 hover:text-white transition" onclick="closeProjectModal()">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
</div>
<div class="p-6">
<form class="space-y-4" id="project-form" onsubmit="event.preventDefault(); saveProject();">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_proj_title">Project Title</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" data-i18n-placeholder="ph_proj_title" id="proj-title" placeholder="e.g. Offshore Wind Farm Installation" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_asset_location">Location</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" data-i18n-placeholder="ph_proj_loc" id="proj-loc" placeholder="e.g. North Sea, Netherlands" required="" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="lbl_proj_date">Project Date</span><span class="text-red-500" data-i18n="ui_3389da">*</span></label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition text-gray-600" id="proj-date" required="" type="date"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_edit_desc">Description</label>
<textarea class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" id="proj-desc" data-i18n-placeholder="ph_proj_desc" placeholder="e.g. EPC delivery of 50 turbines (12MW) and subsea cabling works..." rows="3"></textarea>
</div>
<div class="space-y-3 pt-2">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_proj_cover_input">Cover Image</label>
<div class="flex items-center gap-3">
<div class="relative w-16 h-12 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden group" id="cover-preview">
<i class="fa-solid fa-image text-gray-400"></i>
<button class="hidden absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" data-i18n-title="attr_remove_cover_1bbd4b" onclick="removeProjectCover()" title="Remove Cover" type="button">
<i class="fa-solid fa-trash text-xs"></i>
</button>
</div>
<div class="flex flex-col gap-1">
<label class="cursor-pointer bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-50 transition inline-flex items-center">
<i class="fa-solid fa-upload mr-1"></i><span data-i18n="ui_change_cover_57983b">Change Cover</span><input accept="image/*" class="hidden" id="proj-cover-input" onchange="handleProjectCover(this)" type="file"/>
</label>
</div>
</div>
</div>
<div class="p-3 bg-slate-50 border border-slate-200 rounded-xl relative overflow-hidden">
<div class="flex justify-between items-center mb-2">
<label class="text-xs font-bold text-gray-600 flex items-center gap-2">
<i class="fa-solid fa-images text-BTrustOn-accent"></i><span data-i18n="ui_project_gallery_88062e">Project Gallery</span></label>
<span class="bton-pro-pill bton-pro-pill--mini" id="proj-gallery-badge"><span class="bton-pro-pill__ico"><i class="fa-solid fa-gem"></i></span><span data-i18n="ui_pro_9e3360">PRO</span></span>
</div>
<div class="flex gap-2 mb-2 overflow-x-auto pb-1 custom-scrollbar min-h-[0px] transition-all" id="existing-gallery-preview">
</div>
<div class="flex items-center gap-2 shrink-0">
<label class="flex-1 cursor-pointer bg-white border border-dashed border-gray-300 rounded-lg px-3 py-2 text-center hover:border-BTrustOn-accent transition" id="proj-gallery-label">
<span class="text-[10px] text-gray-500 font-bold block" data-i18n="lbl_proj_gallery_input">+ Add More Photos</span>
<input accept="image/*" class="hidden" id="proj-gallery-input" multiple="" onchange="handleProjectGallery(this)" type="file"/>
</label>
<span class="text-[10px] text-gray-400 font-bold" id="gallery-count-text"></span>
</div>
<div class="absolute inset-0 bg-slate-100/60 backdrop-blur-[1px] flex flex-col items-center justify-center z-10 cursor-pointer hidden" id="proj-gallery-lock" onclick="toggleModal('modal-upgrade')">
<div class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center mb-1">
<i class="fa-solid fa-lock text-gray-400 text-xs"></i>
</div>
<span class="text-[9px] font-bold text-gray-500 bg-white px-2 py-0.5 rounded-full shadow-sm" data-i18n="updates_upgrade">Upgrade</span>
</div>
</div>
</div>
<div class="pt-4 flex gap-3">
<button class="flex-1 px-4 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold text-xs hover:bg-gray-50 transition" data-i18n="post_cancel" onclick="closeProjectModal()" type="button">
        CANCEL
      </button>
<button class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20" data-i18n="ui_save_project_65f672" type="submit">
        SAVE PROJECT
      </button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" id="cert-modal">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCertModal()"></div>
<div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
<div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
<h3 class="font-bold font-header tracking-wide" data-i18n="ui_add_certificate_7159a1" id="cert-modal-title">Add Certificate</h3>
<button class="text-white/70 hover:text-white transition" onclick="closeCertModal()">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
</div>
<div class="p-6">
<form class="space-y-4" id="cert-form" onsubmit="event.preventDefault(); saveCert();">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><span data-i18n="lbl_cert_name">Certificate Name</span><span class="text-red-500" data-i18n="ui_3389da">*</span></label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" data-i18n-placeholder="ph_cert_name" id="cert-name" placeholder="e.g. ISO 9001:2015" required="" type="text"/>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_cert_issuer">Issuer / Org.</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" data-i18n-placeholder="ph_cert_issuer" id="cert-issuer" placeholder="e.g. TUV NORD" type="text"/>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1" data-i18n="lbl_cert_date">Expiry Date</label>
<input class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition text-gray-600" id="cert-date" type="date"/>
</div>
</div>
<div class="pt-2">
<div class="flex justify-between items-center mb-1">
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wider"><span data-i18n="ui_proof_document_3dd27c">Proof Document</span><span class="text-gray-300 font-normal lowercase" data-i18n="ui_pdf_img_62ae83">(pdf, img)</span>
</label>
<span class="hidden bton-pro-pill bton-pro-pill--mini" id="cert-file-pro-badge">
<span class="bton-pro-pill__ico"><i class="fa-solid fa-gem"></i></span>
<span data-i18n="ui_pro_only_a688ca">PRO ONLY</span>
</span>
</div>
<div class="flex items-center gap-3">
<label class="flex-1 cursor-pointer bg-gray-50 border border-dashed border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-2 hover:bg-gray-100 hover:border-BTrustOn-accent transition group relative overflow-hidden" id="cert-file-label">
<input accept=".pdf, .jpg, .jpeg, .png" class="hidden" id="cert-file-input" onchange="handleCertFileSelect(this)" type="file"/>
<i class="fa-solid fa-cloud-arrow-up text-gray-400 group-hover:text-BTrustOn-accent"></i>
<span class="text-xs font-bold text-gray-500 group-hover:text-gray-700 truncate" data-i18n="ui_attach_proof_max_5mb_81863c" id="cert-file-text">Attach Proof (Max 5MB)</span>
<div class="hidden absolute inset-0 bg-gray-100/90 flex items-center justify-center cursor-not-allowed z-10" id="cert-file-lock">
<div class="flex items-center gap-1 text-gray-400 text-xs font-bold">
<i class="fa-solid fa-lock"></i> <span data-i18n="ui_upgrade_to_upload_76da8e">Upgrade to Upload</span>
</div>
</div>
</label>
<button class="hidden w-10 h-10 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 grid place-items-center transition" data-i18n-title="attr_remove_file_46330f" id="btn-remove-cert-file" onclick="removeCertFile()" title="Remove File" type="button">
<i class="fa-solid fa-trash text-xs"></i>
</button>
</div>
<a class="hidden text-[10px] text-BTrustOn-accent font-bold mt-1.5 hover:underline flex items-center gap-1 inline-block" href="#" id="current-cert-link" target="_blank">
<i class="fa-solid fa-paperclip"></i> <span data-i18n="ui_view_current_file_680038">View Current File</span>
</a>
</div>
<div class="pt-4 flex gap-3">
<button class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition" data-i18n="post_cancel" onclick="closeCertModal()" type="button">
            CANCEL
          </button>
<button class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20" data-i18n="ui_save_certificate_ab3f4d" type="submit">
            SAVE CERTIFICATE
          </button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 z-[110000] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" id="delete-modal">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
<div class="bg-white w-full max-w-sm mx-4 rounded-2xl shadow-2xl z-20 overflow-hidden transform transition-all scale-95" id="delete-modal-content">
<div class="p-6 text-center">
<div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i>
</div>
<h3 class="text-lg font-bold text-gray-800 mb-2" data-i18n="ui_confirm_70d9be">Confirm</h3>
<p class="text-sm text-gray-500 mb-6 leading-relaxed" data-i18n="ui_do_you_really_want_to_delete_thi_2fe62e" id="delete-modal-msg">
        Do you really want to delete this item? This process cannot be undone.
      </p>
<div class="flex gap-3">
<button class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition" data-i18n="post_cancel" onclick="closeDeleteModal()">
          CANCEL
        </button>
<button class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-bold text-xs hover:bg-red-600 transition shadow-lg shadow-red-500/30" data-i18n="ui_yes_delete_2aefa7" id="btn-confirm-delete">
          YES, DELETE
        </button>
</div>
</div>
</div>
</div>
<div class="fixed inset-0 bg-slate-900/20 backdrop-blur-[2px] z-[9990] hidden transition-opacity opacity-0" id="inbox-overlay" onclick="toggleInbox()"></div>
<div class="flex flex-col" id="inbox-panel">
<div class="bg-gradient-to-r from-BTrustOn-primary to-slate-800 flex flex-col pt-6 px-6 shadow-lg relative overflow-hidden shrink-0 z-20">
<div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
<div class="relative z-10 flex justify-between items-center mb-4">
<div>
<h2 class="text-white font-header text-xl tracking-wide flex items-center gap-2"><span data-i18n="ui_messages_b47a73">MESSAGES</span><span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-glow hidden" id="inbox-badge-count">0</span>
</h2>
</div>
<button class="text-white/60 hover:text-white hover:rotate-90 transition transform" onclick="toggleInbox()">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
</div>
<div class="flex items-center gap-6 relative z-10 text-xs font-bold text-white/50 bton-inbox-tabs-bar">
<button class="pb-3 border-b-2 border-BTrustOn-accent text-white transition-all flex items-center gap-2" id="btn-tab-inbox" onclick="switchInboxView('inbox')">
                <span data-i18n="ui_inbox_7e3342">INBOX</span><i class="fa-solid fa-inbox text-[10px] ml-1 bton-inbox-tab-icon"></i>
                <span class="ml-1 hidden min-w-[16px] h-4 px-1 rounded-full bg-rose-500 text-white text-[10px] font-extrabold flex items-center justify-center" id="inbox-tab-badge">0</span>
            </button>
<button class="pb-3 border-b-2 border-transparent hover:text-white transition-all flex items-center gap-2" id="btn-tab-sent" onclick="switchInboxView('sent')"><span data-i18n="ui_sent_145d63">SENT</span><i class="fa-solid fa-paper-plane text-[10px]"></i>
<span class="ml-1 hidden min-w-[16px] h-4 px-1 rounded-full bg-rose-500 text-white text-[10px] font-extrabold flex items-center justify-center" id="sent-tab-badge">0</span>
</button>
<button class="pb-3 border-b-2 border-transparent hover:text-white transition-all flex items-center gap-2" id="btn-tab-notif" onclick="switchInboxView('notifications')"><span data-i18n="ui_notifications_222037">NOTIFICATIONS</span><i class="fa-solid fa-bell text-[10px]"></i>
<span class="ml-1 hidden min-w-[16px] h-4 px-1 rounded-full bg-rose-500 text-white text-[10px] font-extrabold flex items-center justify-center" id="notif-tab-badge">0</span>
</button>
</div>
</div>
<div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2 bg-slate-50/50" id="inbox-content">
</div>
<div class="p-4 border-t border-gray-200 bg-white/90 backdrop-blur-sm grid grid-cols-2 gap-3 shrink-0">
<button class="py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-bold hover:bg-white hover:border-BTrustOn-accent hover:text-BTrustOn-accent transition flex items-center justify-center gap-2 group" onclick="markAllInboxRead()">
<i class="fa-solid fa-check-double text-gray-400 group-hover:text-BTrustOn-accent"></i><span data-i18n="ui_mark_read_00e098">MARK READ</span></button>
<button class="py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-bold hover:bg-red-50 hover:border-red-200 hover:text-red-500 transition flex items-center justify-center gap-2 group" onclick="deleteAllInbox()">
<i class="fa-solid fa-trash text-gray-400 group-hover:text-red-500"></i><span data-i18n="ui_delete_all_0761dd">DELETE ALL</span></button>
</div>
</div>
<div class="hidden-view fixed inset-0 z-[10000] bg-slate-50 flex flex-col h-[100dvh]" id="view-message">
<div class="shrink-0 bg-white border-b border-gray-200 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm z-20">
<div class="flex items-center gap-3 md:gap-4 overflow-hidden">
<button class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500 transition" onclick="closeMessageView()">
<i class="fa-solid fa-arrow-left"></i>
</button>
<div class="w-10 h-10 rounded-lg bg-cyan-50 border border-cyan-100 grid place-items-center text-lg font-bold text-BTrustOn-accent shrink-0" data-i18n="ui_a_7fc562" id="msg-logo">
                A
            </div>
<div class="min-w-0">
<h1 class="text-sm md:text-base font-bold text-gray-800 truncate" id="msg-subject">â€”</h1>
<div class="flex items-center gap-2 text-xs text-gray-500">
<span class="truncate font-medium" id="msg-company">â€”</span>
<span class="w-1 h-1 rounded-full bg-gray-300"></span>
<span class="font-semibold text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600" data-i18n="ui_message_90791e" id="msg-type-badge">MESSAGE</span>
</div>
</div>
</div>
<div class="flex gap-2 shrink-0">
<button class="w-9 h-9 rounded-full border border-gray-200 text-gray-400 hover:text-BTrustOn-accent hover:bg-cyan-50 hover:border-BTrustOn-accent transition flex items-center justify-center" data-i18n-title="attr_mark_unread_94324c" onclick="markAsUnreadCurrentMessage()" title="Mark Unread" data-i18n-title="inbox_mark_unread">
<i class="fa-solid fa-envelope-open text-sm"></i>
</button>
<button class="w-9 h-9 rounded-full border border-gray-200 text-gray-400 hover:text-red-500 hover:bg-red-50 hover:border-red-200 transition flex items-center justify-center" data-i18n-title="attr_delete_conversation_90dd01" onclick="deleteCurrentMessage()" title="Delete Conversation" data-i18n-title="inbox_delete_conversation">
<i class="fa-solid fa-trash-can text-sm"></i>
</button>
</div>
</div>
<div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-4 bg-[#e5ddd5]/10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]" id="message-thread-container">
<div class="flex justify-center mt-10">
<span class="bg-gray-200 text-gray-600 text-[10px] px-3 py-1 rounded-full uppercase tracking-wide font-bold" data-i18n="ui_loading_chat_2c1244">Loading Chat...</span>
</div>
</div>
<div class="shrink-0 bg-white border-t border-gray-200 p-3 md:p-4 z-20">
<div class="hidden mb-2 flex items-center justify-between bg-cyan-50 border border-cyan-100 rounded-lg p-2 mx-1" id="attachment-preview">
<div class="flex items-center gap-2 overflow-hidden">
<div class="w-8 h-8 rounded bg-white flex items-center justify-center text-BTrustOn-accent shadow-sm shrink-0">
<i class="fa-solid fa-file-lines"></i>
</div>
<div class="min-w-0">
<p class="text-xs font-bold text-gray-700 truncate" id="attachment-name">filename.pdf</p>
<p class="text-[9px] text-gray-400" data-i18n="ui_0_kb_ee19b1" id="attachment-size">0 KB</p>
</div>
</div>
<button class="w-6 h-6 rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500 flex items-center justify-center transition" onclick="removeAttachment()" type="button">
<i class="fa-solid fa-xmark text-xs"></i>
</button>
</div>
<div class="flex items-end gap-2 md:gap-3 max-w-5xl mx-auto">
<input id="reply-file-input" onchange="handleFileSelect(this)" style="display: none;" type="file">
<button class="h-10 w-10 md:w-12 rounded-xl bg-gray-50 text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition flex items-center justify-center border border-gray-200 shrink-0" onclick="document.getElementById('reply-file-input').click()" type="button">
<i class="fa-solid fa-paperclip text-lg"></i>
</button>
<textarea class="flex-1 bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl px-4 py-2.5 focus:outline-none focus:bg-white focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent transition resize-none max-h-32 min-h-[44px]" id="reply-input" data-i18n-placeholder="inbox_type_message" placeholder="" rows="1"></textarea>
<button class="h-10 px-4 md:px-6 bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white rounded-xl font-bold text-xs tracking-wide transition shadow-lg shadow-cyan-500/20 shrink-0 flex items-center gap-2" onclick="sendReply()">
<span data-i18n="ui_send_548e51">SEND</span>
<i class="fa-solid fa-paper-plane"></i>
</button>
</input></div>
</div>
</div>
 
<div class="hidden-view fade-in min-h-screen bg-slate-100 pb-20" id="view-admin">
<div class="bg-slate-900 text-white pt-24 pb-12 px-4 shadow-lg">
<div class="max-w-6xl mx-auto flex justify-between items-end">
<div>
<h1 class="text-3xl font-header font-bold flex items-center gap-3">
<i class="fa-solid fa-shield-cat text-emerald-400"></i><span data-i18n="ui_admin_dashboard_4b08d5">Admin Dashboard</span></h1>
<p class="text-slate-400 text-sm mt-2" data-i18n="ui_manage_verifications_and_subscri_980b56">Manage verifications and subscriptions.</p>
</div>
<div class="flex gap-4">
<div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
<span class="block text-[10px] text-slate-400 uppercase" data-i18n="ui_pending_requests_a8ed40">Pending Requests</span>
<span class="text-2xl font-bold text-white" id="admin-pending-count">0</span>
</div>
</div>
</div>
</div>
<div class="max-w-6xl mx-auto px-4 -mt-6">
<div class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
<div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
<h3 class="font-bold text-gray-700" data-i18n="ui_verification_requests_443d20">Verification Requests</h3>
<button class="text-xs text-BTrustOn-accent font-bold hover:underline" onclick="loadAdminData(); loadAdminClaims();">
<i class="fa-solid fa-rotate"></i><span data-i18n="refresh">Refresh</span></button>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm text-gray-600">
<thead class="bg-gray-50 text-xs uppercase font-bold text-gray-400 border-b border-gray-200">
<tr>
<th class="px-6 py-4" data-i18n="ui_company_1c76cb">Company</th>
<th class="px-6 py-4" data-i18n="ui_reg_no_info">Registration / Registry</th>
<th class="px-6 py-4" data-i18n="ui_submitted_at_626a47">Submitted At</th>
<th class="px-6 py-4" data-i18n="ui_document_094535">Document</th>
<th class="px-6 py-4 text-right" data-i18n="ui_actions_06df33">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-100" id="admin-request-list">
<tr><td class="px-6 py-8 text-center text-gray-400 italic" colspan="5" data-i18n="ui_loading_requests_810c03">Loading requests...</td></tr>
</tbody>

</table>
</div>
</div>

<!-- CLAIM REQUESTS (Ownership) -->
<div class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden mt-6">
  <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
    <h3 class="font-bold text-gray-700" data-i18n="ui_claim_requests_title">Claim Requests</h3>
    <div class="flex items-center gap-3">
      <div class="bg-slate-800/5 px-3 py-2 rounded-lg border border-slate-200">
        <span class="block text-[10px] text-slate-500 uppercase font-bold" data-i18n="ui_pending_claims">Pending Claims</span>
        <span class="text-xl font-black text-slate-900" id="admin-claim-pending-count">0</span>
      </div>
      <button class="text-xs text-BTrustOn-accent font-bold hover:underline" onclick="loadAdminClaims()">
        <i class="fa-solid fa-rotate"></i> <span data-i18n="refresh">Refresh</span>
      </button>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-left text-sm text-gray-600">
      <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-400 border-b border-gray-200">
        <tr>
          <th class="px-6 py-4" data-i18n="ui_company_1c76cb">Company</th>
          <th class="px-6 py-4" data-i18n="ui_claim_requester">Requester</th>
          <th class="px-6 py-4" data-i18n="ui_claim_note">Note</th>
          <th class="px-6 py-4" data-i18n="ui_submitted_at_626a47">Submitted At</th>
          <th class="px-6 py-4 text-right" data-i18n="ui_actions_06df33">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100" id="admin-claim-list">
        <tr>
          <td class="px-6 py-8 text-center text-gray-400 italic" colspan="5" data-i18n="ui_loading_requests_810c03">Loading requests...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>
</div>

<!-- CLAIM MODAL -->
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[120]" id="modal-claim-company">
  <div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="toggleModal('modal-claim-company')"></div>
  <div class="modal-container relative z-10 bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl border border-slate-200 overflow-hidden max-h-[90vh] animate-fade-in flex flex-col">
    <div class="px-6 py-5 border-b border-gray-100 bg-gray-50/60">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-BTrustOn-accent/10 text-BTrustOn-accent flex items-center justify-center">
          <i class="fa-solid fa-handshake-angle"></i>
        </div>
        <div class="flex-1">
          <h3 class="font-extrabold text-slate-900" data-i18n="ui_claim_modal_title">Claim this company</h3>
          <p class="text-xs text-slate-500 mt-1" data-i18n="ui_claim_modal_sub">If you're a company representative, request ownership.</p>
        </div>
      </div>
    </div>
    <div class="p-6 overflow-y-auto">
      <p class="text-xs text-slate-600 mb-4" data-i18n="ui_claim_modal_hint">Use a corporate email if possible. The admin will review and approve.</p>

      <input type="hidden" id="claim-company-id" value="">
      <div class="mb-3">
        <label class="block text-[11px] font-extrabold text-slate-700 mb-2" data-i18n="ui_claim_note_label">Note (optional)</label>
        <textarea id="claim-note" rows="3"
          class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-BTrustOn-accent/30"
          data-i18n-placeholder="ui_claim_note_ph" placeholder=""></textarea>
      </div>

      <div class="flex justify-end gap-2 mt-5">
        <button class="h-10 px-4 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50 font-extrabold text-[11px] uppercase tracking-wider"
                onclick="toggleModal('modal-claim-company')">
          <span data-i18n="btn_cancel">Cancel</span>
        </button>
        <button class="h-10 px-4 rounded-xl bg-BTrustOn-accent hover:bg-BTrustOn-accent/90 text-white font-extrabold text-[11px] uppercase tracking-wider"
                onclick="submitCompanyClaim()">
          <span data-i18n="ui_submit_claim">Submit</span>
        </button>
      </div>
    </div>
  </div>
</div>


<!-- CLAIM WELCOME (ONE-TIME) MODAL -->
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[130]" id="modal-claim-welcome">
  <div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="closeClaimWelcomeModal()"></div>
  <div class="modal-container relative z-10 bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl border border-slate-200 overflow-hidden max-h-[90vh] animate-fade-in flex flex-col">
    <div class="px-6 py-5 border-b border-gray-100 bg-gray-50/60">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-emerald-500/10 text-emerald-600 flex items-center justify-center">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div class="flex-1">
          <h3 class="font-extrabold text-slate-900" data-i18n="ui_claim_welcome_title">Welcome â€” claim approved</h3>
          <p class="text-xs text-slate-500 mt-1" data-i18n="ui_claim_welcome_sub">You can now manage this company profile.</p>
        </div>
      </div>
    </div>
    <div class="p-6 overflow-y-auto">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-[11px] font-extrabold text-slate-500 uppercase tracking-wider mb-1" data-i18n="ui_company_1c76cb">Company</div>
        <div class="text-lg font-black text-slate-900" id="claim-welcome-company-name">â€”</div>
      </div>

      <p class="text-sm text-slate-700 mt-4 leading-relaxed" id="claim-welcome-body">
        Congrats! You can now edit this company profile (General info, Projects, Certificates and Assets).
      </p>

      <div class="flex justify-end gap-2 mt-6">
        <button class="h-10 px-4 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50 font-extrabold text-[11px] uppercase tracking-wider"
                onclick="closeClaimWelcomeModal()">
          <span data-i18n="ui_got_it">Got it</span>
        </button>
        <button class="h-10 px-4 rounded-xl bg-BTrustOn-accent hover:bg-BTrustOn-accent/90 text-white font-extrabold text-[11px] uppercase tracking-wider"
                onclick="goEditClaimedCompanyFromWelcome()">
          <span data-i18n="ui_edit_company_profile">Edit company profile</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[110]" id="modal-post-update">
<div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="openPostUpdateModal()"></div>
<div class="modal-container bg-white w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col">
<div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
<div>
<h2 class="text-xl font-header font-bold text-BTrustOn-primary" data-i18n="post_modal_title">Post an Update</h2>
<p class="text-[11px] text-gray-400 mt-0.5" data-i18n="post_last7">Visible on homepage for 7 days</p>
</div>
<button class="text-gray-400 hover:text-red-500 transition" onclick="openPostUpdateModal()">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
</div>
<div class="p-6 space-y-5">
<!-- Area -->
<div>
<div class="text-[10px] font-extrabold text-gray-500 uppercase tracking-wider mb-2" data-i18n="post_choose_area">Select area</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2">
<button class="upd-area-btn px-3 py-2 rounded-xl border border-gray-200 bg-white hover:border-BTrustOn-accent text-xs font-bold text-gray-700 transition flex items-center justify-center gap-2" data-area="general" type="button">
<i class="fa-solid fa-bullhorn text-slate-500"></i>
<span data-i18n="post_area_general">General</span>
</button>
<button class="upd-area-btn px-3 py-2 rounded-xl border border-gray-200 bg-white hover:border-BTrustOn-accent text-xs font-bold text-gray-700 transition flex items-center justify-center gap-2" data-area="projects" type="button">
<i class="fa-solid fa-diagram-project text-cyan-500"></i>
<span data-i18n="post_area_projects">Projects</span>
</button>
<button class="upd-area-btn px-3 py-2 rounded-xl border border-gray-200 bg-white hover:border-BTrustOn-accent text-xs font-bold text-gray-700 transition flex items-center justify-center gap-2" data-area="certificates" type="button">
<i class="fa-solid fa-certificate text-amber-500"></i>
<span data-i18n="post_area_certs">Certificates</span>
</button>
<button class="upd-area-btn px-3 py-2 rounded-xl border border-gray-200 bg-white hover:border-BTrustOn-accent text-xs font-bold text-gray-700 transition flex items-center justify-center gap-2" data-area="assets" type="button">
<i class="fa-solid fa-boxes-stacked text-emerald-500"></i>
<span data-i18n="post_area_assets">Assets</span>
</button>
</div>
</div>
<!-- Entity select -->
<div id="upd-entity-wrap">
<div class="text-[10px] font-extrabold text-gray-500 uppercase tracking-wider mb-2" data-i18n="post_select_item">Select item</div>
<div class="relative">
<select class="w-full appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-3 pl-3 pr-10 rounded-xl shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition" id="upd-entity">
<option data-i18n="ui_26aeab" disabled="" selected="" value="">â€”</option>
</select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
</div>
</div>
<div class="hidden mt-2 text-[11px] text-gray-400 italic" id="upd-entity-empty"></div>
</div>
<!-- Update type -->
<div>
<div class="text-[10px] font-extrabold text-gray-500 uppercase tracking-wider mb-2" data-i18n="post_select_update">Update type</div>
<div class="relative">
<select class="w-full appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-3 pl-3 pr-10 rounded-xl shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition" id="upd-signal">
<option data-i18n="ui_26aeab" disabled="" selected="" value="">â€”</option>
</select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
</div>
</div>
</div>
<!-- Note -->
<div>
<div class="flex items-center justify-between mb-2">
<div class="text-[10px] font-extrabold text-gray-500 uppercase tracking-wider" data-i18n="field_note">Additional Notes</div>
<div class="text-[10px] text-gray-400"><span id="upd-note-count">0</span>/160</div>
</div>
<textarea class="w-full border border-gray-200 rounded-xl p-3 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent resize-none" id="upd-note" maxlength="160" placeholder="" rows="3"></textarea>
<div class="mt-1 text-[10px] text-gray-400" data-i18n="post_note_hint">Max 160 characters</div>
</div>
<!-- My recent updates (manage) -->
<div class="mt-4 pt-4 border-t border-gray-100">
<div class="flex items-center justify-between">
<div class="text-[12px] font-semibold text-gray-700" data-i18n="post_my_recent">Your recent updates</div>
<button class="text-[11px] px-2.5 py-1 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition" onclick="loadMyRecentUpdates()" type="button">
<i class="fa-solid fa-rotate-right mr-1"></i><span data-i18n="refresh">Refresh</span>
</button>
</div>
<div class="mt-3 space-y-2" id="my-recent-updates-list"></div>
<div class="mt-2 text-[10px] text-gray-400" data-i18n="post_my_recent_hint">Tip: You can delete your own updates here.</div>
</div>
<!-- Actions -->
<div class="flex items-center justify-end gap-2 pt-2">
<button class="px-4 py-2 rounded-xl border border-gray-200 hover:bg-gray-50 text-xs font-extrabold text-gray-600 transition" data-i18n="post_cancel" onclick="openPostUpdateModal()">CANCEL</button>
<button class="px-4 py-2 rounded-xl bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white text-xs font-extrabold transition shadow-lg shadow-cyan-500/20" data-i18n="post_publish" id="btn-publish-update" onclick="submitCompanyUpdate()">PUBLISH</button>
</div>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]" id="modal-about">
<div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="toggleModal('modal-about')"></div>
<div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col border border-white/60">
<div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
<div>
<h2 class="text-2xl font-header font-extrabold text-BTrustOn-primary" data-i18n="about_modal_title">About BTrustOn</h2>
<p class="text-xs text-gray-400 mt-1" data-i18n="about_modal_tagline">A trust layer for industrial sourcingâ€”built on proof, not posts.</p>
</div>
<button aria-label="Close" class="text-gray-400 hover:text-red-500 transition" data-i18n-aria="attr_close_d3d2e6" onclick="toggleModal('modal-about')">
<i class="fa-solid fa-xmark text-2xl"></i>
</button>
</div>
<div class="p-8 space-y-8 text-sm text-gray-600 leading-relaxed">
<!-- Hero -->
<div class="relative overflow-hidden rounded-3xl border border-gray-100 bg-gradient-to-br from-slate-950 via-BTrustOn-primary to-slate-800 text-white p-7">
<div class="absolute -top-24 -right-24 w-64 h-64 rounded-full bg-white/10 blur-3xl"></div>
<div class="absolute -bottom-28 -left-28 w-72 h-72 rounded-full bg-cyan-400/10 blur-3xl"></div>
<div class="relative">
<div class="text-[10px] font-extrabold tracking-widest text-white/70 uppercase" data-i18n="about_modal_pills">Verified partners Â· References Â· Industrial assets</div>
<div class="mt-2 text-xl md:text-2xl font-header font-extrabold leading-snug" data-i18n="about_modal_sub">
            Discover the right supplier fasterâ€”with clear, verifiable signals.
          </div>
<p class="mt-3 text-[12px] md:text-sm text-white/80 max-w-2xl" data-i18n="about_modal_desc">
            BTrustOn helps buyers and contractors reduce sourcing risk by surfacing what matters: verification status, project references, certificates, and assetsâ€”on one screen.
          </p>
</div>
</div>
<!-- Pillars -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
<div class="h-1 w-10 rounded-full bg-BTrustOn-accent/70 mb-4"></div>
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="about_pillar_verified_title">Verified Partners</div>
<div class="mt-2 text-[12px] text-gray-600" data-i18n="about_pillar_verified_desc">
            A visible trust signal that indicates a company has passed an admin review process. Verification is shown to everyone.
          </div>
</div>
<div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
<div class="h-1 w-10 rounded-full bg-BTrustOn-accent/70 mb-4"></div>
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="about_pillar_refs_title">Project References</div>
<div class="mt-2 text-[12px] text-gray-600" data-i18n="about_pillar_refs_desc">
            Structured references that let buyers understand where a supplier has deliveredâ€”without long pitches or marketing PDFs.
          </div>
</div>
<div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
<div class="h-1 w-10 rounded-full bg-BTrustOn-accent/70 mb-4"></div>
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="about_pillar_assets_title">Industrial Assets</div>
<div class="mt-2 text-[12px] text-gray-600" data-i18n="about_pillar_assets_desc">
            Clear inventories and capabilities (equipment, facilities, systems) so sourcing decisions are based on operational reality.
          </div>
</div>
</div>
<!-- How it works -->
<div class="rounded-3xl border border-gray-100 bg-gray-50 p-6">
<div class="flex items-end justify-between gap-3">
<div>
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="about_how_title">How BTrustOn works</div>
<div class="mt-1 text-[12px] text-gray-500" data-i18n="about_how_sub">A simple workflow designed for procurement speed and credibility.</div>
</div>
<div class="hidden md:block text-[10px] font-extrabold px-2.5 py-1 rounded-full bg-white/70 border border-gray-200 text-gray-600" data-i18n="about_how_tagline">
            Minimal. Structured. B2B.
          </div>
</div>
<div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="rounded-2xl bg-white border border-gray-100 p-4">
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="about_step1_title">1) Create a company profile</div>
<div class="text-[11px] text-gray-500 mt-1" data-i18n="about_step1_desc">Add core services and the essentials buyers need to qualify you.</div>
</div>
<div class="rounded-2xl bg-white border border-gray-100 p-4">
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="about_step2_title">2) Upload proof</div>
<div class="text-[11px] text-gray-500 mt-1" data-i18n="about_step2_desc">Projects, certificates, and assets become your trust stack.</div>
</div>
<div class="rounded-2xl bg-white border border-gray-100 p-4">
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="about_step3_title">3) Request verification</div>
<div class="text-[11px] text-gray-500 mt-1" data-i18n="about_step3_desc">Submit your Company ID (e.g., VKN) for admin review.</div>
</div>
<div class="rounded-2xl bg-white border border-gray-100 p-4">
<div class="text-[11px] font-extrabold text-slate-900" data-i18n="about_step4_title">4) Connect &amp; do business</div>
<div class="text-[11px] text-gray-500 mt-1" data-i18n="about_step4_desc">Send quote requests and find qualified partners faster.</div>
</div>
</div>
</div>
<!-- What we are not -->
<div class="rounded-2xl border border-gray-100 bg-white p-5">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="about_not_title">What BTrustOn is not</div>
<ul class="mt-3 space-y-2 text-[12px] text-gray-600">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="about_not_1">Not a social feed. Updates are structured signals that deep-link to the underlying proof.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="about_not_2">Not a guarantee. Buyers should always perform their own due diligence.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="about_not_3">Not spam-friendly. The platform is designed to stay premium and procurement-focused.</span></li>
</ul>
</div>
<div class="flex flex-col sm:flex-row gap-3 justify-end">
<button class="px-5 py-2.5 rounded-xl border border-gray-200 hover:bg-gray-50 text-xs font-extrabold text-gray-700 transition" data-i18n="about_cta_free" onclick="toggleModal('modal-about'); openJoinModal('free');">
          Start Free
        </button>
<button class="px-5 py-2.5 rounded-xl bg-BTrustOn-primary hover:bg-BTrustOn-accent text-white text-xs font-extrabold transition shadow-lg shadow-cyan-500/15" data-i18n="about_cta_pro" onclick="toggleModal('modal-about'); openJoinModal('pro');">
          Go Pro
        </button>
</div>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]" id="modal-pricing">
<div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="toggleModal('modal-pricing')"></div>
<div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col border border-white/60">
<div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
<div>
<h2 class="text-2xl font-header font-extrabold text-BTrustOn-primary" data-i18n="footer_pricing">Pricing</h2>
<p class="text-xs text-gray-400 mt-1" data-i18n="pricing_modal_sub">Simple plans designed for businessâ€”no noise.</p>
</div>
<button aria-label="Close" class="text-gray-400 hover:text-red-500 transition" data-i18n-aria="attr_close_d3d2e6" onclick="toggleModal('modal-pricing')">
<i class="fa-solid fa-xmark text-2xl"></i>
</button>
</div>
<div class="p-8 space-y-6 text-sm text-gray-600">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Free -->
<div class="rounded-3xl border border-gray-100 bg-white p-6 shadow-sm relative overflow-hidden">
<div class="absolute -top-16 -right-16 w-40 h-40 rounded-full bg-slate-100 blur-2xl"></div>
<div class="relative">
<div class="flex items-start justify-between gap-3">
<div>
<div class="text-[10px] font-extrabold tracking-widest uppercase text-gray-500" data-i18n="pricing_plan_starter">Starter</div>
<div class="mt-1 text-xl font-header font-extrabold text-slate-900" data-i18n="pricing_plan_free">Free</div>
<div class="mt-1 inline-flex items-center gap-2 text-[11px] font-extrabold px-2.5 py-1 rounded-full bg-gray-50 border border-gray-200 text-gray-600">
<i class="fa-solid fa-circle-check text-[11px] text-gray-500"></i><span data-i18n="pricing_no_payment">No payment</span></div>
</div>
<div class="w-12 h-12 rounded-2xl bg-gray-50 border border-gray-200 grid place-items-center">
<i class="fa-solid fa-leaf text-gray-600 text-[14px]"></i>
</div>
</div>
<ul class="mt-5 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_free_b1">Create a company profile and get discovered.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_free_b2">Browse verified partners and view public proof.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_free_b3">Receive quote requests and connect with buyers.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_free_b4">Limited uploads &amp; features compared to Pro.</span></li>
</ul>
<div class="mt-6 flex justify-end">
<button class="px-5 py-2.5 rounded-xl border border-gray-200 hover:bg-gray-50 text-xs font-extrabold text-gray-700 transition" data-i18n="about_cta_free" onclick="toggleModal('modal-pricing'); openJoinModal('free');">
                Start Free
              </button>
</div>
</div>
</div>
<!-- Pro -->
<div class="rounded-3xl border border-cyan-100 bg-gradient-to-br from-white to-cyan-50/40 p-6 shadow-sm relative overflow-hidden">
<div class="absolute -top-20 -right-20 w-48 h-48 rounded-full bg-cyan-300/10 blur-2xl"></div>
<div class="relative">
<div class="flex items-start justify-between gap-3">
<div>
<div class="text-[10px] font-extrabold tracking-widest uppercase text-cyan-700" data-i18n="pricing_plan_pro">Pro</div>
<div class="mt-1 text-xl font-header font-extrabold text-slate-900"><span data-i18n="pricing_price_19">$19</span><span class="text-[12px] font-extrabold text-gray-500" data-i18n="pricing_price_per_month">/ month</span></div>
<div class="mt-2 inline-flex items-center gap-2 text-[11px] font-extrabold px-2.5 py-1 rounded-full bg-white/70 border border-cyan-100 text-slate-700">
<i class="fa-solid fa-lock text-[11px] text-cyan-700"></i><span data-i18n="pricing_trial_available">Trial available</span></div>
</div>
<div class="w-12 h-12 rounded-2xl bg-white/70 border border-cyan-100 grid place-items-center shadow-sm">
<i class="fa-solid fa-gem text-cyan-700 text-[14px]"></i>
</div>
</div>
<ul class="mt-5 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_pro_b1">Unlimited uploads (projects, certificates, assets).</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_pro_b2">Structured company updates that deep-link to proof.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_pro_b3">Request verification (admin review) and display trust signals.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="pricing_pro_b4">Priority visibility and premium profile features.</span></li>
</ul>
<div class="mt-5 rounded-2xl border border-cyan-100 bg-white/70 p-4 text-[11px] text-gray-600">
<div class="font-extrabold text-slate-900" data-i18n="pricing_trials_title">How trials work</div>
<div class="mt-1" data-i18n="pricing_trials_desc">If you havenâ€™t used a trial yet, joining from a Pro CTA will start your Pro Trial automatically. If your trial has ended, you can activate Pro by paying.</div>
</div>
<div class="mt-6 flex justify-end">
<button class="px-5 py-2.5 rounded-xl bg-BTrustOn-primary hover:bg-BTrustOn-accent text-white text-xs font-extrabold transition shadow-lg shadow-cyan-500/15" data-i18n="about_cta_pro" onclick="toggleModal('modal-pricing'); openJoinModal('pro');">
                Go Pro
              </button>
</div>
</div>
</div>
</div>
<div class="text-[11px] text-gray-400" data-i18n="pricing_notes">
        Notes: Prices are shown in USD. Taxes may apply depending on jurisdiction. Payments and invoicing are handled via our payment provider.
      </div>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]" id="modal-terms">
<div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="toggleModal('modal-terms')"></div>
<div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col border border-white/60">
<div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
<div>
<h2 class="text-2xl font-header font-extrabold text-BTrustOn-primary" data-i18n="join_terms_terms">Terms of Service</h2>
<p class="text-xs text-gray-400 mt-1" data-i18n="privacy_last_updated">Last Updated: December 21, 2025</p>
</div>
<button aria-label="Close" class="text-gray-400 hover:text-red-500 transition" data-i18n-aria="attr_close_d3d2e6" onclick="toggleModal('modal-terms')">
<i class="fa-solid fa-xmark text-2xl"></i>
</button>
</div>
<div class="p-8 space-y-6 text-sm text-gray-600 leading-relaxed">
<div class="rounded-2xl border border-amber-100 bg-amber-50 p-4 text-amber-900">
<div class="text-xs font-extrabold uppercase tracking-wider" data-i18n="ui_important_0ab984">Important</div>
<div class="mt-1 text-[12px]" data-i18n="ui_btruston_is_a_b2b_discovery_and_013b55">
          BTrustOn is a B2B discovery and verification platform. We are not a party to transactions between companies and we do not guarantee performance, quality, safety, or compliance of any listed company.
        </div>
</div>
<div class="rounded-2xl border border-gray-100 bg-white p-5">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="ui_overview_3b8782">Overview</div>
<ul class="mt-3 space-y-2 text-[12px] text-gray-600">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_by_using_the_platform_you_agree_9f8046">By using the platform, you agree to these Terms and our Privacy Policy.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_you_are_responsible_for_your_con_c6f1a3">You are responsible for your content and for conducting your own due diligence.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_verification_badges_are_trust_si_08c4b0">Verification badges are trust signals based on review processesâ€”not warranties.</span></li>
</ul>
</div>
<div class="space-y-5">
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_1_eligibility_authority_a9bd34">1. Eligibility &amp; Authority</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_you_must_be_able_to_form_a_bindi_a1f9c4">
            You must be able to form a binding contract in your jurisdiction. If you create or manage a company profile, you represent you have authority to act on behalf of that entity.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_2_accounts_security_6a9214">2. Accounts &amp; Security</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_you_are_responsible_for_maintain_a4437f">
            You are responsible for maintaining account security and all activity under your account. Notify us promptly of unauthorized use.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_3_content_proof_uploads_32735b">3. Content &amp; Proof Uploads</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_you_retain_ownership_of_your_con_f7f87d">
            You retain ownership of your content (logos, documents, project references, asset lists, certificates). By uploading, you grant BTrustOn a non-exclusive license to host, display, and distribute it within the platform for discovery and verification purposes.
          </p>
<ul class="mt-2 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_do_not_upload_confidential_infor_f6031d">Do not upload confidential information you cannot share publicly.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_you_must_have_the_rights_to_uplo_212277">You must have the rights to upload and display the materials.</span></li>
</ul>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_4_verification_d2a6f3">4. Verification</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_verification_indicates_that_cert_63881e">
            Verification indicates that certain submitted information has been reviewed. Verification can be suspended or removed if we detect inconsistency, misuse, or policy violations. Verification does not replace buyer due diligence.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_5_pro_plan_trials_payments_92830a">5. Pro Plan, Trials &amp; Payments</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_pro_features_may_include_unlimit_8a4299">
            Pro features may include unlimited uploads, structured updates, and premium visibility. Trial access may be available once per company/account. After a trial ends, paid subscription may be required to continue Pro features.
          </p>
<ul class="mt-2 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_pricing_and_included_features_ma_24bb34">Pricing and included features may change with notice.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_payments_are_processed_by_a_thir_9eb87a">Payments are processed by a third-party provider; we do not store full card details.</span></li>
</ul>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_6_acceptable_use_557c7c">6. Acceptable Use</h4>
<ul class="mt-2 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_no_fraud_impersonation_or_mislea_43c399">No fraud, impersonation, or misleading claims.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_no_harassment_hate_or_unlawful_c_b287e2">No harassment, hate, or unlawful content.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="ui_no_scraping_reverse_engineering_67f792">No scraping, reverse engineering, or abuse of platform systems.</span></li>
</ul>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_7_disclaimers_ac5047">7. Disclaimers</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_the_platform_is_provided_as_is_a_27ebcb">
            The platform is provided â€œas isâ€ and â€œas availableâ€. We disclaim warranties to the maximum extent permitted by law, including fitness for a particular purpose and non-infringement.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_8_limitation_of_liability_64c68c">8. Limitation of Liability</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_to_the_maximum_extent_permitted_722762">
            To the maximum extent permitted by law, BTrustOn will not be liable for indirect, incidental, special, consequential, or punitive damages. Our total liability for any claim is limited to the amount you paid to us in the 12 months prior to the event giving rise to the claim.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_9_termination_dca51a">9. Termination</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_we_may_suspend_or_terminate_acco_cb7751">
            We may suspend or terminate accounts for violations or to protect platform integrity. You may stop using the platform at any time.
          </p>
</div>
<div>
<h4 class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider mb-1" data-i18n="ui_10_governing_law_fbd5d2">10. Governing Law</h4>
<p class="text-[12px] text-gray-600" data-i18n="ui_these_terms_are_governed_by_the_4e4761">
            These Terms are governed by the laws of the Republic of Turkey. Disputes shall be resolved in the courts of Istanbul (Ã‡aÄŸlayan), unless mandatory law requires otherwise.
          </p>
</div>
</div>
</div>
<div class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end">
<button class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl text-xs transition" data-i18n="privacy_close" onclick="toggleModal('modal-terms')">CLOSE</button>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]" id="modal-privacy">
<div class="modal-overlay absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-0" onclick="toggleModal('modal-privacy')"></div>
<div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col border border-white/60">
<div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
<div>
<h2 class="text-2xl font-header font-extrabold text-BTrustOn-primary" data-i18n="join_terms_privacy">Privacy Policy</h2>
<p class="text-xs text-gray-400 mt-1" data-i18n="privacy_last_updated">Last Updated: December 21, 2025</p>
</div>
<button aria-label="Close" class="text-gray-400 hover:text-red-500 transition" data-i18n-aria="attr_close_d3d2e6" onclick="toggleModal('modal-privacy')">
<i class="fa-solid fa-xmark text-2xl"></i>
</button>
</div>
<div class="p-8 space-y-6 text-sm text-gray-600 leading-relaxed">
<div class="rounded-2xl border border-gray-100 bg-white p-5">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="privacy_summary_title">Summary</div>
<p class="mt-2 text-[12px] text-gray-600" data-i18n="privacy_summary_body">
          We collect the information needed to run a B2B verification and discovery platform. We do not sell personal data. We may share data with service providers that help us operate the platform (hosting, storage, analytics, payments).
        </p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="rounded-2xl border border-gray-100 bg-gray-50 p-5">
<div class="text-xs font-extrabold text-slate-900" data-i18n="privacy_provide_title">Information you provide</div>
<ul class="mt-3 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_provide_1">Company profile details (name, sector, business type, country/city).</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_provide_2">Proof content (projects, certificates, assets) you choose to upload.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_provide_3">Verification data (e.g., Company ID / VKN) submitted for review.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_provide_4">Messages such as quote requests and support inquiries.</span></li>
</ul>
</div>
<div class="rounded-2xl border border-gray-100 bg-gray-50 p-5">
<div class="text-xs font-extrabold text-slate-900" data-i18n="privacy_auto_title">Information we collect automatically</div>
<ul class="mt-3 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_auto_1">Basic device and usage data (pages viewed, interactions, timestamps).</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_auto_2">Log data for security, fraud prevention, and reliability.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_auto_3">Cookies/local storage for session and preferences (e.g., language).</span></li>
</ul>
</div>
</div>
<div class="rounded-3xl border border-gray-100 bg-white p-6">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="privacy_use_title">How we use information</div>
<ul class="mt-3 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_use_1">To create and display company profiles and trust signals.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_use_2">To run verification workflows and protect platform integrity.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_use_3">To enable messaging and quote requests between companies.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_use_4">To improve performance, analytics, and product experience.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_use_5">To comply with legal obligations and enforce our Terms.</span></li>
</ul>
</div>
<div class="rounded-3xl border border-gray-100 bg-white p-6">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="privacy_share_title">Sharing &amp; disclosures</div>
<p class="mt-2 text-[12px] text-gray-600" data-i18n="privacy_share_body">
          We may share information with vendors who process data on our behalf (e.g., infrastructure, storage, analytics, payment processing) and with authorities if required by law. Company profile information and uploaded proof may be visible to other users depending on your platform settings.
        </p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="rounded-2xl border border-gray-100 bg-gray-50 p-5">
<div class="text-xs font-extrabold text-slate-900" data-i18n="privacy_retention_title">Data retention</div>
<p class="mt-2 text-[12px] text-gray-600" data-i18n="privacy_retention_body">
            We keep data as long as necessary to provide the service, meet legal requirements, resolve disputes, and enforce agreements. You may request deletion where applicable.
          </p>
</div>
<div class="rounded-2xl border border-gray-100 bg-gray-50 p-5">
<div class="text-xs font-extrabold text-slate-900" data-i18n="privacy_choices_title">Your choices</div>
<ul class="mt-3 space-y-2 text-[12px]">
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_choices_1">Access and update your company profile information.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_choices_2">Control what proof you upload and keep public.</span></li>
<li class="flex gap-2"><span class="text-gray-400" data-i18n="ui_53fe08">â€¢</span><span data-i18n="privacy_choices_3">Request data export or deletion (subject to legal limits).</span></li>
</ul>
</div>
</div>
<div class="rounded-2xl border border-gray-100 bg-white p-5">
<div class="text-xs font-extrabold text-BTrustOn-primary uppercase tracking-wider" data-i18n="privacy_contact_title">Contact</div>
<p class="mt-2 text-[12px] text-gray-600" data-i18n="privacy_contact_body">
          For privacy requests, please contact support via the platform. If you provide personal data belonging to others (e.g., employee/contact details), you confirm you have the right to share it.
        </p>
</div>
</div>
<div class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end">
<button class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl text-xs transition" data-i18n="privacy_close" onclick="toggleModal('modal-privacy')">CLOSE</button>
</div>
</div>
</div>
<div class="modal fixed inset-0 z-[70] opacity-0 pointer-events-none transition-opacity duration-200" id="modal-upgrade">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
<div class="relative min-h-full flex items-center justify-center p-4">
<div class="w-full max-w-md rounded-3xl bg-white shadow-2xl border border-white/60 overflow-hidden">
<!-- Premium header -->
<div class="relative px-6 pt-6 pb-5 bg-gradient-to-br from-slate-950 via-BTrustOn-primary to-slate-800 text-white">
<div class="absolute -top-16 -right-16 w-40 h-40 rounded-full bg-white/10 blur-2xl"></div>
<div class="absolute -bottom-20 -left-20 w-48 h-48 rounded-full bg-cyan-400/10 blur-2xl"></div>
<div class="relative flex items-start justify-between gap-3">
<div class="flex items-center gap-3">
<div class="w-12 h-12 rounded-2xl bg-cyan-400/10 border border-cyan-200/25 flex items-center justify-center shadow-glass">
<i class="fa-solid fa-gem text-cyan-100 text-[18px]"></i>
</div>
<div>
<h3 class="text-base font-header font-extrabold leading-tight" data-i18n="plan_upgrade_title">Upgrade to Pro</h3>
<p class="text-[11px] text-white/75 leading-snug mt-1" data-i18n="plan_upgrade_desc">Unlimited uploads, updates &amp; priority visibility.</p>
</div>
</div>
<span class="text-[10px] font-extrabold px-2.5 py-1 rounded-full bg-cyan-400/10 border border-cyan-200/25 text-cyan-50" data-i18n="badge_trial" id="upgrade-pill-trial">TRIAL</span>
</div>
</div>
<div class="p-6">
<div class="flex items-center gap-2 mb-4">
<div class="w-10 h-10 rounded-2xl bg-cyan-50 border border-cyan-100 flex items-center justify-center text-cyan-700 shrink-0">
<i class="fa-solid fa-gem text-[12px]"></i>
</div>
<div class="text-xs font-extrabold text-slate-900" data-i18n="upgrade_benefits_title">What you get with Pro</div>
</div>
<ul class="grid grid-cols-1 gap-3 mb-5">
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-circle-check text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_1">Verified badge after approval</div>
</li>
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-infinity text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_2">Unlimited projects, certificates &amp; assets</div>
</li>
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-bullhorn text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_3">Post Company Updates</div>
</li>
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-images text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_4">Albums (galleries) for projects &amp; assets</div>
</li>
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-arrow-up-right-dots text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_5">Priority visibility in search</div>
</li>
<li class="flex items-center gap-3">
<div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 grid place-items-center shrink-0 shadow-sm">
<i class="fa-solid fa-bolt text-cyan-700 text-[13px] leading-none"></i>
</div>
<div class="text-xs font-extrabold text-slate-900 leading-tight flex-1" data-i18n="price_pro_6">Easier access for buyers after verification</div>
</li>
</ul>
<!-- Offer -->
<div class="rounded-2xl border border-[rgba(15,23,42,.10)] bg-white/70 backdrop-blur px-4 py-3 mb-6 shadow-glass">
<div class="flex items-center gap-3">
<div class="w-9 h-9 rounded-2xl bg-cyan-50 border border-cyan-100 flex items-center justify-center text-cyan-700 shrink-0">
<i class="fa-solid fa-lock text-[12px] leading-none"></i>
</div>
<div class="min-w-0">
<div class="text-[10px] font-extrabold text-slate-500 uppercase tracking-wider leading-tight" data-i18n="upgrade_offer_title">Offer</div>
<div class="text-[11px] font-semibold text-slate-700 leading-snug mt-0.5" data-i18n="upgrade_offer_line" id="upgrade-offer-text">
                3 months free trial â€¢ No card required â€¢ Then $19/month.
              </div>
</div>
</div>
</div>
<div class="flex gap-3">
<button class="flex-1 py-3 rounded-xl border border-slate-200 bg-white text-slate-700 text-xs font-extrabold hover:bg-slate-50 transition" data-i18n="upgrade_btn_not_now" onclick="toggleModal('modal-upgrade')">NOT NOW</button>
<button class="flex-1 py-3 rounded-xl bg-BTrustOn-accent text-white text-xs font-extrabold hover:bg-BTrustOn-darkAccent transition flex items-center justify-center gap-2" onclick="handleUpgradeCTA()">
<i class="fa-solid fa-gem text-[12px] leading-none -mt-px text-white/90"></i>
<span class="text-center leading-tight" data-i18n="btn_start_trial" id="upgrade-cta-label">START FREE TRIAL</span>
</button>
</div>
</div>
</div>
</div>
</div>
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[10000]" id="modal-celebration">
<div class="modal-overlay absolute w-full h-full bg-slate-900/90 backdrop-blur-md transition-opacity duration-500"></div>
<div class="modal-container relative bg-white w-11/12 md:max-w-sm mx-auto rounded-3xl shadow-2xl overflow-hidden transform scale-90 transition-all duration-500 ease-out" id="celebration-card">
<div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-40 bg-gradient-to-b from-blue-500/20 to-transparent blur-3xl pointer-events-none"></div>
<div class="p-8 text-center relative z-10">
<div class="mb-6 relative inline-block">
<div class="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
<div class="relative w-24 h-24 bg-gradient-to-tr from-blue-600 to-cyan-400 rounded-full flex items-center justify-center text-white text-5xl shadow-lg shadow-blue-500/40 animate-bounce-slow">
<i class="fa-solid fa-check"></i>
</div>
<i class="fa-solid fa-star text-amber-400 absolute -top-2 -right-2 text-xl animate-spin-slow"></i>
<i class="fa-solid fa-star text-amber-400 absolute bottom-0 -left-2 text-lg animate-ping"></i>
</div>
<h2 class="text-2xl font-header font-bold text-slate-800 mb-2" data-i18n="celebration_title">You are Verified!</h2>
<p class="text-sm text-gray-500 leading-relaxed mb-8"><span data-i18n="celebration_desc">Congratulations! Your business documentation has been approved. You now have the</span><strong class="text-blue-600" data-i18n="celebration_badge_label">Blue Badge</strong>.
        </p>
<button class="w-full py-4 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 hover:scale-[1.02] transition transform shadow-xl" data-i18n="celebration_cta" onclick="closeCelebration()">
            AWESOME, THANKS!
        </button>
</div>
</div>
</div>
<style>
/* Ã–zel Animasyonlar */
/* --- 1. KUTLAMA ANÄ°MASYONLARI (MODAL Ä°Ã‡Ä°N) --- */
    @keyframes bounce-slow {
      0%, 100% { transform: translateY(-5%); }
      50% { transform: translateY(5%); }
    }
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }

    /* --- 2. HATA TÄ°TREMESÄ° (KIRMIZI - SHAKE) --- */
    @keyframes shake-error {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-6px) rotate(-1deg); }
      30% { transform: translateX(6px) rotate(1deg); }
      45% { transform: translateX(-4px); }
      60% { transform: translateX(4px); }
    }
    .shake-input {
      animation: shake-error 0.5s cubic-bezier(.36,.07,.19,.97) both !important;
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
      background-color: #fef2f2 !important;
    }

    /* --- 3. DÄ°KKAT Ã‡EKME (MAVÄ° TÄ°TREME - FOCUS) --- */
    /* --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž (AMA NAZÄ°K) DÄ°KKAT Ã‡EKME EFEKTÄ° --- */
/* --- 3. DÄ°KKAT Ã‡EKME (PREMIUM FOCUS HINT) --- */
/* Dropdown/CTA sonrasÄ± kullanÄ±cÄ±yÄ± ilgili alana "nazikÃ§e" yÃ¶nlendirmek iÃ§in */
@keyframes strong-shake {
  0%   { transform: translateY(0) scale(1); }
  35%  { transform: translateY(-1px) scale(1.012); }
  70%  { transform: translateY(0) scale(1.006); }
  100% { transform: translateY(0) scale(1); }
}

/* Class adÄ± aynÄ±: JS dokunmadan Ã§alÄ±ÅŸsÄ±n */
.attention-grabber {
  animation: strong-shake 0.65s cubic-bezier(.2,.9,.2,1) both !important;

  /* Daha premium "ring + glow" (shake yerine) */
  border: 1px solid rgba(34, 211, 238, 0.45) !important;
  background: linear-gradient(180deg, rgba(236, 254, 255, 0.78), rgba(255, 255, 255, 0.92)) !important;
  box-shadow:
    0 14px 42px rgba(2, 132, 199, 0.10),
    0 0 0 4px rgba(34, 211, 238, 0.10) !important;

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  position: relative;
  z-index: 50;
}

@media (prefers-reduced-motion: reduce) {
  .attention-grabber { animation: none !important; }
}/* --- 4. ZÄ°L SALLANMASI (FIX: GROUP HOVER) --- */
    @keyframes swing {
      20% { transform: rotate(15deg); }
      40% { transform: rotate(-10deg); }
      60% { transform: rotate(5deg); }
      80% { transform: rotate(-5deg); }
      100% { transform: rotate(0deg); }
    }
    /* DÃœZELTME: Tailwind'in yapamadÄ±ÄŸÄ±nÄ± manuel CSS ile yapÄ±yoruz */
    .group:hover .fa-bell {
      animation: swing 2s ease-in-out infinite;
      transform-origin: top center;
    }

    /* --- 5. TAÃ‡ Ä°KONU (NEFES ALMA) --- */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .animate-pulse-slow {
      animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

/* === Attachment image viewer (Assets/Certificates) - Pan + stable zoom === */
#attachment-stage.attachment-pan-stage{ overscroll-behavior: contain; }
#attachment-stage.attachment-pan-enabled{ cursor: grab; touch-action: none; }
#attachment-stage.attachment-pan-enabled.is-panning{ cursor: grabbing; }
#attachment-canvas{ background: transparent; }
#attachment-img{ -webkit-user-drag: none; user-select: none; max-width: none; max-height: none; }

</style>
<style id="mobile-inbox-tabs-wrap">
/* MOBILE INBOX TABS (clean, 1-row, text-only) */
@media (max-width: 520px){
  .bton-inbox-tabs-bar{
    display: grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    gap: 8px !important;
    align-items: center !important;
  }
  #btn-tab-inbox, #btn-tab-sent, #btn-tab-notif{
    width: 100% !important;
    justify-content: center !important;
    padding: 8px 8px !important;
    font-size: 11px !important;
    line-height: 1.05 !important;
    white-space: nowrap !important;
  }
  /* remove extra icons on mobile for a cleaner look */
  #btn-tab-sent i,
  #btn-tab-notif i{
    display: none !important;
  }
  /* remove flex gaps when icons are hidden */
  #btn-tab-inbox, #btn-tab-sent, #btn-tab-notif{
    gap: 0 !important;
  }
  #btn-tab-notif #notif-tab-badge{
    margin-left: 6px !important;
  }
}

/* === BTrustOn Premium UX (Empty states + Tooltips + Active signal) === */
.bton-tip{ position:relative; display:inline-flex; align-items:center; }
.bton-tip[data-tip]::after{
  content: attr(data-tip);
  position:absolute;
  left:50%;
  bottom: calc(100% + 10px);
  transform: translateX(-50%);
  background: rgba(15,23,42,.95);
  color: #fff;
  padding: 8px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .01em;
  white-space: nowrap;
  box-shadow: 0 18px 40px -22px rgba(15,23,42,.75);
  opacity: 0;
  pointer-events: none;
  transition: opacity .12s ease, transform .12s ease;
  z-index: 99999;
}
.bton-tip[data-tip]::before{
  content:"";
  position:absolute;
  left:50%;
  bottom: calc(100% + 4px);
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid rgba(15,23,42,.95);
  opacity: 0;
  transition: opacity .12s ease;
  z-index: 99999;
}

/* Use a floating tooltip (not clipped by card overflow) */
.bton-tip[data-tip]::after,
.bton-tip[data-tip]::before{
  display: none !important;
}

#bton-floating-tooltip{
  position: fixed;
  left: 0;
  top: 0;
  display: none;
  max-width: 320px;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(15,23,42,.95);
  color: #fff;
  font-size: 12px;
  line-height: 1.3;
  box-shadow: 0 18px 40px -22px rgba(15,23,42,.75);
  z-index: 2147483647;
  pointer-events: none;
  white-space: normal;
}
#bton-floating-tooltip[data-show="1"]{
  display: block;
}

.bton-tip:hover::after{ opacity:1; transform: translateX(-50%) translateY(-2px); }
.bton-tip:hover::before{ opacity:1; }

.bton-empty-card{
  display:flex;
  gap: 14px;
  align-items:flex-start;
  padding: 18px;
  border-radius: 18px;
  border: 1px dashed rgba(15,23,42,.14);
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(10px);
  box-shadow: 0 18px 44px -30px rgba(15,23,42,.45);
}
.bton-empty-card--soft{ border-style: solid; border-color: rgba(15,23,42,.08); background: rgba(255,255,255,.62); }
.bton-empty-ic{
  width: 42px; height: 42px;
  border-radius: 16px;
  display:grid; place-items:center;
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.08);
  color: rgba(15,23,42,.70);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
  flex: 0 0 auto;
}
.bton-empty-title{ font-size: 13px; font-weight: 900; color: rgba(15,23,42,.92); letter-spacing: .01em; }
.bton-empty-desc{ margin-top: 4px; font-size: 12px; font-weight: 600; color: rgba(15,23,42,.55); line-height: 1.35; }

/* Home > Company Updates empty-state: slightly smaller copy */
#home-updates-empty .bton-empty-title{ font-size: 12px; }
#home-updates-empty .bton-empty-desc{ font-size: 11px; }
.bton-empty-action{
  margin-top: 10px;
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.78);
  color: rgba(15,23,42,.80);
  font-size: 11px;
  font-weight: 900;
  letter-spacing: .04em;
  text-transform: uppercase;
  transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
}
.bton-empty-action:hover{
  background: rgba(255,255,255,.95);
  border-color: rgba(15,23,42,.18);
  box-shadow: 0 14px 30px -24px rgba(15,23,42,.55);
  transform: translateY(-1px);
}

.bton-active-pill{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(6,182,212,.25);
  background: rgba(6,182,212,.06);
  color: rgba(8,145,178,.95);
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .06em;
  text-transform: uppercase;
  line-height: 1;
}
.bton-active-dot{
  width: 7px; height: 7px;
  border-radius: 999px;
  background: rgba(6,182,212,.95);
  box-shadow: 0 0 0 3px rgba(6,182,212,.10);
}


/* =========================
   BTrustOn Welcome Modal (Join) â€” Ultra Premium Minimal
========================= */
.bton-modal-open{ overflow:hidden; }
#bton-welcome-overlay.hidden{ display:none !important; }
#bton-welcome-overlay{
  position:fixed; inset:0;
  z-index:99999;
  display:flex; align-items:center; justify-content:center;
  padding:18px;
}
#bton-welcome-overlay .bton-welcome-backdrop{
  position:absolute; inset:0;
  background:
    radial-gradient(1200px 600px at 20% 10%, rgba(56,189,248,.14), transparent 55%),
    radial-gradient(900px 520px at 90% 0%, rgba(99,102,241,.10), transparent 60%),
    rgba(2,6,23,.62);
  backdrop-filter: blur(14px) saturate(140%);
}
#bton-welcome-overlay .bton-welcome-card{
  position:relative;
  width:min(600px, 100%);
  border-radius: 28px;
  background: linear-gradient(180deg, rgba(255,255,255,.94) 0%, rgba(248,250,252,.90) 100%);
  border: 1px solid rgba(148,163,184,.26);
  box-shadow:
    0 55px 140px rgba(2,6,23,.30),
    0 14px 38px rgba(2,6,23,.12),
    inset 0 1px 0 rgba(255,255,255,.75);
  overflow:hidden;
  transform: translateY(10px) scale(.985);
  opacity:0;
  transition: transform .22s cubic-bezier(.2,.9,.2,1), opacity .22s ease;
  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing: antialiased;
  text-rendering: geometricPrecision;
}
#bton-welcome-overlay .bton-welcome-card:before{
  content:'';
  position:absolute; left:0; right:0; top:0; height:1px;
  background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(59,130,246,.95), rgba(99,102,241,.90));
  opacity:.9;
}
#bton-welcome-overlay .bton-welcome-card:after{
  content:'';
  position:absolute; inset:-1px;
  background:
    radial-gradient(700px 260px at 18% -10%, rgba(56,189,248,.22), transparent 62%),
    radial-gradient(600px 240px at 105% 15%, rgba(99,102,241,.14), transparent 58%),
    radial-gradient(380px 180px at 35% 115%, rgba(16,185,129,.06), transparent 62%);
  pointer-events:none;
  opacity:.9;
}
#bton-welcome-overlay.show .bton-welcome-card{
  transform: translateY(0) scale(1);
  opacity:1;
}
#bton-welcome-overlay .bton-welcome-top{
  position:relative;
  padding: 20px 20px 0 20px;
  display:flex; align-items:flex-start; justify-content:space-between;
  gap: 12px;
  z-index:2;
}
#bton-welcome-overlay .bton-welcome-badge{
  display:inline-flex;
  align-items:center;
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(15,23,42,.03);
  border: 1px solid rgba(148,163,184,.20);
  color: rgba(15,23,42,.78);
  font-weight: 900;
  font-size: 11px;
  letter-spacing: .18em;
  text-transform: uppercase;
}
#bton-welcome-overlay .bton-welcome-close{
  width: 40px; height: 40px;
  border-radius: 14px;
  display:grid; place-items:center;
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(148,163,184,.18);
  color: rgba(15,23,42,.70);
  cursor:pointer;
  transition: background .14s ease, transform .14s ease, box-shadow .14s ease;
  z-index:2;
}
#bton-welcome-overlay .bton-welcome-close:hover{
  background: rgba(15,23,42,.07);
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(2,6,23,.10);
}
#bton-welcome-overlay .bton-welcome-body{
  position:relative;
  padding: 12px 24px 24px 24px;
  z-index:2;
}
#bton-welcome-overlay .bton-welcome-title{
  margin-top: 12px;
  font-size: 28px;
  line-height: 1.12;
  font-weight: 950;
  color: rgba(15,23,42,.92);
  letter-spacing: -0.03em;
}
#bton-welcome-overlay .bton-welcome-text{
  margin-top: 14px;
  font-size: 14.5px;
  line-height: 1.78;
  color: rgba(51,65,85,.92);
}
#bton-welcome-overlay .bton-welcome-cta{
  margin-top: 20px;
}
#bton-welcome-overlay .bton-welcome-btn{
  width: 100%;
  border-radius: 18px;
  padding: 16px 18px;
  font-size: 12.5px;
  font-weight: 950;
  letter-spacing: .19em;
  text-transform: uppercase;
  border: 1px solid rgba(255,255,255,.25);
  color: white;
  background: linear-gradient(135deg, rgba(14,165,233,.98), rgba(37,99,235,.98));
  box-shadow:
    0 18px 52px rgba(2,132,199,.26),
    inset 0 1px 0 rgba(255,255,255,.22);
  cursor: pointer;
  transition: transform .12s ease, filter .12s ease;
}
#bton-welcome-overlay .bton-welcome-btn:hover{
  filter: brightness(.99);
  transform: translateY(-1px);
}
#bton-welcome-overlay .bton-welcome-btn:active{
  transform: translateY(0);
}

@media (max-width: 420px){
  #bton-welcome-overlay{ padding:14px; }
  #bton-welcome-overlay .bton-welcome-card{ border-radius: 24px; }
  #bton-welcome-overlay .bton-welcome-title{ font-size: 24px; }
  #bton-welcome-overlay .bton-welcome-text{ font-size: 14px; }
}



</style>
<div class="modal opacity-0 pointer-events-none fixed inset-0 z-[120000] flex items-center justify-center bg-black/90 backdrop-blur-md transition-all duration-300" id="modal-gallery">
<button class="absolute top-5 right-5 text-white/70 hover:text-white text-3xl z-50" onclick="closeGallery()">
<i class="fa-solid fa-xmark"></i>
</button>
<div class="w-full h-full flex flex-col items-center justify-center p-4">
<div class="relative w-full max-w-5xl flex items-center justify-center mb-4">
  <button id="gallery-prev" type="button" aria-label="Previous" class="absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 z-10 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur flex items-center justify-center text-white transition shadow-lg">
    <i class="fa-solid fa-chevron-left"></i>
  </button>
  <img class="max-h-[80vh] max-w-full object-contain rounded-lg shadow-2xl animate-fade-in" id="gallery-main-img" src=""/>
  <button id="gallery-next" type="button" aria-label="Next" class="absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 z-10 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur flex items-center justify-center text-white transition shadow-lg">
    <i class="fa-solid fa-chevron-right"></i>
  </button>
</div>
<div class="flex gap-2 overflow-x-auto max-w-2xl pb-2 custom-scrollbar" id="gallery-thumbs">
</div>
<p class="text-white/80 text-sm font-bold mt-2" id="gallery-caption"></p>
</div>
</div>
<!-- (removed duplicate project cropper modal; using main cropper modal) -->
<script>
  // Login modalÄ±nÄ± aÃ§/kapat
  function openLoginModal() {
    const modal = document.getElementById("login-modal");
    if (!modal) return;
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    const err = document.getElementById("login-error");
    if (err) {
      err.classList.add("hidden");
      err.textContent = "";
    }
  }

  function closeLoginModal() {
    const modal = document.getElementById("login-modal");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");

    const err = document.getElementById("login-error");
    if (err) {
      err.classList.add("hidden");
      err.textContent = "";
    }
  }

  
  // Sayfa yÃ¼klendiÄŸinde login formunu hazÄ±rla
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("login-form");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = new FormData(form);
      const email = data.get("email");
      const password = data.get("password");

      const err = document.getElementById("login-error");
      if (err) {
        err.classList.add("hidden");
        err.textContent = "";
      }

      const { data: authData, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        if (err) {
          err.textContent = error.message || "Login failed";
          err.classList.remove("hidden");
        }
        return;
      }

      // âœ… Login baÅŸarÄ±lÄ±
      closeLoginModal();
      checkUserAndOpenProfile(true);

      // If user clicked "Claim" while logged out, continue after login
      try {
        const pcid = window.__pendingClaimCompanyId;
        const pcname = window.__pendingClaimCompanyName;
        if (pcid) {
          window.__pendingClaimCompanyId = null;
          window.__pendingClaimCompanyName = null;
          setTimeout(() => {
            try { openClaimCompanyModal(pcid, pcname || ""); } catch(e) {}
          }, 350);
        }
      } catch(e) {}
    });
  });

  // Logout
  /* --- GÃœNCELLENMÄ°Åž: partnerLogout (Sessiz ve Temiz) --- */
async function partnerLogout() {
  try {
    // Varsa mesaj dinlemeyi durdur (Hata vermemesi iÃ§in)
    if (typeof messageChannel !== 'undefined' && messageChannel) {
        supabaseClient.removeChannel(messageChannel);
    }

    // 1. Supabase oturumunu kapat
    await supabaseClient.auth.signOut();
    
    // 2. HafÄ±zayÄ± temizle
    localStorage.removeItem("BTrustOn_my_company_id");
    try { __myProForEngagement = false; } catch(e) {}
    if(typeof selectedCompany !== 'undefined') selectedCompany = null;

    // 3. Bildirim gÃ¶stermeden direkt ana sayfaya dÃ¶n
    window.location.href = "/";

  } catch (err) {
    console.error("Logout error:", err);
    window.location.href = "/"; // Hata olsa bile sayfayÄ± yenile
  }
}
</script>
<script>
        const translations = { en: {}, tr: {}, es: {} };

let currentLang = (() => {
  try {
    const v = String(localStorage.getItem("bton_lang") || "en").toLowerCase();
    if (v.startsWith("tr")) return "tr";
    if (v.startsWith("es")) return "es";
    return "en";
  } catch(e) { return "en"; }
})();
// =======================
// DEBUG (safe diagnostics)
// Enable via: ?debug=1  OR localStorage.setItem("bton_debug","1")
// Disable via: localStorage.removeItem("bton_debug")
// =======================
const BTON_DEBUG = (() => {
  try {
    const qs = new URLSearchParams(window.location.search || "");
    if (qs.get("debug") === "1" || qs.get("debug") === "true") return true;
    return (localStorage.getItem("bton_debug") === "1");
  } catch (e) { return false; }
})();
function btonDbg(...args){ try { if (BTON_DEBUG) console.log("[BTrustOn]", ...args); } catch(e) {} }


// =======================
// i18n JSON Loader (Tolgee Export via /i18n/*.json)
// =======================
const I18N_VERSION = "updated35";

// Add languages here and drop the corresponding file into /i18n/<lang>.json
const I18N_ENDPOINTS = {
  en: `i18n/en.json?v=${I18N_VERSION}`,
  tr: `i18n/tr.json?v=${I18N_VERSION}`,
  es: `i18n/es.json?v=${I18N_VERSION}`,
};

const __i18nLoad = { en: null, tr: null, es: null };

function __normalizeLangForI18n(lang) {
  const s = String(lang || "en").toLowerCase();
  if (s.startsWith("tr")) return "tr";
  if (s.startsWith("es")) return "es";
  if (s.startsWith("en")) return "en";
  // allow future 2-letter codes if you add a JSON + a menu item
  return s.length ? s.split("-")[0] : "en";
}

function loadI18n(lang) {
  const L = __normalizeLangForI18n(lang);
  const endpoint = I18N_ENDPOINTS[L] || `i18n/${L}.json?v=${I18N_VERSION}`;
  if (translations[L] && Object.keys(translations[L]).length) return Promise.resolve(translations[L]);
  if (__i18nLoad[L]) return __i18nLoad[L];

    const __i18nCtrl = new AbortController();
  const __i18nTmr = setTimeout(() => { try { __i18nCtrl.abort(); } catch(e){} }, 6000);

  __i18nLoad[L] = fetch(endpoint, { cache: "no-store", signal: __i18nCtrl.signal })
    .finally(() => { try { clearTimeout(__i18nTmr); } catch(e){} })
    .then((r) => (r.ok ? r.json() : {}))
    .then((json) => {
      if (json && typeof json === "object") translations[L] = json;
      return translations[L] || {};
    })
    .catch(() => (translations[L] || {}))
    .finally(() => { __i18nLoad[L] = null; });

  return __i18nLoad[L];
}

async function bootI18n() {
  let saved = "en";
  try { saved = localStorage.getItem("bton_lang") || "en"; } catch(e) {}
  saved = __normalizeLangForI18n(saved) || "en";

  // Preload EN + the chosen language (prevents "blank" UI on non-EN)
  try { await loadI18n("en"); } catch(e) {}
  if (saved !== "en") { try { await loadI18n(saved); } catch(e) {} }

  // switchLanguage already applies i18n + refreshes dynamic UI
  if (typeof switchLanguage === "function") switchLanguage(saved);
}
    let currentSector = "all";
    let selectedCompany = null;
    const ADMIN_EMAIL = "rahmiunl@gmail.com"; // BURAYI KENDÄ° MAÄ°LÄ°NÄ°ZLE DEÄžÄ°ÅžTÄ°RÄ°N

// --- ADMIN PROFIL ID CACHE (analytics'te admin gÃ¶rÃ¼ntÃ¼lenmesin / sayÄ±lmasÄ±n) ---
let __ADMIN_PROFILE_ID_CACHE = null;
async function getAdminProfileId() {
  try {
    if (__ADMIN_PROFILE_ID_CACHE) return __ADMIN_PROFILE_ID_CACHE;
    const { data, error } = await supabaseClient
      .from('profiles')
      .select('id')
      .eq('email', ADMIN_EMAIL)
      .limit(1);

    if (error) return null;
    __ADMIN_PROFILE_ID_CACHE = (data && data[0] && data[0].id) ? data[0].id : null;
    return __ADMIN_PROFILE_ID_CACHE;
  } catch (e) {
    return null;
  }
}

/* --- ASSET CATALOG FILES (multi attachments) --- */
let currentAssetFiles = []; // Yeni seÃ§ilen dosyalar (File objeleri)
let existingAssetFiles = []; // Mevcut dosyalar: { url, name }


/* =========================================================
   HOME UPDATES (Last 7 days) + POST UPDATE MODAL
   ========================================================= */
let homeUpdatesData = [];
let homeUpdatesSub = null;
let __homeUpdatesPause = false;
let __homeUpdatesAutoPos = 0; // float px position for smooth auto-flow
let __homeUpdatesLoopWidth = 0;
let __homeUpdatesBaseHTML = "";
let __homeUpdatesLoopHTML = "";   // 1-cycle HTML (may be repeated if few items)
let __homeUpdatesRAF = null;
let __homeUpdatesLastTs = 0;
let __homeUpdatesHoldUntil = 0;   // pause auto-scroll until this timestamp
let __homeUpdatesSpeedPx = 22;    // auto-scroll speed (auto-tuned in startHomeUpdatesAutoScroll)
let __homeUpdatesUserScrollingT = null;
let __homeUpdatesIgnoreScrollUntil = 0; // ignore auto-triggered scroll events
let __postCompany = null;

let homeUpdatesFilter = "all"; // all | followed
let homeFollowSet = new Set();
let homeFollowLoadedFor = null;
let __authUserId = null;
let __myProForEngagement = false;

// --- FOLLOW START TIMES (prevent backfill notifications on first follow) ---
const BTON_FOLLOW_START_MAP_KEY = "BTrustOn_follow_started_at_map";
let __btonFollowStartMapCache = null;

function _btonGetFollowStartMap() {
  try {
    if (__btonFollowStartMapCache && typeof __btonFollowStartMapCache === "object") return __btonFollowStartMapCache;
  } catch(e) {}
  let m = {};
  try {
    const raw = localStorage.getItem(BTON_FOLLOW_START_MAP_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") m = parsed;
    }
  } catch(e) { m = {}; }
  __btonFollowStartMapCache = m;
  return m;
}

function _btonPersistFollowStartMap(m) {
  try {
    __btonFollowStartMapCache = m;
    localStorage.setItem(BTON_FOLLOW_START_MAP_KEY, JSON.stringify(m || {}));
  } catch(e) {}
}

function _btonGetFollowStartIso(cid) {
  try {
    cid = String(cid || "").trim();
    if (!cid) return null;
    const m = _btonGetFollowStartMap();
    return m && m[cid] ? String(m[cid]) : null;
  } catch(e) { return null; }
}

function _btonSetFollowStart(cid, iso) {
  try {
    cid = String(cid || "").trim();
    if (!cid) return;
    const m = _btonGetFollowStartMap();
    m[cid] = iso || new Date().toISOString();
    _btonPersistFollowStartMap(m);
  } catch(e) {}
}

function _btonRemoveFollowStart(cid) {
  try {
    cid = String(cid || "").trim();
    if (!cid) return;
    const m = _btonGetFollowStartMap();
    if (m && Object.prototype.hasOwnProperty.call(m, cid)) {
      delete m[cid];
      _btonPersistFollowStartMap(m);
    }
  } catch(e) {}
}

function _btonEnsureFollowStart(cid) {
  try {
    cid = String(cid || "").trim();
    if (!cid) return;
    const cur = _btonGetFollowStartIso(cid);
    if (!cur) _btonSetFollowStart(cid, new Date().toISOString());
  } catch(e) {}
}

function _btonIsAfterFollowStart(cid, createdAtIso) {
  try {
    const fs = _btonGetFollowStartIso(cid);
    if (!fs) return true; // if unknown, allow (but we set it on follow list load)
    const a = new Date(createdAtIso || Date.now()).getTime();
    const b = new Date(fs).getTime();
    if (isNaN(a) || isNaN(b)) return true;
    return a > b;
  } catch(e) { return true; }
}
// --- END FOLLOW START TIMES ---



const HOME_UPDATE_TEMPLATES = {
  projects: [
    { code: "kickoff", en: "Kick-off started", tr: "BaÅŸlangÄ±Ã§ / Kick-off baÅŸladÄ±", es: "Kick-off iniciado" },
    { code: "phase_started", en: "New phase started", tr: "Yeni faz baÅŸladÄ±", es: "Nueva fase iniciada" },
    { code: "milestone", en: "Milestone achieved", tr: "Kilometre taÅŸÄ± tamamlandÄ±", es: "Hito alcanzado" },
    { code: "scope_update", en: "Scope updated", tr: "Kapsam gÃ¼ncellendi", es: "Alcance actualizado" },
    { code: "schedule_update", en: "Schedule update", tr: "Takvim gÃ¼ncellemesi", es: "ActualizaciÃ³n del cronograma" },
    { code: "field_update", en: "Field update", tr: "Saha gÃ¼ncellemesi", es: "ActualizaciÃ³n de campo" },
    { code: "software_update", en: "Software / system update", tr: "YazÄ±lÄ±m / sistem gÃ¼ncellemesi", es: "ActualizaciÃ³n de software/sistema" },
    { code: "completed", en: "Completed", tr: "TamamlandÄ±", es: "Completado" },
  ],
  assets: [
    { code: "added", en: "New asset added", tr: "Yeni asset eklendi", es: "Nuevo activo aÃ±adido" },
    { code: "availability", en: "Availability updated", tr: "Uygunluk durumu gÃ¼ncellendi", es: "Disponibilidad actualizada" },
    { code: "maintenance", en: "Maintenance / service", tr: "BakÄ±m / servis", es: "Mantenimiento / servicio" },
    { code: "specs_update", en: "Specs updated", tr: "Teknik bilgiler gÃ¼ncellendi", es: "Especificaciones actualizadas" },
    { code: "inspection", en: "Inspection / calibration", tr: "Muayene / kalibrasyon", es: "InspecciÃ³n / calibraciÃ³n" },
    { code: "location", en: "Location updated", tr: "Lokasyon gÃ¼ncellendi", es: "UbicaciÃ³n actualizada" },
  ],
  certificates: [
    { code: "added", en: "New certificate added", tr: "Yeni sertifika eklendi", es: "Nuevo certificado aÃ±adido" },
    { code: "renewed", en: "Renewed", tr: "Yenilendi", es: "Renovado" },
    { code: "audit", en: "Audit / assessment passed", tr: "Denetim / deÄŸerlendirme geÃ§ti", es: "AuditorÃ­a / evaluaciÃ³n superada" },
    { code: "scope_update", en: "Scope updated", tr: "Kapsam gÃ¼ncellendi", es: "Alcance actualizado" },
    { code: "status", en: "Status update", tr: "Durum gÃ¼ncellemesi", es: "ActualizaciÃ³n de estado" },
  ]
};

function _i18n(key, fallback="") {
  try { return (translations && translations[currentLang] && translations[currentLang][key]) || fallback; } catch(e){ return fallback; }
}

function __parseTimestampMs(v){
  if (!v) return null;
  // Date instance
  if (v instanceof Date) {
    const ms = v.getTime();
    return isNaN(ms) ? null : ms;
  }
  // Numeric epoch (ms or seconds)
  if (typeof v === "number") {
    if (!isFinite(v)) return null;
    return (v > 1e12) ? Math.floor(v) : Math.floor(v * 1000); // seconds -> ms
  }
  let s = String(v).trim();
  if (!s) return null;

  // Normalize: "YYYY-MM-DD HH:MM:SS(.ffffff)(+00)" -> ISO-ish
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) {
    s = s.replace(" ", "T");
  }

  // Normalize timezone like +00 or -03 to +00:00 / -03:00
  s = s.replace(/([+-]\d{2})(?!:?\d{2})$/, "$1:00");

  // If has fractional seconds longer than 3 digits, truncate to 3 for Safari compatibility
  s = s.replace(/(\.\d{3})\d+/, "$1");

  // If no timezone info, assume UTC (Supabase timestamps are UTC by default)
  if (!/[zZ]$/.test(s) && !/[+-]\d{2}:\d{2}$/.test(s)) {
    s = s + "Z";
  }

  const ms = Date.parse(s);
  return isNaN(ms) ? null : ms;
}

function _timeAgoI18n(dateString) {
  const ms = __parseTimestampMs(dateString);
  if (ms == null) return "";

  const now = Date.now();
  let seconds = Math.floor((now - ms) / 1000);

  // If the parsed time is slightly "in the future" due to timezone parsing quirks, clamp small negatives.
  if (seconds < 0 && seconds > -120) seconds = 0;

  const d = new Date(ms);

  const lang = (typeof __normLangCode === "function")
    ? __normLangCode(currentLang)
    : String(currentLang || "en").slice(0,2).toLowerCase();

  const isTR = (lang === "tr");
  const isES = (lang === "es");

  const fmt = (n, sEn, sTr, sEs) => {
    if (isTR) return `${n} ${sTr}`;
    if (isES) return `hace ${n} ${sEs}`;
    return `${n} ${sEn}`;
  };

  if (seconds < 60) return isTR ? "az Ã¶nce" : (isES ? "ahora mismo" : "just now");

  let interval = Math.floor(seconds / 60);
  if (interval < 60) return fmt(interval, "min ago", "dk Ã¶nce", "min");

  interval = Math.floor(seconds / 3600);
  if (interval < 24) return fmt(interval, "hours ago", "saat Ã¶nce", "h");

  interval = Math.floor(seconds / 86400);
  if (interval < 7) return fmt(interval, "days ago", "gÃ¼n Ã¶nce", "dÃ­as");

  return d.toLocaleDateString(
    isTR ? "tr-TR" : (isES ? "es-ES" : "en-US"),
    { year:"numeric", month:"short", day:"2-digit" }
  );
}

// Alias kept for backwards compatibility
function _timeAgo(dateString){ return _timeAgoI18n(dateString); }


function _safeText(s) { return (s == null) ? "" : String(s); }

function _pickEntityTitle(entity) {
  if (!entity) return "â€”";
  // Assets use `type` as the main label in this codebase.
  // Keep broad fallbacks to be resilient to older/newer schema variants.
  return (
    entity.title ||
    entity.name ||
    entity.type ||
    entity.item_name ||
    entity.item ||
    entity.asset_name ||
    entity.asset_title ||
    entity.project_name ||
    entity.project_title ||
    entity.certificate_name ||
    entity.cert_name ||
    entity.cert_title ||
    "â€”"
  );
}

function _getAreaList(area) {
  const c = (__postCompany || selectedCompany);
  if (!c) return [];
  if (area === "projects") return Array.isArray(c.projects) ? c.projects : [];
  if (area === "assets") return Array.isArray(c.assets) ? c.assets : [];
  if (area === "certificates") return Array.isArray(c.certificates) ? c.certificates : [];
  return [];
}

function _getAreaTab(area) {
  if (area === "projects") return "projects";
  if (area === "assets") return "assets";
  if (area === "certificates") return "certs";
  return "overview";
}

// --- Deep link helpers (route params + focus scroll) ---
function _btonDomSafeId(v){
  try{
    return String(v ?? "").replace(/[^a-zA-Z0-9_-]/g, "_");
  }catch(e){ return ""; }
}
function _btonEntityDomId(prefix, id){
  const s = _btonDomSafeId(id);
  return s ? `${prefix}-${s}` : "";
}
function focusProfileEntity(tab, entityId){
  try{
    const t = String(tab || "overview").toLowerCase();
    const id = (entityId == null) ? "" : String(entityId).trim();
    if (!id) return;

    // Ensure tab is visible first
    try { if (typeof switchProfileTab === 'function') switchProfileTab(t); } catch(e) {}

    let domId = "";
    if (t === 'projects') domId = _btonEntityDomId('project', id);
    else if (t === 'assets') domId = _btonEntityDomId('asset', id);
    else if (t === 'certs') domId = _btonEntityDomId('cert', id);
    if (!domId) return;

    const el = document.getElementById(domId);
    if (!el) return;

    try{ el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(e){ try{ el.scrollIntoView(true); }catch(_){} }

    // Premium focus flash (temporary)
    try{
      el.classList.remove('bton-focus-flash');
      // force reflow so animation restarts
      void el.offsetWidth;
      el.classList.add('bton-focus-flash');
      setTimeout(() => { try{ el.classList.remove('bton-focus-flash'); }catch(_){} }, 1400);
    }catch(e){}
  }catch(e){}
}

function _templateLabel(area, code) {
  const c = String(code || "").toLowerCase();
  const lang = (typeof __normLangCode === "function") ? __normLangCode(currentLang) : String(currentLang || "en").slice(0,2).toLowerCase();

  // Generic / global labels (used by "General" and by the new update type selector)
  if (c === "info") return (lang === "tr") ? "Bilgi" : (lang === "es" ? "InformaciÃ³n" : "Info");
  if (c === "progress") return (lang === "tr") ? "Ä°lerleme" : (lang === "es" ? "Progreso" : "Progress");
  if (c === "completed") return (lang === "tr") ? "TamamlandÄ±" : (lang === "es" ? "Completado" : "Completed");
  if (c === "attention") return (lang === "tr") ? "Dikkat" : (lang === "es" ? "AtenciÃ³n" : "Attention");

  const arr = HOME_UPDATE_TEMPLATES[area] || [];
  const trow = arr.find(x => String(x.code || "").toLowerCase() === c);
  if (!trow) return code || "";
  if (lang === "tr") return trow.tr || trow.en || "";
  if (lang === "es") return trow.es || trow.en || "";
  return trow.en || "";
}


function _signalMeta(area, code) {
  const c = String(code || "").toLowerCase();

  // Keep tones simple and consistent across UI
  const PROGRESS = new Set(["progress","kickoff","phase_started","milestone","added","renewed"]);
  const COMPLETED = new Set(["completed","done","finished"]);
  const ATTENTION = new Set(["attention","maintenance","inspection","audit"]);

  let tone = "info";
  if (COMPLETED.has(c)) tone = "completed";
  else if (PROGRESS.has(c)) tone = "progress";
  else if (ATTENTION.has(c)) tone = "attention";

  // Premium, consistent "signal" styling (pill + left bar)
  if (tone === "completed") {
    return {
      tone,
      icon: "fa-circle-check",
      iconWrap: "bg-white/75 border border-emerald-200/70 text-emerald-700 shadow-[inset_0_1px_0_rgba(255,255,255,0.85)]",
      pill: "bg-emerald-50/40 border-emerald-200/60 text-slate-800",
      bar: "bg-emerald-500/45",
      glow: "shadow-[0_0_0_1px_rgba(16,185,129,0.08)]"
    };
  }

  if (tone === "progress") {
    return {
      tone,
      icon: "fa-arrow-trend-up",
      iconWrap: "bg-white/75 border border-blue-200/70 text-blue-700 shadow-[inset_0_1px_0_rgba(255,255,255,0.85)]",
      pill: "bg-blue-50/40 border-blue-200/60 text-slate-800",
      bar: "bg-blue-500/40",
      glow: "shadow-[0_0_0_1px_rgba(59,130,246,0.08)]"
    };
  }

  if (tone === "attention") {
    return {
      tone,
      icon: "fa-triangle-exclamation",
      iconWrap: "bg-white/75 border border-amber-200/70 text-amber-700 shadow-[inset_0_1px_0_rgba(255,255,255,0.85)]",
      pill: "bg-amber-50/40 border-amber-200/60 text-slate-800",
      bar: "bg-amber-500/45",
      glow: "shadow-[0_0_0_1px_rgba(245,158,11,0.08)]"
    };
  }

  return {
    tone,
    icon: "fa-circle-info",
    iconWrap: "bg-white/75 border border-cyan-200/70 text-cyan-700 shadow-[inset_0_1px_0_rgba(255,255,255,0.85)]",
    pill: "bg-slate-50/70 border-slate-200/70 text-slate-800",
    bar: "bg-slate-300/70",
    glow: "shadow-[0_0_0_1px_rgba(15,23,42,0.06)]"
  };
}


function _updateHomeUpdatesActiveCount(list) {
  const wrap = document.getElementById("home-updates-active-wrap");
  const el = document.getElementById("home-updates-active-count");
  if (!el) return;
  const ids = new Set((Array.isArray(list) ? list : [])
    .map(x => x.company_id || x.profile_id || x.companyId || "")
    .filter(Boolean)
    .map(String));
  el.textContent = String(ids.size);
  if (wrap) {
    if (ids.size > 0) wrap.classList.remove("hidden");
    else wrap.classList.add("hidden");
  }
}

function renderHomeUpdatesSkeleton(count = 6) {
  const wrap = document.getElementById("home-updates");
  const empty = document.getElementById("home-updates-empty");
  if (!wrap || !empty) return;

  empty.classList.add("hidden");

  const cards = Array.from({ length: count }).map(() => `
    <div class="bton-upd-card snap-start min-w-[320px] sm:min-w-[360px] md:min-w-[420px] bg-white/70 backdrop-blur-xl border border-[rgba(15,23,42,.08)] rounded-2xl px-4 py-4 shadow-[0_10px_30px_-18px_rgba(15,23,42,.35)] overflow-hidden">
      <div class="animate-pulse">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-gray-100"></div>
          <div class="flex-1">
            <div class="h-3 w-40 bg-gray-100 rounded"></div>
            <div class="mt-2 h-3 w-56 bg-gray-100 rounded"></div>
            <div class="mt-3 h-6 w-44 bg-gray-100 rounded-lg"></div>
            <div class="mt-2 h-10 w-full bg-gray-100 rounded-lg"></div>
          </div>
        </div>
      </div>
    </div>
  `).join("");

  wrap.innerHTML = cards;
}


function _isProForPosting(company=null) {
  // âœ… Strict client-side gate (server/RLS should still enforce separately)
  // Only allow if THIS user's company is actively Pro (trial active or paid).
  const c = company || __postCompany;
  if (!c || !c.id) return false;

  const tier = String(c.subscription_tier || "free").toLowerCase();
  const status = String(c.subscription_status || "").toLowerCase();
  const now = nowDate();

  if (tier !== "pro") return false;

  // Paid pro
  if (status === "active_paid") return true;

  // Active trial must be unexpired
  if (status === "active_trial") {
    const until = c.trial_end_date || c.pro_until || c.subscription_end_at;
    if (!until) return false;
    const d = new Date(until);
    return !isNaN(d.getTime()) && d > now;
  }

  // Anything else: not allowed
  return false;
}



async function _ensureSelectedCompanyForPosting() {
  try {
    // If we already have a selected company with tier info, keep it.
    if (selectedCompany && (selectedCompany.subscription_tier || selectedCompany.is_pro != null)) return selectedCompany;

    // Must be signed-in to resolve "my" company
    const user = await _getAuthUserSafe();
    if (!user) return null;

    const stored = (typeof getMyCompanyId === "function")
      ? getMyCompanyId()
      : (function(){ try { return localStorage.getItem("BTrustOn_my_company_id"); } catch(e){ return null; } })();

    const myId = (stored && (typeof isUuid === "function") && isUuid(stored)) ? stored : user.id;

    // Try in-memory cache if exists
    try {
      if (typeof companiesData !== "undefined" && Array.isArray(companiesData)) {
        const hit = companiesData.find(x => String(x.id) === String(myId));
        if (hit) { selectedCompany = hit; return hit; }
      }
    } catch(e) {}

    // Fetch from DB
    const { data, error } = await supabaseClient
      .from("profiles")
      .select("*")
      .eq("id", myId)
      .single();

    if (!error && data) {
      selectedCompany = data;
      return data;
    }
    return null;
  } catch (e) {
    console.warn("ensureSelectedCompanyForPosting failed:", e);
    return null;
  }
}

async function _fetchMyCompanyProfile(userId) {
  if (!userId) return null;
  try {
    // âœ… Preferred: profiles are linked to auth via owner_user_id (claim flow + directory seed)
    // IMPORTANT: a user may have a legacy self-profile row (id = auth uid) PLUS a claimed company row.
    // We prefer a company row (id != auth uid) if it exists.

    // 1) Prefer non-self owned profile
    let { data, error } = await supabaseClient
      .from("profiles")
      .select("*")
      .eq("owner_user_id", userId)
      .neq("id", userId)
      .order("claimed_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    // 2) Otherwise fallback to any owned profile
    if ((error || !data)) {
      const res2 = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("owner_user_id", userId)
        .order("claimed_at", { ascending: false })
        .limit(1)
        .maybeSingle();
      data = res2.data;
      error = res2.error;
    }

    // 3) Fallback: legacy schema (profiles.id = auth uid)
    if ((error || !data)) {
      const res = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("id", userId)
        .maybeSingle();
      data = res.data;
      error = res.error;
    }

    // 4) Fallback: very old schemas (profiles.user_id = auth uid)
    if ((error || !data) && typeof userId === "string") {
      const fb = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("user_id", userId)
        .maybeSingle();
      data = fb.data;
      error = fb.error;
    }

    return data || null;
  } catch (e) {
    return null;
  }
}


async function refreshHomeUpdatesCTA() {
  const btn = document.getElementById("btn-open-post-update");
  const hint = document.getElementById("home-updates-prohint");
  if (!btn) return;

  const user = await _getAuthUserSafe();

  if (!user) {
    __postCompany = null;
    if (hint) hint.classList.add("hidden");
    const sp = btn.querySelector("span");
    if (sp) {
      sp.setAttribute("data-i18n", "btn_post_update");
      sp.textContent = _i18n("btn_post_update", "POST UPDATE");
    }
    return;
  }

  // Load my company snapshot for correct Pro gate + lists (don't depend on selectedCompany)
  __postCompany = await _fetchMyCompanyProfile(user.id);
  if (__postCompany && typeof enforceProLifecycle === "function") {
    __postCompany = await enforceProLifecycle(__postCompany);
  }
  if (!__postCompany) {
    __postCompany = null;
  }

  const sp = btn.querySelector("span");
  if (_isProForPosting()) {
    if (hint) hint.classList.add("hidden");
    if (sp) {
      sp.setAttribute("data-i18n", "btn_post_update");
      sp.textContent = _i18n("btn_post_update", "POST UPDATE");
    }
  } else {
    if (sp) {
      sp.setAttribute("data-i18n", "btn_upgrade_to_post");
      sp.textContent = _i18n("btn_upgrade_to_post", "UPGRADE TO POST");
    }
    if (hint) hint.classList.remove("hidden");
  }
}


function startHomeUpdatesAutoScroll() {
  const rail = document.getElementById("home-updates");
  if (!rail) return;

  // Respect reduced motion (keep auto-flow, just slower)
  let __homeUpdatesReducedMotion = false;
  try {
    const prm = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)");
    __homeUpdatesReducedMotion = !!(prm && prm.matches);
  } catch (e) { __homeUpdatesReducedMotion = false; }

  const setAutoMode = (on) => {
    try { rail.classList.toggle("bton-updates-autoflow", !!on); } catch(e) {}
  };

  // Avoid double-bind
  if (!rail.__btonAutoBound) {
    rail.__btonAutoBound = true;

    // Hover / touch pause
    rail.addEventListener("mouseenter", () => { __homeUpdatesPause = true; setAutoMode(false); }, { passive: true });
    rail.addEventListener("mouseleave", () => {
      __homeUpdatesPause = false;
      __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 900);
      setAutoMode(false);
    }, { passive: true });

    rail.addEventListener("pointerdown", () => {
      __homeUpdatesPause = true;
      __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 2200);
      setAutoMode(false);
    }, { passive: true });

    const onPointerUp = () => {
      __homeUpdatesPause = false;
      __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 3200);
      setAutoMode(false);
    };
    rail.addEventListener("pointerup", onPointerUp, { passive: true });
    rail.addEventListener("pointercancel", onPointerUp, { passive: true });

    // Wheel/touch scrolling: pause auto for a bit
    rail.addEventListener("wheel", () => {
      __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 3800);
      setAutoMode(false);
    }, { passive: true });

    rail.addEventListener("scroll", () => {
      // Ignore scroll events caused by our own auto-flow (some browsers dispatch scroll async)
      if (Date.now() < (__homeUpdatesIgnoreScrollUntil || 0)) return;

      __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 4200);
      setAutoMode(false);

      // sync auto position with user scroll
      try { __homeUpdatesAutoPos = Number(rail.scrollLeft || 0) || 0; } catch(e) {}
      if (__homeUpdatesUserScrollingT) clearTimeout(__homeUpdatesUserScrollingT);
      __homeUpdatesUserScrollingT = setTimeout(() => { __homeUpdatesUserScrollingT = null; }, 350);
    }, { passive: true });
  }

  // Restart RAF loop
  try { if (__homeUpdatesRAF) cancelAnimationFrame(__homeUpdatesRAF); } catch (e) {}
  __homeUpdatesRAF = null;
  __homeUpdatesLastTs = 0;

  // Premium speed: slow but visible
  try {
    const w = window.innerWidth || 1024;
    __homeUpdatesSpeedPx = __homeUpdatesReducedMotion
      ? ((w < 420) ? 18 : (w < 640) ? 20 : (w < 900) ? 22 : (w < 1200) ? 24 : 26)
      : ((w < 420) ? 32 : (w < 640) ? 34 : (w < 900) ? 36 : (w < 1200) ? 38 : 40);
    // px/sec: premium drift (reduced motion -> slower)
  } catch(e) {}


  // Keep a float position so tiny per-frame deltas still move (some browsers round scrollLeft)
  try { __homeUpdatesAutoPos = Number(rail.scrollLeft || 0) || 0; } catch(e) { __homeUpdatesAutoPos = 0; }

  const tick = (ts) => {
    __homeUpdatesRAF = requestAnimationFrame(tick);

    const canAuto = !document.hidden && !__homeUpdatesPause && (Date.now() >= (__homeUpdatesHoldUntil || 0));
    setAutoMode(canAuto);
    if (!canAuto) return;

    const loopW = (__homeUpdatesLoopWidth && __homeUpdatesLoopWidth > 0)
      ? __homeUpdatesLoopWidth
      : Math.max(0, Math.floor((rail.scrollWidth || 0) / 2));

    if (loopW <= 10) return;

    const last = __homeUpdatesLastTs || ts;
    let dt = ts - last;
    __homeUpdatesLastTs = ts;
    if (dt < 0) dt = 0;
    if (dt > 60) dt = 60; // clamp

    const px = (__homeUpdatesSpeedPx || 22) * (dt / 1000);
    if (!px) return;

    // Move (use float position for consistent motion)
    __homeUpdatesAutoPos += px;

    // Wrap seamlessly inside the first cycle
    if (__homeUpdatesAutoPos >= loopW) __homeUpdatesAutoPos -= loopW;

    // Prevent our own scroll events from pausing auto-flow
    __homeUpdatesIgnoreScrollUntil = Date.now() + 220;

    rail.scrollLeft = __homeUpdatesAutoPos;
  };

  __homeUpdatesRAF = requestAnimationFrame(tick);
}


function setupHomeUpdatesNav() {
  const rail = document.getElementById("home-updates");
  const btnL = document.getElementById("home-updates-left");
  const btnR = document.getElementById("home-updates-right");
  if (!rail || !btnL || !btnR) return;

  // Avoid double-bind
  if (rail.__btonNavBound) return;
  rail.__btonNavBound = true;

  const step = () => Math.min(Math.max(rail.clientWidth * 0.88, 360), 620);

  const nudge = (delta) => {
    __homeUpdatesHoldUntil = Math.max(__homeUpdatesHoldUntil, Date.now() + 2600);

    const loopW = (__homeUpdatesLoopWidth && __homeUpdatesLoopWidth > 0)
      ? __homeUpdatesLoopWidth
      : Math.max(0, rail.scrollWidth - rail.clientWidth);

    if (loopW > 6) {
      // If going left beyond 0, jump one cycle forward so smooth scroll works
      if (delta < 0 && (rail.scrollLeft + delta) < 0) {
        rail.scrollLeft += loopW;
      }
    }

    try { rail.scrollBy({ left: delta, behavior: "smooth" }); } catch(e) { rail.scrollLeft += delta; }

    // Normalize back into the first cycle after the smooth scroll settles
    if (loopW > 6) {
      setTimeout(() => {
        try {
          if (rail.scrollLeft >= loopW) rail.scrollLeft -= loopW;
          if (rail.scrollLeft < 0) rail.scrollLeft += loopW;
          // sync auto position after user nudge
          __homeUpdatesAutoPos = Number(rail.scrollLeft || 0) || 0;
        } catch(e) {}
      }, 420);
    }
  };

  btnL.addEventListener("click", () => nudge(-step()));
  btnR.addEventListener("click", () => nudge(step()));

  const sync = () => {
    const overflow = rail.scrollWidth > (rail.clientWidth + 10);
    const show = overflow;
    btnL.style.display = show ? "" : "none";
    btnR.style.display = show ? "" : "none";
    // Infinite loop behavior: don't disable arrows
    btnL.disabled = false;
    btnR.disabled = false;
  };

  rail.addEventListener("scroll", () => requestAnimationFrame(sync), { passive: true });
  window.addEventListener("resize", () => requestAnimationFrame(sync), { passive: true });

  setTimeout(() => requestAnimationFrame(sync), 350);
  setTimeout(() => requestAnimationFrame(sync), 1200);
}


function renderHomeUpdates(list) {
  const wrap = document.getElementById("home-updates");
  const empty = document.getElementById("home-updates-empty");
  if (!wrap || !empty) return;

  const updates = Array.isArray(list) ? list : [];
  if (updates.length === 0) {
    wrap.innerHTML = "";
    empty.classList.remove("hidden");
    _updateHomeUpdatesActiveCount([]);
    return;
  }

  empty.classList.add("hidden");

    // Build base HTML once
  __homeUpdatesBaseHTML = updates.map(u => {
    const meta = _resolveUpdateCompanyMeta(u);
    const companyName = _safeText(meta.name || (u.company_name || u.company_title || "Company"));
    const letter = (String(companyName || "C").trim().charAt(0) || "C").toUpperCase();
    const logo = (meta.logo || "");
    const area = u.area || u.entity_area || "projects";
    const areaLower = String(area || "").toLowerCase();
    const entityTitle = (areaLower === "general")
      ? (t("post_area_general") || (currentLang === "tr" ? "Genel" : "General"))
      : _safeText(u.entity_title || u.item_title || "â€”");
    const templateCode = u.template_code || u.update_code || "";
    const label = _templateLabel(area, templateCode) || _safeText(u.template_label || "");
    const noteRaw = String(u.note || u.message || "");
    const notePlain = noteRaw.replace(/\s+/g, " ").trim();
    const hasNote = notePlain.length > 0;
    const noteIsLong = notePlain.length > 160;
    const notePreview = _safeText(noteIsLong ? (notePlain.slice(0, 160).trimEnd() + "â€¦") : notePlain);
    const createdAt = u.created_at || u.createdAt;
    const age = createdAt ? _timeAgoI18n(createdAt) : "";
    const verified = !!(meta.verified || u.is_verified || u.verified || u.blue_tick);

    const icon = (area === "general")
      ? "fa-bullhorn text-slate-500"
      : (area === "projects")
        ? "fa-diagram-project text-cyan-500"
        : (area === "assets")
          ? "fa-boxes-stacked text-emerald-500"
          : "fa-certificate text-amber-500";

    const tab = _getAreaTab(area);
    const safeCompanyId = _safeText(u.company_id || u.profile_id || "");
    const followed = (__authUserId && safeCompanyId) ? _isCompanyFollowed(safeCompanyId) : false;

    const focusId = (u.entity_id == null) ? "" : String(u.entity_id);
    const safeFocusId = _safeText(focusId);

    return `
      <button onclick="openProfile('${safeCompanyId}', { tab: '${tab}', focus: '${safeFocusId}', preserveScroll: true })"
        class="bton-upd-card group relative snap-start min-w-[320px] sm:min-w-[360px] md:min-w-[420px] text-left bg-white/70 backdrop-blur-xl border border-[rgba(15,23,42,.08)] hover:border-[rgba(15,23,42,.14)] px-4 py-4 shadow-[0_10px_30px_-18px_rgba(15,23,42,.35)] hover:shadow-[0_20px_45px_-25px_rgba(15,23,42,.45)] hover:-translate-y-0.5 transition-all overflow-hidden">

        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition pointer-events-none bg-gradient-to-br from-white via-white to-slate-50/70"></div>
        <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full bg-slate-200/50 blur-2xl pointer-events-none"></div>
        <div class="absolute left-0 top-0 bottom-0 w-[3px] rounded-full bton-upd-bar ${_signalMeta(area, templateCode).bar}"></div>

        <div class="relative flex items-start gap-3">
          <div class="w-10 h-10 rounded-2xl bg-white/80 backdrop-blur border border-slate-200/70 ring-1 ring-white/60 shadow-sm overflow-hidden shrink-0 grid place-items-center">
            ${logo ? `
              <img src="${logo}" class="w-full h-full object-cover" alt="logo" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                onerror="this.classList.add('hidden'); if(this.nextElementSibling) this.nextElementSibling.classList.remove('hidden');">
              <span class="text-sm font-extrabold text-slate-500 hidden">${letter}</span>
            ` : `<span class="text-sm font-extrabold text-slate-500">${letter}</span>`}
          </div>

          <div class="min-w-0 flex-1 flex flex-col">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="text-sm font-extrabold text-BTrustOn-primary truncate">${companyName}</div>
                  ${verified ? `<span class="bton-tip" data-tip="${escapeHtml(_verifiedTipText())}"><i class="fa-solid fa-circle-check text-cyan-500 text-sm"></i></span>` : ``}
                </div>

                <div class="mt-0.5 flex items-center gap-2 text-[11px] text-gray-500 min-w-0">
                  <i class="fa-solid ${icon}"></i>
                  <span class="truncate font-bold">${entityTitle}</span>
                </div>
              </div>

              <div class="flex items-center gap-2 shrink-0 mt-0.5">
                <div class="text-[10px] text-slate-500 font-extrabold whitespace-nowrap bg-white/70 border border-slate-200/70 rounded-full px-2 py-0.5 shadow-sm">${age}</div>
              </div>
            </div>

                        <div class="mt-2 flex items-center gap-2 flex-nowrap overflow-hidden">
              ${(() => {
                const s = _signalMeta(area, templateCode);
                const lbl = _safeText(label || ((currentLang === "tr") ? "Bilgi" : "Info"));
                return `
                  <span class="inline-flex items-center gap-2 text-[10px] font-extrabold tracking-wide px-2.5 py-1 rounded-full border ${s.pill} shadow-sm ring-1 ring-white/60 ${s.glow}">
                    <span class="inline-flex items-center justify-center w-5 h-5 rounded-full ${s.iconWrap}">
                      <i class="fa-solid ${s.icon} text-[10px]"></i>
                    </span>
                    <span class="truncate">${lbl}</span>
                  </span>
                `;
              })()}
            </div><div class="mt-3 relative bton-upd-note bg-white/85 border border-[rgba(15,23,42,.10)] rounded-2xl p-3 h-[86px] overflow-hidden shadow-[inset_0_1px_0_rgba(255,255,255,0.85)]">
              ${hasNote ? `<div class="text-xs text-gray-600 leading-snug break-words clamp-4">${notePreview}</div>` : `<div class="text-xs text-gray-300 italic">&nbsp;</div>`}
              ${noteIsLong ? `<div class="absolute inset-x-0 bottom-0 h-7 bg-gradient-to-t from-slate-50 via-slate-50/80 to-transparent pointer-events-none"></div>
                <div class="absolute bottom-1 right-2 text-[10px] font-extrabold text-cyan-700 pointer-events-none">${(currentLang==="tr") ? "DevamÄ± profilde" : "More in profile"}</div>` : ``}
            </div>

            <div class="mt-auto pt-2 flex items-center justify-end"><span class="inline-flex items-center gap-1 text-[11px] font-extrabold text-cyan-700 opacity-0 translate-x-1 group-hover:opacity-100 group-hover:translate-x-0 transition">
                ${(currentLang === "tr") ? "GÃ¶rÃ¼ntÃ¼le" : "View"} <i class="fa-solid fa-arrow-right text-[10px]"></i>
              </span></div>
          </div>
        </div>
      </button>
    `;
  }).join("");

  // Render base once
  wrap.innerHTML = __homeUpdatesBaseHTML;

  // âœ… Continuous flow + arrow nav: build a "cycle" long enough to overflow, then duplicate once for a seamless loop
  requestAnimationFrame(() => {
    const cw = wrap.clientWidth || 0;

    // If there are very few updates, repeat them inside the 1st cycle until it overflows (so it can actually "flow")
    let safety = 0;
    while (__homeUpdatesBaseHTML && wrap.scrollWidth <= (cw + 40) && safety < 10) {
      wrap.insertAdjacentHTML("beforeend", __homeUpdatesBaseHTML);
      safety++;
    }

    __homeUpdatesLoopHTML = wrap.innerHTML;

    // Add 1 more full cycle for seamless wrap-around
    if (__homeUpdatesLoopHTML) {
      wrap.insertAdjacentHTML("beforeend", __homeUpdatesLoopHTML);
    }

    // Loop width = width of a single cycle (half of total after duplication)
    __homeUpdatesLoopWidth = Math.max(0, Math.floor((wrap.scrollWidth || 0) / 2));

    // Start immediately (ignore initial programmatic scroll events)
    __homeUpdatesHoldUntil = 0;
    __homeUpdatesIgnoreScrollUntil = Date.now() + 900;

    wrap.scrollLeft = 0;
    try { __homeUpdatesAutoPos = 0; } catch(e) {}

    // Apply translations after final DOM is built
    try { applyTranslationsWithin(wrap); } catch(e) {}
    try { const dot = document.getElementById("home-updates-dot"); if (dot) applyTranslationsWithin(dot); } catch(e) {}

    startHomeUpdatesAutoScroll();
  });
}

function _setHomeUpdatesFilterUI(mode) {
  const allBtn = document.getElementById("upd-filter-all");
  const folBtn = document.getElementById("upd-filter-followed");
  if (!allBtn || !folBtn) return;

  const onCls = "bg-BTrustOn-primary text-white shadow";
  const offCls = "text-gray-600 hover:bg-gray-50";

  if (mode === "followed") {
    folBtn.classList.add(...onCls.split(" "));
    folBtn.classList.remove(...offCls.split(" "));
    allBtn.classList.remove(...onCls.split(" "));
    allBtn.classList.add(...offCls.split(" "));
  } else {
    allBtn.classList.add(...onCls.split(" "));
    allBtn.classList.remove(...offCls.split(" "));
    folBtn.classList.remove(...onCls.split(" "));
    folBtn.classList.add(...offCls.split(" "));
  }
}

async function _ensureHomeFollowSet(uid) {
  if (!uid) return;
  if (homeFollowLoadedFor === uid && homeFollowSet && typeof homeFollowSet.has === "function") return;

  homeFollowSet = new Set();
  homeFollowLoadedFor = uid;

  try {
    const { data, error } = await supabaseClient
      .from("company_follows")
      .select("company_id")
      .eq("follower_user_id", uid)
      .limit(500);

    if (error) {
      console.warn("Follow list fetch error:", error);
      return;
    }
    (data || []).forEach(r => {
      if (r?.company_id) {
        const __cid = String(r.company_id);
        homeFollowSet.add(__cid);
        try { _btonEnsureFollowStart(__cid); } catch(e) {}
      }
    });
  } catch (e) {
    console.warn("Follow list fetch failed:", e);
  }
}


function _isCompanyFollowed(companyId) {
  if (!companyId) return false;
  try { return homeFollowSet.has(String(companyId)); } catch { return false; }
}

function _resolveUpdateCompanyMeta(u){
  try {
    const row = u || {};
    const cid = String(row.company_id || row.profile_id || row.companyId || "").trim();

    const pickLogo = (o) => (o && (o.company_logo_url || o.logo_url || o.logoUrl || o.logo || o.company_logo || o.avatar_url || o.avatarUrl || o.photo_url || o.photoUrl || "")) || "";
    const pickName = (o) => (o && (o.company_name || o.company_title || o.name || o.legal_name || o.legalName || "")) || "";
    const pickVerified = (o) => !!(o && (o.is_verified || o.verified || o.blue_tick || (String(o.verification_status||"").toLowerCase()==="approved") || (String(o.verification_status||"").toLowerCase()==="verified")));

    const fromRow = {
      name: pickName(row),
      logo: pickLogo(row),
      verified: pickVerified(row),
    };

    // Supabase join shapes (optional)
    const joined = row.profiles || row.profile || row.company || row.companies || null;
    const fromJoin = joined ? { name: pickName(joined), logo: pickLogo(joined), verified: pickVerified(joined) } : { name:"", logo:"", verified:false };

    // In-memory cache (Discover list / database)
    let fromCache = { name:"", logo:"", verified:false };
    const __tryCache = (arr) => {
      if (!cid || !Array.isArray(arr)) return false;
      const hit = arr.find(x => String(x?.id) === cid);
      if (!hit) return false;
      fromCache = { name: pickName(hit), logo: pickLogo(hit), verified: pickVerified(hit) };
      return true;
    };
    try {
      if (!__tryCache((typeof companiesData !== "undefined") ? companiesData : null)) {
        __tryCache((typeof database !== "undefined") ? database : null);
      }
    } catch(e){}

    const name = (fromCache.name || fromJoin.name || fromRow.name || "").trim();
    const logo = (fromCache.logo || fromJoin.logo || fromRow.logo || "").trim();
    const verified = !!(fromCache.verified || fromJoin.verified || fromRow.verified);

    return { name, logo, verified };
  } catch(e){
    return { name: "", logo: "", verified: false };
  }
}

function setHomeUpdatesFilter(mode) {
  homeUpdatesFilter = (mode === "followed") ? "followed" : "all";
  _setHomeUpdatesFilterUI(homeUpdatesFilter);
  fetchHomeUpdates();
}

function _homeUpdatesSetEmptyText(type) {
  const empty = document.getElementById("home-updates-empty");
  if (!empty) return;

  // Keep the structured empty card (title + description). Do NOT overwrite container textContent.
  const titleEl = empty.querySelector('[data-i18n="updates_empty_title"]') || empty.querySelector(".bton-empty-title");
  let descSpan =
    empty.querySelector('[data-i18n="updates_empty"]') ||
    empty.querySelector('[data-i18n="updates_no_followed"]') ||
    empty.querySelector(".bton-empty-desc span") ||
    null;

  // If the desc span is missing (unexpected DOM), fall back to the first desc container.
  if (!descSpan) {
    const descWrap = empty.querySelector(".bton-empty-desc");
    if (descWrap) descSpan = descWrap;
  }

  // Title (static): No company updates in 7 days
  if (titleEl) {
    const titleFallback = (currentLang === "tr")
      ? "Son 7 gÃ¼nde ÅŸirket gÃ¼ncellemesi yok."
      : (currentLang === "es"
        ? "No hay actualizaciones de empresas en los Ãºltimos 7 dÃ­as."
        : "No company updates in the last 7 days.");
    titleEl.setAttribute("data-i18n", "updates_empty_title");
    titleEl.textContent = _i18n("updates_empty_title", titleFallback);
  }

  if (!descSpan) return;

  if (type === "no_followed") {
    const fb = (currentLang === "tr")
      ? "GÃ¼ncellemeleri burada gÃ¶rmek iÃ§in ÅŸirketleri takip edin."
      : (currentLang === "es"
        ? "Sigue a empresas para ver sus actualizaciones aquÃ­."
        : "Follow companies to see their updates here.");
    if (descSpan.setAttribute) descSpan.setAttribute("data-i18n", "updates_no_followed");
    descSpan.textContent = _i18n("updates_no_followed", fb);
  } else {
    const fb = (currentLang === "tr")
      ? "Åžirketler son 7 gÃ¼nde paylaÅŸÄ±m yapmadÄ±."
      : (currentLang === "es"
        ? "Ninguna empresa ha publicado actualizaciones en los Ãºltimos 7 dÃ­as."
        : "No company updates posted in the last 7 days.");
    if (descSpan.setAttribute) descSpan.setAttribute("data-i18n", "updates_empty");
    descSpan.textContent = _i18n("updates_empty", fb);
  }
}




function _followErrorHint(error) {
  if (!error) return "Unknown error";
  const msg = String(error?.message || error?.details || error?.hint || error || "");
  const low = msg.toLowerCase();
  if (low.includes("company_follows") && (low.includes("does not exist") || low.includes("relation"))) {
    return (currentLang === "tr")
      ? "company_follows tablosu bulunamadÄ±. LÃ¼tfen Supabase SQL Editor'da tablo + RLS politikalarÄ±nÄ± oluÅŸtur."
      : "company_follows table not found. Please create the table + RLS policies in Supabase SQL Editor.";
  }
  if (low.includes("permission") || low.includes("rls") || low.includes("not allowed")) {
    return (currentLang === "tr")
      ? "Ä°zin hatasÄ± (RLS). company_follows iÃ§in RLS policy'lerini eklemelisin."
      : "Permission error (RLS). Please add RLS policies for company_follows.";
  }
  if (low.includes("invalid input syntax for type uuid") || low.includes("violates not-null")) {
    return (currentLang === "tr")
      ? "GeÃ§ersiz company id. SayfayÄ± yenileyip tekrar dene."
      : "Invalid company id. Please refresh and try again.";
  }
  const code = error?.code ? ` (${error.code})` : "";
  return msg + code;
}

function _looksLikeUuid(v) {
  const s = String(v || "").trim();
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);
}

async function toggleCompanyFollow(ev, companyId, companyName) {
  try {
    if (ev) { ev.preventDefault(); ev.stopPropagation(); }

    // Auth (robust)
    const user = await _getAuthUserSafe();
    if (!user?.id) {
      showToast(t("updates_follow") || "Follow", t("updates_signin_to_follow") || "Sign in to follow companies.", "brand");
      if (typeof openLoginModal === "function") openLoginModal();
      return;
    }
    __authUserId = user.id;

    const cid = String(companyId || (ev?.currentTarget?.getAttribute?.("data-company-id") || "")).trim();
    if (!cid) {
      showToast("Error", (currentLang === "tr") ? "Åžirket bulunamadÄ±." : "Company not found.", "error");
      return;
    }

    // Prevent following own company
    let myId = null;
    try {
      const myIdRaw = (typeof getMyCompanyId === "function") ? getMyCompanyId() : null;
      if (myIdRaw && (typeof isUuid === "function") && isUuid(myIdRaw)) myId = myIdRaw;
    } catch(e) {}
    if (myId && String(myId) === cid) {
      showToast(t("updates_follow") || "Follow", (currentLang === "tr") ? "Kendi ÅŸirketini takip edemezsin." : "You can't follow your own company.", "brand");
      return;
    }

    // Resolve snapshot fields from in-memory objects (no profiles join needed)
    let snapName = (companyName || "").trim();
    let snapLogo = "";
    let snapType = "";
    let snapVerified = false;

    try {
      const fromSelected = (typeof selectedCompany !== "undefined" && selectedCompany && String(selectedCompany.id) === cid) ? selectedCompany : null;
      const fromList = (typeof companiesData !== "undefined" && Array.isArray(companiesData))
        ? companiesData.find(x => String(x.id) === cid)
        : null;
      const c = fromSelected || fromList || null;

      if (c) {
        snapName = snapName || (c.company_name || c.name || c.legal_name || "").trim();
        snapLogo = (c.logo_url || c.company_logo_url || c.avatar_url || c.logo || c.company_logo || "") || "";
        snapType = (c.business_type || c.company_type || c.type_label || c.type || "") || "";
        snapVerified = !!(c.is_verified || c.verified || (String(c.verification_status || "").toLowerCase() === "approved"));
      }

// Try button dataset (works even if company is not in arrays)
try {
  const ds = (ev && ev.currentTarget && ev.currentTarget.dataset) ? ev.currentTarget.dataset : {};
  if (ds.companyName) snapName = snapName || String(ds.companyName || "").trim();
  if (ds.companyLogo) snapLogo = snapLogo || String(ds.companyLogo || "").trim();
  if (!snapType && (ds.companyType || ds.companyBusinessType)) snapType = String(ds.companyType || ds.companyBusinessType || "").trim();
  if (!snapVerified && ds.companyVerified) snapVerified = (String(ds.companyVerified) === "1" || String(ds.companyVerified).toLowerCase() === "true");
  if (!snapVerified && ds.verificationStatus) {
    const vs = String(ds.verificationStatus || "").toLowerCase();
    if (vs === "approved" || vs === "verified") snapVerified = true;
  }
} catch(e) {}

    } catch(e) {}

    // Last fallback to something readable
    if (!snapName) snapName = (currentLang === "tr") ? "Åžirket" : "Company";

    const isOn = _isCompanyFollowed(cid);

    if (isOn) {
      const { error } = await supabaseClient
        .from("company_follows")
        .delete()
        .eq("follower_user_id", __authUserId)
        .eq("company_id", cid);

      if (error) {
        console.warn("Unfollow error:", error);
        showToast("Error", _followErrorHint(error), "error");
        return;
      }

      if (homeFollowSet) homeFollowSet.delete(cid);
      try { _btonRemoveFollowStart(cid); } catch(e) {}
      showToast(t("updates_follow") || "Follow", `${snapName} ${(currentLang === "tr") ? "takipten Ã§Ä±karÄ±ldÄ±" : "unfollowed"}`, "brand");

      if (homeUpdatesFilter === "followed") {
        fetchHomeUpdates();
      }
    } else {
      // Store snapshot into company_follows so Following tab doesn't depend on profiles RLS

      // Best-effort: ensure verified tick is accurate (pull from profiles if allowed)
      if (!snapVerified) {
        try {
          const { data: p, error: pe } = await supabaseClient
            .from("profiles")
            .select("id, verification_status")
            .eq("id", cid)
            .maybeSingle();
          if (!pe && p && (typeof isCompanyVerified === "function")) {
            if (isCompanyVerified(p)) snapVerified = true;
          }
        } catch(e) {}
      }

      const payload = {
        follower_user_id: __authUserId,
        company_id: cid,
        company_name: snapName,
        company_logo_url: snapLogo || null,
        is_verified: !!snapVerified,
        business_type: snapType || null
      };

      const { error } = await supabaseClient
        .from("company_follows")
        .upsert([payload], { onConflict: "follower_user_id,company_id", ignoreDuplicates: true });

      if (error) {
        // If snapshot columns are not created yet, retry minimal follow
        const msg = String(error?.message || error?.details || error || "");
        const low = msg.toLowerCase();
        if (low.includes("does not exist") || low.includes("column")) {
          const { error: e2 } = await supabaseClient
            .from("company_follows")
            .upsert([{ follower_user_id: __authUserId, company_id: cid }], { onConflict: "follower_user_id,company_id", ignoreDuplicates: true });
          if (e2) {
            console.warn("Follow error (retry) :", e2);
            showToast("Error", _followErrorHint(e2), "error");
            return;
          }
          // Inform about richer list (optional)
          showToast(
            (currentLang === "tr") ? "Following" : "Following",
            (currentLang === "tr") ? "Takip eklendi. (Ä°steÄŸe baÄŸlÄ±: company_follows'a snapshot kolonlarÄ±nÄ± ekleyerek Following listesinde isim/logo gÃ¶sterebilirsin.)"
                                  : "Follow added. (Optional: add snapshot columns to company_follows to show name/logo in Following list.)",
            "brand"
          );
        } else {
          console.warn("Follow error:", error);
          showToast("Error", _followErrorHint(error), "error");
          return;
        }
      }

      if (!homeFollowSet) homeFollowSet = new Set();
      homeFollowSet.add(cid);
      try { _btonSetFollowStart(cid, new Date().toISOString()); } catch(e) {}
      showToast(t("updates_following") || "Following", `${snapName}`, "success");
    }

    // Update buttons in-place
    document.querySelectorAll(`.company-follow-btn[data-company-id="${cid}"], .upd-follow-btn[data-company-id="${cid}"]`).forEach(btn => {
      const nowOn = _isCompanyFollowed(cid);
      btn.setAttribute("aria-pressed", nowOn ? "true" : "false");
      btn.classList.toggle("is-following", nowOn);

      const icon = btn.querySelector("i");
      if (icon) {
        icon.classList.remove("fa-regular", "fa-solid");
        icon.classList.add(nowOn ? "fa-solid" : "fa-regular");
      }
      btn.setAttribute("title", nowOn ? (t("updates_following") || "Following") : (t("updates_follow") || "Follow"));
    });

    try { updateFollowButtonsUI(); } catch(e) {}

    // If Lists panel is open, refresh Following tab content/counts
    try {
      const sp = document.getElementById("saved-panel");
      if (sp && sp.classList.contains("open")) {
        await fetchFollowingCompanies();
        if (savedPanelTab === "following") renderFollowingCompanies();
      }
    } catch(e) {}
  } catch (e) {
    console.warn("toggleCompanyFollow failed:", e);
    showToast("Error", (currentLang === "tr") ? "Takip iÅŸlemi baÅŸarÄ±sÄ±z." : "Follow action failed.", "error");
  }
}




async function fetchHomeUpdates() {
  try {
    const wrap = document.getElementById("home-updates");
    const empty = document.getElementById("home-updates-empty");
    if (!wrap || !empty) return;

    // Nice first-load feel
    if (!homeUpdatesData || homeUpdatesData.length === 0) {
      renderHomeUpdatesSkeleton(6);
    }

    const now = new Date();
    const since = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    
    // Auth (for follow UI + followed filter)
    const user = await _getAuthUserSafe();
    __authUserId = user?.id || null;
    if (__authUserId) await _ensureHomeFollowSet(__authUserId);

    let followedIds = null;

    if (homeUpdatesFilter === "followed") {
      if (!__authUserId) {
        showToast(t("updates_signin_to_filter") || "Sign in to see only followed updates.", "info");
        homeUpdatesFilter = "all";
        _setHomeUpdatesFilterUI(homeUpdatesFilter);
      } else {
        followedIds = Array.from(homeFollowSet || []);
        if (!followedIds || followedIds.length === 0) {
          homeUpdatesData = [];
          _homeUpdatesSetEmptyText("no_followed");
          renderHomeUpdates([]);
          const dot = document.getElementById("home-updates-dot");
          if (dot) dot.classList.add("hidden");
          return;
        }
      }
    }

    _homeUpdatesSetEmptyText("default");

    let q = supabaseClient
      .from("company_updates")
      .select("*")
      .gte("created_at", since.toISOString())
      .order("created_at", { ascending: false })
      .limit(30);

    if (homeUpdatesFilter === "followed" && followedIds && followedIds.length > 0) {
      q = q.in("company_id", followedIds);
    }

    const { data, error } = await q;

    if (error) {
      console.warn("Updates fetch error:", error);
      renderHomeUpdates([]);
      return;
    }

    homeUpdatesData = (data || []);
    _updateHomeUpdatesActiveCount(homeUpdatesData);
    renderHomeUpdates(homeUpdatesData);

    // LIVE badge if there are updates
    const dot = document.getElementById("home-updates-dot");
    if (dot) {
      if ((homeUpdatesData || []).length > 0) dot.classList.remove("hidden");
      else dot.classList.add("hidden");
    }

  } catch (e) {
    console.warn("Updates fetch exception:", e);
    renderHomeUpdates([]);
  }
}

function subscribeHomeUpdatesRealtime() {
  try {
    if (homeUpdatesSub) {
      supabaseClient.removeChannel(homeUpdatesSub);
      homeUpdatesSub = null;
    }

    homeUpdatesSub = supabaseClient
      .channel("home-updates")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "company_updates" }, payload => {
        const row = payload && payload.new ? payload.new : null;
        if (!row) return;

        // ðŸ”” Followed-company notification (Free + Pro)
        try { _maybeNotifyFollowedUpdate(row); } catch(e) {}

        // Keep only last 7 days
        const createdAt = new Date(row.created_at || row.createdAt || Date.now());
        const now = new Date();
        if ((now - createdAt) > 7 * 24 * 60 * 60 * 1000) return;

        // Filter: if "Only followed", ignore updates from non-followed companies
        if (homeUpdatesFilter === "followed") {
          if (!__authUserId) return;
          const cid = String(row.company_id || row.profile_id || "").trim();
          if (!cid) return;

          // ensure follow set is loaded
          if (homeFollowLoadedFor !== __authUserId) {
            _ensureHomeFollowSet(__authUserId).then(() => {});
          }
          if (!_isCompanyFollowed(cid)) return;
        }

        // Prepend
        homeUpdatesData = [row, ...(homeUpdatesData || [])].slice(0, 30);
        _updateHomeUpdatesActiveCount(homeUpdatesData);
        renderHomeUpdates(homeUpdatesData);

        const dot = document.getElementById("home-updates-dot");
        if (dot) dot.classList.remove("hidden");
        try { syncLocaleUIBits(); } catch(e) {}
      })
      .subscribe();
  } catch (e) {
    console.warn("Updates realtime subscribe failed:", e);
  }
}

/* --- Engagement notifications (Followed updates + Profile views) --- */
let __BTON_ENG_NOTIF_INIT_FOR = null;
let profileViewsSub = null;
let __BTON_NOTIF_REFRESH_TIMER = null;

function _scheduleNotifRefresh() {
  try {
    if (__BTON_NOTIF_REFRESH_TIMER) return;
    __BTON_NOTIF_REFRESH_TIMER = setTimeout(() => {
      __BTON_NOTIF_REFRESH_TIMER = null;
      try { if (typeof fetchNotificationsUnread === "function") fetchNotificationsUnread(); } catch(e) {}
    }, 350);
  } catch(e) {}
}

function _makeI18nMarker(key, params = {}) {
  let s = `[I18N:${key}]`;
  try {
    const obj = (params && typeof params === "object") ? params : {};
    Object.keys(obj).forEach(k => {
      const v = (obj[k] == null) ? "" : String(obj[k]);
      s += `[${k}=${v}]`;
    });
  } catch(e) {}
  return s;
}

async function _notifySelfI18nOnce(key, titleKey, msgKey, params = {}, action = null) {
  try {
    const user = await _getAuthUserSafe();
    if (!user || !user.id || !key) return;

    // âœ… Primary path: DB-level dedupe via (recipient_user_id, dedupe_key) unique index
    const title = `[I18N:${titleKey}]`;
    const msg = `${action ? `[ACTION:${action}]` : ``}${_makeI18nMarker(msgKey, params)}`;

    const row = { recipient_user_id: user.id, title, message: msg, is_read: false, dedupe_key: key };

    const { error } = await supabaseClient
      .from('notifications')
      .upsert([row], { onConflict: 'recipient_user_id,dedupe_key', ignoreDuplicates: true });

    if (error) {
      // Fallback: legacy insert (best-effort). Keeps KEY marker for older parsers.
      try {
        const keyTag = `[KEY:${key}]`;
        const baseRow = { recipient_user_id: user.id, title, message: `${keyTag}${msg}`, is_read: false };
        const { error: err2 } = await supabaseClient.from('notifications').insert([baseRow]);
        if (err2) console.warn("Notification fallback insert failed:", err2);
      } catch(_) {}
    }

    _scheduleNotifRefresh();
  } catch (e) {
    console.warn("Self notification error:", e);
  }
}

async function _maybeNotifyFollowedUpdate(row) {
  try {
    if (!row || !__authUserId) return;
    const cid = String(row.company_id || "").trim();
    if (!cid) return;
    if (String(cid) === String(__authUserId)) return;

    // ensure follow set is loaded
    if (homeFollowLoadedFor !== __authUserId) await _ensureHomeFollowSet(__authUserId);
    if (!_isCompanyFollowed(cid)) return;
    if (!_btonIsAfterFollowStart(cid, row.created_at)) return;

    const key = "FOLLOW_UPD_" + String(row.id || row.created_at || nowTs());
    await _notifySelfI18nOnce(
      key,
      "notif_follow_update_title",
      "notif_follow_update_msg",
      { company: row.company_name || "A company you follow", company_id: cid, event_at: (row.created_at || "") },
      "OPEN_HOME_FOLLOWED"
    );
  } catch (e) {}
}

async function syncFollowedUpdateNotifications() {
  try {
    if (!__authUserId) return;
    if (homeFollowLoadedFor !== __authUserId) await _ensureHomeFollowSet(__authUserId);

    const ids = Array.from(homeFollowSet || []);
    if (!ids.length) return;

    const lastKey = "BTrustOn_notif_follow_updates_since";
    const lastIso = (() => { try { return localStorage.getItem(lastKey); } catch(e){ return null; } })();
    const sinceDate = lastIso ? new Date(lastIso) : new Date(nowTs() - 7*24*60*60*1000);
    const sinceIso = isNaN(sinceDate.getTime()) ? new Date(nowTs() - 7*24*60*60*1000).toISOString() : sinceDate.toISOString();

    // chunk to avoid "in" limits
    const chunkSize = 50;
    let newest = null;

    for (let i=0; i<ids.length; i+=chunkSize) {
      const chunk = ids.slice(i, i+chunkSize);
      const { data, error } = await supabaseClient
        .from("company_updates")
        .select("id,company_id,company_name,created_at")
        .in("company_id", chunk)
        .gt("created_at", sinceIso)
        .order("created_at", { ascending: true })
        .limit(50);

      if (error || !data) continue;

      for (const row of data) {
        newest = row.created_at || newest;
        await _maybeNotifyFollowedUpdate(row);
      }
    }

    if (newest) {
      try { localStorage.setItem(lastKey, new Date(newest).toISOString()); } catch(e) {}
    } else {
      try { localStorage.setItem(lastKey, new Date().toISOString()); } catch(e) {}
    }
  } catch (e) {
    console.warn("Follow update notif sync failed:", e);
  }
}

function _isProActiveForEngagement() {
  try {
    // Use cached "my plan" so it keeps working even if selectedCompany changes while browsing
    if (typeof __myProForEngagement === "boolean") return __myProForEngagement;
  } catch(e) {}
  try { return (typeof _isProForPosting === "function") ? _isProForPosting(selectedCompany) : false; } catch(e) { return false; }
}

async function _resolveViewerCompanyNames(viewRows=[]) {
  const map = new Map();
  try {
    const ids = Array.from(new Set((viewRows || []).map(v => v && v.viewer_id ? String(v.viewer_id) : "").filter(Boolean)));
    if (!ids.length) return map;
    const { data } = await supabaseClient
      .from("profiles")
      .select("id,company_name")
      .in("id", ids);
    (data || []).forEach(p => { if (p && p.id) map.set(String(p.id), p.company_name || ""); });
  } catch(e) {}
  return map;
}

async function _maybeNotifyProfileView(viewRow, viewerNameMap) {
  try {
      if (window.__PV_NOTIF_DB_ONLY) return;
    if (!viewRow || !__authUserId) return;
    if (!_isProActiveForEngagement()) return;

    const viewId = String(viewRow.id || "");
    const key = "PV_" + (viewId || (String(viewRow.viewer_id || "guest") + "_" + String(viewRow.viewed_at || nowTs())));
    const viewerId = viewRow.viewer_id ? String(viewRow.viewer_id) : "";
    const isGuest = !viewerId;

    if (isGuest) {
      // Use the actual view time (viewed_at) so the notification shows e.g. "1 hour ago"
      // even if the profile owner logs in later and notifications are synced afterwards.
      await _notifySelfI18nOnce(
        key,
        "notif_profile_view_title",
        "notif_profile_view_msg_guest",
        { event_at: (viewRow.viewed_at || "") },
        null
      );
    } else {
      const nm = (viewerNameMap && typeof viewerNameMap.get === "function") ? (viewerNameMap.get(viewerId) || "") : "";
      await _notifySelfI18nOnce(
        key,
        "notif_profile_view_title",
        "notif_profile_view_msg_company",
        { company: (nm || "A company"), event_at: (viewRow.viewed_at || "") },
        null
      );
    }
  } catch(e) {}
}

async function syncProfileViewNotifications() {
  try {
      if (window.__PV_NOTIF_DB_ONLY) return;
    if (!__authUserId) return;
    if (!_isProActiveForEngagement()) return;

    const lastKey = "BTrustOn_notif_profile_views_since";
    const lastIso = (() => { try { return localStorage.getItem(lastKey); } catch(e){ return null; } })();
    const sinceDate = lastIso ? new Date(lastIso) : new Date(nowTs() - 30*24*60*60*1000);
    const sinceIso = isNaN(sinceDate.getTime()) ? new Date(nowTs() - 30*24*60*60*1000).toISOString() : sinceDate.toISOString();

    let adminProfileId = null;
    try { if (typeof getAdminProfileId === "function") adminProfileId = await getAdminProfileId(); } catch(e) { adminProfileId = null; }

    const { data: views, error } = await supabaseClient
      .from("profile_views")
      .select("id,viewer_id,viewed_at,profile_id")
      .eq("profile_id", __authUserId)
      .gt("viewed_at", sinceIso)
      .order("viewed_at", { ascending: true })
      .limit(50);

    if (error || !views) return;

    const filtered = (views || []).filter(v => {
      if (!v) return false;
      if (adminProfileId && v.viewer_id && String(v.viewer_id) === String(adminProfileId)) return false;
      return true;
    });

    const nameMap = await _resolveViewerCompanyNames(filtered);
    let newest = null;

    for (const v of filtered) {
      newest = v.viewed_at || newest;
      await _maybeNotifyProfileView(v, nameMap);
    }

    if (newest) {
      try { localStorage.setItem(lastKey, new Date(newest).toISOString()); } catch(e) {}
    } else {
      try { localStorage.setItem(lastKey, new Date().toISOString()); } catch(e) {}
    }
  } catch(e) {
    console.warn("Profile view notif sync failed:", e);
  }
}

function subscribeProfileViewsRealtime() {
  try {
      if (window.__PV_NOTIF_DB_ONLY) return;
    if (profileViewsSub) {
      try { supabaseClient.removeChannel(profileViewsSub); } catch(e) {}
      profileViewsSub = null;
    }
    if (!__authUserId) return;
    if (!_isProActiveForEngagement()) return;

    profileViewsSub = supabaseClient
      .channel("profile-views")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "profile_views", filter: `profile_id=eq.${__authUserId}` }, async payload => {
        const row = payload && payload.new ? payload.new : null;
        if (!row) return;

        // Ignore admin if needed
        let adminProfileId = null;
        try { if (typeof getAdminProfileId === "function") adminProfileId = await getAdminProfileId(); } catch(e) {}
        if (adminProfileId && row.viewer_id && String(row.viewer_id) === String(adminProfileId)) return;

        const nameMap = await _resolveViewerCompanyNames([row]);
        await _maybeNotifyProfileView(row, nameMap);
      })
      .subscribe();
  } catch(e) {
    console.warn("Profile views realtime subscribe failed:", e);
  }
}

async function btonInitEngagementNotifications() {
  try {
    const user = await _getAuthUserSafe();
    if (!user || !user.id) return;

    // âœ… Ensure auth id is set before sync/subscribe (they early-return if missing)
    try { __authUserId = user.id; } catch(e) {}

    if (__BTON_ENG_NOTIF_INIT_FOR === user.id) return;
    __BTON_ENG_NOTIF_INIT_FOR = user.id;

    // Followed updates (all users)
    try { await _ensureHomeFollowSet(user.id); } catch(e) {}
    try { syncFollowedUpdateNotifications(); } catch(e) {}
    // Profile views: DB-driven (trigger creates notifications) â€” client-side PV notification sync disabled
  } catch(e) {}
}

function btonTeardownEngagementNotifications() {
  try {
    __BTON_ENG_NOTIF_INIT_FOR = null;
    if (profileViewsSub) {
      try { supabaseClient.removeChannel(profileViewsSub); } catch(e) {}
      profileViewsSub = null;
    }
  } catch(e) {}
}



/* ---------- POST MODAL FLOW ---------- */
let __updArea = "general";

async function _getAuthUserSafe() {
  // Robust auth check (works even if network is flaky):
  // 1) getSession() reads local session
  // 2) refreshSession() tries to recover if session is stale
  // 3) getUser() verifies with API (fallback)
  const client = (window.supabaseClient || (typeof supabaseClient !== "undefined" ? supabaseClient : null));
  if (!client?.auth) return null;

  try {
    const { data } = await client.auth.getSession();
    const s = data?.session || null;
    if (s?.user) return s.user;
  } catch (e) {}

  try {
    // Sometimes session is present but not yet hydrated; refresh can fix edge cases
    if (client.auth.refreshSession) {
      const { data } = await client.auth.refreshSession();
      const s2 = data?.session || null;
      if (s2?.user) return s2.user;
    }
  } catch (e) {}

  try {
    const { data } = await client.auth.getUser();
    const u = data?.user || null;
    if (u) return u;
  } catch (e) {}

  return null;
}

async function openPostUpdateModal() {
  const user = await _getAuthUserSafe();

  if (!user) {
    showToast(_i18n("toast_login_required", "Please sign in to post an update."));
    // Open login modal (fallback to Join)
    if (typeof openLoginModal === "function") openLoginModal();
    else if (document.getElementById("login-modal")) {
      const m = document.getElementById("login-modal");
      m.classList.remove("hidden");
      m.classList.add("flex");
    } else if (document.getElementById("modal-login")) {
      toggleModal("modal-login");
    } else {
      toggleModal("modal-join");
    }
    return;
  }

  // âœ… Always post as "my company" (do NOT depend on selectedCompany which may be another profile)
  __postCompany = await _fetchMyCompanyProfile(user.id);
  if (__postCompany && typeof enforceProLifecycle === "function") {
    __postCompany = await enforceProLifecycle(__postCompany);
  }

  if (!__postCompany) {
    showToast(currentLang === "tr"
      ? "Åžirket profiliniz yÃ¼klenemedi. LÃ¼tfen Ã¶nce My Company Ã¼zerinden profilinizi aÃ§Ä±n."
      : "Could not load your company profile. Please open My Company once.");
    return;
  }

  if (!_isProForPosting()) {
    const hint = document.getElementById("home-updates-prohint");
    if (hint) hint.classList.remove("hidden");
    showToast(currentLang === "tr"
      ? "Update paylaÅŸmak Pro Ã¶zelliÄŸidir. Pro'ya geÃ§erek paylaÅŸÄ±m yapabilirsiniz."
      : "Posting updates is a Pro feature. Upgrade to Pro to post.");
    openUpgradeModal();
    return;
  }

  // Defaults
  __updArea = "general";
  document.querySelectorAll(".upd-area-btn").forEach(btn => {
    const area = btn.getAttribute("data-area");
    const active = (area === __updArea);
    btn.classList.toggle("border-BTrustOn-accent", active);
    btn.classList.toggle("bg-cyan-50/60", active);
  });

  // reset selects
  const ent = document.getElementById("upd-entity");
  const sig = document.getElementById("upd-signal");
  if (ent) ent.innerHTML = "";
  if (sig) sig.innerHTML = `<option value="" selected disabled>â€”</option>`

  // reset note
  const note = document.getElementById("upd-note");
  const cnt = document.getElementById("upd-note-count");
  if (note) {
    note.value = "";
    note.placeholder = _i18n("post_note_ph", "Add a short note (optional)â€¦");
    if (cnt) cnt.textContent = "0";
    note.oninput = () => { if (cnt) cnt.textContent = String(note.value.length || 0); };
  }

  // Area buttons
  document.querySelectorAll(".upd-area-btn").forEach(btn => {
    btn.onclick = async () => {
      __updArea = btn.getAttribute("data-area") || "projects";
      document.querySelectorAll(".upd-area-btn").forEach(b2 => {
        const a2 = b2.getAttribute("data-area");
        const act = (a2 === __updArea);
        b2.classList.toggle("border-BTrustOn-accent", act);
        b2.classList.toggle("bg-cyan-50/60", act);
      });
      _populateUpdateEntitySelect(__updArea);
      _populateUpdateSignalSelect();
    };
  });

  // Populate selects
  _populateUpdateEntitySelect(__updArea);
  _populateUpdateSignalSelect();

  toggleModal("modal-post-update");
  // Load recent updates for quick management (delete, copy)
  try { loadMyRecentUpdates(); } catch(e) {}
}

// --- Recent Updates Manager (delete own updates) ---
function _renderRecentUpdatesSkeleton(n=3){
  return Array.from({length:n}).map(()=>`
    <div class="flex items-center gap-3 p-3 rounded-xl border border-gray-100 bg-white">
      <div class="w-10 h-10 rounded-xl bg-gray-100 animate-pulse"></div>
      <div class="flex-1 min-w-0">
        <div class="h-3 w-40 bg-gray-100 rounded animate-pulse"></div>
        <div class="mt-2 h-3 w-64 bg-gray-100 rounded animate-pulse"></div>
      </div>
    </div>
  `).join("");
}

async function loadMyRecentUpdates(){
  const listEl = document.getElementById("my-recent-updates-list");
  if (!listEl) return;

  const user = await _getAuthUserSafe();
  if (!user?.id) {
    listEl.innerHTML = `<div class="text-[11px] text-gray-500 p-3 rounded-xl border border-gray-100 bg-gray-50">
      ${_i18n("toast_login_required","Please sign in.")}
    </div>`;
    return;
  }

  listEl.innerHTML = _renderRecentUpdatesSkeleton(3);

  try{
    const now = new Date();
    const since = new Date(now.getTime() - 7*24*60*60*1000).toISOString();

    const { data, error } = await supabaseClient
      .from("company_updates")
      .select("id,created_at,area,entity_title,template_code,note,company_id")
      .eq("company_id", user.id)
      .gte("created_at", since)
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) throw error;
    _renderMyRecentUpdatesList(data || []);
  } catch(e){
    console.warn("loadMyRecentUpdates error:", e);
    listEl.innerHTML = `<div class="text-[12px] text-red-600 p-3 rounded-xl border border-red-100 bg-red-50">
      ${escapeHtml(e?.message || "Failed to load updates")}
    </div>`;
  }
}

function _renderMyRecentUpdatesList(rows){
  const listEl = document.getElementById("my-recent-updates-list");
  if (!listEl) return;

  const items = Array.isArray(rows) ? rows : [];
  if (items.length === 0){
    listEl.innerHTML = `<div class="text-[11px] text-gray-500 p-3 rounded-xl border border-gray-100 bg-gray-50">
      ${_i18n("post_no_updates_7d", (currentLang==="tr") ? "Son 7 gÃ¼nde paylaÅŸÄ±m yok." : (currentLang==="es" ? "No hay actualizaciones en los Ãºltimos 7 dÃ­as." : "No company updates in the last 7 days."))}
    </div>`;
    return;
  }

  listEl.innerHTML = items.map(u=>{
    const area = String(u.area || "projects");
    const when = _timeAgo(u.created_at);
    const title = escapeHtml(u.entity_title || "");
    const tmpl = escapeHtml(_templateLabel(area, u.template_code || ""));
    const note = (u.note ? escapeHtml(u.note) : "");
    const icon = (area === "general")
      ? "fa-bullhorn text-slate-500"
      : (area === "projects")
        ? "fa-diagram-project text-cyan-500"
        : (area === "assets")
          ? "fa-boxes-stacked text-emerald-500"
          : "fa-certificate text-amber-500";

    return `
      <div class="group flex items-start gap-3 p-3 rounded-2xl border border-gray-100 bg-white hover:shadow-sm transition">
        <div class="w-10 h-10 rounded-xl bg-gray-50 border border-gray-100 grid place-items-center shrink-0">
          <i class="fa-solid ${icon}"></i>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-[13px] font-semibold text-gray-900 truncate">${title}</div>
              <div class="mt-0.5 text-[11px] text-gray-500">
                <span class="font-semibold text-gray-700">${tmpl}</span>
                <span class="mx-1.5 text-gray-300">â€¢</span>
                <span>${escapeHtml(when)}</span>
              </div>
            </div>
            <button type="button"
              onclick="deleteCompanyUpdate('${escapeHtml(u.id)}')"
              class="shrink-0 text-[11px] px-2.5 py-1.5 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 transition">
              <i class="fa-regular fa-trash-can mr-1"></i>${(currentLang==="tr") ? "Sil" : "Delete"}
            </button>
          </div>
          ${note ? `<div class="mt-2 text-[12px] text-gray-700 whitespace-pre-wrap break-words">${note}</div>` : ""}
        </div>
      </div>
    `;
  }).join("");
}

async function deleteCompanyUpdate(updateId){
  const user = await _getAuthUserSafe();
  if (!user?.id){
    showToast(_i18n("toast_login_required","Please sign in."));
    if (typeof openLoginModal === "function") openLoginModal();
    return;
  }

  const msg = (currentLang==="tr") ? "Bu paylaÅŸÄ±mÄ± silmek istiyor musun?" : "Delete this update?";
  const ok = await uiConfirm(msg, {
    title: (currentLang==="tr") ? "Onay" : "Confirm",
    okText: (currentLang==="tr") ? "Sil" : "Delete",
    cancelText: (currentLang==="tr") ? "VazgeÃ§" : "Cancel",
    variant: "danger"
  });
  if (!ok) return;

  try{
    const targetCompanyId = (__postCompany?.id || selectedCompany?.id || user.id);

    const { data: delRows, error } = await supabaseClient
      .from("company_updates")
      .delete()
      .eq("id", updateId)
      .eq("company_id", targetCompanyId)
      .select("id");

    if (error) throw error;

    // If RLS blocks DELETE (or company_id mismatch), PostgREST can return 0 rows without an error.
    if (!delRows || delRows.length === 0){
      showToast(
        "Error",
        (currentLang==="tr")
          ? "Silinemedi. Yetki (RLS) veya ÅŸirket kimliÄŸi eÅŸleÅŸmiyor. Supabase'te company_updates iÃ§in DELETE policy eklemeniz gerekebilir."
          : "Delete failed. Permission (RLS) or company id mismatch. You may need a DELETE policy on company_updates.",
        "error"
      );
      return;
    }

    showToast(
      (currentLang==="tr") ? "Silindi" : "Deleted",
      (currentLang==="tr") ? "PaylaÅŸÄ±m kaldÄ±rÄ±ldÄ±." : "Update removed.",
      "success"
    );

    // Refresh both lists
    try { await loadMyRecentUpdates(); } catch(e) {}
    try { await fetchHomeUpdates(); } catch(e) {}

  } catch(e){
    console.warn("deleteCompanyUpdate error:", e);
    showToast("Error", e?.message || "Delete failed", "error");
  }
}


function _populateUpdateEntitySelect
(area) {
  const sel = document.getElementById("upd-entity");
  const empty = document.getElementById("upd-entity-empty");
  if (!sel) return;

  

  const wrap = document.getElementById("upd-entity-wrap");
  if (String(area || "").toLowerCase() === "general") {
    if (wrap) wrap.classList.add("hidden");
    if (empty) empty.classList.add("hidden");
    sel.innerHTML = `<option value="" selected>â€”</option>`;
    return;
  }
  if (wrap) wrap.classList.remove("hidden");
const list = _getAreaList(area);
  const label = (currentLang === "tr")
    ? (area === "projects" ? "Proje" : area === "assets" ? "Asset" : "Sertifika")
    : (area === "projects" ? "Project" : area === "assets" ? "Asset" : "Certificate");

  sel.innerHTML = `<option value="" selected disabled>â€” ${label} â€”</option>`;

  if (!list || list.length === 0) {
    if (empty) {
      empty.textContent = (currentLang === "tr")
        ? `Bu alanda kayÄ±tlÄ± Ã¶ÄŸe yok. Ã–nce profilinizden ekleyin.`
        : `No items found. Please add one in your profile first.`;
      empty.classList.remove("hidden");
    }
    return;
  }

  if (empty) empty.classList.add("hidden");

  list.forEach((it, idx) => {
    const id = it.id != null ? String(it.id) : String(idx);
    const title = _pickEntityTitle(it);
    sel.insertAdjacentHTML("beforeend", `<option value="${id}">${_safeText(title)}</option>`);
  });

}

const HOME_UPDATE_SIGNALS = [
  { code: "info", en: "Info", tr: "Bilgi", es: "InformaciÃ³n" },
  { code: "progress", en: "Progress", tr: "Ä°lerleme", es: "Progreso" },
  { code: "completed", en: "Completed", tr: "TamamlandÄ±", es: "Completado" },
  { code: "attention", en: "Attention", tr: "Dikkat", es: "AtenciÃ³n" },
];

function _populateUpdateSignalSelect() {
  const sel = document.getElementById("upd-signal");
  if (!sel) return;

  sel.innerHTML = `<option value="" selected disabled>â€”</option>`;
  HOME_UPDATE_SIGNALS.forEach(t => {
    const base = (currentLang === "tr") ? t.tr : (currentLang === "es") ? (t.es || t.en) : t.en;
    const label = tOr("updates_signal_" + t.code, base);
    sel.insertAdjacentHTML("beforeend", `<option value="${t.code}">${_safeText(label)}</option>`);
  });
}

document.addEventListener("click", (e) => {
  const btn = e.target.closest(".upd-area-btn");
  if (!btn) return;
  e.preventDefault();
  const area = btn.getAttribute("data-area") || "projects";
  __updArea = area;

  document.querySelectorAll(".upd-area-btn").forEach(b => {
    const a = b.getAttribute("data-area");
    const active = (a === __updArea);
    b.classList.toggle("border-BTrustOn-accent", active);
    b.classList.toggle("bg-cyan-50/60", active);
  });

  _populateUpdateEntitySelect(__updArea);
  _populateUpdateSignalSelect();
}, { passive: false });

async function submitCompanyUpdate() {
  return btonWithLock("submitCompanyUpdate", async () => {
  try {
    const btn = document.getElementById("btn-publish-update");
    if (btn) { btn.disabled = true; btn.classList.add("opacity-70"); }

    const entitySel = document.getElementById("upd-entity");
    const sigSel = document.getElementById("upd-signal");
    const noteEl = document.getElementById("upd-note");

    const entityId = entitySel ? entitySel.value : "";
    const templateCode = sigSel ? sigSel.value : "";
    const note = noteEl ? (noteEl.value || "").trim() : "";

        if (!templateCode) {
      showToast(tOr("toast_select_update_type", (currentLang==="tr") ? "LÃ¼tfen bildirim tipini seÃ§in." : (currentLang==="es" ? "Por favor, selecciona un tipo de actualizaciÃ³n." : "Please select an update type.")));
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }

    if (String(__updArea || "").toLowerCase() !== "general" && !entityId) {
      showToast(tOr("toast_select_item", (currentLang==="tr") ? "LÃ¼tfen bir Ã¶ÄŸe seÃ§in." : (currentLang==="es" ? "Por favor, selecciona un elemento." : "Please select an item.")));
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }

    // ðŸ”’ Enforce Pro gate again at publish-time (prevents bypass)
    const user = await _getAuthUserSafe();
    if (!user) {
      showToast(_i18n("toast_login_required", "Please sign in to post an update."));
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }

    // Refresh my company snapshot + enforce lifecycle so expired trials can't post
    __postCompany = await _fetchMyCompanyProfile(user.id) || __postCompany || null;
    if (__postCompany && typeof enforceProLifecycle === "function") {
      __postCompany = await enforceProLifecycle(__postCompany);
    }
    if (!__postCompany) {
      showToast(currentLang === "tr"
        ? "Åžirket profiliniz yÃ¼klenemedi. LÃ¼tfen My Company sayfanÄ±zÄ± bir kez aÃ§Ä±p tekrar deneyin."
        : "Could not load your company profile. Please open My Company once and try again.");
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }
    selectedCompany = __postCompany; // keep UI consistent for upgrade modal copy

    if (!_isProForPosting()) {
      showToast(currentLang === "tr"
        ? "Update paylaÅŸmak Pro Ã¶zelliÄŸidir. Pro'ya geÃ§erek paylaÅŸÄ±m yapabilirsiniz."
        : "Posting updates is a Pro feature. Upgrade to Pro to post.");
      openUpgradeModal();
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }

    // Snapshot fields (avoid join issues on public feed)
    const c = (__postCompany || selectedCompany) || {};
    const companyId = c.id || "";
    const companyName = c.company_name || c.name || "Company";
    const companyLogo = c.logo_url || c.company_logo_url || c.avatar_url || c.logo || c.company_logo || "";
    const isVerified = !!(c.is_verified || c.verified || c.verification_status === "approved" || c.verification_status === "verified");

        let entityIdOut = entityId;
    let entityTitle = "";

    if (String(__updArea || "").toLowerCase() === "general") {
      // For General updates, entity_id must be NULL (avoids UUID/type errors)
      // Store NULL title and localize on render (so TR/EN always matches current UI language)
      entityIdOut = null;
      entityTitle = "";
    } else {
      const list = _getAreaList(__updArea);
      const picked = list.find(it => String(it.id ?? "") === String(entityId)) || list[Number(entityId)] || null;
      entityTitle = _pickEntityTitle(picked);
    }

    const payload = {
      company_id: companyId,
      company_name: companyName,
      company_logo_url: companyLogo,
      is_verified: isVerified,

      area: __updArea,
      entity_id: entityIdOut,
      entity_title: entityTitle,

      template_code: templateCode,
      note: note,
    };

    const { error } = await supabaseClient.from("company_updates").insert([payload]);
    if (error) {
      console.error("Update insert error:", error);
      showToast(t("toast_publish_failed") || (currentLang==="tr" ? "PaylaÅŸÄ±m baÅŸarÄ±sÄ±z." : (currentLang==="es" ? "No se pudo publicar." : "Failed to publish.")));
      if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
      return;
    }

    showToast(t("toast_published") || (currentLang==="tr" ? "PaylaÅŸÄ±ldÄ±." : (currentLang==="es" ? "Publicado." : "Published.")));
    toggleModal("modal-post-update");

    // Refresh immediately (realtime also handles, but this ensures older browsers)
    await fetchHomeUpdates();

  } catch (e) {
    console.error("submitCompanyUpdate exception:", e);
    showToast(t("toast_publish_failed") || (currentLang==="tr" ? "PaylaÅŸÄ±m baÅŸarÄ±sÄ±z." : (currentLang==="es" ? "No se pudo publicar." : "Failed to publish.")));
  } finally {
    const btn = document.getElementById("btn-publish-update");
    if (btn) { btn.disabled = false; btn.classList.remove("opacity-70"); }
  }

  }, { ttlMs:15000, el: (document.querySelector("#update-form button[type=\"submit\"]") || null) });
}

// Hero CTA: show Join/How only for users who haven't created a company profile yet.
// If signed-in + profile exists => hide Join/How and show Post Update instead.
async function refreshHeroCTA() {
  try {
    const joinBtn = document.getElementById("hero-btn-join");
    const howBtn = document.getElementById("hero-btn-how");
    const postBtn = document.getElementById("hero-btn-post");
    const heroCta = document.getElementById("hero-cta");
    const heroDesc = document.getElementById("hero-desc");
    const heroProof = document.getElementById("hero-proof");
    const howSection = document.getElementById("how-section");
    const heroHeader = document.querySelector("#view-dashboard > header");
    const searchWrap = document.getElementById("hero-search-wrap");

    let user = null;
    try { user = await _getAuthUserSafe(); } catch(e) { user = null; }
    const signedIn = !!(user && user.id);

    // Used by applyTranslations() to pick the right hero title key.
    window.__btonHeroMode = signedIn ? "signed_in" : "guest";

    if (!signedIn) {
      if (joinBtn) joinBtn.style.display = "";
      if (howBtn) howBtn.style.display = "";
      if (postBtn) postBtn.style.display = "none";
      if (heroCta) heroCta.style.display = "";
      if (heroDesc) heroDesc.style.display = "";
      if (heroProof) heroProof.style.display = "";
      if (howSection) howSection.style.display = "";

      if (searchWrap) searchWrap.style.display = "";
      if (heroHeader) heroHeader.classList.remove("bton-hero-compact");

      if (typeof applyTranslations === "function") applyTranslations();
      return;
    }

    // âœ… Logged-in hero must stay minimal (title only)
    if (joinBtn) joinBtn.style.display = "none";
    if (howBtn) howBtn.style.display = "none";
    if (postBtn) postBtn.style.display = "none";
    if (heroCta) heroCta.style.display = "none";
    if (heroDesc) heroDesc.style.display = "none";
    if (heroProof) heroProof.style.display = "none";
    if (howSection) howSection.style.display = "none";

    if (searchWrap) searchWrap.style.display = ""; // keep search visible for signed-in users
    if (heroHeader) heroHeader.classList.add("bton-hero-compact");

    if (typeof applyTranslations === "function") applyTranslations();
  } catch(e) {}
}


/* =========================
   PRICING (FREE vs PRO)
   - Pro users should NOT see prices on the homepage.
   - Free + anonymous users can see pricing and upgrade.
========================= */
async function refreshPricingSection() {
  try {
    const wrap = document.getElementById("pricing-plans-wrap");
    const proState = document.getElementById("pricing-pro-state");
    const proDesc = document.getElementById("pricing-pro-active-desc");
    const sub = document.getElementById("pricing-sub");
    const btnFree = document.getElementById("btn-pricing-free");
    const btnPro = document.getElementById("btn-pricing-pro");
    const payNote = document.getElementById("pricing-pay-note");
    if (!wrap || !proState) return;

    const user = await _getAuthUserSafe();

    // Default: show pricing for visitors
    if (!user || !user.id) {
      wrap.style.display = "";
      proState.classList.add("hidden");
      if (payNote) payNote.style.display = "";
      if (sub) sub.style.display = "";
      if (btnFree) {
        btnFree.disabled = false;
        btnFree.classList.remove("opacity-60", "cursor-default");
        btnFree.setAttribute("data-i18n", "btn_join_free");
        btnFree.textContent = _i18n("btn_join_free", "JOIN FREE");
      }
      if (btnPro) {
        btnPro.disabled = false;
        btnPro.classList.remove("opacity-60", "cursor-default");
        btnPro.setAttribute("data-i18n", "btn_start_trial");
        btnPro.textContent = _i18n("btn_start_trial", "START FREE TRIAL");
      }
      return;
    }

    let profile = await _fetchMyCompanyProfile(user.id);

    // If user hasn't created a company profile yet => show pricing (they can join)
    if (!profile) {
      wrap.style.display = "";
      proState.classList.add("hidden");
      if (payNote) payNote.style.display = "";
      if (sub) sub.style.display = "";
      if (btnFree) {
        btnFree.disabled = false;
        btnFree.classList.remove("opacity-60", "cursor-default");
        btnFree.setAttribute("data-i18n", "btn_join_free");
        btnFree.textContent = _i18n("btn_join_free", "JOIN FREE");
      }
      if (btnPro) {
        btnPro.disabled = false;
        btnPro.classList.remove("opacity-60", "cursor-default");
        btnPro.setAttribute("data-i18n", "btn_start_trial");
        btnPro.textContent = _i18n("btn_start_trial", "START FREE TRIAL");
      }
      return;
    }

    // Keep lifecycle consistent (trial expiry etc.)
    if (typeof enforceProLifecycle === "function") {
      try { profile = (await enforceProLifecycle(profile)) || profile; } catch(_) {}
    }

    const isPro = _isProForPosting(profile);

    // If PRO => hide prices + show status card
    if (isPro) {
      wrap.style.display = "none";
      proState.classList.remove("hidden");
      if (payNote) payNote.style.display = "none";
      if (sub) sub.style.display = "none";

      if (proDesc) {
        const now = nowDate();
        const status = String(profile.subscription_status || "").toLowerCase();
        if (status === "active_trial" && profile.trial_end_date) {
          const d = new Date(profile.trial_end_date);
          if (!isNaN(d.getTime()) && d > now) {
            proDesc.textContent =
              (currentLang === "tr")
                ? `Pro denemeniz ${d.toLocaleDateString()} tarihine kadar aktif.`
                : `Your Pro trial is active until ${d.toLocaleDateString()}.`;
          } else {
            proDesc.textContent = _i18n("pricing_pro_active_desc", "Your plan is active.");
          }
        } else {
          proDesc.textContent = _i18n("pricing_pro_active_desc", "Your plan is active.");
        }
      }
      return;
    }

    // FREE (logged-in + profile exists)
    proState.classList.add("hidden");
    wrap.style.display = "";
    if (payNote) payNote.style.display = "";
    if (sub) sub.style.display = "";

    // Free button = current plan
    if (btnFree) {
      btnFree.disabled = true;
      btnFree.classList.add("opacity-60", "cursor-default");
      btnFree.setAttribute("data-i18n", "btn_current_plan");
      btnFree.textContent = _i18n("btn_current_plan", "CURRENT PLAN");
    }

    // Pro CTA label: trial vs paid upgrade
    const trialAlreadyUsed = !!(profile && profile.trial_start_date);
    if (btnPro) {
      btnPro.disabled = false;
      btnPro.classList.remove("opacity-60", "cursor-default");
      if (trialAlreadyUsed) {
        btnPro.setAttribute("data-i18n", "btn_upgrade_to_pro");
        btnPro.textContent = _i18n("btn_upgrade_to_pro", "UPGRADE TO PRO");
      } else {
        btnPro.setAttribute("data-i18n", "btn_start_trial");
        btnPro.textContent = _i18n("btn_start_trial", "START FREE TRIAL");
      }
    }
  } catch(e) {}
}

async function pricingChooseFree() {
  try {
    const user = await _getAuthUserSafe();
    if (!user) {
      openJoinModal("free");
      return;
    }
    const profile = await _fetchMyCompanyProfile(user.id);
    if (!profile) {
      openJoinModal("free");
      return;
    }
    showToast(
      currentLang === "tr" ? "Zaten hazÄ±rsÄ±n" : "You're all set",
      currentLang === "tr" ? "Free plan aktif." : "Free plan is active.",
      "success"
    );
  } catch (e) {
    openJoinModal("free");
  }
}

async function pricingChoosePro() {
  try {
    const user = await _getAuthUserSafe();
    if (!user) {
      openJoinModal("pro");
      return;
    }

    let profile = await _fetchMyCompanyProfile(user.id);
    if (!profile) {
      openJoinModal("pro");
      return;
    }

    // Ensure lifecycle is enforced before starting trial / payment
    if (typeof enforceProLifecycle === "function") {
      try { profile = (await enforceProLifecycle(profile)) || profile; } catch(_) {}
    }

    // Keep global selection consistent
    selectedCompany = profile;
    __postCompany = profile;

    if (_isProForPosting(profile)) {
      await refreshPricingSection();
      showToast(
        currentLang === "tr" ? "Pro aktif" : "Pro active",
        currentLang === "tr" ? "Zaten Pro planÄ±ndasÄ±n." : "You're already on Pro.",
        "success"
      );
      return;
    }

    const trialAlreadyUsed = !!(profile && profile.trial_start_date);
    if (trialAlreadyUsed) {
      // âœ… Trial already used/expired => go straight to payment
      openProPayment();
      return;
    }

    // âœ… No trial used yet => start trial immediately (no extra modal)
    await startProTrialDirect(profile, { source: "pricing" });
  } catch (e) {
    openJoinModal("pro");
  }
}

// Dosya SeÃ§ilince Ã‡alÄ±ÅŸÄ±r (Input Change)
function __assetFileTypeLabelFromName(name, url){
  const n = (name || url || "").toString().toLowerCase();
  try{
    if (typeof _isImageFileName === "function" && _isImageFileName(n)) return "IMG";
  }catch(_){}
  if (n.includes(".pdf")) return "PDF";
  try{
    const k = _assetFileKind({ file_url: url || "", file_name: name || "" });
    return k || "FILE";
  }catch(e){
    return "FILE";
  }
}

function __renderAssetFileList(){
  const list = document.getElementById("asset-file-list");
  const textEl = document.getElementById("asset-file-text");
  const labelEl = document.getElementById("asset-file-label");
  const removeBtn = document.getElementById("btn-remove-asset-file");

  const totalExisting = (existingAssetFiles || []).length;
  const totalNew = (currentAssetFiles || []).length;
  const total = totalExisting + totalNew;

  if(textEl){
    textEl.textContent = total
      ? (currentLang === "tr" ? `${total} dosya ekli` : `${total} file(s) attached`)
      : (t("lbl_asset_file_input") || "Attach File (Max 5MB)");
  }
  if(labelEl){
    if(total) labelEl.classList.add("border-BTrustOn-accent", "bg-cyan-50");
    else labelEl.classList.remove("border-BTrustOn-accent", "bg-cyan-50");
  }
  if(removeBtn){
    if(total) removeBtn.classList.remove("hidden");
    else removeBtn.classList.add("hidden");
  }

  if(!list) return;
  if(!total){
    list.innerHTML = "";
    return;
  }

  const row = (kind, name, rightHtml) => `
    <div class="flex items-center justify-between gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2">
      <div class="min-w-0 flex items-center gap-2">
        <span class="shrink-0 text-[10px] font-extrabold px-2 py-1 rounded-lg bg-slate-50 border border-slate-200 text-slate-600">${kind}</span>
        <div class="min-w-0 text-[11px] font-bold text-slate-700 truncate" title="${_safeText(name)}">${_safeText(name)}</div>
      </div>
      <div class="shrink-0 flex items-center gap-1">${rightHtml || ""}</div>
    </div>
  `;

  const openLbl = (t("attachment_open") || (currentLang === "tr" ? "AÃ§" : "Open"));
  const selLbl = (currentLang === "tr" ? "SeÃ§ildi" : "Selected");
  const removeTitle = _safeText(t("attr_remove_file_46330f") || "Remove");

  const existingHtml = (existingAssetFiles || []).map((f, idx) => {
    const kind = __assetFileTypeLabelFromName(f.name, f.url);
    const viewBtn = `
      <button type="button"
        class="js-att-open px-2 py-1 rounded-lg bg-slate-50 border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white transition text-[11px] font-extrabold"
        data-att-url="${_safeText(f.url || "")}"
        data-att-title="${_safeText(f.name || "Attachment")}"
        data-att-filename="${_safeText(f.name || "")}"
      >${openLbl}</button>
    `;
    const delBtn = `
      <button type="button"
        class="w-8 h-8 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 grid place-items-center transition"
        onclick="removeExistingAssetFile(${idx})"
        title="${removeTitle}">
        <i class="fa-solid fa-trash text-xs"></i>
      </button>
    `;
    return row(kind, (f.name || f.url || ""), viewBtn + delBtn);
  }).join("");

  const newHtml = (currentAssetFiles || []).map((f, idx) => {
    const kind = __assetFileTypeLabelFromName(f.name, "");
    const pill = `<span class="text-[10px] font-extrabold px-2 py-1 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-700">${selLbl}</span>`;
    const delBtn = `
      <button type="button"
        class="w-8 h-8 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 grid place-items-center transition"
        onclick="removeNewAssetFile(${idx})"
        title="${removeTitle}">
        <i class="fa-solid fa-trash text-xs"></i>
      </button>
    `;
    return row(kind, (f && f.name ? f.name : ""), pill + delBtn);
  }).join("");

  list.innerHTML = existingHtml + (existingHtml && newHtml ? `<div class="h-2"></div>` : ``) + newHtml;
}

function removeExistingAssetFile(idx){
  try{
    existingAssetFiles = (existingAssetFiles || []).filter((_, i) => i !== idx);
    __renderAssetFileList();
  }catch(e){}
}
function removeNewAssetFile(idx){
  try{
    currentAssetFiles = (currentAssetFiles || []).filter((_, i) => i !== idx);
    __renderAssetFileList();
  }catch(e){}
}

// Dosya SeÃ§ilince Ã‡alÄ±ÅŸÄ±r (Input Change)
function handleAssetFileSelect(input) {
  if (!input || !input.files || !input.files.length) return;
  const files = Array.from(input.files || []);

  const MAX_MB = 5;
  const MAX_FILES = 12;

  for (const file of files) {
    if (!file) continue;

    if (file.size > MAX_MB * 1024 * 1024) {
      showToast("File too large", `Max file size is ${MAX_MB}MB. (${file.name})`, "error");
      continue;
    }

    // prevent duplicates by name+size (new) / name (existing)
    const dupNew = (currentAssetFiles || []).some(f => f && f.name === file.name && f.size === file.size);
    const dupExisting = (existingAssetFiles || []).some(f => f && f.name === file.name);
    if (dupNew || dupExisting) continue;

    currentAssetFiles.push(file);

    if ((currentAssetFiles.length + (existingAssetFiles || []).length) >= MAX_FILES) break;
  }

  // Reset input so selecting the same file triggers again
  input.value = "";

  __renderAssetFileList();
}

// SeÃ§ilen/Mevcut DosyalarÄ± Ä°ptal Et (Ã‡Ã¶p Kutusu Butonu)
function removeAssetFile() {
  currentAssetFiles = [];
  existingAssetFiles = [];

  const inputEl = document.getElementById("asset-file-input");
  if(inputEl) inputEl.value = "";

  __renderAssetFileList();
}

/* --- PROJE RESÄ°M YÃ–NETÄ°MÄ° --- */
let currentProjCover = null;       // Yeni seÃ§ilen kapak dosyasÄ±
let shouldRemoveCover = false;     // "KapaÄŸÄ± Sil"e basÄ±ldÄ± mÄ±?
let currentProjGalleryFiles = [];  // Yeni seÃ§ilen galeri dosyalarÄ± (File objeleri)
let tempExistingGalleryUrls = [];  // DÃ¼zenleme modunda: VeritabanÄ±ndaki mevcut URL'ler
let cropperInstance = null; // KÄ±rpma aracÄ±nÄ± tutacak

// 1. Kapak SeÃ§imi
/* --- GÃœNCELLENMÄ°Åž: handleProjectCover (CROPPER Ä°LE) --- */
function handleProjectCover(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Use the same cropper as profile logo/contact photo (16:9 for project cover)
        openCropperForFile(file, { kind: "project_cover", mode: "edit" });

        // Reset input so selecting same file triggers again
        input.value = "";
    }
}

// --- CROPPER FONKSÄ°YONLARI ---

function openCropper(imageSrc) {
    const modal = document.getElementById("modal-cropper");
    const image = document.getElementById("cropper-img");
    
    // Resmi yÃ¼kle
    image.src = imageSrc;
    
    // ModalÄ± gÃ¶ster
    modal.classList.remove("opacity-0", "pointer-events-none");

    // EÄŸer eski bir cropper varsa yok et (memory leak olmasÄ±n)
    if (cropperInstance) {
        cropperInstance.destroy();
    }

    // Yeni Cropper baÅŸlat
    // aspectRatio: 16/9 -> DikdÃ¶rtgen kapak iÃ§in ideal oran
    cropperInstance = new Cropper(image, {
        aspectRatio: 16 / 9, 
        viewMode: 1, 
        autoCropArea: (__btonCropContain ? 0.92 : 1),
        dragMode: 'move',
        guides: true,
        center: true,
        background: false
    });
}

function closeCropper() {
    const modal = document.getElementById("modal-cropper");
    modal.classList.add("opacity-0", "pointer-events-none");
    if (cropperInstance) {
        cropperInstance.destroy();
        cropperInstance = null;
    }
}

function cropImage() {
    if (!cropperInstance) return;

    // 1. KÄ±rpÄ±lmÄ±ÅŸ hali Canvas olarak al
    const canvas = cropperInstance.getCroppedCanvas({
        width: 800,  // Resmi optimize et (Ã§ok bÃ¼yÃ¼k olmasÄ±n)
        height: 450, // 16:9 oranÄ±nda
    });

    // 2. Canvas'Ä± Blob'a (Dosyaya) Ã§evir
    canvas.toBlob((blob) => {
        // Blob'u sanki bir File objesiymiÅŸ gibi paketle
        // Supabase'e yÃ¼klerken 'name' lazÄ±m olacak
        const file = new File([blob], "cropped_cover.jpg", { type: "image/jpeg" });

        // 3. Bizim ana deÄŸiÅŸkene ata (saveProject bunu kullanacak)
        currentProjCover = file;
        shouldRemoveCover = false;

        // 4. Ã–nizleme kutusunu gÃ¼ncelle (Modal iÃ§indeki kÃ¼Ã§Ã¼k kutu)
        const previewDiv = document.getElementById("cover-preview");
        previewDiv.innerHTML = `
            <img src="${canvas.toDataURL()}" class="w-full h-full object-cover">
            <button type="button" onclick="removeProjectCover()" class="absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition cursor-pointer">
               <i class="fa-solid fa-trash text-xs"></i>
            </button>
        `;

        // 5. KÄ±rpÄ±cÄ±yÄ± kapat
        closeCropper();
        showToast("Image Cropped", "Cover image updated.", "success");
    }, 'image/jpeg', 0.85); // %85 kalite ile sÄ±kÄ±ÅŸtÄ±r
}

// 2. KapaÄŸÄ± Silme Fonksiyonu
function removeProjectCover() {
    currentProjCover = null;
    shouldRemoveCover = true; // Kaydederken 'null' gÃ¶ndereceÄŸiz
    
    // UI'Ä± sÄ±fÄ±rla
    const div = document.getElementById("cover-preview");
    div.innerHTML = `<i class="fa-solid fa-image text-gray-400"></i>`;
}

// 3. Galeriye YENÄ° Dosya Ekleme
function handleProjectGallery(input) {
    if (input.files) {
        // Yeni dosyalarÄ± mevcutlarÄ±n Ã¼zerine ekle (Append)
        const newFiles = Array.from(input.files);
        currentProjGalleryFiles = [...currentProjGalleryFiles, ...newFiles];
        
        // Metni gÃ¼ncelle
        updateGalleryCountText();
    }
}

// 4. Galeri Metni GÃ¼ncelleme Helper
function updateGalleryCountText() {
    const total = tempExistingGalleryUrls.length + currentProjGalleryFiles.length;
    const txt = document.getElementById("gallery-count-text");
    if(total > 0) txt.textContent = `${currentProjGalleryFiles.length} new, ${tempExistingGalleryUrls.length} existing`;
    else txt.textContent = "";
}

// 5. Mevcut Galeri Resmini Listeden Ã‡Ä±karma (UI'dan silme)
function removeExistingGalleryImage(url) {
    // Listeden Ã§Ä±kar
    tempExistingGalleryUrls = tempExistingGalleryUrls.filter(u => u !== url);
    // UI'Ä± gÃ¼ncelle (Yeniden Ã§iz)
    renderExistingGalleryPreviews();
    updateGalleryCountText();
}

// 6. Galeri Ã–nizlemelerini Ã‡izme (Modal AÃ§Ä±lÄ±nca)
function renderExistingGalleryPreviews() {
    const container = document.getElementById("existing-gallery-preview");
    container.innerHTML = "";
    
    if (tempExistingGalleryUrls.length === 0) {
        container.style.display = "none"; // BoÅŸsa gizle
        return;
    }
    container.style.display = "flex";

    tempExistingGalleryUrls.forEach(url => {
        const div = document.createElement("div");
        div.className = "relative flex-shrink-0 w-12 h-12 rounded border border-gray-200 overflow-hidden group";
        div.innerHTML = `
            <img src="${url}" class="w-full h-full object-cover">
            <button type="button" onclick="removeExistingGalleryImage('${url}')" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center rounded-bl text-[8px] hover:bg-red-600 transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

/* --- STEP 5: PLAN LÄ°MÄ°TLERÄ° VE KONTROLÃœ --- */
const PLAN_LIMITS = {
    free: { projects: 2, assets: 3, certs: 2 },
    pro: { projects: 9999, assets: 9999, certs: 9999 }
};

function checkPlanLimit(type) {
    // Åžirket verisi yoksa veya tier bilgisi yoksa 'free' varsay
    const tier = (selectedCompany && selectedCompany.subscription_tier) ? selectedCompany.subscription_tier : 'free';
    
    // Pro ise sÄ±nÄ±r yok, geÃ§
    if (tier === 'pro') return true;

    // Mevcut sayÄ±larÄ± kontrol et
    let currentCount = 0;
    const limit = PLAN_LIMITS.free[type];

    if (selectedCompany) {
        if (type === 'projects') currentCount = (selectedCompany.projects || []).length;
        if (type === 'assets') currentCount = (selectedCompany.assets || []).length;
        if (type === 'certs') currentCount = (selectedCompany.certificates || []).length;
    }

    // Limit dolduysa uyarÄ± ver ve false dÃ¶ndÃ¼r
    if (currentCount >= limit) {
        showToast("Limit Reached", `Free plan limit: ${limit} items. Upgrade to add more.`, "error");
        return false;
    }
    return true; // Limit dolmadÄ±ysa true dÃ¶ndÃ¼r
}
/* --- GENÄ°ÅžLETÄ°LMÄ°Åž ÃœLKE LÄ°STESÄ° --- */
const countryList = [
    // Asya & Pasifik
    "Afghanistan", "Australia", "Bangladesh", "China", "India", "Indonesia", "Japan", 
    "Kazakhstan", "Malaysia", "Mongolia", "New Zealand", "Pakistan", "Philippines", 
    "Singapore", "South Korea", "Thailand", "Turkmenistan", "Uzbekistan", "Vietnam",
    
    // Avrupa
    "Albania", "Austria", "Belgium", "Bosnia and Herzegovina", "Bulgaria", "Croatia", 
    "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", 
    "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Netherlands", "Norway", 
    "Poland", "Portugal", "Romania", "Russia", "Serbia", "Spain", "Sweden", 
    "Switzerland", "Ukraine", "United Kingdom",
    
    // Orta DoÄŸu & Afrika
    "Algeria", "Azerbaijan", "Bahrain", "Egypt", "Georgia", "Iran", "Iraq", "Israel", 
    "Jordan", "Kuwait", "Lebanon", "Libya", "Morocco", "Nigeria", "Oman", "Qatar", 
    "Saudi Arabia", "South Africa", "Tunisia", "UAE",
    
    // Amerika
    "Argentina", "Brazil", "Canada", "Chile", "Colombia", "Mexico", "Peru", "USA", "Venezuela"
].sort(); // Ã–nce hepsini alfabetik diziyoruz

// Sayfa aÃ§Ä±lÄ±nca kutularÄ± dolduran fonksiyon (TÃœRKÄ°YE Ã–NCELÄ°KLÄ°)

// =======================
// Country localization helpers (for dropdown labels)
// =======================
const __ISO2_COUNTRY_CODES = ["AD", "AE", "AF", "AG", "AI", "AL", "AM", "AO", "AQ", "AR", "AS", "AT", "AU", "AW", "AX", "AZ", "BA", "BB", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BL", "BM", "BN", "BO", "BQ", "BR", "BS", "BT", "BV", "BW", "BY", "BZ", "CA", "CC", "CD", "CF", "CG", "CH", "CI", "CK", "CL", "CM", "CN", "CO", "CR", "CU", "CV", "CW", "CX", "CY", "CZ", "DE", "DJ", "DK", "DM", "DO", "DZ", "EC", "EE", "EG", "EH", "ER", "ES", "ET", "FI", "FJ", "FK", "FM", "FO", "FR", "GA", "GB", "GD", "GE", "GF", "GG", "GH", "GI", "GL", "GM", "GN", "GP", "GQ", "GR", "GS", "GT", "GU", "GW", "GY", "HK", "HM", "HN", "HR", "HT", "HU", "ID", "IE", "IL", "IM", "IN", "IO", "IQ", "IR", "IS", "IT", "JE", "JM", "JO", "JP", "KE", "KG", "KH", "KI", "KM", "KN", "KP", "KR", "KW", "KY", "KZ", "LA", "LB", "LC", "LI", "LK", "LR", "LS", "LT", "LU", "LV", "LY", "MA", "MC", "MD", "ME", "MF", "MG", "MH", "MK", "ML", "MM", "MN", "MO", "MP", "MQ", "MR", "MS", "MT", "MU", "MV", "MW", "MX", "MY", "MZ", "NA", "NC", "NE", "NF", "NG", "NI", "NL", "NO", "NP", "NR", "NU", "NZ", "OM", "PA", "PE", "PF", "PG", "PH", "PK", "PL", "PM", "PN", "PR", "PS", "PT", "PW", "PY", "QA", "RE", "RO", "RS", "RU", "RW", "SA", "SB", "SC", "SD", "SE", "SG", "SH", "SI", "SJ", "SK", "SL", "SM", "SN", "SO", "SR", "SS", "ST", "SV", "SX", "SY", "SZ", "TC", "TD", "TF", "TG", "TH", "TJ", "TK", "TL", "TM", "TN", "TO", "TR", "TT", "TV", "TW", "TZ", "UA", "UG", "UM", "US", "UY", "UZ", "VA", "VC", "VE", "VG", "VI", "VN", "VU", "WF", "WS", "YE", "YT", "ZA", "ZM", "ZW"];
const __countryNameCodeCache = { en: null, tr: null };

function __buildCountryNameMap(locale) {
  const map = {};
  try {
    const dn = new Intl.DisplayNames([locale], { type: 'region' });
    __ISO2_COUNTRY_CODES.forEach(code => {
      const nm = dn.of(code);
      if (nm) map[String(nm).toLowerCase()] = code;
    });
  } catch (e) {}
  return map;
}

function __normLangCode(l) {
  const s = String(l || 'en').toLowerCase();
  if (s.startsWith('tr')) return 'tr';
  if (s.startsWith('en')) return 'en';
  return s;
}

function __normalizeCountryInput(v) {
  let s = String(v || '');
  try { s = s.replace(/[\u200B-\u200D\uFEFF]/g, ''); } catch(e) {}
  try { s = s.replace(/\u00A0/g, ' '); } catch(e) {}
  try { s = s.replace(/\s+/g, ' ').trim(); } catch(e) {}
  try { if (s.normalize) s = s.normalize('NFKC'); } catch(e) {}
  return s;
}

const __COUNTRY_ALIAS_CODE = {
  // Common EN/TR aliases (add more if needed)
  "turkey":"TR", "tÃ¼rkiye":"TR", "turkiye":"TR", "tr":"TR", "t.c.":"TR",
  "finland":"FI", "finlandiya":"FI",
  "france":"FR", "fransa":"FR",
  "germany":"DE", "almanya":"DE",
  "united states":"US", "usa":"US", "amerika":"US", "abd":"US",
  "united kingdom":"GB", "uk":"GB", "birleÅŸik krallÄ±k":"GB", "ingiltere":"GB",
  "netherlands":"NL", "hollanda":"NL",
  "spain":"ES", "ispanya":"ES",
  "italy":"IT", "italya":"IT",
  "saudi arabia":"SA", "suudi arabistan":"SA",
  "united arab emirates":"AE", "uae":"AE", "birleÅŸik arap emirlikleri":"AE",
  "china":"CN", "Ã§in":"CN"
};

function countryNameToISO2(name) {
  const raw = __normalizeCountryInput(name);
  if (!raw) return null;

  // Already ISO2
  if (/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();

  const key = raw.toLowerCase();
  if (__COUNTRY_ALIAS_CODE[key]) return __COUNTRY_ALIAS_CODE[key];

  try {
    if (!__countryNameCodeCache.en) __countryNameCodeCache.en = __buildCountryNameMap('en');
    if (__countryNameCodeCache.en[key]) return __countryNameCodeCache.en[key];

    if (!__countryNameCodeCache.tr) __countryNameCodeCache.tr = __buildCountryNameMap('tr');
    if (__countryNameCodeCache.tr[key]) return __countryNameCodeCache.tr[key];
  } catch (e) {}

  return null;
}

function localizeCountryName(name) {
  const raw = __normalizeCountryInput(name);
  if (!raw) return '';

  const code = countryNameToISO2(raw);
  if (!code) return raw;

  const lang = __normLangCode(typeof currentLang !== 'undefined' ? currentLang : 'en');

  // Deterministic TR fallbacks (prevents showing Turkey/Finland in TR UI)
  if (lang === 'tr') {
    const manual = {
      "TR": "TÃ¼rkiye",
      "FI": "Finlandiya",
      "FR": "Fransa",
      "DE": "Almanya",
      "US": "ABD",
      "GB": "BirleÅŸik KrallÄ±k",
      "NL": "Hollanda",
      "ES": "Ä°spanya",
      "IT": "Ä°talya",
      "SA": "Suudi Arabistan",
      "AE": "BirleÅŸik Arap Emirlikleri",
      "CN": "Ã‡in"
    };
    if (manual[code]) return manual[code];
  }

  try {
    const dn = new Intl.DisplayNames([lang], { type: 'region' });
    return dn.of(code) || raw;
  } catch (e) {
    return raw;
  }
}




function formatCityCountry(city, country) {
  const c = (city || "").toString().trim();
  const cn = localizeCountryName(country || "");
  if (c && cn) return `${c}, ${cn}`;
  return c || cn || "";
}

function populateCountrySelects() {
    const selects = ["join-country", "edit-country"];
    
    selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        
        const prev = el.value; el.innerHTML = '<option value="">' + (t("ui_select_country") || "Select Country...") + '</option>';
        
        // 1. TÃœRKÄ°YE'YÄ° EN BAÅžA SABÄ°TLE (KolaylÄ±k olsun)
        const trOption = document.createElement("option");
        trOption.value = "Turkey";
        trOption.textContent = localizeCountryName("Turkey");
        el.appendChild(trOption);

        // Araya Ã§izgi (Separator) atalÄ±m
        const separator = document.createElement("option");
        separator.disabled = true;
        separator.textContent = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";
        el.appendChild(separator);

        // 2. DÄ°ÄžER ÃœLKELERÄ° ALFABETÄ°K EKLE
        countryList.forEach(c => {
            // Listede Turkey varsa tekrar ekleme (zaten baÅŸa koyduk)
            if (c !== "Turkey") {
                const option = document.createElement("option");
                option.value = c;
                option.textContent = localizeCountryName(c);
                el.appendChild(option);
            }
        });
        
        // Listenin sonuna "Other" ekle
        const otherOpt = document.createElement("option");
        otherOpt.value = "Other";
        otherOpt.textContent = (t("ui_other_not_listed") || "Other / Not Listed");
        el.appendChild(otherOpt);

        // restore previous value
        try { if (prev) el.value = prev; } catch(e) {}
    });
}

    // Top band animasyon & canlÄ± gÃ¶rÃ¼nÃ¼m iÃ§in
    let topCompaniesOrder = [];
    let topScrollInterval = null;
    let topRotateInterval = null;

    // Ana grid iÃ§in hafif "canlÄ±lÄ±k" (boÅŸ aramada hafif shuffle)
    let gridShuffleInterval = null;

    // *** DATABASE: TAM LÄ°STE ***
    const database = [];



    function t(key) {
      const pack = (translations && translations[currentLang]) ? translations[currentLang] : {};
      const en = (translations && translations.en) ? translations.en : {};
      // Avoid EN "flash" while TR pack is still loading
      const packReady = pack && Object.keys(pack).length;
      if (!packReady && currentLang !== "en") return "";
      return (pack && pack[key]) || (en && en[key]) || "";
    }

function tOr(key, fallback) {
      const pack = (translations && translations[currentLang]) ? translations[currentLang] : {};
      const packReady = pack && Object.keys(pack).length;
      if (!packReady && currentLang !== "en") return "";
      const v = t(key);
      return (v && String(v).trim().length) ? v : (fallback || "");
    }



    // =======================
    // UI value translations (dynamic enums)
    // =======================
    function translateCompanyType(typeRaw) {
  const v = (typeRaw || "").toString().trim();
  if (!v) return "";

  const s = v.toLowerCase();

  // Normalize many possible stored/display labels to a stable i18n key
  let k = "";
  if (s.includes("operator") || s.includes("asset owner") || s === "operator") k = "join_type_operator";
  else if (s.includes("epc") || s.includes("general contractor") || s.includes("contractor")) k = "join_type_contractor";
  else if (s.includes("subcontractor") || s.includes("specialist") || s.includes("sub-contractor")) k = "join_type_subcontractor";
  else if (s.includes("manufacturer") || s.includes("oem") || s.includes("fabrication") || s.includes("fabricator")) k = "join_type_manufacturer";
  else if (s.includes("distributor") || s.includes("supplier") || s.includes("distribÃ¼tÃ¶r") || s.includes("tedarik")) k = "join_type_distributor";
  else if (s.includes("engineering") || s.includes("consult") || s.includes("consultancy") || s.includes("danÄ±ÅŸman")) k = "join_type_engineering_consultancy";
  else if (s.includes("tech") || s.includes("software") || s.includes("technology") || s.includes("yazÄ±lÄ±m")) k = "join_type_technology_software";
  else if (s.includes("service provider")) k = "join_type_service_provider";
  else if (s.includes("consultant")) k = "join_type_consultant";

  const label = k ? t(k) : "";
  return label || v;
}

function translateCountryName(countryRaw, countryCodeRaw="") {
  const code = String(countryCodeRaw || "").trim().toUpperCase();

  // If we have ISO-2, localize via Intl.DisplayNames
  if (code && code.length === 2 && typeof Intl !== "undefined" && Intl.DisplayNames) {
    try {
      const lang = __normLangCode(typeof currentLang !== "undefined" ? currentLang : "en");
      const locale = (lang === "tr") ? "tr-TR" : (lang === "es" ? "es-ES" : "en-US");
      const dn = new Intl.DisplayNames([locale], { type: "region" });
      const n = dn.of(code);
      if (n) return n;
    } catch(e) {}
  }

  // Otherwise infer ISO from the name and localize
  if (typeof localizeCountryName === "function") return localizeCountryName(countryRaw);

  return (countryRaw || "").toString().trim() || code;
}



function translateCompanySize(sizeRaw) {
      const v = (sizeRaw || "").trim();
      if (!v) return "";
      const lang = (typeof __normLangCode === "function") ? __normLangCode(currentLang) : String(currentLang || "en").slice(0,2).toLowerCase();

      if (lang === "tr") {
        const map = {
          "1-10 employees": "1â€“10 Ã§alÄ±ÅŸan",
          "10-50 employees": "10â€“50 Ã§alÄ±ÅŸan",
          "50-100 employees": "50â€“100 Ã§alÄ±ÅŸan",
          "100-250 employees": "100â€“250 Ã§alÄ±ÅŸan",
          "250+ employees": "250+ Ã§alÄ±ÅŸan",
          "Size N/A": "Boyut Yok"
        };
        return map[v] || v.replace(/\s*employees\b/i, " Ã§alÄ±ÅŸan");
      }

      if (lang === "es") {
        const map = {
          "1-10 employees": "1â€“10 empleados",
          "10-50 employees": "10â€“50 empleados",
          "50-100 employees": "50â€“100 empleados",
          "100-250 employees": "100â€“250 empleados",
          "250+ employees": "250+ empleados",
          "Size N/A": "TamaÃ±o N/D"
        };
        return map[v] || v.replace(/\s*employees\b/i, " empleados");
      }

      // default (EN or unknown)
      if (/^Size\s*N\/?A$/i.test(v)) return "Size N/A";
      return v;
    }

    function formatFoundedYear(yearVal) {
      const y = (yearVal == null) ? "" : String(yearVal).trim();
      if (!y) return "";
      const lang = (typeof __normLangCode === "function") ? __normLangCode(currentLang) : String(currentLang || "en").slice(0,2).toLowerCase();
      if (lang === "tr") return `KuruluÅŸ ${y}`;
      if (lang === "es") return `Fundada en ${y}`;
      return `Founded ${y}`;
    }

    
// =======================
// i18n audit (dev-only): warns if a key used in DOM is missing from both currentLang and EN
// =======================
let __i18nAuditTimer = null;
function __i18nHasKey(lang, key){
  try {
    const obj = (lang === "en") ? (translations && translations.en) : (translations && translations[lang]);
    return !!(obj && Object.prototype.hasOwnProperty.call(obj, key));
  } catch(e){ return false; }
}
function auditI18nKeys(root = document){
  if (!BTON_DEBUG) return;
  try {
    const used = new Set();
    const attrs = ["data-i18n","data-i18n-placeholder","data-i18n-title","data-i18n-aria"];
    attrs.forEach(attr=>{
      root.querySelectorAll("[" + attr + "]").forEach(el=>{
        const k = el.getAttribute(attr);
        if (k) used.add(k);
      });
    });
    const missing = [];
    used.forEach(k=>{
      const ok = __i18nHasKey(currentLang, k) || __i18nHasKey("en", k);
      if (!ok) missing.push(k);
    });
    if (missing.length){
      console.warn("[i18n] Missing keys:", missing);
    } else {
      btonDbg("i18n audit: ok (" + used.size + " keys)");
    }
  } catch(e){}
}
function auditI18nKeysDebounced(){
  if (!BTON_DEBUG) return;
  try { clearTimeout(__i18nAuditTimer); } catch(e){}
  __i18nAuditTimer = setTimeout(()=>auditI18nKeys(document), 50);
}
function computeScore(meta) {
      const sum =
        meta.references +
        meta.delivery +
        meta.years +
        meta.financial +
        meta.digital;
      return Math.round(sum / 5);
    }

    /* --- YENÄ° ROZET SÄ°STEMÄ° (SADECE MAVÄ° TÄ°K) --- */
function isCompanyVerified(company){
  try {
    const vs = String(company?.verification_status || "").trim().toLowerCase();

    // Match v19 behavior (admin-approved only):
    // - verification_status: "approved" or "verified"
    // - boolean flags: is_verified / verified / blue_tick (must be real booleans or 1)
    const boolTrue = (x) => (x === true || x === 1 || x === "true" || x === "1");

    return !!(
      (vs === "approved" || vs === "verified") ||
      boolTrue(company?.is_verified) ||
      boolTrue(company?.verified) ||
      boolTrue(company?.blue_tick)
    );
  } catch(e){
    return false;
  }
}

/* === Premium helpers: Verified tooltip + Active recently signal === */
function _verifiedTipText(){
  try {
    const v = (typeof t === "function") ? (t("tip_verified_by_btruston") || "") : "";
    if (v) return v;
  } catch(e) {}
  if (currentLang === "tr") return "BTrustOn tarafÄ±ndan doÄŸrulandÄ±";
  if (currentLang === "es") return "Verificado por BTrustOn";
  return "Verified by BTrustOn";
}

function _getLastActiveDate(company){
  try {
    const c = company || {};
    const raw =
      c.last_active_at || c.last_seen_at || c.last_login_at || c.last_sign_in_at ||
      c.lastActiveAt || c.lastSeenAt || c.lastLoginAt ||
      c.updated_at || c.updatedAt || c.profile_updated_at || c.profileUpdatedAt ||
      null;
    if (!raw) return null;
    const d = new Date(raw);
    if (!Number.isFinite(d.getTime())) return null;
    return d;
  } catch(e) {
    return null;
  }
}

function getActiveRecentlyMark(company, opts){
  try {
    const o = opts || {};
    const d = _getLastActiveDate(company);
    if (!d) return "";
    const ageMs = Date.now() - d.getTime();
    const hasRealLastActive = !!((company||{}).last_active_at || (company||{}).last_seen_at || (company||{}).last_login_at || (company||{}).last_sign_in_at || (company||{}).lastActiveAt || (company||{}).lastSeenAt || (company||{}).lastLoginAt);
    const defaultDays = hasRealLastActive ? 7 : 30;
    const windowMs = (o.windowDays ? Number(o.windowDays) : defaultDays) * 24*60*60*1000;
    if (!Number.isFinite(ageMs) || ageMs < 0 || ageMs > windowMs) return "";

    const label = (typeof t === "function" && t("pill_active")) || (currentLang === "tr" ? "Aktif" : (currentLang === "es" ? "Activo" : "Active"));
    const tipPrefix = (typeof t === "function" && t("tip_last_active")) || (currentLang === "tr" ? "Son aktif: " : (currentLang === "es" ? "Ãšltima actividad: " : "Last active: "));
    const tip = tipPrefix + (typeof timeAgo === "function" ? timeAgo(d.toISOString()) : d.toISOString());
    const tipEsc = (typeof escapeHtml === "function") ? escapeHtml(tip) : tip;

    // Smaller option
    const extra = o.compact ? "px-2 py-1 text-[9px]" : "";
    return `<span class="bton-active-pill bton-tip ${extra}" data-tip="${tipEsc}"><span class="bton-active-dot"></span>${label}</span>`;
  } catch(e) {
    return "";
  }
}

/* Best-effort: touch last_active_at on login (safe even if column doesn't exist) */
async function touchLastActive(session){
  try {
    const nowIso = new Date().toISOString();
    const throttleKey = "bton_last_active_touch_at";
    const last = Number(localStorage.getItem(throttleKey) || "0");
    if (Number.isFinite(last) && (Date.now() - last) < 15*60*1000) return; // 15 min

    const uid = session?.user?.id || session?.user_id || null;
    if (!uid) return;

    const stored = (typeof getMyCompanyId === "function") ? getMyCompanyId() : null;
    const myId = (stored && typeof isUuid === "function" && isUuid(stored)) ? stored : uid;

    try { localStorage.setItem(throttleKey, String(Date.now())); } catch(e) {}

    // Attempt update (ignore errors)
    const res = await supabaseClient
      .from("profiles")
      .update({ last_active_at: nowIso })
      .eq("id", myId);

    if (res?.error) {
      const msg = String(res.error?.message || "");
      // Ignore "column does not exist" etc.
      if (!/does not exist|column|schema cache|pgrst/i.test(msg)) {
        console.warn("touchLastActive error:", msg);
      }
      return;
    }

    // Update caches (best-effort)
    try {
      if (selectedCompany && String(selectedCompany.id) === String(myId)) {
        selectedCompany.last_active_at = nowIso;
      }
    } catch(e) {}
    try {
      if (typeof companiesData !== "undefined" && Array.isArray(companiesData)) {
        const idx = companiesData.findIndex(x => x && String(x.id) === String(myId));
        if (idx > -1) companiesData[idx] = { ...companiesData[idx], last_active_at: nowIso };
      }
    } catch(e) {}
  } catch(e) {}
}

function getTrustBadge(company) {
  if (!isCompanyVerified(company)) return "";
  const tip = (typeof escapeHtml === "function") ? escapeHtml(_verifiedTipText()) : _verifiedTipText();
  return `
    <span class="bg-cyan-50 text-cyan-800 border border-cyan-200 text-[10px] font-extrabold px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm bton-tip" data-tip="${tip}">
      <i class="fa-solid fa-circle-check text-cyan-600"></i>
      <span>${t("badge_verified") || "VERIFIED"}</span>
    </span>
  `;
}


/* --- LIVE SHOWCASE CARD HELPERS --- */
function getVerifiedMark(company){
  if (!isCompanyVerified(company)) return "";
  const tip = (typeof escapeHtml === "function") ? escapeHtml(_verifiedTipText()) : _verifiedTipText();
  return `<span class="bton-tip" data-tip="${tip}"><i class="fa-solid fa-circle-check text-cyan-500 text-[13px] ml-1 align-middle bton-verified-icon"></i></span>`;
}

function getCompanyLogoThumb(company){
  const url = company?.logo_url;
  const name = String(company?.name || "").trim();
  const letter = (name ? name[0].toUpperCase() : "C");
  if (url){
    return `<img src="${url}" alt="Logo" class="w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer">`;
  }
  return `<div class="w-full h-full bg-slate-50 flex items-center justify-center">
            <span class="text-sm font-extrabold text-slate-500">${letter}</span>
          </div>`;
}

// ðŸ‘‡ YENÄ° FONKSÄ°YON: Åžirket Tipine GÃ¶re Rozet Ãœretir ðŸ‘‡
    /* --- GÃœNCELLENMÄ°Åž: getCompanyTypeBadge (YENÄ° TÄ°PLER) --- */
function getCompanyTypeBadge(rawType) {
  const type = (rawType || "company").toLowerCase();
  let label = rawType;
  let icon = "fa-building";
  // VarsayÄ±lan Renk (Gri)
  let colorClass = "bg-gray-50 text-gray-500 border-gray-200";

  // 1. Ãœreticiler (Mor)
  if (type.includes("manufacturer") || type.includes("oem")) {
    label = (t("join_type_manufacturer") || "Manufacturer / OEM");
    icon = "fa-industry";
    colorClass = "bg-purple-50 text-purple-700 border-purple-100";
  } 
  // 2. Ana YÃ¼kleniciler (Turuncu - Koyu)
  else if (type.includes("epc") || type.includes("general contractor")) {
    label = (t("join_type_contractor") || "EPC Contractor");
    icon = "fa-helmet-safety";
    colorClass = "bg-orange-100 text-orange-800 border-orange-200";
  } 
  // 3. Alt YÃ¼kleniciler (Turuncu - AÃ§Ä±k)
  else if (type.includes("subcontractor") || type.includes("specialist")) {
    label = (t("join_type_specialist_sub") || "Subcontractor");
    icon = "fa-screwdriver-wrench";
    colorClass = "bg-orange-50 text-orange-600 border-orange-100";
  }
  // 4. TedarikÃ§iler (Ä°ndigo)
  else if (type.includes("distributor") || type.includes("supplier")) {
    label = (t("join_type_distributor") || "Distributor / Supplier");
    icon = "fa-truck-ramp-box";
    colorClass = "bg-indigo-50 text-indigo-700 border-indigo-100";
  } 
  // 5. Teknoloji (Mavi)
  else if (type.includes("tech") || type.includes("software")) {
    label = (t("join_type_tech") || "Tech & Software");
    icon = "fa-microchip";
    colorClass = "bg-blue-50 text-blue-700 border-blue-100";
  } 
  // 6. MÃ¼hendislik (Cam GÃ¶beÄŸi / Teal)
  else if (type.includes("engineering") || type.includes("consultancy")) {
    label = (t("join_type_engineering_consultancy") || "Engineering & Consult.");
    icon = "fa-drafting-compass";
    colorClass = "bg-teal-50 text-teal-700 border-teal-100";
  }
  // 7. Ä°ÅŸletmeciler / Maden Sahipleri (ZÃ¼mrÃ¼t YeÅŸili)
  else if (type.includes("operator") || type.includes("asset") || type.includes("mining")) {
    label = (t("join_type_operator") || "Operator / Asset Owner");
    icon = "fa-gem";
    colorClass = "bg-emerald-50 text-emerald-700 border-emerald-100";
  }

  return `
    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-[10px] font-bold border ${colorClass} uppercase tracking-wide whitespace-nowrap">
       <i class="fa-solid ${icon}"></i> ${label}
    </span>
  `;
}

    function getScoreLabel(score) {
      if (currentLang === "tr") {
        if (score >= 95) return "MÃœKEMMEL";
        if (score >= 90) return "GÃœÃ‡LÃœ";
        if (score >= 80) return "SAÄžLAM";
        return "GELÄ°ÅžMEKTE";
      } else {
        if (score >= 95) return "EXCELLENT";
        if (score >= 90) return "STRONG";
        if (score >= 80) return "SOLID";
        return "GROWING";
      }
    }

    function sectorToTr(sector) {
  const raw = String(sector || "").trim();
  if (!raw) return "";
  const k = raw.toLowerCase();

  // Prefer i18n keys (so ES and future languages work automatically)
  const lbl =
    t("sector_short_" + k) ||
    t("join_sector_" + k) ||
    t("sec_" + k) ||
    t("sector_" + k);

  if (lbl) return lbl;
  return k.charAt(0).toUpperCase() + k.slice(1);
}

function applyTranslations() {
      // Text / HTML
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        if (el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n");
        if (!key) return;
        const value = t(key);
        if (value) el.innerHTML = value;
      });

      // Placeholders
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
        if (el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-placeholder");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("placeholder", value);
      });

      // Titles / tooltips
      document.querySelectorAll("[data-i18n-title]").forEach((el) => {
        if (el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-title");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("title", value);
      });

      

      // Aria labels (accessibility)
      document.querySelectorAll("[data-i18n-aria]").forEach((el) => {
        if (el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-aria");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("aria-label", value);
      });
const heroTitle = document.getElementById("hero-title");
      const heroDesc = document.getElementById("hero-desc");
      const heroMode = (window && window.__btonHeroMode) ? window.__btonHeroMode : "guest";

      if (heroTitle) {
        const key = (heroMode === "signed_in") ? "hero_title_signed_in" : "hero_title";
        const v = t(key);
        if (v) heroTitle.innerHTML = v;
      }
      if (heroDesc) {
        const v = t("hero_desc");
        if (v) heroDesc.innerHTML = v;
      }

      const searchInput = document.getElementById("search-input");
      if (searchInput) {
        const v = t("search_ph");
        if (v) searchInput.placeholder = v;
      }

      const yearSpan = document.getElementById("year-span");
      if (yearSpan) yearSpan.textContent = nowDate().getFullYear().toString();

      // Dev-only: warn on missing i18n keys
      auditI18nKeysDebounced();
    }

    // Apply i18n translations within a specific DOM subtree (safer for async/dynamic renders)
    function applyTranslationsWithin(root) {
      const scope = root || document;

      // Text / HTML
      scope.querySelectorAll && scope.querySelectorAll("[data-i18n]").forEach((el) => {
        if (el.hasAttribute && el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n");
        if (!key) return;
        const value = t(key);
        if (value) el.innerHTML = value;
      });

      // Placeholders
      scope.querySelectorAll && scope.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
        if (el.hasAttribute && el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-placeholder");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("placeholder", value);
      });

      // Titles / tooltips
      scope.querySelectorAll && scope.querySelectorAll("[data-i18n-title]").forEach((el) => {
        if (el.hasAttribute && el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-title");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("title", value);
      });

      // Aria labels (accessibility)
      scope.querySelectorAll && scope.querySelectorAll("[data-i18n-aria]").forEach((el) => {
        if (el.hasAttribute && el.hasAttribute("data-i18n-skip")) return;
        const key = el.getAttribute("data-i18n-aria");
        if (!key) return;
        const value = t(key);
        if (value) el.setAttribute("aria-label", value);
      });
    }


    // TOP COMPANIES BAND

    // TOP COMPANIES (AKILLI ROTASYON MANTIÄžI)
    function initTopCompaniesOrder() {
      // Verified havuzu (puan yok)
      let qualifiedCompanies = database.filter(company => {
          const trust = String(company?.trust || "").toLowerCase();
          const vs = String(company?.verification_status || "").toLowerCase();
          const isVerified = !!(
            company?.is_verified || company?.verified || company?.blue_tick ||
            vs === "approved" || vs === "verified" ||
            (trust && ["verified", "premium", "global"].includes(trust))
          );
          return isVerified;
      });

      // Havuz kÃ¼Ã§Ã¼kse vitrin boÅŸ kalmasÄ±n
      if (qualifiedCompanies.length < 5) qualifiedCompanies = [...database];

      // Shuffle
      qualifiedCompanies.sort(() => Math.random() - 0.5);

      // Limit
      topCompaniesOrder = qualifiedCompanies.slice(0, 30);
    }

function renderTopCompanies() {
      const container = document.getElementById("top-companies");
      if (!container) return;
      container.innerHTML = "";

      if (!topCompaniesOrder.length) {
}

      // AKILLI LÄ°STELEME MANTIÄžI:
      // EÄŸer veritabanÄ±nda az ÅŸirket varsa (10'dan az), ekran dolsun ve animasyon aksÄ±n diye listeyi Ã§oÄŸaltÄ±yoruz.
      // EÄŸer zaten Ã§ok ÅŸirket varsa, sistemi yormamak iÃ§in olduÄŸu gibi bÄ±rakÄ±yoruz.
      let topList;
      if (topCompaniesOrder.length < 10) {
         const baseTop = topCompaniesOrder.slice(0, 5); // En iyi 5 ÅŸirketi al
         topList = [...baseTop, ...baseTop, ...baseTop, ...baseTop]; // 4 kere arka arkaya ekle
      } else {
         topList = topCompaniesOrder.slice(0, 20); // Zaten Ã§ok varsa ilk 20 tanesi yeter
      }

      topList.forEach((company) => {
        const isVerified = (typeof isCompanyVerified === "function" ? isCompanyVerified(company) : false) || ["verified","premium","global"].includes(String(company?.trust||"").toLowerCase());
        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const card = document.createElement("button");
        // Mobilde ve PC'de dÃ¼zgÃ¼n durmasÄ± iÃ§in geniÅŸlik ayarÄ±
        card.className =
          "min-w-[260px] bg-slate-900 text-white rounded-xl px-4 py-3 flex flex-col justify-between shadow-md hover:shadow-lg hover:-translate-y-0.5 transition transform border border-slate-700/50";
        card.onclick = () => openProfile(company.id);

        card.innerHTML = `
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-[13px] font-bold line-clamp-1 text-cyan-50">
              ${company.name}
            </span>
            ${isVerified ? `<span class="text-[10px] font-extrabold bg-cyan-900/50 text-cyan-200 px-2 py-0.5 rounded-full border border-cyan-800 flex items-center gap-1"><i class="fa-solid fa-circle-check text-[10px]"></i>VERIFIED</span>` : `<span class="text-[10px] font-extrabold bg-slate-800/60 text-slate-200 px-2 py-0.5 rounded-full border border-slate-700">${t("badge_featured") || "FEATURED"}</span>`}
          </div>
          <p class="text-[11px] text-slate-400 line-clamp-2 mb-2 text-left font-light leading-relaxed">
            ${desc}
          </p>
          <div class="flex items-center justify-between mt-auto w-full">
            <span class="flex items-center gap-1.5 text-[10px] text-slate-500">
              <i class="fa-solid fa-location-dot"></i>
              <span class="line-clamp-1 max-w-[80px]">${formatCityCountry(company.city, company.country)}</span>
            </span>
            ${isVerified ? `<span class="text-[10px] font-bold text-cyan-200 flex items-center gap-1"><i class="fa-solid fa-circle-check text-cyan-300"></i>${t("badge_verified") || "Verified"}</span>` : ``}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function rotateTopCompanies() {
      if (!topCompaniesOrder.length) return;
      const first = topCompaniesOrder.shift();
      topCompaniesOrder.push(first);
}

    function startTopAnimations() {
      const container = document.getElementById("top-companies");
      if (!container) return;

      const scrollSpeed = 30; // Kayma hÄ±zÄ± (dÃ¼ÅŸÃ¼k = hÄ±zlÄ±, yÃ¼ksek = yavaÅŸ)

      // --- Ä°Ã‡ FONKSÄ°YON: OYNAT ---
      function playAnimations() {
        // Ã–nce eski zamanlayÄ±cÄ±lar varsa temizle (Ã¼st Ã¼ste binmesin)
        if (topScrollInterval) clearInterval(topScrollInterval);
        if (topRotateInterval) clearInterval(topRotateInterval);

        // 1. KaydÄ±rma (Scroll) BaÅŸlat
        topScrollInterval = setInterval(() => {
          if (!container) return;
          container.scrollLeft += 1; 

          // Sona gelince baÅŸa sar
          if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 1) {
            container.scrollLeft = 0;
          }
        }, scrollSpeed);

        // 2. KartlarÄ± KarÄ±ÅŸtÄ±rma BaÅŸlat (Okurken deÄŸiÅŸmesin diye bunu da durduruyoruz)
        topRotateInterval = setInterval(() => {
          rotateTopCompanies();
        }, 10000);
      }

      // --- Ä°Ã‡ FONKSÄ°YON: DURDUR ---
      function pauseAnimations() {
        if (topScrollInterval) clearInterval(topScrollInterval);
        if (topRotateInterval) clearInterval(topRotateInterval);
      }

      // --- EVENT LISTENERLAR (Olay Dinleyicileri) ---
      // Mouse Ã¼zerine gelince DURDUR
      container.onmouseenter = () => {
        pauseAnimations();
        // KullanÄ±cÄ± durduÄŸunu anlasÄ±n diye cursor stilini deÄŸiÅŸtirebiliriz (opsiyonel)
        container.style.cursor = "paused"; 
      };

      // Mouse gidince DEVAM ET
      container.onmouseleave = () => {
        playAnimations();
        container.style.cursor = "default";
      };

      // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda baÅŸlat
      playAnimations();
    }

    // MAIN GRID

    function renderCards(searchQuery = "") {
      const container = document.getElementById("card-container");
      const resultCount = document.getElementById("result-count");
      if (!container) return;
      container.innerHTML = "";

      const query = (searchQuery || "").toLowerCase().trim();

      let filtered = getSearchableCompanies().filter((company) => {
      if (company.email === ADMIN_EMAIL || company.contact_email === ADMIN_EMAIL) {
        return false; 
      }
        if (currentSector !== "all" && company.sector !== currentSector) {
          return false;
        }

        if (!query) return true;

        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const services =
          currentLang === "tr" && company.services_tr
            ? company.services_tr
            : company.services;

        const haystack = [
          company.name,
          company.city,
          company.sector,
          desc,
          ...(services || []),
          ...(services || []).map(svcDisplayLabel),
        ]
          .join(" ")
          .toLowerCase();

        return haystack.includes(query);
      });

      if (resultCount) {
        resultCount.textContent = `${filtered.length} ${t("results_label")}`;
      }

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.className = "col-span-full";
        const title = (currentLang === "tr")
          ? "SonuÃ§ bulunamadÄ±"
          : (currentLang === "es" ? "No hay resultados" : "No results");
        const desc = (currentLang === "tr")
          ? "Filtreleri geniÅŸletmeyi veya aramayÄ± deÄŸiÅŸtirmeyi deneyin."
          : (currentLang === "es" ? "Prueba ampliar los filtros o cambiar la bÃºsqueda." : "Try widening your filters or changing your search.");
        empty.innerHTML = `
          <div class="bton-empty-card bton-empty-card--soft mx-auto max-w-[620px]">
            <div class="bton-empty-ic"><i class="fa-solid fa-filter"></i></div>
            <div class="min-w-0">
              <div class="bton-empty-title">${title}</div>
              <div class="bton-empty-desc">${desc}</div>
            </div>
          </div>
        `;
        container.appendChild(empty);
        return;
      }

      filtered.forEach((company) => {
        const isVerified = (typeof isCompanyVerified === "function" ? isCompanyVerified(company) : false) || ["verified","premium","global"].includes(String(company?.trust||"").toLowerCase());
        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const services =
          currentLang === "tr" && company.services_tr
            ? company.services_tr
            : company.services;

        const card = document.createElement("div");
        card.className =
          "bg-white/90 border border-gray-100 rounded-2xl p-5 shadow-glass flex flex-col justify-between hover:border-BTrustOn-accent hover:shadow-lg hover:-translate-y-1 transition cursor-pointer";
        card.onclick = () => openProfile(company.id);

        card.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-3">
            <div>
              <h3 class="text-sm font-bold text-BTrustOn-primary mb-0.5 line-clamp-1">
                ${company.name}
              </h3>
              <div class="flex items-center gap-2 text-[11px] text-gray-400 mb-1 min-w-0">
                <span class="truncate">${company.city}</span>
                ${getActiveRecentlyMark(company, { compact: true })}
              </div>
            </div>
            <div class="flex items-center gap-2 justify-end">
              ${getTrustBadge(company)}
              ${company.year_label ? `<span class="text-[10px] font-extrabold px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200 text-slate-600">Est. ${company.year_label}</span>` : ``}
            </div>
          </div>
          <p class="text-xs text-gray-600 mb-3 line-clamp-3">
            ${desc}
          </p>
          <div class="flex flex-wrap gap-1.5 mb-3">
            ${(services || [])
              .slice(0, 3)
              .map(
                (s) => `
              <span class="text-[10px] px-2 py-1 rounded-full bg-slate-50 border border-slate-200 text-slate-600">
                ${svcDisplayLabel(s)}
              </span>
            `
              )
              .join("")}
          </div>
          <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-100">
            <div class="flex items-center gap-2 shrink-0">
              ${getTrustBadge(company)}
            </div>
            <button
              class="text-[11px] font-bold text-BTrustOn-accent flex items-center gap-1"
              type="button"
            >
              <span>${t("btn_view")}</span>
              <i class="fa-solid fa-arrow-right text-[10px]"></i>
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Hafif "canlÄ±lÄ±k": sadece default durumda (tÃ¼m sektÃ¶rler + boÅŸ arama) diziyi shuffle et
    function startGridShuffle() {
      const searchInput = document.getElementById("search-input");

      if (gridShuffleInterval) clearInterval(gridShuffleInterval);

      gridShuffleInterval = setInterval(() => {
        if (!searchInput) return;
        const query = (searchInput.value || "").trim();
        if (query !== "" || currentSector !== "all") {
          return; // kullanÄ±cÄ± filtre kullanÄ±yorsa karÄ±ÅŸmasÄ±n
        }

        // Rastgele hafif karÄ±ÅŸtÄ±r
        database.sort(() => Math.random() - 0.5);
        renderCards("");
      }, 15000); // 15 sn'de bir hafif deÄŸiÅŸim
    }

function filterSector(sector, btnEl) {
      currentSector = sector;

      // 1. ButonlarÄ±n renklerini sÄ±fÄ±rla/ayarla
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.classList.remove("border-BTrustOn-accent", "bg-BTrustOn-accent/10", "text-BTrustOn-accent", "shadow-glow");
        btn.classList.add("border-gray-300", "bg-transparent", "text-gray-500");
      });

      // TÄ±klanan butonu boya
      if (btnEl) {
        btnEl.classList.remove("border-gray-300", "bg-transparent", "text-gray-500");
        btnEl.classList.add("border-BTrustOn-accent", "bg-BTrustOn-accent/10", "text-BTrustOn-accent", "shadow-glow");
      }

      // 2. Arama ve Listeleme MantÄ±ÄŸÄ±
      const searchInput = document.getElementById("search-input");
      const value = searchInput ? searchInput.value : "";
      
      if (sector === "all" && value.trim() === "") {
          isSearchActive = false;
          renderShowcase();
      } else {
          isSearchActive = true;
          renderSearchResults(value);
      }

      // 3) â›” Scroll sabitleme:
      // Dropdown (#sector-filter) onchange -> btnEl gelmiyor.
      // Bu durumda sayfayÄ± otomatik yukarÄ±/aÅŸaÄŸÄ± oynatmayalÄ±m.
      // Sadece Ã¼stteki "chip"/butonlardan tÄ±klanÄ±nca (btnEl varsa) istenirse sonuÃ§lara inebilir.
      if (btnEl) {
        const mainSection = document.querySelector("main");
        if (mainSection) {
          // Biraz gecikmeli: Ã¶nce filtreleme bitsin
          setTimeout(() => {
            mainSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }
      }
    }
    // Status badge renkleri (Available / Under Maintenance / Out of Service)
    function getStatusBadge(baseStatusRaw, displayStatus) {
      const base = (baseStatusRaw || "").toLowerCase();
      const disp = (displayStatus || baseStatusRaw || "").toLowerCase();

      const lang = (typeof __normLangCode === "function") ? __normLangCode(currentLang) : String(currentLang || "en").slice(0,2).toLowerCase();
      const isTR = (lang === "tr");
      const isES = (lang === "es");

      let classes = "bg-slate-50 text-slate-600 border-slate-200";

      // Available / MÃ¼sait / Disponible â†’ Green
      if (base.includes("available") || disp.includes("mÃ¼sait") || disp.includes("disponible")) {
        classes = "bg-emerald-50 text-emerald-700 border-emerald-100";
      }
      // Under Maintenance / bakÄ±m / mantenimiento â†’ Yellow
      else if (
        base.includes("maintenance") ||
        base.includes("maint") ||
        disp.includes("bakÄ±m") ||
        disp.includes("mantenimiento")
      ) {
        classes = "bg-amber-50 text-amber-800 border-amber-100";
      }
      // Out of Service / servis dÄ±ÅŸÄ± / fuera de servicio â†’ Red
      else if (
        base.includes("out of service") ||
        base.includes("oos") ||
        disp.includes("servis dÄ±ÅŸÄ±") ||
        disp.includes("fuera de servicio")
      ) {
        classes = "bg-rose-50 text-rose-700 border-rose-100";
      }

      let label = displayStatus || baseStatusRaw || "";
      try {
        const base2 = (baseStatusRaw || "").toLowerCase();

        // Normalize to stable keys regardless of stored language
        const isAvail = base2.includes("available") || base2.includes("mÃ¼sait") || base2.includes("disponible");
        const isMaint = base2.includes("maintenance") || base2.includes("maint") || base2.includes("bakÄ±m") || base2.includes("mantenimiento");
        const isOut = base2.includes("out of service") || base2.includes("oos") || base2.includes("servis dÄ±ÅŸÄ±") || base2.includes("fuera de servicio");

        if (isAvail) {
          label = (t("asset_status_available") || (isTR ? "MÃ¼sait" : (isES ? "Disponible" : "Available")));
        } else if (isMaint) {
          label = (t("asset_status_maintenance") || (isTR ? "BakÄ±mda" : (isES ? "En mantenimiento" : "Under Maintenance")));
        } else if (isOut) {
          label = (t("asset_status_out") || (isTR ? "Servis dÄ±ÅŸÄ±" : (isES ? "Fuera de servicio" : "Out of Service")));
        }
      } catch(e) {}

      return `
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-extrabold border ${classes}">
          <span class="w-1.5 h-1.5 rounded-full bg-current opacity-60"></span>
          ${label}
        </span>
      `;
    }


/* =========================
   ASSETS UI (Cards + Filters)
   ========================= */
window.__assetUI = window.__assetUI || { query: "", status: "all", sort: "newest" };


function _safeText(s){
  return (s ?? "").toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function _isImageFileName(fn){
  return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test((fn || "").toString());
}
function _assetFileIconClass(fn){
  const f = (fn || "").toString().toLowerCase();
  if (f.endsWith(".pdf")) return "fa-file-pdf";
  if (f.endsWith(".doc") || f.endsWith(".docx")) return "fa-file-word";
  if (f.endsWith(".xls") || f.endsWith(".xlsx") || f.endsWith(".csv")) return "fa-file-excel";
  if (f.endsWith(".ppt") || f.endsWith(".pptx")) return "fa-file-powerpoint";
  if (_isImageFileName(f)) return "fa-image";
  return "fa-file";
}

function _assetFiles(a){
  if(!a) return [];
  const raw = a.files || a.catalog_files || a.attachments || a.docs;
  if(Array.isArray(raw)){
    return raw.map(x => {
      const url = (x && (x.url || x.file_url || x.fileUrl || x.href)) || "";
      const name = (x && (x.name || x.file_name || x.fileName || x.title)) || "";
      return url ? { url, name } : null;
    }).filter(Boolean);
  }
  if(a.file_url){
    return [{ url: a.file_url, name: a.file_name || "" }];
  }
  return [];
}
function _assetPrimaryFile(a){
  const files = _assetFiles(a);
  return files[0] || null;
}


function buildAssetAttachmentPreview(a){
  // Small catalog cover preview (keeps layout stable, avoids random crop)
  const files = _assetFiles(a);
  if (!a || !files.length) return "";

  const primary = files[0];
  const fnRaw = (primary.name || primary.url || "").toString();
  const fn = fnRaw.toLowerCase();
  const urlLower = (primary.url || "").toString().toLowerCase();
  const isImg = _isImageFileName(fn) || _isImageFileName(urlLower);
  const isPdf = fn.endsWith(".pdf") || fn.includes(".pdf?") || urlLower.includes(".pdf");

  // Extension label for non-image covers
  let ext = "";
  try {
    const cleaned = (fnRaw || "").split("?")[0].split("#")[0];
    ext = (cleaned.includes(".") ? cleaned.split(".").pop() : "").toUpperCase();
  } catch(e) { ext = ""; }
  if (!ext || ext.length > 6) ext = (isPdf ? "PDF" : (currentLang === "tr" ? "DOSYA" : "FILE"));

  const urlAttr = _safeText(primary.url || "");
  const titleAttr = _safeText(primary.name || _assetName(a) || (currentLang === "tr" ? "Ek" : "Attachment"));
  const fileNameAttr = _safeText(primary.name || "");

  const assetIdAttr = _safeText(String(a.id ?? ""));
  const cidxAttr = "0";

  const countBadge = files.length > 1
    ? `<span class="absolute -top-2 -right-2 min-w-[20px] h-[20px] px-1 rounded-full bg-slate-900 text-white text-[10px] font-extrabold grid place-items-center shadow">${files.length}</span>`
    : "";

  const baseBtnClass = "js-att-open w-[68px] h-[68px] shrink-0 rounded-xl border border-slate-200 bg-slate-50 shadow-sm transition overflow-hidden opacity-90 group-hover:opacity-100 hover:shadow-md hover:scale-[1.01] relative";

  if (isImg){
    return `
      <button type="button"
         class="${baseBtnClass}"
         data-asset-id="${assetIdAttr}"
         data-cidx="${cidxAttr}"
         data-att-url="${urlAttr}"
         data-att-title="${titleAttr}"
         data-att-filename="${fileNameAttr}"
         title="${_safeText(t("ui_open_catalog") || (currentLang === "tr" ? "KataloÄŸu aÃ§" : "Open catalog"))}">
        <img src="${primary.url}" alt="Attachment" class="w-full h-full object-contain p-2" loading="lazy" />
        ${countBadge}
      </button>
    `;
  }

  // PDF / docs cover
  const coverTone = isPdf ? "text-rose-600 bg-white/70 border-rose-100" : "text-slate-700 bg-white/70 border-slate-200";
  const openText = (t("ui_open") || (currentLang === "tr" ? "AÃ§" : "Open"));
  return `
    <button type="button"
       class="${baseBtnClass} flex flex-col items-center justify-center"
       data-asset-id="${assetIdAttr}"
       data-cidx="${cidxAttr}"
       data-att-url="${urlAttr}"
       data-att-title="${titleAttr}"
       data-att-filename="${fileNameAttr}"
       title="${_safeText(t("ui_open_catalog") || (currentLang === "tr" ? "KataloÄŸu aÃ§" : "Open catalog"))}">
      <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full border text-[10px] font-extrabold ${coverTone}">${_safeText(ext)}</span>
      <span class="mt-1 text-[10px] font-bold text-slate-500">${_safeText(openText)}</span>
      ${countBadge}
    </button>
  `;
}



// Delegated handler for all attachment preview buttons (assets + cards)
if (!window.__attDelegationBound) {
  window.__attDelegationBound = true;
  document.addEventListener("click", (e) => {
    const btn = e.target && e.target.closest ? e.target.closest(".js-att-open") : null;
    if (!btn) return;
    try { e.preventDefault(); e.stopPropagation(); } catch(_){}

    const assetId = btn.getAttribute("data-asset-id");
    const cidx = parseInt(btn.getAttribute("data-cidx") || "0", 10);

    // Asset cards: open catalog viewer (asset modal) instead of single-file viewer
    if (assetId) {
      try {
        openAssetViewer(assetId);
        // After modal renders, jump to index (if supported)
        setTimeout(() => {
          try {
            if (typeof __avSelectCatalogIndex === "function") __avSelectCatalogIndex(cidx);
            else if (window.__avSelectCatalogIndex) window.__avSelectCatalogIndex(cidx);
          } catch(e) {}
        }, 0);
        return;
      } catch (err) {
        console.error("openAssetViewer failed:", err);
        // fallback below
      }
    }

    // Generic attachments (certificates etc.)
    const url = btn.getAttribute("data-att-url") || "";
    const title = btn.getAttribute("data-att-title") || "";
    const fn = btn.getAttribute("data-att-filename") || "";
    if (!url) return;
    try { openAttachmentViewer(url, title, fn); }
    catch (err) {
      console.error("openAttachmentViewer failed:", err);
      try { window.open(url, "_blank", "noopener"); } catch(_){}
    }
  }, true);
}


// Keep a few key UI labels in sync even if some parts render async
function syncLocaleUIBits() {
  try {
    const dot = document.getElementById("home-updates-dot");
    if (dot) applyTranslationsWithin(dot);
  } catch(e) {}
  try {
    const av = document.getElementById("asset-viewer");
    if (av) applyTranslationsWithin(av);
  } catch(e) {}
}


function _assetTime(a){
  const t = Date.parse(a?.updated_at || a?.created_at || "");
  return Number.isFinite(t) ? t : 0;
}
function _assetName(a){
  return (a?.type || a?.item || a?.name || "").toString();
}
function _assetSpec(a){
  return (a?.spec || a?.specs || "").toString();
}
function _assetLoc(a){
  return (a?.location || "").toString();
}
function _assetQty(a){
  const n = parseFloat((a?.qty ?? "").toString().replace(",", "."));
  return Number.isFinite(n) ? n : 0;
}

function _assetFileKind(a){
  const name = (a?.file_name || a?.fileName || "").toString().toLowerCase();
  const url = (a?.file_url || a?.fileUrl || a?.file || "").toString().toLowerCase();
  const src = name || url;
  if (!src) return "";

  const m = src.match(/\.([a-z0-9]{1,10})(?:$|[?#])/i);
  const ext = m ? (m[1] || "").toLowerCase() : "";
  if (!ext) return "";

  const img = ["jpg","jpeg","png","webp","gif","bmp","svg","tif","tiff","heic"];
  const doc = ["doc","docx","rtf","odt"];
  const xls = ["xls","xlsx","csv","ods"];
  const ppt = ["ppt","pptx","odp"];
  const cad = ["dwg","dxf","dgn","stp","step","igs","iges","stl","3dm","rvt","ifc"];
  const zip = ["zip","rar","7z","tar","gz"];

  if (ext === "pdf") return "PDF";
  if (img.includes(ext)) return "IMG";
  if (doc.includes(ext)) return "DOC";
  if (xls.includes(ext)) return "XLS";
  if (ppt.includes(ext)) return "PPT";
  if (cad.includes(ext)) return "CAD";
  if (zip.includes(ext)) return "ZIP";
  if (ext === "txt") return "TXT";
  if (ext.length <= 6) return ext.toUpperCase();

  return "FILE";
}

function _assetNormStatus(s){
  const v = (s || "").toString().toLowerCase().trim();

  // Out of service / disabled (check first so "service dÄ±ÅŸÄ±" doesn't get caught by maintenance)
  if (
    v.includes("out of service") || v.includes("out") ||
    v.includes("offline") || v.includes("off") ||
    v.includes("service dÄ±ÅŸÄ±") || v.includes("servis dÄ±ÅŸÄ±") ||
    v.includes("devre dÄ±ÅŸÄ±") || v.includes("deaktif") ||
    v.includes("disabled") || v.includes("inactive")
  ) return "out";

  // Under maintenance
  if (
    v.includes("maint") || v.includes("maintenance") ||
    v.includes("bakÄ±m") || v.includes("bakim") ||
    v.includes("repair") || v.includes("serviste") ||
    v.includes("servis") ||
    (v.includes("service") && !v.includes("service dÄ±ÅŸÄ±") && !v.includes("servis dÄ±ÅŸÄ±"))
  ) return "maintenance";

  // Available / active
  if (
    v.includes("available") || v.includes("avail") ||
    v.includes("ready") || v.includes("active") ||
    v.includes("mÃ¼sait") || v.includes("musait")
  ) return "available";

  return "other";
}
function _assetStatusRank(s){
  const ns = _assetNormStatus(s);
  if (ns === "available") return 0;
  if (ns === "maintenance") return 1;
  if (ns === "out") return 2;
  return 3;
}

function renderAssetsCards(company, isMyProfile){
  window.__lastAssetsIsMyProfile = !!isMyProfile;
  const grid = document.getElementById("p-assets-grid");
  const empty = document.getElementById("p-assets-empty");
  if (!grid) return;

  const all = Array.isArray(company?.assets) ? [...company.assets] : [];
  const q = (window.__assetUI?.query || "").toLowerCase().trim();
  const st = (window.__assetUI?.status || "all").toLowerCase();
  const sort = (window.__assetUI?.sort || "newest").toLowerCase();

  let arr = all;

  if (q){
    arr = arr.filter(a => {
      const hay = `${_assetName(a)} ${_assetSpec(a)} ${_assetLoc(a)} ${(a?.status||"")}`.toLowerCase();
      return hay.includes(q);
    });
  }

  if (st && st !== "all"){
    arr = arr.filter(a => _assetNormStatus(a?.status) === st);
  }

  // Sort
  if (sort === "az") arr.sort((a,b)=> _assetName(a).localeCompare(_assetName(b)));
  else if (sort === "oldest") arr.sort((a,b)=> _assetTime(a) - _assetTime(b));
  else if (sort === "status") arr.sort((a,b)=> _assetStatusRank(a?.status) - _assetStatusRank(b?.status) || _assetName(a).localeCompare(_assetName(b)));
  else if (sort === "qtydesc") arr.sort((a,b)=> _assetQty(b) - _assetQty(a));
  else arr.sort((a,b)=> _assetTime(b) - _assetTime(a)); // newest default

  grid.innerHTML = "";

  if (!arr.length){
    if (empty) empty.classList.remove("hidden");
    try {
      const cta = document.getElementById("p-assets-empty-cta");
      if (cta) cta.classList.toggle("hidden", !isMyProfile);
    } catch(e) {}
    return;
  } else {
    if (empty) empty.classList.add("hidden");
    try { const cta = document.getElementById("p-assets-empty-cta"); if (cta) cta.classList.add("hidden"); } catch(e) {}
  }

  arr.forEach(a => {

    const __now = Date.now();
    const __cAt = Date.parse(a?.created_at || "");
    const __uAt = Date.parse(a?.updated_at || "");
    const __isNew = Number.isFinite(__cAt) && (__now - __cAt <= 7*24*60*60*1000);
    const __isUpdated = !__isNew && Number.isFinite(__uAt) && (__now - __uAt <= 48*60*60*1000);

    const __recencyText = __isNew
      ? (currentLang === "tr" ? "Yeni" : (currentLang === "es" ? "Nuevo" : "New"))
      : (__isUpdated ? (currentLang === "tr" ? "GÃ¼ncellendi" : (currentLang === "es" ? "Actualizado" : "Updated")) : "");

    const __recencyBadge = __recencyText ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-extrabold ${__isNew ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-slate-50 border-slate-200 text-slate-600'}">${__recencyText}</span>` : "";

    const __fileKind = _assetFileKind(a);
    const __fileKindBadge = __fileKind ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/70 border border-slate-200 text-[10px] font-extrabold text-slate-600" title="${(currentLang === "tr" ? "Dosya" : (currentLang === "es" ? "Archivo" : "File"))}: ${__fileKind}">${__fileKind}</span>` : "";

    const attachmentPreview = buildAssetAttachmentPreview(a);
    const attachmentPreviewInline = attachmentPreview ? `<div class="flex justify-end">${attachmentPreview}</div>` : "";
    const locText = (_assetLoc(a) || "").toString().trim();
    const specRaw = (_assetSpec(a) || "").toString().trim();
    const specText = specRaw ? specRaw : (t("ui_no_specs_provided") || (currentLang === "tr" ? "Ã–zellik belirtilmedi." : "No specs provided."));

    const actions = isMyProfile ? `
      <div class="flex gap-2">
        <button onclick="event.stopPropagation(); openAssetModal(${a.id})" class="w-8 h-8 rounded-lg bg-slate-50 hover:bg-BTrustOn-primary text-slate-700 hover:text-white border border-slate-200 flex items-center justify-center transition shadow-sm" title="${t("ui_edit") || "Edit"}">
          <i class="fa-solid fa-pen text-[10px]"></i>
        </button>
        <button onclick="event.stopPropagation(); deleteAsset(${a.id})" class="w-8 h-8 rounded-lg bg-rose-50 hover:bg-rose-600 text-rose-700 hover:text-white border border-rose-100 flex items-center justify-center transition shadow-sm" title="${t("ui_delete") || "Delete"}">
          <i class="fa-solid fa-trash text-[10px]"></i>
        </button>
      </div>
    ` : ``;


    const viewAction = !isMyProfile ? `
      <button onclick="event.stopPropagation(); openAssetViewer(${a.id})" class="bton-view-hint inline-flex items-center justify-center px-2.5 py-1 rounded-full bg-white/80 border border-slate-200 text-[11px] font-extrabold text-slate-700 hover:bg-cyan-50/50 hover:border-cyan-200 hover:text-BTrustOn-primary" title="${t("ui_view") || (currentLang === "tr" ? "GÃ¶rÃ¼ntÃ¼le" : "View")}">
        ${t("ui_view") || (currentLang === "tr" ? "GÃ¶rÃ¼ntÃ¼le" : "View")}
      </button>
    ` : ``;

    const card = document.createElement("div");
    try{ card.id = _btonEntityDomId('asset', a.id); }catch(e){}
    card.className = "relative group rounded-2xl border border-[rgba(15,23,42,.10)] bg-white/80 backdrop-blur shadow-sm hover:shadow-md hover:border-cyan-200 transition overflow-hidden cursor-pointer";
    card.setAttribute("role","button");
    card.setAttribute("tabindex","0");
    card.onclick = () => openAssetViewer(a.id);
    card.onkeydown = (e) => { if(e.key === "Enter") openAssetViewer(a.id); };

	    card.innerHTML = `
      <div class="bton-accent-line"></div>
      <div class="p-5">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-start gap-3">
              <div class="w-9 h-9 rounded-2xl bg-slate-50/80 border border-slate-200 text-slate-700 shadow-sm flex items-center justify-center shrink-0 transition group-hover:border-cyan-200/70 group-hover:bg-white">
                <i class="fa-solid fa-boxes-stacked text-[13px] opacity-90"></i>
              </div>
              <div class="min-w-0">
                <div class="text-[14px] font-extrabold text-slate-800 leading-snug break-words line-clamp-2 min-h-[2.6rem]">${_safeText(_assetName(a) || "Asset")}</div>
                ${locText ? '<div class="mt-1 text-[11px] text-slate-500 break-words line-clamp-1"><i class="fa-solid fa-location-dot text-[10px] mr-1 text-slate-400"></i>' + _safeText(locText) + '</div>' : ''}
              </div>
            </div>

            <div class="mt-4 rounded-xl bg-slate-50/70 border border-slate-200/70 px-3 py-2.5">
              <div class="flex items-center justify-between gap-2">
              <div class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">${t("th_specs") || "Specs"}</div>
              ${__fileKindBadge}
              </div>
              <div class="mt-1 text-[12px] text-slate-700 font-medium leading-snug whitespace-normal break-words line-clamp-2">${_safeText(specText)}</div>
            </div>
          </div>

          <div class="flex flex-col items-end gap-2 shrink-0">
            <div class="flex items-center gap-2">${getStatusBadge(a.status)}</div>
            ${viewAction}
            <div class="flex items-start gap-2">
              <div class="flex flex-col items-end gap-2">
                <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-white/70 border border-slate-200 text-[11px] font-extrabold text-slate-800">
                <span class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">${t("ui_qty") || "Qty"}</span>
                <span>${(a.qty ?? "-")}</span>
              </span>
                ${attachmentPreviewInline}
              </div>
              ${actions}
            </div>
          </div>
        </div>
      </div>
`;
    grid.appendChild(card);
  });
  try { applyTranslationsWithin(grid); } catch(e) {}
}

function filterAssetsUI(){
  const s = document.getElementById("asset-search");
  const f = document.getElementById("asset-filter-status");
  window.__assetUI = window.__assetUI || {};
  window.__assetUI.query = (s?.value || "");
  window.__assetUI.status = (f?.value || "all");
  // re-render using currently selected company
  try {
    if (selectedCompany) {
      renderAssetsCards(selectedCompany, window.__lastAssetsIsMyProfile);
    }
  } catch(e) {}
}

function sortAssetsUI(mode){
  window.__assetUI = window.__assetUI || {};
  window.__assetUI.sort = mode || "newest";
  try {
    if (selectedCompany) {
      renderAssetsCards(selectedCompany, window.__lastAssetsIsMyProfile);
    }
  } catch(e) {}
}

/* =========================
   ASSET VIEWER MODAL
   ========================= */
let __assetViewerItem = null;
let __avCatalog = null;

function __avCatalogHTML(){
  const openLbl = (t("attachment_open") || (currentLang === "tr" ? "AÃ§" : "Open"));
  const prevLbl = (currentLang === "tr" ? "Ã–nceki" : "Previous");
  const nextLbl = (currentLang === "tr" ? "Sonraki" : "Next");
  const pna = (t("attachment_preview_not_available") || "Preview not available");
  const pnt = (t("attachment_to_view_new_tab") || "Use Open to view this file in a new tab.");
  return `
    <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
      <div class="relative bg-slate-50 aspect-[16/10] overflow-hidden" id="av-cat-stage">
        <img id="av-cat-img" class="hidden w-full h-full object-contain select-none" draggable="false" />
        <iframe id="av-cat-frame" class="hidden w-full h-full" title="Preview"></iframe>
        <div id="av-cat-fallback" class="hidden absolute inset-0 flex items-center justify-center p-6">
          <div class="bg-white/90 border border-slate-200 rounded-2xl p-5 shadow-glass text-center max-w-sm">
            <div class="w-11 h-11 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center mx-auto mb-3">
              <i class="fa-solid fa-file text-slate-500"></i>
            </div>
            <div class="text-sm font-extrabold text-slate-800 mb-1">${pna}</div>
            <div class="text-xs text-slate-500">${pnt}</div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-between gap-2 px-3 py-2 border-t border-slate-100">
        <div class="min-w-0 text-[11px] text-slate-600 font-semibold truncate" id="av-cat-caption"></div>
        <div class="flex items-center gap-2 shrink-0">
          <button type="button" id="av-cat-open" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white transition text-xs font-bold">
            <i class="fa-solid fa-arrow-up-right-from-square text-[12px]"></i>
            <span class="hidden sm:inline">${openLbl}</span>
          </button>
          <button type="button" id="av-cat-prev" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition grid place-items-center" aria-label="${prevLbl}" title="${prevLbl}">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <button type="button" id="av-cat-next" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition grid place-items-center" aria-label="${nextLbl}" title="${nextLbl}">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="mt-2 flex items-center gap-2 overflow-x-auto pb-1" id="av-cat-thumbs"></div>
  `;
}

function __avGuessKind(url, name){
  try{
    if(typeof __attachmentKind === "function"){
      let k = __attachmentKind(url, name);
      if(k && k !== "other") return k;
    }
  }catch(e){}
  const lower = (name || url || "").toString().toLowerCase();
  if (typeof _isImageFileName === "function" && _isImageFileName(lower)) return "image";
  if (lower.includes(".pdf")) return "pdf";
  return "pdf";
}

function __avRenderCatalog(idx){
  if(!__avCatalog || !Array.isArray(__avCatalog.files) || !__avCatalog.files.length) return;
  const files = __avCatalog.files;
  const total = files.length;

  let i = idx;
  if(i < 0) i = total - 1;
  if(i >= total) i = 0;
  __avCatalog.idx = i;

  const item = files[i];
  const url = item && item.url ? item.url : "";
  const name = (item && item.name ? item.name : ("File " + (i + 1)));
  const kind = __avGuessKind(url, name);

  const img = document.getElementById("av-cat-img");
  const frame = document.getElementById("av-cat-frame");
  const fb = document.getElementById("av-cat-fallback");
  const caption = document.getElementById("av-cat-caption");
  const thumbs = document.getElementById("av-cat-thumbs");

  if(caption) caption.textContent = `${name} (${i + 1}/${total})`;
  try{ if(fb) fb.classList.add("hidden"); }catch(_){}

  if(kind === "image"){
    if(frame){ frame.classList.add("hidden"); try{ frame.src = "about:blank"; }catch(_e){} }
    if(img){
      img.classList.remove("hidden");
      img.onerror = () => { try{ img.onerror = null; }catch(e){} try{ if(fb) fb.classList.remove("hidden"); }catch(_e){} };
      img.src = url;
    }
  } else {
    if(img){ img.classList.add("hidden"); img.src = ""; }
    if(frame){
      frame.classList.remove("hidden");
      let loaded = false;
      const onLoad = () => { loaded = true; try{ if(fb) fb.classList.add("hidden"); }catch(e){} };
      frame.addEventListener("load", onLoad, { once: true });
      frame.src = url;

      setTimeout(() => {
        try{ if(!loaded && fb) fb.classList.remove("hidden"); }catch(e){}
      }, 1800);
    }
  }

  if(thumbs){
    thumbs.innerHTML = files.map((f, j) => {
      const nm = (f && f.name ? f.name : "");
      const k = __avGuessKind(f.url, nm);
      const active = (j === i) ? "border-slate-900" : "border-slate-200";
      if(k === "image"){
        return `
          <button type="button" onclick="__avSelectCatalogIndex(${j})" class="shrink-0 w-14 h-14 rounded-xl border ${active} overflow-hidden bg-white">
            <img src="${_safeText(f.url)}" class="w-full h-full object-cover" loading="lazy" />
          </button>
        `;
      }
      const label = (nm || "").toLowerCase().includes(".pdf") ? "PDF" : (_assetFileKind({ file_url: f.url, file_name: nm }) || "FILE");
      const icon = (label === "PDF") ? "fa-file-pdf text-rose-400" : "fa-file text-slate-500";
      return `
        <button type="button" onclick="__avSelectCatalogIndex(${j})" class="shrink-0 w-14 h-14 rounded-xl border ${active} bg-white flex flex-col items-center justify-center gap-1">
          <i class="fa-solid ${icon} text-[18px]"></i>
          <span class="text-[9px] font-extrabold text-slate-600">${label}</span>
        </button>
      `;
    }).join("");
  }
}

function __avStepCatalog(delta){
  if(!__avCatalog) return;
  __avRenderCatalog(__avCatalog.idx + delta);
}

function __avOpenCurrentInAttachmentViewer(){
  if(!__avCatalog) return;
  const item = __avCatalog.files[__avCatalog.idx];
  if(!item || !item.url) return;
  openAttachmentViewer(item.url, (item.name || "Attachment"), (item.name || ""));
}

function __avSelectCatalogIndex(idx){
  __avRenderCatalog(idx);
}
window.__avSelectCatalogIndex = __avSelectCatalogIndex;

function openAssetViewer(assetId){

  const company = selectedCompany;
  const a = (company?.assets || []).find(x => String(x.id) === String(assetId));
  if (!a) return;

  __assetViewerItem = a;

  const m = document.getElementById("asset-viewer");
  if (!m) return;

  document.getElementById("av-title").textContent = _assetName(a) || "Asset";
  document.getElementById("av-meta").textContent = _assetLoc(a) || "";
  document.getElementById("av-status").innerHTML = getStatusBadge(a.status);
  document.getElementById("av-spec").textContent = _assetSpec(a) || (t("ui_no_specs_provided") || (currentLang === "tr" ? "Ã–zellik belirtilmedi." : "No specs provided."));
  document.getElementById("av-qty").textContent = (a.qty ?? "-");
  document.getElementById("av-updated").textContent = a.updated_at ? new Date(a.updated_at).toLocaleString((currentLang === "tr") ? "tr-TR" : "en-US", {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}) : "-";

  const fileWrap = document.getElementById("av-file");
  if (fileWrap) {
    const files = _assetFiles(a);

    if (files.length) {
      fileWrap.innerHTML = __avCatalogHTML();
      __avCatalog = { files: files, idx: 0 };

      // bind controls
      const prev = document.getElementById("av-cat-prev");
      const next = document.getElementById("av-cat-next");
      const openBtn = document.getElementById("av-cat-open");

      if (prev) prev.onclick = (ev) => { try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){ } __avStepCatalog(-1); };
      if (next) next.onclick = (ev) => { try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){ } __avStepCatalog(1); };
      if (openBtn) openBtn.onclick = (ev) => { try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){ } __avOpenCurrentInAttachmentViewer(); };

      __avRenderCatalog(0);
    } else {
      __avCatalog = null;
      fileWrap.innerHTML = `<div class="text-[11px] text-gray-400">${(t("ui_no_document_attached") || (currentLang === "tr" ? "Ekli belge yok." : "No document attached."))}</div>`;
    }
  }

  m.classList.remove("hidden");
  try { applyTranslationsWithin(m); } catch(e) {}
}

function closeAssetViewer(){
  const m = document.getElementById("asset-viewer");
  if (m) m.classList.add("hidden");
  __assetViewerItem = null;
  __avCatalog = null;
}




/* --- GÃœNCELLENMÄ°Åž: renderCertificates (RENKLÄ° BUTONLAR) --- */

/* --- CERTIFICATE UI STATE (filter + search) --- */
window.__certUI = window.__certUI || { filter: "all", q: "", bound: false };

function _certParseDate(d) {
  try {
    if (!d) return null;
    // Support YYYY-MM-DD
    const s = String(d).trim();
    if (!s) return null;
    const dt = new Date(s.length <= 10 ? (s + "T00:00:00") : s);
    return isNaN(dt.getTime()) ? null : dt;
  } catch(e) { return null; }
}

function _certStatus(expiryDate) {
  const dt = _certParseDate(expiryDate);
  if (!dt) return "unknown";
  const today = nowDate();
  today.setHours(0,0,0,0);
  dt.setHours(0,0,0,0);
  return (dt < today) ? "expired" : "valid";
}

function _certDaysLeft(expiryDate) {
  const dt = _certParseDate(expiryDate);
  if (!dt) return null;
  const today = nowDate();
  today.setHours(0,0,0,0);
  dt.setHours(0,0,0,0);
  const diff = Math.round((dt.getTime() - today.getTime()) / (1000*60*60*24));
  return diff;
}

function _bindCertControlsOnce() {
  if (window.__certUI.bound) return;
  const controls = document.getElementById("cert-controls");
  if (!controls) return;

  // Filter buttons
  controls.querySelectorAll(".cert-filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      window.__certUI.filter = btn.getAttribute("data-filter") || "all";
      // Visual active state (premium)
      controls.querySelectorAll(".cert-filter-btn").forEach(b => {
        b.classList.remove("bg-cyan-50", "border-cyan-200", "text-BTrustOn-primary", "shadow-md", "ring-1", "ring-cyan-100");
        try { b.setAttribute("aria-pressed", "false"); } catch(_) {}
      });
      btn.classList.add("bg-cyan-50", "border-cyan-200", "text-BTrustOn-primary", "shadow-md", "ring-1", "ring-cyan-100");
      try { btn.setAttribute("aria-pressed", "true"); } catch(_) {}
try { if (selectedCompany) renderCertificates(selectedCompany); } catch(e) {}
    });
  });

  // Search
  const search = document.getElementById("cert-search");
  if (search) {
    search.addEventListener("input", () => {
      window.__certUI.q = (search.value || "").toLowerCase();
      try { if (selectedCompany) renderCertificates(selectedCompany); } catch(e) {}
    });
  }

  // Mark bound BEFORE triggering default click (prevents recursion)
  window.__certUI.bound = true;

  // Default active
  const first = controls.querySelector('.cert-filter-btn[data-filter="all"]');
  if (first) first.click();
}

/* --- Enhanced Certificates Renderer (filters + preview + better cards) --- */
function renderCertificates(company) {
  const certList = document.getElementById("p-certs-list");
  const btnAddCert = document.getElementById("btn-add-cert");
  const myId = localStorage.getItem("BTrustOn_my_company_id");
  const isOwner = (myId && String(company.id) === String(myId));

  // Owner-only: add button visible
  if (btnAddCert) {
    if (isOwner) btnAddCert.classList.remove("hidden-view");
    else btnAddCert.classList.add("hidden-view");
  }

  // Bind filter/search UI once
  _bindCertControlsOnce();

  if (!certList) return;
  certList.innerHTML = "";

  const raw = company.certificates || [];
  const q = (window.__certUI.q || "").trim();
  const mode = window.__certUI.filter || "all";

  // Normalize into objects
  let certs = raw.map(c => {
    if (typeof c === "string") {
      return { id: -1, name: c, issuer: "", expiry_date: null, file_url: null };
    }
    return {
      id: (c && typeof c.id !== "undefined") ? c.id : -1,
      name: c?.name || "",
      issuer: c?.issuer || "",
      expiry_date: c?.expiry_date || null,
      file_url: c?.file_url || null,
      file_name: c?.file_name || c?.fileName || null,
      created_at: c?.created_at || c?.createdAt || c?.issued_at || c?.issuedAt || c?.issue_date || c?.issueDate || null,
      updated_at: c?.updated_at || null,
    };
  }).filter(c => String(c.name || "").trim() !== "");

  // Filter
  certs = certs.filter(c => {
    const status = _certStatus(c.expiry_date);
    const hasDoc = !!c.file_url;

    if (mode === "valid" && status !== "valid") return false;
    if (mode === "expired" && status !== "expired") return false;
    if (mode === "docs" && !hasDoc) return false;

    if (q) {
      const hay = (String(c.name || "") + " " + String(c.issuer || "")).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // Sort: valid soonest first, unknown last, expired last (most recent expired first)
  certs.sort((a, b) => {
    const sa = _certStatus(a.expiry_date);
    const sb = _certStatus(b.expiry_date);
    if (sa !== sb) {
      const order = { valid: 0, unknown: 1, expired: 2 };
      return (order[sa] ?? 9) - (order[sb] ?? 9);
    }
    const da = _certParseDate(a.expiry_date);
    const db = _certParseDate(b.expiry_date);
    if (da && db) {
      if (sa === "valid") return da - db;         // soonest
      if (sa === "expired") return db - da;       // most recently expired
      return db - da;
    }
    if (da && !db) return -1;
    if (!da && db) return 1;
    return String(a.name).localeCompare(String(b.name));
  });

  if (certs.length === 0) {
    // Keep layout aligned with the filters above
    certList.className = "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4";

    const emptyTitle = (typeof t === "function") ? t("no_certs_found_title") : "No certificates found";
    const emptyDesc  = (typeof t === "function") ? t("no_certs_found_desc")  : "This company hasnâ€™t listed any certificates yet.";

    certList.innerHTML = `
      <div class="col-span-full">
        <div class="rounded-2xl border border-dashed border-[rgba(15,23,42,.14)] bg-gradient-to-b from-white/70 to-slate-50/60 p-6">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-white border border-[rgba(15,23,42,.10)] shadow-sm flex items-center justify-center text-slate-500 shrink-0">
              <i class="fa-solid fa-certificate"></i>
            </div>
            <div class="min-w-0">
              <div class="text-[12px] font-extrabold text-slate-700 tracking-wide">${emptyTitle}</div>
              <div class="mt-1 text-[11px] text-slate-500 font-semibold">${emptyDesc}</div>
            </div>
          </div>
        </div>
      </div>`;
    return;
  }

  // Responsive grid
  certList.className = "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4";

  certs.forEach((cert) => {
    const name = cert.name;
    const issuer = cert.issuer || (t("ui_unknown_issuer") || "Unknown issuer");
    const date = cert.expiry_date;
    const fileUrl = cert.file_url;
    const id = cert.id;

    const status = _certStatus(date);
    const daysLeft = _certDaysLeft(date);

    // Status badge (Valid / Expiring soon / Expired)
    const _certLbl = (key, en, tr, es) => {
      try { const v = (typeof t === "function") ? t(key) : null; if (v) return v; } catch(_) {}
      return (currentLang === "tr") ? tr : (currentLang === "es" ? es : en);
    };
    const _lblValid    = _certLbl("cert_badge_valid", "Valid", "GeÃ§erli", "VÃ¡lido");
    const _lblExpSoon  = _certLbl("cert_badge_expiring", "Expiring soon", "SÃ¼resi dolmak Ã¼zere", "PrÃ³ximo a caducar");
    const _lblExpired  = _certLbl("cert_badge_expired", "Expired", "SÃ¼resi doldu", "Caducado");
    const _lblNoExpiry = (() => {
      try { const v = (typeof t === "function") ? (t("ui_no_expiry") || t("cert_badge_no_expiry")) : null; if (v) return v; } catch(_) {}
      return (currentLang === "tr") ? "Son kullanma yok" : (currentLang === "es" ? "Sin caducidad" : "No expiry");
    })();

    let statusBadge = "";
    if (status === "valid") {
      const warn = (typeof daysLeft === "number" && daysLeft <= 30);
      statusBadge = `
        <span class="inline-flex items-center gap-1 ${warn ? "bg-amber-50 text-amber-700 border-amber-100" : "bg-emerald-50 text-emerald-700 border-emerald-100"} text-[9px] font-extrabold px-2 py-1 rounded-lg border uppercase">
          <i class="fa-solid ${warn ? "fa-triangle-exclamation" : "fa-circle-check"}"></i>
          ${warn ? _lblExpSoon : _lblValid}
        </span>`;
    } else if (status === "expired") {
      statusBadge = `
        <span class="inline-flex items-center gap-1 bg-red-50 text-red-700 text-[9px] font-extrabold px-2 py-1 rounded-lg border border-red-100 uppercase">
          <i class="fa-solid fa-circle-exclamation"></i> ${_lblExpired}
        </span>`;
    } else {
      statusBadge = `
        <span class="inline-flex items-center gap-1 bg-slate-50 text-slate-600 text-[9px] font-extrabold px-2 py-1 rounded-lg border border-slate-200 uppercase">
          <i class="fa-solid fa-circle-question"></i> ${_lblNoExpiry}
        </span>`;
    }

    // File kind badge (PDF / IMG / DOCâ€¦)
    const __kind = fileUrl ? _assetFileKind({ file_url: fileUrl, file_name: cert.file_name || "" }) : "";
    const fileTypeBadge = __kind ? `
      <span class="inline-flex items-center px-2 py-1 rounded-lg border border-slate-200 bg-white/70 text-slate-600 text-[9px] font-extrabold uppercase tracking-wide">${__kind}</span>`
      : "";

    // File preview icon
    let thumb = `
      <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-slate-50 to-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-slate-400">
        <i class="fa-solid fa-certificate text-lg"></i>
      </div>`;
    if (fileUrl) {
      const lower = String(fileUrl).toLowerCase();
      const isImg = lower.endsWith(".png") || lower.endsWith(".jpg") || lower.endsWith(".jpeg") || lower.endsWith(".webp");
      if (isImg) {
        thumb = `
          <div class="w-12 h-12 rounded-2xl overflow-hidden border border-gray-200 shadow-sm shrink-0 bg-white">
            <img src="${fileUrl}" class="w-full h-full object-cover">
          </div>`;
      } else {
        thumb = `
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-50 to-white border border-blue-100 flex items-center justify-center shrink-0 shadow-sm text-blue-600">
            <i class="fa-solid fa-file-lines text-lg"></i>
          </div>`;
      }
    }

    const meta = date
      ? `<span class="inline-flex items-center gap-2 text-[10px] text-gray-400">
           <i class="fa-regular fa-calendar"></i>
           Exp: <span class="font-bold text-gray-600">${date}</span>
           ${typeof daysLeft === "number" ? `<span class="text-gray-300">â€¢</span><span class="font-bold ${daysLeft < 0 ? "text-red-600" : (daysLeft <= 30 ? "text-amber-700" : "text-emerald-700")}">${(daysLeft < 0 ? (t("ui_days_ago") || "{n}d ago") : (t("ui_days_left") || "{n}d left")).replace("{n}", Math.abs(daysLeft))}</span>` : ``}
         </span>`
      : `<span class="inline-flex items-center gap-2 text-[10px] text-gray-400"><i class="fa-regular fa-calendar"></i> ${t("ui_expiry") || "Expiry"}: <span class="font-bold text-gray-600">${t("ui_not_provided") || "Not provided"}</span></span>`;

    // Issued micro timestamp (small, helpful)
    const _lblIssued = (typeof t === "function" ? t("ui_issued") : null) || (currentLang === "tr" ? "DÃ¼zenlendi" : (currentLang === "es" ? "Emitido" : "Issued"));

    let __issuedTs = Date.parse(cert.created_at || "");
    if (!Number.isFinite(__issuedTs)) {
      const __idn = Number(cert.id);
      if (Number.isFinite(__idn) && __idn > 100000000000) __issuedTs = __idn; // ms timestamp ids
    }

    const __fmtDate = (ts) => {
      try {
        const loc = (currentLang === "tr") ? "tr-TR" : (currentLang === "es" ? "es-ES" : "en-US");
        return new Date(ts).toLocaleDateString(loc, { year: "numeric", month: "2-digit", day: "2-digit" });
      } catch(e) { return ""; }
    };

    const issuedTxt = Number.isFinite(__issuedTs) ? __fmtDate(__issuedTs) : "";
    const stampHtml = issuedTxt
      ? `<div class="mt-2 text-[10px] text-gray-400 font-semibold">${_lblIssued}: <span class="font-bold text-gray-600">${issuedTxt}</span></div>`
      : "";

    // Actions
    const viewBtn = fileUrl
      ? `<button type="button" data-action="view-doc" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/80 backdrop-blur border border-[rgba(15,23,42,.12)] text-slate-700 text-[11px] font-extrabold hover:bg-BTrustOn-accent hover:text-white hover:border-BTrustOn-accent transition shadow-sm" title="${t("ui_view_document") || "View document"}">
           <i class="fa-solid fa-arrow-up-right-from-square"></i> ${t("btn_view") || "View"} </button>`
      : `<button type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 text-slate-400 text-[11px] font-extrabold cursor-not-allowed" title="${t("ui_no_document_attached") || "No document attached"}">
           <i class="fa-regular fa-file"></i> ${t("btn_view") || "View"} </button>`;
const ownerActions = isOwner ? `
      <div class="flex gap-2">
        <button type="button" onclick="openCertModal(${id})" class="w-9 h-9 rounded-xl bg-cyan-50 text-BTrustOn-accent border border-cyan-100 hover:bg-BTrustOn-accent hover:text-white flex items-center justify-center transition shadow-sm" title="${t("ui_edit") || "Edit"}">
          <i class="fa-solid fa-pen text-[11px]"></i>
        </button>
        <button type="button" onclick="deleteCert(${id}, '${String(name).replace(/'/g, "\\'")}')" class="w-9 h-9 rounded-xl bg-red-50 text-red-600 border border-red-100 hover:bg-red-600 hover:text-white flex items-center justify-center transition shadow-sm" title="${t("ui_delete") || "Delete"}">
          <i class="fa-solid fa-trash text-[11px]"></i>
        </button>
      </div>
    ` : ``;

        const nameTitle = String(name || "").replace(/"/g, "&quot;");

const card = document.createElement("div");
    try{ card.id = _btonEntityDomId('cert', id); }catch(e){}
    card.className = "relative bg-gradient-to-b from-white/92 to-slate-50/70 backdrop-blur border border-[rgba(15,23,42,.08)] rounded-2xl p-5 shadow-sm hover:shadow-lg hover:-translate-y-[1px] hover:border-[rgba(6,182,212,.28)] transition group overflow-hidden";

    card.innerHTML = `
      <div class="bton-accent-line"></div>
      <div class="flex items-start gap-4">
        ${thumb}
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="min-w-0 flex-1 text-sm font-extrabold text-gray-800 truncate" title="${nameTitle}">${name}</div>
            <div class="shrink-0 flex items-center gap-2 flex-wrap justify-end">
              ${statusBadge}
              ${fileTypeBadge}
            </div>
          </div>
          <div class="text-[11px] text-gray-500 font-semibold truncate mt-0.5">${issuer}</div>
          <div class="mt-2">${meta}</div>
          ${stampHtml}
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between gap-3">
        ${viewBtn}
        ${ownerActions}
      </div>
    `;

    // View button opens in-page attachment viewer (no new tab) + keeps scroll
    try{
      const __viewBtn = card.querySelector('[data-action="view-doc"]');
      if(__viewBtn && fileUrl){
        __viewBtn.addEventListener('click', (e) => {
          try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
          openAttachmentViewer(fileUrl, name || "Certificate", (cert.file_name || cert.file_url || ""));
        });
      }
    }catch(e){}

    // If card is clicked and has file, open
    if (fileUrl) {
      card.classList.add("cursor-pointer");
      card.addEventListener("click", (e) => {
        e.stopPropagation();
        if (e.target.closest("button") || e.target.closest("a")) return;
        openAttachmentViewer(fileUrl, name || "Certificate", (cert.file_name || cert.file_url || ""));
      });
}

    certList.appendChild(card);
  });
}


/* --- YENÄ°: PROFÄ°L ANALÄ°TÄ°ÄžÄ° SÄ°STEMÄ° (GÃœNDE 1 KEZ SAYMA) --- */

// 1. ZÄ°YARETÄ° KAYDET (SPAM KORUMALI)
async function trackProfileView(targetProfileId) {
  return btonWithLock("trackProfileView:"+String(targetProfileId), async () => {
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const user = sessionData?.session?.user || null;

    // âœ… Admin kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼lediÄŸinde analitiÄŸe hiÃ§ yazma / sayma
    if (user && (typeof ADMIN_EMAIL !== "undefined") && user.email === ADMIN_EMAIL) return;

    // B. SPAM KONTROLÃœ (LOCAL STORAGE) â€” gÃ¼nde 1 kere
    const today = nowDate().toISOString().split('T')[0];
    const storageKey = `BTrustOn_view_${targetProfileId}_${today}`;

    if (localStorage.getItem(storageKey)) {
      console.log("Bu profile bugÃ¼n zaten bakÄ±ldÄ±, sayaÃ§ artÄ±rÄ±lmadÄ±.");
      return;
    }

    // C. Viewer company (claim-aware) + self-view guard
    let viewerCompanyId = null;
    let guestId = null;

    if (user) {
      // Resolve active viewer company (claim-aware, robust)
      try {
        if (typeof btonResolveCompanyByOwnerId === "function") {
          const best = await btonResolveCompanyByOwnerId(user.id);
          if (best && best.id) {
            viewerCompanyId = best.id;
            try { localStorage.setItem("BTrustOn_my_company_id", String(best.id)); } catch(e) {}
          }
        }
      } catch(e) {}

      // Fallback: cached my company fetcher, then localStorage, then auth uid
      if (!viewerCompanyId) {
        try {
          if (typeof btonGetMyCompanyProfileFresh === "function") {
            const my = await btonGetMyCompanyProfileFresh(false);
            if (my && my.id) viewerCompanyId = my.id;
          }
        } catch(e) {}
      }

      if (!viewerCompanyId) {
        try { viewerCompanyId = (typeof myCompanyIdOr === "function") ? myCompanyIdOr(user.id) : user.id; } catch(e) { viewerCompanyId = user.id; }
      }

      // Self-view (company-to-company)
      if (viewerCompanyId && String(viewerCompanyId) === String(targetProfileId)) return;
      // Legacy self-view fallback
      if (String(user.id) === String(targetProfileId)) return;
    } else {
      // Guest id (tarayÄ±cÄ±da kalÄ±cÄ±)
      guestId = localStorage.getItem("BTrustOn_guest_id");
      if (!guestId) {
        guestId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ("g_" + Date.now() + "_" + Math.random().toString(16).slice(2));
        localStorage.setItem("BTrustOn_guest_id", guestId);
      }
    }

    // âœ… DBâ€™ye dÃ¼ÅŸÃ¼r (RPC) â€” supports new param p_viewer_profile_id (claim aware)
    let rpcRes = null;
    try {
      const args = { p_profile_id: targetProfileId, p_guest_fingerprint: user ? null : guestId };
      if (user && viewerCompanyId) args.p_viewer_profile_id = viewerCompanyId;

      rpcRes = await supabaseClient.rpc('track_profile_view', args);

      if (rpcRes?.error) {
        // If DB function is not updated to accept p_viewer_profile_id, we MUST stop here (otherwise viewer will look like the legacy user)
        const msg = String(rpcRes.error.message || rpcRes.error.details || "").toLowerCase();
        const code = String(rpcRes.error.code || "");
        const looksLikeParamMismatch =
          msg.includes("p_viewer_profile_id") || msg.includes("does not exist") || msg.includes("unknown") ||
          code === "42883" || code === "PGRST202";

        if (looksLikeParamMismatch) {
          try {
            showToast(
              "DB function missing",
              "Update Supabase RPC track_profile_view to accept p_viewer_profile_id (claim-aware viewer).",
              "warning"
            );
          } catch(_) {}
        }
      }
    } catch (e) {
      rpcRes = { error: e };
    }

    if (rpcRes && rpcRes.error) {
      console.warn('trackProfileView upsert failed:', rpcRes.error);
      return;
    }

    // D. BaÅŸarÄ±lÄ±ysa TarayÄ±cÄ±ya "BugÃ¼n BaktÄ±" Ä°ÅŸaretini Koy
    try { localStorage.setItem(storageKey, "true"); } catch(e) {}
    console.log("Yeni ziyaret kaydedildi.");
  }, { ttlMs:10000 });
}


/* --- UI Helper: refresh analytics Pro pill/button (no page refresh) --- */
function refreshAnalyticsPlanUI() {
  try {
    const isPro = !!(selectedCompany && String(selectedCompany.subscription_tier || "free").toLowerCase() === "pro");
    const upgradeBtn = document.getElementById("btn-card-upgrade");
    const proPill = document.getElementById("card-pro-pill");
    if (upgradeBtn) {
      if (isPro) upgradeBtn.classList.add("hidden");
      else upgradeBtn.classList.remove("hidden");
    }
    if (proPill) {
      if (isPro) proPill.classList.remove("hidden");
      else proPill.classList.add("hidden");
    }
  } catch(_) {}
}

// 2. Ä°STATÄ°STÄ°KLERÄ° Ã‡EK VE GÃ–STER
async function loadProfileAnalytics(profileId) {
    // A. UI SÄ±fÄ±rla (YÃ¼kleniyor...)
    const partnerCountEl = document.getElementById("stat-partner-count");
    const guestCountEl = document.getElementById("stat-guest-count");
    const listContainer = document.getElementById("stat-partner-list");
    if (partnerCountEl) partnerCountEl.textContent = "-";
    if (guestCountEl) guestCountEl.textContent = "-";
    if (listContainer) listContainer.innerHTML = '<div class="p-3 text-center"><i class="fa-solid fa-spinner fa-spin text-cyan-500"></i></div>';

    // B. Pro kontrolÃ¼ (kimin baktÄ±ÄŸÄ± listesi sadece Pro)
    const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
    const upgradeBtn = document.getElementById("btn-card-upgrade");
    if (upgradeBtn) {
        if (isPro) upgradeBtn.classList.add("hidden");
        else upgradeBtn.classList.remove("hidden");
    }

    
const proPill = document.getElementById("card-pro-pill");
if (proPill) {
    if (isPro) proPill.classList.remove("hidden");
    else proPill.classList.add("hidden");
}
// C. Tarih HesabÄ± (Son 90 GÃ¼n)
    const ninetyDaysAgo = nowDate();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

    // D. Verileri Ã‡ek
    const { data: views, error } = await supabaseClient
        .from('profile_views')
        .select('viewer_id, viewed_at')
        .eq('profile_id', profileId)
        .gte('viewed_at', ninetyDaysAgo.toISOString())
        .order('viewed_at', { ascending: false });

    if (error || !views) {
        console.error("Analytics Error:", error);
        if (partnerCountEl) partnerCountEl.textContent = "0";
        if (guestCountEl) guestCountEl.textContent = "0";
        if (listContainer) listContainer.innerHTML = '<div class="p-3 text-center text-[10px] text-gray-400">No data.</div>';
        return;
    }

    // E. Admin'i filtrele (eski kayÄ±tlar dahil)
    let adminProfileId = null;
    try { adminProfileId = await getAdminProfileId(); } catch(e) { adminProfileId = null; }

    const filteredViews = (views || []).filter(v => {
        if (!v) return false;
        if (adminProfileId && v.viewer_id && String(v.viewer_id) === String(adminProfileId)) return false;
        return true;
    });

    // F. AyrÄ±ÅŸtÄ±r (Partner vs Guest) + Partner'da son gÃ¶rÃ¼ntÃ¼leme tarihini tut
    let guestCount = 0;
    const partnerMap = new Map(); // viewer_id -> most recent viewed_at

    filteredViews.forEach(v => {
        if (v.viewer_id) {
            if (!partnerMap.has(v.viewer_id)) {
                partnerMap.set(v.viewer_id, v.viewed_at); // zaten desc sÄ±ralÄ± => ilk en gÃ¼ncel
            }
        } else {
            guestCount++;
        }
    });

    // G. SayÄ±larÄ± Animasyonla Bas (Ã–n sayÄ±m)
    animateValue("stat-partner-count", 0, partnerMap.size, 800);
    animateValue("stat-guest-count", 0, guestCount, 800);

    // H. Liste alanÄ± (kimin baktÄ±ÄŸÄ±) sadece Pro
    if (!listContainer) return;

    if (!isPro) {
        listContainer.innerHTML = `
          <div class="p-4 text-center">
            <div class="w-11 h-11 mx-auto rounded-2xl bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 border border-slate-700 flex items-center justify-center mb-2 shadow-sm">
              <i class="fa-solid fa-eye text-cyan-300 text-sm"></i>
            </div>
            <div class="text-[11px] font-extrabold text-slate-800">Recent viewers are a Pro feature</div>
            <div class="text-[9px] text-gray-400 mt-1">Upgrade to see which companies viewed your profile.</div>
            <button class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl text-[10px] font-extrabold border border-slate-700 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 text-white shadow-sm hover:shadow-md hover:scale-[1.01] transition transform"
                    onclick="openUpgradeModal()">
              <span class="w-6 h-6 rounded-lg flex items-center justify-center bg-white/10 border border-white/15 shadow-sm">
                <i class="fa-solid fa-gem text-emerald-200 text-[11px]"></i>
              </span>
              <span class="tracking-wide" data-i18n="btn_upgrade_pro">GO PRO</span>
            </button>
          </div>
        `;
        return;
    }

    // Pro ise listeyi doldur
    listContainer.innerHTML = "";

    if (partnerMap.size === 0) {
        listContainer.innerHTML = '<div class="p-4 text-center text-[10px] text-gray-400 italic">No registered views yet.</div>';
        return;
    }

    const partnerIds = Array.from(partnerMap.keys());

    // ID'lere gÃ¶re profil bilgilerini Ã§ek
    const { data: profiles, error: pErr } = await supabaseClient
        .from('profiles')
        .select('id, company_name, logo_url, city')
        .in('id', partnerIds);

    if (pErr) {
        console.warn("Analytics profile fetch error:", pErr);
    }

    const safeProfiles = Array.isArray(profiles) ? profiles : [];

    // âœ… Partner sayÄ±sÄ±nÄ± "gerÃ§ekte bulunan profil" sayÄ±sÄ±na gÃ¶re dÃ¼zelt (silinen/bozuk kayÄ±tlar ÅŸiÅŸirmesin)
    if (partnerCountEl) partnerCountEl.textContent = String(safeProfiles.length);

    // GÃ¶rÃ¼ntÃ¼leme zamanÄ±na gÃ¶re sÄ±rala (en yeni en Ã¼st)
    safeProfiles.sort((a, b) => {
        const ta = partnerMap.get(a.id) ? new Date(partnerMap.get(a.id)).getTime() : 0;
        const tb = partnerMap.get(b.id) ? new Date(partnerMap.get(b.id)).getTime() : 0;
        return tb - ta;
    });

    safeProfiles.forEach(p => {
        const viewTime = partnerMap.get(p.id);
        const dateStr = viewTime ? new Date(viewTime).toLocaleDateString() : "";
        const name = p.company_name || "Unknown Company";
        const logoLetter = name.charAt(0).toUpperCase();

        const item = document.createElement("div");
        item.className = "flex items-center gap-3 p-2 hover:bg-cyan-50 rounded-lg transition cursor-pointer border-b border-gray-50 last:border-0";
        item.onclick = () => openProfile(p.id);

        item.innerHTML = `
            <div class="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center text-BTrustOn-accent font-bold text-xs shadow-sm shrink-0 overflow-hidden">
                ${p.logo_url ? `<img src="${p.logo_url}" class="w-full h-full object-cover">` : logoLetter}
            </div>
            <div class="min-w-0 flex-1">
                <div class="text-[11px] font-bold text-gray-700 truncate">${name}</div>
                <div class="text-[9px] text-gray-400 flex justify-between">
                    <span class="truncate max-w-[80px]">${p.city || 'Unknown'}</span>
                    <span>${dateStr}</span>
                </div>
            </div>
        `;
        listContainer.appendChild(item);
    });
}


// YardÄ±mcÄ±: SayÄ± Animasyonu
function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    if (start === end) { obj.textContent = end; return; }
    
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

    /* --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž OPEN PROFILE (OTOMATÄ°K VERÄ° Ã‡EKME + EKRAN YÃ–NETÄ°MÄ°) --- */
/* --- GÃœNCELLENMÄ°Åž: openProfile (RENKLÄ° STATUS + ÅžIK BUTONLAR) --- */
async function openProfile(companyId, opts = {}) {

  const __tabRequestedRaw   = (opts && opts.tab != null) ? String(opts.tab) : "";
  const __focusRequestedRaw = (opts && opts.focus != null) ? String(opts.focus) : "";
  const __tabRequested      = __tabRequestedRaw.trim();
  const __focusRequested    = __focusRequestedRaw.trim();
  const __hasFocus          = !!__focusRequested;

  const __preserveTab    = !!(opts && opts.preserveTab);

  // Preserve scroll only when we are ALREADY on the profile view.
  // (Prevents opening a profile from the homepage at a random scroll position.)
  const __wasProfileView = (() => {
    try {
      const vp = document.getElementById('view-profile');
      return !!(vp && !vp.classList.contains('hidden'));
    } catch(e) { return false; }
  })();

  // If focus is requested, never preserve scroll (focus will scroll instead)
  const __preserveScroll = !!(opts && opts.preserveScroll) && !__hasFocus && __wasProfileView;
  const __scrollY        = __preserveScroll ? (window.scrollY || 0) : 0;
  // PreserveTab is for keeping the current tab when re-opening after save/close.
  // If a tab is explicitly requested, we respect it and skip restore.
  const __tabToRestore   = (__preserveTab && !__tabRequested) ? (window.__profileActiveTab || 'overview') : null;


  // --- ROUTE + FAST UI SWITCH (prevents 1-2s dashboard flash on refresh) ---
  try { localStorage.setItem("BTrustOn_last_route", `company:${companyId}`); } catch(e) {}

  // Keep URL in sync (so refresh stays on the same company)
// - Restore (refresh) sÄ±rasÄ±nda replaceState (history ÅŸiÅŸmesin)
// - KullanÄ±cÄ± tÄ±klayÄ±nca pushState (browser Back ile listeye dÃ¶nebilsin)
try {
  let newHash = `#company=${encodeURIComponent(companyId)}`;
  if (__tabRequested) newHash += `&tab=${encodeURIComponent(__tabRequested)}`;
  if (__focusRequested) newHash += `&focus=${encodeURIComponent(__focusRequested)}`;
  if (window.location.hash !== newHash) {
    const st = { view: "profile", id: String(companyId), t: nowTs() };
    if (history && history.pushState && !window.__routeRestoring) history.pushState(st, "", newHash);
    else if (history && history.replaceState) history.replaceState(st, "", newHash);
    else window.location.hash = newHash;
  }
} catch(e) {}

  // Immediately switch to Profile view shell (even if data must load)
  const _vd = document.getElementById("view-dashboard");
  const _vp = document.getElementById("view-profile");
  const _ve = document.getElementById("view-editor");
  const _vm = document.getElementById("view-message");
  const _bb = document.getElementById("back-btn");

  if (_vd) _vd.classList.add("hidden-view");
  if (_ve) _ve.classList.add("hidden-view");
  if (_vm) _vm.classList.add("hidden-view");
  if (_vp) _vp.classList.remove("hidden-view");
  if (_bb) _bb.classList.remove("hidden", "hidden-view");
  // âœ… Start profile at top unless we explicitly preserve scroll
  if (!__preserveScroll) {
    try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch(e) { try { window.scrollTo(0,0); } catch(_) {} }
  }


  // âœ… Show skeleton while profile data loads
  try { showProfileSkeleton(); } catch(e) {}


  // 0) If we already have this profile in memory, refresh claim fields
  //    (prevents stale "Unclaimed / Claim now" after an admin approval during the same session)
  const __refreshClaimFields = async (obj) => {
    try {
      if (!obj || !obj.id) return;
      const em = String(obj.email || obj.contact_email || "").toLowerCase();
      const isSeed = em.includes("@btruston.seed");
      if (!isSeed) return; // only refresh seed directory profiles
      const { data } = await supabaseClient
        .from("profiles")
        .select("owner_user_id, claimed_at, verification_status, is_listed, blue_tick, is_verified, verified, is_verified_company")
        .eq("id", obj.id)
        .maybeSingle();
      if (!data) return;
      obj.owner_user_id = data.owner_user_id || null;
      obj.claimed_at = data.claimed_at || null;
      if (typeof data.verification_status !== "undefined") obj.verification_status = data.verification_status || obj.verification_status;
      if (typeof data.blue_tick !== "undefined") obj.blue_tick = data.blue_tick;
      if (typeof data.is_verified !== "undefined") obj.is_verified = data.is_verified;
      if (typeof data.verified !== "undefined") obj.verified = data.verified;
      if (typeof data.is_verified_company !== "undefined") obj.is_verified_company = data.is_verified_company;

      if (typeof data.is_listed !== "undefined") obj.is_listed = data.is_listed;
    } catch(e) {}
  };

  // 1. Ã–nce veritabanÄ±nda var mÄ±?
  let company = database.find((c) => c.id == companyId);
  if (company) { await __refreshClaimFields(company); }

  // 2. Yoksa Supabase'den Ã§ek
  if (!company) {
      if (!(window.__routeRestoring === true)) {
        showToast("Loading...", "Fetching company profile...", "info");
      }
      try {
          let { data: profile, error } = await supabaseClient
              .from('profiles')
              .select('*')
              .eq('id', companyId)
              .single();

          if (error || !profile) {
              showToast("Error", "Profile not found or deleted.", "error");
              try { hideProfileSkeleton(); } catch(e) {}
              return;
          }

          company = {
              id: profile.id,
              email: profile.email || "",
              subscription_tier: profile.subscription_tier || "free",
              verification_status: profile.verification_status || "none",
              owner_user_id: profile.owner_user_id || null,
              claimed_at: profile.claimed_at || null,
              blue_tick: (typeof profile.blue_tick !== "undefined") ? profile.blue_tick : undefined,
              is_verified: (typeof profile.is_verified !== "undefined") ? profile.is_verified : undefined,
              verified: (typeof profile.verified !== "undefined") ? profile.verified : undefined,
              is_verified_company: (typeof profile.is_verified_company !== "undefined") ? profile.is_verified_company : undefined,

              tax_id: profile.tax_id || "",
              duns_number: profile.duns_number || "",
              country: profile.country || "Turkey",
              address: profile.address || "",
              name: profile.company_name || "Unknown",
              city: profile.city || "No Location",
              tagline: profile.tagline || "",
              sector: profile.sector || "construction",
              desc: profile.description || "",
              type_label: profile.company_type || "Industrial Supplier",
              size_label: profile.company_size || "Size N/A",
              year_label: profile.founded_year || "",
              services: profile.services ? profile.services.split(',') : [],
              logo_url: profile.logo_url || null,
              website: profile.website || "",
              phone: profile.phone || "",
              contact_email: profile.contact_email || "",
              trust: "verified",
              meta: { references: 50, delivery: 50, years: 1, financial: 50, digital: 50 },
              certificates: profile.certificates || [],
              assets: profile.assets || [],
              projects: profile.projects || []
          };
          database.push(company);
      } catch (err) {
          console.error(err);
          showToast("Error", "Connection failed.", "error");
          try { hideProfileSkeleton(); } catch(e) {}
          return;
      }
  }

  selectedCompany = company;

  try { if (typeof updateSaveButtonsUI === 'function') updateSaveButtonsUI(); try{ updateFollowButtonsUI();
  // BTON_FOLLOW_UI_DELAY_REFRESH: auth/follow set may arrive slightly later on mobile
  try { setTimeout(() => { try { updateFollowButtonsUI(); } catch(e) {} }, 220); } catch(e) {}
 }catch(e){} } catch(e) {}


  // 3. EKRAN GEÃ‡Ä°ÅžLERÄ°
  const viewDashboard = document.getElementById("view-dashboard");
  const viewProfile = document.getElementById("view-profile");
  const viewEditor = document.getElementById("view-editor");
  const viewMessage = document.getElementById("view-message"); 
  const backBtn = document.getElementById("back-btn");
  if (viewDashboard) viewDashboard.classList.add("hidden-view");
  if (viewEditor) viewEditor.classList.add("hidden-view");
  if (viewMessage) viewMessage.classList.add("hidden-view"); 
  
  if (viewProfile) viewProfile.classList.remove("hidden-view");
  if (backBtn) backBtn.classList.remove("hidden", "hidden-view");
window.scrollTo(0, 0);
  document.body.style.overflow = "auto"; 

  // 4. VERÄ°LERÄ° DOLDUR
  // Logo
  const pLogoImg = document.getElementById("p-logo-image");
  const pDefaultIcon = document.getElementById("p-default-icon");
  if (pLogoImg && pDefaultIcon) {
      if (company.logo_url) {
          pLogoImg.src = company.logo_url;
          pLogoImg.classList.remove("hidden");
          pDefaultIcon.classList.add("hidden");
      } else {
          pLogoImg.classList.add("hidden");
          pDefaultIcon.classList.remove("hidden");
      }
  }

  // Metinler
  const nameEl = document.getElementById("p-name");
  const descEl = document.getElementById("p-desc");
  const cityEl = document.getElementById("p-city");
  const sectorEl = document.getElementById("p-sector");
  const pType = document.getElementById("p-type-tag");
  const pSize = document.getElementById("p-size-tag");
  const pYear = document.getElementById("p-year-tag");

  // --- YENÄ° EKLENEN KISIM: Ä°SÄ°M + AKILLI ROZET SÄ°STEMÄ° ---
if (nameEl) {
    // 1. Ã–nce sadece ismi yaz
    nameEl.innerHTML = company.name;

    // 2. Kontrolleri Yap
    const ADMIN_MAIL = "rahmiunl@gmail.com"; // Senin mailin
    const isAdmin = (company.email === ADMIN_MAIL || company.contact_email === ADMIN_MAIL);
    const isVerified = String(company.verification_status || '').toLowerCase() === 'verified';
    const __emailL = String(company.email || company.contact_email || "").toLowerCase();
    const isSeedDirectory = (__emailL.endsWith("@btruston.seed") || __emailL.includes("@btruston.seed"));
    const isUnclaimed = isSeedDirectory && (!company.owner_user_id || String(company.owner_user_id).trim()==='');


    // 3. Rozet SeÃ§imi
    if (isAdmin) {
        // --- ADMIN Ä°Ã‡Ä°N: ALTIN TAÃ‡ VE Ã–ZEL ETÄ°KET ---
        nameEl.innerHTML += `
            <span class="inline-flex items-center gap-1.5 ml-3 px-2 py-0.5 rounded bg-amber-100 border border-amber-200 align-middle">
                <i class="fa-solid fa-crown text-amber-600 text-sm animate-pulse"></i>
                <span class="text-[10px] font-bold text-amber-700 uppercase tracking-wide">BTrustOn Official</span>
            </span>
        `;
    } 
    else if (isVerified) {
            // ðŸ’Ž ONAYLI ÃœYE: LIQUID CRYSTAL MAVÄ° TÄ°K (EN HAVALISI)
            nameEl.innerHTML += `
                <span class="group relative inline-flex items-center justify-center ml-2 align-middle cursor-help select-none" title="Officially Verified Partner">
                    
                    <span class="absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-20 animate-ping duration-[3s]"></span>
                    
                    <span class="absolute inline-flex h-[80%] w-[80%] rounded-full bg-blue-500 blur-md opacity-40"></span>
                    
                    <span class="relative z-10 bg-white rounded-full w-5 h-5 flex items-center justify-center"></span>

                    <i class="fa-solid fa-circle-check text-2xl relative z-20 -ml-5" 
                       style="
                           background: linear-gradient(135deg, #1d4ed8 0%, #06b6d4 100%); /* Derin Mavi -> Parlak Cam GÃ¶beÄŸi */
                           -webkit-background-clip: text;
                           -webkit-text-fill-color: transparent;
                           filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3)); /* 3D GÃ¶lge */
                       ">
                    </i>
                </span>
            `;
        } 
        else if (isUnclaimed) {
            // ðŸ§© SAHÄ°PLENÄ°LMEMÄ°Åž PROFÄ°L: Label + Claim CTA
            nameEl.innerHTML += `
              <span class="inline-flex items-center gap-1.5 ml-3 px-2.5 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-700 align-middle">
                <i class="fa-regular fa-circle-dot text-[12px]"></i>
                <span class="text-[10px] font-extrabold uppercase tracking-wide">${tOr("ui_unclaimed_profile","Unclaimed profile")}</span>
              </span>
              <button class="inline-flex items-center gap-1.5 ml-2 px-3 py-1 rounded-full bg-white border border-slate-200 text-slate-900 hover:border-slate-300 hover:bg-slate-50 text-[10px] font-extrabold uppercase tracking-wide"
                      onclick="event.stopPropagation(); openClaimCompanyModal('${company.id}', '${_safeText(company.company_name || "")}');"
                      title="${tOr("ui_unclaimed_profile_hint","This profile hasn't been claimed by a company representative yet.")}">
                <i class="fa-solid fa-handshake-angle text-[12px] text-BTrustOn-accent"></i>
                ${tOr("ui_claim_cta","Claim")}
              </button>
            `;
        }
}

// --- BÄ°TÄ°Åž ---
// Location (City, Country)
if (cityEl) {
    const city = (company.city || "").trim();
    const countryRaw = (company.country || "").trim();
    const country = localizeCountryName(countryRaw);
    let loc = "";

    if (city && country) {
        // Avoid duplicates like "Ankara, Turkey, Turkey"
        const cityL = city.toLowerCase();
        const cL = String(country).toLowerCase();
        const cRawL = String(countryRaw || "").toLowerCase();
        if (cityL.includes(cL) || (cRawL && cityL.includes(cRawL))) loc = city;
        else loc = `${city}, ${country}`;
    } else {
        loc = city || country || ((typeof currentLang !== 'undefined' && currentLang === 'tr') ? "Konum Yok" : "Location N/A");
    }

    cityEl.textContent = loc;
}

  
  // Sector (i18n)
if (sectorEl) {
    const __sraw = String(company.sector || "");
    const __skey = __sraw.trim().toLowerCase();
    const __lbl = (__skey ? (t("join_sector_" + __skey) || "") : "");
    sectorEl.textContent = __lbl || (__sraw ? (__sraw.charAt(0).toUpperCase() + __sraw.slice(1)) : "");
}

if (pType) pType.textContent = translateCompanyType(company.type_label || company.type || "Industrial Supplier");
  if (pSize) pSize.textContent = translateCompanySize(company.size_label || "");
  if (pYear) pYear.textContent = formatFoundedYear(company.year_label);
  
  // AÃ§Ä±klama (Dil DesteÄŸi)
  if (descEl) {
      if (typeof currentLang !== 'undefined' && currentLang === 'tr' && company.desc_tr) {
          descEl.textContent = company.desc_tr;
      } else {
          descEl.textContent = company.desc;
      }
  }

  // Slogan
  const taglineContainer = document.getElementById("p-tagline-container");
  const taglineText = document.getElementById("p-tagline");
  if (taglineContainer && taglineText) {
      if (company.tagline && company.tagline.trim() !== "") {
          taglineText.textContent = `"${company.tagline}"`; 
          taglineContainer.classList.remove("hidden");
      } else {
          taglineContainer.classList.add("hidden");
      }
  }

  // (Scoring removed)

  // Ä°letiÅŸim
  const pWebsite = document.getElementById("p-website-link");
  const pEmail = document.getElementById("p-email-text");
  const pPhone = document.getElementById("p-phone-text");

  if (pWebsite) {
      if (company.website) {
          let href = company.website.startsWith("http") ? company.website : "https://" + company.website;
          pWebsite.href = href;
          pWebsite.textContent = company.website.replace(/^https?:\/\//, '').replace(/\/$/, '');
          pWebsite.classList.remove("text-gray-400", "italic", "pointer-events-none");
          pWebsite.classList.add("text-BTrustOn-accent", "hover:underline");
      } else {
          pWebsite.textContent = "-";
          pWebsite.removeAttribute("href");
          pWebsite.classList.add("text-gray-400", "italic", "pointer-events-none");
          pWebsite.classList.remove("text-BTrustOn-accent", "hover:underline");
      }
  }
  if (pEmail) {
      const displayEmail = company.contact_email || company.email || "-";
      pEmail.textContent = displayEmail;
      if(displayEmail !== "-") {
          pEmail.parentElement.onclick = () => window.location.href = "mailto:" + displayEmail;
          pEmail.parentElement.classList.remove("text-gray-400");
          pEmail.parentElement.classList.add("cursor-pointer", "hover:bg-gray-50", "text-gray-700");
      } else {
           pEmail.parentElement.onclick = null;
           pEmail.parentElement.classList.remove("cursor-pointer", "hover:bg-gray-50", "text-gray-700");
           pEmail.parentElement.classList.add("text-gray-400");
      }
  }
  if (pPhone) pPhone.textContent = company.phone || "-";
// âœ… YENÄ°: ADRES GÃ–STERÄ°MÄ°
  const pAddress = document.getElementById("p-address-text");
  if (pAddress) {
      if (company.address && company.address.trim() !== "") {
          pAddress.textContent = company.address;
          // Ä°konun olduÄŸu kapsayÄ±cÄ±yÄ± gÃ¶ster (gizliyse)
          pAddress.parentElement.classList.remove("hidden");
      } else {
          pAddress.textContent = (currentLang === "tr") ? "Resmi adres belirtilmemiÅŸ." : (currentLang === "es" ? "No se ha indicado una direcciÃ³n oficial." : "No official address listed.");
          // Ä°sterseniz boÅŸsa gizleyebilirsiniz:
          // pAddress.parentElement.classList.add("hidden");
      }
  }

  // Hizmetler
  /* --- CORE SERVICES VIEW (Top Capabilities + Other Services + Details) --- */
const servicesGrid = document.getElementById("p-services-grid");
if (servicesGrid) {
  servicesGrid.innerHTML = "";

  // Language-aware service list
  let displayServices = company.services || [];
  if (typeof currentLang !== 'undefined' && currentLang === 'tr' && company.services_tr && company.services_tr.length > 0) {
    displayServices = company.services_tr;
  }

  // Normalize into array of strings
  let tags = [];
  if (Array.isArray(displayServices)) {
    tags = displayServices;
  } else if (typeof displayServices === "string") {
    tags = displayServices.split(",").map(s => s.trim()).filter(Boolean);
  }
  tags = tags.map(s => String(s || "").trim()).filter(Boolean);

  // Featured services (user-selected). If not available, fallback to first 5.
  let featuredRaw = company.services_featured || [];
  if (typeof currentLang !== 'undefined' && currentLang === 'tr' && company.services_featured_tr && company.services_featured_tr.length > 0) {
    featuredRaw = company.services_featured_tr;
  }

  let featuredList = [];
  if (Array.isArray(featuredRaw)) {
    featuredList = featuredRaw;
  } else if (typeof featuredRaw === "string") {
    featuredList = featuredRaw.split(",").map(s => s.trim()).filter(Boolean);
  }
  featuredList = featuredList.map(s => String(s || "").trim()).filter(Boolean);

  // keep only items that exist in tags + preserve featured order
  const tagKey = (s) => String(s || "").trim().toLowerCase();
  const tagSet = new Set(tags.map(tagKey));
  featuredList = featuredList.filter(s => tagSet.has(tagKey(s)));

  // de-dupe featured
  const seenFeat = new Set();
  featuredList = featuredList.filter(s => {
    const k = tagKey(s);
    if (seenFeat.has(k)) return false;
    seenFeat.add(k);
    return true;
  });

  if (featuredList.length === 0) {
    featuredList = tags.slice(0, 5);
  }

  // Other = everything not featured
  const featSet = new Set(featuredList.map(tagKey));
  const other = tags.filter(s => !featSet.has(tagKey(s)));

  servicesGrid.className = "space-y-4 mb-8";

  const myId = localStorage.getItem("BTrustOn_my_company_id");
  const isOwner = (myId && String(company.id) === String(myId));

  if (tags.length === 0) {
    servicesGrid.innerHTML = `
      <div class="w-full py-6 text-center border border-dashed border-gray-200 rounded-2xl bg-gray-50">
        <p class="text-sm text-gray-400 italic">${t("svc_no_tags") || "No service tags yet."}</p>
        ${isOwner ? `<button type="button" class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-gray-200 text-xs font-bold text-gray-600 hover:bg-cyan-50 hover:border-cyan-200 transition" onclick="editMyProfile('section-services')">
          <i class="fa-solid fa-pen"></i> ${t("ui_add_services_btn_3d0ce2") || "Add services"}
        </button>` : ``}
      </div>`;
  } else {
    // âœ… Single-card layout (no â€œdouble stackedâ€ feel)
    const card = document.createElement("div");
    card.className = "bg-white/70 backdrop-blur-md border border-[rgba(15,23,42,.08)] rounded-2xl p-5";

    const featuredMany = featuredList.length > 5;
    const featuredVisible = featuredMany ? featuredList.slice(0, 5) : featuredList;
    const featuredHidden = featuredMany ? featuredList.slice(5) : [];

    const otherMany = other.length > 12;
    const otherVisible = otherMany ? other.slice(0, 12) : other;
    const otherHidden = otherMany ? other.slice(12) : [];

    card.innerHTML = `
      <div class="flex items-center justify-between gap-3 mb-4">
        <div class="flex items-center gap-2 shrink-0">
          <span class="w-8 h-8 rounded-xl bg-cyan-50 border border-cyan-100 text-BTrustOn-accent flex items-center justify-center">
            <i class="fa-solid fa-layer-group"></i>
          </span>
          <div class="min-w-0">
            <div class="text-sm font-bold text-gray-800">${t("svc_card_title")}</div>
          </div>
        </div>
        ${isOwner ? `<div class="text-[10px] text-gray-400 font-semibold">${t("svc_reorder_hint")}</div>` : ``}
      </div>

      ${featuredVisible.length ? `
        <div class="mb-4">
          <div class="flex items-center justify-between gap-3 mb-2">
            <div class="inline-flex items-center gap-2">
              <div class="text-[11px] text-gray-400 font-bold uppercase tracking-widest">${t("svc_featured")}</div>
              <span class="inline-flex items-center justify-center h-[18px] min-w-[18px] px-2 rounded-full bg-white/70 backdrop-blur-sm border border-[rgba(6,182,212,.28)] text-[10px] font-extrabold text-BTrustOn-accent leading-none">${featuredList.length}</span>
            </div>
            ${featuredMany ? `<button id="svc-featured-toggle-btn" type="button" class="text-[11px] font-bold text-BTrustOn-accent hover:underline">${t("show_all")}</button>` : ``}
          </div>

          <div id="svc-featured-wrap" class="flex flex-wrap gap-2">
            ${featuredVisible.map((s) => `
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 backdrop-blur-sm border border-[rgba(6,182,212,.20)]">
                <span class="w-5 h-5 rounded-lg bg-cyan-50 text-BTrustOn-accent border border-cyan-100 flex items-center justify-center">
                  <i class="fa-solid fa-star text-[10px]"></i>
                </span>
                <span class="text-xs font-extrabold text-gray-700">${svcEscape(svcDisplayLabel(s))}</span>
              </span>
            `).join("")}
          </div>

          ${featuredMany ? `<div id="svc-featured-hidden-wrap" class="flex flex-wrap gap-2 mt-2 hidden">
            ${featuredHidden.map((s) => `
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 backdrop-blur-sm border border-[rgba(6,182,212,.20)]">
                <span class="w-5 h-5 rounded-lg bg-cyan-50 text-BTrustOn-accent border border-cyan-100 flex items-center justify-center">
                  <i class="fa-solid fa-star text-[10px]"></i>
                </span>
                <span class="text-xs font-extrabold text-gray-700">${svcEscape(svcDisplayLabel(s))}</span>
              </span>
            `).join("")}
          </div>` : ``}
        </div>
      ` : ``}

      ${other.length ? `
        <div class="pt-4 border-t border-gray-100">
          <div class="flex items-center justify-between gap-3 mb-2">
            <div class="inline-flex items-center gap-2">
              <div class="text-[11px] text-gray-400 font-bold uppercase tracking-widest">${t("svc_more")}</div>
              <span class="inline-flex items-center justify-center h-[18px] min-w-[18px] px-2 rounded-full bg-white/70 backdrop-blur-sm border border-[rgba(15,23,42,.12)] text-[10px] font-extrabold text-gray-500 leading-none">${other.length}</span>
            </div>
            ${otherMany ? `<button id="svc-toggle-btn" type="button" class="text-xs font-bold text-BTrustOn-accent hover:underline">${t("show_all")}</button>` : ``}
          </div>

          <div id="svc-other-wrap" class="flex flex-wrap gap-2">
            ${otherVisible.map((s) => `
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-gray-200 hover:border-cyan-200 hover:bg-cyan-50/40 transition">
                <span class="w-5 h-5 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center">
                  <i class="fa-solid fa-check text-[10px]"></i>
                </span>
                <span class="text-xs font-bold text-gray-700">${svcEscape(svcDisplayLabel(s))}</span>
              </span>
            `).join("")}
          </div>

          ${otherMany ? `<div id="svc-hidden-wrap" class="flex flex-wrap gap-2 mt-2 hidden">
            ${otherHidden.map((s) => `
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-gray-200 hover:border-cyan-200 hover:bg-cyan-50/40 transition">
                <span class="w-5 h-5 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center">
                  <i class="fa-solid fa-check text-[10px]"></i>
                </span>
                <span class="text-xs font-bold text-gray-700">${svcEscape(svcDisplayLabel(s))}</span>
              </span>
            `).join("")}
          </div>` : ``}
        </div>
      ` : ``}
    `;

    servicesGrid.appendChild(card);

    // Featured toggle
    if (featuredMany) {
      const btnF = card.querySelector("#svc-featured-toggle-btn");
      const hiddenF = card.querySelector("#svc-featured-hidden-wrap");
      if (btnF && hiddenF) {
        btnF.onclick = () => {
          const isHidden = hiddenF.classList.contains("hidden");
          if (isHidden) {
            hiddenF.classList.remove("hidden");
            btnF.textContent = t("show_less");
          } else {
            hiddenF.classList.add("hidden");
            btnF.textContent = t("show_all");
          }
        };
      }
    }

    if (otherMany) {
      const btn = card.querySelector("#svc-toggle-btn");
      const hiddenWrap = card.querySelector("#svc-hidden-wrap");
      if (btn && hiddenWrap) {
        btn.onclick = () => {
          const isHidden = hiddenWrap.classList.contains("hidden");
          if (isHidden) {
            hiddenWrap.classList.remove("hidden");
            btn.textContent = t("show_less");
          } else {
            hiddenWrap.classList.add("hidden");
            btn.textContent = t("show_all");
          }
        };
      }
    }
  }

  // --- Details ---
  if (company.service_details && company.service_details.trim() !== "") {
    const detailsDiv = document.createElement("div");
    detailsDiv.className = "w-full max-w-full animate-fade-in";
    detailsDiv.innerHTML = `
      <div class="relative bg-slate-50 rounded-2xl p-6 border border-slate-100 overflow-hidden">
        <i class="fa-solid fa-quote-left absolute top-4 left-4 text-slate-200 text-2xl"></i>
        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 pl-6"data-i18n="ui_technical_capability_statement">${t("ui_technical_capability_statement")}</h4>
        <div class="text-sm text-gray-600 leading-relaxed pl-6 font-light break-words whitespace-pre-wrap font-sans">
          ${company.service_details}
        </div>
      </div>
    `;
    servicesGrid.appendChild(detailsDiv);
  }
}



// --- BÃ–LÃœM 3: OWNER / YETKÄ°LÄ° KARTI (SIDEBAR Ä°Ã‡Ä°N YENÄ° VERSÄ°YON) ---
  
  // 1. Yeni hedef kutuyu bul (sidebar'daki)
  const sidebarOwnerContainer = document.getElementById("sidebar-owner-view");

  // 2. EÄŸer eski kutu kaldÄ±ysa onu temizle (Ã‡akÄ±ÅŸma olmasÄ±n)
  const oldOwnerContainer = document.getElementById("p-owner-view");
  if (oldOwnerContainer) oldOwnerContainer.innerHTML = "";

  if (sidebarOwnerContainer) {
      sidebarOwnerContainer.innerHTML = ""; // Temizle
      
      // Veri kontrolÃ¼: Ä°sim veya Rol varsa gÃ¶ster
      if (company.owner_name || company.owner_role) {
          
          const photoSrc = company.owner_photo_url 
            ? `<img id="p-owner-photo-img" src="${company.owner_photo_url}" class="w-full h-full object-cover hover:scale-110 transition duration-500">`
            : `<div id="p-owner-photo-placeholder" class="w-full h-full bg-slate-100 flex items-center justify-center text-slate-300"><i class="fa-solid fa-user text-lg"></i></div>`;const linkedinBtn = company.owner_linkedin 
            ? `<a href="${company.owner_linkedin}" target="_blank" class="flex items-center justify-center gap-2 w-full py-2.5 mt-4 rounded-xl bg-[#0077b5]/10 text-[#0077b5] text-xs font-bold hover:bg-[#0077b5] hover:text-white transition-all group/btn">
                 <i class="fa-brands fa-linkedin text-sm"></i> <span>Connect on LinkedIn</span>
               </a>`
            : ``;

          sidebarOwnerContainer.innerHTML = `
              <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm relative overflow-hidden group hover:shadow-md transition-all duration-300">
                  <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-BTrustOn-accent/10 to-transparent rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110"></div>

                  <div class="relative z-10">
                      <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                          <i class="fa-solid fa-certificate text-BTrustOn-accent"></i> <span data-i18n="ui_profile_key_contact_title">${t("ui_profile_key_contact_title")}</span>
                      </h4>

                      <div class="flex items-center gap-4">
                          <div id="p-owner-photo-wrap" class="bton-avatar-ring w-14 h-14 rounded-full border border-transparent shadow-md overflow-hidden shrink-0 bg-gray-50 relative">
                              ${photoSrc}
                              <div id="p-owner-photo-overlay" class="hidden">
                                  <i class="fa-solid fa-camera text-sm"></i>
                              </div>
                          </div>
                          <div class="min-w-0 flex-1">
                              <h5 class="text-sm font-bold text-gray-800 truncate leading-tight mb-0.5">
                                  ${company.owner_name || 'Company Rep.'}
                              </h5>
                              <p class="text-[11px] text-gray-500 font-medium truncate">
                                  ${company.owner_role || 'Authorized Person'}
                              </p>
                          </div>
                      </div>
                      ${linkedinBtn}
                  </div>
              </div>
          `;
          
          sidebarOwnerContainer.classList.remove("hidden");
      } else {
          sidebarOwnerContainer.classList.add("hidden");
      }
  }

  // Yetki KontrolÃ¼
  const myCurrentId = localStorage.getItem("BTrustOn_my_company_id");
  const isMyProfile = (myCurrentId && String(company.id) === String(myCurrentId));
  
  // ðŸŽ‰ Celebration check (runs when YOUR company becomes verified, including claim-based companies)
  try { if (isMyProfile && typeof checkAndTriggerCelebration === "function") checkAndTriggerCelebration(company); } catch(e) {}

  
  const btnEdit = document.getElementById("btn-edit-profile");
  const btnAddAsset = document.getElementById("btn-add-asset");
  const btnQuote = document.getElementById("btn-req-quote");
  const btnAddProject = document.getElementById("btn-add-project");
  const btnAddCert = document.getElementById("btn-add-cert");
  const logoContainer = document.getElementById("p-logo-container");
  const logoOverlay = document.getElementById("p-logo-overlay");

  if (isMyProfile) {
      if(btnEdit) btnEdit.classList.remove("hidden-view");
      if(btnAddAsset) btnAddAsset.classList.remove("hidden-view");
      if(btnAddProject) btnAddProject.classList.remove("hidden-view");
      if(btnAddCert) btnAddCert.classList.remove("hidden-view");
      if(btnQuote) btnQuote.classList.add("hidden-view");

      if (logoContainer) {
          logoContainer.classList.add("cursor-pointer", "group"); 
          logoContainer.setAttribute("onclick", "triggerProfileLogoUpload()");
      }
      if (logoOverlay) {
          logoOverlay.classList.remove("hidden");
          logoOverlay.className = "absolute inset-0 bg-slate-900/30 backdrop-blur-sm flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-500 z-20"; 
      }

      // Owner photo quick edit (Profile sidebar)
      const ownerWrap = document.getElementById("p-owner-photo-wrap");
      const ownerOverlay = document.getElementById("p-owner-photo-overlay");
      if (ownerWrap) {
          ownerWrap.classList.add("cursor-pointer", "group");
          ownerWrap.setAttribute("onclick", "triggerOwnerPhotoUpload('direct')");
      }
      if (ownerOverlay) {
          ownerOverlay.classList.remove("hidden");
          ownerOverlay.className = "absolute inset-0 bg-slate-900/30 backdrop-blur-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-500 z-20 text-white";
      }
  } else {
      if(btnEdit) btnEdit.classList.add("hidden-view");
      if(btnAddAsset) btnAddAsset.classList.add("hidden-view");
      if(btnAddProject) btnAddProject.classList.add("hidden-view");
      if(btnAddCert) btnAddCert.classList.add("hidden-view");
      if(btnQuote) btnQuote.classList.remove("hidden-view");

      if (logoContainer) {
          // Allow viewers to click the logo to enlarge (only if a logo exists)
          const logoImg = document.getElementById("p-logo-image");
          const hasLogo = !!(logoImg && !logoImg.classList.contains("hidden") && (logoImg.getAttribute("src") || "").trim());
          if (hasLogo) {
              logoContainer.classList.add("cursor-pointer");
              logoContainer.setAttribute("onclick", "openProfileLogoViewer()");
          } else {
              logoContainer.classList.remove("cursor-pointer", "group");
              logoContainer.removeAttribute("onclick");
          }
      }
      if (logoOverlay) {
          logoOverlay.classList.add("hidden");
      }

      const ownerWrap = document.getElementById("p-owner-photo-wrap");
      const ownerOverlay = document.getElementById("p-owner-photo-overlay");
      if (ownerWrap) {
          ownerWrap.classList.remove("cursor-pointer", "group");
          ownerWrap.removeAttribute("onclick");
      }
      if (ownerOverlay) {
          ownerOverlay.classList.add("hidden");
      }
  }


  
// Mobile: move "Edit Profile" under location/sector chips (prevents ugly wrap when name is long)
try {
  const slot = document.getElementById("p-edit-mobile-slot");
  if (btnEdit) {
    if (!window.__btonBtnEditHome) window.__btonBtnEditHome = btnEdit.parentElement;

    const isMobile = window.matchMedia && window.matchMedia("(max-width: 640px)").matches;

    // reset
    btnEdit.classList.remove("bton-edit-pill");
    btnEdit.onclick = (e) => { if (e) e.stopPropagation(); editMyProfile(); };

    if (isMyProfile && isMobile && slot) {
      slot.appendChild(btnEdit);
      btnEdit.classList.add("bton-edit-pill");
    } else if (window.__btonBtnEditHome) {
      window.__btonBtnEditHome.appendChild(btnEdit);
    }
  }
} catch (e) {}

// Keep current tab when re-opening the same company (e.g., viewing a certificate/doc)
  const sameCompany = window.__profileActiveCompanyId && String(window.__profileActiveCompanyId) === String(company.id);
  const desiredTab = (__tabRequested ? __tabRequested : ((sameCompany && window.__profileActiveTab) ? window.__profileActiveTab : "overview"));
  switchProfileTab(desiredTab);
  window.__profileActiveCompanyId = company.id;

  
  // --- PROJELER (TIKLANABÄ°LÄ°R KART + GÄ°ZLÄ° BUTONLAR) ---
  const projList = document.getElementById("p-projects-list");
  window.__projectsCache = (company.projects || []);
  if (projList) {
      projList.innerHTML = "";

      // Sort render order by Project Date (fallback: created id)
      const sortMode = (document.getElementById("proj-sort")?.value) || "newest";
      const projectsArr = Array.isArray(company.projects) ? [...company.projects] : [];
      const getDateTS = (p) => {
        const ts = Date.parse((p && p.project_date) ? p.project_date : "");
        if (Number.isFinite(ts)) return ts;
        const fallback = Number(p && p.id) || 0;
        return fallback;
      };
      if (sortMode === "oldest") projectsArr.sort((a,b)=> getDateTS(a) - getDateTS(b));
      else if (sortMode === "az") projectsArr.sort((a,b)=> String(a?.title||"").toLowerCase().localeCompare(String(b?.title||"").toLowerCase()));
      else projectsArr.sort((a,b)=> getDateTS(b) - getDateTS(a));


      // Keep a sorted cache for the Project Viewer
      window.__projectsCache = projectsArr;
      if (!company.projects || company.projects.length === 0) {
          const emptyTitle = (typeof t === "function") ? t("no_projects_found_title") : "No projects found";
          const emptyDesc  = (typeof t === "function") ? t("no_projects_found_desc")  : "This company hasnâ€™t listed any projects yet.";
          projList.innerHTML = `
            <div class="col-span-full">
              <div class="rounded-2xl border border-dashed border-[rgba(15,23,42,.14)] bg-gradient-to-b from-white/70 to-slate-50/60 p-6">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-xl bg-white border border-[rgba(15,23,42,.10)] shadow-sm flex items-center justify-center text-slate-500 shrink-0">
                    <i class="fa-solid fa-diagram-project"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="text-[12px] font-extrabold text-slate-700 tracking-wide">${emptyTitle}</div>
                    <div class="mt-1 text-[11px] text-slate-500 font-semibold">${emptyDesc}</div>
                  </div>
                </div>
              </div>
            </div>`;
      } else {
          projectsArr.forEach(p => {
              const hasGallery = p.gallery_urls && p.gallery_urls.length > 0;
              const coverPlaceholder = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%221200%22%20height%3D%22675%22%20viewBox%3D%220%200%201200%20675%22%3E%3Crect%20width%3D%221200%22%20height%3D%22675%22%20fill%3D%22%23f1f5f9%22/%3E%3Cpath%20d%3D%22M430%20365l130-140%20150%20185%20110-125%20210%20255H350z%22%20fill%3D%22%23e2e8f0%22/%3E%3C/svg%3E";
  const cover = p.cover_url || coverPlaceholder;
              // Kart artÄ±k her zaman "Detay" aÃ§ar. Galeri varsa detay iÃ§inden aÃ§Ä±lÄ±r.
              let cardClickAction = `onclick="openProjectViewer(${p.id})"`;
              let cursorClass = "cursor-pointer";
              let galleryBadge = "";

              if (hasGallery) {
                  // Sol Ã¼stte kÃ¼Ã§Ã¼k "foto sayÄ±sÄ±" etiketi
                  galleryBadge = `
                    <div class="absolute top-3 left-3 bg-black/45 text-white text-[11px] px-2 py-1 rounded-lg flex items-center gap-1.5 z-10 border border-white/10 shadow-sm">
                         <i class="fa-solid fa-camera"></i> ${p.gallery_urls.length}
                    </div>
                  `;
              }

              const actionBtns = isMyProfile ? `
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20">
                    <button onclick="event.stopPropagation(); openProjectModal(${p.id})" class="w-8 h-8 rounded-full bg-white/90 backdrop-blur-sm text-slate-600 hover:text-BTrustOn-accent hover:bg-white shadow-lg flex items-center justify-center transition transform hover:scale-105" title="${t("ui_edit_project") || "Edit Project"}">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteProject(${p.id})" class="w-8 h-8 rounded-full bg-white/90 backdrop-blur-sm text-slate-600 hover:text-red-500 hover:bg-white shadow-lg flex items-center justify-center transition transform hover:scale-105" title="${t("ui_delete_project") || (t("ui_delete") || "Delete Project")}">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
              ` : "";

              const card = document.createElement("div");
              try{ card.id = _btonEntityDomId('project', p.id); }catch(e){}
              card.className = "group relative bg-white/80 backdrop-blur border border-[rgba(15,23,42,.08)] rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col h-full";
              
              const hay = `${p.title || ""} ${p.loc || ""} ${p.desc || ""}`.trim();
              card.dataset.hay = hay;
              card.dataset.pid = String(p.id || "");
              card.dataset.title = p.title || "";
              card.dataset.created = String(p.id || "");

              card.dataset.pdate = String(p.project_date || "");

              card.innerHTML = `
                <div class="bton-accent-line z-30"></div>
                <div class="relative h-48 overflow-hidden bg-gray-100 shrink-0 ${cursorClass} group/img" ${cardClickAction}>
                    <img src="${cover}" class="w-full h-full object-cover group-hover/img:scale-105 transition-transform duration-700">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/20 to-transparent opacity-90"></div>
                    
                    ${galleryBadge}
                    
                    <div class="absolute bottom-0 left-0 p-4 w-full text-white z-10">
                        <h4 class="font-bold text-lg leading-tight mb-1 shadow-sm truncate pr-2">${p.title}</h4>
                        <div class="flex items-center flex-wrap gap-x-4 gap-y-1 text-xs text-slate-300 font-medium">
                            <span class="inline-flex items-center gap-1.5 min-w-0">
                              <i class="fa-solid fa-location-dot text-BTrustOn-accent"></i>
                              <span class="truncate min-w-0">${p.loc || (t("ui_unknown_location") || "Unknown Location")}</span>
                            </span>
                            <span class="inline-flex items-center gap-1.5">
                              <i class="fa-solid fa-calendar-days text-BTrustOn-accent"></i>
                              <span>${(p.project_date ? new Date(p.project_date).toLocaleDateString((currentLang==="tr" ? "tr-TR" : (currentLang==="es" ? "es-ES" : "en-US")),{year:'numeric',month:'short',day:'2-digit'}) : 'â€”')}</span>
                            </span>
                        </div>
                    </div>
                    
                    ${actionBtns}
                </div>

                <div class="p-5 flex flex-col flex-1">
                    <p class="text-sm text-gray-600 leading-relaxed whitespace-normal break-words line-clamp-4">
                        ${p.desc || (t("ui_no_description") || "No description provided.")}
                    </p>
                </div>
              `;
              projList.appendChild(card);
          });
      }
  }

  
  // Sertifikalar
  renderCertificates(company);

  // --- ASSETS (Cards + Viewer) ---
  try {
    // Reset UI controls each time we open a profile
    const s = document.getElementById("asset-search");
    const f = document.getElementById("asset-filter-status");
    const so = document.getElementById("asset-sort");
    if (s) s.value = "";
    if (f) f.value = "all";
    if (so) so.value = "newest";
    window.__assetUI = { query: "", status: "all", sort: "newest" };
  } catch(e) {}

  renderAssetsCards(company, isMyProfile);

  // ðŸ‘‡ GÃœNCELLENMÄ°Åž ANALÄ°TÄ°K YÃ–NETÄ°MÄ° (GÄ°ZLÄ°LÄ°K AYARLI) ðŸ‘‡
  
  // 1. Ziyaret SayacÄ±: Herkes iÃ§in Ã§alÄ±ÅŸÄ±r (Arka planda kaydeder)
  trackProfileView(company.id);

  // 2. Analitik KartÄ± GÃ¶sterimi: SADECE SAHÄ°BÄ°NE
  const analyticsCard = document.getElementById("profile-analytics-card");
  
  if (analyticsCard) {
      if (isMyProfile) {
          // A. Benim profilimse kartÄ± gÃ¶ster (Hidden sÄ±nÄ±fÄ±nÄ± kaldÄ±r)
          analyticsCard.classList.remove("hidden");
          
          // B. Verileri veritabanÄ±ndan Ã§ek ve doldur
          loadProfileAnalytics(company.id);
      } else {
          // A. BaÅŸkasÄ±nÄ±n profiliyse kartÄ± gizle
          analyticsCard.classList.add("hidden");
          
          // B. Veri Ã§ekme iÅŸlemini yapma (Gereksiz yÃ¼k olmasÄ±n)
      }
  }
// ðŸ‘‡ YENÄ°: PROFÄ°L WIDGET YÃ–NETÄ°MÄ° (Buraya Ekleyin) ðŸ‘‡
  const profileWidget = document.getElementById("profile-verify-widget");
  const widgetTax = document.getElementById("widget-reg-no");
  const widgetDuns = document.getElementById("widget-reg-url");

  if (profileWidget) {
      if (isMyProfile) {
          // 1. Profil sahibi ise Widget'Ä± gÃ¶ster
          profileWidget.classList.remove("hidden");
          
          // 2. KutularÄ± veritabanÄ± verisiyle doldur
          const widgetRegion = document.getElementById("widget-reg-region");
          if(widgetTax) widgetTax.value = company.registry_number || company.tax_id || "";
          if(widgetRegion) widgetRegion.value = company.registry_region || "";
          if(widgetDuns) widgetDuns.value = company.registry_url || "";
          
          // 3. Durumu (Kilitli/AÃ§Ä±k/SarÄ±/YeÅŸil) gÃ¼ncelle
          updateVerificationUI(company.verification_status);
          try { updateRegistryVerificationUI(); } catch(_) {}
      } else {
          // BaÅŸkasÄ± bakÄ±yorsa Widget'Ä± gizle
          profileWidget.classList.add("hidden");
      }
  }
    
  // âœ… Hide skeleton once profile UI is ready
  try { hideProfileSkeleton(); } catch(e) {}

  // âœ… If we came from an update card (deep link), jump to the exact entity
  if (__hasFocus) {
    try {
      const __t = __tabRequested || window.__profileActiveTab || 'overview';
      requestAnimationFrame(() => { try { focusProfileEntity(__t, __focusRequested); } catch(e) {} });
      setTimeout(() => { try { focusProfileEntity(__t, __focusRequested); } catch(e) {} }, 120);
    } catch(e) {}
  }

  // âœ… Restore tab/scroll after refresh (so closing gallery / deleting items doesn't jump to top)
  if (__preserveTab && __tabToRestore) {
    try { switchProfileTab(__tabToRestore); } catch(e) {}
  }
  if (__preserveScroll) {
    requestAnimationFrame(() => { try { window.scrollTo(0, __scrollY); } catch(e) {} });
    setTimeout(() => { try { window.scrollTo(0, __scrollY); } catch(e) {} }, 0);
  }
}

   // âœ… YENÄ° KAYDETME FONKSÄ°YONU (Supabase Uyumlu)
// âœ… 1. GÃœNCELLENMÄ°Åž KAYDETME FONKSÄ°YONU
/* --- %100 GARANTÄ°LÄ° KAYDETME FONKSÄ°YONU (SÄ°LME SORUNU Ã‡Ã–ZÃœLDÃœ) --- */
async function saveProfileData() {
  const btn = document.querySelector("#editor-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Uploading...";
  btn.disabled = true;

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("No active session found!");

    // --- 1. ÅžÄ°RKET LOGOSU ---
    let finalLogoUrl = selectedCompany.logo_url || null;
    if (typeof selectedLogoFile !== 'undefined' && selectedLogoFile) {
        const fileExt = selectedLogoFile.name.split('.').pop();
        const filePath = `${user.id}-${nowTs()}.${fileExt}`;
        const { error: uploadError } = await supabaseClient.storage.from('logos').upload(filePath, selectedLogoFile);
        if (uploadError) throw uploadError;
        const { data } = supabaseClient.storage.from('logos').getPublicUrl(filePath);
        finalLogoUrl = data.publicUrl;
    } else {
        if (document.getElementById("edit-logo-img").classList.contains("hidden")) {
            finalLogoUrl = null;
        }
    }

    // --- 2. DÄ°ÄžER STANDART VERÄ°LER ---
    const name = document.getElementById("edit-name").value.trim();
    const city = document.getElementById("edit-city").value.trim();
    const country = document.getElementById("edit-country").value;
    const regNo = (document.getElementById("edit-reg-no")?.value || "").trim();
    const regRegion = (document.getElementById("edit-reg-region")?.value || "").trim();
    const regUrl = (document.getElementById("edit-reg-url")?.value || "").trim();
    const address = document.getElementById("edit-address").value.trim();
    const sector = document.getElementById("edit-sector").value;
    const desc = document.getElementById("edit-desc").value.trim();
    const servicesStr = document.getElementById("edit-services").value.trim();
    const featuredStrRaw = (document.getElementById("edit-services-featured")?.value || "").trim();
    const serviceDetails = document.getElementById("edit-service-details").value.trim();
    // Featured services (comma-separated). If empty, fallback to first 5 services.
    let featuredStr = featuredStrRaw;
    if (!featuredStr) {
      const tmp = servicesStr.split(",").map(s => s.trim()).filter(Boolean);
      featuredStr = tmp.slice(0, 5).join(", ");
    }
    const website = document.getElementById("edit-website").value.trim();
    const phone = document.getElementById("edit-phone").value.trim();
    const contactEmail = document.getElementById("edit-email").value.trim();
    const typeVal = document.getElementById("edit-type").value;
    const sizeVal = document.getElementById("edit-size").value;
    const yearVal = document.getElementById("edit-year").value;
    const tagline = document.getElementById("edit-tagline").value.trim();

    // --- 3. OWNER VERÄ°LERÄ° (KRÄ°TÄ°K DÃœZELTME BURADA) ---
    // Toggle (Anahtar) aÃ§Ä±k mÄ±?
    const isOwnerActive = document.getElementById("edit-owner-toggle").checked;

    // DeÄŸiÅŸkenleri varsayÄ±lan olarak NULL (BOÅž) yapÄ±yoruz
    let ownerName = null;
    let ownerRole = null;
    let ownerLink = null;
    let finalOwnerPhotoUrl = null;

    // SADECE Anahtar AÃ‡IKSA verileri dolduruyoruz
    if (isOwnerActive) {
        ownerName = document.getElementById("edit-owner-name").value.trim();
        ownerRole = document.getElementById("edit-owner-role").value.trim();
        ownerLink = document.getElementById("edit-owner-linkedin").value.trim();
        
        // FotoÄŸraf MantÄ±ÄŸÄ±
        finalOwnerPhotoUrl = selectedCompany.owner_photo_url || null;
        
        if (typeof selectedOwnerFile !== 'undefined' && selectedOwnerFile) {
            const fileExt = selectedOwnerFile.name.split('.').pop();
            const filePath = `owner-${user.id}-${nowTs()}.${fileExt}`;
            const { error: upErr } = await supabaseClient.storage.from('logos').upload(filePath, selectedOwnerFile);
            if (!upErr) {
                const { data } = supabaseClient.storage.from('logos').getPublicUrl(filePath);
                finalOwnerPhotoUrl = data.publicUrl;
            }
        }
        
        const isOwnerImgVisible = !document.getElementById("preview-owner-img").classList.contains("hidden");
        if (!isOwnerImgVisible && (typeof selectedOwnerFile === 'undefined' || !selectedOwnerFile)) {
            finalOwnerPhotoUrl = null;
        }
    } 
    // EÄžER KAPALIYSA HÄ°Ã‡BÄ°R ÅžEY YAPMIYORUZ, YUKARIDA ZATEN NULL TANIMLADIK.
    // BÃ¶ylece input iÃ§inde yazÄ± kalsa bile biz onu 'null' olarak kaydediyoruz.

    // --- 4. GÃœNCELLEME PAKETÄ° ---
    const updates = {
      company_name: name,
      city: city,
      country: country,
      registry_country: country,
      registry_region: regRegion || null,
      registry_number: regNo || null,
      registry_url: regUrl || null,
      address: address,
      tagline: tagline,
      sector: sector,
      description: desc,
      services: servicesStr,
      services_featured: featuredStr,
      service_details: serviceDetails,
      website: website,
      phone: phone,
      contact_email: contactEmail,
      company_type: typeVal,
      company_size: sizeVal,
      founded_year: yearVal,
      logo_url: finalLogoUrl,
      
      // Owner verileri (Ya dolu gelir ya da NULL gelir)
      owner_name: ownerName,
      owner_role: ownerRole,
      owner_linkedin: ownerLink,
      owner_photo_url: finalOwnerPhotoUrl,

      updated_at: nowDate(),
    };

    // --- 5. DB GÃ–NDER ---
    let { error } = await supabaseClient
      .from('profiles')
      .update(updates)
      .eq('id', myCompanyIdOr(user.id));

    // If the DB doesn't have a column yet, retry without it (backward compatible)
    if (error && String(error.message || "").toLowerCase().includes("does not exist")) {
      const __msg = String(error.message || "").toLowerCase();
      try { if (__msg.includes("services_featured")) delete updates.services_featured; } catch(e) {}
      try {
        if (__msg.includes("registry_country") || __msg.includes("registry_region") || __msg.includes("registry_number") || __msg.includes("registry_url") || __msg.includes("registry_")) {
          delete updates.registry_country;
          delete updates.registry_region;
          delete updates.registry_number;
          delete updates.registry_url;
        }
      } catch(e) {}
      ({ error } = await supabaseClient
        .from('profiles')
        .update(updates)
        .eq('id', myCompanyIdOr(user.id)));
    }
if (error) throw error;

    showToast(
      (t("toast_success_title") || (currentLang==="tr" ? "BaÅŸarÄ±lÄ±" : (currentLang==="es" ? "Ã‰xito" : "Success"))),
      (t("toast_profile_updated_success") || (currentLang==="tr" ? "Profil baÅŸarÄ±yla gÃ¼ncellendi!" : (currentLang==="es" ? "Â¡Perfil actualizado correctamente!" : "Profile updated successfully!"))),
      "success"
    );

    // --- 6. LOCAL HAFIZAYI GÃœNCELLE ---
    const localCompany = database.find(c => c.id == myCompanyIdOr(user.id));
    if (localCompany) {
        Object.assign(localCompany, {
            name, city, country, sector, desc, tagline,
            registry_country: country,
            registry_region: regRegion || null,
            registry_number: regNo || null,
            registry_url: regUrl || null,
            website, phone, contact_email: contactEmail,
            address, type_label: typeVal, size_label: sizeVal, year_label: yearVal,
            logo_url: finalLogoUrl,
            services: servicesStr.split(',').map(s => s.trim()).filter(s => s),
            services_featured: featuredStr,
            service_details: serviceDetails,
            
            // BURASI Ã‡OK Ã–NEMLÄ°: Hesaplanan (veya null olan) deÄŸerleri basÄ±yoruz
            owner_name: ownerName,
            owner_role: ownerRole,
            owner_linkedin: ownerLink,
            owner_photo_url: finalOwnerPhotoUrl
        });
    }


    // --- 6B. CANLI GÃ–RÃœNÃœMÃœ SENKRONLA (Vitrin + Home Updates) ---
    try {
      if (typeof selectedCompany !== "undefined" && selectedCompany && String(selectedCompany.id) === String(myCompanyIdOr(user.id))) {
        if (localCompany) selectedCompany = localCompany;
      }
    } catch(e){}

    // Keep optional in-memory lists in sync too (if present)
    try {
      if (typeof companiesData !== "undefined" && Array.isArray(companiesData)) {
        const idx = companiesData.findIndex(c => c && String(c.id) === String(myCompanyIdOr(user.id)));
        if (idx > -1 && localCompany) companiesData[idx] = { ...companiesData[idx], ...localCompany };
      }
    } catch(e){}

    // Re-render showcase/search instantly
    try {
      if (typeof dedupeDatabasePreferReal === "function") dedupeDatabasePreferReal();

      if (typeof isSearchActive !== "undefined" && !!isSearchActive) {
        const qEl = document.getElementById("search-input");
        const q = qEl ? qEl.value : "";
        if (typeof renderSearchResults === "function") renderSearchResults(q);
      } else {
        if (typeof renderShowcase === "function") renderShowcase();
      }

      if (typeof refreshCompanyCardsAfterSavedChange === "function") {
        refreshCompanyCardsAfterSavedChange();
      }
    } catch(e){}

    // Re-render home updates so old posts immediately show new logo/name
    try {
      if (typeof homeUpdatesData !== "undefined" && Array.isArray(homeUpdatesData) && typeof renderHomeUpdates === "function") {
        renderHomeUpdates(homeUpdatesData);
      }
    } catch(e){}

    openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true, tab: (window.__profileActiveTab || 'overview') });
    
    // Re-render the profile instantly (no manual refresh needed)
    try {
      await openProfile(myCompanyIdOr(user.id), { preserveTab: true });
    } catch(e) {
      try {
        document.getElementById("view-editor").classList.add("hidden-view");
        document.getElementById("view-profile").classList.remove("hidden-view");
        document.getElementById("back-btn").classList.remove("hidden", "hidden-view");
      } catch(_) {}
    }

  } catch (error) {
    console.error("Error:", error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

    
function showProfileSkeleton() {
  const el = document.getElementById("profile-skeleton");
  if (!el) return;
  el.classList.remove("hidden");
  // toast yerine skeleton kullan
  window.__suppressProfileLoadingToasts = true;
}
function hideProfileSkeleton() {
  const el = document.getElementById("profile-skeleton");
  if (!el) return;
  el.classList.add("hidden");
  window.__suppressProfileLoadingToasts = false;
}

function showMainView() {

      // Ensure profile loader is off on Home
      try { hideProfileSkeleton(); } catch(e) {}
      // Remember last view (prevents "random" landing on refresh)
      try { localStorage.setItem("BTrustOn_last_route", "home"); } catch(e) {}

      // Clear any company route from the URL (clean + professional)
// - KullanÄ±cÄ± UI ile listeye dÃ¶nÃ¼yorsa pushState (browser Back/Forward tutarlÄ±)
// - Restore sÄ±rasÄ±nda replaceState
try {
  const base = window.location.pathname + window.location.search;
  const hadHash = !!window.location.hash;
  const st = { view: "home", t: nowTs() };
  if (history && history.pushState && hadHash && !window.__routeRestoring) {
    history.pushState(st, "", base);
  } else if (history && history.replaceState) {
    history.replaceState(st, "", base);
  } else {
    window.location.hash = "";
  }
} catch(e) {}

      const viewDashboard = document.getElementById("view-dashboard");
      const viewProfile = document.getElementById("view-profile");
      const viewEditor = document.getElementById("view-editor");
      const backBtn = document.getElementById("back-btn");
      if (viewDashboard) viewDashboard.classList.remove("hidden-view");
      if (viewProfile) viewProfile.classList.add("hidden-view");
      if (viewEditor) viewEditor.classList.add("hidden-view");
      if (backBtn) backBtn.classList.add("hidden", "hidden-view");
// âœ… Always start Home at top
      try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch(e) { try { window.scrollTo(0,0); } catch(_) {} }

    }
/* --- EKSÄ°K OLAN FONKSÄ°YON: EditÃ¶r EkranÄ±nÄ± GÃ¶ster --- */
function showEditorView() {
  const viewDashboard = document.getElementById("view-dashboard");
  const viewProfile = document.getElementById("view-profile");
  const viewEditor = document.getElementById("view-editor");
  const viewMessage = document.getElementById("view-message"); 
  const backBtn = document.getElementById("back-btn");
  // 1. DiÄŸer tÃ¼m ekranlarÄ± gizle
  if (viewDashboard) viewDashboard.classList.add("hidden-view");
  if (viewProfile) viewProfile.classList.add("hidden-view");
  if (viewMessage) viewMessage.classList.add("hidden-view");
  
  // 2. EditÃ¶r ekranÄ±nÄ± aÃ§
  if (viewEditor) viewEditor.classList.remove("hidden-view");
  
  // 3. Back butonunu gizle (EditÃ¶rde kendi Cancel butonu var)
  if (backBtn) backBtn.classList.add("hidden", "hidden-view"); 

  // 4. SayfayÄ± en Ã¼ste kaydÄ±r
  window.scrollTo(0, 0);

  // âœ… Show welcome modal only right after join
  try { setTimeout(() => { try { btonMaybeShowWelcomeModal('editor'); } catch(e) {} }, 220); } catch(e) {}
}



/* =========================
   Welcome Modal logic (Join -> Editor)
========================= */
function btonShowWelcomeModal() {
  const overlay = document.getElementById("bton-welcome-overlay");
  if (!overlay) return;
  overlay.classList.remove("hidden");
  overlay.setAttribute("aria-hidden", "false");
  document.body.classList.add("bton-modal-open");
  requestAnimationFrame(() => { try { overlay.classList.add("show"); } catch(e) {} });
  // Bind ESC once
  if (!window.__BTON_WELCOME_ESC_BOUND) {
    window.__BTON_WELCOME_ESC_BOUND = true;
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        try { btonHideWelcomeModal(); } catch(_) {}
      }
    });
  }
}
function btonHideWelcomeModal() {
  const overlay = document.getElementById("bton-welcome-overlay");
  if (!overlay) return;
  try { overlay.classList.remove("show"); } catch(e) {}
  overlay.setAttribute("aria-hidden", "true");
  document.body.classList.remove("bton-modal-open");
  setTimeout(() => { try { overlay.classList.add("hidden"); } catch(e) {} }, 160);

  try {
    const uid = (localStorage.getItem("BTrustOn_just_joined_uid") || "").trim() || (selectedCompany?.id || "");
    const seenKey = uid ? `BTrustOn_welcome_seen_${uid}` : "BTrustOn_welcome_seen";
    localStorage.setItem(seenKey, "1");
    localStorage.removeItem("BTrustOn_welcome_pending");
  } catch(e) {}
}

function btonWelcomeCta() {
  // Close modal and take user to the top of Profile Editor (no tab jump)
  try { btonHideWelcomeModal(); } catch(e) {}
  try {
    // Prefer scrolling to the editor hero/top
    const hero = document.querySelector('#view-editor .bton-editor-hero');
    if (hero && hero.scrollIntoView) {
      hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
      return;
    }
  } catch(e) {}
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}
}

function btonMaybeShowWelcomeModal(source) {
  try {
    if (localStorage.getItem("BTrustOn_welcome_pending") !== "1") return;

    const uid = (localStorage.getItem("BTrustOn_just_joined_uid") || "").trim() || (selectedCompany?.id || "");
    const seenKey = uid ? `BTrustOn_welcome_seen_${uid}` : "BTrustOn_welcome_seen";
    if (localStorage.getItem(seenKey) === "1") {
      localStorage.removeItem("BTrustOn_welcome_pending");
      return;
    }

    btonShowWelcomeModal();
  } catch(e) {}
}



/* =========================
   SERVICES TAG EDITOR (chips + reorder)
   - Stores canonical value in hidden #edit-services (comma-separated)
   - User-selected â­ tags are treated as "Featured" on profile
========================= */

window.__svcEditor = window.__svcEditor || { tags: [], featured: [], dragIndex: null, bound: false };

// --- Services taxonomy (i18n-ready) ---
// Store canonical tokens as "svc:<id>" so labels can be translated via i18n JSON packs.
const SVC_LIBRARY = [
  { id: "3d_laser_scanning", fallback: "3D Laser Scanning" },
  { id: "3pl", fallback: "3PL / Logistics Provider" },
  { id: "after_sales_service", fallback: "After-sales Service" },
  { id: "ai_ml", fallback: "AI / Machine Learning" },
  { id: "air_emissions", fallback: "Air Emissions Monitoring" },
  { id: "air_freight", fallback: "Air Freight" },
  { id: "arc_flash", fallback: "Arc Flash Study" },
  { id: "assaying", fallback: "Assaying" },
  { id: "asset_management", fallback: "Asset Management" },
  { id: "atex", fallback: "ATEX Compliance" },
  { id: "auditing", fallback: "Auditing" },
  { id: "automation_engineering", fallback: "Automation Engineering" },
  { id: "mine_backfill", fallback: "Backfill" },
  { id: "basic_engineering", fallback: "Basic Engineering" },
  { id: "bearings", fallback: "Bearings" },
  { id: "bim", fallback: "BIM" },
  { id: "biodiversity", fallback: "Biodiversity" },
  { id: "blast_hole_drilling", fallback: "Blast Hole Drilling" },
  { id: "blasting", fallback: "Blasting" },
  { id: "boilers", fallback: "Boilers" },
  { id: "brand_marketing", fallback: "Brand & Marketing" },
  { id: "bridges", fallback: "Bridges" },
  { id: "building_construction", fallback: "Building Construction" },
  { id: "bulk_handling", fallback: "Bulk Material Handling" },
  { id: "cables", fallback: "Cables" },
  { id: "calibration", fallback: "Calibration" },
  { id: "camp_catering", fallback: "Camp & Catering" },
  { id: "carbon_management", fallback: "Carbon Management" },
  { id: "ceu_compliance", fallback: "CE / EU Compliance" },
  { id: "certification_support", fallback: "Certification Support" },
  { id: "change_management", fallback: "Change Management" },
  { id: "chemicals_supply", fallback: "Chemicals Supply" },
  { id: "cip_cil", fallback: "CIP / CIL" },
  { id: "civil_engineering", fallback: "Civil Engineering" },
  { id: "civil_works", fallback: "Civil Works" },
  { id: "cladding", fallback: "Cladding" },
  { id: "claims_management", fallback: "Claims Management" },
  { id: "cloud_services", fallback: "Cloud Services" },
  { id: "coating_painting", fallback: "Coating & Painting" },
  { id: "commissioning", fallback: "Commissioning" },
  { id: "compressors", fallback: "Compressors" },
  { id: "concept_study", fallback: "Concept Study" },
  { id: "concreting", fallback: "Concreting" },
  { id: "condition_monitoring", fallback: "Condition Monitoring" },
  { id: "construction", fallback: "Construction" },
  { id: "consultancy", fallback: "Consultancy" },
  { id: "contract_management", fallback: "Contract Management" },
  { id: "control_panels", fallback: "Control Panels" },
  { id: "control_room", fallback: "Control Room Design" },
  { id: "control_system_integration", fallback: "Control System Integration" },
  { id: "conveyors", fallback: "Conveyors" },
  { id: "core_drilling", fallback: "Core Drilling" },
  { id: "cost_control", fallback: "Cost Control" },
  { id: "cranes_rigging", fallback: "Cranes & Rigging" },
  { id: "crushing_screening", fallback: "Crushing & Screening" },
  { id: "customs_brokerage", fallback: "Customs Brokerage" },
  { id: "cybersecurity", fallback: "Cybersecurity" },
  { id: "data_analytics", fallback: "Data Analytics" },
  { id: "dcs", fallback: "DCS" },
  { id: "demolition", fallback: "Demolition" },
  { id: "desalination", fallback: "Desalination" },
  { id: "detailed_engineering", fallback: "Detailed Engineering" },
  { id: "drainage_dewatering", fallback: "Dewatering" },
  { id: "digital_transformation", fallback: "Digital Transformation" },
  { id: "digital_twin", fallback: "Digital Twin" },
  { id: "distribution_networks", fallback: "Distribution Networks" },
  { id: "document_control", fallback: "Document Control" },
  { id: "doors_windows", fallback: "Doors & Windows" },
  { id: "drill_blast_design", fallback: "Drill & Blast Design" },
  { id: "drones_photogrammetry", fallback: "Drones & Photogrammetry" },
  { id: "earthing_grounding", fallback: "Earthing & Grounding" },
  { id: "earthmoving", fallback: "Earthmoving" },
  { id: "earthworks", fallback: "Earthworks" },
  { id: "eia_permitting", fallback: "EIA & Permitting" },
  { id: "electrical_engineering", fallback: "Electrical Engineering" },
  { id: "electrical_installation", fallback: "Electrical Installation" },
  { id: "electrical_panels", fallback: "Electrical Panels" },
  { id: "electrical_studies", fallback: "Electrical Studies" },
  { id: "electrical_testing", fallback: "Electrical Testing" },
  { id: "emergency_response", fallback: "Emergency Response" },
  { id: "energy_efficiency", fallback: "Energy Efficiency" },
  { id: "engineering_design", fallback: "Engineering Design" },
  { id: "engineering_software", fallback: "Engineering Software" },
  { id: "environment", fallback: "Environment" },
  { id: "environmental", fallback: "Environmental Consulting" },
  { id: "epc", fallback: "EPC" },
  { id: "epcm", fallback: "EPCM" },
  { id: "equipment_manufacturing", fallback: "Equipment Manufacturing" },
  { id: "equipment_rental", fallback: "Equipment Rental" },
  { id: "erp_systems", fallback: "ERP Systems" },
  { id: "excavation", fallback: "Excavation" },
  { id: "expediting", fallback: "Expediting" },
  { id: "exploration", fallback: "Exploration" },
  { id: "explosives_supply", fallback: "Explosives Supply" },
  { id: "export_import", fallback: "Export / Import Services" },
  { id: "fabrication", fallback: "Fabrication" },
  { id: "facility_management", fallback: "Facility Management" },
  { id: "fat_sat", fallback: "FAT / SAT" },
  { id: "feasibility_study", fallback: "Feasibility Study" },
  { id: "field_service", fallback: "Field Service" },
  { id: "financial_advisory", fallback: "Financial Advisory" },
  { id: "finishing_works", fallback: "Finishing Works" },
  { id: "fire_protection", fallback: "Fire Protection Systems" },
  { id: "fire_safety", fallback: "Fire Safety Engineering" },
  { id: "first_aid", fallback: "First Aid" },
  { id: "fleet_leasing", fallback: "Fleet Leasing" },
  { id: "fleet_management", fallback: "Fleet Management" },
  { id: "flooring", fallback: "Flooring" },
  { id: "flotation", fallback: "Flotation" },
  { id: "forklifts", fallback: "Forklifts" },
  { id: "formwork", fallback: "Formwork" },
  { id: "foundations", fallback: "Foundations" },
  { id: "freight_forwarding", fallback: "Freight Forwarding" },
  { id: "fuel_supply", fallback: "Fuel Supply" },
  { id: "functional_safety", fallback: "Functional Safety (SIL)" },
  { id: "gearboxes", fallback: "Gearboxes" },
  { id: "generators", fallback: "Generators" },
  { id: "geochemistry", fallback: "Geochemistry" },
  { id: "geology", fallback: "Geology" },
  { id: "geophysics", fallback: "Geophysics" },
  { id: "geotechnical", fallback: "Geotechnical Engineering" },
  { id: "gis_mapping", fallback: "GIS & Mapping" },
  { id: "grade_control", fallback: "Grade Control" },
  { id: "grinding_milling", fallback: "Grinding / Milling" },
  { id: "ground_support", fallback: "Ground Support" },
  { id: "harmonic_analysis", fallback: "Harmonic Analysis" },
  { id: "haulage", fallback: "Haulage" },
  { id: "hazardous_area", fallback: "Hazardous Area Classification" },
  { id: "hazmat_handling", fallback: "Hazmat Handling" },
  { id: "hazop", fallback: "HAZOP" },
  { id: "heap_leach", fallback: "Heap Leach" },
  { id: "heat_exchangers", fallback: "Heat Exchangers" },
  { id: "heavy_equipment", fallback: "Heavy Equipment" },
  { id: "heavy_lift", fallback: "Heavy Lift" },
  { id: "hse", fallback: "HSE / Safety Management" },
  { id: "hvac", fallback: "HVAC" },
  { id: "hydraulics", fallback: "Hydraulics" },
  { id: "hydrogeology", fallback: "Hydrogeology" },
  { id: "iiot_sensors", fallback: "IIoT Sensors" },
  { id: "incoterms_consulting", fallback: "Incoterms Consulting" },
  { id: "industrial_buildings", fallback: "Industrial Buildings" },
  { id: "industrial_cleaning", fallback: "Industrial Cleaning" },
  { id: "industrial_gases", fallback: "Industrial Gases" },
  { id: "industrial_iot_platform", fallback: "Industrial IoT Platform" },
  { id: "inspection", fallback: "Inspection" },
  { id: "instrument_calibration", fallback: "Instrument Calibration" },
  { id: "instrumentation_controls", fallback: "Instrumentation & Controls" },
  { id: "instrumentation_engineering", fallback: "Instrumentation Engineering" },
  { id: "instrumentation_installation", fallback: "Instrumentation Installation" },
  { id: "instrumentation_panels", fallback: "Instrumentation Panels" },
  { id: "insulation", fallback: "Insulation" },
  { id: "insurance_brokering", fallback: "Insurance Brokerage" },
  { id: "international_shipping", fallback: "International Shipping" },
  { id: "inventory_management", fallback: "Inventory Management" },
  { id: "investment_advisory", fallback: "Investment Advisory" },
  { id: "iso_consulting", fallback: "ISO Consulting" },
  { id: "it_support", fallback: "IT Support" },
  { id: "laboratory_services", fallback: "Laboratory Services" },
  { id: "laboratory_testing", fallback: "Laboratory Testing" },
  { id: "last_mile_delivery", fallback: "Last-mile Delivery" },
  { id: "leaching", fallback: "Leaching" },
  { id: "legal_consulting", fallback: "Legal Consulting" },
  { id: "lidar_scanning", fallback: "LiDAR Scanning" },
  { id: "lifting_equipment", fallback: "Lifting Equipment" },
  { id: "lightning_protection", fallback: "Lightning Protection" },
  { id: "load_flow", fallback: "Load Flow Study" },
  { id: "loop_checking", fallback: "Loop Checking" },
  { id: "lubricants", fallback: "Lubricants" },
  { id: "lubrication", fallback: "Lubrication Systems" },
  { id: "machinery_safety", fallback: "Machinery Safety" },
  { id: "machining", fallback: "Machining" },
  { id: "maintenance", fallback: "Maintenance" },
  { id: "management_consulting", fallback: "Management Consulting" },
  { id: "market_research", fallback: "Market Research" },
  { id: "materials_handling", fallback: "Material Handling" },
  { id: "mechanical_design", fallback: "Mechanical Engineering" },
  { id: "mechanical_installation", fallback: "Mechanical Installation" },
  { id: "medical_services", fallback: "Medical Services" },
  { id: "mes_systems", fallback: "MES Systems" },
  { id: "metallurgy", fallback: "Metallurgy" },
  { id: "metrology", fallback: "Metrology" },
  { id: "mine_permitting", fallback: "Mine Permitting" },
  { id: "mine_planning", fallback: "Mine Planning" },
  { id: "mine_survey", fallback: "Mine Survey" },
  { id: "mining_services", fallback: "Mining Services" },
  { id: "mobile_equipment", fallback: "Mobile Equipment" },
  { id: "motors_drives", fallback: "Motors & Drives" },
  { id: "ndt", fallback: "NDT (Non-Destructive Testing)" },
  { id: "network_infrastructure", fallback: "Network Infrastructure" },
  { id: "noise_vibration", fallback: "Noise & Vibration" },
  { id: "oem_supply", fallback: "OEM Supply" },
  { id: "open_pit_mining", fallback: "Open Pit Mining" },
  { id: "operations_maintenance", fallback: "Operations & Maintenance" },
  { id: "overburden_removal", fallback: "Overburden Removal" },
  { id: "oxygen_nitrogen", fallback: "Oxygen / Nitrogen" },
  { id: "packaging", fallback: "Packaging" },
  { id: "painting_finishing", fallback: "Painting" },
  { id: "paste_backfill", fallback: "Paste Backfill" },
  { id: "pipe_spools", fallback: "Pipe Spools" },
  { id: "pipelines", fallback: "Pipelines" },
  { id: "piping", fallback: "Piping" },
  { id: "piping_engineering", fallback: "Piping Engineering" },
  { id: "pit_services", fallback: "Pit Services" },
  { id: "planning_scheduling", fallback: "Planning & Scheduling" },
  { id: "plant_maintenance", fallback: "Plant Maintenance" },
  { id: "plc_automation", fallback: "PLC & Automation" },
  { id: "pneumatics", fallback: "Pneumatics" },
  { id: "ports_terminals", fallback: "Ports & Terminals" },
  { id: "power_generation", fallback: "Power Generation" },
  { id: "power_quality", fallback: "Power Quality" },
  { id: "prefeasibility_study", fallback: "Pre-Feasibility Study" },
  { id: "concrete_precast", fallback: "Precast Concrete" },
  { id: "predictive_maintenance", fallback: "Predictive Maintenance" },
  { id: "pressure_vessels", fallback: "Pressure Vessels" },
  { id: "printing_signage", fallback: "Printing & Signage" },
  { id: "process_control", fallback: "Process Control" },
  { id: "process_engineering", fallback: "Process Engineering" },
  { id: "process_safety", fallback: "Process Safety" },
  { id: "procurement", fallback: "Procurement" },
  { id: "procurement_consulting", fallback: "Procurement Consulting" },
  { id: "product_management", fallback: "Product Management" },
  { id: "project_management", fallback: "Project Management" },
  { id: "pumps", fallback: "Pumps" },
  { id: "qa_qc", fallback: "Quality Assurance / QC" },
  { id: "radiation_safety", fallback: "Radiation Safety" },
  { id: "rail_freight", fallback: "Rail Freight" },
  { id: "raise_boring", fallback: "Raise Boring" },
  { id: "ram_studies", fallback: "RAM Studies" },
  { id: "rc_drilling", fallback: "RC Drilling" },
  { id: "reagents_supply", fallback: "Reagents Supply" },
  { id: "rebar_fixing", fallback: "Rebar Fixing" },
  { id: "recruitment_staffing", fallback: "Recruitment / Staffing" },
  { id: "refractory", fallback: "Refractory" },
  { id: "rehabilitation_closure", fallback: "Rehabilitation & Closure" },
  { id: "relay_protection", fallback: "Relay Protection" },
  { id: "reliability_engineering", fallback: "Reliability Engineering" },
  { id: "remote_monitoring", fallback: "Remote Monitoring" },
  { id: "renewable_energy", fallback: "Renewable Energy Integration" },
  { id: "risk_assessment", fallback: "Risk Assessment" },
  { id: "road_transport", fallback: "Road Transport" },
  { id: "roads_infrastructure", fallback: "Roads & Infrastructure" },
  { id: "roofing", fallback: "Roofing" },
  { id: "rope_access", fallback: "Rope Access" },
  { id: "rotating_equipment", fallback: "Rotating Equipment" },
  { id: "sales_business_dev", fallback: "Sales / Business Development" },
  { id: "sampling", fallback: "Sampling" },
  { id: "sandblasting", fallback: "Sandblasting" },
  { id: "scada", fallback: "SCADA" },
  { id: "scaffolding", fallback: "Scaffolding" },
  { id: "sea_freight", fallback: "Sea Freight" },
  { id: "security_services", fallback: "Security Services" },
  { id: "short_circuit", fallback: "Short Circuit Study" },
  { id: "shotcrete", fallback: "Shotcrete" },
  { id: "shutdown_turnaround", fallback: "Shutdown / Turnaround" },
  { id: "shutdown_services", fallback: "Shutdown Services" },
  { id: "site_clinic", fallback: "Site Clinic" },
  { id: "site_supervision", fallback: "Site Supervision" },
  { id: "software_development", fallback: "Software Development" },
  { id: "sop_procedures", fallback: "SOP / Procedures" },
  { id: "spare_parts", fallback: "Spare Parts" },
  { id: "spare_parts_supply", fallback: "Spare Parts Supply" },
  { id: "spares_management", fallback: "Spares Management" },
  { id: "spill_response", fallback: "Spill Response" },
  { id: "startup_rampup", fallback: "Startup & Ramp-up" },
  { id: "steel_erection", fallback: "Steel Erection" },
  { id: "steel_structures", fallback: "Steel Structures" },
  { id: "strategy_consulting", fallback: "Strategy Consulting" },
  { id: "structural_engineering", fallback: "Structural Engineering" },
  { id: "structural_steel", fallback: "Structural Steel" },
  { id: "substations", fallback: "Substations" },
  { id: "supply_chain_consulting", fallback: "Supply Chain Consulting" },
  { id: "supply_chain_management", fallback: "Supply Chain Management" },
  { id: "surveying", fallback: "Surveying" },
  { id: "sustainability_esg", fallback: "Sustainability / ESG" },
  { id: "switchgear", fallback: "Switchgear" },
  { id: "system_integration", fallback: "System Integration" },
  { id: "tailings_filtration", fallback: "Tailings Filtration" },
  { id: "tailings_management", fallback: "Tailings Management" },
  { id: "tank_fabrication", fallback: "Tank Fabrication" },
  { id: "tank_farms", fallback: "Tank Farms" },
  { id: "tax_finance_consulting", fallback: "Tax & Finance Consulting" },
  { id: "technical_sales", fallback: "Technical Sales" },
  { id: "telecom", fallback: "Telecom & Communications" },
  { id: "temporary_labor", fallback: "Temporary Labor" },
  { id: "testing_commissioning", fallback: "Testing & Commissioning" },
  { id: "thickening_filtration", fallback: "Thickening & Filtration" },
  { id: "third_party_inspection", fallback: "Third-party Inspection" },
  { id: "training", fallback: "Training" },
  { id: "transformers", fallback: "Transformers" },
  { id: "translation_interpretation", fallback: "Translation / Interpretation" },
  { id: "transmission_lines", fallback: "Transmission Lines" },
  { id: "transport_logistics", fallback: "Transport & Logistics" },
  { id: "travel_services", fallback: "Travel Services" },
  { id: "tyres_tracks", fallback: "Tyres & Tracks" },
  { id: "ui_ux", fallback: "UI/UX Design" },
  { id: "underground_mining", fallback: "Underground Mining" },
  { id: "valves", fallback: "Valves" },
  { id: "vendor_inspection", fallback: "Vendor Inspection" },
  { id: "ventilation", fallback: "Ventilation" },
  { id: "visa_support", fallback: "Visa Support" },
  { id: "warehousing", fallback: "Warehousing" },
  { id: "warranty_support", fallback: "Warranty Support" },
  { id: "waste_management", fallback: "Waste Management" },
  { id: "waste_oil_management", fallback: "Waste Oil Management" },
  { id: "wastewater_treatment", fallback: "Wastewater Treatment" },
  { id: "water_resource_management", fallback: "Water Resource Management" },
  { id: "water_supply", fallback: "Water Supply" },
  { id: "water_treatment", fallback: "Water Treatment" },
  { id: "wear_parts", fallback: "Wear Parts / Liners" },
  { id: "welding", fallback: "Welding" }
];

const SVC_BY_ID = new Map(SVC_LIBRARY.map(x => [x.id, x]));

function svcI18nKeyFromId(id) {
  return "svc_tag_" + String(id || "").trim();
}

function svcLabelById(id) {
  const it = SVC_BY_ID.get(String(id || "").trim());
  if (!it) return "";
  const key = svcI18nKeyFromId(it.id);
  // Prefer current language pack; fallback to EN; then fallback label.
  const viaT = (typeof t === "function") ? (t(key) || "") : "";
  if (viaT) return viaT;
  try {
    const enPack = (typeof translations === "object" && translations && translations.en) ? translations.en : null;
    if (enPack && enPack[key]) return String(enPack[key] || "");
  } catch (e) {}
  return it.fallback || "";
}

function svcTokenToId(rawTag) {
  const raw = String(rawTag || "").trim();
  if (!raw) return "";
  if (raw.toLowerCase().startsWith("svc:")) {
    let id = raw.slice(4).trim();
    if (id.toLowerCase().startsWith("svc_tag_")) id = id.slice(8);
    return id;
  }
  return "";
}

function _svcAliasSignature() {
  // Rebuild alias map when packs load/expand.
  try {
    const packs = (typeof translations === "object" && translations) ? translations : {};
    const cur = String(window.currentLang || localStorage.getItem("bton_lang") || "en").toLowerCase();
    const a = packs.en ? Object.keys(packs.en).length : 0;
    const b = packs.tr ? Object.keys(packs.tr).length : 0;
    const c = packs[cur] ? Object.keys(packs[cur]).length : 0;
    return [a,b,c,cur].join("|");
  } catch (e) {
    return "0|0|0|en";
  }
}

window.__svcAliasCache = window.__svcAliasCache || { sig: "", map: null };

function _svcBuildAliasMap() {
  const packs = (typeof translations === "object" && translations) ? translations : {};
  const m = new Map();
  SVC_LIBRARY.forEach(it => {
    const key = svcI18nKeyFromId(it.id);
    const labels = new Set();
    if (it.fallback) labels.add(it.fallback);
    try {
      if (packs.en && packs.en[key]) labels.add(packs.en[key]);
      if (packs.tr && packs.tr[key]) labels.add(packs.tr[key]);
      const curLabel = (typeof t === "function") ? t(key) : "";
      if (curLabel) labels.add(curLabel);
    } catch (e) {}

    // also accept id as a typed value (with spaces)
    labels.add(String(it.id || "").replace(/_/g, " "));

    labels.forEach(l => {
      const k = _svcKey(l);
      if (k) m.set(k, it.id);
    });
  });
  return m;
}

function _svcAliasMap() {
  const sig = _svcAliasSignature();
  if (window.__svcAliasCache.map && window.__svcAliasCache.sig === sig) return window.__svcAliasCache.map;
  const built = _svcBuildAliasMap();
  window.__svcAliasCache = { sig, map: built };
  return built;
}

function svcCanonicalizeTag(rawTag) {
  const raw = _svcNorm(rawTag);
  if (!raw) return "";
  const idFromToken = svcTokenToId(raw);
  if (idFromToken) {
    if (SVC_BY_ID.has(idFromToken)) return "svc:" + idFromToken;
    return raw; // unknown token; keep
  }
  const alias = _svcAliasMap();
  const id = alias.get(_svcKey(raw));
  if (id) return "svc:" + id;
  return raw;
}

function getServiceSuggestions(query) {
  const q = _svcKey(query);
  if (!q) return [];
  const out = [];
  for (const it of SVC_LIBRARY) {
    const label = svcLabelById(it.id) || it.fallback || it.id;
    const hay = (String(label) + " " + String(it.fallback || "")).toLowerCase();
    if (hay.includes(q)) {
      out.push({ token: "svc:" + it.id, label });
      if (out.length >= 12) break;
    }
  }
  return out;
}

function svcHumanizeId(id) {
  return String(id || "")
    .replace(/^svc_tag_?/i, "")
    .replace(/^svc[:\s]*/i, "")
    .replace(/[_\-]+/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .replace(/\b\w/g, (m) => m.toUpperCase());
}

function svcDisplayLabel(tag) {
  const raw0 = String(tag || "").trim();
  if (!raw0) return "";

  // Strip common prefixes (svc:, svv:) and whitespace variants
  const mm = raw0.match(/^(?:svc|svv)\s*:\s*(.+)$/i);
  const raw = mm ? String(mm[1] || "").trim() : raw0;

  // If token/id is known in library, prefer its translated label (fallback to EN, then fallback label)
  try {
    const id = (typeof svcTokenToId === "function") ? (svcTokenToId(raw0) || svcTokenToId(raw) || "") : "";
    const finalId = id || (typeof SVC_BY_ID !== "undefined" && SVC_BY_ID && SVC_BY_ID.has(raw) ? raw : "");
    if (finalId && typeof svcLabelById === "function") {
      const label = svcLabelById(finalId);
      if (label) return label;
      if (typeof svcHumanizeId === "function") return svcHumanizeId(finalId);
      return String(finalId);
    }
  } catch (e) {}

  // Last resort: just return without prefix
  return raw;
}


function svcEscape(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
  }[c]));
}


function _svcNorm(s) {
  return String(s || "").replace(/\s+/g, " ").trim();
}

function _svcKey(s) {
  return String(s || "").trim().toLowerCase();
}

function _svcSyncHiddenInput() {
  const tags = window.__svcEditor.tags || [];
  const featured = window.__svcEditor.featured || [];

  // keep featured in-sync with current tags (remove deleted, keep order by tags)
  const tagKeys = new Set(tags.map(_svcKey));
  const featuredClean = featured.filter(t => tagKeys.has(_svcKey(t)));
  const featuredSorted = tags.filter(t => featuredClean.some(f => _svcKey(f) === _svcKey(t)));
  window.__svcEditor.featured = featuredSorted;

  const hidden = document.getElementById("edit-services");
  if (hidden) hidden.value = tags.join(", ");

  const hiddenFeat = document.getElementById("edit-services-featured");
  if (hiddenFeat) hiddenFeat.value = featuredSorted.join(", ");
}

function initServiceTagEditor() {
  const wrap = document.getElementById("svc-tags");
  const input = document.getElementById("svc-add-input");
  const suggest = document.getElementById("svc-suggest");
  if (!wrap || !input || !suggest) return;

  if (window.__svcEditor.bound) return;

  // Hide suggest on outside click
  document.addEventListener("click", (e) => {
    const inside = e.target.closest("#svc-suggest") || e.target.closest("#svc-add-input");
    if (!inside) {
      suggest.classList.add("hidden");
      suggest.innerHTML = "";
    }
  });

  // Blur -> hide suggest (after click selection)
  input.addEventListener("blur", () => {
    setTimeout(() => {
      suggest.classList.add("hidden");
      suggest.innerHTML = "";
    }, 180);
  });

  window.__svcEditor.bound = true;
  renderServiceTags();
}

function setServiceTagsFromString(str) {
  const s = String(str || "");
  const parts = s
    .split(",")
    .map(_svcNorm)
    .filter(Boolean)
    .map(svcCanonicalizeTag)
    .filter(Boolean);

  // de-dupe (case-insensitive, canonical)
  const seen = new Set();
  const unique = [];
  parts.forEach(p => {
    const k = _svcKey(p);
    if (!seen.has(k)) { seen.add(k); unique.push(p); }
  });

  window.__svcEditor.tags = unique;
  _svcSyncHiddenInput();
  renderServiceTags();
}


function setServiceFeaturedFromAny(val) {
  let arr = [];
  if (Array.isArray(val)) {
    arr = val.map(_svcNorm).filter(Boolean);
  } else if (typeof val === "string") {
    arr = String(val || "").split(",").map(_svcNorm).filter(Boolean);
  }

  arr = arr.map(svcCanonicalizeTag).filter(Boolean);

  // de-dupe + keep only existing tags (sync will handle)
  const seen = new Set();
  const uniq = [];
  arr.forEach(p => {
    const k = _svcKey(p);
    if (!seen.has(k)) { seen.add(k); uniq.push(p); }
  });

  window.__svcEditor.featured = uniq;
  _svcSyncHiddenInput();
  renderServiceTags();
}


function toggleServiceFeatured(tag) {
  const t = _svcNorm(tag);
  if (!t) return;
  const tags = window.__svcEditor.tags || [];
  let featured = window.__svcEditor.featured || [];
  const key = _svcKey(t);
  const has = featured.some(x => _svcKey(x) === key);
  if (has) {
    featured = featured.filter(x => _svcKey(x) !== key);
  } else {
    featured = [...featured, t];
  }
  window.__svcEditor.featured = featured;
  _svcSyncHiddenInput();
  renderServiceTags();
}

function addServiceTag(tag) {
  const raw = _svcNorm(tag);
  if (!raw) return;

  // Canonicalize known services so i18n can render them in any language.
  const canon = svcCanonicalizeTag(raw) || raw;

  const key = _svcKey(canon);
  const tags = window.__svcEditor.tags || [];
  if (tags.some(x => _svcKey(x) === key)) return;

  tags.push(canon);
  window.__svcEditor.tags = tags;
  _svcSyncHiddenInput();
  renderServiceTags();
}


function removeServiceTag(idx) {
  const tags = window.__svcEditor.tags || [];
  tags.splice(idx, 1);
  window.__svcEditor.tags = tags;
  _svcSyncHiddenInput();
  renderServiceTags();
}

function clearServiceTags() {
  window.__svcEditor.tags = [];
  window.__svcEditor.featured = [];
  _svcSyncHiddenInput();
  renderServiceTags();
  const input = document.getElementById("svc-add-input");
  if (input) input.value = "";
}

function renderServiceTags() {
  const wrap = document.getElementById("svc-tags");
  if (!wrap) return;
  wrap.innerHTML = "";

  const tags = window.__svcEditor.tags || [];

  if (tags.length === 0) {
    wrap.innerHTML = `
      <div class="w-full px-4 py-4 rounded-2xl border border-dashed border-gray-200 bg-gray-50 text-center">
        <div class="text-xs text-gray-400 italic">${t("svc_no_tags") || "No service tags yet."}</div>
        <div class="text-[10px] text-gray-400 mt-1">${t("svc_add_tag_hint") || "Add a tag below (press Enter)."}</div>
      </div>`;
    return;
  }

  tags.forEach((tag, idx) => {
    const chip = document.createElement("div");
    chip.className = "group inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-gray-200 shadow-sm hover:border-cyan-200 hover:bg-cyan-50/40 transition cursor-grab";
    chip.setAttribute("draggable", "true");
    chip.dataset.idx = String(idx);

    const isFeatured = (window.__svcEditor.featured || []).some(x => _svcKey(x) === _svcKey(tag));

    chip.innerHTML = `
      <span class="w-6 h-6 rounded-lg bg-slate-50 border border-slate-200 text-slate-500 flex items-center justify-center">
        <i class="fa-solid fa-grip-lines text-[10px]"></i>
      </span>
      <span class="text-xs font-extrabold text-gray-700">${svcEscape(svcDisplayLabel(tag))}</span>

      <button type="button" class="svc-star ml-1 w-7 h-7 rounded-lg border border-amber-200 bg-amber-50 text-amber-600 flex items-center justify-center transition opacity-85 group-hover:opacity-100" title="${t("svc_toggle_featured") || "Toggle Featured"}" aria-pressed="${isFeatured ? "true" : "false"}">
        <i class="${isFeatured ? "fa-solid" : "fa-regular"} fa-star text-[11px]"></i>
      </button>
      ${isFeatured ? `<span class="ml-1 text-[9px] font-extrabold px-2 py-1 rounded-lg bg-cyan-50 border border-cyan-100 text-BTrustOn-accent uppercase">${t("badge_featured") || "Featured"}</span>` : ``}

      <button type="button" class="svc-remove ml-1 w-7 h-7 rounded-lg bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 hover:border-red-200 hover:text-red-700 flex items-center justify-center transition opacity-80 group-hover:opacity-100" title="${t("svc_remove") || "Remove"}">
        <i class="fa-solid fa-xmark text-[11px]"></i>
      </button>
    `;

    // Featured toggle
    chip.querySelector(".svc-star")?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleServiceFeatured(tag);
    });

    // Remove
    chip.querySelector(".svc-remove")?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      removeServiceTag(idx);
    });

    // Drag & Drop reorder
    chip.addEventListener("dragstart", (e) => {
      window.__svcEditor.dragIndex = idx;
      try { e.dataTransfer.setData("text/plain", String(idx)); } catch(_) {}
      chip.classList.add("opacity-60");
    });

    chip.addEventListener("dragend", () => {
      chip.classList.remove("opacity-60");
      window.__svcEditor.dragIndex = null;
    });

    chip.addEventListener("dragover", (e) => {
      e.preventDefault();
      chip.classList.add("ring-2", "ring-cyan-200");
    });

    chip.addEventListener("dragleave", () => {
      chip.classList.remove("ring-2", "ring-cyan-200");
    });

    chip.addEventListener("drop", (e) => {
      e.preventDefault();
      chip.classList.remove("ring-2", "ring-cyan-200");

      const from = window.__svcEditor.dragIndex;
      const to = Number(chip.dataset.idx);
      if (from === null || from === undefined || isNaN(to) || from === to) return;

      const list = window.__svcEditor.tags || [];
      const [moved] = list.splice(from, 1);
      list.splice(to, 0, moved);
      window.__svcEditor.tags = list;
      _svcSyncHiddenInput();
      renderServiceTags();
    });

    wrap.appendChild(chip);
  });
}

function serviceAddKeydown(e) {
  const input = document.getElementById("svc-add-input");
  if (!input) return;

  if (e.key === "Enter" || e.key === ",") {
    e.preventDefault();
    const val = input.value;
    input.value = "";
    addServiceTag(val);
    const suggest = document.getElementById("svc-suggest");
    if (suggest) { suggest.classList.add("hidden"); suggest.innerHTML = ""; }
    return;
  }

  if (e.key === "Escape") {
    const suggest = document.getElementById("svc-suggest");
    if (suggest) { suggest.classList.add("hidden"); suggest.innerHTML = ""; }
  }
}

function serviceSuggest(query) {
    const suggest = document.getElementById("svc-suggest");
    if (!suggest) return;

    const q = String(query || "").trim().toLowerCase();
    if (!q) { suggest.innerHTML = ""; suggest.classList.add("hidden"); return; }

    let matches = [];
    try {
      matches = getServiceSuggestions(q).slice(0, 8);
    } catch (e) {
      matches = [];
    }

    if (!matches.length) { suggest.innerHTML = ""; suggest.classList.add("hidden"); return; }

    // Build safely (no inline onclick; avoids escaping issues like '&' in labels)
    suggest.innerHTML = "";
    matches.forEach((m) => {
      const token = (m && m.token) ? String(m.token) : "";
      const label = (m && m.label) ? String(m.label) : (token ? svcDisplayLabel(token) : "");

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center justify-between gap-2";
      btn.addEventListener("click", () => servicePickSuggestion(token));

      const left = document.createElement("span");
      left.className = "text-sm text-gray-700 truncate";
      left.textContent = label || svcDisplayLabel(token) || token;

      const right = document.createElement("span");
      right.className = "text-[10px] font-extrabold text-BTrustOn-accent";
      right.textContent = (t("svc_add") || "ADD");

      btn.appendChild(left);
      btn.appendChild(right);
      suggest.appendChild(btn);
    });

    suggest.classList.remove("hidden");
  }

function servicePickSuggestion(s) {
  addServiceTag(s);
  const input = document.getElementById("svc-add-input");
  if (input) input.value = "";
  const suggest = document.getElementById("svc-suggest");
  if (suggest) { suggest.classList.add("hidden"); suggest.innerHTML = ""; }
}



function toggleModal(id) {
  const modal = document.getElementById(id);
  if (!modal) return;

  const isClosed = modal.classList.contains("opacity-0") || modal.classList.contains("pointer-events-none");
  if (isClosed) {
    modal.classList.remove("opacity-0");
    modal.classList.remove("pointer-events-none");
  } else {
    modal.classList.add("opacity-0");
    modal.classList.add("pointer-events-none");
  }

  // Keep body lock consistent even with multiple modals
  try {
    const anyOpen = Array.from(document.querySelectorAll(".modal"))
      .some(m => !m.classList.contains("opacity-0") && !m.classList.contains("pointer-events-none"));
    if (anyOpen) document.body.classList.add("modal-active");
    else document.body.classList.remove("modal-active");
  } catch(e) {
    // fallback
    if (isClosed) document.body.classList.add("modal-active");
    else document.body.classList.remove("modal-active");
  }
}

    // Join intent: pricing CTA can open Join modal in "Pro" mode to auto-start a trial after signup
    let __joinIntent = "free"; // "free" | "pro"

    function openJoinModal(intent = "free") {
      __joinIntent = (String(intent).toLowerCase() === "pro") ? "pro" : "free";
      const m = document.getElementById("modal-join");
      if (!m) return;
      const isClosed = m.classList.contains("opacity-0") || m.classList.contains("pointer-events-none");
      if (isClosed) toggleModal("modal-join");
    }


    function openQuoteModal(companyName) {
      const targetEl = document.getElementById("quote-target-company");
      const inputTarget = document.getElementById("input-target-company");
      if (targetEl) targetEl.textContent = companyName || "";
      if (inputTarget) inputTarget.value = companyName || "";
      toggleModal("modal-quote");
    }

    function switchProfileTab(tab) {
      const tabs = ["overview", "projects", "certs", "assets"];
      tabs.forEach((tName) => {
        const btn = document.getElementById(`tab-${tName}`);
        const content = document.getElementById(`content-${tName}`);
        if (!btn || !content) return;

        if (tName === tab) {
          btn.classList.add(
            "border-BTrustOn-accent",
            "text-BTrustOn-primary",
            "bg-cyan-50/50"
          );
          btn.classList.remove("border-transparent");
          content.classList.remove("hidden-view");
        } else {
          btn.classList.remove(
            "border-BTrustOn-accent",
            "text-BTrustOn-primary",
            "bg-cyan-50/50"
          );
          btn.classList.add("border-transparent");
          content.classList.add("hidden-view");
        }
      });
    

      try { window.__profileActiveTab = tab; } catch(e) {}
}

    
/* =========================
   Header Language Menu (dropdown)
========================= */
function toggleLangMenu(forceOpen) {
  const dd = document.getElementById("lang-menu-dropdown");
  const btn = document.getElementById("lang-menu-toggle");
  if (!dd) return;
  const isOpen = !dd.classList.contains("hidden");
  const next = (typeof forceOpen === "boolean") ? forceOpen : !isOpen;
  if (next) {
    dd.classList.remove("hidden");
    btn && btn.setAttribute("aria-expanded", "true");
  } else {
    dd.classList.add("hidden");
    btn && btn.setAttribute("aria-expanded", "false");
  }
}

function closeLangMenu() { toggleLangMenu(false); }

/* --- Mobile Nav Menu (Hamburger) --- */
function toggleMobileNavMenu(ev, forceOpen) {
  if (ev && typeof ev.stopPropagation === "function") ev.stopPropagation();
  const dd = document.getElementById("mobile-nav-menu");
  const btn = document.getElementById("mobile-nav-toggle");
  if (!dd) return;

  const isOpen = !dd.classList.contains("hidden");
  const next = (typeof forceOpen === "boolean") ? forceOpen : !isOpen;

  if (next) {
    dd.classList.remove("hidden");
    dd.classList.add("bton-open");
    btn && btn.setAttribute("aria-expanded", "true");
  } else {
    dd.classList.add("hidden");
    dd.classList.remove("bton-open");
    btn && btn.setAttribute("aria-expanded", "false");
  }
}
function closeMobileNavMenu() { toggleMobileNavMenu(null, false); }

function initMobileNavMenuOnce() {
  const dd = document.getElementById("mobile-nav-menu");
  const btn = document.getElementById("mobile-nav-toggle");
  if (!dd || !btn) return;

  document.addEventListener("click", (e) => {
    if (dd.classList.contains("hidden")) return;
    if (btn.contains(e.target) || dd.contains(e.target)) return;
    closeMobileNavMenu();
  });

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768) closeMobileNavMenu();
  });
}
document.addEventListener("DOMContentLoaded", initMobileNavMenuOnce);


function initLangMenuOnce() {
  if (window.__bton_langmenu_inited) return;
  window.__bton_langmenu_inited = true;

  document.addEventListener("click", (e) => {
    const dd = document.getElementById("lang-menu-dropdown");
    if (!dd || dd.classList.contains("hidden")) return;
    const wrap = document.getElementById("lang-menu");
    if (wrap && !wrap.contains(e.target)) closeLangMenu();
  }, { passive: true });

  document.addEventListener("keydown", (e) => {
    if (e && e.key === "Escape") closeLangMenu();
  }, { passive: true });
}

document.addEventListener("DOMContentLoaded", initLangMenuOnce);

async function switchLanguage(lang) {
  // 1) Persist language
  currentLang = __normalizeLangForI18n(lang) || "en";
  try { localStorage.setItem("bton_lang", currentLang); } catch(e) {}

  // 2) Ensure translations are loaded (only if missing)
  try {
    const __needsI18n = !(translations && translations[currentLang] && Object.keys(translations[currentLang]).length);
    if (__needsI18n && typeof loadI18n === "function") {
      await loadI18n(currentLang);
    }
  } catch(e) {}

  // 3) Always apply i18n to the current DOM
  try { applyTranslations(); } catch(e) {}

  // Refresh country-specific registry placeholders/helpers after language change
  try { if (typeof updateRegistryVerificationUI === "function") updateRegistryVerificationUI(); } catch(e) {}



  // 3b) Refresh dynamic plan/upgrade labels in header & menus (no refresh needed)
  try {
    const __c = (typeof __postCompany !== "undefined" && __postCompany)
      ? __postCompany
      : ((typeof selectedCompany !== "undefined") ? selectedCompany : null);
    if (typeof renderNavPlanButton === "function") renderNavPlanButton(__c);
  } catch(e) {}
  try { if (typeof refreshAnalyticsPlanUI === "function") refreshAnalyticsPlanUI(); } catch(e) {}
  try { if (typeof refreshHomeUpdatesCTA === "function") refreshHomeUpdatesCTA(); } catch(e) {}
  try { if (typeof refreshPricingSection === "function") refreshPricingSection(); } catch(e) {}

  // 4) Re-render dynamic lists using the SAME current state (no extra fetch, no scroll jump)
  try {
    if (typeof refreshCompanyCardsAfterSavedChange === "function") {
      refreshCompanyCardsAfterSavedChange(); // respects isSearchActive + current query
    } else {
      // fallback
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      if (typeof isSearchActive !== "undefined" && isSearchActive && typeof renderSearchResults === "function") {
        renderSearchResults(q);
      } else if (typeof renderShowcase === "function") {
        renderShowcase();
      } else if (typeof renderCards === "function") {
        renderCards(q);
      }
    }
  } catch(e) {}

  // Home updates (if any)
  try { if (typeof renderHomeUpdates === "function") renderHomeUpdates(homeUpdatesData); } catch(e) {}

  // If profile view is open, re-open (preserve scroll & tab) so dynamic labels update
  try {
    const viewProfile = document.getElementById("view-profile");
    const isProfileVisible = viewProfile && !viewProfile.classList.contains("hidden-view");
    if (isProfileVisible) {
      const cid = (window.__profileActiveCompanyId || (typeof selectedCompany !== "undefined" && selectedCompany && selectedCompany.id));
      if (cid && typeof openProfile === "function") {
        openProfile(cid, { preserveScroll: true, preserveTab: true, tab: (window.__profileActiveTab || "overview") });
      }
    }
  } catch(e) {}

  // Some sections render async; re-apply i18n shortly after (cheap + safe)
  try { setTimeout(() => { try { applyTranslations(); } catch(_) {} }, 80); } catch(e) {}
  try { setTimeout(() => { try { applyTranslations(); } catch(_) {} }, 320); } catch(e) {}

  
// Update lang switcher UI states
const btnEn = document.getElementById("lang-en");
const btnTr = document.getElementById("lang-tr");
const btnEs = document.getElementById("lang-es");
const btns = [btnEn, btnTr, btnEs].filter(Boolean);

btns.forEach((b) => {
  b.classList.remove("bg-white", "text-BTrustOn-primary", "shadow-sm");
  b.classList.add("text-gray-500");
});

const activeBtn =
  (currentLang === "tr") ? btnTr :
  (currentLang === "es") ? btnEs :
  btnEn;

if (activeBtn) {
  activeBtn.classList.add("bg-white", "text-BTrustOn-primary", "shadow-sm");
  activeBtn.classList.remove("text-gray-500");
}

  // Refresh country dropdown labels (localized)
  try { if (typeof populateCountryFilter === "function") populateCountryFilter(); } catch(e) {}
  try { if (typeof populateCountrySelects === "function") populateCountrySelects(); } catch(e) {}

  // If editor is open, re-render service chips (so labels switch language cleanly)
  try {
    const viewEditor = document.getElementById("view-editor");
    const isEditorVisible = viewEditor && !viewEditor.classList.contains("hidden-view");
    if (isEditorVisible && typeof renderServiceTags === "function") {
      renderServiceTags();
    }
  } catch(e) {}
}

      
    /* --- Skeleton helpers (Top Companies + Result Count) --- */
function renderTopCompaniesSkeleton(n = 6) {
  const el = document.getElementById("top-companies");
  if (!el) return;
  el.innerHTML = "";
  for (let i = 0; i < n; i++) {
    const d = document.createElement("div");
    d.className = "min-w-[220px] bg-white/70 border border-white/60 rounded-2xl p-4 shadow-glass";
    d.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="skel w-12 h-12 rounded-2xl"></div>
        <div class="flex-1 space-y-2">
          <div class="skel h-4 w-32"></div>
          <div class="skel h-3 w-24"></div>
        </div>
        <div class="skel h-8 w-12 rounded-xl"></div>
      </div>
    `;
    el.appendChild(d);
  }
}

function renderResultCountSkeleton() {
  const el = document.getElementById("result-count");
  if (!el) return;
  el.innerHTML = `<span class="inline-block skel h-7 w-40 align-middle"></span>`;
}

// Boot is handled in the main DOMContentLoaded (avoid double init)
/* --- GELÄ°ÅžMÄ°Åž ASSET YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingAssetId = null;

// 1. MODALI AÃ‡ (Ekleme veya DÃ¼zenleme)
// MODALI AÃ‡ (Ekleme veya DÃ¼zenleme)
/* --- GÃœNCELLENMÄ°Åž: openAssetModal (DOSYA YÃ–NETÄ°MLÄ°) --- */
function openAssetModal(assetId = null) {
  // Pro Plan KontrolÃ¼ (Sadece YENÄ° eklerken sÄ±nÄ±r kontrolÃ¼ yapar, dÃ¼zenlerken deÄŸil)
  if (!assetId) { 
      if (!checkPlanLimit('assets')) return; 
  }

  const modal = document.getElementById("asset-modal");
  const form = document.getElementById("asset-form");
  const title = document.getElementById("asset-modal-title");
  if (title && !assetId) title.textContent = (t("ui_add_new_asset_3632ed") || "Add New Asset");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  
  if(form) form.reset();
  removeAssetFile(); // Dosya seÃ§imlerini sÄ±fÄ±rla

  // --- PRO KULLANICI KONTROLÃœ ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const fileLabel = document.getElementById("asset-file-label");
  const fileLock = document.getElementById("asset-file-lock");
  const proBadge = document.getElementById("asset-file-pro-badge");
  const fileInput = document.getElementById("asset-file-input");

  if (isPro) {
      // Pro ise kilidi aÃ§
      if(fileLabel) { fileLabel.classList.remove("opacity-60"); fileLabel.onclick = null; }
      if(fileLock) fileLock.classList.add("hidden");
      if(proBadge) proBadge.classList.add("hidden");
      if(fileInput) fileInput.disabled = false;
  } else {
      // Free ise kilitle ve Upgrade'e yÃ¶nlendir
      if(fileLabel) { 
          fileLabel.classList.add("opacity-60"); 
          // TÄ±klayÄ±nca Upgrade aÃ§sÄ±n
          fileLabel.onclick = (e) => { e.preventDefault(); toggleModal('modal-upgrade'); };
      }
      if(fileLock) fileLock.classList.remove("hidden");
      if(proBadge) proBadge.classList.remove("hidden");
      if(fileInput) fileInput.disabled = true;
  }

  // --- DÃœZENLEME MANTIÄžI ---
  if (assetId) {
    currentEditingAssetId = assetId;
    if(title) title.textContent = (t("ui_edit_asset_details") || "Edit Asset Details");
    
    const asset = selectedCompany.assets.find(a => a.id === assetId);
    if (asset) {
        document.getElementById("asset-item").value = asset.type || "";
        document.getElementById("asset-specs").value = asset.spec || "";
        document.getElementById("asset-qty").value = asset.qty || "1";
        document.getElementById("asset-location").value = asset.location || "";
        document.getElementById("asset-status").value = asset.status || "Available";

        // Catalog files (multi attachments)
        existingAssetFiles = _assetFiles(asset);
        currentAssetFiles = [];
        __renderAssetFileList();
    }
  } else {
    currentEditingAssetId = null;
    if(title) title.textContent = (t("ui_add_new_asset_3632ed") || "Add New Asset");
  }
}
function closeAssetModal() {
  const modal = document.getElementById("asset-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingAssetId = null;
}

// 2. KAYDET (Hem Yeni Ekleme Hem GÃ¼ncelleme)
// 2. KAYDET (ASSET - ENGLISH)
/* --- GÃœNCELLENMÄ°Åž: saveAsset (DOSYA YÃœKLEMELÄ°) --- */
async function saveAsset() {
  const btn = document.querySelector("#asset-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Uploading...";
  btn.disabled = true;

  try {
    const item = document.getElementById("asset-item").value.trim();
    const specs = document.getElementById("asset-specs").value.trim();
    const qty = document.getElementById("asset-qty").value.trim();
    const location = document.getElementById("asset-location").value.trim();
    const status = document.getElementById("asset-status").value;

    if (!item) { showToast("Missing Info", "Please enter an item name.", "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("No session.");

    // --- DOSYA YÃœKLEME (Katalog: bir asset'e birden fazla dosya) ---
    const uploadedFiles = [];

    if (currentAssetFiles && currentAssetFiles.length) {
      for (const file of currentAssetFiles) {
        if (!file) continue;
        const fileExt = (file.name || "").split('.').pop();
        const cleanName = (file.name || "file").replace(/[^a-zA-Z0-9]/g, '_');
        const filePath = `${user.id}/${nowTs()}_${cleanName}.${fileExt}`;

        const { error: uploadError } = await supabaseClient
            .storage
            .from('asset-docs')
            .upload(filePath, file);

        if (uploadError) throw uploadError;

        const { data: publicUrlData } = supabaseClient.storage.from('asset-docs').getPublicUrl(filePath);
        uploadedFiles.push({ url: publicUrlData.publicUrl, name: file.name });
      }
    }

    // Mevcut + yeni eklenen dosyalar
    const finalFiles = [...(existingAssetFiles || []), ...uploadedFiles].filter(f => f && f.url);

    // Backward compatible primary file
    const primary = finalFiles[0] || null;
    const finalFileUrl = primary ? primary.url : null;
    const finalFileName = primary ? (primary.name || null) : null;

    const nowIso = nowDate().toISOString();

    // --- VERÄ° HAZIRLAMA ---
    let currentAssets = [...(selectedCompany.assets || [])];

    const assetObj = {
        type: item, 
        spec: specs, 
        qty: qty, 
        location: location, 
        status: status,
        files: finalFiles, // Catalog files (images + pdf)
        file_url: finalFileUrl, // backward compatible primary file
        file_name: finalFileName, // backward compatible primary file name
        updated_at: nowIso
    };

    if (currentEditingAssetId) {
        const index = currentAssets.findIndex(a => a.id === currentEditingAssetId);
        if (index > -1) {
            currentAssets[index] = { ...currentAssets[index], ...assetObj };
        }
    } else {
        currentAssets.push({ id: nowTs(), ...assetObj, date_added: nowIso, created_at: nowIso });
    }

    // --- DB UPDATE ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ assets: currentAssets, updated_at: nowDate() })
      .eq('id', myCompanyIdOr(user.id));

    if (error) throw error;

    selectedCompany.assets = currentAssets;
    const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
    if(localRef) localRef.assets = currentAssets;

    openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            switchProfileTab('assets');
    closeAssetModal();
    showToast((t("toast_success") || (currentLang === "tr" ? "BaÅŸarÄ±lÄ±" : "Success")), (t("msg_asset_saved") || (currentLang === "tr" ? "VarlÄ±k baÅŸarÄ±yla kaydedildi." : "Asset saved successfully.")), "success");

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}
// 3. SÄ°LME (ASSET - ENGLISH)
// 3. SÄ°LME (ASSET) - YENÄ° MODAL Ä°LE
function deleteAsset(assetId) {
    openDeleteModal(_deleteConfirmMsg("asset"), async () => {
        try {
            let currentAssets = selectedCompany.assets.filter(a => a.id !== assetId);

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ assets: currentAssets, updated_at: nowDate() })
                .eq('id', myCompanyIdOr(user.id));

            if (error) throw error;

            selectedCompany.assets = currentAssets;
            const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
            if(localRef) localRef.assets = currentAssets;

            openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            switchProfileTab('assets');
            showToast("Deleted", (t("msg_asset_removed") || ((currentLang==="tr") ? "VarlÄ±k baÅŸarÄ±yla silindi." : "Asset removed successfully.")), "success");

        } catch (error) {
            showToast("Error", error.message, "error");
        }
    });
}
/* --- PROJECT YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingProjectId = null;

// 1. MODALI AÃ‡
/* --- GÃœNCELLENMÄ°Åž: openProjectModal (RESÄ°M YÃ–NETÄ°MLÄ°) --- */
function openProjectModal(projectId = null) {
  if (!projectId) { if (!checkPlanLimit('projects')) return; }

  const modal = document.getElementById("project-modal");
  const form = document.getElementById("project-form");
  const title = document.getElementById("project-modal-title");
  if (title && !projectId) title.textContent = (t("ui_add_new_project_17bde1") || "Add New Project");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  if(form) form.reset();

  // --- SIFIRLAMA ---
  currentProjCover = null;
  shouldRemoveCover = false;
  currentProjGalleryFiles = [];
  tempExistingGalleryUrls = [];
  
  // UI SÄ±fÄ±rlama
  document.getElementById("cover-preview").innerHTML = '<i class="fa-solid fa-image text-gray-400"></i>';
  document.getElementById("existing-gallery-preview").innerHTML = ""; 
  document.getElementById("gallery-count-text").textContent = "";

  // --- PRO KONTROLÃœ ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const galleryLock = document.getElementById("proj-gallery-lock");
  const galleryInput = document.getElementById("proj-gallery-input");
  
  if (isPro) {
      if(galleryLock) galleryLock.classList.add("hidden");
      if(galleryInput) galleryInput.disabled = false;
  } else {
      if(galleryLock) galleryLock.classList.remove("hidden");
      if(galleryInput) galleryInput.disabled = true;
  }

  // --- DÃœZENLEME MODU ---
  if (projectId) {
    currentEditingProjectId = projectId;
    if(title) title.textContent = (t("ui_edit_project") || "Edit Project");
    
    const proj = selectedCompany.projects.find(p => p.id === projectId);
    if (proj) {
        document.getElementById("proj-title").value = proj.title || "";
        document.getElementById("proj-loc").value = proj.loc || "";
        document.getElementById("proj-desc").value = proj.desc || "";
        document.getElementById("proj-date").value = proj.project_date || "";
        
        // 1. Kapak Resmi Varsa GÃ¶ster (Ve silme butonu koy)
        if (proj.cover_url) {
            document.getElementById("cover-preview").innerHTML = `
                <img src="${proj.cover_url}" class="w-full h-full object-cover">
                <button type="button" onclick="removeProjectCover()" class="absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition cursor-pointer">
                   <i class="fa-solid fa-trash text-xs"></i>
                </button>
            `;
        }

        // 2. Galeri Resimlerini YÃ¼kle
        if (proj.gallery_urls && Array.isArray(proj.gallery_urls)) {
            tempExistingGalleryUrls = [...proj.gallery_urls]; // KopyasÄ±nÄ± al
            renderExistingGalleryPreviews();
        }
    }
  } else {
    // --- YENÄ° EKLEME MODU ---
    currentEditingProjectId = null;
    if(title) title.textContent = (t("ui_add_new_project_17bde1") || "Add New Project");
  }
}

function closeProjectModal() {
  const modal = document.getElementById("project-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingProjectId = null;
}

// 2. KAYDET (Supabase)
// 2. KAYDET (PROJECT - ENGLISH)
/* --- GÃœNCELLENMÄ°Åž: saveProject (SÄ°LME MANTIKLI) --- */
async function saveProject() {
  const btn = document.querySelector("#project-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Saving...";
  btn.disabled = true;

  try {
    const title = document.getElementById("proj-title").value.trim();
    const loc = document.getElementById("proj-loc").value.trim();
    const desc = document.getElementById("proj-desc").value.trim();

    const projDate = (document.getElementById("proj-date")?.value || "").trim();

    if (!title) { showToast("Missing Info", "Title required.", "error"); return; }
    if (!projDate) { showToast("Missing Info", "Project date required.", "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();

    // Mevcut verileri bul
    let currentProjects = [...(selectedCompany.projects || [])];
    let existingData = {};
    if (currentEditingProjectId) {
        existingData = currentProjects.find(p => p.id === currentEditingProjectId) || {};
    }

    // --- KAPAK FOTOÄžRAFI MANTIÄžI ---
    let finalCoverUrl = existingData.cover_url; // VarsayÄ±lan: eskisi kalsÄ±n

    if (shouldRemoveCover) {
        finalCoverUrl = null; // KullanÄ±cÄ± sildi
    }
    
    if (currentProjCover) {
        // Yeni resim yÃ¼kleniyor
        const path = `${user.id}/cover_${nowTs()}_${currentProjCover.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
        await supabaseClient.storage.from('project-gallery').upload(path, currentProjCover);
        const { data } = supabaseClient.storage.from('project-gallery').getPublicUrl(path);
        finalCoverUrl = data.publicUrl;
    }

    // --- GALERÄ° MANTIÄžI ---
    // BaÅŸlangÄ±Ã§: DÃ¼zenleme ekranÄ±nda "SilmediÄŸimiz" eski resimler
    let finalGallery = [...tempExistingGalleryUrls];

    // Ãœzerine: Yeni seÃ§ilen dosyalarÄ± yÃ¼kle ve ekle
    if (currentProjGalleryFiles.length > 0) {
        const uploadPromises = currentProjGalleryFiles.map(async (file) => {
            const path = `${user.id}/gallery_${nowTs()}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            await supabaseClient.storage.from('project-gallery').upload(path, file);
            const { data } = supabaseClient.storage.from('project-gallery').getPublicUrl(path);
            return data.publicUrl;
        });
        
        const newUrls = await Promise.all(uploadPromises);
        finalGallery = [...finalGallery, ...newUrls];
    }

    // --- VERÄ° HAZIRLAMA ---
    const projObj = {
        id: currentEditingProjectId || nowTs(),
        title: title,
        loc: loc,
        desc: desc,
        project_date: projDate,
        cover_url: finalCoverUrl,
        gallery_urls: finalGallery,
        updated_at: nowDate().toISOString()
    };

    if (currentEditingProjectId) {
        const index = currentProjects.findIndex(p => p.id === currentEditingProjectId);
        if (index > -1) currentProjects[index] = projObj;
    } else {
        currentProjects.push(projObj);
    }

    // --- DB KAYIT ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ projects: currentProjects, updated_at: nowDate() })
      .eq('id', myCompanyIdOr(user.id));

    if (error) throw error;

    // Local State GÃ¼ncelle
    selectedCompany.projects = currentProjects;
    const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
    if(localRef) localRef.projects = currentProjects;

    openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            switchProfileTab('projects');
    closeProjectModal();
    showToast((t("toast_success") || (currentLang === "tr" ? "BaÅŸarÄ±lÄ±" : "Success")), (t("msg_project_saved") || (currentLang === "tr" ? "Proje kaydedildi." : "Project saved!")), "success");

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// 3. SÄ°LME (PROJECT - ENGLISH)
// 3. SÄ°LME (PROJECT) - YENÄ° MODAL Ä°LE
function deleteProject(projectId) {
    openDeleteModal(_deleteConfirmMsg("project"), async () => {
        try {
            let currentProjects = (selectedCompany.projects || []).filter(p => p.id !== projectId);
            
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error("No session.");

            const { error } = await supabaseClient
                .from('profiles')
                .update({ projects: currentProjects, updated_at: nowDate() })
                .eq('id', myCompanyIdOr(user.id));

            if (error) throw error;

            selectedCompany.projects = currentProjects;
            const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
            if(localRef) localRef.projects = currentProjects;

            openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            switchProfileTab('projects');
            showToast("Deleted", (t("msg_project_removed") || ((currentLang==="tr") ? "Proje baÅŸarÄ±yla silindi." : "Project removed successfully.")), "success");

        } catch (error) {
            showToast("Error", error.message, "error");
        }
    });
}
// 3. SÄ°LME (CERTIFICATE) - YENÄ° MODAL Ä°LE
function deleteCert(certId, certName) {
    // TarayÄ±cÄ± confirm'i yerine kendi modalÄ±mÄ±zÄ± Ã§aÄŸÄ±rÄ±yoruz
    openDeleteModal(_deleteConfirmMsg("certificate"), async () => {
        
        // --- ASIL SÄ°LME Ä°ÅžLEMÄ° BURADA BAÅžLIYOR ---
        try {
            let currentCerts = [];
            
            if (certId === -1) {
                currentCerts = selectedCompany.certificates.filter(c => c !== certName);
            } else {
                currentCerts = selectedCompany.certificates.filter(c => c.id !== certId);
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ certificates: currentCerts, updated_at: nowDate() })
                .eq('id', myCompanyIdOr(user.id));

            if (error) throw error;

            selectedCompany.certificates = currentCerts;
            const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
            if(localRef) localRef.certificates = currentCerts;

            openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            showToast("Deleted", (t("msg_certificate_removed") || ((currentLang==="tr") ? "Sertifika baÅŸarÄ±yla silindi." : "Certificate removed successfully.")), "success");
            
        } catch (error) {
            showToast("Error", "Delete failed: " + error.message, "error");
        }
    });
}
  </script>
<!-- âœ… PROJECT VIEWER MODAL (click any project card) -->
<div class="hidden fixed inset-0 z-[99990]" id="project-viewer">
<div class="absolute inset-0 bg-slate-900/60" onclick="closeProjectViewer()"></div>
<div class="relative max-w-4xl mx-auto mt-24 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
<div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
<div>
<div class="text-sm font-extrabold text-BTrustOn-primary" id="pv-title"></div>
<div class="text-[11px] text-gray-400 mt-0.5" id="pv-meta"></div>
</div>
<button aria-label="Close" class="w-9 h-9 rounded-full hover:bg-gray-100 text-gray-500" data-i18n-aria="attr_close_d3d2e6" onclick="closeProjectViewer()">
<i class="fa-solid fa-xmark"></i>
</button>
</div>
<div class="p-5">
<button class="w-full rounded-xl overflow-hidden border border-gray-200 bg-slate-50 focus:outline-none" id="pv-cover-btn">
<img alt="" class="w-full h-[320px] object-cover" id="pv-cover"/>
</button>
<div class="text-sm text-gray-600 mt-4 whitespace-pre-wrap break-words bton-wrap-anywhere" id="pv-desc"></div>
<div class="mt-4 flex items-center justify-between">
<div class="text-[11px] text-gray-400" id="pv-gallery-info"></div>
<button class="hidden px-4 py-2 rounded-lg bg-BTrustOn-primary text-white text-xs font-bold hover:bg-BTrustOn-accent transition" id="pv-open-gallery" onclick="openProjectViewerGallery()">
<i class="fa-solid fa-images mr-2"></i><span data-i18n="ui_view_gallery_dc33b4">VIEW GALLERY</span></button>
</div>
<div class="mt-4 grid grid-cols-3 md:grid-cols-6 gap-2" id="pv-thumbs"></div>
</div>
</div>
</div>
<script>
// --- tiny helpers (safety) ---
function escapeHtml(v){
  const s = (v===null||v===undefined)?"":String(v);
  return s.replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/\"/g,"&quot;")
          .replace(/'/g,"&#39;");
}

// i18n-safe translator helper (never throws)
function TT(key, fallback){
  try {
    return (typeof window.t === "function") ? (t(key) || fallback) : fallback;
  } catch (e) {
    return fallback;
  }
}


// 1. YENÄ° KAYIT (JOIN) Ä°ÅžLEMÄ°
// GÃœNCELLENMÄ°Åž KAYIT FONKSÄ°YONU (Type Bilgisini Kaydeder)
/* --- GÃœNCELLENMÄ°Åž handleJoin (Toast'lÄ±) --- */
async function handleJoin() {
  const btn = document.querySelector("#join-form button");
  const originalText = btn.textContent;

  // âœ… never throw if i18n isn't ready
  btn.textContent = TT("toast_processing", (currentLang === "tr" ? "Ä°ÅŸleniyor..." : "Processing..."));
  btn.disabled = true;

  let authData = null;

  try {
    const email = (document.getElementById("join-email")?.value || "").trim();
    const password = (document.getElementById("join-password")?.value || "").trim();
    const companyName = (document.getElementById("join-companyName")?.value || "").trim();
    const sector = (document.getElementById("join-sector")?.value || "").trim();
    const typeVal = (document.getElementById("join-type")?.value || "").trim();
    const city = (document.getElementById("join-city")?.value || "").trim();
    const country = (document.getElementById("join-country")?.value || "").trim();
    const services = (document.getElementById("join-services")?.value || "").trim();

    const errEl = document.getElementById("join-error");
    if (errEl) errEl.classList.add("hidden");

    // ---------------------------------------------------------
    // Stage 1: AUTH + DB (only these failures should show "failed")
    // ---------------------------------------------------------
    try {
      const signRes = await supabaseClient.auth.signUp({ email, password });
      authData = signRes?.data || null;
      if (signRes?.error) throw signRes.error;

      const uid = authData?.user?.id;
      if (!uid) {
        // Some setups require email confirmation; user may not be returned immediately.
        throw new Error(currentLang === "tr"
          ? "KayÄ±t oluÅŸturuldu ancak kullanÄ±cÄ± bilgisi alÄ±namadÄ±. LÃ¼tfen e-postanÄ±zÄ± doÄŸrulayÄ±n ve tekrar giriÅŸ yapÄ±n."
          : "Signup created, but user info was not returned. Please verify your email and login.");
      }

      const insRes = await supabaseClient.from("profiles").insert([{
        id: uid,
        email,
        company_name: companyName,
        sector,
        company_type: typeVal,
        city,
        country,
        services,
        description: "",
        size: "1-10",
        subscription_tier: "free",
        subscription_status: "free",
        owner_user_id: uid,
        claimed_at: new Date().toISOString()
      }]);

      if (insRes?.error) throw insRes.error;
    } catch (error) {
      const errEl2 = document.getElementById("join-error");
      if (errEl2) {
        errEl2.textContent = (currentLang === "tr" ? "Hata: " : "Error: ") + (error?.message || error);
        errEl2.classList.remove("hidden");
      }

      showToast(
        TT("toast_registration_failed", (currentLang === "tr" ? "KayÄ±t baÅŸarÄ±sÄ±z" : "Registration Failed")),
        (error?.message || (currentLang === "tr" ? "LÃ¼tfen bilgileri kontrol edin." : "Please check details.")),
        "error"
      );
      return;
    }

    // ---------------------------------------------------------
    // Stage 2: UI (never block join even if something fails)
    // ---------------------------------------------------------
    const __intent = (typeof __joinIntent !== "undefined") ? String(__joinIntent) : "free";
    try { if (typeof __joinIntent !== "undefined") __joinIntent = "free"; } catch(_) {}

    try { toggleModal("modal-join"); } catch(e) {}
    try {
      showToast(
        TT("toast_welcome", (currentLang === "tr" ? "HoÅŸ geldiniz!" : "Welcome!")),
        TT("toast_registration_success", (currentLang === "tr" ? "KayÄ±t baÅŸarÄ±lÄ±. Profil oluÅŸturuldu." : "Registration successful. Profile created.")),
        "success"
      );
    } catch(e) {
      try {
        showToast(
          (currentLang === "tr" ? "HoÅŸ geldiniz!" : "Welcome!"),
          (currentLang === "tr" ? "KayÄ±t baÅŸarÄ±lÄ±." : "Registration successful."),
          "success"
        );
      } catch(_) {}
    }

    try {
      // âœ… After successful join, go directly to the user's own company profile (no manual refresh)
      const __uid = authData?.user?.id || null;
      if (__uid) {
        try { localStorage.setItem("BTrustOn_just_joined", "1"); } catch(_) {}
        try { localStorage.setItem("BTrustOn_just_joined_uid", String(__uid)); } catch(_) {}
        try { localStorage.setItem("BTrustOn_just_joined_edit", "1");
        try { localStorage.setItem("BTrustOn_welcome_pending", "1"); } catch(_) {} } catch(_) {}
        try { localStorage.setItem("BTrustOn_my_company_id", String(__uid)); } catch(_) {}
        try { localStorage.setItem("BTrustOn_last_route", `company:${__uid}`); } catch(_) {}

        // Prefer a direct profile open for instant UX; fallback to checkUserAndOpenProfile(forceOpen)
        if (typeof openProfile === "function") {
          await openProfile(__uid, { tab: "overview" });
          // âœ… Jump straight into Profile Editor after join
          if (typeof editMyProfile === "function") {
            try { setTimeout(() => { try { editMyProfile(); } catch(e) {} }, 120); } catch(e) {}
          } else if (typeof showEditorView === "function") {
            try { setTimeout(() => { try { showEditorView(); } catch(e) {} }, 120); } catch(e) {}
          }
        } else if (typeof checkUserAndOpenProfile === "function") {
          await checkUserAndOpenProfile(true);
        } else {
          try { window.location.hash = `#company=${encodeURIComponent(__uid)}`; } catch(_) {}
        }
      } else {
        // Fallback: at least refresh session-driven UI
        if (typeof checkUserAndOpenProfile === "function") await checkUserAndOpenProfile(true);
      }

      // Clear join redirect flag once navigated
      try { localStorage.removeItem("BTrustOn_just_joined"); } catch(_) {}
    } catch(e) {
      console.warn("post-join redirect to profile failed:", e);
      try { if (typeof checkUserAndOpenProfile === "function") await checkUserAndOpenProfile(true); } catch(_) {}
    }
    try { if (typeof refreshHeroCTA === "function") setTimeout(refreshHeroCTA, 120); } catch(e) {}

    // If user joined from the Pro pricing CTA, start Pro trial immediately
    if (__intent.toLowerCase() === "pro") {
      setTimeout(async () => {
        try {
          const u = await _getAuthUserSafe();
          const uid = u?.id || authData?.user?.id;
          if (!uid) return;

          let p = null;
          try { p = await _fetchMyCompanyProfile(uid); } catch(_) { p = null; }
          if (!p) p = { id: uid, trial_start_date: null, created_at: null };

          selectedCompany = p;
          __postCompany = p;

          await startProTrialDirect(p, { source: "join" });
        } catch(e) {}
      }, 550);
    }

    // Saved companies
    setTimeout(() => {
      try {
        if (typeof fetchSavedCompanies === "function") {
          fetchSavedCompanies().then(() => {
            try {
              updateSaveButtonsUI();
              try { updateFollowButtonsUI(); } catch(e) {}
              refreshCompanyCardsAfterSavedChange();
            } catch(e) {}
          });
        }
      } catch(e) {}
    }, 0);

    // Follow list
    setTimeout(async () => {
      try {
        const u = await _getAuthUserSafe();
        __authUserId = u?.id || null;
        if (__authUserId) await _ensureHomeFollowSet(__authUserId);
        try { updateFollowButtonsUI(); } catch(e) {}
      } catch(e) {}
    }, 0);

  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// --- YENÄ° EKLENECEK FONKSÄ°YON BAÅžLANGIÃ‡ ---
async function fetchAllPublicProfiles() {
  // 1. Supabase'den profilleri Ã§ek
  const { data: profiles, error } = await supabaseClient
    .from('profiles')
    .select('*');

  if (error || !profiles) {
    console.log("HenÃ¼z kayÄ±tlÄ± ÅŸirket yok veya hata oluÅŸtu.");
    return;
  }

  // 2. Gelen veriyi site formatÄ±na uydur
  profiles.forEach(profile => {
if (profile.email === ADMIN_EMAIL) {
        return; // Admin maili ise bu turu atla, listeye ekleme!
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† --------------------------- ðŸ‘†ðŸ‘†ðŸ‘†
    // Listede zaten var mÄ±? Varsa Ã¼stÃ¼ne yazmayalÄ±m, sadece eksikleri gÃ¼ncelleyelim.
    const exists = database.find(c => c.id == profile.id);
    
    const formattedProfile = {
      id: profile.id,
      name: profile.company_name || "New Company",
      city: profile.city || "Konum Yok",
      country: profile.country || "Turkey",
      address: profile.address || "",
      email: profile.email || "",
      subscription_tier: profile.subscription_tier || "free",
      verification_status: profile.verification_status || "none",
      tax_id: profile.tax_id || "",
      duns_number: profile.duns_number || "",

      tagline: profile.tagline || "",
      sector: profile.sector || "construction",
      desc: profile.description || "",
      type_label: profile.company_type || "Industrial Supplier", // Type verisi buradan geliyor
      size_label: profile.company_size || "Size N/A",
      year_label: profile.founded_year || "",
      services: profile.services ? profile.services.split(',') : [],
      logo_url: profile.logo_url || null,
      website: profile.website || "",
      phone: profile.phone || "",
      contact_email: profile.contact_email || "",
      trust: "emerging", 
      meta: { references: 60, delivery: 70, years: 1, financial: 60, digital: 50 }, 
      certificates: profile.certificates || [],
      assets: profile.assets || [],
      projects: profile.projects || [] 
    };

    if (exists) {
        // Varsa gÃ¼ncelle
        Object.assign(exists, formattedProfile);
    } else {
        // Yoksa ekle
        database.unshift(formattedProfile);
    }
  });


  // Deduplicate demo/real collisions
  dedupeDatabasePreferReal();
  // 3. EKRANI YENÄ°LE (DÃœZELTME BURADA YAPILDI)
  // Eski renderCards("") yerine akÄ±llÄ± vitrini Ã§aÄŸÄ±rÄ±yoruz.
  if (typeof isSearchActive !== 'undefined' && !isSearchActive) {
      renderShowcase(); // Rozetleri destekleyen fonksiyon
  } else {
      // EÄŸer kullanÄ±cÄ± o sÄ±rada arama yapÄ±yorsa arama sonucunu gÃ¼ncelle
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      renderSearchResults(q);
  }
  
}
// --- YENÄ° EKLENECEK FONKSÄ°YON BÄ°TÄ°Åž ---
/* --- DÃœZELTÄ°LMÄ°Åž: checkUserAndOpenProfile --- */
async function checkUserAndOpenProfile(forceOpen = false) {
  // âœ… Guard: prevent double-run on iOS Safari (DOMContentLoaded + INITIAL_SESSION can fire back-to-back)
  // This page is heavy; running this twice can crash Safari and show â€œpage had a problem repeatedlyâ€.
  if (!forceOpen) {
    try {
      if (window.__BTON_CHECKUSER_LOCK) return;
      window.__BTON_CHECKUSER_LOCK = true;
      setTimeout(() => { try { window.__BTON_CHECKUSER_LOCK = false; } catch(e) {} }, 1200);
    } catch(e) {}
  }

  // 1. Oturumu Kontrol Et
  const { data: { session } } = await supabaseClient.auth.getSession();
  
  // GruplarÄ± SeÃ§
  const guestGroup = document.getElementById("guest-actions");
  const userGroup = document.getElementById("user-actions");
  const mobileGuestGroup = document.getElementById("mobile-guest-actions");
  const mobileUserGroup = document.getElementById("mobile-user-actions");
  const mobileQuickCompany = document.getElementById("mobile-quick-my-company");
  // 2. UI'I ANINDA GÃœNCELLE
  if (!session) {
    try { __myProForEngagement = false; } catch(e) {}
    if(guestGroup) { guestGroup.classList.remove("hidden"); guestGroup.classList.add("flex"); }
    if(userGroup) { userGroup.classList.add("hidden"); userGroup.classList.remove("flex"); }
    if(mobileGuestGroup) { mobileGuestGroup.classList.remove("hidden"); mobileGuestGroup.classList.add("flex"); }
    if(mobileUserGroup) { mobileUserGroup.classList.add("hidden"); mobileUserGroup.classList.remove("flex"); }
    if(mobileQuickCompany) { mobileQuickCompany.classList.add("hidden"); }
    return; 
  } else {
    if(guestGroup) { guestGroup.classList.add("hidden"); guestGroup.classList.remove("flex"); }
    if(userGroup) { userGroup.classList.remove("hidden"); userGroup.classList.add("flex"); }
    if(mobileGuestGroup) { mobileGuestGroup.classList.add("hidden"); mobileGuestGroup.classList.remove("flex"); }
    if(mobileUserGroup) { mobileUserGroup.classList.remove("hidden"); mobileUserGroup.classList.add("flex"); }
    if(mobileQuickCompany) { mobileQuickCompany.classList.remove("hidden"); }

    // âœ… Safe init (mobile refresh): i18n might not be ready yet; guard + avoid unhandled errors
    try { if (typeof t !== "function" && typeof bootI18n === "function") { await bootI18n(); } } catch(e) {}
    try { if (typeof fetchInboxMessages === "function") fetchInboxMessages(); } catch(e){ console.warn("fetchInboxMessages:", e); }
    try { if (typeof subscribeToMessages === "function") subscribeToMessages(); } catch(e){ console.warn("subscribeToMessages:", e); }
    try { if (typeof fetchNotificationsUnread === "function") fetchNotificationsUnread(); } catch(e){ console.warn("fetchNotificationsUnread:", e); }
    try { if (typeof subscribeNotifications === "function") subscribeNotifications(); } catch(e){ console.warn("subscribeNotifications:", e); }

  }

  // 3. PROFÄ°L VERÄ°SÄ°NÄ° Ã‡EK
  // âœ… Claim-ready schema: resolve my company via owner_user_id (fallback to legacy)
  let profile = await _fetchMyCompanyProfile(session.user.id);

  if (!profile) { console.log("Profil verisi Ã§ekilemedi."); return; }

  // âœ… Enforce Pro lifecycle (expiry + reminder notifications)
  try { profile = await enforceProLifecycle(profile); } catch(e) {}

  // âœ… Cache my Pro status for engagement notifications (independent of selectedCompany)
  try {
    const __tier = String(profile.subscription_tier || "").toLowerCase();
    const __status = String(profile.subscription_status || "").toLowerCase();
    __myProForEngagement = (__tier === "pro") && (__status === "active_paid" || __status === "active_trial" || __status === "active" || __status === "pro");
  } catch(e) { __myProForEngagement = false; }

  // 4. VERÄ°YÄ° FORMATLA
  const mappedProfile = {
    id: profile.id,
    email: profile.email,
    name: profile.company_name,
    city: profile.city,
    country: profile.country || "Turkey",
    address: profile.address || "",
    subscription_tier: profile.subscription_tier || 'free',
    subscription_status: profile.subscription_status || 'free',
    trial_start_date: profile.trial_start_date || null,
    trial_end_date: profile.trial_end_date || null,
    created_at: profile.created_at || null,
    verification_status: profile.verification_status || 'none',
    owner_user_id: profile.owner_user_id || null,
    claimed_at: profile.claimed_at || null,
    // Verification flags (supports multiple schemas)
    blue_tick: (typeof profile.blue_tick !== "undefined") ? profile.blue_tick : undefined,
    is_verified: (typeof profile.is_verified !== "undefined") ? profile.is_verified : undefined,
    verified: (typeof profile.verified !== "undefined") ? profile.verified : undefined,
    is_verified_company: (typeof profile.is_verified_company !== "undefined") ? profile.is_verified_company : undefined,
    verification_celebrated: (typeof profile.verification_celebrated !== "undefined") ? profile.verification_celebrated : undefined,

    tax_id: profile.tax_id || "",
    duns_number: profile.duns_number || "",  
    tagline: profile.tagline || "",
    sector: profile.sector || "construction",
    desc: profile.description || "",
    type_label: profile.company_type || "Industrial Supplier",
    size_label: profile.company_size || "Size N/A",
    year_label: profile.founded_year || "",
    services: profile.services ? profile.services.split(',') : [],
    logo_url: profile.logo_url || null,
    website: profile.website || "",
    phone: profile.phone || "",
    contact_email: profile.contact_email || "",
    service_details: profile.service_details || "", 
    owner_name: profile.owner_name || null,
    owner_role: profile.owner_role || null,
    owner_linkedin: profile.owner_linkedin || null,
    owner_photo_url: profile.owner_photo_url || null,
    trust: "verified",
    meta: { references: 50, delivery: 50, years: 1, financial: 50, digital: 50 },
    certificates: profile.certificates || [],
    assets: profile.assets || [],
    projects: profile.projects || [] 
  };

  if (typeof database !== 'undefined') {
      const idx = database.findIndex(c => c.id == profile.id);
      if (idx > -1) { database[idx] = mappedProfile; } 
      else { database.unshift(mappedProfile); }
      
      localStorage.setItem("BTrustOn_my_company_id", profile.id);

      // âœ… Auto-open my profile after join (or when forced)
      try {
        const __justJoinedUid = (localStorage.getItem("BTrustOn_just_joined_uid") || "").trim();
        const __shouldOpen = (forceOpen === true) || (__justJoinedUid && __justJoinedUid === String(profile.id));
        if (__shouldOpen) {
          let __wantEdit = false;
          try { __wantEdit = (localStorage.getItem("BTrustOn_just_joined_edit") === "1"); } catch(_) {}
          try { await openProfile(profile.id); } catch(e) { try { openProfile(profile.id); } catch(_) {} }

          if (__wantEdit && typeof editMyProfile === "function") {
            try { setTimeout(() => { try { editMyProfile(); } catch(e) {} }, 160); } catch(e) {}
          }

          try {
            localStorage.removeItem("BTrustOn_just_joined_uid");
            localStorage.removeItem("BTrustOn_just_joined");
            localStorage.removeItem("BTrustOn_just_joined_edit");
          } catch(_) {}
        }
      } catch(e) {
        try { if (forceOpen === true) openProfile(profile.id); } catch(_) {}
      }

      // âœ… If user's company profile is currently open, refresh it so verification badge updates without a manual refresh
      try {
        const vp = document.getElementById("view-profile");
        const isProfileOpen = vp && !vp.classList.contains("hidden-view");
        const bootSame = (window.__BTON_BOOT_OPENED_COMPANY === true && String(window.__BTON_BOOT_COMPANY_ID || "") === String(profile.id));
        if (forceOpen !== true && isProfileOpen && typeof selectedCompany !== 'undefined' && selectedCompany && String(selectedCompany.id) === String(profile.id) && !bootSame) {
          const fresh = (typeof database !== 'undefined' && database) ? database.find(c => String(c.id) === String(profile.id)) : null;
          selectedCompany = fresh || mappedProfile;
          await openProfile(profile.id, { preserveTab: true, preserveScroll: true });
        }
      } catch(e) {}

  
    // ðŸ”” Engagement notifications init (followed updates + profile views)
    try { if (typeof btonInitEngagementNotifications === "function") await btonInitEngagementNotifications(); } catch(e) {}
}

  // Kutlama kontrolÃ¼ yap
  try { if (typeof checkAndTriggerCelebration === "function") checkAndTriggerCelebration(mappedProfile); } catch(e) {}


  // âœ… Claim-approved welcome modal (one-time, cross-device)
  try { if (typeof checkAndTriggerClaimWelcome === "function") checkAndTriggerClaimWelcome(); } catch(e) {}
  // Admin KontrolÃ¼
  try { if (typeof checkAdminAccess === "function") checkAdminAccess(); } catch(e) {}

  // --- PLAN BUTONU (UPGRADE / PRO) ---
  const navUpgradeBtn = document.getElementById("btn-nav-upgrade");
  const cardUpgradeBtn = document.getElementById("btn-card-upgrade");

  // Nav plan button: show for all signed-in users, content/style depends on tier
  if (navUpgradeBtn) {
    navUpgradeBtn.classList.remove("hidden");
    navUpgradeBtn.classList.add("flex");
  }

  // Card upgrade button only for Free users
  if (mappedProfile.subscription_tier === 'pro') {
    if (cardUpgradeBtn) {
      cardUpgradeBtn.classList.add("hidden");
      cardUpgradeBtn.classList.remove("flex");
    }
  } else {
    if (cardUpgradeBtn) {
      cardUpgradeBtn.classList.remove("hidden");
      cardUpgradeBtn.classList.add("flex");
    }
  }

  // Keep a reliable "my company" snapshot for plan UI + pro gates
  try { __postCompany = mappedProfile; } catch(e) {}
  try { renderNavPlanButton(mappedProfile); } catch(e) {}

  /* __BTON_SYNC_AUTH_FOLLOW_UI__: keep follow button consistent on first profile open (mobile refresh safe) */
  try {
    __authUserId = session?.user?.id || null;
  } catch(e) {}
  try {
    if (__authUserId) await _ensureHomeFollowSet(__authUserId);
  } catch(e) {}
  try { updateFollowButtonsUI(); } catch(e) {}

}
// 3. SAYFA YÃœKLENÄ°NCE Ã‡ALIÅžTIR
/* --- SAYFA BAÅžLANGIÃ‡ AYARLARI (GECÄ°KMESÄ°Z) --- */

/* --- ROUTE RESTORE (NO FLASH) --- */
function _getHashParamFromHash(key){
  try{
    const h = (window.location.hash || "").replace(/^#/, "");
    if (!h) return null;
    const p = new URLSearchParams(h);
    return p.get(key);
  }catch(e){ return null; }
}

function _getCompanyIdFromHash() {
  return _getHashParamFromHash('company');
}
function _getCompanyTabFromHash(){
  return _getHashParamFromHash('tab');
}
function _getCompanyFocusFromHash(){
  return _getHashParamFromHash('focus');
}

function _getCompanyIdFromLastRoute() {
  try {
    const last = localStorage.getItem("BTrustOn_last_route") || "";
    if (last.startsWith("company:")) return last.slice("company:".length);
  } catch(e) {}
  return null;
}

// Runs first: decides which view should be visible before the homepage renders.
async function restoreInitialRoute() {
  const companyFromHash = _getCompanyIdFromHash();
  const tabFromHash = _getCompanyTabFromHash();
  const focusFromHash = _getCompanyFocusFromHash();
  const companyId = companyFromHash || _getCompanyIdFromLastRoute();
  if (companyId) {
    // âœ… Boot route flags (avoid double-render + iOS reload crash)
    try { window.__BTON_BOOT_COMPANY_ID = String(companyId); window.__BTON_BOOT_OPENED_COMPANY = false; } catch(e) {}

    // Don't wait: openProfile will load data; we just avoid homepage flash
    window.__routeRestoring = true;
    try {
      await openProfile(companyId, { tab: (companyFromHash ? tabFromHash : null), focus: (companyFromHash ? focusFromHash : null), __fromRestore: true });
      try { window.__BTON_BOOT_OPENED_COMPANY = true; } catch(e) {}
    } catch (err) {
      console.error("restoreInitialRoute openProfile failed:", err);
      try { localStorage.removeItem("BTrustOn_last_route"); } catch(_) {}
      try { history.replaceState(null, "", window.location.pathname + window.location.search); } catch(_) {}
      try { showMainView(); } catch(_) {}
    } finally {
      window.__routeRestoring = false;
    }
    return;
  }
  // Default: dashboard (home)
  showMainView();
}


// Keep browser Back/Forward (popstate) and hash changes perfectly in sync with the UI
(function () {
  let syncing = false;

  async function syncRoute() {
    if (syncing) return;
    syncing = true;
    try {
      const hasCompany = /^#company=/.test(window.location.hash || "");
      try {
        if (hasCompany) showProfileSkeleton();
        else hideProfileSkeleton();
      } catch(e) {}
      await restoreInitialRoute();
    } finally {
      syncing = false;
    }
  }

  window.addEventListener("popstate", syncRoute);
  window.addEventListener("hashchange", syncRoute);
})();


// Runs last: reveals the UI (removes boot overlay)
function finishBoot() {
  const root = document.documentElement;
  try { root.classList.remove("booting","route-company","boot-show"); } catch(e) {}
  try {
    const overlay = document.getElementById("boot-overlay");
    if (overlay) {
      overlay.classList.add("boot-out");
      setTimeout(() => { try{ overlay.remove(); }catch(e){} }, 160);
    }
  } catch(e) {}
}

/* --- BOOT SAFETY NET (prevents mobile refresh brick on unexpected errors) --- */
if (!window.__BTON_BOOT_SAFETY_NET) {
  window.__BTON_BOOT_SAFETY_NET = true;

  window.addEventListener("unhandledrejection", (e) => {
    try { console.error("Unhandled promise:", (e && e.reason) ? e.reason : e); } catch(_) {}
    try { finishBoot(); } catch(_) {}
  });

  window.addEventListener("error", (e) => {
    try { console.error("Window error:", (e && e.error) ? e.error : e); } catch(_) {}
    try { finishBoot(); } catch(_) {}
  });

  // Watchdog: even if something goes wrong, never leave the UI hidden
  setTimeout(() => {
    try {
      const stillBoot = document.documentElement.classList.contains("booting") || document.getElementById("boot-overlay");
      if (stillBoot) finishBoot();
    } catch(_) {}
  }, 3500);
}


document.addEventListener("DOMContentLoaded", async () => {
  // âœ… Guard: prevent double-run on iOS Safari (DOMContentLoaded + INITIAL_SESSION can fire back-to-back)
  if (window.__BTON_MAIN_BOOTED) return;
  window.__BTON_MAIN_BOOTED = true;

  let __bootOk = false;

  try {
    // Country dropdowns (never brick boot)
    try { populateCountrySelects(); } catch(e){ console.warn("populateCountrySelects:", e); }

    // Apply language before showing UI (prevents ENâ†’TR flash)
    try { await bootI18n(); } catch(e){ console.error("bootI18n:", e); }

    // Restore last view after language is ready (never brick boot)
    try {
      await restoreInitialRoute();
    } catch (e) {
      console.error("restoreInitialRoute (boot) failed:", e);
      // Bad route can brick refresh; clear it and fall back to Home
      try { localStorage.removeItem("BTrustOn_last_route"); } catch(_) {}
      try { history.replaceState(null, "", window.location.pathname + window.location.search); } catch(_) {}
      try { showMainView(); } catch(_) {}
    }

    // Load data after view is visible (safe)
    try { initRealData(); } catch(e){ console.error("initRealData:", e); }

    // âœ… On company route, postpone showcase animations (reduces iOS Safari refresh crashes)
    try {
      const __bootHasCompany2 = /^#company=/.test(window.location.hash || "");
      if (!__bootHasCompany2) initShowcaseSystem();
      else setTimeout(() => { try { initShowcaseSystem(); } catch(e) {} }, 1600);
    } catch(e) { try { initShowcaseSystem(); } catch(_) {} }

    // Home updates (last 7 days) â€” postpone on company route
    try {
      const __bootHasCompany = /^#company=/.test(window.location.hash || "");
      if (!__bootHasCompany) {
        try { _setHomeUpdatesFilterUI(homeUpdatesFilter); } catch(e) {}
        try { fetchHomeUpdates(); } catch(e) {}
        try { subscribeHomeUpdatesRealtime(); } catch(e) {}
        try { setupHomeUpdatesNav(); } catch(e) {}
      } else {
        setTimeout(() => {
          try { _setHomeUpdatesFilterUI(homeUpdatesFilter); } catch(e) {}
          try { fetchHomeUpdates(); } catch(e) {}
          try { subscribeHomeUpdatesRealtime(); } catch(e) {}
          try { setupHomeUpdatesNav(); } catch(e) {}
        }, 1400);
      }
    } catch(e) {}

    // Session check (refresh user UI / My Company button etc.)
    try { checkUserAndOpenProfile(); } catch(e){ console.error("checkUserAndOpenProfile:", e); }

    try { if (typeof refreshHeroCTA === "function") setTimeout(refreshHeroCTA, 120); } catch(e) {}
    try { if (typeof refreshPricingSection === "function") setTimeout(refreshPricingSection, 160); } catch(e) {}
    try { if (typeof refreshHomeUpdatesCTA === "function") setTimeout(refreshHomeUpdatesCTA, 200); } catch(e) {}

    __bootOk = true;
  } finally {
    // âœ… CRITICAL: Always finish boot so page never stays hidden on mobile refresh
    try { finishBoot(); } catch(e) {
      try {
        document.documentElement.classList.remove("booting","route-company","boot-show");
        document.getElementById("boot-overlay")?.remove();
      } catch(_) {}
    }

    if (!__bootOk) {
      try {
        const msg = (typeof t === "function" ? (t("ui_try_refresh") || "Bir hata oluÅŸtu. LÃ¼tfen yenileyin.") : "Bir hata oluÅŸtu. LÃ¼tfen yenileyin.");
        if (typeof showToast === "function") showToast("Error", msg, "error");
      } catch(_) {}
    }
  }
});
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
    // GiriÅŸ yapÄ±ldÄ±ysa
    if (typeof closeLoginModal === "function") closeLoginModal();
    
    
    // âœ… Keep auth id + follow UI in sync
    try { __authUserId = session?.user?.id || null; } catch(e) { try { __authUserId = null; } catch(_) {} }
    try { if (typeof touchLastActive === 'function') touchLastActive(session); } catch(e) {}
    try { if (__authUserId) _ensureHomeFollowSet(__authUserId); } catch(e) {}
    try { updateFollowButtonsUI(); } catch(e) {}
// 1. Ã–nce Admin mi diye bak (Bunu ekleyin)
    if (typeof checkAdminAccess === "function") checkAdminAccess();

    // 2. Sonra profili Ã§ek
    checkUserAndOpenProfile();

    if (typeof refreshHeroCTA === "function") if (typeof refreshHeroCTA === "function") setTimeout(refreshHeroCTA, 120);
    if (typeof refreshPricingSection === "function") if (typeof refreshPricingSection === "function") setTimeout(refreshPricingSection, 160);
    // Saved companies (KOBI MVP)
    setTimeout(() => {
      try {
        if (typeof fetchSavedCompanies === 'function') {
          fetchSavedCompanies().then(() => { try { updateSaveButtonsUI(); try{ updateFollowButtonsUI(); }catch(e){} refreshCompanyCardsAfterSavedChange(); } catch(e) {} });
        }
      } catch(e) {}
    }, 0); 
  } 
  else if (event === 'SIGNED_OUT') {
    // Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ysa temizle + ana sayfaya dÃ¶n (deploy path baÄŸÄ±msÄ±z)
    try { localStorage.removeItem("BTrustOn_my_company_id"); } catch(e) {}
    try { __myProForEngagement = false; } catch(e) {}

    
    // âœ… Clear auth id + follow cache
    try { __authUserId = null; } catch(e) {}
    try { if (typeof homeFollowSet !== "undefined" && homeFollowSet && homeFollowSet.clear) homeFollowSet.clear(); } catch(e) {}
    try { homeFollowLoadedFor = null; } catch(e) {}
    try { updateFollowButtonsUI(); } catch(e) {}
// Teardown realtime channels / intervals (deferred to avoid TDZ)
    setTimeout(() => {
      try {
        if (typeof notifChannel !== "undefined" && notifChannel) {
          try { supabaseClient.removeChannel(notifChannel); } catch(e) {}
          notifChannel = null;
        }
        if (typeof notifUserId !== "undefined") notifUserId = null;
        if (typeof _notifSubscribed !== "undefined") _notifSubscribed = false;

        if (typeof messageChannel !== "undefined" && messageChannel) {
          try { supabaseClient.removeChannel(messageChannel); } catch(e) {}
          messageChannel = null;
        }
        try { if (typeof btonTeardownEngagementNotifications === "function") btonTeardownEngagementNotifications(); } catch(e) {}
        // Optional: clear any registered intervals
        try { if (window.__BTON_INTERVALS) { Object.keys(window.__BTON_INTERVALS).forEach(k => btonClearInterval(k)); } } catch(e) {}
      } catch(e) {}
    }, 0);

    // Inbox / Notifications UI reset
    try {
      inboxData = [];
      notificationsData = [];
    // Saved reset (defer; avoids TDZ during initial script load)
    setTimeout(() => {
      try {
        if (typeof savedCompanyIds !== 'undefined') savedCompanyIds = new Set();
        if (typeof savedCompaniesData !== 'undefined') savedCompaniesData = [];
        if (typeof _savedLoadedOnce !== 'undefined') _savedLoadedOnce = false;
        if (typeof updateSavedBadges === 'function') updateSavedBadges();
        const sp = document.getElementById('saved-panel');
        if (sp && sp.classList.contains('open') && typeof toggleSavedPanel === 'function') toggleSavedPanel();
      } catch(e) {}
    }, 0);
notificationsUnreadCount = 0;
      messagesUnreadCount = 0;
      if (typeof renderInboxItems === "function") renderInboxItems();
    } catch(e) {}

    // Inbox panel aÃ§Ä±ksa kapat
    try {
      const panel = document.getElementById("inbox-panel");
      if (panel && panel.classList.contains("open") && typeof toggleInbox === "function") toggleInbox();
    } catch(e) {}

    // Ana sayfa (Home) gÃ¶rÃ¼nÃ¼mÃ¼ne dÃ¶n
    try {
      if (typeof showMainView === "function") {
        showMainView();
        if (typeof refreshHeroCTA === "function") setTimeout(refreshHeroCTA, 0);
        if (typeof refreshPricingSection === "function") setTimeout(refreshPricingSection, 0);
        setTimeout(refreshHomeUpdatesCTA, 0);
      } else {
        // fallback: aynÄ± dosyayÄ± yeniden yÃ¼kle (subpath uyumlu)
        window.location.href = window.location.pathname + window.location.search;
      }
    } catch(e) {
      try { window.location.reload(); } catch(_) {}
    }
  }
});

/* --- MY COMPANY BUTONU DÃœZELTME --- */

// Eski fonksiyonu bununla deÄŸiÅŸtiriyoruz/eziyoruz:
async function openMyCompanyIfExists() {
  try {
    // 0) Session check (mobile'de localStorage bazen boÅŸ gelebiliyor)
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session || !session.user) {
      showToast("Login required", "Please sign in to open your company profile.", "brand");
      try { openLoginModal(); } catch(e) { try { openJoinModal(); } catch(_) {} }
      return;
    }

    // 1) Prefer stored company id; fallback to authed user id
    let myId = null;
    try { myId = localStorage.getItem("BTrustOn_my_company_id"); } catch(e) {}
    if (!myId) myId = session.user.id;

    // 1b) Prefer claimed company by owner_user_id (seeded profiles use different profile id)
    try {
      if (!myId || String(myId) === String(session.user.id)) {
        const { data: owned, error: oErr } = await supabaseClient
          .from('profiles')
          .select('id')
          .eq('owner_user_id', session.user.id)
          .order('claimed_at', { ascending: false })
          .limit(1);

        if (!oErr && owned && owned.length) {
          myId = owned[0].id;
        }
      }
    } catch(e) {}

    // 2) Persist snapshot for future quick access
    try { localStorage.setItem("BTrustOn_my_company_id", String(myId)); } catch(e) {}

    // 3) If our in-memory list isn't ready (or company not in list), fetch+open reliably
    const hasDb = (typeof database !== "undefined") && Array.isArray(database);
    const existsInDb = hasDb && database.some(c => String(c?.id) === String(myId));

    if (!existsInDb) {
      // forceOpen -> checkUserAndOpenProfile will map profile + call openProfile(profile.id)
      await checkUserAndOpenProfile(true);
      return;
    }

    // 4) Open directly
    openProfile(myId);
  } catch (err) {
    console.error("openMyCompanyIfExists error:", err);
    showToast("Error", "Couldnâ€™t open your company profile. Please try again.", "danger");
  }
}


/* --- PROFÄ°L DÃœZENLEME FONKSÄ°YONLARI --- */
/* =========================================
   1. GÃœNCELLENMÄ°Åž EDÄ°TÃ–R AÃ‡MA FONKSÄ°YONU
   ========================================= */
/* =========================================
   GÃœNCELLENMÄ°Åž EDÄ°TÃ–R FONKSÄ°YONU (SertifikasÄ±z & Temiz)
   ========================================= */
/* --- A. EDÄ°TÃ–RÃœ DOLDURMA (GÃœNCEL) --- */
/* --- GÃœNCELLENMÄ°Åž: editMyProfile (ÃœLKE VE ÅžEHÄ°R DESTEKLÄ°) --- */
function editMyProfile(targetSectionId) {
  if (!selectedCompany) return;

  // Safety: never allow editing other companies
  const myCurrentId = localStorage.getItem("BTrustOn_my_company_id");
  if (!myCurrentId || String(selectedCompany.id) !== String(myCurrentId)) {
    showToast("Not allowed", "You can only edit your own company profile.", "error");
    return;
  }

  targetSectionId = targetSectionId || null;

  // 1. Mevcut verileri kutulara doldur
  document.getElementById("edit-name").value = selectedCompany.name || "";
  document.getElementById("edit-tagline").value = selectedCompany.tagline || "";
  document.getElementById("edit-desc").value = selectedCompany.desc || "";
  
  // --- YENÄ° EKLENEN KISIM (Ãœlke ve Åžehir) ---
  document.getElementById("edit-city").value = selectedCompany.city || "";
  
  // âœ… Ä°ÅžTE BURASI: EÄŸer veri yoksa otomatik 'Turkey' seÃ§er
  document.getElementById("edit-country").value = selectedCompany.country || "Turkey";
document.getElementById("edit-address").value = selectedCompany.address || ""; 

  // Logo GÃ¶sterimi
  const logoUrl = selectedCompany.logo_url;
  if (logoUrl) {
      document.getElementById("edit-logo-img").src = logoUrl;
      document.getElementById("edit-logo-img").classList.remove("hidden");
      document.getElementById("edit-logo-icon").classList.add("hidden");
  } else {
      document.getElementById("edit-logo-img").src = "";
      document.getElementById("edit-logo-img").classList.add("hidden");
      document.getElementById("edit-logo-icon").classList.remove("hidden");
  }
  selectedLogoFile = null; 

  // Ä°letiÅŸim Bilgileri
  document.getElementById("edit-website").value = selectedCompany.website || "";
  document.getElementById("edit-phone").value = selectedCompany.phone || "";
  document.getElementById("edit-email").value = selectedCompany.contact_email || selectedCompany.email || "";

  // SektÃ¶r ve Tip SeÃ§imi
  const sectorSelect = document.getElementById("edit-sector");
  if(sectorSelect) sectorSelect.value = selectedCompany.sector;

  const typeEl = document.getElementById("edit-type");
  const sizeEl = document.getElementById("edit-size");
  const yearEl = document.getElementById("edit-year");

  if(typeEl) typeEl.value = selectedCompany.type_label || "Operator"; // VarsayÄ±lanÄ± gÃ¼ncelledik
  if(sizeEl) sizeEl.value = selectedCompany.size_label || "1-10 employees";
  if(yearEl) yearEl.value = selectedCompany.year_label || "";

  // Hizmetler
  const services = selectedCompany.services || []; 
  document.getElementById("edit-services").value = Array.isArray(services) ? services.join(", ") : services;
  document.getElementById("edit-reg-no").value = selectedCompany.registry_number || selectedCompany.tax_id || "";
  document.getElementById("edit-reg-region").value = selectedCompany.registry_region || "";
  document.getElementById("edit-reg-url").value = selectedCompany.registry_url || "";
  try { updateRegistryVerificationUI(); } catch(_) {}
  document.getElementById("edit-service-details").value = selectedCompany.service_details || ""; // <-- BU SATIRI EKLE 

  // âœ… Services Tag Editor (chips + featured + reorder)
  try {
    initServiceTagEditor();
    setServiceTagsFromString(document.getElementById("edit-services").value);

    const existingFeatured = selectedCompany.services_featured || "";
    const hasExisting = Array.isArray(existingFeatured) ? existingFeatured.length > 0 : String(existingFeatured || "").trim() !== "";
    if (hasExisting) {
      setServiceFeaturedFromAny(existingFeatured);
    } else {
      // default: first 5 tags become featured (user can change anytime)
      const currentTags = (window.__svcEditor && window.__svcEditor.tags) ? window.__svcEditor.tags : [];
      setServiceFeaturedFromAny(currentTags.slice(0, 5));
    }
  } catch(e) {}



// ðŸ‘‡ðŸ‘‡ðŸ‘‡ D ADIMI: OWNER VERÄ°LERÄ°NÄ° KUTULARA DOLDUR ðŸ‘‡ðŸ‘‡ðŸ‘‡
  
  // 1. Ã–nce "Bu ÅŸirketin bir yetkili kaydÄ± var mÄ±?" diye bakÄ±yoruz
  const hasOwner = selectedCompany.owner_name || selectedCompany.owner_role;
  
  // 2. Varsa anahtarÄ± (toggle) aÃ§Ä±yoruz
  document.getElementById("edit-owner-toggle").checked = !!hasOwner;
  toggleOwnerSection(); // Kutuyu aÃ§ veya kapa
  
  // 3. Ä°sim, Rol ve LinkedIn linkini dolduruyoruz
  document.getElementById("edit-owner-name").value = selectedCompany.owner_name || "";
  document.getElementById("edit-owner-role").value = selectedCompany.owner_role || "";
  document.getElementById("edit-owner-linkedin").value = selectedCompany.owner_linkedin || "";
  
  // 4. FotoÄŸraf varsa gÃ¶steriyoruz, yoksa temizliyoruz
  if (selectedCompany.owner_photo_url) {
      document.getElementById("preview-owner-img").src = selectedCompany.owner_photo_url;
      document.getElementById("preview-owner-img").classList.remove("hidden");
      document.getElementById("icon-owner-img").classList.add("hidden");
  } else {
      // EÄŸer fotoÄŸraf yoksa, temizleme fonksiyonunu Ã§aÄŸÄ±rÄ±p ikon haline dÃ¶ndÃ¼rÃ¼yoruz
      if(typeof deleteOwnerPhoto === "function") deleteOwnerPhoto(); 
  } 

  updateVerificationUI(selectedCompany.verification_status);

  // EditÃ¶rÃ¼ AÃ§
  showEditorView();
  
  
  // âœ… Ensure services tag editor renders AFTER editor view becomes visible (prevents blank list / JS timing issues)
  try {
    setTimeout(() => {
      try {
        initServiceTagEditor();
        setServiceTagsFromString(document.getElementById("edit-services").value);

        const existingFeatured = selectedCompany.services_featured || "";
        const hasExisting = Array.isArray(existingFeatured) ? existingFeatured.length > 0 : String(existingFeatured || "").trim() !== "";
        if (hasExisting) {
          setServiceFeaturedFromAny(existingFeatured);
        } else {
          const currentTags = (window.__svcEditor && window.__svcEditor.tags) ? window.__svcEditor.tags : [];
          setServiceFeaturedFromAny(currentTags.slice(0, 5));
        }
      } catch(e) { if (typeof BTON_DEBUG !== "undefined" && BTON_DEBUG) console.error(e); }
    }, 0);
  } catch(e) {}
// Profil doluluk oranÄ±nÄ± hesapla
  setTimeout(initEditorListeners, 100); 
  // âœ… Jump directly to a requested editor section (e.g., Services & Capabilities)
  if (targetSectionId) {
    setTimeout(() => {
      const el = document.getElementById(targetSectionId);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        el.classList.add("bton-focus-flash");
        setTimeout(() => el.classList.remove("bton-focus-flash"), 1400);
      }
    }, 260);
  }

}
/* =========================================
   2. YENÄ° EKLENEN FONKSÄ°YONLAR (AltÄ±na Gelecek)
   ========================================= */

// A. Sol menÃ¼den tÄ±klayÄ±nca ilgili yere kaydÄ±rma

function scrollToSection(sectionId) {
  try {
    const el = document.getElementById(sectionId);
    if (!el) return;

    // If the global header is fixed, keep a comfortable offset
    const headerOffset = 110;

    const rect = el.getBoundingClientRect();
    const absoluteY = rect.top + window.pageYOffset;
    const targetY = Math.max(0, absoluteY - headerOffset);

    window.scrollTo({ top: targetY, behavior: "smooth" });

    // subtle focus flash to help the user see where they landed
    el.classList.add("bton-focus-flash");
    setTimeout(() => el.classList.remove("bton-focus-flash"), 1400);
  } catch (e) {
    // no-op
  }
}

/* --- PROFILE STRENGTH HESAPLAMA (GÃœNCEL) --- */
function calculateProfileStatus() {
  // 1. ADIM: FORM ALANLARINI KONTROL ET
  // Yeni eklenen "edit-website" ve "edit-phone" listeye eklendi
  const fields = [
    "edit-name", "edit-city", "edit-sector", "edit-desc", 
    "edit-services", "edit-type", "edit-size", "edit-year",
    "edit-website", "edit-phone" 
  ];

  let filledCount = 0;
  fields.forEach(id => {
    const el = document.getElementById(id);
    // BoÅŸluklarÄ± temizle ve dolu mu bak
    if (el && el.value && el.value.trim().length > 0) {
      filledCount++;
    }
  });
  
  // Form puanÄ± (Toplam skorun %60'Ä± formdan gelir)
  const formScore = Math.round((filledCount / fields.length) * 60);

  // 2. ADIM: PROJE VE VARLIK KONTROLÃœ
  let projectScore = 0;
  let assetScore = 0;

  if (selectedCompany) {
      // En az 1 proje varsa +20 Puan
      if (selectedCompany.projects && selectedCompany.projects.length > 0) {
          projectScore = 20;
      }
      // En az 1 varlÄ±k varsa +20 Puan
      if (selectedCompany.assets && selectedCompany.assets.length > 0) {
          assetScore = 20;
      }
  }

  // TOPLAM PUAN
  const totalPercent = formScore + projectScore + assetScore;

  // UI GÃœNCELLEME
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("status-percent");
  const msg = document.getElementById("status-text");

  if (bar) bar.style.width = `${totalPercent}%`;
  if (text) text.textContent = `${totalPercent}%`;

  // RENK VE MESAJ AYARLARI
  if (totalPercent >= 100) {
      if(msg) msg.textContent = (t("ui_profile_strength_fully_optimized_33b0be") || "Excellent! Your profile is fully optimized.");
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
      if(text) text.classList.replace("text-blue-600", "text-emerald-600");
  } else if (totalPercent >= 70) {
      if(msg) msg.textContent = (t("ui_profile_strength_strong_fill_missing_100_6b2b57") || "Strong profile. Fill missing info to reach 100%.");
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-blue-600";
  } else {
      if(msg) msg.textContent = (t("ui_profile_strength_need_more_proof_add_projects_assets_5b07c1") || "Your profile needs more proof. Add projects & assets to improve visibility.");
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-amber-500";
      if(text) text.classList.replace("text-blue-600", "text-amber-600");
  }
}
// C. EditÃ¶r aÃ§Ä±ldÄ±ÄŸÄ±nda ve yazÄ± yazÄ±ldÄ±ÄŸÄ±nda hesaplamayÄ± tetikle
function initEditorListeners() {
  const inputs = document.querySelectorAll("#editor-form input, #editor-form select, #editor-form textarea");
  inputs.forEach(input => {
    // Her tuÅŸa basÄ±ldÄ±ÄŸÄ±nda veya seÃ§im deÄŸiÅŸtiÄŸinde hesapla
    input.addEventListener("input", calculateProfileStatus);
    input.addEventListener("change", calculateProfileStatus);
  });
  
  // Ä°lk aÃ§Ä±lÄ±ÅŸta bir kere hesapla
  calculateProfileStatus();
}
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (En alta ekleyin) --- */
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (GÃœNCELLENMÄ°Åž HALÄ°) --- */
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (TIKLANABÄ°LÄ°R VERSÄ°YON) --- */
function showToast(title, message, type = 'success', onClick = null) {
  // âœ… Backward-compatible: allow showToast("Title only") calls
  if (message === undefined || message === null) message = "";
  if (title === undefined || title === null) title = "";

  // âœ… Skeleton aÃ§Ä±kken profil yÃ¼kleme toast'larÄ±nÄ± bastÄ±r (refresh + normal geÃ§iÅŸ)
  if (window.__suppressProfileLoadingToasts) {
    const t = String(title || "").toLowerCase();
    const m = String(message || "").toLowerCase();
    if (t.includes("loading") || m.includes("loading") || m.includes("fetching") || m.includes("profile")) {
      return;
    }
  }


  // âœ… i18n: normalize common toast titles (Success/Deleted/Error...)
  try {
    const raw = String(title || "").trim();
    const key = raw.toLowerCase();
    const tt = (k, fallback) => (typeof window.t === "function" ? (t(k) || fallback) : fallback);
    const map = {
      "success": tt("toast_success", (currentLang === "tr" ? "BaÅŸarÄ±lÄ±" : "Success")),
      "deleted": tt("toast_deleted", (currentLang === "tr" ? "Silindi" : "Deleted")),
      "removed": tt("toast_removed", (currentLang === "tr" ? "KaldÄ±rÄ±ldÄ±" : "Removed")),
      "saved": tt("toast_saved", (currentLang === "tr" ? "Kaydedildi" : "Saved")),
      "error": tt("toast_error", (currentLang === "tr" ? "Hata" : "Error")),
      "warning": tt("toast_warning", (currentLang === "tr" ? "UyarÄ±" : "Warning")),
      "cleared": tt("toast_cleared", (currentLang === "tr" ? "Temizlendi" : "Cleared")),
      "loading...": tt("toast_loading", (currentLang === "tr" ? "YÃ¼kleniyor..." : "Loading...")),
      "uploading...": tt("toast_uploading", (currentLang === "tr" ? "YÃ¼kleniyor..." : "Uploading...")),
      "downloading...": tt("toast_downloading", (currentLang === "tr" ? "Ä°ndiriliyor..." : "Downloading...")),
      "processing...": tt("toast_processing", (currentLang === "tr" ? "Ä°ÅŸleniyor..." : "Processing...")),
      "ready": tt("toast_ready", (currentLang === "tr" ? "HazÄ±r" : "Ready")),
      "limit reached": tt("toast_limit_reached", (currentLang === "tr" ? "SÄ±nÄ±r aÅŸÄ±ldÄ±" : "Limit Reached")),
      "missing info": tt("toast_missing_info", (currentLang === "tr" ? "Eksik bilgi" : "Missing Info")),
      "login required": tt("toast_login_required", (currentLang === "tr" ? "GiriÅŸ gerekli" : "Login required")),
      "not allowed": tt("toast_not_allowed", (currentLang === "tr" ? "Ä°zin yok" : "Not allowed")),
      "unavailable": tt("toast_unavailable", (currentLang === "tr" ? "KullanÄ±lamÄ±yor" : "Unavailable")),
      "file too large": tt("toast_file_too_large", (currentLang === "tr" ? "Dosya Ã§ok bÃ¼yÃ¼k" : "File too large")),
      "too large": tt("toast_too_large", (currentLang === "tr" ? "Ã‡ok bÃ¼yÃ¼k" : "Too Large")),
      "image cropped": tt("toast_image_cropped", (currentLang === "tr" ? "GÃ¶rsel kÄ±rpÄ±ldÄ±" : "Image Cropped")),
      "marked unread": tt("toast_marked_unread", (currentLang === "tr" ? "OkunmadÄ± olarak iÅŸaretlendi" : "Marked Unread")),
      "up to date": tt("toast_up_to_date", (currentLang === "tr" ? "GÃ¼ncel" : "Up to date")),
      "welcome!": tt("toast_welcome", (currentLang === "tr" ? "HoÅŸ geldiniz!" : "Welcome!")),
      "welcome to pro!": tt("toast_welcome_pro", (currentLang === "tr" ? "Proâ€™ya hoÅŸ geldiniz!" : "Welcome to Pro!")),
      "registration failed": tt("toast_registration_failed", (currentLang === "tr" ? "KayÄ±t baÅŸarÄ±sÄ±z" : "Registration Failed")),
      "payment link missing": tt("toast_payment_link_missing", (currentLang === "tr" ? "Ã–deme baÄŸlantÄ±sÄ± yok" : "Payment link missing"))
    };
    if (map[key]) title = map[key];
  } catch(e) {}

  const container = document.getElementById('toast-container');
  if (!container) return;

  const toast = document.createElement('div');
  
  // TÄ±klanabilir ise mouse imleci el iÅŸareti olsun
  const cursorClass = onClick ? 'cursor-pointer hover:bg-gray-50' : '';
  toast.className = `toast ${type} ${cursorClass}`;
  
  // Ä°kon SeÃ§imi
  let icon = 'fa-circle-check'; 
  if (type === 'error') icon = 'fa-circle-xmark';
  if (type === 'brand') icon = 'fa-tower-broadcast'; 

  const _msgStyle = String(message || "").trim() ? "" : "style=\"display:none\"";
  toast.innerHTML = `
    <i class="fa-solid ${icon}"></i>
    <div class="toast-content">
      <span class="toast-title">${title}</span>
      <span class="toast-msg" ${_msgStyle}>${message}</span>
    </div>
    <button id="close-toast-btn" class="text-gray-400 hover:text-gray-600 z-50 p-1">
      <i class="fa-solid fa-xmark text-sm"></i>
    </button>
  `;

  // TIKLAMA OLAYI
  toast.onclick = (e) => {
    // EÄŸer kapatma butonuna (veya ikonuna) basÄ±ldÄ±ysa mesajÄ± aÃ§ma, sadece kapat
    if (e.target.closest('#close-toast-btn')) {
        toast.remove();
        return;
    }
    
    // EÄŸer tÄ±klama aksiyonu varsa Ã§alÄ±ÅŸtÄ±r
    if (onClick) {
        onClick();
        toast.remove(); // TÄ±klayÄ±nca bildirimi ekrandan kaldÄ±r
    }
  };

  // Kapatma butonu iÃ§in Ã¶zel dinleyici (Garanti olsun diye)
  const closeBtn = toast.querySelector('#close-toast-btn');
  if(closeBtn) {
      closeBtn.onclick = (e) => {
          e.stopPropagation(); // TÄ±klamayÄ± yukarÄ± geÃ§irme
          toast.remove();
      };
  }

  container.appendChild(toast);

  // 4 saniye sonra otomatik sil
  setTimeout(() => {
    if (toast.parentNode) { // Hala ekrandaysa
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
    }
  }, 4000);
}

/* --- Pretty Confirm Dialog (replaces browser confirm "This page says...") --- */
function uiConfirm(message, opts = {}) {
  return new Promise((resolve) => {
    const modal = document.getElementById("confirm-modal");
    const titleEl = document.getElementById("confirm-title");
    const msgEl = document.getElementById("confirm-message");
    const btnOk = document.getElementById("confirm-ok");
    const overlay = document.getElementById("confirm-overlay");
    const btnCancel = document.getElementById("confirm-cancel");
    const btnX = document.getElementById("confirm-x");
    if (!modal || !titleEl || !msgEl || !btnOk || !btnCancel || !btnX || !overlay) {
      // fallback
      resolve(confirm(message));
      return;
    }

    const title = opts.title || ((currentLang==="tr") ? "Onay" : "Confirm");
    const okText = opts.okText || ((currentLang==="tr") ? "Tamam" : "OK");
    const cancelText = opts.cancelText || ((currentLang==="tr") ? "VazgeÃ§" : "Cancel");
    titleEl.textContent = title;
    msgEl.textContent = String(message || "");
    btnOk.textContent = okText;
    btnCancel.textContent = cancelText;

    // styles
    btnOk.classList.remove("bg-slate-900","bg-rose-600");
    btnOk.classList.add(opts.variant === "danger" ? "bg-rose-600" : "bg-slate-900");

    let settled = false;
    const cleanup = (val) => {
      if (settled) return;
      settled = true;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.removeEventListener("keydown", onKey);
      btnOk.removeEventListener("click", onOk);
      btnCancel.removeEventListener("click", onCancel);
      btnX.removeEventListener("click", onCancel);
      overlay.removeEventListener("click", onCancel);
      resolve(val);
    };
    const onOk = (e) => { e.preventDefault(); cleanup(true); };
    const onCancel = (e) => { e.preventDefault(); cleanup(false); };
    const onKey = (e) => {
      if (e.key === "Escape") cleanup(false);
    };

    btnOk.addEventListener("click", onOk);
    btnCancel.addEventListener("click", onCancel);
    btnX.addEventListener("click", onCancel);
    overlay.addEventListener("click", onCancel);
    document.addEventListener("keydown", onKey);

    modal.classList.remove("hidden");
    modal.classList.add("flex");
    // focus for accessibility
    setTimeout(() => { try { btnOk.focus(); } catch(_) {} }, 0);
  });
}


/* --- Standard delete confirmation message (same style as Company Updates delete) --- */
function _deleteEntityLabel(entityKey) {
  const map = {
    asset: { en: "asset", tr: "asset" },
    certificate: { en: "certificate", tr: "sertifika" },
    project: { en: "project", tr: "project" },
    update: { en: "update", tr: "paylaÅŸÄ±m" },
    notification: { en: "notification", tr: "bildirim" },
    conversation: { en: "conversation", tr: "konuÅŸma" },
    message: { en: "message", tr: "mesaj" }
  };
  const v = map[entityKey] || { en: String(entityKey || "item"), tr: String(entityKey || "kayÄ±t") };
  return (currentLang === "tr") ? v.tr : v.en;
}

function _deleteConfirmMsg(entityKey) {
  const label = _deleteEntityLabel(entityKey);
  return (currentLang === "tr")
    ? `Bu ${label} kaydÄ±nÄ± silmek istiyor musun?`
    : `Delete this ${label}?`;
}


/* --- SÄ°LME ONAY SÄ°STEMÄ° --- */
let pendingDeleteAction = null; // Silme fonksiyonunu burada tutacaÄŸÄ±z

function openDeleteModal(message, actionCallback, opts = {}) {
  // Use the same confirmation UI used in Company Updates (uiConfirm)
  // Backward compatible with existing call sites that pass (message, callback)
  uiConfirm(String(message || ""), {
    title: opts.title || (t("ui_confirm_title") || ((currentLang === "tr") ? "Onay" : "Confirm")),
    okText: opts.okText || (t("ui_delete") || ((currentLang === "tr") ? "Sil" : "Delete")),
    cancelText: opts.cancelText || (t("ui_cancel") || ((currentLang === "tr") ? "VazgeÃ§" : "Cancel")),
    variant: opts.variant || "danger"
  }).then(async (ok) => {
    if (!ok) return;
    try {
      if (typeof actionCallback === "function") {
        await actionCallback();
      }
    } catch (e) {
      console.error("openDeleteModal action error:", e);
    }
  });
}

function closeDeleteModal() {
  const modal = document.getElementById("delete-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  
  // Efekt sÄ±fÄ±rlama
  const content = document.getElementById("delete-modal-content");
  if(content) {
      content.classList.remove("scale-100");
      content.classList.add("scale-95");
  }
  
  pendingDeleteAction = null;
}

/* --- YENÄ° EKLENECEK KODLAR --- */

// Hangi sekmedeyiz? (VarsayÄ±lan: inbox)
let currentInboxView = 'inbox'; 

// Sekme DeÄŸiÅŸtirme Fonksiyonu
function switchInboxView(view) {
    currentInboxView = view;

    // UI GÃ¼ncelleme (Border ve Renkler)
    const btnInbox = document.getElementById("btn-tab-inbox");
    const btnSent  = document.getElementById("btn-tab-sent");
    const btnNotif = document.getElementById("btn-tab-notif");

    const setActive = (btn) => {
      if(!btn) return;
      btn.classList.add("border-BTrustOn-accent", "text-white");
      btn.classList.remove("border-transparent", "text-white/50");
    };
    const setInactive = (btn) => {
      if(!btn) return;
      btn.classList.remove("border-BTrustOn-accent", "text-white");
      btn.classList.add("border-transparent", "text-white/50");
    };

    // Reset all
    setInactive(btnInbox);
    setInactive(btnSent);
    setInactive(btnNotif);

    // Activate selected
    if (view === 'inbox') setActive(btnInbox);
    else if (view === 'sent') setActive(btnSent);
    else setActive(btnNotif);

    // Listeyi yeniden Ã§iz
    renderInboxItems();
}
/* --- PREMIUM INBOX ENGINE (EN ALTA EKLE) --- */
// ðŸ‘‡ YENÄ° EKLENECEK KISIM ðŸ‘‡

// Inbox verisini artÄ±k canlÄ± tutacaÄŸÄ±z, demo veriyi sildik, boÅŸ baÅŸlattÄ±k.
let inboxData = [];
// --- Manual Unread Thread Flags (for "Mark Unread" UX) ---
// Stores a lightweight per-user map in localStorage so "Mark Unread" immediately affects counts
// even if there are no unread DB rows in that thread.
function __btonNormalizeSubject(s) { return String(s||"").replace(/^(Re:\s*)+/i,'').trim(); }
function __btonThreadKey(partnerId, subject) { return String(partnerId||"").trim()+"::"+__btonNormalizeSubject(subject).toLowerCase(); }
function __btonManualUnreadStorageKey(uid) { return "bton_manual_unread_threads:" + String(uid || window.__authUserId || "anon"); }
function __btonReadManualUnread(uid) {
  try { return JSON.parse(localStorage.getItem(__btonManualUnreadStorageKey(uid)) || "{}") || {}; } catch(e){ return {}; }
}
function __btonWriteManualUnread(uid, obj) {
  try { localStorage.setItem(__btonManualUnreadStorageKey(uid), JSON.stringify(obj||{})); } catch(e){}
}
function __btonSetManualUnread(uid, partnerId, subject, on) {
  const key = __btonThreadKey(partnerId, subject);
  const map = __btonReadManualUnread(uid);
  if (on) map[key] = Date.now();
  else delete map[key];
  __btonWriteManualUnread(uid, map);
}
function __btonApplyManualUnreadToInbox(uid) {
  try {
    const map = __btonReadManualUnread(uid);
    (inboxData||[]).forEach(it => {
      const k = __btonThreadKey(it.partner_id, it.title);
      if (map && map[k]) { it.unread = true; it.manual_unread = true; }
    });
  } catch(e){}
}
function __btonClearManualUnreadForThread(uid, partnerId, subject) {
  try { __btonSetManualUnread(uid, partnerId, subject, false); } catch(e){}
}
function __btonClearAllManualUnread(uid){
  try { __btonWriteManualUnread(uid, {}); } catch(e){}
}

// --- Notifications (for admin reject/approve updates) ---
let notificationsUnreadCount = 0;
let notificationsData = [];
let messagesUnreadCount = 0;
let inboxUnreadCount = 0;
let sentUnreadCount = 0;
let _notifSubscribed = false;
let notifChannel = null;
let notifUserId = null;

// --- Saved Companies (KOBI MVP: Save + Note) ---
let savedCompanyIds = new Set();         // Set of saved_company_id
let savedCompaniesData = [];             // [{id,rowId,saved_company_id,note,created_at, company:{...}}]
let _savedLoadedOnce = false;


// --- Company Follows (Follow list + Only followed filter) ---
let followingCompanyIds = new Set();
let followingCompaniesData = [];
let _followingLoading = false;
let _followingLastError = "";
 // [{company:{...}, created_at}]
let _followingLoadedOnce = false;
let savedPanelTab = "saved";

// Saved snapshots indexed from rendered cards (safe: used only to enrich saved insert payload)
const companySnapshotById = {};
function normalizeCompanySnapshot(c) {
  if (!c) return null;
  const id = c.id || c.profile_id || c.company_id;
  if (!id) return null;

  const vs = (c.verification_status || c.verificationStatus || "").toString().trim();
  const boolTrue = (x) => (x === true || x === 1 || x === "true" || x === "1");
  const vFlag = (vs.toLowerCase() === "approved" || vs.toLowerCase() === "verified")
    || boolTrue(c.is_verified) || boolTrue(c.verified) || boolTrue(c.blue_tick);

  return {
    id,
    name: c.company_name || c.name || c.company || "â€”",
    logo_url: c.logo_url || c.company_logo_url || c.logo || null,
    city: c.city || "â€”",
    country: c.country || "TR",
    type: (c.company_type || c.business_type || c.type || c.type_label || c.company_type_label || c.business_type_label || null),

    // Verified snapshot (best-effort)
    verification_status: vs || null,
    is_verified: vFlag,
    verified: vFlag,
    blue_tick: vFlag
  };
}
function indexCompanySnapshot(c) {
  const snap = normalizeCompanySnapshot(c);
  if (snap && snap.id) companySnapshotById[String(snap.id)] = snap;
}
function getCompanySnapshotById(id) {
  return companySnapshotById[String(id)] || null;
}

// UUID helper (for Supabase ids)
const UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
function isUuid(v){ return UUID_RE.test(String(v || '')); }

function getMyCompanyId() {
  try { return localStorage.getItem("BTrustOn_my_company_id"); } catch(e) { return null; }
}

// Helper: always act on the currently owned company profile id (claimed or legacy)
function myCompanyIdOr(uid) {
  try {
    const s = getMyCompanyId();
    return (s && typeof isUuid === "function" && isUuid(s)) ? s : uid;
  } catch(e) {
    return uid;
  }
}




// =========================================================
// Claim-aware helpers for "active company" + partner resolution
// =========================================================
let __btonMyCompanyCache = { userId: null, profile: null, ts: 0 };
async function btonGetMyCompanyProfileFresh(force=false) {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return null;

    const now = Date.now();
    if (!force && __btonMyCompanyCache.userId === user.id && __btonMyCompanyCache.profile && (now - __btonMyCompanyCache.ts) < 60000) {
      return __btonMyCompanyCache.profile;
    }

    const p = await _fetchMyCompanyProfile(user.id);
    if (p && p.id) {
      try { localStorage.setItem("BTrustOn_my_company_id", p.id); } catch(e) {}
    }
    __btonMyCompanyCache = { userId: user.id, profile: (p || null), ts: now };
    return p || null;
  } catch(e) {
    return null;
  }
}

const __btonOwnerToCompanyCache = new Map();
async function btonResolveCompanyByOwnerId(ownerUserId) {
  try {
    const key = String(ownerUserId || "");
    if (!key || key === "null" || key === "undefined") return null;
    if (__btonOwnerToCompanyCache.has(key)) return __btonOwnerToCompanyCache.get(key);

    // Prefer a claimed company row (id != owner_user_id), then newest claimed_at
    const res = await supabaseClient
      .from("profiles")
      .select("id, company_name, owner_user_id, claimed_at")
      .eq("owner_user_id", ownerUserId)
      .order("claimed_at", { ascending: false })
      .limit(10);

    let best = null;
    if (!res.error && Array.isArray(res.data) && res.data.length) {
      best = res.data.slice().sort((a,b)=>{
        const aNon = (String(a.id) !== String(a.owner_user_id)) ? 1 : 0;
        const bNon = (String(b.id) !== String(b.owner_user_id)) ? 1 : 0;
        if (aNon !== bNon) return bNon - aNon;
        const at = a.claimed_at ? (new Date(a.claimed_at).getTime() || 0) : 0;
        const bt = b.claimed_at ? (new Date(b.claimed_at).getTime() || 0) : 0;
        return bt - at;
      })[0];
    }

    // Fallback: legacy profile id == owner id
    if (!best) {
      const fb = await supabaseClient.from("profiles").select("id, company_name, owner_user_id, claimed_at").eq("id", ownerUserId).maybeSingle();
      if (fb && fb.data) best = fb.data;
    }

    if (best) __btonOwnerToCompanyCache.set(key, best);
    return best;
  } catch(e) {
    return null;
  }
}
function updateSavedBadges() {
  // Updates counts inside Lists panel (Saved + Following). No badge on the top nav button.
  const savedCount = (savedCompanyIds && typeof savedCompanyIds.size === 'number')
    ? savedCompanyIds.size
    : (savedCompaniesData.length || 0);

  const followCount = (followingCompanyIds && typeof followingCompanyIds.size === 'number')
    ? followingCompanyIds.size
    : (followingCompaniesData.length || 0);

  // Tabs counts
  const sTab = document.getElementById("saved-tab-count");
  if (sTab) sTab.textContent = String(savedCount);
  const fTab = document.getElementById("following-tab-count");
  if (fTab) fTab.textContent = String(followCount);

  // Hide any legacy total badges (nav + panel header)
  const badge = document.getElementById("saved-badge");
  if (badge) badge.classList.add("hidden");
  const panelBadge = document.getElementById("saved-panel-count");
  if (panelBadge) panelBadge.classList.add("hidden");
}




function isCompanySaved(companyId) {
  if (!companyId) return false;
  return savedCompanyIds.has(String(companyId));
}

async function fetchSavedCompanies() {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      savedCompanyIds = new Set();
      savedCompaniesData = [];
      updateSavedBadges();
      return;
    }

    const storedCompanyId = getMyCompanyId();
    const companyId = (storedCompanyId && isUuid(storedCompanyId)) ? storedCompanyId : user.id;
    try { if (storedCompanyId !== companyId) localStorage.setItem("BTrustOn_my_company_id", String(companyId)); } catch(e) {}

    let rows = null;
    let error = null;

    const selectV2 = 'id, company_id, saved_company_id, note, created_at, updated_at, saved_company_name, saved_company_logo_url, saved_company_country, saved_company_city, saved_company_type, saved_company_is_verified, saved_company_verification_status';
    const selectV1 = 'id, company_id, saved_company_id, note, created_at, updated_at, saved_company_name, saved_company_logo_url, saved_company_country, saved_company_city, saved_company_type';

    try {
      const res = await supabaseClient
        .from('saved_companies')
        .select(selectV2)
        .eq('company_id', companyId)
        .order('created_at', { ascending: false });

      rows = res.data || [];
      error = res.error || null;

      // Fallback if new snapshot columns don't exist yet
      if (error) {
        const msg = String(error?.message || error?.details || error || "");
        const low = msg.toLowerCase();
        if (low.includes("does not exist") || low.includes("column") || low.includes("schema cache") || low.includes("pgrst")) {
          const res2 = await supabaseClient
            .from('saved_companies')
            .select(selectV1)
            .eq('company_id', companyId)
            .order('created_at', { ascending: false });

          rows = res2.data || [];
          error = res2.error || null;
        }
      }
    } catch(e) {
      error = e;
      rows = [];
    }

    if (error) {
      console.warn("fetchSavedCompanies error:", error.message);
      savedCompanyIds = new Set();
      savedCompaniesData = [];
      updateSavedBadges();
      return;
    }

    const list = rows || [];
    savedCompanyIds = new Set(list.map(r => String(r.saved_company_id)));

    // âœ… SAFE MODE: Use snapshot fields stored in saved_companies.
    // This avoids any dependency on profiles RLS/policies.
    savedCompaniesData = list.map(r => {
      const boolTrue = (x) => (x === true || x === 1 || x === "true" || x === "1");
      const vStatus = (r.saved_company_verification_status || null);
      const vFlag = boolTrue(r.saved_company_is_verified) || (String(vStatus || "").trim().toLowerCase() === "approved") || (String(vStatus || "").trim().toLowerCase() === "verified");

      const company = {
        id: r.saved_company_id,
        name: (r.saved_company_name || "â€”"),
        logo_url: r.saved_company_logo_url || null,
        city: r.saved_company_city || "â€”",
        country: r.saved_company_country || "TR",
        company_type: ((r.saved_company_type && String(r.saved_company_type).trim() && String(r.saved_company_type).trim().toLowerCase() !== "company") ? r.saved_company_type : null),
        business_type: null,

        // âœ… verified tick support for Saved list (prefers snapshot columns if present)
        verification_status: vStatus,
        is_verified: vFlag,
        verified: vFlag,
        blue_tick: vFlag
      };
      return {
        rowId: r.id,
        saved_company_id: r.saved_company_id,
        note: r.note || "",
        created_at: r.created_at,
        company
      };
    });

    // Optional enrich: try to pull live business type from public profiles (if policies allow).
    // This fixes older saved rows where saved_company_type was stored as "Company".
    try {
      const ids = Array.from(savedCompanyIds || []);
      if (ids.length) {
        let profs = null;
        let pErr = null;

        try {
          let r = await supabaseClient
            .from('profiles')
            .select('id, company_type, verification_status')
            .in('id', ids);

          // Fallback if boolean columns don't exist (common schema)
          if (r.error) {
            const msg = String(r.error?.message || r.error?.details || r.error || "");
            const low = msg.toLowerCase();
            if (low.includes("does not exist") || low.includes("column") || low.includes("schema cache") || low.includes("pgrst")) {
              r = await supabaseClient
                .from('profiles')
                .select('id, company_type, verification_status')
                .in('id', ids);
            }
          }

          profs = r.data || null;
          pErr = r.error || null;
        } catch(e) {
          pErr = e;
          profs = null;
        }

        if (!pErr && Array.isArray(profs)) {
          const metaMap = {};
          profs.forEach(p => {
            metaMap[String(p.id)] = {
              company_type: (p.company_type || null),
              verification_status: (p.verification_status || null),
              is_verified: (p.is_verified || p.verified || p.blue_tick || (String(p.verification_status||'').toLowerCase()==='approved') || (String(p.verification_status||'').toLowerCase()==='verified'))
            };
          });

          savedCompaniesData = (savedCompaniesData || []).map(item => {
            const cid = String(item?.company?.id || "");
            const m = metaMap[cid] || {};
            const t = m.company_type;
            {
              const tt = (t && String(t).trim() && String(t).trim().toLowerCase() !== "company") ? String(t).trim() : null;
              const cur = (item.company.business_type || item.company.company_type || "");
              const curNorm = String(cur).trim().toLowerCase();
              if (tt) {
                // Prefer profiles.company_type as the single source of truth for Saved cards
                item.company.company_type = tt;
                item.company.business_type = tt; // backward compatibility with older UI code

                // Verified meta (best-effort)
                try {
                  if (m && (m.verification_status || m.is_verified)) {
                    item.company.verification_status = m.verification_status || (m.is_verified ? "approved" : "");
                    item.company.is_verified = !!m.is_verified;
                    item.company.verified = !!m.is_verified;
                    item.company.blue_tick = !!m.is_verified;
                  }
                } catch(e) {}


                // If this saved row previously had a useless default (e.g., "Company"), persist the real type for offline-safe rendering
                if (!cur || curNorm === "company" || curNorm === "â€”") {
                  try { supabaseClient.from('saved_companies').update({ saved_company_type: tt }).eq('id', item.rowId); } catch(e) {}
                }
              }
            }
            return item;
          });
        }
      }
    } catch(e) { /* ignore */ }

    updateSavedBadges();
    _savedLoadedOnce = true;

  } catch (e) {
    console.warn("fetchSavedCompanies exception:", e);
  }
}

function refreshCompanyCardsAfterSavedChange() {
  try {
    if (typeof isSearchActive !== 'undefined' && isSearchActive) {
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      if (typeof renderSearchResults === "function") renderSearchResults(q);
    } else {
      if (typeof renderShowcase === "function") renderShowcase();
    }
  } catch(e) {}
}

async function toggleSaveCompany(targetCompanyId) {
  return btonWithLock("toggleSaveCompany:"+String(targetCompanyId), async () => {
  try {
    if (!targetCompanyId) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      // login prompt
      if (typeof toggleModal === "function") toggleModal("modal-join");
      else showToast("Login required", "Please sign in to save companies.", "brand");
      return;
    }

    const storedCompanyId2 = getMyCompanyId();
    const myCompanyId = (storedCompanyId2 && isUuid(storedCompanyId2)) ? storedCompanyId2 : user.id;
    try { if (storedCompanyId2 !== myCompanyId) localStorage.setItem("BTrustOn_my_company_id", String(myCompanyId)); } catch(e) {}

    if (String(targetCompanyId) === String(myCompanyId)) {
      showToast("Not allowed", "You can't save your own company.", "warn");
      return;
    }

    // Only registered (UUID) companies can be saved
    if (!isUuid(targetCompanyId)) {
      showToast("Unavailable", "Only registered companies can be saved.", "warn");
      return;
    }

    const alreadySaved = isCompanySaved(targetCompanyId);

    if (alreadySaved) {
      const { error } = await supabaseClient
        .from('saved_companies')
        .delete()
        .eq('company_id', myCompanyId)
        .eq('saved_company_id', targetCompanyId);

      if (error) {
        showToast("Error", "Couldn't remove saved company: " + error.message, "error");
        return;
      }

      savedCompanyIds.delete(String(targetCompanyId));
      savedCompaniesData = savedCompaniesData.filter(x => String(x.saved_company_id) !== String(targetCompanyId));

      updateSavedBadges();
      updateSaveButtonsUI(); try{ updateFollowButtonsUI(); }catch(e){}
      refreshCompanyCardsAfterSavedChange();
      if (document.getElementById("saved-panel")?.classList.contains("open")) renderSavedCompanies();

      showToast(t("toast_removed"), t("saved_company_removed"), "success");
      return;
    }

    // Insert
    const snap = getCompanySnapshotById(targetCompanyId) ||
      normalizeCompanySnapshot((typeof selectedCompany !== 'undefined' && selectedCompany && String(selectedCompany.id) === String(targetCompanyId)) ? selectedCompany : null);

    const payload = {
      company_id: myCompanyId,
      saved_company_id: targetCompanyId,
      note: "",
      created_by_user_id: user.id,
      saved_company_name: snap ? snap.name : null,
      saved_company_logo_url: snap ? snap.logo_url : null,
      saved_company_city: snap ? snap.city : null,
      saved_company_country: snap ? snap.country : null,
      saved_company_type: snap ? snap.type : null
    };

    // Add verified snapshot if possible (safe: will retry without these columns if schema doesn't have them)
    try {
      const vs = (snap?.verification_status || "").toString().trim();
      const boolTrue = (x) => (x === true || x === 1 || x === "true" || x === "1");
      const vFlag = (vs.toLowerCase() === "approved" || vs.toLowerCase() === "verified")
        || boolTrue(snap?.is_verified) || boolTrue(snap?.verified) || boolTrue(snap?.blue_tick);
      payload.saved_company_verification_status = vs || null;
      payload.saved_company_is_verified = !!vFlag;
    } catch(e) {}

    let ins = await supabaseClient
      .from('saved_companies')
      .insert(payload)
      .select('id')
      .single();

    // Fallback: if new snapshot columns don't exist, retry without them
    if (ins.error) {
      const msg = String(ins.error?.message || ins.error?.details || ins.error || "");
      const low = msg.toLowerCase();
      if (low.includes("does not exist") || low.includes("column") || low.includes("schema cache") || low.includes("pgrst")) {
        try { delete payload.saved_company_verification_status; delete payload.saved_company_is_verified; } catch(e) {}
        ins = await supabaseClient
          .from('saved_companies')
          .insert(payload)
          .select('id')
          .single();
      }
    }

    const { data, error } = ins;

    if (error) {
      showToast("Error", "Couldn't save company: " + error.message, "error");
      return;
    }

    // Optimistic update: we will refetch for correct ordering + profile fields
    savedCompanyIds.add(String(targetCompanyId));
    await fetchSavedCompanies();

    updateSavedBadges();
    updateSaveButtonsUI(); try{ updateFollowButtonsUI(); }catch(e){}
    refreshCompanyCardsAfterSavedChange();
    if (document.getElementById("saved-panel")?.classList.contains("open")) renderSavedCompanies();

    showToast(t("toast_saved"), t("saved_company_added"), "success");

  } catch (e) {
    console.warn("toggleSaveCompany exception:", e);
    showToast("Error", "Unexpected error while saving.", "error");
  }

  }, { ttlMs:8000 });
}

async function updateSavedNote(rowId, newNote) {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    const storedCompanyId2 = getMyCompanyId();
    const myCompanyId = (storedCompanyId2 && isUuid(storedCompanyId2)) ? storedCompanyId2 : user.id;
    try { if (storedCompanyId2 !== myCompanyId) localStorage.setItem("BTrustOn_my_company_id", String(myCompanyId)); } catch(e) {}

    const { error } = await supabaseClient
      .from('saved_companies')
      .update({ note: String(newNote || "").slice(0, 800) })
      .eq('id', rowId)
      .eq('company_id', myCompanyId);

    if (error) {
      showToast("Error", "Note couldn't be saved: " + error.message, "error");
      return;
    }

    const item = savedCompaniesData.find(x => x.rowId === rowId);
    if (item) item.note = String(newNote || "");

    showToast("Saved", "Note updated.", "success");
  } catch (e) {
    console.warn("updateSavedNote exception:", e);
  }
}

async function removeSavedRow(rowId, savedCompanyId) {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;
    const storedCompanyId2 = getMyCompanyId();
    const myCompanyId = (storedCompanyId2 && isUuid(storedCompanyId2)) ? storedCompanyId2 : user.id;
    try { if (storedCompanyId2 !== myCompanyId) localStorage.setItem("BTrustOn_my_company_id", String(myCompanyId)); } catch(e) {}

    const { error } = await supabaseClient
      .from('saved_companies')
      .delete()
      .eq('id', rowId)
      .eq('company_id', myCompanyId);

    if (error) {
      showToast("Error", "Couldn't remove: " + error.message, "error");
      return;
    }

    savedCompanyIds.delete(String(savedCompanyId));
    savedCompaniesData = savedCompaniesData.filter(x => x.rowId !== rowId);

    updateSavedBadges();
    updateSaveButtonsUI(); try{ updateFollowButtonsUI(); }catch(e){}
    refreshCompanyCardsAfterSavedChange();
    renderSavedCompanies();

    showToast(t("toast_removed"), t("saved_company_removed"), "success");
  } catch(e) {
    console.warn("removeSavedRow exception:", e);
  }
}

function renderSavedCompanies() {
  const listEl = document.getElementById("saved-list");
  const emptyEl = document.getElementById("saved-empty");
  if (!listEl || !emptyEl) return;

  const q = (document.getElementById("saved-search")?.value || "").trim().toLowerCase();

  let list = Array.isArray(savedCompaniesData) ? savedCompaniesData.slice() : [];
  if (q) {
    list = list.filter(x => {
      const c = x.company || {};
      const hay = `${c.name || ""} ${(c.business_type || c.company_type || c.type || "")} ${c.city || ""} ${c.country || ""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  if (!list.length) {
    listEl.innerHTML = "";
    emptyEl.classList.remove("hidden");
    return;
  }

  emptyEl.classList.add("hidden");

  listEl.innerHTML = list.map(item => {
    const c = item.company || {};
    const rc = _resolveCompanyFromCaches(c.id) || {};
    const displayName = (c.name || "").trim() || (rc.name || "").trim() || "â€”";

    const initials = (displayName || "C").trim().slice(0, 1).toUpperCase();
    const logoUrl = ((c.logo_url || rc.logo_url || "") + "").trim();
    const logo = logoUrl
      ? `<img src="${logoUrl}" alt="" class="w-10 h-10 rounded-xl object-cover border border-gray-200 bg-white" referrerpolicy="no-referrer" />`
      : `<div class="w-10 h-10 rounded-xl bg-cyan-50 border border-gray-200 grid place-items-center font-bold text-[12px] text-cyan-900">${initials}</div>`;

    const ver = (typeof getVerifiedMark === "function")
      ? getVerifiedMark(Object.assign({}, rc, c))
      : "";

    const missingBadge = c._missing
      ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-amber-50 border border-amber-200 text-amber-700">${_i18n("saved_unavailable", "Unavailable")}</span>`
      : "";

    const metaCity = (c.city || "").trim() || (rc.city || "").trim() || "â€”";
    const metaCountryRaw = ((c.country || "").trim() || (rc.country || "").trim());
    const metaCountryCode = (c.country_code || c.countryCode || c.country_iso2 || c.country_iso || "").trim();
    const metaCountry = metaCountryRaw ? translateCountryName(metaCountryRaw, metaCountryCode) : "â€”";
    const metaTypeRaw = (c.business_type || c.company_type || c.type || (rc.business_type || rc.company_type || rc.type || ""));
    const metaType = (metaTypeRaw && String(metaTypeRaw).trim().toLowerCase() !== "company") ? translateCompanyType(metaTypeRaw) : "â€”";

    const activeHtml = (typeof getActiveRecentlyMark === 'function') ? getActiveRecentlyMark(Object.assign({}, rc, c), { compact: true }) : '';
    const activeChunk = activeHtml ? `<span class="text-gray-300">â€¢</span>${activeHtml}` : "";


    return `
      <div class="saved-item rounded-2xl p-3 bg-white border border-gray-200 shadow-sm">
        <div class="flex items-start gap-3">
          <div class="shrink-0 cursor-pointer" onclick="openProfile('${c.id}', { reserveScroll: true, preserveTab: true }); toggleSavedPanel();">
            ${logo}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-bold text-sm text-BTrustOn-primary cursor-pointer hover:underline min-w-0 flex items-center gap-1"
                     onclick="openProfile('${c.id}', { reserveScroll: true, preserveTab: true }); toggleSavedPanel();">
                  <span class="truncate min-w-0" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</span>
                  <span class="shrink-0 flex items-center gap-1">${ver}${missingBadge}${activeHtml ? `<span class=\"ml-1\">${activeHtml}</span>` : ""}</span>
                </div>
                <div class="text-[10px] text-gray-500 mt-1 flex flex-wrap items-center gap-2">
                  <span class="px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200">${metaType}</span>
                  <span class="text-gray-400">â€¢</span>
                  <span class="truncate">${metaCity}, ${metaCountry}</span>
                                  </div>
              </div>

              <button
                class="w-8 h-8 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 hover:text-red-600 transition flex items-center justify-center"
                title="${t("svc_remove") || "Remove"}"
                onclick="event.stopPropagation(); removeSavedRow('${item.rowId}', '${item.saved_company_id}')"
              >
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </div>

            <div class="mt-2">
              <label class="sr-only">${_i18n("saved_note_label", "Note")}</label>
              <textarea
                class="w-full min-h-[44px] rounded-xl border border-gray-200 bg-white/80 text-[12px] p-2 leading-snug resize-none focus:outline-none focus:ring-2 focus:ring-cyan-200 focus:border-cyan-300"
                placeholder="${_i18n("saved_note_optional_ph", "Note (optional)â€¦")}"
                onkeydown="event.stopPropagation()"
                onclick="event.stopPropagation()"
                onblur="updateSavedNote('${item.rowId}', this.value)"
              >${(item.note || "").replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;}).join("");
}


function toggleSavedPanel() {
  const panel = document.getElementById("saved-panel");
  const overlay = document.getElementById("saved-overlay");
  if (!panel || !overlay) return;

  const isOpen = panel.classList.contains("open");

  if (isOpen) {
    panel.classList.remove("open");
    overlay.classList.remove("opacity-100");
    overlay.classList.add("opacity-0");
    setTimeout(() => overlay.classList.add("hidden"), 300);
  } else {
    overlay.classList.remove("hidden");
    setTimeout(() => {
      overlay.classList.remove("opacity-0");
      overlay.classList.add("opacity-100");
      panel.classList.add("open");
    }, 10);

    // Refresh when opening (Saved + Following)
    (async () => {
      try { await fetchSavedCompanies(); } catch(e) {}
      try { await fetchFollowingCompanies(); } catch(e) {}
      try { setSavedPanelTab(savedPanelTab || "saved"); } catch(e) { try { renderSavedCompanies(); } catch(e2) {} }
    })();
  }
}


function renderSavedPanelActive() {
  if (savedPanelTab === "following") renderFollowingCompanies();
  else renderSavedCompanies();
}

function setSavedPanelTab(tab) {
  const t = (tab === 'following') ? 'following' : 'saved';
  savedPanelTab = t;

  const savedBtn = document.getElementById('saved-tab-btn');
  const followBtn = document.getElementById('following-tab-btn');

  if (savedBtn) {
    const isSaved = (t === 'saved');
    savedBtn.setAttribute('aria-pressed', String(isSaved));
    savedBtn.classList.toggle('bg-white/20', isSaved);
    savedBtn.classList.toggle('bg-white/5', !isSaved);
  }
  if (followBtn) {
    const isFollow = (t === 'following');
    followBtn.setAttribute('aria-pressed', String(isFollow));
    followBtn.classList.toggle('bg-white/20', isFollow);
    followBtn.classList.toggle('bg-white/5', !isFollow);
  }

  // Show/hide sections
  const savedList = document.getElementById('saved-list');
  const followingList = document.getElementById('following-list');
  const savedEmpty = document.getElementById('saved-empty');
  const followingEmpty = document.getElementById('following-empty');

  const showSaved = (t === 'saved');
  if (savedList) savedList.classList.toggle('hidden', !showSaved);
  if (savedEmpty) savedEmpty.classList.toggle('hidden', !showSaved);
  if (followingList) followingList.classList.toggle('hidden', showSaved);
  if (followingEmpty) followingEmpty.classList.toggle('hidden', showSaved);

  // Render active tab content (and ensure Following is fetched)
  try {
    if (savedPanelTab === 'following') {
      (async()=>{ try { await fetchFollowingCompanies(); } catch(e){} try { renderFollowingCompanies(); } catch(e){} })();
    } else {
      renderSavedCompanies();
    }
  } catch(e) {}
}



async function fetchFollowingCompanies() {
  _followingLoading = true;
  _followingLastError = "";
  try {
    if (savedPanelTab === "following") { try { renderFollowingCompanies(); } catch(e){} }

    // Auth (prefer local session, but fallback to getUser)
    let user = null;
    try { user = await _getAuthUserSafe(); } catch(e) {}
    if (!user?.id) {
      try {
        const r = await supabaseClient.auth.getUser();
        user = r?.data?.user || null;
      } catch(e) {}
    }

    if (!user?.id) {
      followingCompanyIds = new Set();
      followingCompaniesData = [];
      _followingLoadedOnce = true;
      updateSavedBadges();
      return;
    }

    // Primary: read snapshot directly from company_follows (no profiles join / no RPC needed)
    // NOTE: rely on RLS for scoping; don't additionally filter by uid to avoid edge-case mismatches.
    let rows = null;
    let error = null;

    try {
      const res = await supabaseClient
        .from("company_follows")
        .select("company_id, company_name, company_logo_url, is_verified, business_type, created_at")
        .eq("follower_user_id", user.id)
        .order("created_at", { ascending: false })
        .limit(500);
      rows = res.data || [];
      error = res.error || null;
    } catch(e) {
      error = e;
    }

    // Fallback if snapshot columns don't exist yet
    if (error) {
      const msg = String(error?.message || error?.details || error || "");
      const low = msg.toLowerCase();
      if (low.includes("does not exist") || low.includes("column") || low.includes("pgrst") || low.includes("schema cache")) {
        const res2 = await supabaseClient
          .from("company_follows")
          .select("company_id, created_at")
          .eq("follower_user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(500);
        if (res2.error) {
          console.warn("fetchFollowingCompanies error:", res2.error);
          _followingLastError = String(res2.error?.message || res2.error?.details || res2.error || "");
          followingCompanyIds = new Set();
          followingCompaniesData = [];
          _followingLoadedOnce = true;
          updateSavedBadges();
          return;
        }
        rows = res2.data || [];
      } else {
        console.warn("fetchFollowingCompanies error:", error);
        _followingLastError = msg;
        followingCompanyIds = new Set();
        followingCompaniesData = [];
        _followingLoadedOnce = true;
        updateSavedBadges();
        return;
      }
    }

    const list = rows || [];
    followingCompanyIds = new Set(list.map(r => String(r.company_id)));

    // Keep home follow set in sync for Only followed filter
    try {
      if (!homeFollowSet) homeFollowSet = new Set();
      homeFollowSet = new Set([...followingCompanyIds].map(x => String(x)));
    } catch(e) {}

    followingCompaniesData = list.map(r => {
      const cid = String(r.company_id || "");
      const shortId = cid ? (cid.slice(0, 8) + "â€¦") : "â€”";
      const c = {
        id: cid,
        name: (r.company_name || "").trim() || shortId,
        logo_url: r.company_logo_url || "",
        business_type: r.business_type || "",
        company_type: r.business_type || "",
        city: "",
        country: "",
        is_verified: !!r.is_verified,
        verified: !!r.is_verified,
        verification_status: (!!r.is_verified) ? "approved" : ""
      };
      return { company: c, created_at: r.created_at || null };
    });


    // Best-effort enrich from profiles to ensure Verified tick + latest meta are correct
    // (some follows may have been inserted before snapshot fields were populated)
    try {
      const ids = Array.from(followingCompanyIds || []).slice(0, 400);
      if (ids.length) {
        let profs = null;
        let pe = null;
        // Try to pull last-active signals when available (falls back if columns don't exist)
        {
          const r1 = await supabaseClient
            .from("profiles")
            .select("id, company_name, logo_url, company_type, city, country, country_code, verification_status, last_active_at, updated_at")
            .in("id", ids);

          profs = r1.data; pe = r1.error;

          if (pe) {
            const r2 = await supabaseClient
              .from("profiles")
              .select("id, company_name, logo_url, company_type, city, country, country_code, verification_status, updated_at")
              .in("id", ids);
            profs = r2.data; pe = r2.error;
          }

          if (pe) {
            const r3 = await supabaseClient
              .from("profiles")
              .select("id, company_name, logo_url, company_type, city, country, country_code, verification_status")
              .in("id", ids);
            profs = r3.data; pe = r3.error;
          }
        }

        if (!pe && Array.isArray(profs) && profs.length) {
          const mp = new Map(profs.map(p => [String(p.id), p]));
          followingCompaniesData = (followingCompaniesData || []).map(item => {
            const cid = String(item?.company?.id || "");
            const p = mp.get(cid);
            if (!p) return item;

            const c = Object.assign({}, item.company || {});

            // Prefer fresh profile fields (safe fallbacks)
            if (p.company_name) c.name = p.company_name;
            if (p.logo_url) c.logo_url = p.logo_url;
            if (p.company_type) { c.business_type = p.company_type; c.company_type = p.company_type; }
            if (p.city) c.city = p.city;
            if (p.country) c.country = p.country;
            if (p.country_code) c.country_code = p.country_code;
            if (p.verification_status) c.verification_status = p.verification_status;

            const v = (typeof isCompanyVerified === "function") ? isCompanyVerified(Object.assign({}, c, p)) : !!c.is_verified;
            c.is_verified = v;
            c.verified = v;

            return Object.assign({}, item, { company: c });
          });
        }
      }
    } catch(e) {}

    _followingLoadedOnce = true;
    updateSavedBadges();
  } catch (e) {
    console.warn("fetchFollowingCompanies exception:", e);
    _followingLastError = String(e?.message || e || "");
  } finally {
    _followingLoading = false;
    try { updateSavedBadges(); } catch(e) {}
    if (savedPanelTab === "following") { try { renderFollowingCompanies(); } catch(e){} }
  }
}





function _resolveCompanyFromCaches(companyId) {
  const cid = String(companyId || "").trim();
  if (!cid) return null;

  let c = null;
  try {
    if (Array.isArray(savedCompaniesData)) {
      const hit = savedCompaniesData.find(x => x && x.company && String(x.company.id) === cid);
      if (hit && hit.company) c = hit.company;
    }
  } catch(e) {}

  try {
    if (!c && typeof selectedCompany !== "undefined" && selectedCompany && String(selectedCompany.id) === cid) c = selectedCompany;
  } catch(e) {}

  try {
    if (!c && Array.isArray(companiesData)) {
      const hit = companiesData.find(x => x && String(x.id) === cid);
      if (hit) c = hit;
    }
  } catch(e) {}

  try {
    if (!c && Array.isArray(database)) {
      const hit = database.find(x => x && String(x.id) === cid);
      if (hit) c = hit;
    }
  } catch(e) {}

  if (!c) return null;

  const name = (c.company_name || c.name || c.legal_name || "").trim();
  const logo = (c.logo_url || c.company_logo_url || c.avatar_url || c.logo || c.company_logo || "").trim();
  const type = (c.business_type || c.company_type || c.type_label || c.type || "").trim();
  const city = (c.city || "").trim();
  const country = (c.country || "").trim();
  const isV = !!(c.is_verified || c.verified || (String(c.verification_status || "").toLowerCase() === "approved") || (String(c.verification_status || "").toLowerCase() === "verified"));

  return { name, logo_url: logo, business_type: type, city, country, is_verified: isV };
}


function renderFollowingCompanies() {
  const listEl = document.getElementById("following-list");
  const emptyEl = document.getElementById("following-empty");
  if (!listEl || !emptyEl) return;

  // Loading state
  if (_followingLoading) {
    emptyEl.classList.add("hidden");
    listEl.classList.remove("hidden");
    listEl.innerHTML = `
      <div class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm animate-pulse">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-gray-200"></div>
          <div class="flex-1">
            <div class="h-3 w-40 bg-gray-200 rounded"></div>
            <div class="mt-2 h-3 w-56 bg-gray-100 rounded"></div>
          </div>
        </div>
      </div>
      <div class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm animate-pulse">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-gray-200"></div>
          <div class="flex-1">
            <div class="h-3 w-44 bg-gray-200 rounded"></div>
            <div class="mt-2 h-3 w-52 bg-gray-100 rounded"></div>
          </div>
        </div>
      </div>
      <div class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm animate-pulse">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-gray-200"></div>
          <div class="flex-1">
            <div class="h-3 w-36 bg-gray-200 rounded"></div>
            <div class="mt-2 h-3 w-60 bg-gray-100 rounded"></div>
          </div>
        </div>
      </div>
    `;
    return;
  }

  const q = (document.getElementById("saved-search")?.value || "").trim().toLowerCase();

  let list = Array.isArray(followingCompaniesData) ? followingCompaniesData.slice() : [];
  if (q) {
    list = list.filter(x => {
      const c = x.company || {};
      const hay = `${c.name || ""} ${(c.business_type || c.company_type || c.type || "")} ${c.city || ""} ${c.country || ""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  if (!list.length) {
    listEl.innerHTML = "";
    emptyEl.classList.remove("hidden");

    if (_followingLastError) {
      emptyEl.innerHTML = `
        <div class="font-black text-gray-800 mb-1">${(currentLang === "tr") ? "Following yÃ¼klenemedi" : "Could not load Following"}</div>
        <div class="text-[12px] text-gray-600 break-words">${escapeHtml(_followingLastError)}</div>
        <button class="mt-3 text-xs font-black px-3 py-1.5 rounded-full border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition"
          onclick="(async()=>{ await fetchFollowingCompanies(); if(savedPanelTab==='following') renderFollowingCompanies(); })()">
          <i class="fa-solid fa-rotate-right mr-1"></i> ${(currentLang === "tr") ? "Yenile" : "Retry"}
        </button>
      `;
    } else {
      const title = (currentLang === "tr")
        ? "HenÃ¼z takip ettiÄŸin ÅŸirket yok"
        : (currentLang === "es" ? "AÃºn no sigues empresas" : "No followed companies yet");
      const desc = (currentLang === "tr")
        ? "Åžirket kartlarÄ±nda veya profilde Takip ikonunu kullanarak firmalarÄ± takip edebilirsin."
        : (currentLang === "es" ? "Usa el icono Seguir en las tarjetas o en el perfil de la empresa." : "Use the Follow icon on company cards or profiles.");

      emptyEl.innerHTML = `
        <div class="bton-empty-card">
          <div class="bton-empty-ic"><i class="fa-solid fa-tower-broadcast"></i></div>
          <div class="min-w-0">
            <div class="bton-empty-title">${title}</div>
            <div class="bton-empty-desc">${desc}</div>
            <button class="bton-empty-action" type="button" onclick="try{ toggleSavedPanel(); }catch(e){} try{ document.getElementById('search-input')?.focus(); }catch(e){}">
              <i class="fa-solid fa-magnifying-glass"></i>
              <span>${(currentLang === "tr") ? "Åžirketleri keÅŸfet" : (currentLang === "es" ? "Explorar empresas" : "Browse companies")}</span>
            </button>
          </div>
        </div>
      `;
    }
    return;
  }

  emptyEl.classList.add("hidden");
  listEl.classList.remove("hidden");

  listEl.innerHTML = list.map(item => {
    const c = item.company || {};
const rc = _resolveCompanyFromCaches(c.id) || {};
const displayName = (c.name || "").trim() || (rc.name || "").trim() || "â€”";

const initials = (displayName || "C").trim().slice(0, 1).toUpperCase();
const logoUrl = (c.logo_url || rc.logo_url || "").trim();
const logo = logoUrl
  ? `<img src="${logoUrl}" alt="" class="w-10 h-10 rounded-xl object-cover border border-gray-200 bg-white" referrerpolicy="no-referrer" />`
  : `<div class="w-10 h-10 rounded-xl bg-cyan-50 border border-gray-200 grid place-items-center font-bold text-[12px] text-cyan-900">${initials}</div>`;

const metaTypeRaw = (c.business_type || c.company_type || c.type || c.type_label || "").toString().trim() || (rc.business_type || rc.company_type || rc.type || rc.type_label || "").toString().trim();
const metaType = (metaTypeRaw && metaTypeRaw.toLowerCase() !== "company") ? translateCompanyType(metaTypeRaw) : "â€”";

const metaCity = (c.city || "").trim() || (rc.city || "").trim();
const metaCountryRaw = ((c.country || "").trim() || (rc.country || "").trim());
const metaCountryCode = ((c.country_code || c.countryCode || rc.country_code || rc.countryCode || "").trim());
const metaCountry = metaCountryRaw ? translateCountryName(metaCountryRaw, metaCountryCode) : "";
const loc = [metaCity, metaCountry].filter(Boolean).join(", ");
    const locHtml = loc ? `<span class=\"text-gray-400\">â€¢</span><span class=\"truncate\">${escapeHtml(loc)}</span>` : "";

    const activeHtml = (typeof getActiveRecentlyMark === 'function') ? getActiveRecentlyMark(Object.assign({}, rc, c), { compact: true }) : '';
    const activeChunk = activeHtml ? (loc ? `<span class=\"text-gray-300\">â€¢</span>${activeHtml}` : `${activeHtml}`) : "";

    const ver = (typeof getVerifiedMark === "function")
      ? getVerifiedMark(Object.assign({}, rc, c))
      : ((c.is_verified) ? `<span class="bton-tip" data-tip="${escapeHtml(_verifiedTipText())}"><i class="fa-solid fa-circle-check text-cyan-500 text-[13px] ml-1 align-middle"></i></span>` : "");const missingBadge = c._missing
      ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-amber-50 border border-amber-200 text-amber-700 font-black">${_i18n("saved_unavailable", "Unavailable")}</span>`
      : "";

    return `
      <div class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm hover:shadow-md transition">
        <div class="flex items-start gap-3">
          <div class="shrink-0 cursor-pointer" onclick="openProfile('${c.id}', { reserveScroll: true, preserveTab: true }); toggleSavedPanel();">
            ${logo}
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold text-sm cursor-pointer hover:underline min-w-0 flex items-center gap-1"
                onclick="openProfile('${c.id}', { reserveScroll: true, preserveTab: true }); toggleSavedPanel();">
                <span class="truncate min-w-0" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</span>
                <span class="shrink-0 flex items-center gap-1">${ver}${missingBadge}${activeHtml ? `<span class=\"ml-1\">${activeHtml}</span>` : ""}</span>
              </div>
              <button class="text-xs font-black px-3 py-1.5 rounded-full border border-gray-200 hover:border-rose-300 hover:bg-rose-50 transition"
                onclick="toggleCompanyFollow(event, '${c.id}', '${escapeHtml((c.name||'') + '')}')"
                title="${_i18n("action_unfollow","Unfollow")}">
                <i class="fa-solid fa-tower-broadcast mr-1"></i> ${_i18n("action_unfollow","Unfollow")}
              </button>
            </div>
            <div class="mt-1 text-[10px] text-gray-500 flex flex-wrap items-center gap-2">
  <span class="px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200">${escapeHtml(metaType)}</span>
  ${locHtml}
  </div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}


function updateSaveButtonsUI() {
  // Profile header save icon
  try {
    const btn = document.getElementById("btn-save-company");
    const icon = document.getElementById("icon-save-company");
    if (!btn || !icon) return;

    // if no selected company, hide
    if (typeof selectedCompany === "undefined" || !selectedCompany || !selectedCompany.id) {
      btn.classList.add("hidden");
      return;
    }

    // hide for own company
    const myIdRaw = getMyCompanyId();
    const myId = (myIdRaw && isUuid(myIdRaw)) ? myIdRaw : null;
    if (myId && String(selectedCompany.id) === String(myId)) {
      btn.classList.add("hidden");
      return;
    }

    btn.classList.remove("hidden");
    const saved = isCompanySaved(selectedCompany.id);

    icon.classList.toggle("fa-solid", saved);
    icon.classList.toggle("fa-regular", !saved);

    // Tooltip title (localized)
    try {
      btn.setAttribute("title", saved
        ? (t("ui_saved_company") || (currentLang === "tr" ? "Kaydedildi" : "Saved company"))
        : (t("ui_save_company") || (currentLang === "tr" ? "Åžirketi kaydet" : "Save company"))
      );
    } catch(e) {}
  } catch(e) {}
}


function updateFollowButtonsUI() {
  try {
    // Update all follow buttons on company cards
    document.querySelectorAll(".company-follow-btn[data-company-id]").forEach(btn => {
      const cid = (btn.getAttribute("data-company-id") || "").trim();
      if (!cid) return;
      const on = (() => { try { return _isCompanyFollowed(cid); } catch(e){ return false; } })();
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      const icon = btn.querySelector("i");
      if (icon) icon.classList.toggle("opacity-40", !on);
      btn.setAttribute("title", on ? (t("updates_following") || "Following") : (t("updates_follow") || "Follow"));
    });
  } catch(e) {}

  try {
    // Profile header follow button (must be stable/always visible when applicable)
    const btn = document.getElementById("btn-follow-company");
    const icon = document.getElementById("icon-follow-company");
    if (!btn || !icon) return;

    if (typeof selectedCompany === "undefined" || !selectedCompany || !selectedCompany.id) {
      btn.classList.add("hidden");
      return;
    }

    // Hide on my own company profile
    const myIdRaw = (typeof getMyCompanyId === "function") ? getMyCompanyId() : null;
    const myId = (myIdRaw != null) ? String(myIdRaw) : null;
    if (myId && String(selectedCompany.id) === myId) {
      btn.classList.add("hidden");
      return;
    }

    // âœ… Always show (no â€œsometimes missingâ€)
    btn.classList.remove("hidden");
    try { btn.disabled = false; btn.removeAttribute("aria-busy"); } catch(e) {}

    // State (may be false until follow set loads)
    const on = (() => { try { return _isCompanyFollowed(String(selectedCompany.id)); } catch(e){ return false; } })();
    icon.classList.toggle("opacity-40", !on);
    btn.setAttribute("title", on ? (t("updates_following") || "Following") : (t("updates_follow") || "Follow"));

    // If auth/follow set not ready, resolve silently but don't hide UI
    if (!__authUserId && !window.__BTON_FOLLOW_UID_LOADING) {
      window.__BTON_FOLLOW_UID_LOADING = true;
      Promise.resolve()
        .then(() => _getAuthUserSafe())
        .then(u => {
          __authUserId = u?.id || null;
          if (__authUserId) return _ensureHomeFollowSet(__authUserId);
        })
        .catch(() => {})
        .finally(() => {
          window.__BTON_FOLLOW_UID_LOADING = false;
          try { updateFollowButtonsUI(); } catch(e) {}
        });
    }
  } catch(e) {}
}


 

// Tarih formatlayÄ±cÄ± (Ã–rn: "2 hours ago" yazar)
function timeAgo(dateString) {
  return _timeAgoI18n(dateString);
}

/* --- GÃœNCELLENMÄ°Åž: fetchInboxMessages (Kesin Filtreleme) --- */
async function fetchInboxMessages() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // 1. TÃ¼m mesajlarÄ± Ã§ek
    const { data: rawMessages, error } = await supabaseClient
        .from('messages')
        .select('*')
        .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Fetch Error:", error);
        return;
    }

    // 2. ðŸ‘‡ FÄ°LTRELEME: Silinenleri Kesin Olarak Gizle ðŸ‘‡
    const messages = rawMessages.filter(m => {
        // GÃ–NDEREN BEN Ä°SEM (Sent Kutusu):
        // sender_delete 'true' ise gizle.
        if (m.sender_id === user.id && m.sender_delete === true) return false;
        
        // ALICI BEN Ä°SEM (Inbox Kutusu):
        // receiver_delete 'true' ise gizle.
        if (m.receiver_id === user.id && m.receiver_delete === true) return false;

        return true; // DiÄŸer durumlarda gÃ¶ster
    });

        const groupedMap = new Map();
    const partnersToFetch = new Set(); // owner user ids

    // ðŸ‘‡ messages.forEach bloÄŸunu claim-aware hale getirdik ðŸ‘‡
    messages.forEach(msg => {
        const cleanSubject = msg.subject ? msg.subject.replace(/^(Re:\s*)+/i, '').trim() : (t("inbox_no_subject") || "No Subject");
        const isMeSender = (msg.sender_id === user.id);

        // PartnerId here is ALWAYS a user id (auth.users.id) for registered users
        const partnerId = isMeSender ? msg.receiver_id : (msg.sender_id || 'null');
        const groupKey = cleanSubject + "_" + partnerId;

        if (!groupedMap.has(groupKey)) {
            let displayCompany = (t("ui_loading") || ((getUILang()||"en").toLowerCase().startsWith("tr") ? "YÃ¼kleniyor..." : "Loading..."));
            let logoChar = "P";
            let partnerCompanyId = null;

            // Guest
            if (partnerId === 'null' || partnerId === 'undefined' || partnerId === null) {
                displayCompany = (t("inbox_guest_user") || "Guest User");
                logoChar = "G";
                if (msg.related_company_name) {
                    displayCompany = msg.related_company_name;
                    const nameMatch = displayCompany.match(/^(.*?)\s*\(/);
                    if(nameMatch) logoChar = nameMatch[1].charAt(0).toUpperCase();
                    else logoChar = displayCompany.charAt(0).toUpperCase();
                }
            } else {
                // âœ… Claim-aware: try cache first
                try {
                    const cached = __btonOwnerToCompanyCache && __btonOwnerToCompanyCache.get(String(partnerId));
                    if (cached && cached.company_name) {
                        displayCompany = cached.company_name;
                        logoChar = displayCompany.charAt(0).toUpperCase();
                        partnerCompanyId = cached.id || null;
                    } else {
                        partnersToFetch.add(String(partnerId));
                    }
                } catch(e) {
                    partnersToFetch.add(String(partnerId));
                }
            }

            groupedMap.set(groupKey, {
                id: msg.id,
                count: 1,
                partner_id: partnerId,
                partner_company_id: partnerCompanyId,
                company: displayCompany,
                title: cleanSubject,
                desc: isMeSender ? `You: ${msg.content}` : msg.content,
                time: timeAgo(msg.created_at),
                unread: !msg.is_read && !isMeSender,
                sent_unread: !msg.is_read && isMeSender,
                type: msg.msg_type,
                logo: logoChar,
                isSentByMe: isMeSender
            });
        } else {
            const existing = groupedMap.get(groupKey);
            existing.count += 1;
            if (!msg.is_read && !isMeSender) existing.unread = true;
            if (!msg.is_read && isMeSender) existing.sent_unread = true;
        }
    });
    // ðŸ‘† messages.forEach bloÄŸu burada bitiyor ðŸ‘†

    // âœ… Partner isimlerini owner_user_id Ã¼zerinden batch resolve et
    if (partnersToFetch.size > 0) {
        const owners = Array.from(partnersToFetch).filter(x => x && x !== 'null' && x !== 'undefined');

        if (owners.length > 0) {
            const { data: profs, error: pErr } = await supabaseClient
                .from('profiles')
                .select('id, company_name, owner_user_id, claimed_at')
                .in('owner_user_id', owners)
                .order('claimed_at', { ascending: false });

            const bestMap = new Map(); // owner_user_id -> best profile
            if (!pErr && Array.isArray(profs)) {
                profs.forEach(p => {
                    const key = String(p.owner_user_id || "");
                    if (!key) return;

                    const prev = bestMap.get(key);
                    const score = (row) => {
                        const nonStub = (String(row.id) !== String(row.owner_user_id)) ? 1000000 : 0;
                        const tms = row.claimed_at ? (new Date(row.claimed_at).getTime() || 0) : 0;
                        return nonStub + tms;
                    };

                    if (!prev || score(p) > score(prev)) {
                        bestMap.set(key, p);
                    }
                });
            }

            groupedMap.forEach((val) => {
                const pid = String(val.partner_id || "");
                if (!pid || pid === 'null' || pid === 'undefined') return;

                const best = bestMap.get(pid);
                if (best && best.company_name) {
                    val.company = best.company_name;
                    val.logo = best.company_name.charAt(0).toUpperCase();
                    val.partner_company_id = best.id || null;
                    try { __btonOwnerToCompanyCache.set(pid, best); } catch(e) {}
                } else {
                    // fallback: keep existing text, but ensure not showing raw id forever
                    if (!val.company || /^Company ID:/i.test(val.company) || val.company === "Loading..." || val.company === "YÃ¼kleniyor...") {
                        val.company = (t("ui_company") || "Company") + " â€¢ " + pid.substr(0,4) + "...";
                        val.logo = "C";
                    }
                }
            });
        }
    }

    inboxData = Array.from(groupedMap.values());
    try { __btonApplyManualUnreadToInbox(user.id); } catch(e) {}
    renderInboxItems();
}
/* --- YENÄ° YARDIMCI: AnlÄ±k Liste GÃ¼ncelleyici (Gecikmeyi Ã–nler) --- */
function manualInboxUpdate(partnerId, subject, content, isQuote = false) {
    // 1. Konu baÅŸlÄ±ÄŸÄ±nÄ± temizle
    const cleanSubject = subject.replace(/^(Re:\s*)+/i, '').trim();
    
    // 2. Partnerin (AlÄ±cÄ±nÄ±n) Ä°smini Bul
        let partnerName = (t("ui_loading") || "Loading...");
    try {
      const cached = __btonOwnerToCompanyCache && __btonOwnerToCompanyCache.get(String(partnerId));
      if (cached && cached.company_name) partnerName = cached.company_name;
    } catch(e) {}

    // If still not known, try modal header (target company name)
    if (!partnerName || partnerName === "Loading..." || partnerName === "YÃ¼kleniyor..." || partnerName === (t("ui_loading") || "Loading...")) {
      const msgHeaderName = document.getElementById("quote-target-company");
      if (msgHeaderName && msgHeaderName.textContent) partnerName = msgHeaderName.textContent.trim();
    }

    // Background resolve (claim-aware)
    try {
      if (partnerId && partnerId !== 'null' && partnerId !== 'undefined') {
        btonResolveCompanyByOwnerId(partnerId).then(res => {
          try {
            if (res && res.company_name) {
              __btonOwnerToCompanyCache.set(String(partnerId), res);
              // refresh the list silently
              try { fetchInboxMessages(); } catch(e) {}
            }
          } catch(e) {}
        }).catch(()=>{});
      }
    } catch(e) {}

    // 3. Listede bu konuÅŸma var mÄ±?
    const existingIndex = inboxData.findIndex(item => 
        String(item.partner_id) === String(partnerId) && item.title === cleanSubject
    );

    // 4. Yeni veri objesi
    const newItem = {
        id: nowTs(), // GeÃ§ici ID (Ekran iÃ§in yeterli)
        count: existingIndex > -1 ? inboxData[existingIndex].count + 1 : 1,
        partner_id: partnerId,
        company: partnerName,
        title: cleanSubject,
        desc: "You: " + content, // "You" ekledik ki Sent formatÄ±na uysun
        time: "Just now",
        unread: false,
        sent_unread: true,
        type: isQuote ? 'quote' : 'message',
        logo: partnerName.charAt(0).toUpperCase(),
        isSentByMe: true // Kilit nokta: SENT kutusunda gÃ¶rÃ¼nmesini saÄŸlar
    };

    // 5. Eski kaydÄ± listeden Ã§Ä±kar (Varsa)
    if (existingIndex > -1) {
        inboxData.splice(existingIndex, 1);
    }

    // 6. Yeni kaydÄ± EN BAÅžA ekle
    inboxData.unshift(newItem);

    // 7. Listeyi hemen boya (HiÃ§ beklemeden)
    renderInboxItems();
}
// Realtime Abonelik BaÅŸlat (Sayfa aÃ§Ä±lÄ±nca Ã§aÄŸÄ±rÄ±lmalÄ±)
// âœ… DÃœZELTÄ°LMÄ°Åž ABONELÄ°K (Kendi mesajÄ±na bildirim vermez)
/* --- GERÃ‡EK ZAMANLI DÄ°NLEME (REALTIME) --- */
// âœ… Mesajlar ve Teklifler iÃ§in DoÄŸru Real-time Dinleyicisi
// âœ… Mesajlar ve Teklifler (Ä°ngilizce + Mavi Logo Rengi)
// âœ… Mesajlar ve Teklifler (TÄ±klayÄ±nca Mesaja Gitme Ã–zellikli)
let messageChannel = null;
/* --- GÃœNCELLENMÄ°Åž: subscribeToMessages (CanlÄ± KÄ±rmÄ±zÄ± IÅŸÄ±k) --- */
function subscribeToMessages() {
  // âœ… Guard against rapid double-subscribe (can happen on INITIAL_SESSION + DOMContentLoaded)
  try {
    if (window.__BTON_MSG_SUB_LOCK) return;
    window.__BTON_MSG_SUB_LOCK = true;
    setTimeout(() => { try { window.__BTON_MSG_SUB_LOCK = false; } catch(e) {} }, 800);
  } catch(e) {}

  if (messageChannel) { supabaseClient.removeChannel(messageChannel); messageChannel = null; }

  messageChannel = supabaseClient
    .channel('public:messages')
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'messages' },
      async (payload) => {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        // Sadece mesaj BANA (receiver_id) geldiyse Ã§alÄ±ÅŸ
        if (!user || payload.new.receiver_id !== user.id) return;

        // 1. INBOX LÄ°STESÄ°NÄ° VE KIRMIZI ROZETÄ° YENÄ°LE
        await fetchInboxMessages(); 

                // 2. TOAST BÄ°LDÄ°RÄ°MÄ° GÃ–STER (Claim-aware company name)
        let companyName = "Unknown";
        try {
          if (payload.new.sender_id) {
            const resolved = await btonResolveCompanyByOwnerId(payload.new.sender_id);
            if (resolved && resolved.company_name) companyName = resolved.company_name;
          }
        } catch(e) {}

        if (!companyName || companyName === "Unknown") {
          const rawName = payload.new.related_company_name || "Unknown";
          const match = rawName.match(/\((.+)\)$/);
          companyName = match ? match[1] : rawName;
        }

        const isQuote = payload.new.msg_type === 'quote';
        const title = isQuote ? "New Quote Request" : "New Message";
        const body = `${companyName} sent you a request.`;

        // Inbox kapalÄ±ysa bildirim gÃ¶ster, tÄ±klayÄ±nca mesajÄ± aÃ§
        const panel = document.getElementById("inbox-panel");
        if (panel && !panel.classList.contains("open")) {
            showToast(title, body, "brand", () => openMessage(payload.new.id));
        }
      }
    )
    .subscribe();
}

// --- Notifications: fetch + realtime subscribe ---
// --- Notifications fetch + realtime subscribe ---
async function fetchNotificationsUnread() {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // âœ… Fetch full list so the Inbox can actually show notifications
    const { data, error } = await supabaseClient
      .from('notifications')
      .select('id,title,message,created_at,is_read,title_i18n_key,title_i18n_vars,message_i18n_key,message_i18n_vars')
      .eq('recipient_user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) {
      console.warn('Notifications fetch error:', error.message);
      return;
    }

    const rawList = Array.isArray(data) ? data : [];
    notificationsData = (typeof _applyNotifVisibility === "function") ? _applyNotifVisibility(rawList) : rawList;

    // Count unread (supports boolean / 0-1 / null)
    notificationsUnreadCount = notificationsData.filter(n => (n.is_read === false || n.is_read === 0 || n.is_read === null)).length;

    // Refresh badges + lists
    if (typeof renderInboxItems === "function") {
      renderInboxItems();
    } else if (typeof updateBadges === "function") {
      updateBadges((inboxUnreadCount||0) + (notificationsUnreadCount||0));
    }
  } catch (e) {
    console.warn('Notifications fetch exception:', e);
  }
}

function subscribeNotifications() {
  // âœ… Guard against concurrent double-subscribe (iOS can fire INITIAL_SESSION + DOMContentLoaded quickly)
  try {
    if (window.__BTON_NOTIF_SUB_LOCK) return;
    window.__BTON_NOTIF_SUB_LOCK = true;
    setTimeout(() => { try { window.__BTON_NOTIF_SUB_LOCK = false; } catch(e) {} }, 800);
  } catch(e) {}

  // Robust dedupe: one realtime channel per logged-in user
  supabaseClient.auth.getUser().then(({ data: { user } }) => {
    try {
      if (!user) {
        _notifSubscribed = false;
        // teardown (defer to avoid TDZ on early auth events)
        try { if (notifChannel) { supabaseClient.removeChannel(notifChannel); } } catch (e) {}
        notifChannel = null; notifUserId = null;
        return;
      }

      // Already subscribed for this user
      if (notifChannel && notifUserId === user.id) {
        _notifSubscribed = true;
        return;
      }

      // Remove any previous channel (different user or stale)
      try { if (notifChannel) supabaseClient.removeChannel(notifChannel); } catch (e) {}
      notifChannel = null;
      notifUserId = user.id;
      _notifSubscribed = true;

      const ch = supabaseClient
        .channel('realtime-notifications-' + user.id)
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'notifications',
            filter: `recipient_user_id=eq.${user.id}`,
          },
          (payload) => {
            const n = payload && payload.new ? payload.new : {};
            // If user previously deleted/cleared locally, don't re-add
            if (typeof _isNotifHidden === "function" && _isNotifHidden(n)) return;

            const isUnread = (n.is_read === false || n.is_read === 0 || n.is_read === null);
            if (isUnread) {
              notificationsUnreadCount += 1;
            }

            // Keep list in sync so Inbox isn't empty
            if (!Array.isArray(notificationsData)) notificationsData = [];
            notificationsData.unshift({
              id: n.id,
              title: n.title || (t("ui_notification") || "Notification"),
              message: n.message || "",
              title_i18n_key: n.title_i18n_key || null,
              title_i18n_vars: n.title_i18n_vars || null,
              message_i18n_key: n.message_i18n_key || null,
              message_i18n_vars: n.message_i18n_vars || null,
              created_at: n.created_at || nowDate().toISOString(),
              is_read: n.is_read
            });

            if (typeof renderInboxItems === "function") {
              renderInboxItems();
            } else if (typeof updateBadges === "function") {
              updateBadges((inboxUnreadCount||0) + (notificationsUnreadCount||0));
            }

            // Update bell dot if exists
            try {
              const dot = document.getElementById("inbox-dot");
              if (dot) {
                if ((messagesUnreadCount + notificationsUnreadCount) > 0) dot.classList.remove("hidden");
                else dot.classList.add("hidden");
              }
            } catch (e) {}
          }
        )
        .subscribe();

      notifChannel = btonSetChannel('notifications:' + user.id, ch);
    } catch (e) {
      console.warn("subscribeNotifications exception:", e);
      _notifSubscribed = false;
    }
  });
}



/* --- NOTIFICATION INBOX HELPERS --- */
async function markNotificationRead(notifId) {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user || !notifId) return;

    // Optimistic UI
    const idx = (notificationsData || []).findIndex(n => String(n.id) === String(notifId));
    if (idx > -1) {
      const wasUnread = (notificationsData[idx].is_read === false || notificationsData[idx].is_read === 0 || notificationsData[idx].is_read === null);
      notificationsData[idx].is_read = true;
      if (wasUnread && notificationsUnreadCount > 0) notificationsUnreadCount -= 1;
    }

    await supabaseClient
      .from('notifications')
      .update({ is_read: true })
      .eq('id', notifId)
      .eq('recipient_user_id', user.id);

    renderInboxItems();
  } catch (e) {
    console.warn("markNotificationRead error:", e);
  }
}

async function markAllNotificationsRead() {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error((t("auth_login_required") || "Login required"));

    const unreadExists = (notificationsData || []).some(n => (n.is_read === false || n.is_read === 0 || n.is_read === null));
    if (!unreadExists) {
      showToast("Up to date", (t("inbox_all_notifications_already_read") || "All notifications are already read."), "info");
      return;
    }

    const { error } = await supabaseClient
      .from("notifications")
      .update({ is_read: true })
      .eq("recipient_user_id", user.id)
      .or("is_read.eq.false,is_read.eq.0,is_read.is.null");

    if (error) throw error;

    (notificationsData || []).forEach(n => n.is_read = true);
    notificationsUnreadCount = 0;
    renderInboxItems();
    showToast("Success", (t("inbox_all_notifications_marked_read") || "All notifications marked as read."), "success");
  } catch (e) {
    console.error("Mark all notifications read error:", e);
    showToast("Error", (t("inbox_could_not_update_notifications") || "Could not update notifications."), "error");
  }
}


/* --- NOTIFICATION VISIBILITY (DB DELETE + LOCAL FALLBACK) --- */
const _notifDismissKey = "bton_notif_dismissed_ids";
const _notifClearedAtKey = "bton_notif_cleared_at";

function _getNotifDismissedIds() {
  try { return JSON.parse(localStorage.getItem(_notifDismissKey) || "[]"); }
  catch { return []; }
}
function _setNotifDismissedIds(arr) {
  try { localStorage.setItem(_notifDismissKey, JSON.stringify(Array.isArray(arr) ? arr : [])); } catch {}
}
function _getNotifClearedAt() {
  const v = localStorage.getItem(_notifClearedAtKey);
  if (!v) return null;
  const t = Date.parse(v);
  if (!t || Number.isNaN(t)) return null;

  // SAFETY: If a future "cleared_at" was stored while Time Travel was active,
  // it can unintentionally hide all DB notifications (created_at is server time).
  // Clamp overly-future values to real now.
  try {
    const realNow = __REAL_DATE_NOW__();
    if (t > realNow + (48 * 60 * 60 * 1000)) return realNow;
  } catch (e) {}
  return t;
}
function _setNotifClearedAt(isoOrNull) {
  try {
    if (!isoOrNull) localStorage.removeItem(_notifClearedAtKey);
    else localStorage.setItem(_notifClearedAtKey, isoOrNull);
  } catch {}
}
function _isNotifHidden(n) {
  const ids = _getNotifDismissedIds();
  if (n && n.id != null && ids.includes(String(n.id))) return true;

  const clearedAt = _getNotifClearedAt();
  if (clearedAt) {
    const t = n && n.created_at ? Date.parse(n.created_at) : null;
    if (t && t <= clearedAt) return true;
  }
  return false;
}
function _applyNotifVisibility(list) {
  const arr = Array.isArray(list) ? list : [];
  return arr.filter(n => !_isNotifHidden(n));
}
function _dismissNotifIdLocal(id) {
  const ids = _getNotifDismissedIds();
  const s = String(id);
  if (!ids.includes(s)) {
    ids.unshift(s);
    _setNotifDismissedIds(ids.slice(0, 500)); // cap
  }
}

/* --- Single notification delete (with fallback) --- */
function deleteNotification(notifId) {
  openDeleteModal((t("inbox_confirm_delete_notification") || "Delete this notification?"), async () => {
    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) throw new Error((t("auth_login_required") || "Login required"));

      // Optimistic UI remove
      const before = Array.isArray(notificationsData) ? notificationsData : [];
      const target = before.find(n => String(n.id) === String(notifId));
      const wasUnread = target ? (target.is_read === false || target.is_read === 0 || target.is_read === null) : false;

      notificationsData = before.filter(n => String(n.id) !== String(notifId));
      if (wasUnread && notificationsUnreadCount > 0) notificationsUnreadCount -= 1;
      renderInboxItems();

      // Try DB delete (may be blocked by RLS and return 0 rows without error)
      const { data: deletedRows, error } = await supabaseClient
        .from("notifications")
        .delete()
        .eq("id", notifId)
        .eq("recipient_user_id", user.id)
        .select("id");

      if (error) throw error;

      if (!deletedRows || deletedRows.length === 0) {
        // Fallback: hide locally so refresh won't bring it back
        _dismissNotifIdLocal(notifId);
      }

      showToast("Deleted", (t("inbox_notification_removed") || "Notification removed."), "success");
    } catch (e) {
      console.error("Delete notification error:", e);
      showToast("Error", (t("inbox_failed_delete_notification") || "Failed to delete notification."), "error");
      // In case of error, re-fetch to recover UI
      try { await fetchNotificationsUnread(); } catch {}
    }
  });
}


function deleteAllNotifications() {
  openDeleteModal((t("inbox_confirm_delete_all_notifications") || "Delete all notifications?"), async () => {
    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) throw new Error((t("auth_login_required") || "Login required"));

      // Try DB delete first (may be blocked by RLS and return 0 rows without error)
      const { data: deletedRows, error } = await supabaseClient
        .from("notifications")
        .delete()
        .eq("recipient_user_id", user.id)
        .select("id");

      if (error) throw error;

      if (!deletedRows || deletedRows.length === 0) {
        // Fallback: keep it "deleted" on this device by hiding everything up to now
        _setNotifClearedAt(new Date(__REAL_DATE_NOW__()).toISOString());
        _setNotifDismissedIds([]);
      } else {
        // DB delete worked â†’ clear local hide state
        _setNotifClearedAt(null);
        _setNotifDismissedIds([]);
      }

      notificationsData = [];
      notificationsUnreadCount = 0;
      renderInboxItems();
      showToast("Cleared", (t("inbox_all_notifications_removed") || "All notifications removed."), "success");
    } catch (e) {
      console.error("Delete notifications error:", e);
      showToast("Error", (t("inbox_failed_delete_notifications") || "Failed to delete notifications."), "error");
    }
  });
}


function toggleInbox() {
  const panel = document.getElementById("inbox-panel");
  const overlay = document.getElementById("inbox-overlay");
  
  if (!panel || !overlay) return;

  const isOpen = panel.classList.contains("open");

  if (isOpen) {
    // Kapat
    panel.classList.remove("open");
    overlay.classList.remove("opacity-100");
    overlay.classList.add("opacity-0");
    setTimeout(() => overlay.classList.add("hidden"), 300);
  } else {
    // AÃ§
    renderInboxItems(); // Verileri tazeleyerek aÃ§
    overlay.classList.remove("hidden");
    // Animasyon iÃ§in minik gecikme
    setTimeout(() => {
        overlay.classList.remove("opacity-0");
        overlay.classList.add("opacity-100");
        panel.classList.add("open");
    }, 10);
  }
}
/* --- GÃœNCELLENMÄ°Åž: renderInboxItems (RENKLÄ° LEAD DESTEKLÄ°) --- */
function renderInboxItems() {
  const container = document.getElementById("inbox-content");
  const badgeNav = document.getElementById("nav-badge");
  const badgeHeader = document.getElementById("inbox-badge-count");
  
  if (!container) return;
  container.innerHTML = "";

  // 1. OKUNMAMIÅž SAYILARI (INBOX / SENT / NOTIFICATIONS)
  inboxUnreadCount = 0;
  sentUnreadCount = 0;

  (inboxData || []).forEach(item => {
    if (!item) return;

    // Gelen (kendi okunmamÄ±ÅŸlarÄ±n): son mesaj kimden gelmiÅŸ olursa olsun "unread" true ise Inbox sayacÄ±na girsin
    if (item.unread) inboxUnreadCount++;

    // GÃ¶nderilen (karÅŸÄ± taraf okumadÄ±): sadece sent sekmesiyle uyumlu olsun diye "isSentByMe" olan konuÅŸmalarda say
    if (item.isSentByMe && item.sent_unread) sentUnreadCount++;
  });

  messagesUnreadCount = inboxUnreadCount + sentUnreadCount;
  const totalUnreadAll = messagesUnreadCount + notificationsUnreadCount;
  const totalUnreadNav = inboxUnreadCount + notificationsUnreadCount;

  // 1.5 NOTIFICATIONS VIEW
  if (currentInboxView === 'notifications') {
    const list = Array.isArray(notificationsData) ? notificationsData : [];

    if (list.length === 0) {
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fa-solid fa-bell text-4xl mb-3 opacity-20"></i>
            <p class="text-xs">${t("ui_no_notifications_2ef213") || "No notifications."}</p>
        </div>`;
      updateBadges((inboxUnreadCount||0) + (notificationsUnreadCount||0));
      return;
    }

    list.forEach(n => {
      const isUnread = (n.is_read === false || n.is_read === 0 || n.is_read === null);

      const titleRaw = (n.title || (t("ui_notification") || "Notification"));
      const msgRaw = (n.message || "");

      const action = _extractNotifAction(msgRaw);

      // âœ… DB-backed i18n support (title_i18n_key/message_i18n_key + vars)
      const titleVars = (typeof _normNotifVars === "function") ? _normNotifVars(n.title_i18n_vars) : (n.title_i18n_vars || {});
      const msgVars   = (typeof _normNotifVars === "function") ? _normNotifVars(n.message_i18n_vars) : (n.message_i18n_vars || {});

      const parsedMsg = (!n.message_i18n_key) ? _parseNotifI18n(msgRaw) : null;
      const parsedTitle = (!n.title_i18n_key) ? _parseNotifI18n(titleRaw) : null;

      let titleResolved = titleRaw;
      try {
        if (n.title_i18n_key) {
          const out = tP(n.title_i18n_key, titleVars);
          if (out) titleResolved = out;
        } else if (parsedTitle && parsedTitle.key) {
          const out = tP(parsedTitle.key, parsedTitle.params);
          if (out) titleResolved = out;
        }
      } catch(e) {}
      const title = String(titleResolved || (t("ui_notification") || "Notification")).replace(/</g, "&lt;").replace(/>/g, "&gt;");

      let msgResolved = "";
      let notifParams = {};
      try {
        if (n.message_i18n_key) {
          notifParams = (msgVars && typeof msgVars === "object") ? msgVars : {};
          msgResolved = tP(n.message_i18n_key, notifParams) || (n.message || "");
        } else {
          notifParams = (parsedMsg && parsedMsg.params) ? parsedMsg.params : {};
          msgResolved = (parsedMsg && parsedMsg.key)
            ? (tP(parsedMsg.key, parsedMsg.params) || _stripNotifMarkers(msgRaw))
            : _stripNotifMarkers(msgRaw);
        }
      } catch(e) {
        msgResolved = _stripNotifMarkers(msgRaw);
        notifParams = {};
      }
      const msg = String(msgResolved || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      let __whenBase = n.created_at || n.updated_at || null;
      try {
        const ev = (notifParams.event_at || notifParams.eventAt || notifParams.event_time || notifParams.eventTime || "");
        if (ev) {
          const dt = new Date(ev);
          if (!isNaN(dt.getTime())) __whenBase = dt.toISOString();
        }
      } catch(e) {}
      const when = __whenBase ? timeAgo(__whenBase) : "";
      const nidSafe = String(n.id).replace(/'/g, "\'");


      const card = document.createElement("div");
      card.className = `relative p-4 mb-2 rounded-xl border ${isUnread ? "bg-white shadow-sm border-rose-100" : "bg-white/60 border-transparent opacity-90"} hover:border-gray-200 transition-all duration-200 cursor-pointer group`;
      card.onclick = () => {
        if (isUnread) markNotificationRead(n.id);
        if (action === 'UPGRADE') { try { openUpgradeModal(); } catch(e) {} }
        if (action === 'OPEN_PROFILE') {
          try {
            const cid = notifParams.company_id || notifParams.companyId || notifParams.cid || notifParams.profile_id || notifParams.profileId;
            if (cid && typeof openProfile === "function") openProfile(cid);
          } catch(e) {}
        }
        if (action === 'OPEN_HOME_FOLLOWED') {
          try {
            if (typeof showMainView === "function") showMainView();
            if (typeof setHomeUpdatesFilter === "function") setHomeUpdatesFilter('followed');
            setTimeout(() => {
              try {
                const el = document.getElementById("home-updates-head") || document.getElementById("home-updates");
                if (el && el.scrollIntoView) el.scrollIntoView({ behavior: "smooth", block: "start" });
              } catch(e) {}
            }, 80);
          } catch(e) {}
        }
        if (action === 'OPEN_ANALYTICS') {
          try { if (typeof openProfile === "function" && __authUserId) openProfile(__authUserId, { tab:"overview", focus:"profile-analytics" }); } catch(e) {}
        }
      };

      card.innerHTML = `
        <button type="button" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/80 border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-200 shadow-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition" title="${t("ui_delete") || "Delete"}" onclick="event.stopPropagation(); deleteNotification('${nidSafe}')">
          <i class="fa-solid fa-trash text-[11px]"></i>
        </button>
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-2xl bg-rose-50 border border-rose-100 grid place-items-center shrink-0 text-rose-600">
            <i class="fa-solid fa-bell"></i>
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-extrabold text-gray-800 leading-tight break-words">${title}</div>
                <div class="text-[11px] text-gray-400 mt-0.5">${when}</div>
              </div>
              ${isUnread ? `<span class="mt-1 inline-flex items-center gap-1 text-[10px] font-extrabold text-rose-600 bg-rose-50 border border-rose-100 px-2 py-1 rounded-full">${t("label_new")}</span>` : ``}
            </div>
            <div class="text-[12px] text-gray-600 mt-2 leading-relaxed whitespace-pre-wrap break-words">${msg}</div>
          </div>
        </div>
      `;

      container.appendChild(card);
    });

    updateBadges((inboxUnreadCount||0) + (notificationsUnreadCount||0));
    return;
  }


  // 2. FÄ°LTRELEME
  const filteredData = inboxData.filter(item => {
      if (currentInboxView === 'inbox') {
          // Inbox: Ya gerÃ§ekten gelen mesaj (isSentByMe === false) ya da kullanÄ±cÄ± manuel olarak okunmadÄ± yaptÄ± (unread === true)
          return (item.isSentByMe === false) || (item.unread === true);
      } else {
          // Sent: son mesaj benden geldiyse gÃ¶ster; ama kullanÄ±cÄ± manuel okunmadÄ± yaptÄ±ysa Inbox'ta gÃ¶rÃ¼nsÃ¼n (Ã§ift gÃ¶rÃ¼nmesin)
          return (item.isSentByMe === true) && (item.unread !== true);
      }
  });

  // BoÅŸ durum mesajÄ±
  if (filteredData.length === 0) {
      const msg = currentInboxView === 'inbox' ? (t("ui_no_received_messages_9d2a12") || "No received messages.") : (t("ui_no_sent_messages_83b1fd") || "No sent messages.");
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fa-solid ${currentInboxView === 'inbox' ? 'fa-inbox' : 'fa-paper-plane'} text-4xl mb-3 opacity-20"></i>
            <p class="text-xs">${msg}</p>
        </div>`;
      
      updateBadges(totalUnreadNav);
      return;
  }

  // KartlarÄ± OluÅŸtur
  filteredData.forEach(item => {
    const safeTitle = item.title.replace(/'/g, "\\'");
    const directionLabel = currentInboxView === 'sent' ? 'To:' : 'From:';
    const previewText = item.desc.replace(/^You:\s*/, '');

    // --- RENK VE STÄ°L AYARI ---
    // 'G' logosu veya 'null' ID, bunun bir Misafir/Lead olduÄŸunu gÃ¶sterir.
    const isLead = (item.logo === 'G') || (item.partner_id === 'null') || (item.partner_id === null);

    let cardClasses = "";
    let iconBg = "";
    let iconName = "";

    if (isLead) {
        // --- LEAD (TURUNCU/AMBER) TASARIMI ---
        // OkunmamÄ±ÅŸsa daha koyu, okunmuÅŸsa ÅŸeffaf turuncu
        const bg = item.unread ? "bg-amber-50 border-l-4 border-l-amber-500 shadow-sm" : "bg-amber-50/50 border-l-4 border-l-transparent opacity-90";
        cardClasses = `inbox-item relative p-4 mb-2 rounded-xl border-y border-r border-amber-100 ${bg} hover:border-amber-300 transition-all duration-200 cursor-pointer group`;
        
        iconBg = "bg-amber-100 text-amber-600";
        iconName = "fa-user-clock"; // Lead iÃ§in Ã¶zel ikon
    } 
    else {
        // --- STANDART (BEYAZ/GRÄ°) TASARIMI ---
        const bg = item.unread ? "bg-white unread shadow-sm" : "bg-white/60 opacity-90";
        cardClasses = `inbox-item relative p-4 mb-2 rounded-xl border border-transparent hover:border-gray-200 ${bg} transition-all duration-200 cursor-pointer group`;
        
        iconBg = "bg-gray-100 text-gray-500";
        iconName = "fa-building";
        
        // EÄŸer Teklif ise (Lead deÄŸil ama kayÄ±tlÄ± Ã¼yeden teklif)
        if(item.type === 'quote') { 
            iconBg = "bg-cyan-50 text-BTrustOn-accent"; 
            iconName = "fa-file-invoice-dollar"; 
        }
    }

    const countBadge = item.count > 1 
        ? `<span class="ml-2 bg-gray-100 text-gray-500 text-[9px] font-bold px-1.5 py-0.5 rounded-full">+${item.count - 1}</span>` 
        : '';

    const card = document.createElement("div");
    card.className = cardClasses;
    card.onclick = () => openMessage(item.id); 

    card.innerHTML = `
      <button 
          onclick="deleteThread(${item.id}, '${safeTitle}', '${item.partner_id}', event)" 
          class="absolute top-2 right-2 w-7 h-7 rounded-lg bg-white/80 text-gray-300 hover:text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 shadow-sm"
          title="Delete Thread"
      >
          <i class="fa-solid fa-trash-can text-[10px]"></i>
      </button>

      <div class="flex gap-3 pointer-events-none"> 
        <div class="w-10 h-10 rounded-xl ${iconBg} grid place-items-center shrink-0 shadow-sm relative mt-1">
           <i class="fa-solid ${iconName}"></i>
           ${item.unread ? '<span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full"></span>' : ''}
        </div>

        <div class="flex-1 min-w-0">
           
           <div class="flex justify-between items-start mb-1 pr-6"> 
              <div class="flex items-center min-w-0">
                  <h4 class="text-xs font-bold text-gray-800 leading-tight truncate pr-1">${item.title}</h4>
                  ${countBadge}
              </div>
              <span class="text-[9px] text-gray-400 whitespace-nowrap ml-2 shrink-0">${item.time}</span>
           </div>

           <div class="flex items-center gap-1.5 mb-1.5">
              <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wide">${directionLabel}</span>
              <span class="text-xs font-bold ${isLead ? 'text-amber-600' : 'text-BTrustOn-accent'} truncate">
                 ${item.company} 
              </span>
           </div>
           
           <p class="text-[10px] text-gray-500 leading-relaxed line-clamp-1 italic border-l-2 ${isLead ? 'border-amber-200' : 'border-gray-200'} pl-2">
             "${previewText}"
           </p>
           
        </div>
      </div>
    `;
    container.appendChild(card);
  });

  updateBadges(totalUnreadNav);
}
// YardÄ±mcÄ± Badge Fonksiyonu (EÄŸer yoksa bunu da ekle, varsa gerek yok)
let __btonLastNavBadgeCount = 0;
function __btonPopBadge(el){
  if(!el) return;
  try{
    el.classList.remove('bton-pop');
    void el.offsetWidth; // reflow to restart animation
    el.classList.add('bton-pop');
    setTimeout(() => { try { el.classList.remove('bton-pop'); } catch(e){} }, 260);
  } catch(e){}
}
function updateBadges(count) {
  const prev = (typeof __btonLastNavBadgeCount === 'number') ? __btonLastNavBadgeCount : 0;
  const next = Number(count || 0);
  const shouldPop = (next > prev);
  __btonLastNavBadgeCount = next;
  const badgeNav = document.getElementById("nav-badge");
  const badgeHeader = document.getElementById("inbox-badge-count");
  const mobileNavBadge = document.getElementById("mobile-nav-badge");
  const mobileInboxBadge = document.getElementById("mobile-inbox-badge");

  if(badgeNav) {
      if(count > 0) {
          badgeNav.textContent = count;
          badgeNav.classList.remove("hidden");
                if(shouldPop) __btonPopBadge(badgeNav);
} else {
          badgeNav.classList.add("hidden");
      }
  }
  if(mobileNavBadge) {
      if(count > 0) {
          mobileNavBadge.textContent = count;
          mobileNavBadge.classList.remove("hidden");
                if(shouldPop) __btonPopBadge(mobileNavBadge);
} else {
          mobileNavBadge.classList.add("hidden");
      }
  }
  if(mobileInboxBadge) {
      if(count > 0) {
          mobileInboxBadge.textContent = String(count);
          mobileInboxBadge.classList.remove("hidden");
      } else {
          mobileInboxBadge.classList.add("hidden");
      }
  }

  if(badgeHeader) {
      if(count > 0) {
        badgeHeader.textContent = `${count} ${t("label_new")}`;
        badgeHeader.classList.remove("hidden");
      } else {
        badgeHeader.classList.add("hidden");
      }
  }

  // Inbox/Sent tab badges (messages)
  const inboxTabBadge = document.getElementById("inbox-tab-badge");
  if (inboxTabBadge) {
      if (inboxUnreadCount > 0) {
          inboxTabBadge.textContent = String(inboxUnreadCount);
          inboxTabBadge.classList.remove("hidden");
      } else {
          inboxTabBadge.classList.add("hidden");
      }
  }

  const sentTabBadge = document.getElementById("sent-tab-badge");
  if (sentTabBadge) {
      if (sentUnreadCount > 0) {
          sentTabBadge.textContent = String(sentUnreadCount);
          sentTabBadge.classList.remove("hidden");
      } else {
          sentTabBadge.classList.add("hidden");
      }
  }


  // Notifications tab badge (shows only notifications unread)
  const notifTabBadge = document.getElementById("notif-tab-badge");
  if (notifTabBadge) {
      if (notificationsUnreadCount > 0) {
          notifTabBadge.textContent = String(notificationsUnreadCount);
          notifTabBadge.classList.remove("hidden");
      } else {
          notifTabBadge.classList.add("hidden");
      }
  }

}
// Sayfa aÃ§Ä±lÄ±nca badge'i kontrol et
document.addEventListener("DOMContentLoaded", () => {
    // Hafif bir gecikmeyle Ã§alÄ±ÅŸtÄ±r ki diÄŸer yÃ¼klemeler bitsin
    setTimeout(renderInboxItems, 800);
});
/* --- MESSAGE READER LOGIC (YENÄ° EKLENECEK KISIM) --- */


/* --- GERÃ‡EK MESAJLAÅžMA SÄ°STEMÄ° (Supabase Entegreli) --- */

let currentMessageContext = null; // Hangi mesajÄ± cevaplÄ±yoruz?

// 1. MESAJI AÃ‡MA FONKSÄ°YONU
/* --- GÃœNCELLENMÄ°Åž SOHBET AÃ‡MA (TIKLANABÄ°LÄ°R BAÅžLIK) --- */
let currentPartnerId = null; // Global deÄŸiÅŸken
let currentPartnerCompanyId = null; // Resolved company profile id for partner (claim-aware)
let currentSubject = null;
let currentOpenMessageId = null;
/* --- GÃœNCELLENMÄ°Åž: openMessage (BaÅŸlÄ±k Ä°sim Garantili) --- */
async function openMessage(itemId) {
    const item = inboxData.find(m => m.id === itemId);
    if (!item) return;

    currentPartnerId = item.partner_id;
    currentPartnerCompanyId = null;
    currentSubject = item.title;
    currentOpenMessageId = itemId;

// Clear any manual-unread flag when user opens the conversation
try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (user) __btonClearManualUnreadForThread(user.id, currentPartnerId, currentSubject);
} catch(e) {}

    // --- KRÄ°TÄ°K DÃœZELTME: BAÅžLIK Ä°SMÄ°NÄ° CANLI VERÄ°DEN AL ---
    // Inbox listesindeki isme gÃ¼venmek yerine, veritabanÄ± (database) hafÄ±zasÄ±ndaki 
    // gÃ¼ncel ÅŸirket kartÄ±nÄ± bulup ismini oradan Ã§ekiyoruz.
    let fixedHeaderName = item.company; // VarsayÄ±lan

    // âœ… Claim-aware: partnerId is a USER id. Resolve their active company profile (prefer claimed company)
    try {
        if (currentPartnerId && currentPartnerId !== 'null' && currentPartnerId !== 'undefined') {
            const resolved = await btonResolveCompanyByOwnerId(currentPartnerId);
            if (resolved && resolved.company_name) {
                fixedHeaderName = resolved.company_name;
                currentPartnerCompanyId = resolved.id || null;
            }
        }
    } catch(e) {}

    // -------------------------------------------------------

    // Okundu Yapma Ä°ÅŸlemleri
    if (item.unread) {
        item.unread = false;
        renderInboxItems(); // Soldaki listeyi gÃ¼ncelle
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        if(user) {
            supabaseClient.from('messages').update({ is_read: true })
                .eq('receiver_id', user.id).eq('sender_id', currentPartnerId)
                .ilike('subject', `%${item.title}%`).then(()=>{});
        }
    }

    // 1. KONU BAÅžLIÄžI
    document.getElementById("msg-subject").textContent = item.title;

    // 2. ÅžÄ°RKET Ä°SMÄ° (SabitlenmiÅŸ Ä°sim KullanÄ±lÄ±yor)
    // 2. ÅžÄ°RKET Ä°SMÄ° (Misafir KontrolÃ¼ EklenmiÅŸ Hali)
    let companyHeaderHtml = "";
    
    // EÄŸer partnerId 'null' ise veya tanÄ±msÄ±zsa (Yani Misafir ise)
    if (!currentPartnerId || currentPartnerId === 'null' || currentPartnerId === 'undefined') {
        // MÄ°SAFÄ°R Ä°SE: TÄ±klanamayan dÃ¼z yazÄ± ve 'Guest User' etiketi
        companyHeaderHtml = `
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 font-normal uppercase tracking-wider">${_i18n("inbox_guest_user","Guest User")}</span>
                <span class="text-left font-bold text-gray-800 text-sm flex items-center gap-1.5 cursor-default">
                    <i class="fa-solid fa-user-clock text-amber-500"></i>
                    ${fixedHeaderName} 
                </span>
            </div>
        `;
    } else {
        // KAYITLI ÅžÄ°RKET Ä°SE: TÄ±klanabilir Profil Linki (Eski hali)
        companyHeaderHtml = `
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 font-normal uppercase tracking-wider">${_i18n("inbox_conversation_with", (currentLang==="tr" ? "Sohbet" : "Conversation with"))}</span>
                <button onclick="openProfile('${currentPartnerCompanyId || currentPartnerId}')" 
                        class="text-left font-bold text-BTrustOn-accent hover:text-blue-700 hover:underline transition text-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-building-user"></i>
                    ${fixedHeaderName} 
                </button>
            </div>
        `;
    }

    // HTML'i sayfaya bas
    document.getElementById("msg-company").innerHTML = companyHeaderHtml;

    // 3. LOGO (SabitlenmiÅŸ Ä°smin BaÅŸ Harfi)
    const logoEl = document.getElementById("msg-logo");
    if(logoEl) {
        logoEl.textContent = fixedHeaderName.charAt(0).toUpperCase();
        logoEl.className = "w-10 h-10 rounded-lg bg-BTrustOn-accent text-white grid place-items-center text-lg font-bold shrink-0 shadow-md border-0";
    }

    // EkranÄ± AÃ§
    const viewer = document.getElementById("view-message");
    if(viewer) viewer.classList.remove("hidden-view");
    __lockScrollForModal();
    toggleInbox(); 
    
    // Sohbeti YÃ¼kle
    await loadMessageThread(item.title, currentPartnerId);
// Cevap yazma kutusunu (input area) seÃ§
    const replyInputArea = document.querySelector("#view-message .border-t"); 
    
    // EÄŸer partner ID yoksa veya 'null'/'undefined' stringi ise bu bir misafirdir
    if (!currentPartnerId || currentPartnerId === 'null' || currentPartnerId === 'undefined') {
        
        // 1. Input alanÄ±nÄ± GÄ°ZLE
        if(replyInputArea) replyInputArea.classList.add("hidden");

        // 2. UyarÄ± mesajÄ± GÃ–STER (Daha Ã¶nce eklenmediyse ekle)
        const warningBanner = document.getElementById("guest-reply-warning");
        if (!warningBanner) {
            const warning = document.createElement("div");
            warning.id = "guest-reply-warning";
            warning.className = "p-4 bg-amber-50 border-t border-amber-100 text-center animate-fade-in";
            warning.innerHTML = `
                <div class="flex flex-col items-center gap-2">
                    <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 grid place-items-center">
                        <i class="fa-solid fa-user-clock text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-amber-800 uppercase tracking-wide">${(t("inbox_guest_user") || t("guest_user_title") || "Guest User")}</p>
                        <p class="text-[11px] text-amber-700 mt-0.5">
                            ${(t("guest_unregistered_cant_reply") || (currentLang === "tr" ? "Bu talep kayÄ±tlÄ± olmayan bir misafir kullanÄ±cÄ±dan geldi. Sohbet Ã¼zerinden yanÄ±t veremezsiniz." : "This request is from an unregistered guest. You cannot reply via chat."))}
                            <br>${(t("guest_reply_via_email") || (currentLang === "tr" ? "LÃ¼tfen yukarÄ±daki iletiÅŸim bilgilerini kullanarak e-posta ile yanÄ±t verin." : "Please reply via email using the contact details above."))}
                        </p>
                    </div>
                </div>
            `;
            // Mesaj ekranÄ±nÄ±n en altÄ±na (inputun olduÄŸu yere) ekle
            document.getElementById("view-message").appendChild(warning);
        } else {
            // Zaten varsa gÃ¶rÃ¼nÃ¼r yap
            warningBanner.classList.remove("hidden");
        }

    } else {
        // --- NORMAL KULLANICI Ä°SE ---
        
        // Inputu GÃ–STER
        if(replyInputArea) replyInputArea.classList.remove("hidden");
        
        // UyarÄ±yÄ± GÄ°ZLE
        const warningBanner = document.getElementById("guest-reply-warning");
        if (warningBanner) warningBanner.classList.add("hidden");
    }
}
/* --- GÃœNCELLENMÄ°Åž: loadMessageThread (MÄ°SAFÄ°R HATASI GÄ°DERÄ°LMÄ°Åž) --- */
async function loadMessageThread(cleanSubject, partnerId) {
    const container = document.getElementById("message-thread-container");
    container.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-spinner fa-spin text-BTrustOn-accent"></i></div>';

    const { data: { user } } = await supabaseClient.auth.getUser();
    if(!user) return;

    let fixedPartnerName = (t("inbox_partner") || "Partner");
    
    // Partner ismini bulmaya Ã§alÄ±ÅŸ (Misafir ise 'Guest User' kalÄ±r veya related_company_name'den gelir)
    if (partnerId && partnerId !== 'null') {
        // Try resolve partner's active company name (claim-aware)
        const resolved = await btonResolveCompanyByOwnerId(partnerId);
        if (resolved && resolved.company_name) fixedPartnerName = resolved.company_name;
    }

    // --- SORGULAMA MANTIÄžI DEÄžÄ°ÅžTÄ° ---
    let query = supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true });

    // EÄŸer Partner ID 'null' ise (MÄ°SAFÄ°R SENARYOSU)
    if (!partnerId || partnerId === 'null' || partnerId === 'undefined') {
        // "GÃ¶nderen BOÅž (null) VE AlÄ±cÄ± BEN olan mesajlarÄ± getir"
        query = query
            .is('sender_id', null)       // Sender ID NULL olmalÄ±
            .eq('receiver_id', user.id)  // AlÄ±cÄ± BEN olmalÄ±yÄ±m
            .ilike('subject', `%${cleanSubject}%`); // Konu baÅŸlÄ±ÄŸÄ± uymalÄ±
    } 
    else {
        // NORMAL KULLANICI SENARYOSU (Eski MantÄ±k)
        // "Benim gÃ¶nderdiÄŸim VEYA bana gelen mesajlarÄ± getir"
        query = query
            .or(`and(sender_id.eq.${user.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${user.id})`)
            .ilike('subject', `%${cleanSubject}%`);
    }

    const { data: thread, error } = await query;

    if (error) {
        console.error("Load Thread Error:", error);
        container.innerHTML = '<p class="text-red-500 text-xs text-center mt-4">Error loading history.</p>';
        return;
    }
    
    container.innerHTML = ""; 

    if(!thread || thread.length === 0) {
        container.innerHTML = `<p class="text-gray-400 text-xs text-center italic mt-10">${t("inbox_start_conversation") || "Start the conversation..."}</p>`;
        return;
    }

    thread.forEach(m => {
        const isMe = m.sender_id === user.id; // MesajÄ± ben mi attÄ±m?
        
        // Misafir ismini mesajÄ±n iÃ§inden (related_company_name) Ã§ekmeye Ã§alÄ±ÅŸ
                let senderDisplayName = fixedPartnerName;

        // âœ… Only use stored related_company_name for GUEST threads (sender_id is null).
        // For registered users, prefer live-resolved company name to avoid showing stale names after claim.
        if (!isMe && (!partnerId || partnerId === 'null' || partnerId === 'undefined') && m.related_company_name) {
             senderDisplayName = m.related_company_name.split('(')[0].trim();
        }

        let displayNameHtml = isMe 
            ? `<span class="text-[10px] font-bold text-BTrustOn-accent">${(t("inbox_me_label") || "ME")}</span>`
            : `<span class="text-[10px] font-bold text-gray-600 uppercase tracking-wide cursor-default">${senderDisplayName}</span>`;
            // Misafir olduÄŸu iÃ§in isme tÄ±klama (cursor-default) Ã¶zelliÄŸi verdik

        let cleanContent = m.content || "";
        // --- i18n: Localize legacy guest request block (stored as EN/TR text) ---
        try {
            if (/^---\s*(GUEST REQUEST|MÄ°SAFÄ°R TALEBÄ°)\s*---/i.test(cleanContent)) {
                const __hdr = (t("guest_request_header") || "--- GUEST REQUEST ---");
                const __nameLbl = (t("guest_label_name") || "Name");
                const __emailLbl = (t("guest_label_email") || "Email");
                cleanContent = cleanContent.replace(/^---\s*(GUEST REQUEST|MÄ°SAFÄ°R TALEBÄ°)\s*---/i, __hdr);
                cleanContent = cleanContent.replace(/(^|\n)\s*(Name|Ad)\s*:\s*/g, `$1${__nameLbl}: `);
                cleanContent = cleanContent.replace(/(^|\n)\s*(Email|E-?posta)\s*:\s*/gi, `$1${__emailLbl}: `);
            }
        } catch(e) {}


        // --- DOSYA KARTI OLUÅžTURMA (Ã–nceki Ä°ndirme Logic'i Korundu) ---
        cleanContent = cleanContent.replace(/\[FILE_ATTACHMENT\|(.*?)\|(.*?)\]/g, function(match, fileName, fileUrl) {
            
            let icon = "fa-file-lines";
            if(fileName.match(/\.(jpg|jpeg|png|gif)$/i)) icon = "fa-image";
            if(fileName.match(/\.(pdf)$/i)) icon = "fa-file-pdf";
            if(fileName.match(/\.(doc|docx)$/i)) icon = "fa-file-word";
            if(fileName.match(/\.(xls|xlsx)$/i)) icon = "fa-file-excel";

            // Ä°ndirme butonu sadece alÄ±cÄ±ya (Bana) gÃ¶rÃ¼nsÃ¼n
            const downloadBtnHtml = !isMe ? `
                <button onclick="downloadFile('${fileUrl}', '${fileName}')" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-400 hover:text-BTrustOn-accent flex items-center justify-center transition" title="Download File">
                    <i class="fa-solid fa-download"></i>
                </button>
            ` : '';

            const actionText = isMe ? "Click to verify upload" : "Click to view";

            return `
                <div class="mt-3 group">
                    <div class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-xl hover:border-BTrustOn-accent hover:shadow-md transition-all">
                        <div onclick="window.open('${fileUrl}', '_blank')" class="cursor-pointer w-10 h-10 rounded-lg bg-gray-50 text-BTrustOn-accent grid place-items-center text-lg group-hover:bg-BTrustOn-accent group-hover:text-white transition-colors">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div onclick="window.open('${fileUrl}', '_blank')" class="cursor-pointer flex-1 min-w-0">
                            <p class="text-xs font-bold text-gray-700 truncate group-hover:text-BTrustOn-accent transition-colors" title="${fileName}">${fileName}</p>
                            <p class="text-[10px] text-gray-400">${actionText}</p>
                        </div>
                        ${downloadBtnHtml}
                    </div>
                </div>
            `;
        });

        cleanContent = cleanContent.replace(/\n/g, '<br>');

        const bubble = document.createElement("div");
        bubble.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;
        
        bubble.innerHTML = `
            <div class="max-w-[85%] ${isMe ? 'bg-cyan-50 border border-cyan-100 rounded-tr-none' : 'bg-white border border-gray-200 rounded-tl-none'} p-4 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-1 gap-4">
                    ${displayNameHtml}
                    <span class="text-[9px] text-gray-400">${formatMsgClock(m.created_at)}</span>
                </div>
                <div class="text-sm text-gray-700 leading-relaxed break-words">
                    ${cleanContent}
                </div>
            </div>
        `;
        container.appendChild(bubble);
        
        // MesajÄ± okundu iÅŸaretle
        if (!isMe && !m.is_read) {
            supabaseClient.from('messages').update({ is_read: true }).eq('id', m.id).then(()=>{});
        }
    });

    container.scrollTop = container.scrollHeight;
}
// 2. MESAJI KAPATMA
function closeMessageView() {
    const viewer = document.getElementById("view-message");
    if(viewer) viewer.classList.add("hidden-view");
    __unlockScrollForModal();
}
/* --- GÃœNCELLENMÄ°Åž: sendReply (ROKET HIZI - SIFIR GECÄ°KME) --- */
async function sendReply() {
  return btonWithLock("sendReply:"+String(currentPartnerId||"")+":"+String(currentSubject||""), async () => {
    const inputEl = document.getElementById("reply-input");
    const content = inputEl.value.trim();
    const btn = document.querySelector("#view-message button[onclick='sendReply()']") || document.querySelector("button[onclick='sendReply()']");

    if (!content && !currentAttachmentFile) {
        showToast("Warning", (t("inbox_please_write_message") || "Please write a message."), "error");
        return;
    }

    if (!currentPartnerId || !currentSubject) {
        showToast("Error", (t("inbox_chat_connection_lost") || "Chat connection lost."), "error");
        return;
    }

    const originalText = btn ? btn.innerHTML : (t("ui_send") || "SEND");
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; }

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Please login again.");

        let myDisplayName = "My Company";
        try {
          const myP = await btonGetMyCompanyProfileFresh(true);
          if (myP && myP.company_name) myDisplayName = myP.company_name;
        } catch(e) {}

        const replySubject = currentSubject.startsWith("Re:") ? currentSubject : "Re: " + currentSubject;
        
        let finalContent = content;

        // Dosya varsa Ã¶nce onu yÃ¼kle (BurasÄ± mecbur bekleyecek, dosya yÃ¼klenmeden mesaj gitmez)
        if (currentAttachmentFile) {
             const publicUrl = await uploadFileToSupabase(currentAttachmentFile, 'chat');
             finalContent += `\n\n[FILE_ATTACHMENT|${currentAttachmentFile.name}|${publicUrl}]`;
        }

        // --- HIZLANDIRMA BURADA BAÅžLIYOR ---

        // 1. ANINDA GÃ–RÃœNTÃœ (Optimistic UI)
        // VeritabanÄ±nÄ± beklemeden ekranÄ± gÃ¼ncelle
        inputEl.value = ""; // Kutuyu temizle
        if (typeof removeAttachment === "function") removeAttachment(); 

        // SaÄŸdaki sohbete balonu ekle
        appendLocalMessage(finalContent); 
        
        // Soldaki listeyi gÃ¼ncelle
        manualInboxUpdate(currentPartnerId, currentSubject, finalContent, false); 


        // 2. ARKA PLANDA GÃ–NDER (KullanÄ±cÄ± beklemez)
        const { error } = await supabaseClient.from('messages').insert([{
            sender_id: user.id,
            receiver_id: currentPartnerId,
            content: finalContent,
            subject: replySubject,
            related_company_name: myDisplayName,
            msg_type: 'message',
            is_read: false
        }]);

        if (error) {
            // Hata olursa kullanÄ±cÄ±yÄ± uyar (Ã‡ok nadir olur)
            showToast("Error", (t("inbox_message_failed_to_send") || "Message failed to send!"), "error");
            console.error(error);
        }

    } catch (error) {
        console.error(error);
        showToast("Error", (t("inbox_failed_to_send_prefix") || "Failed to send: ") + error.message, "error");
    } finally {
        if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
    }

  }, { ttlMs:12000, el: (document.querySelector("#view-message button[onclick=\"sendReply()\"]") || null) });
}
// 1. MEVCUT MESAJI SÄ°L
// 1. MEVCUT MESAJI SÄ°L (PROFESYONEL MODAL Ä°LE)
// MEVCUT MESAJI SÄ°L (HEM EKRANDAN HEM VERÄ°TABANINDAN)
// 1. MEVCUT MESAJI SÄ°L (HEM EKRANDAN HEM VERÄ°TABANINDAN)
/* --- GÃœNCELLENMÄ°Åž SÄ°LME VE OKUNMADI Ä°ÅžLEMLERÄ° --- */

// 1. MESAJI (SOHBETÄ°) SÄ°L
/* --- deleteCurrentMessage (TEK MESAJI BENDEN GÄ°ZLE) --- */
function deleteCurrentMessage() {
    if (!currentOpenMessageId) return;

    openDeleteModal((t("inbox_confirm_remove_conversation") || "Remove this conversation from your view?"), async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            // Bu mesajÄ±n detayÄ±nÄ± bul (GÃ¶nderen ben miyim alÄ±cÄ± mÄ±?)
            // ID'den mesajÄ± Ã§ekip bakabiliriz ama thread'i komple sildiÄŸimiz iÃ§in
            // deleteThread fonksiyonunu Ã§aÄŸÄ±rmak daha mantÄ±klÄ±.
            // Ancak tek mesaj silme butonu detay sayfasÄ±nda olduÄŸu iÃ§in:
            
            const item = inboxData.find(m => m.id === currentOpenMessageId);
            if (item) {
                // Thread silme fonksiyonunu kullan (daha temiz)
                await deleteThread(null, item.title, item.partner_id, null);
                closeMessageView();
            } else {
                // EÄŸer listede yoksa manuel update dene (Yedek plan)
                await supabaseClient.from('messages').update({ sender_delete: true }).eq('id', currentOpenMessageId).eq('sender_id', user.id);
                await supabaseClient.from('messages').update({ receiver_delete: true }).eq('id', currentOpenMessageId).eq('receiver_id', user.id);
                
                closeMessageView();
                fetchInboxMessages(); // Listeyi tazele
            }

        } catch (error) {
            console.error("Delete error:", error);
            showToast("Error", (t("inbox_could_not_delete") || "Could not delete."), "error");
        }
    });
}
// 2. OKUNMADI OLARAK Ä°ÅžARETLE
/* --- TEK MESAJI OKUNMADI YAP --- */
async function markAsUnreadCurrentMessage() {
    // ID kontrolÃ¼ (Ã–nceki adÄ±mda openMessage iÃ§inde bunu tanÄ±mlamÄ±ÅŸtÄ±k)
    if (!currentOpenMessageId) {
        showToast("Error", (t("ui_no_message_selected") || "No message selected."), "error");
        return;
    }

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast("Error", (t("auth_login_required") || "Login required."), "error");
            return;
        }
        if (!currentPartnerId || !currentSubject) {
            showToast("Error", (t("inbox_chat_connection_lost") || "Chat connection lost."), "error");
            return;
        }

        // 1) Always mark locally + persist a manual-unread flag (so counts update even if DB has no unread rows)
        try { __btonSetManualUnread(user.id, currentPartnerId, currentSubject, true); } catch(e) {}
        try {
            const it = inboxData.find(m => m.id === currentOpenMessageId) ||
                       inboxData.find(m => String(m.partner_id) === String(currentPartnerId) && String(m.title||'') === String(currentSubject||''));
            if (it) { it.unread = true; it.manual_unread = true; }
        } catch(e) {}

        // 2) Best-effort DB update: mark partner->me messages as unread again (if any)
        try {
            const { error } = await supabaseClient
                .from("messages")
                .update({ is_read: false })
                .eq("receiver_id", user.id)
                .eq("sender_id", currentPartnerId)
                .ilike("subject", `%${currentSubject}%`);
            if (error) console.warn("markAsUnread DB update failed (ignored):", error);
        } catch(e) {
            console.warn("markAsUnread DB update exception (ignored):", e);
        }

        // 3) Refresh UI
        renderInboxItems();
        closeMessageView();
        showToast((t("toast_marked_unread") || "Marked Unread"), (t("inbox_conversation_marked_unread") || "Conversation marked as unread."), "success");

    } catch (e) {
        console.error("Unread error:", e);
        try { renderInboxItems(); } catch(_) {}
        showToast("Error", (t("inbox_failed_update_status") || "Failed to update status."), "error");
    }
}
/* --- DOSYA EKLEME YÃ–NETÄ°MÄ° --- */

let currentAttachmentFile = null; // SeÃ§ilen dosyayÄ± hafÄ±zada tut

// 1. DOSYA SEÃ‡Ä°LÄ°NCE Ã‡ALIÅžIR
function handleFileSelect(input) {
    if (input.files && input.files[0]) {
        currentAttachmentFile = input.files[0];
        
        // Ã–nizleme alanÄ±nÄ± doldur
        const preview = document.getElementById("attachment-preview");
        const nameEl = document.getElementById("attachment-name");
        const sizeEl = document.getElementById("attachment-size");
        
        if (preview && nameEl) {
            nameEl.textContent = currentAttachmentFile.name;
            // Boyutu hesapla (KB veya MB)
            let size = currentAttachmentFile.size / 1024;
            let label = " KB";
            if(size > 1024) { size = size / 1024; label = " MB"; }
            
            if(sizeEl) sizeEl.textContent = size.toFixed(1) + label;

            // Kutuyu gÃ¶ster
            preview.classList.remove("hidden");
        }
    }
}

// 2. DOSYAYI KALDIR (X Butonu)
function removeAttachment() {
    currentAttachmentFile = null;
    document.getElementById("reply-file-input").value = ""; // Inputu sÄ±fÄ±rla
    
    // Kutuyu gizle
    const preview = document.getElementById("attachment-preview");
    if (preview) preview.classList.add("hidden");
}

let selectedLogoFile = null; // SeÃ§ilen logo dosyasÄ±nÄ± tutar

/* =========================
   CROPPER (Logo & Owner Photo)
========================= */
let __btonCropper = null;
let __btonCropCtx = null; // { kind: 'logo'|'owner', mode: 'direct'|'edit' }
let __btonCropMinRatio = null; // initial zoom ratio when the cropper is ready
let __btonCropZoomSpan = 2.5;    // slider 0..100 => minRatio .. minRatio*(1+ZoomSpan)
let __btonCropContain = false; // logos with extreme aspect ratios: start in 'contain' mode
let __btonCropBaseline = null; // { minRatio, canvas, cropBox } baseline for "100%" view

function __btonCaptureCropBaseline() {
  if (!__btonCropper) return;
  try {
    const minR = __btonCropMinRatio || (__btonCropper.getImageData()?.ratio) || 1;
    __btonCropBaseline = {
      minRatio: minR,
      canvas: __btonCropper.getCanvasData(),
      cropBox: __btonCropper.getCropBoxData()
    };
  } catch (_) {}
}

function __btonRestoreCropBaseline() {
  if (!__btonCropper || !__btonCropBaseline) return;
  try {
    if (__btonCropBaseline.minRatio) __btonCropper.zoomTo(__btonCropBaseline.minRatio);
    if (__btonCropBaseline.canvas) __btonCropper.setCanvasData(__btonCropBaseline.canvas);
    if (__btonCropBaseline.cropBox) __btonCropper.setCropBoxData(__btonCropBaseline.cropBox);
    try { __btonCropper.setDragMode("move"); } catch (_) {}
  } catch (_) {}
}


function openCropperForFile(file, ctx) {
  if (!file) return;
  __btonCropCtx = ctx || { kind: "logo", mode: "edit" };

  const modal = document.getElementById("modal-cropper");
  const imgEl = document.getElementById("cropper-image");
  const titleEl = document.getElementById("cropper-title");
  const zoomEl = document.getElementById("cropper-zoom");
  const prevSq = document.getElementById("cropper-preview-square");
  const prevCi = document.getElementById("cropper-preview-circle");
  const prevRe = document.getElementById("cropper-preview-rect");
  const tipEl = document.getElementById("cropper-tip");

  if (titleEl) {
    if (__btonCropCtx.kind === "owner") titleEl.textContent = "Adjust Contact Photo";
    else if (__btonCropCtx.kind === "project_cover") titleEl.textContent = "Adjust Project Cover";
    else titleEl.textContent = "Adjust Company Logo";
  }

  if (tipEl) {
    tipEl.textContent = (__btonCropCtx.kind === "project_cover")
      ? "Tip: Use a wide image. We'll crop it to a 16:9 cover."
      : "Tip: For best quality, choose a clear image (min 400Ã—400). We'll crop it to a square.";
  }

// Preview shape
  if (prevSq && prevCi && prevRe) {
    if (__btonCropCtx.kind === "owner") {
      prevCi.classList.remove("hidden");
      prevSq.classList.add("hidden");
      prevRe.classList.add("hidden");
    } else if (__btonCropCtx.kind === "project_cover") {
      prevRe.classList.remove("hidden");
      prevSq.classList.add("hidden");
      prevCi.classList.add("hidden");
    } else {
      prevSq.classList.remove("hidden");
      prevCi.classList.add("hidden");
      prevRe.classList.add("hidden");
    }
  }

// Reset zoom slider (disable until cropper is ready)
  if (zoomEl) { zoomEl.value = 0; zoomEl.disabled = true; }
  __btonCropMinRatio = null;

  // Load image
  const reader = new FileReader();
  reader.onload = function (e) {
    if (!imgEl) return;

    // Open modal (without toggling other modals)
    if (modal) {
      modal.classList.remove("opacity-0", "pointer-events-none");
      document.body.classList.add("modal-active");
    }

    // Destroy old cropper
    if (__btonCropper) {
      try { __btonCropper.destroy(); } catch(_) {}
      __btonCropper = null;
    }

    // Reset zoom baseline and lock slider until Cropper is ready
    __btonCropMinRatio = null;
    __btonCropBaseline = null;
    if (zoomEl) { zoomEl.value = 0; zoomEl.disabled = true; }

    // IMPORTANT: wait for the image to fully load before initializing Cropper
    imgEl.onload = () => {
      try { imgEl.onload = null; } catch(_) {}

      // Decide 'contain' vs 'cover' behavior.
      // Very wide/tall logos look better when the image is fitted *inside* the square (with optional padding)
      // instead of forcing a 'cover' crop that cuts most of the logo.
      try {
        const ar = (imgEl.naturalWidth || 1) / (imgEl.naturalHeight || 1);
        __btonCropContain = (__btonCropCtx && __btonCropCtx.kind === "logo") && (ar > 1.6 || ar < 0.62);
      } catch (_) {
        __btonCropContain = false;
      }

      // (Re)destroy just in case
      if (__btonCropper) {
        try { __btonCropper.destroy(); } catch(_) {}
        __btonCropper = null;
      }

      __btonCropper = new Cropper(imgEl, {
        aspectRatio: (__btonCropCtx.kind === "project_cover" ? (16/9) : 1),
        viewMode: (__btonCropContain ? 0 : 1),
        dragMode: "move",
        autoCropArea: 1,
        responsive: true,
        background: false,
        guides: false,
        center: true,
        highlight: false,
        movable: true,
        zoomable: true,
        zoomOnWheel: true,
        zoomOnTouch: true,
        wheelZoomRatio: 0.08,
        scalable: false,
        rotatable: true,
        cropBoxMovable: false,
        cropBoxResizable: false,
        toggleDragModeOnDblclick: false,
        preview: ".cropper-preview",
        ready() {
          // Force "move" so mouse-drag always pans the photo (not the frame)
          try { __btonCropper.setDragMode("move"); } catch(_) {}

          // Improve UX for large / wide images:
          // - Make the crop box visually larger (within the container)
          // - Auto-zoom so the image comfortably fills the crop frame
          try {
            const c = __btonCropper.getContainerData();
            const isCover = (__btonCropCtx && __btonCropCtx.kind === "project_cover");
            const aspect = isCover ? (16/9) : 1;

            let targetW, targetH;

            if (!isCover) {
              // Square (logo / profile / owner)
              const base = Math.min(c.width, c.height) * 0.86;
              const size = Math.max(360, Math.min(780, base));
              targetW = size;
              targetH = size;
            } else {
              // 16:9 cover (project)
              let w = c.width * 0.94;
              let h = w / aspect;
              const maxH = c.height * 0.72;
              if (h > maxH) { h = maxH; w = h * aspect; }
              targetW = Math.max(360, w);
              targetH = Math.max(200, h);
            }

            // Adjust initial zoom:
            // - Default: "cover" (fill the crop box)
            // - For very wide/tall logos: "contain" (fit the whole logo inside the square, allowing padding)
            const img0 = __btonCropper.getImageData();
            const containLogo = (!!__btonCropContain && !isCover && (__btonCropCtx && __btonCropCtx.kind === "logo"));

            let factor;
            if (containLogo) {
              factor = Math.min(targetW / img0.width, targetH / img0.height);
            } else {
              factor = Math.max(targetW / img0.width, targetH / img0.height, 1);
            }

            if (Number.isFinite(factor) && factor > 0) {
              __btonCropper.zoomTo(img0.ratio * factor);
            }

            // Center the image after zoom
            const img1 = __btonCropper.getImageData();
            __btonCropper.setCanvasData({
              left: (c.width - img1.width) / 2,
              top: (c.height - img1.height) / 2
            });

            // Center and size the crop box
            __btonCropper.setCropBoxData({
              left: (c.width - targetW) / 2,
              top: (c.height - targetH) / 2,
              width: targetW,
              height: targetH
            });
          } catch (e) {
            // Keep defaults if anything fails
          }

          // Capture the baseline zoom ratio once the cropper is fully laid out (after our adjustments).
          try {
            const d = __btonCropper.getImageData();
            __btonCropMinRatio = (d && d.ratio) ? d.ratio : null;
            if (zoomEl) zoomEl.disabled = false;
          } catch(_) {
            __btonCropMinRatio = null;
            if (zoomEl) zoomEl.disabled = false;
          }

          // Snapshot baseline (centered) so 100% zoom always returns to the original view
          requestAnimationFrame(() => { __btonCaptureCropBaseline(); });

        },
        zoom(event) {
          // Keep slider in sync even if user zooms with mouse wheel / touch
          try {
            const ratio = event && event.detail ? event.detail.ratio : (__btonCropper.getImageData()?.ratio);
            const minR = __btonCropMinRatio || (__btonCropper.getImageData()?.ratio) || 1;
            const t = Math.max(0, Math.min(1, (ratio / minR - 1) / (__btonCropZoomSpan)));
            if (zoomEl && !zoomEl.matches(":active")) zoomEl.value = String(Math.round(t * 100));
          } catch(_) {}
        }
      });
    };

    // Set src AFTER binding onload (prevents zero-dimension init bugs)
    imgEl.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function closeCropperModal() {
  const modal = document.getElementById("modal-cropper");
  if (modal) modal.classList.add("opacity-0", "pointer-events-none");

  if (__btonCropper) {
    try { __btonCropper.destroy(); } catch(_) {}
    __btonCropper = null;
  }
  __btonCropCtx = null;
  __btonCropMinRatio = null;
  __btonCropBaseline = null;

  // Keep modal-active only if another modal is open
  syncBodyModalState();
}

function syncBodyModalState() {
  const openAny = Array.from(document.querySelectorAll(".modal")).some(m => {
    // ignore cropper itself if it's hidden
    const isOpen = !m.classList.contains("opacity-0") && !m.classList.contains("pointer-events-none");
    return isOpen;
  });
  if (openAny) document.body.classList.add("modal-active");
  else document.body.classList.remove("modal-active");
}




function onCropperZoom(val) {
  if (!__btonCropper) return;
  const v = Math.max(0, Math.min(100, parseInt(val || "0", 10))) / 100;
  try {
    const minR = __btonCropMinRatio || (__btonCropper.getImageData()?.ratio) || 1;

    // When user comes back to 100% (slider = 0), also restore the original centered position.
    if (v <= 0.000001) {
      if (__btonCropBaseline) {
        __btonRestoreCropBaseline();
      } else {
        __btonCropper.zoomTo(minR);
        requestAnimationFrame(() => { __btonCaptureCropBaseline(); });
      }
      return;
    }

    const target = minR * (1 + (v * __btonCropZoomSpan));
    __btonCropper.zoomTo(target);
  } catch (e) {
    console.warn("Zoom error", e);
  }
}

function cropperRotate(deg) {
  if (!__btonCropper) return;
  try { __btonCropper.rotate(deg); } catch(_) {}
  // After rotation, recompute min zoom baseline on next frame
  const zoomEl = document.getElementById("cropper-zoom");
  if (zoomEl) zoomEl.value = 0;
  requestAnimationFrame(() => {
    try {
      __btonCropMinRatio = __btonCropper.getImageData()?.ratio || __btonCropMinRatio;
      if (__btonCropMinRatio) __btonCropper.zoomTo(__btonCropMinRatio);
      requestAnimationFrame(() => { __btonCaptureCropBaseline(); });
    } catch(_) {}
  });
}

function cropperReset() {
  if (!__btonCropper) return;
  __btonCropBaseline = null;
  try { __btonCropper.reset(); } catch(_) {}
  const zoomEl = document.getElementById("cropper-zoom");
  if (zoomEl) zoomEl.value = 0;
  requestAnimationFrame(() => {
    try {
      __btonCropMinRatio = __btonCropper.getImageData()?.ratio || __btonCropMinRatio;
      if (__btonCropMinRatio) __btonCropper.zoomTo(__btonCropMinRatio);
      requestAnimationFrame(() => { __btonCaptureCropBaseline(); });
    } catch(_) {}
  });
}

async function confirmCropper() {
  if (!__btonCropper || !__btonCropCtx) return;

  // NOTE: closeCropperModal() resets __btonCropCtx to null.
  // confirmCropper() continues after closing the modal (and inside an async toBlob callback),
  // so we must snapshot the context first to avoid "Cannot read properties of null (reading 'kind')".
  const ctx = { ...__btonCropCtx };

  // Produce a high quality crop
  const isCover = (ctx.kind === "project_cover");
  const targetW = isCover ? 1200 : 512;
  const targetH = isCover ? 675 : 512;

  const canvas = __btonCropper.getCroppedCanvas({
    width: targetW,
    height: targetH,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: "high"
  });

  const mime = (ctx.kind === "logo") ? "image/png" : "image/jpeg";
  const ext = (ctx.kind === "logo") ? "png" : "jpg";

  showToast("Processing...", (t("ui_preparing_image") || "Preparing your image..."), "info");

  canvas.toBlob(async (blob) => {
    try {
      if (!blob) throw new Error((t("ui_could_not_crop_image") || "Could not crop image."));
      const croppedFile = new File([blob], `${ctx.kind}-${nowTs()}.${ext}`, { type: mime });

      // Close cropper first (feels faster)
      closeCropperModal();

      if (ctx.kind === "logo") {
        if (ctx.mode === "direct") {
          await uploadLogoDirectFile(croppedFile);
        } else {
          // Edit mode: keep for Save & Preview
          selectedLogoFile = croppedFile;
          // Preview in editor
          const url = URL.createObjectURL(croppedFile);
          const img = document.getElementById("edit-logo-img");
          const icon = document.getElementById("edit-logo-icon");
          if (img) { img.src = url; img.classList.remove("hidden"); }
          if (icon) icon.classList.add("hidden");
          showToast("Ready", (t("ui_logo_prepared_publish") || "Logo prepared. Click Save & Preview to publish."), "success");
        }
      } else if (ctx.kind === "owner") {
        const mode = ctx.mode || "edit";
        if (mode === "direct") {
          await uploadOwnerPhotoDirectFile(croppedFile);
        } else {
          // Edit mode: keep for Save & Preview
          selectedOwnerFile = croppedFile;
          const url = URL.createObjectURL(croppedFile);
          const img = document.getElementById("preview-owner-img");
          const icon = document.getElementById("icon-owner-img");
          if (img) { img.src = url; img.classList.remove("hidden"); }
          if (icon) icon.classList.add("hidden");
          showToast("Ready", (t("ui_photo_prepared_publish") || "Photo prepared. Click Save & Preview to publish."), "success");
        }
      }

      else if (ctx.kind === "project_cover") {
        // Project cover: keep for SaveProject()
        currentProjCover = croppedFile;
        shouldRemoveCover = false;

        const url = URL.createObjectURL(croppedFile);
        const previewDiv = document.getElementById("cover-preview");
        if (previewDiv) {
          previewDiv.innerHTML = `
            <img src="${url}" class="w-full h-full object-cover">
            <button type="button" onclick="removeProjectCover()" class="absolute inset-0 bg-black/55 text-white text-[10px] font-bold opacity-0 hover:opacity-100 transition flex items-center justify-center">
              <i class="fa-solid fa-trash mr-1"></i> Remove
            </button>`;
        }
        showToast("Ready", (t("ui_cover_prepared_publish_project") || "Cover prepared. Click Save to publish this project."), "success");
      }

    } catch (err) {
      console.error(err);
      showToast("Error", err.message || "Image processing failed.", "error");
    } finally {
      // ctx is local snapshot; global ctx is cleared by closeCropperModal().
    }
  }, mime, 0.92);
}

/* =========================
   LOGO PICKERS (Edit & Profile)
========================= */

function handleLogoFromEdit(input) {
  if (input.files && input.files[0]) {
    openCropperForFile(input.files[0], { kind: "logo", mode: "edit" });
  }
  // allow re-pick same file
  input.value = "";
}

function handleLogoFromProfile(input) {
  if (input.files && input.files[0]) {
    openCropperForFile(input.files[0], { kind: "logo", mode: "direct" });
  }
  input.value = "";
}

/* =========================
   OWNER PHOTO PICKERS
========================= */

function triggerOwnerPhotoUpload(mode = "edit") {
  window.__ownerPhotoMode = mode;
  const el = document.getElementById("edit-owner-photo");
  if (el) el.click();
}

function handleOwnerPhotoPicked(input) {
  if (input.files && input.files[0]) {
    const mode = window.__ownerPhotoMode || "edit";
    openCropperForFile(input.files[0], { kind: "owner", mode });
  }
  window.__ownerPhotoMode = "edit";
  input.value = "";
}

/* =========================
   DIRECT UPLOADS (No refresh)
========================= */

async function uploadLogoDirectFile(file) {
  if (!file) return;

  // Immediate preview on profile header
  const previewUrl = URL.createObjectURL(file);
  const pImg = document.getElementById("p-logo-image");
  const pIcon = document.getElementById("p-default-icon");
  if (pImg) { pImg.src = previewUrl; pImg.classList.remove("hidden"); }
  if (pIcon) pIcon.classList.add("hidden");

  showToast("Uploading...", (t("ui_updating_logo") || "Updating your logo..."), "info");

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error((t("auth_login_required") || "Login required"));

    const fileExt = (file.name.split('.').pop() || "png").toLowerCase();
    const fileName = `${user.id}-logo-${nowTs()}.${fileExt}`;
    const filePath = `${fileName}`;

    const { error: uploadError } = await supabaseClient.storage
      .from("logos")
      .upload(filePath, file, { upsert: true });

    if (uploadError) throw uploadError;

    const { data: { publicUrl } } = supabaseClient.storage
      .from("logos")
      .getPublicUrl(filePath);

    const { error: dbError } = await supabaseClient
      .from("profiles")
      .update({ logo_url: publicUrl, updated_at: nowDate() })
      .eq("id", myCompanyIdOr(user.id));

    if (dbError) throw dbError;

    // Local memory update
    const localCompany = database.find(c => String(c.id) === String(myCompanyIdOr(user.id)));
    if (localCompany) localCompany.logo_url = publicUrl;
    if (selectedCompany && String(selectedCompany.id) === String(myCompanyIdOr(user.id))) selectedCompany.logo_url = publicUrl;

    showToast("Success", "Logo updated successfully!", "success");

  } catch (error) {
    console.error(error);
    showToast("Error", "Logo upload failed: " + (error.message || "Unknown error"), "error");
  }
}

async function uploadOwnerPhotoDirectFile(file) {
  if (!file) return;

  // Immediate preview on sidebar card (if visible)
  const previewUrl = URL.createObjectURL(file);
  const wrap = document.getElementById("p-owner-photo-wrap");
  if (wrap) {
    let img = document.getElementById("p-owner-photo-img");
    const overlay = document.getElementById("p-owner-photo-overlay");
    const ph = document.getElementById("p-owner-photo-placeholder");
    if (!img) {
      if (ph) ph.remove();
      img = document.createElement("img");
      img.id = "p-owner-photo-img";
      img.className = "w-full h-full object-cover hover:scale-110 transition duration-500";
      wrap.insertBefore(img, overlay || null);
    }
    img.src = previewUrl;
  }

  // Also preview in edit modal if open
  const eImg = document.getElementById("preview-owner-img");
  const eIcon = document.getElementById("icon-owner-img");
  if (eImg) { eImg.src = previewUrl; eImg.classList.remove("hidden"); }
  if (eIcon) eIcon.classList.add("hidden");

  showToast("Uploading...", (t("ui_updating_contact_photo") || "Updating contact photo..."), "info");

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error((t("auth_login_required") || "Login required"));

    const fileExt = (file.name.split('.').pop() || "jpg").toLowerCase();
    const fileName = `${user.id}-owner-${nowTs()}.${fileExt}`;
    const filePath = `${fileName}`;

    const { error: uploadError } = await supabaseClient.storage
      .from("logos")
      .upload(filePath, file, { upsert: true });

    if (uploadError) throw uploadError;

    const { data: { publicUrl } } = supabaseClient.storage
      .from("logos")
      .getPublicUrl(filePath);

    const { error: dbError } = await supabaseClient
      .from("profiles")
      .update({ owner_photo_url: publicUrl, updated_at: nowDate() })
      .eq("id", myCompanyIdOr(user.id));

    if (dbError) throw dbError;

    // Local memory update
    const localCompany = database.find(c => String(c.id) === String(myCompanyIdOr(user.id)));
    if (localCompany) localCompany.owner_photo_url = publicUrl;
    if (selectedCompany && String(selectedCompany.id) === String(myCompanyIdOr(user.id))) selectedCompany.owner_photo_url = publicUrl;

    showToast("Success", "Contact photo updated!", "success");
  } catch (error) {
    console.error(error);
    showToast("Error", "Upload failed: " + (error.message || "Unknown error"), "error");
  }
}
/* --- SERTÄ°FÄ°KA YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingCertId = null;

// 1. MODALI AÃ‡
/* --- GÃœNCELLENMÄ°Åž: openCertModal (PRO LOCK + DATE) --- */
function openCertModal(certId = null) {
  // Pro deÄŸilse ve limiti dolduysa engelle (Sadece yeni eklemede)
  if ((!certId || certId === -1)) {
      if (!checkPlanLimit('certs')) return;
  }

  const modal = document.getElementById("cert-modal");
  const form = document.getElementById("cert-form");
  const title = document.getElementById("cert-modal-title");
  if (title && (!certId || certId === -1)) title.textContent = (t("ui_add_certificate_7159a1") || "Add Certificate");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  if(form) form.reset();
  removeCertFile(); // DosyayÄ± temizle

  // --- PRO KONTROLÃœ (KÄ°LÄ°T MEKANÄ°ZMASI) ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const fileLock = document.getElementById("cert-file-lock");
  const fileInput = document.getElementById("cert-file-input");
  const proBadge = document.getElementById("cert-file-pro-badge");
  const fileLabel = document.getElementById("cert-file-label");

  if (isPro) {
      if(fileLock) fileLock.classList.add("hidden"); // Kilidi aÃ§
      if(proBadge) proBadge.classList.add("hidden"); 
      if(fileInput) fileInput.disabled = false;
      if(fileLabel) fileLabel.onclick = null;
  } else {
      if(fileLock) fileLock.classList.remove("hidden"); // Kilitle
      if(proBadge) proBadge.classList.remove("hidden");
      if(fileInput) fileInput.disabled = true;
      // Kilitli alana tÄ±klayÄ±nca Upgrade'i aÃ§
      if(fileLabel) fileLabel.onclick = (e) => { e.preventDefault(); toggleModal('modal-upgrade'); };
  }

  // --- DÃœZENLEME MODU ---
  if (certId && certId !== -1) {
    currentEditingCertId = certId;
    if(title) title.textContent = (t("ui_edit_certificate") || "Edit Certificate");
    
    const cert = selectedCompany.certificates.find(c => c.id === certId);
    if (cert) {
        document.getElementById("cert-name").value = cert.name || "";
        document.getElementById("cert-issuer").value = cert.issuer || "";
        document.getElementById("cert-date").value = cert.expiry_date || ""; // Tarihi doldur

        // Varsa DosyayÄ± GÃ¶ster
        if (cert.file_url) {
            existingCertFileUrl = cert.file_url;
            const linkEl = document.getElementById("current-cert-link");
            linkEl.href = cert.file_url;
            linkEl.classList.remove("hidden");
            document.getElementById("btn-remove-cert-file").classList.remove("hidden");
            document.getElementById("cert-file-text").textContent = "Change File";
        }
    }
  } else {
    currentEditingCertId = null;
    if(title) title.textContent = (t("ui_add_new_certificate_1b4fc5") || "Add New Certificate");
  }
}

function closeCertModal() {
  const modal = document.getElementById("cert-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingCertId = null;
}

// 2. KAYDET (Supabase)
/* --- GÃœNCELLENMÄ°Åž: saveCert (SEKME SORUNU Ã‡Ã–ZÃœLDÃœ) --- */
async function saveCert() {
  const btn = document.querySelector("#cert-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Saving...";
  btn.disabled = true;

  try {
    const name = document.getElementById("cert-name").value.trim();
    const issuer = document.getElementById("cert-issuer").value.trim();
    const date = document.getElementById("cert-date").value;

    if (!name) { showToast("Missing Info", (t("ui_certificate_name_required") || "Certificate name required."), "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("Session expired.");

    // --- DOSYA YÃœKLEME ---
    let finalUrl = existingCertFileUrl;
    
    if (currentCertFile) {
        if (selectedCompany.subscription_tier === 'pro') {
            const fileExt = currentCertFile.name.split('.').pop();
            const filePath = `${user.id}/cert_${nowTs()}.${fileExt}`;
            
            const { error: uploadError } = await supabaseClient.storage
                .from('certificate-docs')
                .upload(filePath, currentCertFile);

            if (uploadError) throw uploadError;
            
            const { data } = supabaseClient.storage.from('certificate-docs').getPublicUrl(filePath);
            finalUrl = data.publicUrl;
        }
    }
    
    if (!currentCertFile && !existingCertFileUrl) finalUrl = null;

    // --- VERÄ° HAZIRLAMA ---
    const certObj = {
        name: name,
        issuer: issuer,
        expiry_date: date,
        file_url: finalUrl,
        updated_at: nowDate().toISOString()
    };

    let currentCerts = [...(selectedCompany.certificates || [])];

    if (currentEditingCertId) {
        const index = currentCerts.findIndex(c => c.id === currentEditingCertId);
        if (index > -1) {
            currentCerts[index] = { ...currentCerts[index], ...certObj };
        }
    } else {
        currentCerts.push({ id: nowTs(), created_at: nowDate().toISOString(), ...certObj });
    }

    // --- DB GÃœNCELLEME ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ certificates: currentCerts, updated_at: nowDate() })
      .eq('id', myCompanyIdOr(user.id));

    if (error) throw error;

    selectedCompany.certificates = currentCerts;
    const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
    if(localRef) localRef.certificates = currentCerts;

    // --- KRÄ°TÄ°K DÃœZELTME BURADA ---
    openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });      // Profili yÃ¼kle
    switchProfileTab('certs'); // HIZLICA SERTÄ°FÄ°KA SEKMESÄ°NE DÃ–N
    
    showToast((t("toast_success") || (currentLang === "tr" ? "BaÅŸarÄ±lÄ±" : "Success")), (t("msg_certificate_saved") || (currentLang === "tr" ? "Sertifika kaydedildi." : "Certificate saved!")), "success");
    closeCertModal();

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// 3. SÄ°LME
// 3. SÄ°LME (CERTIFICATE) - YENÄ° MODAL Ä°LE
function deleteCert(certId, certName) {
    // TarayÄ±cÄ± confirm'i yerine kendi modalÄ±mÄ±zÄ± Ã§aÄŸÄ±rÄ±yoruz
    openDeleteModal(_deleteConfirmMsg("certificate"), async () => {
        
        // --- ASIL SÄ°LME Ä°ÅžLEMÄ° BURADA BAÅžLIYOR ---
        try {
            let currentCerts = [];
            
            if (certId === -1) {
                currentCerts = selectedCompany.certificates.filter(c => c !== certName);
            } else {
                currentCerts = selectedCompany.certificates.filter(c => c.id !== certId);
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ certificates: currentCerts, updated_at: nowDate() })
                .eq('id', myCompanyIdOr(user.id));

            if (error) throw error;

            selectedCompany.certificates = currentCerts;
            const localRef = database.find(c => c.id == myCompanyIdOr(user.id));
            if(localRef) localRef.certificates = currentCerts;

            openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true });
            showToast("Deleted", (t("msg_certificate_removed") || ((currentLang==="tr") ? "Sertifika baÅŸarÄ±yla silindi." : "Certificate removed successfully.")), "success");
            
        } catch (error) {
            showToast("Error", "Delete failed: " + error.message, "error");
        }
    });
}
// --- VERÄ°TABANINDAN GÃœNCEL VERÄ°LERÄ° Ã‡EKME ---
/* --- GÃœNCELLENMÄ°Åž: initRealData (COUNTRY VERÄ°SÄ° EKLENDÄ°) --- */
async function initRealData() {
  console.log("Supabase'den veriler Ã§ekiliyor...");
  
  // 1. Supabase'den tÃ¼m profilleri al
  const { data: profiles, error } = await supabaseClient
    .from('profiles')
    .select('*');

  if (error) { console.error("Veri Ã§ekme hatasÄ±:", error); return; }
  if (!profiles) return;

  // 2. Verileri formatla
  profiles.forEach(p => {
// ðŸ‘‡ðŸ‘‡ðŸ‘‡ BURASI YENÄ°: EÄžER BU PROFÄ°L ADMÄ°N Ä°SE LÄ°STEYE EKLEME ðŸ‘‡ðŸ‘‡ðŸ‘‡
    if (p.email === ADMIN_EMAIL) {
        return; // DÃ¶ngÃ¼yÃ¼ burada kes, bu ÅŸirketi listeye alma
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† ---------------------------------------------------- ðŸ‘†ðŸ‘†ðŸ‘†
    const pId = p.id;
    const realData = {
      id: pId,
      name: p.company_name || "New Company",
      city: p.city || "Konum Yok",
      updated_at: p.updated_at || p.updatedAt || null,
      last_active_at: p.last_active_at || p.last_seen_at || p.last_login_at || p.last_sign_in_at || p.updated_at || null,

      
      // âœ… Ä°ÅžTE EKSÄ°K OLAN SATIR BUYDU:
      country: p.country || "Turkey",
address: p.address || "", // âœ… BU SATIRI EKLEYÄ°N
      email: p.email || "", 
      is_listed: (p.is_listed !== undefined ? p.is_listed : true),
      subscription_tier: p.subscription_tier || "free",
      verification_status: p.verification_status || "none",
      tax_id: p.tax_id || "",
      duns_number: p.duns_number || "",

service_details: p.service_details || "",
owner_name: p.owner_name,
      owner_role: p.owner_role,
      owner_linkedin: p.owner_linkedin,
      owner_photo_url: p.owner_photo_url,
      
      sector: p.sector || "construction",
      desc: p.description || "",
      tagline: p.tagline || "",
      type_label: p.company_type, 
      size_label: p.company_size,
      year_label: p.founded_year,
      services: p.services ? p.services.split(',').map(s=>s.trim()) : [],
      logo_url: p.logo_url,
      website: p.website,
      phone: p.phone,
      contact_email: p.contact_email,
      certificates: p.certificates || [],
      projects: p.projects || [],
      assets: p.assets || [],
      trust: "verified",
      meta: { references: 80, delivery: 85, years: 5, financial: 80, digital: 70 }
    };

    const existingIndex = database.findIndex(c => c.id == pId);
    if (existingIndex > -1) {
      database[existingIndex] = { ...database[existingIndex], ...realData };
    } else {
      database.unshift(realData);
    }
  });

  // 3. Filtreleri ve EkranÄ± Yenile
  dedupeDatabasePreferReal();
  populateCountryFilter(); // <-- ArtÄ±k verilerde 'country' olduÄŸu iÃ§in burasÄ± Ã§alÄ±ÅŸacak
  
  if (typeof isSearchActive !== 'undefined' && !isSearchActive) {
      renderShowcase(); 
  } else {
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      renderSearchResults(q);
  }
  
// AÃ§Ä±k profil varsa gÃ¼ncelle
  if (selectedCompany) {
      const updatedCompany = database.find(c => c.id === selectedCompany.id);
      if(updatedCompany) {
          selectedCompany = updatedCompany;
          openProfile(selectedCompany.id);
      }
  }
}
// TÃœMÃœNÃœ OKUNDU OLARAK Ä°ÅžARETLE
/* --- TÃœMÃœNÃœ OKUNDU YAP (GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž) --- */
/* --- TÃœMÃœNÃœ OKUNDU YAP (AKILLI KONTROL) --- */
async function markAllInboxRead() {
  // Notifications tab uses notifications table
  if (currentInboxView === 'notifications') {
    await markAllNotificationsRead();
    return;
  }

  const btn = document.querySelector("#inbox-panel button[onclick='markAllInboxRead()']");
  
  // 1. Ã–NCE KONTROL ET: HiÃ§ okunmamÄ±ÅŸ mesaj var mÄ±?
  // inboxData listesindeki 'unread' olanlarÄ± sayÄ±yoruz
  const unreadExists = inboxData.some(item => item.unread === true);

  if (!unreadExists) {
      // EÄŸer hepsi zaten okunmuÅŸsa, boÅŸuna sunucuya gitme ve "Success" deme.
      // Sadece kullanÄ±cÄ±ya bilgi ver ve fonksiyondan Ã§Ä±k.
      showToast("Up to date", (t("inbox_all_messages_already_read") || "All messages are already read."), "info");
      return; 
  }

  // --- Buradan sonrasÄ± aynÄ±, iÅŸlem baÅŸlÄ±yor ---
  if(btn) btn.disabled = true;

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error((t("auth_login_required") || "Login required"));

    // 1. VeritabanÄ±nÄ± GÃ¼ncelle
    const { error } = await supabaseClient
      .from("messages")
      .update({ is_read: true })
      .eq("receiver_id", user.id)
      .eq("is_read", false);

    if (error) throw error;

    // 2. Yerel listeyi gÃ¼ncelle
    try { __btonClearAllManualUnread(user.id); } catch(e) {}
    inboxData.forEach(item => item.unread = false);
    renderInboxItems();

    // 3. BaÅŸarÄ±lÄ± MesajÄ± (Sadece gerÃ§ekten bir ÅŸeyler deÄŸiÅŸtiyse Ã§Ä±kar)
    showToast("Success", (t("inbox_all_messages_marked_read") || "All messages marked as read."), "success");

  } catch (e) {
    console.error("Mark all read error:", e);
    showToast("Error", (t("inbox_could_not_update_status") || "Could not update status."), "error");
  } finally {
    if(btn) btn.disabled = false;
  }
}

/* --- EKSÄ°K OLAN FONKSÄ°YON: TÃœMÃœNÃœ SÄ°L --- */
function deleteAllInbox() {
    // Notifications tab uses notifications table
    if (currentInboxView === 'notifications') {
        deleteAllNotifications();
        return;
    }

    // 1. Hangi kutuda olduÄŸumuzu kontrol et
    const isInbox = currentInboxView === 'inbox';

    // 2. Onay ModalÄ± AÃ§
    openDeleteModal(
        isInbox
          ? (t("inbox_confirm_delete_all_received") || "Delete all received messages?")
          : (t("inbox_confirm_delete_all_sent") || "Delete all sent messages?"),
        async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error((t("auth_login_required") || "Login required"));

            // 3. VeritabanÄ± Ä°ÅŸlemi (Soft Delete)
            let query = supabaseClient.from('messages');
            
            if (isInbox) {
                // Gelen Kutusunu Temizle (receiver_delete = true)
                query = query.update({ receiver_delete: true }).eq('receiver_id', user.id);
            } else {
                // GÃ¶nderilenleri Temizle (sender_delete = true)
                query = query.update({ sender_delete: true }).eq('sender_id', user.id);
            }

            const { error } = await query;
            if (error) throw error;

            // 4. Yerel Listeyi GÃ¼ncelle
            // SildiÄŸimiz kutuya ait olmayanlarÄ± tut, diÄŸerlerini at
            inboxData = inboxData.filter(item => {
                if (isInbox) {
                    return item.isSentByMe === true; // Inbox siliyorsak, Sent'ler kalsÄ±n
                } else {
                    return item.isSentByMe === false; // Sent siliyorsak, Inbox'lar kalsÄ±n
                }
            });

            // 5. EkranÄ± Yenile
            renderInboxItems();
            showToast("Cleared", (isInbox ? (t("inbox_all_received_deleted_success") || "All received messages deleted successfully.") : (t("inbox_all_sent_deleted_success") || "All sent messages deleted successfully.")), "success");

        } catch (error) {
            console.error("Delete All Error:", error);
            showToast("Error", (t("inbox_failed_to_delete_prefix") || "Failed to delete: ") + error.message, "error");
        }
    });
}

/* --- AKILLI VÄ°TRÄ°N VE ARAMA SÄ°STEMÄ° --- */

    let showcaseInterval = null; // 5 saniyelik zamanlayÄ±cÄ±
    let isSearchActive = false;  // Arama modunda mÄ±yÄ±z?

    // 1. ANA RENDER FONKSÄ°YONU (KartlarÄ± Ã‡izer)
    // Bu fonksiyon sadece "Verilen Listeyi Ekrana Basmakla" gÃ¶revlidir.
    // 1. ANA RENDER FONKSÄ°YONU (KartlarÄ± Ã‡izer) - DÃœZELTÄ°LMÄ°Åž VERSÄ°YON
    // 1. ANA RENDER FONKSÄ°YONU (GÃœNCELLENMÄ°Åž - TÄ°P ROZETLÄ°)
    function drawCardsToScreen(companyList, mode = "showcase") {
        const container = document.getElementById("card-container");
        const resultCount = document.getElementById("result-count");
        
        if (!container) return;
        container.innerHTML = "";

        // BaÅŸlÄ±k ve SayÄ± GÃ¼ncelleme
        if (resultCount) {
            // result-count is dynamic; prevent i18n engine from overwriting it later
            try { resultCount.setAttribute("data-i18n-skip","1"); resultCount.removeAttribute("data-i18n"); } catch(e) {}

            if (mode === "search") {
                resultCount.innerHTML = `
                    <span class="text-sm text-gray-500 font-normal">${t("results_search_label") || "Search Results:"}</span> 
                    <span class="text-BTrustOn-accent">${companyList.length}</span> 
                    <span class="text-sm text-gray-500 font-normal">${t("results_companies_found") || "companies found"}</span>`;
            } else {
                resultCount.innerHTML = `
                    <span class="text-sm text-gray-500 font-normal">${t("results_live_showcase") || "Live Showcase:"}</span> 
                    <span class="text-BTrustOn-accent font-semibold">${t("results_active") || "Active"}</span> 
                    <span class="text-[10px] text-gray-400 ml-2">${t("results_refreshing_5s") || "(Refreshing every 5s)"}</span>
                    <span class="block mt-1 text-[11px] text-slate-500">${t("showcase_pro_note") || "Verified partners rotate here â€” Go Pro to unlock updates visibility."}</span>`;
            }
        }

        if (companyList.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-gray-500">${t("results_none_found") || "No companies found matching your criteria."}</p>
                </div>`;
            return;
        }

        companyList.forEach((company) => {
if (company.email === ADMIN_EMAIL || company.contact_email === ADMIN_EMAIL) {
                return; // Admin ise bu turu pas geÃ§, ekrana Ã§izme
            }
            // Index snapshot for Saved insert payload (safe)
            indexCompanySnapshot(company);
            const desc = currentLang === "tr" && company.desc_tr ? company.desc_tr : company.desc;
            const services = currentLang === "tr" && company.services_tr ? company.services_tr : company.services;
            
            // VeritabanÄ±ndaki "type" veya "type_label" alanÄ±nÄ± kullanÄ±yoruz
            const compTypeKey = String(company.company_type || company.business_type || company.type || "").trim();
const compType = (company.type_label || (compTypeKey ? translateCompanyType(compTypeKey) : "â€”") || "â€”");

            const refCount = (company.projects || []).length;
            const certCount = (company.certificates || []).length;
            const assetCount = (company.assets || []).length;


            const saved = (typeof isCompanySaved === 'function') ? isCompanySaved(company.id) : false;

            const canSave = (typeof isUuid === 'function') ? isUuid(company.id) : false;

            const myIdRaw2 = (typeof getMyCompanyId === 'function') ? getMyCompanyId() : null;
            const myId2 = (myIdRaw2 && (typeof isUuid === 'function') && isUuid(myIdRaw2)) ? myIdRaw2 : null;
            const isOwn2 = !!(myId2 && String(company.id) === String(myId2));
            const followed2 = (__authUserId && canSave && !isOwn2 && typeof _isCompanyFollowed === 'function') ? _isCompanyFollowed(company.id) : false;
            const safeCompanyName2 = String(company.name || '').replace(/'/g, "\\'");

const safeCompanyNameAttr2 = String(company.name || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeCompanyLogoAttr2 = String(company.logo_url || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeCompanyTypeAttr2 = String(compTypeKey || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeCompanyCityAttr2 = String(company.city || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeCompanyCountryAttr2 = String(company.country || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const safeCompanyVerifiedAttr2 = (company.verification_status === "approved" || company.verification_status === "verified" || company.is_verified || company.verified) ? "1" : "0";

            const card = document.createElement("div");
            card.className = "group relative bg-white/80 backdrop-blur border border-slate-200/70 rounded-3xl p-5 shadow-sm flex flex-col h-full hover:border-BTrustOn-accent hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer fade-in overflow-hidden";
            
            card.onclick = () => openProfile(company.id);

            card.innerHTML = `
              <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-gradient-to-br from-cyan-50/70 via-white to-white pointer-events-none"></div>
              <div class="absolute -top-12 -right-12 w-28 h-28 rounded-full bg-slate-200/50 blur-2xl pointer-events-none"></div>
              <div class="relative flex-1 flex flex-col gap-3">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start gap-3 min-w-0 flex-1">
                      <div class="w-12 h-12 rounded-2xl bg-white/80 backdrop-blur border border-slate-200/70 ring-1 ring-white/60 shadow-sm overflow-hidden shrink-0 flex items-center justify-center">
                        ${getCompanyLogoThumb(company)}
                      </div>

                      <div class="min-w-0 flex-1">
                        <h3 class="text-[15px] font-extrabold text-BTrustOn-primary leading-snug tracking-tight min-w-0 flex items-center gap-1">
                          <span class="truncate min-w-0" title="${escapeHtml(company.name || '')}">${escapeHtml(company.name || '')}</span>
                          <span class="shrink-0 flex items-center">${getVerifiedMark(company)}</span>
                        </h3>

                        <div class="flex flex-wrap items-center gap-2 mt-1">
                          ${getCompanyTypeBadge(compType)}
                          <span class="text-[10px] text-gray-400 flex items-center gap-1 shrink-0">
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            ${formatCityCountry(company.city, company.country || "TR")}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <p class="text-[12px] text-slate-600 clamp-3 leading-relaxed">
                    ${desc}
                  </p>

                  <div class="flex flex-wrap gap-1.5">
                    ${(services || []).slice(0, 3).map(s => `
                      <span class="text-[10px] px-2 py-1 rounded-full bg-white/70 border border-slate-200/70 text-slate-700 shadow-sm">${svcDisplayLabel(s)}</span>
                    `).join("")}
                  </div>

                  <div class="flex items-center gap-3 pt-1 text-[11px] font-semibold text-slate-600">
                    <button type="button"
                      class="inline-flex items-center gap-1 hover:text-BTrustOn-accent transition whitespace-nowrap"
                      title="${t("card_meta_references") || "References"}"
                      aria-label="${t("card_meta_references") || "References"}"
                      onclick="event.stopPropagation(); openProfile('${company.id}', {tab:'projects'});">
                      <span>${t("card_meta_references") || "References"}</span>
                      <span class="font-extrabold text-slate-900">${refCount}</span>
                    </button>

                    <span class="text-slate-300 select-none" aria-hidden="true">â€¢</span>

                    <button type="button"
                      class="inline-flex items-center gap-1 hover:text-BTrustOn-accent transition whitespace-nowrap"
                      title="${t("card_meta_certificates") || "Certificates"}"
                      aria-label="${t("card_meta_certificates") || "Certificates"}"
                      onclick="event.stopPropagation(); openProfile('${company.id}', {tab:'certs'});">
                      <span>${t("card_meta_certificates") || "Certificates"}</span>
                      <span class="font-extrabold text-slate-900">${certCount}</span>
                    </button>

                    <span class="text-slate-300 select-none" aria-hidden="true">â€¢</span>

                    <button type="button"
                      class="inline-flex items-center gap-1 hover:text-BTrustOn-accent transition whitespace-nowrap"
                      title="${t("card_meta_assets") || "Assets"}"
                      aria-label="${t("card_meta_assets") || "Assets"}"
                      onclick="event.stopPropagation(); openProfile('${company.id}', {tab:'assets'});">
                      <span>${t("card_meta_assets") || "Assets"}</span>
                      <span class="font-extrabold text-slate-900">${assetCount}</span>
                    </button>
                  </div>
              </div>

              <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-200/60">
                <div class="flex items-center gap-2">
                  ${canSave ? `
                  <button
                  class="w-9 h-9 rounded-full bg-white/80 backdrop-blur border border-slate-200/70 shadow-sm flex items-center justify-center hover:bg-white hover:border-BTrustOn-accent hover:shadow-md transition"
                  title="${saved ? (t("ui_saved_company") || (currentLang==="tr" ? 'Kaydedildi' : 'Saved company')) : (t("ui_save_company") || (currentLang==="tr" ? 'Åžirketi kaydet' : 'Save company'))}"
                  onclick="event.stopPropagation(); toggleSaveCompany('${company.id}');"
                  >
                  <i class="${saved ? 'fa-solid' : 'fa-regular'} fa-bookmark text-[14px] text-BTrustOn-accent"></i>
                  </button>
                  ` : `
                  <button
                  class="w-9 h-9 rounded-full bg-white/70 backdrop-blur border border-slate-200/70 shadow-sm flex items-center justify-center opacity-50 cursor-not-allowed"
                  title="Only registered companies can be saved"
                  onclick="event.stopPropagation(); showToast('Unavailable','Only registered companies can be saved.','warn');"
                  >
                  <i class="fa-regular fa-bookmark text-[14px] text-BTrustOn-accent"></i>
                  </button>
                  `}
                  ${(canSave && !isOwn2) ? `
                  <button
                  class="company-follow-btn w-9 h-9 rounded-full bg-white/80 backdrop-blur border border-slate-200/70 shadow-sm flex items-center justify-center hover:bg-white hover:border-BTrustOn-accent hover:shadow-md transition"
                  title="${followed2 ? (t('updates_following') || 'Following') : (t('updates_follow') || 'Follow')}"
                  aria-pressed="${followed2 ? 'true' : 'false'}"
                  data-company-id="${company.id}"
                  data-company-name="${safeCompanyNameAttr2}"
                  data-company-logo="${safeCompanyLogoAttr2}"
                  data-company-type="${safeCompanyTypeAttr2}"
                  data-company-city="${safeCompanyCityAttr2}"
                  data-company-country="${safeCompanyCountryAttr2}"
                  data-company-verified="${safeCompanyVerifiedAttr2}"
                  onclick="event.stopPropagation(); toggleCompanyFollow(event,'${company.id}','${safeCompanyName2}');"
                  >
                  <i class="fa-solid fa-tower-broadcast text-[14px] text-BTrustOn-accent ${followed2 ? '' : 'opacity-40'}"></i>
                  </button>
                  ` : ``}
                </div>
                <button class="text-[11px] font-extrabold text-BTrustOn-accent inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 bg-cyan-50/60 border border-cyan-100 hover:bg-cyan-50 transition">
                  <span>${t("btn_view")}</span> <i class="fa-solid fa-arrow-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
                </button>
              </div>
            `;
            container.appendChild(card);
        });
    }

    // 2. VÄ°TRÄ°N MODU (Rastgele 12 Åžirket)
    // 2. VÄ°TRÄ°N MODU (Rastgele 12 Åžirket)
    function renderShowcase() {
    // EÄŸer arama/filtre modundaysak vitrin Ã§alÄ±ÅŸmasÄ±n
    if (isSearchActive) return;

    // âœ… Always keep the list de-duplicated (prevents double cards)
    try { dedupeDatabasePreferReal(); } catch(e) {}

    // Admin kartlarÄ±nÄ± vitrine sokma + gerÃ§ek profilleri Ã¶ncelikle kullan
    const cleanList = getSearchableCompanies().filter(c =>
        c.email !== ADMIN_EMAIL && c.contact_email !== ADMIN_EMAIL
    );

    // Verified tanÄ±mÄ±: SADECE admin onaylÄ± (v19 mantÄ±ÄŸÄ±) â€” mavi tik ile aynÄ± kriter
    const isVerified = (c) => (typeof isCompanyVerified === "function") ? isCompanyVerified(c) : false;

    const byId = (a, b) => String(a?.id || '').localeCompare(String(b?.id || ''));

    // Sorted snapshots for stable pool comparison (won't rebuild just because list order changes)
    const verifiedNow = cleanList.filter(isVerified).slice().sort(byId);
    const othersNow   = cleanList.filter(c => !isVerified(c)).slice().sort(byId);

    // ---- Stable rotating pools (so 500 verified will continuously cycle) ----
    // Rebuild pools only when counts change significantly (cheap + safe)
    if (!window.__bton_showcasePools) {
        window.__bton_showcasePools = {
            v: [], o: [],
            vi: 0, oi: 0,
            vLen: -1, oLen: -1, vKey: "", oKey: ""
        };
    }
    const P = window.__bton_showcasePools;
    const hashIds = (arr) => {
        let h = 0;
        for (const c of arr) {
            const s = String(c?.id || "");
            for (let i = 0; i < s.length; i++) {
                h = ((h << 5) - h + s.charCodeAt(i)) | 0;
            }
        }
        return `${arr.length}:${h}`;
    };

    const vKey = hashIds(verifiedNow);
    if (P.vKey !== vKey) {
        P.v = [...verifiedNow].sort(() => Math.random() - 0.5);
        P.vi = 0;
        P.vKey = vKey;
        P.vLen = verifiedNow.length;
    }

    const oKey = hashIds(othersNow);
    if (P.oKey !== oKey) {
        P.o = [...othersNow].sort(() => Math.random() - 0.5);
        P.oi = 0;
        P.oKey = oKey;
        P.oLen = othersNow.length;
    }


    const TAKE = 12;
    const out = [];

    // 1) Ã–nce verified dÃ¶ngÃ¼sÃ¼ (yeterliyse tamamen verified)
    if (P.v.length) {
        const vTake = Math.min(TAKE, P.v.length);
        for (let i = 0; i < vTake; i++) {
            out.push(P.v[(P.vi + i) % P.v.length]);
        }
        P.vi = (P.vi + vTake) % P.v.length;
    }

    // 2) Verified yetmiyorsa kalanlarÄ± verified-olmayanlardan doldur
    if (out.length < TAKE && P.o.length) {
        const need = TAKE - out.length;
        const oTake = Math.min(need, P.o.length);
        for (let i = 0; i < oTake; i++) {
            out.push(P.o[(P.oi + i) % P.o.length]);
        }
        P.oi = (P.oi + oTake) % P.o.length;
    }

    // 3) Display shuffling: Verified partners change positions each refresh (without breaking the rotation pool)
    const __fyShuffle = (arr) => {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    const outVerified = out.filter(isVerified);
    const outOthers = out.filter(c => !isVerified(c));

    __fyShuffle(outVerified);
    __fyShuffle(outOthers);

    // Randomly distribute verified items across the 12 slots (so they don't always stay on top-left)
    const slots = Array.from({ length: out.length }, (_, i) => i);
    __fyShuffle(slots);

    const finalOut = new Array(out.length).fill(null);

    const vSlots = slots.slice(0, outVerified.length);
    vSlots.forEach((slotIndex, i) => { finalOut[slotIndex] = outVerified[i]; });

    let oi = 0;
    for (let i = 0; i < finalOut.length; i++) {
        if (!finalOut[i] && oi < outOthers.length) {
            finalOut[i] = outOthers[oi++];
        }
    }

    drawCardsToScreen(finalOut.filter(Boolean), "showcase");
}

    // 3. ARAMA MODU (Filtreli Liste)
    // 3. ARAMA VE LÄ°STELEME MODU (GÃœNCELLENMÄ°Åž)
   /* --- GÃœNCELLENMÄ°Åž: renderSearchResults (DERÄ°N ARAMA) --- */

/* ===== LIVE DATA HYGIENE: prevent duplicates between demo + real profiles ===== */
function isRealCompany(c){
  // Supabase UUID ids are long strings; demo cards are usually numbers
  return (typeof c?.id === "string" && c.id.length > 20) || !!c?.email;
}

function dedupeDatabasePreferReal(){
  const seen = new Map();
  const out = [];

  const norm = (v) => String(v || "").trim().toLowerCase();

  const score = (c) => {
    let s = 0;
    if (isRealCompany(c)) s += 1000;
    if (c?.verification_status === "verified") s += 100;
    if (c?.subscription_tier && c.subscription_tier !== "free") s += 10;
    if (c?.trust_score) s += Number(c.trust_score) || 0;
    return s;
  };

  for (const c of database){
    const taxKey = c?.tax_id ? ("t:" + norm(c.tax_id)) : "";
    const emailKey = c?.email ? ("e:" + norm(c.email)) : "";
    const cityKey = norm((String(c.city || "").split(",")[0] || "").trim());
    const baseKey = ("n:" + norm(c.name) + "|c:" + cityKey);
    const key = taxKey || emailKey || baseKey;
    if (!key.trim()) { out.push(c); continue; }

    if (!seen.has(key)){
      seen.set(key, c);
      out.push(c);
      continue;
    }

    const prev = seen.get(key);
    if (score(c) > score(prev)){
      const idx = out.indexOf(prev);
      if (idx > -1) out[idx] = c;
      seen.set(key, c);
    }
    // else ignore c
  }

  // mutate const array in-place
  database.length = 0;
  database.push(...out);
}

function getSearchableCompanies(){
  // Hide "unlisted" rows from search/showcase (e.g., auto-created stub profiles after a claim).
  const clean = database.filter(c => c.email !== ADMIN_EMAIL && c.contact_email !== ADMIN_EMAIL);

  // Default: listed unless explicitly false
  const visible = clean.filter(c => c.is_listed !== false);

  const real = visible.filter(isRealCompany);
  // If there are no real profiles yet, fall back to demo cards so UI doesn't look empty
  return real.length ? real : visible;
}

function renderSearchResults(query) {
    const q = (query || "").toLowerCase().trim();

    // âœ… Always keep the list de-duplicated (prevents double cards)
    try { dedupeDatabasePreferReal(); } catch(e) {}

    // A. FÄ°LTRELEME
    let filtered = getSearchableCompanies().filter((company) => {
        // 1. SektÃ¶r Filtresi (EÄŸer "All" deÄŸilse eÅŸleÅŸmeli)
        if (currentSector !== "all" && company.sector !== currentSector) return false;
        
        // 2. Ãœlke Filtresi (EÄŸer "All" deÄŸilse eÅŸleÅŸmeli)
        // 2. Ãœlke Filtresi (GÃœNCEL - Direkt Veriden)
        if (currentCountryFilter !== "all") {
            // ArtÄ±k ÅŸehri parÃ§alamÄ±yoruz, direkt 'country' sÃ¼tununa bakÄ±yoruz
            if (countryNameToISO2(company.country) && countryNameToISO2(currentCountryFilter)) { if (countryNameToISO2(company.country) !== countryNameToISO2(currentCountryFilter)) return false; } else { if (company.country !== currentCountryFilter) return false; }
        }

        // 3. METÄ°N ARAMASI (HAYSTACK MANTIÄžI)
        if (!q) return true; // Arama kutusu boÅŸsa herkesi gÃ¶ster

        // --- DERÄ°N VERÄ° TOPLAMA ---
        
        // a. Temel Bilgiler
        const baseInfo = [
            company.name, 
            company.city, 
            company.sector, 
            company.type_label,
            company.desc, 
            company.tagline
        ].join(" ").toLowerCase();

        // b. Hizmetler (Array)
        const servicesText = (company.services || []).join(" ").toLowerCase();

        // c. VarlÄ±klar (Assets - Obje Dizisi)
        // Asset'in Tipini ve Ã–zelliklerini (Spec) alÄ±yoruz
        const assetsText = (company.assets || []).map(a => 
            `${a.type} ${a.spec} ${a.location}`
        ).join(" ").toLowerCase();

        // d. Projeler (Projects - Obje Dizisi)
        // Proje baÅŸlÄ±ÄŸÄ±nÄ± ve aÃ§Ä±klamasÄ±nÄ± alÄ±yoruz
        const projectsText = (company.projects || []).map(p => 
            `${p.title} ${p.desc} ${p.loc}`
        ).join(" ").toLowerCase();

        // e. Sertifikalar (Certificates)
        // Hem string hem obje formatÄ±nÄ± destekleyelim
        const certsText = (company.certificates || []).map(c => {
            if (typeof c === 'string') return c;
            return `${c.name} ${c.issuer}`;
        }).join(" ").toLowerCase();

        // --- DEVASA ARAMA HAVUZU (HAYSTACK) ---
        // TÃ¼m verileri tek bir uzun metinde birleÅŸtir
        const fullHaystack = `
            ${baseInfo} 
            ${servicesText} 
            ${assetsText} 
            ${projectsText} 
            ${certsText}
        `;

        // Aranan kelime bu dev metnin iÃ§inde geÃ§iyor mu?
        return fullHaystack.includes(q);
    });

    // B. SIRALAMA
    filtered = sortCompanyList(filtered);

    // C. EKRANA BASMA
    drawCardsToScreen(filtered, "search");
}

    // 4. BAÅžLATICI VE YÃ–NETÄ°CÄ° (Controller)
    function initShowcaseSystem() {
        // Ä°lk aÃ§Ä±lÄ±ÅŸta bir kere vitrini gÃ¶ster
        renderShowcase();

        // 5 Saniyede bir deÄŸiÅŸtiren zamanlayÄ±cÄ±yÄ± baÅŸlat
        startShowcaseTimer();
    }

    function startShowcaseTimer() {
        if (showcaseInterval) clearInterval(showcaseInterval);
        
        showcaseInterval = btonSetInterval("showcaseInterval", () => {
            // Sadece arama yapÄ±lmÄ±yorsa vitrini yenile
            if (!isSearchActive) {
                renderShowcase();
            }
        }, 10000); // 10000 ms = 10 saniye
    }

    // Arama kutusuna her basÄ±ldÄ±ÄŸÄ±nda bu Ã§alÄ±ÅŸacak
    // (Eski renderCards yerine bunu kullanacaÄŸÄ±z)


// Read the current fixed header height (uses CSS variable)
function btonNavOffset(extra = 0) {
    const v = getComputedStyle(document.documentElement).getPropertyValue('--bton-nav-h').trim();
    const base = parseInt(v, 10);
    return (Number.isFinite(base) ? base : 96) + extra;
}

// Smooth-scroll to "How BTrustOn Works" so the full section starts below the header
function scrollToHowSection() {
    const el = document.getElementById("how-section");
    if (!el) return;

    const offset = btonNavOffset(18); // header + breathing space
    const y = el.getBoundingClientRect().top + window.pageYOffset;

    window.scrollTo({
        top: Math.max(y - offset, 0),
        behavior: "smooth"
    });

    // Subtle arrival highlight
    try {
        el.classList.add("bton-spotlight");
        setTimeout(() => el.classList.remove("bton-spotlight"), 950);
    } catch (e) {}
}

// Smooth-scroll to results so the "Search results" count is always visible
function scrollToResults() {
    const isMobile = (window.matchMedia && window.matchMedia("(max-width: 768px)").matches);
    const el = document.getElementById(isMobile ? "card-container" : "live-showcase");
    if (!el) return;

    const offset = btonNavOffset(22); // header + breathing space (mobile/desktop aware)
    const y = el.getBoundingClientRect().top + window.pageYOffset;

    window.scrollTo({
        top: Math.max(y - offset, 0),
        behavior: "smooth"
    });
}

    // Search input hardening: debounce to reduce re-render thrash while typing
    
    function btonIsMobile() {
        try { return window.matchMedia && window.matchMedia("(max-width: 768px)").matches; } catch (e) { return false; }
    }
    function btonSetMobileSearchActive(active) {
        try {
            if (!btonIsMobile()) return;
            document.body.classList.toggle("bton-mobile-search-active", !!active);
        } catch (e) {}
    }

let __searchDebounceTimer = null;
    let __searchLastQuery = "";

    function handleSearchInput(value) {
        try {
            const query = (value || "").trim();
            const isDefaultState =
                (query === "" &&
                 currentSector === "all" &&
                 currentCountryFilter === "all" &&
                 currentSortOption === "recommended");

            if (isDefaultState) {
                isSearchActive = false;
                try {
                    if (__searchDebounceTimer) {
                        clearTimeout(__searchDebounceTimer);
                        __searchDebounceTimer = null;
                    }
                } catch (e) {}
                /* Mobile: feed-first. No showcase unless user searches. */
                try { btonSetMobileSearchActive(false); } catch (e) {}
                if (btonIsMobile()) return;
                renderShowcase();
                return;
            }

            isSearchActive = true;
            try { btonSetMobileSearchActive(true); } catch (e) {}
            __searchLastQuery = query;

            try { if (__searchDebounceTimer) clearTimeout(__searchDebounceTimer); } catch (e) {}
            __searchDebounceTimer = setTimeout(() => {
                try {
                    renderSearchResults(__searchLastQuery);
                } catch (e) {
                    try { btonDbg("renderSearchResults error:", e); } catch(_) {}
                }
            }, 120);
        } catch (e) {
            try { btonDbg("handleSearchInput error:", e); } catch(_) {}
        }
    }
    
    // SektÃ¶r ButonlarÄ± iÃ§in GÃ¼ncelleme
    // (Mevcut filterSector fonksiyonunuzun iÃ§inden burayÄ± Ã§aÄŸÄ±racaÄŸÄ±z)
    // AÅŸaÄŸÄ±daki fonksiyonu eskisiyle deÄŸiÅŸtirin veya entegre edin.
/* --- FÄ°LTRELEME VE SIRALAMA SÄ°STEMÄ° (ÃœLKE & SORT) --- */
    
    let currentCountryFilter = "all";
    let currentSortOption = "recommended";

    // 1. Åžehirden Ãœlkeyi AyÄ±kla (Ã–rn: "Ankara, TR" -> "TR")
    function getCountryFromCity(cityString) {
        if (!cityString) return "";
        if (cityString.includes(",")) {
            return cityString.split(",")[1].trim(); 
        }
        return cityString.trim(); // VirgÃ¼l yoksa direkt kendisini al
    }

    // 2. Ãœlke Kutusunu Doldur
    /* --- GÃœNCELLENMÄ°Åž: populateCountryFilter (DÄ°REKT VERÄ°DEN) --- */
function populateCountryFilter() {
    const countrySet = new Set();
    
    // VeritabanÄ±ndaki "country" alanlarÄ±nÄ± topla
    database.forEach(c => {
        if(c.country) countrySet.add(c.country);
    });

    const select = document.getElementById("country-filter");
    if(select) {
        const prev = select.value;
        select.innerHTML = '<option value="all">' + (t("filter_all_countries") || "All Countries") + '</option>';
        
        Array.from(countrySet)
          .sort((a,b) => String(localizeCountryName(a)).localeCompare(String(localizeCountryName(b)), currentLang || 'en'))
          .forEach(country => {
            const option = document.createElement("option");
            option.value = country;
            option.textContent = localizeCountryName(country);
            select.appendChild(option);
          });
        try { if (prev) select.value = prev; } catch(e) {}
    }
}

    // 3. Ãœlke DeÄŸiÅŸince Ã‡alÄ±ÅŸÄ±r
    function handleCountryChange(countryVal) {
        currentCountryFilter = countryVal;

        const searchInput = document.getElementById("search-input");
        const query = searchInput ? searchInput.value.trim() : "";

        const noFilters = (!query && currentSector === "all" && currentCountryFilter === "all" && currentSortOption === "recommended");
        if (noFilters) {
            // Back to Live Showcase
            isSearchActive = false;
            renderShowcase();
            startShowcaseTimer();
            return;
        }

        // Filtered list mode
        isSearchActive = true;
        renderSearchResults(query);
    }

    // 4. SÄ±ralama DeÄŸiÅŸince Ã‡alÄ±ÅŸÄ±r
    function handleSortChange(sortValue) {
        currentSortOption = sortValue;

        const searchInput = document.getElementById("search-input");
        const query = searchInput ? searchInput.value.trim() : "";

        // If user selects "Recommended" with no active filters, keep the rotating Live Showcase
        const noFilters = (!query && currentSector === "all" && currentCountryFilter === "all" && currentSortOption === "recommended");
        if (noFilters) {
            isSearchActive = false;
            renderShowcase();
            startShowcaseTimer();
            return;
        }

        // Otherwise show a stable sorted list
        isSearchActive = true;
        renderSearchResults(query);
    }

    // 5. Listeyi SÄ±ralayan YardÄ±mcÄ± Fonksiyon
    function sortCompanyList(list) {
        const sorted = [...list]; // KopyasÄ±nÄ± al

        const isVerified = (c) => (typeof isCompanyVerified === "function") ? isCompanyVerified(c) : false;

        const isPro = (c) => String((c && c.subscription_tier) || "free").toLowerCase() === "pro";
        const safeName = (c) => String((c && c.name) || "");

        switch (currentSortOption) {
            case "recommended": // Ã–nerilen: Verified + Pro + A-Z
                sorted.sort((a, b) => {
                    const v = Number(isVerified(b)) - Number(isVerified(a));
                    if (v) return v;
                    const p = Number(isPro(b)) - Number(isPro(a));
                    if (p) return p;
                    return safeName(a).localeCompare(safeName(b));
                });
                break;

            case "verified_first": // Verified Ã¶nce
                sorted.sort((a, b) => {
                    const v = Number(isVerified(b)) - Number(isVerified(a));
                    if (v) return v;
                    return safeName(a).localeCompare(safeName(b));
                });
                break;

            case "year_oldest": // YÄ±l: Eskiden Yeniye
                sorted.sort((a, b) => (parseInt(a.year_label)||2023) - (parseInt(b.year_label)||2023));
                break;

            case "year_newest": // YÄ±l: Yeniden Eskiye
                sorted.sort((a, b) => (parseInt(b.year_label)||2023) - (parseInt(a.year_label)||2023));
                break;

            case "name_desc": // Ä°sim: Z-A
                sorted.sort((a, b) => safeName(b).localeCompare(safeName(a)));
                break;

            case "name_asc": // Ä°sim: A-Z
            default:
                sorted.sort((a, b) => safeName(a).localeCompare(safeName(b)));
                break;
        }
        return sorted;
    }
// --- TEKLÄ°F FORMU GÃ–NDERME (YENÄ°) ---
// Teklif ModalÄ±nÄ± AÃ§ma (ID parametresi eklendi)
/* --- GÃœNCELLENMÄ°Åž: openQuoteModal (MÄ°SAFÄ°R DOSYA KÄ°LÄ°DÄ° GERÄ° GELDÄ°) --- */
async function openQuoteModal(companyId, companyName) {
  // 1. Hedef bilgilerini doldur
  const targetNameEl = document.getElementById("quote-target-company");
  const inputName = document.getElementById("input-target-company");
  const inputId = document.getElementById("input-target-id");

  if (targetNameEl) targetNameEl.textContent = companyName || "";
  if (inputName) inputName.value = companyName || "";
  if (inputId) inputId.value = companyId || ""; 

  // 2. KULLANICI KONTROLÃœ VE DOSYA KUTUSU AYARI
  const { data: { session } } = await supabaseClient.auth.getSession();

  // EMAIL: ÃœYE Ä°SE EMAIL Ä°STEME, MÄ°SAFÄ°RSE ZORUNLU
  const quoteEmailInput = document.getElementById("quote-email-input") || document.querySelector("#modal-quote input[name='email']");
  const quoteEmailRow = document.getElementById("quote-email-row") || (quoteEmailInput ? quoteEmailInput.closest("div") : null);

  if (quoteEmailInput) {
    if (session && session.user) {
      const autoEmail = String(session.user.email || "").trim();
      if (autoEmail) quoteEmailInput.value = autoEmail;
      quoteEmailInput.required = false;
      quoteEmailInput.readOnly = true;
      quoteEmailInput.classList.add("opacity-70");
      // âœ… Logged-in users: email is taken from session; do not show it in UI.
      if (quoteEmailRow) quoteEmailRow.classList.add("hidden");
    } else {
      quoteEmailInput.readOnly = false;
      quoteEmailInput.required = true;
      quoteEmailInput.value = ""; // guest: clear any cached email
      quoteEmailInput.classList.remove("opacity-70");
      // âœ… Guests: email is required and visible.
      if (quoteEmailRow) quoteEmailRow.classList.remove("hidden");
    }
  }


  
  const fileInput = document.getElementById("quote-file");
  const fileLabel = fileInput.closest("label"); // "Select File" butonu
  const fileNameDisplay = document.getElementById("quote-file-name");
  const container = fileLabel.parentElement; // KapsayÄ±cÄ± div

  // UyarÄ± mesajÄ± daha Ã¶nce eklenmemiÅŸse oluÅŸtur (Dinamik Ekleme)
  let warningMsg = document.getElementById("guest-file-warning");
  if (!warningMsg) {
      warningMsg = document.createElement("span");
      warningMsg.id = "guest-file-warning";
      warningMsg.className = "text-[10px] text-amber-600 font-bold ml-2 hidden items-center gap-1";
      // TÄ±klayÄ±nca Ã¶nce Quote modalÄ±nÄ± kapatÄ±r, sonra Join modalÄ±nÄ± aÃ§ar
      const __joinTpl = (t("ui_attach_requires_join_tpl") || "Please {link}.");
      const __joinLinkText = (t("ui_attach_requires_join_link") || "join to attach files");
      const __joinLink = `<a href="javascript:void(0)" onclick="toggleModal('modal-quote'); setTimeout(() => toggleModal('modal-join'), 200)" class="underline hover:text-amber-800">${__joinLinkText}</a>`;
      warningMsg.innerHTML = `<i class="fa-solid fa-lock"></i> ${__joinTpl.replace("{link}", __joinLink)}`;
      container.appendChild(warningMsg);
  }

  if (session) {
      // --- ÃœYE Ä°SE: Dosya seÃ§imi SERBEST ---
      fileInput.disabled = false;
      
      // GÃ¶rseli normal hale getir
      fileLabel.classList.remove("opacity-50", "cursor-not-allowed", "bg-gray-100");
      fileLabel.classList.add("cursor-pointer", "hover:bg-gray-50");
      fileLabel.title = ""; 
      
      // UyarÄ±yÄ± gizle
      warningMsg.classList.add("hidden");
      fileNameDisplay.classList.remove("hidden");
  } else {
      // --- MÄ°SAFÄ°R Ä°SE: Dosya seÃ§imi YASAK ---
      fileInput.disabled = true; // TÄ±klamayÄ± engelle
      fileInput.value = ""; // Varsa seÃ§ili dosyayÄ± temizle
      fileNameDisplay.textContent = "";

      // GÃ¶rseli pasif (gri) hale getir
      fileLabel.classList.add("opacity-50", "cursor-not-allowed", "bg-gray-100");
      fileLabel.classList.remove("cursor-pointer", "hover:bg-gray-50");
      fileLabel.title = (t("ui_login_required_to_attach_files") || "Login required to attach files"); 
      
      // UyarÄ±yÄ± gÃ¶ster ve dosya ismini gizle
      warningMsg.classList.remove("hidden");
      fileNameDisplay.classList.add("hidden");
  }

  // 3. ModalÄ± AÃ§
  toggleModal("modal-quote");
}
// Teklifi VeritabanÄ±na GÃ¶nderme
/* --- GÃœNCELLENMÄ°Åž: handleQuoteSubmit (MÄ°SAFÄ°R DESTEKLÄ°) --- */
async function handleQuoteSubmit() {
  const btn = document.querySelector("#modal-quote button[type='submit']");
  const originalText = btn.textContent;
  btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${(t("ui_sending") || "Sending")}...`;
  btn.disabled = true;

  try {
    // Mevcut oturumu kontrol et
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session ? session.user : null;

    // Form verilerini al
    const targetId = document.getElementById("input-target-id").value;
    const targetName = document.getElementById("input-target-company").value;
    const senderName = document.querySelector("#modal-quote input[name='name']").value.trim(); 
    let senderEmail = document.querySelector("#modal-quote input[name='email']").value.trim(); // Email inputu HTML'de var varsayÄ±yorum
    // Ãœye ise: emaili oturumdan al (formdan istemiyoruz)
    if (user && user.email) senderEmail = String(user.email).trim();
    const subjectRaw = document.getElementById("quote-subject").value.trim();
    const messageRaw = document.querySelector("#modal-quote textarea[name='message']").value;
    const fileInput = document.getElementById("quote-file");

    let finalContent = messageRaw;
    let senderIdToSend = null;
    let displaySenderName = senderName;

    // 1. KULLANICI LOGIC'Ä°
    if (user) {
        // KayÄ±tlÄ± kullanÄ±cÄ±
        senderIdToSend = user.id;
        let myCompanyName = "Private User";
        try {
          const myP = await btonGetMyCompanyProfileFresh(true);
          if (myP && myP.company_name) myCompanyName = myP.company_name;
        } catch(e) {}
        displaySenderName = `${senderName} (${myCompanyName})`;
    } else {
        // 2. MÄ°SAFÄ°R LOGIC'Ä° (GUEST)
        // Ä°letiÅŸim bilgilerini mesaja ekle
        finalContent = `${(t("guest_request_header") || "--- GUEST REQUEST ---")}\n${(t("guest_label_name") || "Name")}: ${senderName}\n${(t("guest_label_email") || "Email")}: ${senderEmail}\n---------------------\n\n${messageRaw}`;
        displaySenderName = `${senderName} (${(t("guest_tag") || t("label_guest") || "Guest")})`;
        
        // Misafir email girmemiÅŸse uyar
        if(!senderEmail) {
            throw new Error((t("guest_email_required") || "Please enter your email so they can reply."));
        }
    }

    // Dosya varsa yÃ¼kle
    if (fileInput.files && fileInput.files[0]) {
        // Misafirler iÃ§in de dosya yÃ¼klemeye izin veriyoruz (Supabase bucket policy 'public' ise Ã§alÄ±ÅŸÄ±r)
        // EÄŸer Ã§alÄ±ÅŸmazsa try-catch ile yakalayabiliriz ama genelde auth gerekir. 
        // *GÃ¼venlik notu: Misafir upload'u iÃ§in storage bucket policy'sini de 'public insert' yapmak gerekir.
        // Åžimdilik sadece user varsa yÃ¼klesin diyebiliriz veya bucket ayarÄ±nÄ± aÃ§malÄ±sÄ±nÄ±z.
        if(user) {
            showToast((t("toast_uploading") || "Uploading..."), (t("ui_attaching_file") || "Attaching your file..."), "info");
            const publicUrl = await uploadFileToSupabase(fileInput.files[0], 'quotes');
            finalContent += `\n\n[FILE_ATTACHMENT|${fileInput.files[0].name}|${publicUrl}]`;
        } else {
             finalContent += `\n\n(${t("ui_file_attachment_skipped_login_required") || "File attachment skipped - Login required to attach files"})`;
        }
    }
    // MesajÄ± GÃ¶nder
    // âœ… Claim-aware: messages use auth.user ids. We must resolve the target company's owner user id.
    let receiverUserId = null;
    try {
        if (targetId && typeof isUuid === 'function' && isUuid(targetId)) {
            const { data: tp, error: tpErr } = await supabaseClient
                .from('profiles')
                .select('owner_user_id, company_name, email')
                .eq('id', targetId)
                .maybeSingle();
            if (tpErr) throw tpErr;

            // If profile exists but is not claimed yet, we cannot route to a user inbox (FK would fail).
            if (tp && tp.owner_user_id) {
                receiverUserId = tp.owner_user_id;
            } else {
                throw new Error((t("ui_company_not_claimed_cant_message") || "This company hasn't claimed its profile yet, so you can't send a request via inbox."));
            }
        } else {
            throw new Error((t("ui_invalid_company") || "Invalid company target."));
        }
    } catch (e) {
        throw e;
    }


    const { error } = await supabaseClient.from('messages').insert([{
          sender_id: senderIdToSend, // Misafir ise NULL gider
          receiver_id: receiverUserId,
          subject: user ? subjectRaw : `[LEAD] ${subjectRaw}`, // Misafir mesajÄ± belli olsun
          content: finalContent,
          related_company_name: displaySenderName, 
          msg_type: 'quote',
          is_read: false
      }]);

    if (error) throw error;

    showToast("Success", `Request sent to ${targetName}. They will contact you via email.`, "success");
    toggleModal('modal-quote');
    document.querySelector("#modal-quote form").reset();
    document.getElementById('quote-file-name').textContent = ""; 

    // EÄŸer giriÅŸ yapmÄ±ÅŸsa Sent kutusunu gÃ¼ncelle
    if(user) {
        manualInboxUpdate(receiverUserId, subjectRaw, finalContent, true);
        const panel = document.getElementById("inbox-panel");
        if (panel && !panel.classList.contains("open")) toggleInbox();
        switchInboxView('sent');
    }

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}
// 1. TEK BÄ°R SOHBETÄ° SÄ°L (HEM GELENÄ° HEM GÄ°DENÄ° SÄ°LER)
/* --- GÃœNCELLENMÄ°Åž: deleteThread (MÄ°SAFÄ°R SÄ°LME FÄ°XLENDÄ°) --- */
function deleteThread(msgId, title, partnerId, event) {
    if(event) { event.stopPropagation(); event.preventDefault(); }

    openDeleteModal((t("inbox_confirm_remove_conversation") || "Remove this conversation view?"), async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error((t("auth_login_required") || "Login required"));

            const cleanSearchTitle = title.replace(/^(Re:\s*)+/i, '').trim();

            // Misafir KontrolÃ¼ (ID null mu, 'null' stringi mi?)
            const isGuest = !partnerId || partnerId === 'null' || partnerId === 'undefined';

            // 1. BENÄ°M GÃ–NDERDÄ°KLERÄ°MÄ° SÄ°L (sender_delete = true)
            // (Normalde misafire mesaj atamÄ±yoruz ama sistem tutarlÄ±lÄ±ÄŸÄ± iÃ§in kalsÄ±n)
            let querySent = supabaseClient
                .from('messages')
                .update({ sender_delete: true })
                .eq('sender_id', user.id)
                .ilike('subject', `%${cleanSearchTitle}%`);

            if (isGuest) {
                // EÄŸer alÄ±cÄ± misafirse (teorik olarak), receiver_id NULL'dur
                querySent = querySent.filter('receiver_id', 'is', 'null');
            } else {
                querySent = querySent.eq('receiver_id', partnerId);
            }

            // 2. BANA GELENLERÄ° SÄ°L (receiver_delete = true) -> ASIL Ã–NEMLÄ° KISIM BURASI
            let queryReceived = supabaseClient
                .from('messages')
                .update({ receiver_delete: true })
                .eq('receiver_id', user.id)
                .ilike('subject', `%${cleanSearchTitle}%`);

            if (isGuest) {
                // âœ… DÃœZELTME: .eq('sender_id', 'null') YERÄ°NE .filter('sender_id', 'is', 'null')
                // Bu sayede veritabanÄ± "UUID hatasÄ±" vermez, boÅŸ olanlarÄ± bulur.
                queryReceived = queryReceived.filter('sender_id', 'is', 'null');
            } else {
                queryReceived = queryReceived.eq('sender_id', partnerId);
            }

            // Ä°ki iÅŸlemi de paralel Ã§alÄ±ÅŸtÄ±r
            const [res1, res2] = await Promise.all([querySent, queryReceived]);

            if (res1.error) throw res1.error;
            if (res2.error) throw res2.error;

            // Ekran listesinden anÄ±nda kaldÄ±r
            inboxData = inboxData.filter(m => {
                // EÄŸer bu satÄ±rÄ±n partnerId'si bizim silmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zla aynÄ±ysa LÄ°STEDEN AT
                // Hem 'null' string hem de null deÄŸer kontrolÃ¼ yapÄ±yoruz
                const itemPartnerId = m.partner_id || 'null';
                const targetPartnerId = partnerId || 'null';
                
                // BaÅŸlÄ±k ve ID eÅŸleÅŸiyorsa filtrele (yani sil)
                if (String(itemPartnerId) === String(targetPartnerId) && m.title === title) {
                    return false; 
                }
                return true;
            });
            
            renderInboxItems();
            showToast((t("toast_removed") || "Removed"), (t("inbox_conversation_removed") || (currentLang==="tr" ? "KonuÅŸma kaldÄ±rÄ±ldÄ±." : "Conversation removed.")), "success");

        } catch (error) {
            console.error("Delete Error Details:", error);
            showToast("Error", "Could not remove thread: " + error.message, "error");
        }
    });
}
/* --- YENÄ° YARDIMCI FONKSÄ°YON: Dosya YÃ¼kle ve Link Al --- */
async function uploadFileToSupabase(file, folder = 'uploads') {
    if (!file) return null;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("User not logged in");

    // Benzersiz dosya ismi oluÅŸtur: user_id + timestamp + orjinal isim
    const fileExt = file.name.split('.').pop();
    const cleanName = file.name.replace(/[^a-zA-Z0-9]/g, '_'); // TÃ¼rkÃ§e karakter sorununu Ã¶nlemek iÃ§in
    const filePath = `${folder}/${user.id}-${nowTs()}-${cleanName}.${fileExt}`;

    // 1. Storage'a YÃ¼kle (Bucket adÄ± 'logos' veya 'files' olmalÄ±. 
    // Sizin kodunuzda 'logos' bucket'Ä± var gibi gÃ¶rÃ¼nÃ¼yor, onu kullanalÄ±m)
    const { error: uploadError } = await supabaseClient.storage
        .from('logos') 
        .upload(filePath, file);

    if (uploadError) throw uploadError;

    // 2. Public URL Al (TÄ±klanabilir Link)
    const { data } = supabaseClient.storage
        .from('logos')
        .getPublicUrl(filePath);

    return data.publicUrl;
}
/* --- EKSÄ°K OLAN FONKSÄ°YON: Profil Logosuna TÄ±klama --- */
function triggerProfileLogoUpload() {
    // GÃ¼venlik KontrolÃ¼: Åžu an ekranda aÃ§Ä±k olan ÅŸirket benim ÅŸirketim mi?
    const myId = localStorage.getItem("BTrustOn_my_company_id");
    
    if (selectedCompany && String(selectedCompany.id) === String(myId)) {
        // Gizli inputa tÄ±kla
        document.getElementById('profile-logo-input').click();
    } else {
        // BaÅŸkasÄ±nÄ±n profili ise tÄ±klanmasÄ±n (Opsiyonel: FotoÄŸrafÄ± bÃ¼yÃ¼tebilirsiniz)
        console.log("Cannot edit another company's logo.");
    }
}
/* --- YENÄ° YARDIMCI: Sohbet Balonunu AnÄ±nda Ekrana Bas --- */
function appendLocalMessage(content) {
    const container = document.getElementById("message-thread-container");
    if (!container) return;

    // EÄŸer "Start conversation..." yazÄ±sÄ± varsa temizle
    if ((container.innerHTML.includes("Start the conversation") || container.innerHTML.includes(t("inbox_start_conversation") || "Start the conversation"))) container.innerHTML = "";

    // Tarih
    const time = formatMsgClock(nowDate());

    // SatÄ±r baÅŸlarÄ±nÄ± <br> yap
    let cleanContent = content.replace(/\n/g, '<br>');
    
    // Dosya eki formatÄ±nÄ± gÃ¶rselleÅŸtir (Opsiyonel)
    if (cleanContent.includes("[FILE_ATTACHMENT")) {
        cleanContent = cleanContent.replace(/\[FILE_ATTACHMENT\|(.*?)\|(.*?)\]/g, 
            '<div class="flex items-center gap-2 mt-2 p-2 bg-white border rounded-lg"><i class="fa-solid fa-paperclip text-BTrustOn-accent"></i> <span class="text-xs font-bold">$1</span></div>'
        );
    }

    const bubble = document.createElement("div");
    bubble.className = `flex justify-end mb-4 animate-fade-in`; // Biz gÃ¶nderdiÄŸimiz iÃ§in hep saÄŸda (justify-end)
    
    bubble.innerHTML = `
        <div class="max-w-[85%] bg-cyan-50 border border-cyan-100 rounded-tr-none p-4 rounded-xl shadow-sm">
            <div class="flex justify-between items-center mb-1 gap-4">
                <span class="text-[10px] font-bold text-BTrustOn-accent">${(t("inbox_me_label") || "ME")}</span>
                <span class="text-[9px] text-gray-400">${time}</span>
            </div>
            <div class="text-sm text-gray-700 leading-relaxed break-words">
                ${cleanContent}
            </div>
        </div>
    `;
    
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight; // En alta kaydÄ±r
}
/* --- YENÄ° YARDIMCI: DosyayÄ± Ä°ndirmeye Zorla --- */
async function downloadFile(fileUrl, fileName) {
    // TÄ±klama olayÄ±nÄ±n yukarÄ± (karta) gitmesini engelle (eÄŸer iÃ§ iÃ§e ise)
    if(event) { event.stopPropagation(); event.preventDefault(); }

    showToast("Downloading...", "Please wait while the file is prepared.", "info");

    try {
        // 1. DosyayÄ± veritabanÄ±ndan Ã§ek
        const response = await fetch(fileUrl);
        if (!response.ok) throw new Error("Network response was not ok");
        
        // 2. Veriyi Blob formatÄ±na Ã§evir
        const blob = await response.blob();
        
        // 3. GeÃ§ici bir indirme linki oluÅŸtur
        const blobUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = fileName; // Ä°ndirilecek dosyanÄ±n adÄ±
        
        // 4. Linke tÄ±kla ve temizle
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(blobUrl);

        showToast("Saved", "File downloaded successfully.", "success");

    } catch (error) {
        console.error("Download failed:", error);
        // Hata olursa kullanÄ±cÄ±yÄ± uyar ve yeni sekmede aÃ§mayÄ± dene (Yedek plan)
        showToast("Error", "Download failed, opening in new tab...", "error");
        window.open(fileUrl, '_blank');
    }
}
/* --- STATUS RENGÄ°NÄ° AYARLAYAN FONKSÄ°YON --- */
function getStatusBadgeLegacy(status) {
    const s = (status || "").toLowerCase();
    
    // VarsayÄ±lan (Gri)
    let classes = "bg-gray-50 text-gray-600 border-gray-200"; 

    // 1. MÃ¼sait (YeÅŸil)
    if (s.includes("available") || s.includes("mÃ¼sait")) {
        classes = "bg-emerald-50 text-emerald-700 border-emerald-200";
    } 
    // 2. BakÄ±mda (SarÄ±/Turuncu)
    else if (s.includes("maintenance") || s.includes("bakÄ±m")) {
        classes = "bg-amber-50 text-amber-700 border-amber-200";
    } 
    // 3. Servis DÄ±ÅŸÄ± (KÄ±rmÄ±zÄ±)
    else if (s.includes("out") || s.includes("servis")) {
        classes = "bg-rose-50 text-rose-700 border-rose-200";
    }

    return `
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-[10px] font-bold border ${classes} uppercase tracking-wide whitespace-nowrap">
            ${status}
        </span>
    `;
}
/* --- DOÄžRULAMA SÄ°STEMÄ° MANTIÄžI --- */
/* --- Ã‡Ä°FT TARAFLI DOÄžRULAMA YÃ–NETÄ°MÄ° (EDÄ°TÃ–R + PROFÄ°L) --- */

// 1. BUTONA TIKLANINCA (Upgrade KontrolÃ¼)
/* --- GÃœNCELLENMÄ°Åž: handleVerifyClick (GARANTÄ°LÄ° Ã‡Ã–ZÃœM) --- */
function handleVerifyClick(forceUnlocked = false) {
    // Veri yoksa hata vermesin diye kontrol
    if (!selectedCompany) return;

    const tier = forceUnlocked ? "pro" : (selectedCompany.subscription_tier || "free");

    // 1. KullanÄ±cÄ± PRO ise formu aÃ§
    if (tier === 'pro') {
        toggleVerifyVisibility('unlocked');

        // 2. TarayÄ±cÄ±nÄ±n "hidden" sÄ±nÄ±fÄ±nÄ± kaldÄ±rmasÄ±nÄ± bekle (100ms)
        setTimeout(() => {
            // Hangi ekranÄ±n aÃ§Ä±k olduÄŸunu sÄ±nÄ±f kontrolÃ¼yle anla
            const editorView = document.getElementById("view-editor");
            // EÄŸer view-editor'de 'hidden-view' yoksa, editÃ¶rdeyiz demektir.
            const isEditorActive = editorView && !editorView.classList.contains("hidden-view");

            let targetContainer = null;
            let targetInput = null;

            if (isEditorActive) {
                // EditÃ¶rdeki kutuyu hedefle
                targetContainer = document.getElementById("verify-form-view");
                targetInput = document.getElementById("edit-reg-no");
            } else {
                // Profildeki (Widget) kutuyu hedefle
                targetContainer = document.getElementById("widget-form-view");
                targetInput = document.getElementById("widget-reg-no");
            }

            // Hedef bulunduysa iÅŸlemi yap
            if (targetContainer && targetInput) {
                // A. SayfayÄ± oraya kaydÄ±r (Ortalayarak)
                targetInput.scrollIntoView({ behavior: "smooth", block: "center" });

                // B. Ä°mleci iÃ§ine koy
                targetInput.focus({ preventScroll: true });

                // C. Animasyonu SÄ±fÄ±rla ve Yeniden BaÅŸlat (Reflow Trigger)
                targetContainer.classList.remove("attention-grabber");

                // Bu satÄ±r sihirli: TarayÄ±cÄ±yÄ± deÄŸiÅŸikliÄŸi fark etmeye zorlar
                void targetContainer.offsetWidth;

                targetContainer.classList.add("attention-grabber");

                // D. 1 saniye sonra efekti kaldÄ±r (Tekrar basÄ±lÄ±rsa Ã§alÄ±ÅŸsÄ±n diye)
                setTimeout(() => {
                    targetContainer.classList.remove("attention-grabber");
                }, 1000);
            }
        }, 100);

    }
    // Free ise YÃ¼kseltme ModalÄ±nÄ± AÃ§ (modalÄ± her yerden doÄŸru iÃ§erikle aÃ§)
    else {
        try {
            if (typeof openUpgradeModal === "function") openUpgradeModal();
            else toggleModal('modal-upgrade');
        } catch (_) {
            toggleModal('modal-upgrade');
        }
    }
}
// 2. GÃ–RÃœNÃœMÃœ GÃœNCELLE (YardÄ±mcÄ± Fonksiyon)
function toggleVerifyVisibility(mode) {
    // EditÃ¶r Elementleri
    const editLock = document.getElementById("verify-locked-view");
    const editForm = document.getElementById("verify-form-view");
    
    // Profil Widget Elementleri
    const widgetLock = document.getElementById("widget-locked-view");
    const widgetForm = document.getElementById("widget-form-view");

    if (mode === 'unlocked') {
        if(editLock) editLock.classList.add("hidden");
        if(editForm) editForm.classList.remove("hidden");
        if(widgetLock) widgetLock.classList.add("hidden");
        if(widgetForm) widgetForm.classList.remove("hidden");
    } else {
        if(editLock) editLock.classList.remove("hidden");
        if(editForm) editForm.classList.add("hidden");
        if(widgetLock) widgetLock.classList.remove("hidden");
        if(widgetForm) widgetForm.classList.add("hidden");
    }
}

/* =========================
   VERIFIED BADGE (Registry-based verification)
   - Stores: profiles.registry_country / registry_region / registry_number / registry_url
   - Creates audit rows in: verification_requests
========================= */

function normalizeCountryKey(raw) {
  const v = String(raw || "").trim();
  if (!v) return "";
  const up = v.toUpperCase();
  if (up.length === 2) return up;

  const low = v.toLowerCase();
  const map = {
    "united states": "US",
    "usa": "US",
    "u.s.": "US",
    "u.s.a.": "US",
    "united states of america": "US",
    "canada": "CA",
    "turkey": "TR",
    "tÃ¼rkiye": "TR",
    "uk": "GB",
    "united kingdom": "GB",
    "england": "GB",
    "germany": "DE",
    "france": "FR",
    "spain": "ES",
    "italy": "IT",
    "netherlands": "NL",
    "belgium": "BE",
    "switzerland": "CH",
    "austria": "AT",
    "sweden": "SE",
    "norway": "NO",
    "denmark": "DK",
    "finland": "FI",
    "poland": "PL",
    "czechia": "CZ",
    "czech republic": "CZ",
    "portugal": "PT",
    "ireland": "IE",
    "romania": "RO",
    "bulgaria": "BG",
    "greece": "GR",
    "brazil": "BR",
    "argentina": "AR",
    "chile": "CL",
    "colombia": "CO",
    "peru": "PE",
    "mexico": "MX",
    "australia": "AU",
    "new zealand": "NZ",
    "south africa": "ZA",
    "saudi arabia": "SA",
    "united arab emirates": "AE",
    "qatar": "QA"
  };
  return map[low] || up; // last resort: keep stable
}

function getRegistryRule(countryKey) {
  const c = String(countryKey || "").toUpperCase();

  // Defaults
  const rule = {
    regLabel: (t("lbl_reg_no") || "Registration No."),
    regPlaceholder: (t("ph_reg_no") || "Registration / Entity number"),
    help: (t("help_reg_default") || "Use your official registration / tax entity number. You can also add a registry link."),
    showRegion: false,
    regionLabel: "State / Region",
    regionPlaceholder: "e.g., Delaware",
    regionRequired: false
  };

  if (c === "US") {
    rule.regLabel = (t("lbl_reg_no_us") || "Registration No.");
    rule.regPlaceholder = (t("ph_reg_no_us") || "EIN / Entity number (varies by state)");
    rule.help = (t("help_reg_us") || "US: Enter your official EIN or State Entity Number. State is required for faster verification.");
    rule.showRegion = true;
    rule.regionLabel = (t("lbl_state") || "State");
    rule.regionPlaceholder = (t("ph_state") || "e.g., Delaware");
    rule.regionRequired = true;
  } else if (c === "CA") {
    rule.regPlaceholder = (t("ph_reg_no_ca") || "Business Number (BN) / Corporation number");
    rule.help = (t("help_reg_ca") || "Canada: Use your Business Number (BN) or your provincial/territorial corporation number.");
    rule.showRegion = true;
    rule.regionLabel = (t("lbl_province") || "Province / Territory");
    rule.regionPlaceholder = (t("ph_province") || "e.g., Ontario");
    rule.regionRequired = false;
  } else if (["GB","DE","FR","ES","IT","NL","BE","CH","AT","SE","NO","DK","FI","PL","CZ","PT","IE","RO","BG","GR"].includes(c)) {
    rule.regPlaceholder = (t("ph_reg_no_eu") || "Company registration number (e.g., VAT / Trade register)");
    rule.help = (t("help_reg_eu") || "Europe: Use your company registration number (trade register / VAT / national ID).");
  } else if (["BR","AR","CL","CO","PE","MX"].includes(c)) {
    rule.regPlaceholder = (t("ph_reg_no_latam") || "Official company registration / tax ID");
    rule.help = (t("help_reg_latam") || "South America: Use your official company registration / tax ID.");
  }

  return rule;
}

function _getCountryForVerificationUI() {
  // Prefer editor selection when open (user may change country)
  const cSel = document.getElementById("edit-country");
  const raw = (cSel && cSel.value) ? cSel.value : (selectedCompany && (selectedCompany.registry_country || selectedCompany.country)) || "";
  return normalizeCountryKey(raw);
}

function updateRegistryVerificationUI() {
  const key = _getCountryForVerificationUI();
  const rule = getRegistryRule(key);

  // Editor
  const eReg = document.getElementById("edit-reg-no");
  const eHelp = document.getElementById("edit-regno-help");
  const eRegionWrap = document.getElementById("edit-regregion-wrap");
  const eRegionLabel = document.getElementById("edit-regregion-label");
  const eRegionInput = document.getElementById("edit-reg-region");

  if (eReg) {
    try { eReg.placeholder = rule.regPlaceholder || eReg.placeholder; } catch(_) {}
  }
  if (eHelp) eHelp.textContent = rule.help || "";
  if (eRegionWrap) {
    if (rule.showRegion) eRegionWrap.classList.remove("hidden");
    else eRegionWrap.classList.add("hidden");
  }
  if (eRegionLabel) eRegionLabel.textContent = rule.regionLabel || "State / Region";
  if (eRegionInput) {
    try { eRegionInput.placeholder = rule.regionPlaceholder || eRegionInput.placeholder; } catch(_) {}
    try { eRegionInput.required = !!rule.regionRequired; } catch(_) {}
  }

  // Registry link placeholders (i18n)
  const eUrl = document.getElementById("edit-reg-url");
  if (eUrl) {
    try { eUrl.placeholder = (t("ph_registry_link_optional") || "Official registry URL (optional)"); } catch(_) {}
  }


  // Widget
  const wReg = document.getElementById("widget-reg-no");
  const wHelp = document.getElementById("widget-regno-help");
  const wRegionWrap = document.getElementById("widget-regregion-wrap");
  const wRegionLabel = document.getElementById("widget-regregion-label");
  const wRegionInput = document.getElementById("widget-reg-region");

  if (wReg) {
    try { wReg.placeholder = rule.regPlaceholder || wReg.placeholder; } catch(_) {}
  }
  if (wHelp) wHelp.textContent = rule.help || "";
  if (wRegionWrap) {
    if (rule.showRegion) wRegionWrap.classList.remove("hidden");
    else wRegionWrap.classList.add("hidden");
  }
  if (wRegionLabel) wRegionLabel.textContent = rule.regionLabel || "State / Region";
  if (wRegionInput) {
    try { wRegionInput.placeholder = rule.regionPlaceholder || wRegionInput.placeholder; } catch(_) {}
  }

  // Registry link placeholders (i18n)
  const wUrl = document.getElementById("widget-reg-url");
  if (wUrl) {
    try { wUrl.placeholder = (t("ph_registry_link_optional") || "Official registry URL (optional)"); } catch(_) {}
  }
}

// Keep UI synced when user changes country in editor
document.addEventListener("change", (e) => {
  try {
    if (e && e.target && e.target.id === "edit-country") {
      updateRegistryVerificationUI();
    }
  } catch(_) {}
});

// 3. FORM GÃ–NDERME (Kaynaktan BaÄŸÄ±msÄ±z)
async function submitVerificationRequest(source = 'editor') {
    const btnId = source === 'widget' ? "btn-widget-submit" : "btn-verify-submit";
    const btn = document.getElementById(btnId);

    // Inputs
    const regNoEl = document.getElementById(source === 'widget' ? "widget-reg-no" : "edit-reg-no");
    const regionEl = document.getElementById(source === 'widget' ? "widget-reg-region" : "edit-reg-region");
    const urlEl = document.getElementById(source === 'widget' ? "widget-reg-url" : "edit-reg-url");

    const regNo = (regNoEl && regNoEl.value) ? regNoEl.value.trim() : "";
    const region = (regionEl && regionEl.value) ? regionEl.value.trim() : "";
    const regUrl = (urlEl && urlEl.value) ? urlEl.value.trim() : "";

    // Country rule
    const countryKey = _getCountryForVerificationUI();
    const rule = getRegistryRule(countryKey);

    if (!regNo) {
      showToast("Missing Info", (t("err_regno_required") || "Enter Registration No."), "error");
      handleVerifyClick(source === 'widget'); // shake + focus
      return;
    }
    if (rule.showRegion && rule.regionRequired && !region) {
      showToast("Missing Info", (t("err_state_required") || "State is required for US verification."), "error");
      try {
        if (regionEl) {
          regionEl.scrollIntoView({ behavior: "smooth", block: "center" });
          regionEl.focus({ preventScroll: true });
        }
      } catch(_) {}
      return;
    }

    if (btn) { btn.textContent = (t("ui_wait") || "Wait..."); btn.disabled = true; }

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user || !user.id) throw new Error("Login required");

        // 1) Update profile (single source of truth)
        const profilePayload = {
          registry_country: countryKey || null,
          registry_region: (rule.showRegion ? (region || null) : null),
          registry_number: regNo,
          registry_url: regUrl || null,
          verification_method: 'registry',
          verification_status: 'pending'
        };

        const { error: uErr } = await supabaseClient
          .from('profiles')
          .update(profilePayload)
          .eq('id', myCompanyIdOr(user.id));

        if (uErr) throw uErr;

        // 2) Insert audit request row (best-effort; doesn't block UI if policy isn't ready yet)
        try {
          await supabaseClient
            .from('verification_requests')
            .insert([{
              company_id: myCompanyIdOr(user.id),
              submitted_by: user.id,
              status: 'submitted',
              registry_country: profilePayload.registry_country,
              registry_region: profilePayload.registry_region,
              registry_number: profilePayload.registry_number,
              registry_url: profilePayload.registry_url,
              verification_method: 'registry'
            }]);
        } catch(e) {
          console.warn("verification_requests insert skipped:", e);
        }

        // Local cache update
        selectedCompany.verification_status = 'pending';
        selectedCompany.registry_country = profilePayload.registry_country;
        selectedCompany.registry_region = profilePayload.registry_region;
        selectedCompany.registry_number = profilePayload.registry_number;
        selectedCompany.registry_url = profilePayload.registry_url;
        selectedCompany.verification_method = 'registry';

        // Sync both sides (widget + editor)
        updateVerificationUI('pending');
        try { updateRegistryVerificationUI(); } catch(_) {}

        // Mirror values
        const eReg = document.getElementById("edit-reg-no");
        const wReg = document.getElementById("widget-reg-no");
        const eRegion = document.getElementById("edit-reg-region");
        const wRegion = document.getElementById("widget-reg-region");
        const eUrl = document.getElementById("edit-reg-url");
        const wUrl = document.getElementById("widget-reg-url");

        if (eReg) eReg.value = regNo;
        if (wReg) wReg.value = regNo;
        if (eRegion) eRegion.value = region;
        if (wRegion) wRegion.value = region;
        if (eUrl) eUrl.value = regUrl;
        if (wUrl) wUrl.value = regUrl;

        showToast((t("ui_success") || "Success"), (t("ui_request_sent_for_review") || "Request sent for review."), "success");

    } catch (err) {
        showToast("Error", err.message || "Verification request failed.", "error");
        if (btn) { btn.disabled = false; btn.textContent = (t("ui_submit_82b1fb") || "SUBMIT"); }
    }
}

// 4. UI DURUMUNU GÃœNCELLE (Her Ä°ki Yeri De Boyar)
/* --- GÃœNCELLENMÄ°Åž: updateVerificationUI (ONAYLANINCA KUTULARI GÄ°ZLER) --- */
function updateVerificationUI(status) {
    const tier = selectedCompany.subscription_tier || 'free';
    
    // Pro ise veya iÅŸlem baÅŸladÄ±ysa formu aÃ§
    if (tier === 'pro' || status === 'pending' || status === 'verified') {
        toggleVerifyVisibility('unlocked');
    } else {
        toggleVerifyVisibility('locked');
        return; 
    }

    // --- EDÄ°TÃ–R TARAFI ---
    const editAlert = document.getElementById("verify-status-alert");
    // EditÃ¶rdeki inputlarÄ±n olduÄŸu kapsayÄ±cÄ± (.grid)
    const editInputBox = document.querySelector("#verify-form-view .grid"); 
    // EditÃ¶rdeki butonun olduÄŸu kapsayÄ±cÄ± (.mt-4)
    const editBtnBox = document.querySelector("#verify-form-view .mt-4");

    // --- WIDGET (PROFÄ°L) TARAFI ---
    const widgetAlert = document.getElementById("widget-status-alert");
    // Widget'taki inputlar ve butonun olduÄŸu kapsayÄ±cÄ± (.space-y-3)
    const widgetMainBox = document.querySelector("#widget-form-view .space-y-3");
    // Widget butonu (Pending durumunda sadece butonu gizlemek iÃ§in lazÄ±m)
    const widgetBtn = document.getElementById("btn-widget-submit");

    // YardÄ±mcÄ± Fonksiyon: Duruma GÃ¶re GÃ¶ster/Gizle
    const setStatus = (alertEl, inputBox, btnBox, specificBtn, type) => {
        if(!alertEl) return;
        
        // Alert Stili (Ortak)
        alertEl.className = "mb-3 p-3 rounded-lg text-[10px] font-bold border flex items-center gap-2";

        if (type === 'verified') {
            // âœ… DURUM 1: ONAYLI (Sadece Mesaj KalsÄ±n, Formlar UÃ§sun)
            alertEl.classList.add("bg-emerald-50", "border-emerald-200", "text-emerald-700");
            alertEl.innerHTML = '<i class="fa-solid fa-circle-check"></i> ' + (t("ui_verified_badge_active") || "Verified. Badge active.");
            alertEl.classList.remove("hidden");

            // Form elemanlarÄ±nÄ± komple GÄ°ZLE
            if(inputBox) inputBox.classList.add("hidden");
            if(btnBox) btnBox.classList.add("hidden");
            
            // Widget iÃ§in mainBox gizlenince iÃ§indeki buton da otomatik gizlenir
            if(specificBtn) specificBtn.parentElement.classList.add("hidden"); 

        } else if (type === 'pending') {
            // âœ… DURUM 2: BEKLEMEDE (Mesaj Var, Inputlar Pasif, Buton Yok)
            alertEl.classList.add("bg-amber-50", "border-amber-200", "text-amber-700");
            alertEl.innerHTML = '<i class="fa-solid fa-clock"></i> ' + (t("ui_review_pending_24h") || "Review pending (24h).");
            alertEl.classList.remove("hidden");

            // InputlarÄ± gÃ¶ster ama kilitle
            if(inputBox) {
                inputBox.classList.remove("hidden");
                const inputs = inputBox.querySelectorAll("input");
                inputs.forEach(i => i.disabled = true);
            }

            // Kaydet butonunu gizle (Zaten gÃ¶nderildi)
            if(btnBox) btnBox.classList.add("hidden");
            if(specificBtn) specificBtn.classList.add("hidden");


        } else if (type === 'rejected') {
            // âœ… DURUM 3: REDDEDÄ°LDÄ° (Mesaj Var, Inputlar AÃ§Ä±k, Buton Var)
            alertEl.classList.add("bg-rose-50", "border-rose-200", "text-rose-700");
            const _reasonRaw = (typeof selectedCompany !== "undefined" && selectedCompany && (selectedCompany.verification_reject_reason || selectedCompany.verification_notes)) ? (selectedCompany.verification_reject_reason || selectedCompany.verification_notes) : "";
            const _reason = (_reasonRaw ? String(_reasonRaw).trim() : "");
            const _reasonHtml = _reason ? `<div class="mt-1 text-[10px] font-medium text-rose-700/90">${escapeHtml(_reason)}</div>` : "";
            alertEl.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> ' + (t("ui_verification_rejected") || "Verification rejected.") + _reasonHtml;
            alertEl.classList.remove("hidden");

            // InputlarÄ± gÃ¶ster ve aÃ§Ä±k bÄ±rak
            if(inputBox) {
                inputBox.classList.remove("hidden");
                const inputs = inputBox.querySelectorAll("input");
                inputs.forEach(i => i.disabled = false);
            }

            // Kaydet butonu gÃ¶rÃ¼nÃ¼r (yeniden gÃ¶nderebilsin)
            if(btnBox) btnBox.classList.remove("hidden");
            if(specificBtn) specificBtn.classList.remove("hidden");

        } else {
            // âœ… DURUM 3: HÄ°Ã‡BÄ°RÄ° (Form AÃ§Ä±k, Mesaj Yok)
            alertEl.classList.add("hidden"); // UyarÄ± yok

            if(inputBox) {
                inputBox.classList.remove("hidden");
                const inputs = inputBox.querySelectorAll("input");
                inputs.forEach(i => i.disabled = false);
            }

            if(btnBox) btnBox.classList.remove("hidden");
            if(specificBtn) specificBtn.classList.remove("hidden");
        }
    };

    // EditÃ¶r UI GÃ¼ncelle
    setStatus(editAlert, editInputBox, editBtnBox, null, status);
    
    // Widget (Profil) UI GÃ¼ncelle
    setStatus(widgetAlert, widgetMainBox, null, widgetBtn, status);
}
/* --- ADMIN PANEL SÄ°STEMÄ° --- */

// 1. AYARLAR


// 2. ADMIN KONTROLÃœ (GiriÅŸ yapÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r)
async function checkAdminAccess() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    const adminBtn = document.getElementById("btn-admin-panel");
    
    if (user && (typeof ADMIN_EMAIL !== "undefined") && user.email === ADMIN_EMAIL) {
        if(adminBtn) adminBtn.classList.remove("hidden");
    } else {
        if(adminBtn) adminBtn.classList.add("hidden");
    }
}

// checkUserAndOpenProfile fonksiyonunun en sonuna ÅŸu satÄ±rÄ± ekleyin:
// checkAdminAccess(); 
// (Bunu manuel eklemeyi unutmayÄ±n, yoksa buton Ã§Ä±kmaz)


// 3. ADMIN PANELÄ°NÄ° AÃ‡MA
function showAdminView() {
    // DiÄŸer ekranlarÄ± gizle
    document.getElementById("view-dashboard").classList.add("hidden-view");
    document.getElementById("view-profile").classList.add("hidden-view");
    document.getElementById("view-editor").classList.add("hidden-view");
    document.getElementById("view-admin").classList.remove("hidden-view");
    
    // Verileri yÃ¼kle
    loadAdminData();
    try { loadAdminClaims(); } catch(e) {}
}


// 4. BEKLEYEN Ä°STEKLERÄ° Ã‡EKME
async function loadAdminData() {
    const listContainer = document.getElementById("admin-request-list");
    const countBadge = document.getElementById("admin-pending-count");

    if (!listContainer) return;

    listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-gray-300"></i></td></tr>';

    // Pull pending verification requests (audit table)
    const { data: requests, error } = await supabaseClient
        .from('verification_requests')
        .select('*')
        .eq('status', 'submitted')
        .order('submitted_at', { ascending: false });

    if (error) {
        console.error(error);
        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>';
        return;
    }

    const reqs = Array.isArray(requests) ? requests : [];
    if (countBadge) countBadge.textContent = reqs.length;

    if (reqs.length === 0) {
        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No pending requests found.</td></tr>';
        return;
    }

    // Fetch related company profiles (name/email/logo)
    const ids = Array.from(new Set(reqs.map(r => r.company_id).filter(Boolean)));
    let profileMap = {};
    if (ids.length > 0) {
      const { data: profs, error: pErr } = await supabaseClient
        .from('profiles')
        .select('id, company_name, email, logo_url, country')
        .in('id', ids);

      if (!pErr && Array.isArray(profs)) {
        profs.forEach(p => { profileMap[String(p.id)] = p; });
      }
    }

    listContainer.innerHTML = "";

    reqs.forEach(req => {
        const p = profileMap[String(req.company_id)] || {};
        const cName = p.company_name || "Unknown Company";
        const cEmail = p.email || "";
        const iconLetter = (cName && cName[0]) ? cName[0].toUpperCase() : "?";

        const regNo = req.registry_number || "";
        const regCountry = req.registry_country || normalizeCountryKey(p.country || "");
        const regRegion = req.registry_region || "";

        const regInfo = [regCountry, regRegion, regNo].filter(Boolean).join(" â€¢ ") || "N/A";

        let docLink = '<span class="text-gray-300 text-xs">No link</span>';
        if (req.registry_url) {
          const safe = String(req.registry_url);
          docLink = `<a href="${safe}" target="_blank" class="flex items-center gap-1 text-blue-600 hover:underline font-bold text-xs"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</a>`;
        }

        const dateStr = formatDateTimeMeridiemTR(req.submitted_at || req.created_at || req.updated_at) || "";

        const row = document.createElement("tr");
        row.className = "hover:bg-slate-50 transition";
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gray-200 flex items-center justify-center font-bold text-gray-500">
                        ${iconLetter}
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">${cName}</div>
                        <div class="text-[10px] text-gray-400">${cEmail}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="font-mono text-xs bg-gray-100 px-2 py-1 rounded inline-block text-gray-600">
                    ${regInfo}
                </div>
            </td>
            <td class="px-6 py-4 text-xs text-gray-500">${dateStr}</td>
            <td class="px-6 py-4">${docLink}</td>
            <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                    <button onclick="processVerification('${req.id}', '${req.company_id}', 'reject')" class="w-8 h-8 rounded-lg border border-red-200 text-red-500 hover:bg-red-50 transition flex items-center justify-center" title="Reject">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <button onclick="processVerification('${req.id}', '${req.company_id}', 'approve')" class="px-4 py-2 rounded-lg bg-emerald-500 text-white font-bold text-xs hover:bg-emerald-600 transition shadow-lg shadow-emerald-500/20 flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> APPROVE (Pro)
                    </button>
                </div>
            </td>
        `;
        listContainer.appendChild(row);
    });
}


// 5. ONAYLAMA / REDDETME Ä°ÅžLEMÄ°

// =======================
// CLAIM (Ownership) FLOW
// =======================
async function openClaimCompanyModal(companyId, companyName) {
  try {
    const user = await _getAuthUserSafe();
    if (!user?.id) {
      try { window.__pendingClaimCompanyId = String(companyId || ""); window.__pendingClaimCompanyName = String(companyName || ""); } catch(_){}
      showToast(tOr("ui_claim_requires_login","Login required"), tOr("ui_claim_requires_login","Please sign in to request ownership."), "brand");
      try { openLoginModal(); } catch(e) { try { openJoinModal(); } catch(_) {} }
      return;
    }
  } catch(e) {
    // if auth check fails, still force login modal
    showToast(tOr("ui_claim_requires_login","Login required"), tOr("ui_claim_requires_login","Please sign in to request ownership."), "brand");
    try { openLoginModal(); } catch(e) { try { openJoinModal(); } catch(_) {} }
    return;
  }

  try {
    document.getElementById("claim-company-id").value = String(companyId || "");
    const noteEl = document.getElementById("claim-note");
    if (noteEl) noteEl.value = "";
    toggleModal("modal-claim-company");
  } catch(e) {
    console.error(e);
  }
}

async function submitCompanyClaim() {
  const user = await _getAuthUserSafe();
  if (!user?.id) {
    showToast(tOr("ui_claim_requires_login","Login required"), tOr("ui_claim_requires_login","Please sign in to request ownership."), "brand");
    try { openLoginModal(); } catch(e) { try { openJoinModal(); } catch(_) {} }
    return;
  }

  const companyId = String(document.getElementById("claim-company-id")?.value || "").trim();
  const note = String(document.getElementById("claim-note")?.value || "").trim();
  const requesterEmail = String(user.email || "").trim();

  if (!companyId) {
    showToast("Error", tOr("ui_action_failed","Action failed."), "error");
    return;
  }

  try {
    const payload = {
      company_id: companyId,
      requester_user_id: user.id,
      requester_email: requesterEmail,
      note: note ? note : null,
      status: "pending"
    };

    const { error } = await supabaseClient
      .from("company_claim_requests")
      .insert([payload]);

    if (error) {
      // Unique pending constraint â†’ duplicate request
      if (String(error.code || "") === "23505") {
        showToast("Info", tOr("ui_claim_already_pending","A claim request is already pending for this company."), "brand");
      } else {
        console.error(error);
        showToast("Error", tOr("ui_claim_request_failed","Couldn't submit claim request."), "error");
      }
      return;
    }

    showToast("OK", tOr("ui_claim_submitted","Claim request submitted. We'll review it soon."), "brand");
    try { toggleModal("modal-claim-company"); } catch(e) {}
  } catch (e) {
    console.error(e);
    showToast("Error", tOr("ui_claim_request_failed","Couldn't submit claim request."), "error");
  }
}


/* =======================
   CLAIM WELCOME (ONE-TIME, CROSS-DEVICE)
   - Shows a single celebration modal after admin approves a company claim.
   - Uses DB table: public.claim_welcome_events (user_id, company_id, shown_at).
======================= */
window.__claimWelcome = window.__claimWelcome || { companyId: null, companyName: "" };

function _tFmtOr(key, params, fallback) {
  let s = tOr(key, fallback || "");
  try {
    const obj = (params && typeof params === "object") ? params : {};
    Object.keys(obj).forEach(k => {
      const v = (obj[k] == null) ? "" : String(obj[k]);
      s = s.split(`{${k}}`).join(v);
    });
  } catch(e) {}
  return s;
}

async function __markClaimWelcomeShown(userId, companyId) {
  try {
    if (!userId || !companyId) return;
    await supabaseClient
      .from("claim_welcome_events")
      .update({ shown_at: nowDate().toISOString() })
      .eq("user_id", userId)
      .eq("company_id", companyId)
      .is("shown_at", null);
  } catch(e) {}
}

function openClaimWelcomeModal(companyId, companyName) {
  try {
    window.__claimWelcome.companyId = String(companyId || "");
    window.__claimWelcome.companyName = String(companyName || "");

    const nameEl = document.getElementById("claim-welcome-company-name");
    if (nameEl) nameEl.textContent = window.__claimWelcome.companyName || "â€”";

    const bodyEl = document.getElementById("claim-welcome-body");
    if (bodyEl) {
      bodyEl.textContent = _tFmtOr(
        "ui_claim_welcome_body_fmt",
        { company: window.__claimWelcome.companyName || "" },
        `Congratulations! Your ownership request for ${window.__claimWelcome.companyName || "this company"} has been approved. You can now edit the company profile.`
      );
    }

    const m = document.getElementById("modal-claim-welcome");
    if (!m) return;
    const isClosed = m.classList.contains("opacity-0") || m.classList.contains("pointer-events-none");
    if (isClosed) toggleModal("modal-claim-welcome");
  } catch(e) {
    console.error(e);
  }
}

function closeClaimWelcomeModal() {
  try {
    const m = document.getElementById("modal-claim-welcome");
    if (!m) return;
    const isOpen = !m.classList.contains("opacity-0") && !m.classList.contains("pointer-events-none");
    if (isOpen) toggleModal("modal-claim-welcome");
  } catch(e) {}
}

async function goEditClaimedCompanyFromWelcome() {
  try {
    const cid = String(window.__claimWelcome.companyId || "").trim();
    if (!cid) return;

    closeClaimWelcomeModal();

    // Ensure "my company" points to the claimed company (UI permission checks rely on this)
    try { localStorage.setItem("BTrustOn_my_company_id", cid); } catch(e) {}

    try { await openProfile(cid, { tab: "overview" }); } catch(e) { try { openProfile(cid, { tab: "overview" }); } catch(_) {} }

    // Open editor after profile loads
    try { setTimeout(() => { try { editMyProfile(); } catch(e) {} }, 140); } catch(e) {}
  } catch(e) {
    console.error(e);
  }
}

async function checkAndTriggerClaimWelcome() {
  try {
    const user = await _getAuthUserSafe();
    if (!user?.id) return;

    const { data: rows, error } = await supabaseClient
      .from("claim_welcome_events")
      .select("company_id, created_at, shown_at")
      .eq("user_id", user.id)
      .is("shown_at", null)
      .order("created_at", { ascending: false })
      .limit(1);

    if (error) return;
    const row = (rows && rows[0]) ? rows[0] : null;
    if (!row?.company_id) return;

    const companyId = String(row.company_id);

    // Resolve company name (best-effort)
    let companyName = "";
    try {
      const { data: p, error: pErr } = await supabaseClient
        .from("profiles")
        .select("company_name")
        .eq("id", companyId)
        .maybeSingle();
      if (!pErr) companyName = p?.company_name || "";
    } catch(e) {}

    // Mark as shown BEFORE opening (prevents repeats across devices even if user refreshes)
    await __markClaimWelcomeShown(user.id, companyId);

    // Keep primary company pointing to claimed company
    try { localStorage.setItem("BTrustOn_my_company_id", companyId); } catch(e) {}

    openClaimWelcomeModal(companyId, companyName);
  } catch(e) {
    // silent
  }
}


// Admin: list + approve/reject claim requests
async function loadAdminClaims() {
  const listContainer = document.getElementById("admin-claim-list");
  const countBadge = document.getElementById("admin-claim-pending-count");
  if (!listContainer) return;

  listContainer.innerHTML = `
    <tr><td class="px-6 py-8 text-center text-gray-400 italic" colspan="5">${tOr("ui_loading_requests_810c03","Loading requests...")}</td></tr>
  `;

  try {
    const { data: reqs, error } = await supabaseClient
      .from("company_claim_requests")
      .select("id, company_id, requester_email, note, submitted_at, requester_user_id")
      .eq("status", "pending")
      .order("submitted_at", { ascending: false });

    if (error) throw error;

    const rows = Array.isArray(reqs) ? reqs : [];
    if (countBadge) countBadge.textContent = String(rows.length);

    if (!rows.length) {
      listContainer.innerHTML = `
        <tr><td class="px-6 py-10 text-center text-gray-400 italic" colspan="5">${tOr("ui_no_pending_claims","No pending claim requests.")}</td></tr>
      `;
      return;
    }

    // Fetch company names
    const ids = [...new Set(rows.map(r => r.company_id).filter(Boolean).map(String))];
    const companyMap = {};
    if (ids.length) {
      const { data: profs, error: pErr } = await supabaseClient
        .from("profiles")
        .select("id, company_name, logo_url, country, city")
        .in("id", ids);

      if (!pErr && Array.isArray(profs)) {
        profs.forEach(p => { companyMap[String(p.id)] = p; });
      }
    }

    listContainer.innerHTML = "";

    rows.forEach(r => {
      const p = companyMap[String(r.company_id)] || {};
      const cName = p.company_name || "Unknown Company";
      const iconLetter = (cName && cName[0]) ? cName[0].toUpperCase() : "?";
      const loc = [p.city, p.country].filter(Boolean).join(", ");

      const noteRaw = String(r.note || "").trim();
      const noteSafe = _safeText(noteRaw);
      const noteShort = noteSafe.length > 120 ? (noteSafe.slice(0, 120) + "â€¦") : noteSafe;

      const submitted = r.submitted_at ? _timeAgoI18n(r.submitted_at) : "";

      listContainer.innerHTML += `
        <tr class="hover:bg-gray-50/60">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-slate-900/5 border border-slate-200 flex items-center justify-center font-black text-slate-700">
                ${iconLetter}
              </div>
              <div>
                <div class="font-extrabold text-slate-900">${_safeText(cName)}</div>
                <div class="text-[11px] text-slate-500">${_safeText(loc || "")}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="font-bold text-slate-700">${_safeText(r.requester_email || "")}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-slate-600">${noteShort || "â€”"}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-slate-600">${_safeText(submitted)}</div>
          </td>
          <td class="px-6 py-4 text-right">
            <div class="inline-flex gap-2">
              <button class="h-9 px-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold text-[11px] uppercase tracking-wider"
                      onclick="adminApproveClaim('${r.id}')">
                <i class="fa-solid fa-check mr-1"></i> ${tOr("ui_approve","Approve")}
              </button>
              <button class="h-9 px-3 rounded-xl bg-rose-600 hover:bg-rose-700 text-white font-extrabold text-[11px] uppercase tracking-wider"
                      onclick="adminRejectClaim('${r.id}')">
                <i class="fa-solid fa-xmark mr-1"></i> ${tOr("ui_reject","Reject")}
              </button>
            </div>
          </td>
        </tr>
      `;
    });

  } catch (e) {
    console.error(e);
    if (countBadge) countBadge.textContent = "0";
    listContainer.innerHTML = `
      <tr><td class="px-6 py-10 text-center text-rose-500 italic" colspan="5">${tOr("ui_action_failed","Action failed.")}</td></tr>
    `;
  }
}

async function adminApproveClaim(claimId) {
  const ok = (typeof uiConfirm === "function")
    ? await uiConfirm(tOr("ui_confirm_approve_claim","Approve this claim request?"))
    : confirm(tOr("ui_confirm_approve_claim","Approve this claim request?"));
  if (!ok) return;

  try {
    const { error } = await supabaseClient.rpc("bton_admin_approve_claim", { claim_id: claimId });
    if (error) throw error;
    showToast("OK", tOr("ui_claim_approved","Claim approved."), "brand");
    loadAdminClaims();
  } catch (e) {
    console.error(e);
    showToast("Error", tOr("ui_action_failed","Action failed."), "error");
  }
}

async function adminRejectClaim(claimId) {
  const ok = (typeof uiConfirm === "function")
    ? await uiConfirm(tOr("ui_confirm_reject_claim","Reject this claim request?"))
    : confirm(tOr("ui_confirm_reject_claim","Reject this claim request?"));
  if (!ok) return;

  try {
    const { error } = await supabaseClient.rpc("bton_admin_reject_claim", { claim_id: claimId, decision_notes: null });
    if (error) throw error;
    showToast("OK", tOr("ui_claim_rejected","Claim rejected."), "brand");
    loadAdminClaims();
  } catch (e) {
    console.error(e);
    showToast("Error", tOr("ui_action_failed","Action failed."), "error");
  }
}


async function processVerification(requestId, userId, action) {
    const ok = await uiConfirm(`Are you sure you want to ${action} this company?`, {title:'Confirm', okText:'Yes', cancelText:'Cancel'});
    if (!ok) return;

    const { data: { user: adminUser } } = await supabaseClient.auth.getUser();
    const adminId = adminUser && adminUser.id ? adminUser.id : null;

    let profileUpdates = {};
    let requestUpdates = {
      status: action === 'approve' ? 'approved' : 'rejected',
      reviewed_by: adminId,
      reviewed_at: nowDate().toISOString()
    };

    if (action === 'approve') {
        const now = nowDate();
        const { endDate } = computeProTrialEnd(now, null);

        profileUpdates = {
            verification_status: 'verified',
            verified_at: now.toISOString(),
            verified_by: adminId,
            verification_method: 'registry',
            subscription_tier: 'pro',
            subscription_status: 'active_trial',
            trial_start_date: now.toISOString(),
            trial_end_date: endDate.toISOString(),
            verification_reject_reason: null,
            verification_rejected_at: null
        };
        requestUpdates.decision_notes = null;

    } else {
        const reason = prompt(
            (t("ui_reject_reason_prompt") || "Reject reason (optional):\nTell the company what to fix (e.g., wrong registration number, missing state, invalid link)."),
            (t("ui_verification_request_rejected") || "Your verification request was rejected. Please review your information and try again.")
        );
        profileUpdates = {
            verification_status: 'rejected',
            verification_reject_reason: reason ? reason.trim() : null,
            verification_rejected_at: nowDate().toISOString()
        };
        requestUpdates.decision_notes = reason ? reason.trim() : null;
    }

    // Update profile
    const { error: pErr } = await supabaseClient
        .from('profiles')
        .update(profileUpdates)
        .eq('id', userId);

    if (pErr) {
        alert("Error: " + pErr.message);
        return;
    }

    // Update request audit row (best-effort)
    try {
      if (requestId) {
        const { error: rErr } = await supabaseClient
          .from('verification_requests')
          .update(requestUpdates)
          .eq('id', requestId);

        if (rErr) console.warn("verification_requests update error:", rErr);
      }
    } catch(e) {
      console.warn("verification_requests update skipped:", e);
    }

    showToast("Success", `Company ${action}d successfully.`, "success");
    loadAdminData();
}


/* =========================
   PRO LIFECYCLE (TRIAL -> PAID -> DOWNGRADE)
   Goal: clear rules + revenue-friendly flow
========================= */
const PRO_MONTHLY_PRICE_USD = 19;                  // âœ… change if needed
const PRO_EARLY_BIRD_END_UTC = "2026-12-31T23:59:59Z";
const PRO_TRIAL_MONTHS_EARLY = 3;                  // early adopters
const PRO_TRIAL_DAYS_DEFAULT = 30;                 // new signups after early-bird
const PRO_PAYMENT_URL = "https://buy.stripe.com/REPLACE_ME"; // âœ… replace with Stripe/checkout link

function _stripNotifMarkers(text="") {
  return String(text)
    .replace(/\[(ACTION|KEY|I18N):[^\]]+\]/g, "")
    .replace(/\[(?!ACTION:|KEY:|I18N:)([a-zA-Z0-9_]+)=([^\]]*)\]/g, "")
    .replace(/\n{3,}/g, "\n\n")
    .trim();
}
function _extractNotifAction(text="") {
  const m = String(text).match(/\[ACTION:([^\]]+)\]/);
  return m ? m[1] : null;
}
function _hasNotifKey(text="", key="") {
  return String(text).includes(`[KEY:${key}]`);
}

/* --- Notification i18n (render-time) --- */
function tP(key, params = {}) {
  let s = t(key) || "";
  try {
    const obj = (params && typeof params === "object") ? params : {};
    Object.keys(obj).forEach(k => {
      const v = (obj[k] == null) ? "" : String(obj[k]);
      s = s.split(`{${k}}`).join(v);
    });
  } catch(e) {}
  return s;
}

function _normNotifVars(v) {
  try {
    if (!v) return {};
    if (typeof v === "string") {
      const s = v.trim();
      if (!s) return {};
      return JSON.parse(s);
    }
    if (typeof v === "object") return v;
  } catch(e) {}
  return {};
}


function _parseNotifI18n(text="") {
  const raw = String(text || "");
  const keyMatch = raw.match(/\[I18N:([^\]]+)\]/);
  const key = keyMatch ? keyMatch[1] : null;
  const params = {};
  raw.replace(/\[(?!ACTION:|KEY:|I18N:)([a-zA-Z0-9_]+)=([^\]]*)\]/g, (m, k, v) => {
    params[k] = v;
    return m;
  });
  return { key, params };
}

function _renderNotifI18n(text="", fallback="") {
  const raw = String(text || "");
  const parsed = _parseNotifI18n(raw);
  if (parsed && parsed.key) {
    const out = tP(parsed.key, parsed.params);
    if (out) return out;
  }
  return fallback || "";
}


function computeProTrialEnd(nowDate, createdAtISO=null) {
  // âœ… Current pricing: everyone gets a 3-month free Pro trial (no card required).
  const now = nowDate instanceof Date ? nowDate : new Date(nowDate);
  const endDate = new Date(now);
  endDate.setMonth(now.getMonth() + 3);

  const trialNote = _i18n("price_trial_note", "3 months free trial");
  const noCard = _i18n("price_no_card", "No card required");
  const label = `${trialNote} â€¢ ${noCard}`;

  return { endDate, label };
}


function openProPayment() {
  // For now: open your checkout link in a new tab
  if (!PRO_PAYMENT_URL || PRO_PAYMENT_URL.includes("REPLACE_ME")) {
    showToast("Payment link missing", "Please set PRO_PAYMENT_URL in the code.", "error");
    return;
  }
  window.open(PRO_PAYMENT_URL, "_blank", "noopener,noreferrer");
}

// Start Pro trial directly (used by homepage pricing + join intent)
// - If trial already used => opens payment
async function startProTrialDirect(companyRow, opts = {}) {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user || !user.id) {
      showToast(
        currentLang === "tr" ? "GiriÅŸ gerekli" : "Login required",
        currentLang === "tr" ? "Pro denemesini baÅŸlatmak iÃ§in giriÅŸ yapÄ±n." : "Please login to start your Pro trial.",
        "info"
      );
      return;
    }

    // Fetch latest if needed
    let row = companyRow;
    if (!row || String(row.id) !== String(myCompanyIdOr(user.id))) {
      try { row = await _fetchMyCompanyProfile(user.id); } catch(_) { row = null; }
    }
    if (!row) return;

    // Enforce lifecycle before acting
    if (typeof enforceProLifecycle === "function") {
      try { row = (await enforceProLifecycle(row)) || row; } catch(_) {}
    }

    if (typeof _isProForPosting === "function" && _isProForPosting(row)) {
      try { renderNavPlanButton(row); } catch(_) {}
      try { refreshPricingSection(); } catch(_) {}
      return;
    }

    const trialAlreadyUsed = !!(row && row.trial_start_date);
    if (trialAlreadyUsed) {
      openProPayment();
      return;
    }

    const now = nowDate();
    const createdAtISO = row.created_at || null;
    const { endDate, label } = computeProTrialEnd(now, createdAtISO);

    const { error } = await supabaseClient
      .from('profiles')
      .update({
        subscription_tier: 'pro',
        subscription_status: 'active_trial',
        trial_start_date: now.toISOString(),
        trial_end_date: endDate.toISOString(),
        updated_at: now.toISOString()
      })
      .eq('id', myCompanyIdOr(user.id));

    if (error) throw error;

    // Update local objects
    row.subscription_tier = 'pro';
    row.subscription_status = 'active_trial';
    row.trial_start_date = now.toISOString();
    row.trial_end_date = endDate.toISOString();

    selectedCompany = row;
    __postCompany = row;

    // Update in-memory list (if exists)
    try {
      if (Array.isArray(database)) {
        const ix = database.findIndex(c => String(c.id) === String(myCompanyIdOr(user.id)));
        if (ix >= 0) {
          database[ix].subscription_tier = 'pro';
          database[ix].subscription_status = 'active_trial';
          database[ix].trial_start_date = row.trial_start_date;
          database[ix].trial_end_date = row.trial_end_date;
        }
      }
    } catch(_) {}

    // Refresh UI
    try { renderNavPlanButton(row); } catch(_) {}
    try { if (typeof refreshAnalyticsPlanUI === "function") refreshAnalyticsPlanUI(); } catch(_) {}
    try { updateVerificationUI(row.verification_status || 'none'); } catch(_) {}
    try { refreshHomeUpdatesCTA(); } catch(_) {}
    try { refreshPricingSection(); } catch(_) {}

    const niceDate = endDate.toLocaleDateString();
    showToast(
      currentLang === "tr" ? "Pro aktif!" : "Pro activated!",
      (currentLang === "tr")
        ? `${label} â€¢ ${niceDate} tarihine kadar.`
        : `${label} active until ${niceDate}.`,
      "success"
    );

    // Keep user inside profile and guide to verification if available
    try {
      openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true, tab: (window.__profileActiveTab || 'overview') });
    } catch(_) {}
    setTimeout(() => {
      try { if (typeof handleVerifyClick === "function") handleVerifyClick(true); } catch(_) {}
    }, 600);

  } catch (err) {
    console.error("startProTrialDirect error:", err);
    showToast("Error", err.message || "Could not start trial.", "error");
  }
}


/* =========================
   NAV PLAN BUTTON (UPGRADE / PRO) + CANCEL
========================= */
let __planMenuOpen = false;

function closePlanMenu() {
  const menu = document.getElementById("nav-plan-menu");
  if (menu) menu.classList.add("hidden");
  __planMenuOpen = false;
}

function togglePlanMenu(ev) {
  try { if (ev) ev.stopPropagation(); } catch(_) {}
  const menu = document.getElementById("nav-plan-menu");
  if (!menu) return;
  if (__planMenuOpen) { closePlanMenu(); return; }
  menu.classList.remove("hidden");
  __planMenuOpen = true;
}

// Close on outside click / ESC (safe to register once)
document.addEventListener("click", (e) => {
  if (!__planMenuOpen) return;
  const wrap = document.getElementById("nav-plan-wrap");
  if (wrap && wrap.contains(e.target)) return;
  closePlanMenu();
});
document.addEventListener("keydown", (e) => {
  if (!__planMenuOpen) return;
  if (e.key === "Escape") closePlanMenu();
});

function _isProActiveForUI(company) {
  try { return _isProForPosting(company); } catch(e) { return false; }
}

function renderNavPlanButton(company = null) {
  const btn = document.getElementById("btn-nav-upgrade");
  const icon = document.getElementById("nav-plan-icon");
  const label = document.getElementById("nav-plan-label");
  const iconWrap = document.getElementById("nav-plan-icon-wrap");

  const mTitle = document.getElementById("nav-plan-menu-title");
  const mSub = document.getElementById("nav-plan-menu-sub");
  const mUpgrade = document.getElementById("plan-menu-upgrade");
  const mCancel = document.getElementById("plan-menu-cancel");

  if (!btn) return;

  const c = company || __postCompany || null;
  const isPro = !!(c && String(c.subscription_tier || "free").toLowerCase() === "pro");

  const baseBtn = "flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-extrabold border transition shadow-sm";
  if (isPro) {
    btn.className = baseBtn + " bg-white/80 backdrop-blur text-slate-800 border-cyan-200 hover:bg-white hover:shadow-md";
    if (icon) icon.className = "fa-solid fa-gem text-BTrustOn-accent";
    if (iconWrap) iconWrap.className = "w-6 h-6 rounded-lg flex items-center justify-center bg-cyan-50 border border-cyan-200 shadow-sm";
    if (label) label.textContent = "PRO";
    if (mTitle) mTitle.textContent = tOr("ui_pro_plan_title","Pro Plan");
    if (mSub) mSub.textContent = tOr("ui_pro_plan_active_sub","Your plan is active. You can cancel anytime.");
    if (mUpgrade) mUpgrade.classList.add("hidden");
    if (mCancel) mCancel.classList.remove("hidden");
  } else {
    btn.className = baseBtn + " bg-BTrustOn-primary text-white border-white/10 hover:bg-BTrustOn-accent hover:shadow-md";
    if (icon) icon.className = "fa-solid fa-gem text-cyan-100";
    if (iconWrap) iconWrap.className = "w-6 h-6 rounded-lg flex items-center justify-center bg-white/10 border border-white/15 shadow-sm";
    if (label) label.textContent = tOr("updates_upgrade","Upgrade");
    if (mTitle) mTitle.textContent = tOr("attr_plan_0b6cbd","Plan");
    if (mSub) mSub.textContent = tOr("ui_upgrade_to_unlock_pro_features_7bc2e8","Upgrade to unlock Pro features.");
    if (mUpgrade) mUpgrade.classList.remove("hidden");
    if (mCancel) mCancel.classList.add("hidden");
  }
}

async function cancelProSubscription() {
  try {
    const ok = await uiConfirm(
      (currentLang === "tr")
        ? "Pro planÄ±nÄ± iptal etmek istiyor musun? Ã–deme planÄ± durdurulacak ve Free plana geÃ§eceksin."
        : "Cancel Pro? Your billing will stop and you will return to Free plan.",
      {
        title: (currentLang === "tr") ? "Ä°ptal OnayÄ±" : "Confirm Cancel",
        okText: (currentLang === "tr") ? "Evet, iptal et" : "Yes, cancel",
        cancelText: (currentLang === "tr") ? "VazgeÃ§" : "Keep Pro"
      }
    );
    if (!ok) return;

    const user = await _getAuthUserSafe();
    if (!user) {
      toggleModal("modal-login");
      return;
    }

    // ðŸ”§ This app is currently using a simple DB flag for Pro access.
    // Cancelling sets tier back to Free (your verified badge stays).
    const { error } = await supabaseClient
      .from("profiles")
      .update({
        subscription_tier: "free",
        subscription_status: "free"
      })
      .eq("id", myCompanyIdOr(user.id));

    if (error) {
      showToast("Error", error.message || "Could not cancel.", "error");
      return;
    }

    if (__postCompany && String(__postCompany.id) === String(myCompanyIdOr(user.id))) {
      __postCompany.subscription_tier = "free";
      __postCompany.subscription_status = "free";
    }
    if (selectedCompany && String(selectedCompany.id) === String(myCompanyIdOr(user.id))) {
      selectedCompany.subscription_tier = "free";
      selectedCompany.subscription_status = "free";
    }

    
// âœ… Refresh Pro-gated UI instantly (no browser refresh)
    // Pull a fresh snapshot (prevents stale UI without full page refresh)
    try {
      const fresh = await _fetchMyCompanyProfile(user.id);
      if (fresh) { selectedCompany = fresh; __postCompany = fresh; }
    } catch (_) {}

    try { if (typeof updateVerificationUI === "function") updateVerificationUI((selectedCompany && selectedCompany.verification_status) || "none"); } catch(_) {}
    try { if (typeof refreshAnalyticsPlanUI === "function") refreshAnalyticsPlanUI(); } catch(_) {}
    showToast(
      (currentLang === "tr") ? "Ä°ptal edildi" : "Cancelled",
      (currentLang === "tr")
        ? "Pro planÄ±n durduruldu. Free plana geÃ§tin. (Verified rozetin kalÄ±r.)"
        : "Your Pro plan is cancelled. You are now on Free. (Verified badge stays.)",
      "success"
    );

    try { renderNavPlanButton(__postCompany || selectedCompany); } catch(_) {}
    try { refreshHomeUpdatesCTA(); } catch(_) {}
    try { refreshPricingSection(); } catch(_) {}
  } catch (e) {
    showToast("Error", e.message || "Could not cancel.", "error");
  }
}


async function openUpgradeModal() {
  try {
    
// Ensure the modal always reflects the logged-in user's plan (works from anywhere)
try {
  const u = await _getAuthUserSafe();
  if (u && u.id) {
    const my = await _fetchMyCompanyProfile(u.id);
    if (my) { selectedCompany = my; __postCompany = my; }
  }
} catch(_) {}

const offerEl = document.getElementById("upgrade-offer-text");
    const ctaLbl = document.getElementById("upgrade-cta-label");
    const pill = document.getElementById("upgrade-pill-trial");

    const now = nowDate();
    const createdAt = (selectedCompany && selectedCompany.created_at) ? selectedCompany.created_at : null;

    const trialAlreadyUsed = !!(selectedCompany && selectedCompany.trial_start_date);
    const isTrialActive = !!(selectedCompany && selectedCompany.trial_end_date && new Date(selectedCompany.trial_end_date) > now);

    // Price helper
    const monthWord = _i18n("price_month", "month");
    const priceStr = `$${PRO_MONTHLY_PRICE_USD}/${monthWord}`;

    // Hide trial pill if trial is not available anymore
    if (pill) pill.style.display = trialAlreadyUsed ? "none" : "";

    if (trialAlreadyUsed) {
      if (offerEl) {
        offerEl.textContent = (currentLang === "tr")
          ? `Pro Ã¼creti ${priceStr}. SÄ±nÄ±rsÄ±z Ã¶zellikleri kullanmaya devam etmek iÃ§in Pro'ya yÃ¼kseltin.`
          : `Pro is ${priceStr}. Upgrade now to keep unlimited features.`;
      }
      if (ctaLbl) ctaLbl.textContent = _i18n("btn_upgrade_pro", "UPGRADE TO PRO");
    } else {
      const { label } = computeProTrialEnd(now, createdAt);
      if (offerEl) {
        offerEl.textContent = (currentLang === "tr")
          ? `${label} â€¢ Sonra ${priceStr}.`
          : `${label} â€¢ Then ${priceStr}.`;
      }
      if (ctaLbl) ctaLbl.textContent = _i18n("btn_start_trial", "START FREE TRIAL");
    }

    if (isTrialActive && selectedCompany && selectedCompany.trial_end_date) {
      const d = new Date(selectedCompany.trial_end_date);
      const ds = d.toLocaleDateString(currentLang === "tr" ? "tr-TR" : (currentLang === "es" ? "es-ES" : "en-US"), { year:"numeric", month:"short", day:"2-digit" });

      if (pill) pill.style.display = ""; // show something
      if (offerEl) {
        offerEl.textContent = (currentLang === "tr")
          ? `Pro denemeniz ${ds} tarihine kadar aktif.`
          : `Your Pro trial is active until ${ds}.`;
      }
      if (ctaLbl) ctaLbl.textContent = _i18n("upgrade_btn_ok", "OK");
    }

  } catch(e) {}
  toggleModal('modal-upgrade');
}


async function handleUpgradeCTA() {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      showToast("Login required", "Please login to continue.", "info");
      toggleModal('modal-login');
      return;
    }

    const now = nowDate();
    const isTrialActive = !!(selectedCompany && selectedCompany.subscription_status === "active_trial" && selectedCompany.trial_end_date && new Date(selectedCompany.trial_end_date) > now);
    if (isTrialActive) {
      toggleModal('modal-upgrade');
      return;
    }

    const trialAlreadyUsed = !!(selectedCompany && selectedCompany.trial_start_date);
    if (trialAlreadyUsed) {
      toggleModal('modal-upgrade');
      openProPayment();
      return;
    }
    // start trial
    await upgradeToPro();
  } catch(e) {
    showToast("Error", e.message || "Could not continue.", "error");
  }
}

async function _maybeSendLifecycleNotification(userId, key, title, message) {
  try {
    if (!userId || !key) return;

    // âœ… Primary path: DB-level dedupe via (recipient_user_id, dedupe_key) unique index
    const row = {
      recipient_user_id: userId,
      title,
      message: `[ACTION:UPGRADE]\n` + String(message || ""),
      is_read: false,
      dedupe_key: key
    };

    const { error } = await supabaseClient
      .from('notifications')
      .upsert([row], { onConflict: 'recipient_user_id,dedupe_key', ignoreDuplicates: true });

    if (error) {
      // Fallback: legacy insert (best-effort)
      try {
        const keyTag = `[KEY:${key}]`;
        const baseRow = {
          recipient_user_id: userId,
          title,
          message: `${keyTag}[ACTION:UPGRADE]\n` + String(message || ""),
          is_read: false
        };
        const { error: err2 } = await supabaseClient.from('notifications').insert([baseRow]);
        if (err2) console.warn("Lifecycle notif fallback insert failed:", err2);
      } catch(_) {}
    }

    // Refresh UI fast
    try { if (typeof fetchNotificationsUnread === "function") fetchNotificationsUnread(); } catch(_) {}
  } catch(e) {
    console.warn("Lifecycle notification error:", e);
  }
}

async function enforceProLifecycle(profileRow) {
  try {
    if (!profileRow || !profileRow.id) return profileRow;

    const now = nowDate();
    const tier = profileRow.subscription_tier || 'free';
    const status = profileRow.subscription_status || 'free';
    const trialEnd = profileRow.trial_end_date ? new Date(profileRow.trial_end_date) : null;

    // If active trial: send reminders + expire when needed
    if (status === 'active_trial' && trialEnd && !isNaN(trialEnd.getTime())) {
      const msLeft = trialEnd.getTime() - now.getTime();

      // Calendar-day based (stable across time-of-day + time-travel testing)
      const _msDay = 24*60*60*1000;
      const _dayStart = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
      const today0 = _dayStart(now);
      const end0 = _dayStart(trialEnd);
      const daysLeft = Math.round((end0.getTime() - today0.getTime()) / _msDay);
      const endKey = end0.toISOString().slice(0,10);

      if (daysLeft === 10) {
        await _maybeSendLifecycleNotification(
          profileRow.id,
          `PRO_TRIAL_10D_${endKey}`,
          "Pro trial ending soon",
          `Your Pro trial ends on ${trialEnd.toLocaleDateString()}. Upgrade to keep unlimited features.`
        );
      }

      if (daysLeft === 1) {
        await _maybeSendLifecycleNotification(
          profileRow.id,
          `PRO_TRIAL_1D_${endKey}`,
          "Pro trial ends tomorrow",
          `Your Pro trial ends on ${trialEnd.toLocaleDateString()}. Upgrade now to avoid losing Pro features.`
        );
      }

      // Expired
      if (msLeft <= 0) {
        await supabaseClient.from('profiles').update({
          subscription_tier: 'free',
          subscription_status: 'trial_expired',
          updated_at: now.toISOString()
        }).eq('id', profileRow.id);

        await _maybeSendLifecycleNotification(
          profileRow.id,
          `PRO_TRIAL_ENDED_${endKey}`,
          "Pro trial ended",
          `Your Pro trial ended on ${trialEnd.toLocaleDateString()}. You are now on the Free plan (your verification badge stays). Upgrade to restore unlimited features.`
        );

        profileRow.subscription_tier = 'free';
        profileRow.subscription_status = 'trial_expired';
      }
    }

    // Safety: if tier says pro but status not active_trial -> downgrade unless you add paid_until later
    if (tier === 'pro' && status !== 'active_trial') {
      // If there's no valid active trial end date, treat as free to avoid "forever pro"
      if (!trialEnd || isNaN(trialEnd.getTime()) || trialEnd <= now) {
        await supabaseClient.from('profiles').update({
          subscription_tier: 'free',
          subscription_status: status === 'active_paid' ? status : 'trial_expired',
          updated_at: now.toISOString()
        }).eq('id', profileRow.id);
        profileRow.subscription_tier = 'free';
        if (profileRow.subscription_status !== 'active_paid') profileRow.subscription_status = 'trial_expired';
      }
    }

    return profileRow;
  } catch(e) {
    console.warn("enforceProLifecycle error:", e);
    return profileRow;
  }
}


/* --- GÃœNCELLENMÄ°Åž: upgradeToPro (ANINDA BUTON GÄ°ZLEME) --- */
async function upgradeToPro() {
    const btn = document.querySelector("#modal-upgrade button:last-child");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
    btn.disabled = true;

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Please login first.");

        // --- TRIAL DATE (revenue-friendly rules) ---
        const now = nowDate();
        // Trial is one-time per company (prevents infinite free Pro)
        const trialAlreadyUsed = !!(selectedCompany && selectedCompany.trial_start_date);
        if (trialAlreadyUsed) {
            toggleModal('modal-upgrade');
            openProPayment();
            return;
        }
        const _createdAtISO = (selectedCompany && selectedCompany.created_at) ? selectedCompany.created_at : null;
        const { endDate, label } = computeProTrialEnd(now, _createdAtISO);

        // 1. VeritabanÄ± GÃ¼ncellemesi
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                subscription_tier: 'pro',
                subscription_status: 'active_trial',
                trial_start_date: now.toISOString(),
                trial_end_date: endDate.toISOString(),
                updated_at: now
            })
            .eq('id', myCompanyIdOr(user.id));

        if (error) throw error;

        // 2. Yerel HafÄ±zayÄ± GÃ¼ncelle
        if (selectedCompany) {
            selectedCompany.subscription_tier = 'pro';
            selectedCompany.subscription_status = 'active_trial';
            selectedCompany.trial_start_date = now.toISOString();
            selectedCompany.trial_end_date = endDate.toISOString();
        }

        
if (__postCompany && String(__postCompany.id) === String(myCompanyIdOr(user.id))) {
    __postCompany.subscription_tier = 'pro';
    __postCompany.subscription_status = 'active_trial';
    __postCompany.trial_start_date = now.toISOString();
    __postCompany.trial_end_date = endDate.toISOString();
}
// 3. ModalÄ± Kapat
        toggleModal('modal-upgrade');
// 4. âœ… UI'Ä± anÄ±nda gÃ¼ncelle (butonlarÄ± gizleme yerine Pro durumuna geÃ§ir)
try { renderNavPlanButton(selectedCompany); } catch(_) {}
try { if (typeof refreshAnalyticsPlanUI === "function") refreshAnalyticsPlanUI(); } catch(_) {}

// 5. Verify KutularÄ±nÄ±n Kilidini AÃ§ (ArtÄ±k Pro olduÄŸu iÃ§in)
// EÄŸer verification durumu yoksa 'none' gÃ¶nderiyoruz
        updateVerificationUI(selectedCompany.verification_status || 'none');
        
        // 6. KullanÄ±cÄ±yÄ± Bilgilendir
        const niceDate = endDate.toLocaleDateString(); 
        showToast("Welcome to Pro!", `${label} active until ${niceDate}`, "success");
        
        

try { refreshHomeUpdatesCTA(); } catch(_) {}
try { refreshPricingSection(); } catch(_) {}
// 7. Profili Yeniden Ã‡iz (Rozetler vs. iÃ§in)
        openProfile(myCompanyIdOr(user.id), { preserveScroll: true, preserveTab: true, tab: (window.__profileActiveTab || 'overview') });
	setTimeout(() => handleVerifyClick(true), 700);
    } catch (err) {
        console.error(err);
        showToast("Error", "Upgrade failed: " + err.message, "error");
    } finally {
        if(btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

/* --- KUTLAMA MANTIÄžI --- */

// 1. Durumu Kontrol Et ve Kutla
/* --- CROSS-DEVICE: Verification Celebration (DB-based, no repeat across devices) --- */
async function __getAuthUserId() {
  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    return user?.id || null;
  } catch (e) {
    return null;
  }
}

async function __fetchCelebrationSeen(companyProfileId) {
  // Returns true if celebration has already been shown for THIS company profile.
  // Prefer DB flag (cross-device). Fallback to localStorage.
  if (!companyProfileId) return false; // fail-open: allow celebration rather than hiding it forever
  const lsKey = "BTrustOn_celebrated_" + String(companyProfileId);
  try {
    // local quick guard
    try { if (localStorage.getItem(lsKey) === "true") return true; } catch(e) {}

    const { data, error } = await supabaseClient
      .from("profiles")
      .select("verification_celebrated")
      .eq("id", companyProfileId)
      .maybeSingle();

    if (error) {
      // DB/RLS/column issue -> fail-open but keep local guard
      return false;
    }
    return !!(data && data.verification_celebrated);
  } catch (e) {
    return false; // fail-open
  }
}

async function __setCelebrationSeen(companyProfileId) {
  if (!companyProfileId) return;
  const lsKey = "BTrustOn_celebrated_" + String(companyProfileId);
  try { localStorage.setItem(lsKey, "true"); } catch(e) {}

  try {
    const nowIso = nowDate().toISOString();
    // Try by id (company profile row)
    let { error } = await supabaseClient
      .from("profiles")
      .update({ verification_celebrated: true, verification_celebrated_at: nowIso })
      .eq("id", companyProfileId);

    // If update blocked by RLS, we still keep localStorage flag (prevents repeats).
    if (error) return;
  } catch (e) {
    // ignore
  }
}

async function checkAndTriggerCelebration(company) {
  try {
    const userId = await __getAuthUserId();
    if (!userId || !company) return;

    // Verified detection (supports multiple schemas/labels)
    const vs = String(company.verification_status || "").toLowerCase().trim();
    const boolTrue = (x) => (x === true || x === 1 || x === "true" || x === "1");
    const isVerified =
      (vs === "verified" || vs === "approved")
      || boolTrue(company.is_verified) || boolTrue(company.verified)
      || boolTrue(company.blue_tick) || boolTrue(company.is_verified_company);

    if (!isVerified) return;

    // Ownership (claim-aware)
    const ownerId = company.owner_user_id || company.ownerUserId || company.user_id || company.userId || null;
    const myCompanyId = (typeof myCompanyIdOr === "function") ? myCompanyIdOr(userId) : userId;

    const isOwner =
      (String(company.id) === String(userId)) ||                               // legacy
      (ownerId && String(ownerId) === String(userId)) ||                        // claim owner
      (myCompanyId && String(myCompanyId) === String(company.id));              // active company

    if (!isOwner) return;

    const hasSeen = await __fetchCelebrationSeen(company.id);
    if (hasSeen) return;

    // Mark seen before opening (prevents duplicates across tabs/devices as best-effort)
    try { window.__celebrationCompanyId = company.id; } catch(_) {}

    __setCelebrationSeen(company.id).catch(() => {});
    openCelebrationModal();
  } catch (e) {
    // no-op
  }
}

// 2. ModalÄ± AÃ§ ve Konfeti Patlat
/* --- GÃœNCELLENMÄ°Åž: openCelebrationModal (SADE VE KURUMSAL) --- */
function openCelebrationModal() {
    const modal = document.getElementById("modal-celebration");
    const card = document.getElementById("celebration-card");
    
    if(!modal) return;

    // ModalÄ± GÃ¶ster
    modal.classList.remove("opacity-0", "pointer-events-none");
    if(card) {
        card.classList.remove("scale-90");
        card.classList.add("scale-100");
    }

    // BURADAKÄ° KONFETÄ° KODLARINI SÄ°LDÄ°K (Daha profesyonel durmasÄ± iÃ§in)
}
// 3. ModalÄ± Kapat ve Kaydet
async function closeCelebration() {
  const modal = document.getElementById("modal-celebration");
  if (modal) modal.classList.add("opacity-0", "pointer-events-none");

  // Ek gÃ¼venlik: modal kapatÄ±lÄ±rken de DB'ye "seen" yaz
  try {
    const cid = (window.__celebrationCompanyId || null);
    if (cid) await __setCelebrationSeen(cid);
  } catch (e) {}
}

// --- GALERÄ° (LIGHTBOX) FONKSÄ°YONLARI ---
// --- GALERÄ° (LIGHTBOX) FONKSÄ°YONLARI ---
// Scroll sabitleme (modal aÃ§/kapatta sayfa en Ã¼ste zÄ±plamasÄ±n)
window.__scrollLock = window.__scrollLock || { count: 0, y: 0, prev: null };

function __lockScrollForModal(){
  const st = window.__scrollLock;
  if (st.count === 0){
    st.y = window.scrollY || document.documentElement.scrollTop || 0;
    st.prev = {
      position: document.body.style.position || "",
      top: document.body.style.top || "",
      left: document.body.style.left || "",
      right: document.body.style.right || "",
      width: document.body.style.width || "",
      paddingRight: document.body.style.paddingRight || "",
      overflow: document.body.style.overflow || ""
    };
    // Sabitle
    const sbw = Math.max(0, (window.innerWidth || 0) - (document.documentElement ? document.documentElement.clientWidth : 0));
    document.body.style.position = "fixed";
    document.body.style.top = `-${st.y}px`;
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";
    document.body.style.paddingRight = sbw ? `${sbw}px` : "";
    document.body.style.overflow = "hidden";
  }
  st.count += 1;
}

function __unlockScrollForModal(){
  const st = window.__scrollLock;
  if (!st || st.count <= 0) return;
  st.count -= 1;
  if (st.count === 0){
    const y = st.y || 0;
    const prev = st.prev || {};
    document.body.style.position = prev.position ?? "";
    document.body.style.top      = prev.top ?? "";
    document.body.style.left     = prev.left ?? "";
    document.body.style.right    = prev.right ?? "";
    document.body.style.width    = prev.width ?? "";
    document.body.style.paddingRight = prev.paddingRight ?? "";
    document.body.style.overflow = prev.overflow ?? "";
    // Bir sonraki frame'de scroll'u geri al (layout otursun)
    requestAnimationFrame(() => window.scrollTo(0, y));
  }
}

/* =========================
   ATTACHMENT VIEWER (Assets + Certificates)
   - Opens image/PDF in an in-page modal (no new tab)
   - Preserves scroll position on close (uses __lockScrollForModal)
========================= */

function __attachmentKind(url, fileName){
  try{
    const pick = (v) => {
      const clean = String(v || "").split("#")[0].split("?")[0].toLowerCase();
      if (clean.endsWith(".pdf")) return "pdf";
      if (clean.match(/\.(png|jpg|jpeg|webp|gif|svg|bmp)$/)) return "image";
      return "other";
    };
    const k1 = pick(fileName);
    if(k1 !== "other") return k1;
    return pick(url);
  }catch(e){ return "other"; }
}

async function __isDisplayableImage(url){
  return new Promise((resolve) => {
    try{
      const img = new Image();
      let done = false;
      const finish = (v) => { if(done) return; done = true; resolve(v); };
      const timer = setTimeout(() => finish(false), 1200);
      img.onload = () => { clearTimeout(timer); finish(true); };
      img.onerror = () => { clearTimeout(timer); finish(false); };
      // Do not set crossOrigin; we only need displayability
      img.src = url;
    }catch(e){
      resolve(false);
    }
  });
}



// --- Robust attachment kind probing (handles URLs without extensions) ---
const __attachmentKindCache = new Map();
async function __probeAttachmentKind(url){
  try{
    const u = String(url || "");
    if(!u) return "other";

    // Cache only strong classifications (avoid caching transient failures)
    if(__attachmentKindCache.has(u)) return __attachmentKindCache.get(u);

    const fetchWithTimeout = async (input, init, ms) => {
      const ac = new AbortController();
      const t = setTimeout(() => { try{ ac.abort(); }catch(e){} }, ms);
      try{
        return await fetch(input, { ...(init||{}), signal: ac.signal });
      } finally {
        clearTimeout(t);
      }
    };

    let kind = "other";

    // 1) Try HEAD to read Content-Type quickly
    try{
      const head = await fetchWithTimeout(u, { method: "HEAD" }, 1500);
      const ct = (head.headers.get("content-type") || "").toLowerCase();
      if(ct.includes("application/pdf") || ct.includes("pdf")) kind = "pdf";
      else if(ct.startsWith("image/")) kind = "image";
    }catch(e){ /* ignore */ }

    // 2) If still unknown, try a tiny GET + signature sniff (no full download)
    if(kind === "other"){
      try{
        const res = await fetchWithTimeout(u, { method: "GET" }, 2500);
        const ct2 = (res.headers.get("content-type") || "").toLowerCase();
        if(ct2.includes("application/pdf") || ct2.includes("pdf")) kind = "pdf";
        else if(ct2.startsWith("image/")) kind = "image";

        if(kind === "other" && res.body && res.body.getReader){
          const reader = res.body.getReader();
          const { value } = await reader.read();
          try{ await reader.cancel(); }catch(e){}
          if(value && value.length){
            // PDF: %PDF-
            if(value.length >= 5 && value[0]===0x25 && value[1]===0x50 && value[2]===0x44 && value[3]===0x46 && value[4]===0x2D){
              kind = "pdf";
            }
            // PNG
            else if(value.length >= 8 && value[0]===0x89 && value[1]===0x50 && value[2]===0x4E && value[3]===0x47 && value[4]===0x0D && value[5]===0x0A && value[6]===0x1A && value[7]===0x0A){
              kind = "image";
            }
            // JPEG
            else if(value.length >= 3 && value[0]===0xFF && value[1]===0xD8 && value[2]===0xFF){
              kind = "image";
            }
            // GIF
            else if(value.length >= 3 && value[0]===0x47 && value[1]===0x49 && value[2]===0x46){
              kind = "image";
            }
            // WEBP: "RIFF"...."WEBP"
            else if(value.length >= 12 && value[0]===0x52 && value[1]===0x49 && value[2]===0x46 && value[3]===0x46 && value[8]===0x57 && value[9]===0x45 && value[10]===0x42 && value[11]===0x50){
              kind = "image";
            }
          }
        }
      }catch(e){ /* ignore */ }
    }

    // Cache only when confident
    if(kind !== "other"){
      __attachmentKindCache.set(u, kind);
    }
    return kind;
  }catch(e){
    return "other";
  }
}

/* Attachment image viewer state
   - Zoom is expressed as percentage relative to "fit" scale (100% = fit-to-stage)
   - Panning is done by scrolling the stage (so you can reach every corner)
*/
const __att = {
  kind: "other",
  imgW: 0,
  imgH: 0,
  baseScale: 1,
  zoomPct: 100,
  isReady: false
};

function __clamp(n, min, max){
  n = Number(n);
  if(!Number.isFinite(n)) n = min;
  return Math.max(min, Math.min(max, n));
}

function __showAttachmentImgControls(show){
  const wrap = document.getElementById("attachment-img-controls");
  if(wrap) wrap.classList.toggle("hidden", !show);

  const stage = document.getElementById("attachment-stage");
  if(stage){
    stage.classList.toggle("attachment-pan-enabled", !!show && __att.kind === "image");
    stage.classList.remove("is-panning");
  }
}

function __updateAttachmentZoomLabel(){
  const lbl = document.getElementById("attachment-zoom-label");
  if(!lbl) return;
  lbl.textContent = `${Math.round(__att.zoomPct)}%`;
}

function __syncAttachmentModeButtons(){
  const fitBtn = document.getElementById("attachment-fit-btn");
  const actBtn = document.getElementById("attachment-actual-btn");
  if(fitBtn){
    const on = Math.round(__att.zoomPct) === 100;
    fitBtn.classList.toggle("bg-slate-900", on);
    fitBtn.classList.toggle("text-white", on);
    fitBtn.classList.toggle("bg-slate-50", !on);
    fitBtn.classList.toggle("text-slate-700", !on);
  }
  if(actBtn){
    const actualPct = Math.round((1 / Math.max(__att.baseScale, 0.0001)) * 100);
    const on = Math.round(__att.zoomPct) === actualPct;
    actBtn.classList.toggle("bg-slate-900", on);
    actBtn.classList.toggle("text-white", on);
    actBtn.classList.toggle("bg-white", !on);
    actBtn.classList.toggle("text-slate-600", !on);
  }
}

function __attApplyZoom(nextPct, opts){
  opts = opts || {};
  const stage = document.getElementById("attachment-stage");
  const canvas = document.getElementById("attachment-canvas");
  const img = document.getElementById("attachment-img");
  if(!stage || !canvas || !img || !__att.isReady) return;

  const keepCenter = opts.keepCenter !== false; // default true

  const stageW = stage.clientWidth || 1;
  const stageH = stage.clientHeight || 1;

  const oldW = canvas.offsetWidth || 1;
  const oldH = canvas.offsetHeight || 1;
  const relCx = (stage.scrollLeft + stageW/2) / oldW;
  const relCy = (stage.scrollTop + stageH/2) / oldH;

  const pct = __clamp(Math.round(nextPct), 25, 400);
  const scale = __att.baseScale * (pct / 100);

  const newW = Math.max(1, Math.round(__att.imgW * scale));
  const newH = Math.max(1, Math.round(__att.imgH * scale));

  canvas.style.width = newW + "px";
  canvas.style.height = newH + "px";
  canvas.classList.remove("hidden");

  __att.zoomPct = pct;
  __updateAttachmentZoomLabel();
  __syncAttachmentModeButtons();

  requestAnimationFrame(() => {
    // Always re-center on 100% (fit)
    if(pct === 100){
      stage.scrollLeft = Math.max(0, (newW - stageW) / 2);
      stage.scrollTop  = Math.max(0, (newH - stageH) / 2);
      return;
    }

    if(!keepCenter) return;

    const maxL = Math.max(0, newW - stageW);
    const maxT = Math.max(0, newH - stageH);
    stage.scrollLeft = __clamp(relCx * newW - stageW/2, 0, maxL);
    stage.scrollTop  = __clamp(relCy * newH - stageH/2, 0, maxT);
  });
}

function __setAttachmentMode(mode){
  if(!__att.isReady) return;
  if(mode === "actual"){
    const actualPct = Math.round((1 / Math.max(__att.baseScale, 0.0001)) * 100);
    __attApplyZoom(actualPct);
  }else{
    __attApplyZoom(100, { keepCenter: false });
  }
}

function __setAttachmentZoom(deltaPct){
  if(!__att.isReady) return;
  __attApplyZoom(__att.zoomPct + deltaPct);
}

function __resetAttachmentViewer(){
  __att.kind = "other";
  __att.imgW = 0;
  __att.imgH = 0;
  __att.baseScale = 1;
  __att.zoomPct = 100;
  __att.isReady = false;

  const stage = document.getElementById("attachment-stage");
  const canvas = document.getElementById("attachment-canvas");
  const img = document.getElementById("attachment-img");
  const frame = document.getElementById("attachment-frame");
  const fb = document.getElementById("attachment-fallback");
  const sub = document.getElementById("attachment-sub");

  if(sub) sub.textContent = "";
  __showAttachmentImgControls(false);
  __updateAttachmentZoomLabel();

  if(stage){
    stage.scrollLeft = 0;
    stage.scrollTop = 0;
    stage.classList.remove("is-panning");
    stage.classList.remove("attachment-pan-enabled");
    stage.style.overflow = "";
  }
  if(canvas){
    canvas.classList.add("hidden");
    canvas.style.width = "";
    canvas.style.height = "";
  }
  if(img){
    img.classList.add("hidden");
    img.src = "";
  }
  if(frame){
    frame.classList.add("hidden");
    frame.src = "about:blank";
  }
  if(fb){
    fb.classList.add("hidden");
  }
}


function openProfileLogoViewer(){
  try{
    const img = document.getElementById("p-logo-image");
    const url = img ? (img.getAttribute("src") || "").trim() : "";
    if(!url) return;
    const name = (document.getElementById("p-name")?.textContent || "").trim() || "Company";
    openAttachmentViewer(url, name + " â€¢ Logo", "logo");
  }catch(e){}
}

async function openAttachmentViewer(url, title, fileName){
  try{
    if(!url) return;
    const modal = document.getElementById("modal-attachment-viewer");
    if(!modal) return;

    __lockScrollForModal();

    // show modal first so stage has measurable size (important for fit scale)
    modal.classList.remove("hidden");

    __resetAttachmentViewer();

    let kind = __attachmentKind(url, fileName || title);
    if(kind === "other"){
      // Many Supabase object URLs don't carry .pdf/.jpg extensions
      kind = await __probeAttachmentKind(url);
    }
    // Last resort: try to decide by attempting to load as an image (works even when fetch/CORS is blocked)
    if(kind === "other"){
      const isImg = await __isDisplayableImage(url);
      kind = isImg ? "image" : "pdf";
    }
    __att.kind = kind;

    const t = document.getElementById("attachment-title");
    const sub = document.getElementById("attachment-sub");
    const openBtn = document.getElementById("attachment-open-newtab");
    const stage = document.getElementById("attachment-stage");
    const canvas = document.getElementById("attachment-canvas");
    const img = document.getElementById("attachment-img");
    const frame = document.getElementById("attachment-frame");
    const fb = document.getElementById("attachment-fallback");

    if(t) t.textContent = title || "Attachment";
    if(sub){ sub.textContent = ""; sub.classList.add("hidden"); }

    if(openBtn){
      openBtn.href = url;
      openBtn.classList.remove("hidden");
    }

    if(kind === "pdf"){
      __showAttachmentImgControls(false);
      if(stage) stage.style.overflow = "hidden";
      if(frame){
        frame.classList.remove("hidden");

        // Avoid showing the fallback message prematurely â€” many PDFs just need a moment to load.
        if(fb) fb.classList.add("hidden");

        let loaded = false;
        const onLoad = () => { loaded = true; try{ if(fb) fb.classList.add("hidden"); }catch(e){} };
        frame.addEventListener("load", onLoad, { once: true });

        frame.src = url;

        // If iframe doesn't load (blocked inline preview / attachment headers), show the fallback after a short delay.
        setTimeout(() => {
          try{
            if(!loaded && fb) fb.classList.remove("hidden");
          }catch(e){}
        }, 1800);
      }else{
        window.open(url, "_blank", "noopener");
      }
      return;
    }

    if(kind === "image"){
      __showAttachmentImgControls(true);
      if(stage) stage.style.overflow = "auto";

      if(canvas) canvas.classList.remove("hidden");
      if(img){
        img.classList.remove("hidden");

        // Critical: compute fit scale AFTER image loads
        img.onload = () => {
          try{
            if(!stage) return;
            __att.imgW = img.naturalWidth || img.width || 1;
            __att.imgH = img.naturalHeight || img.height || 1;

            const stageW = stage.clientWidth || 1;
            const stageH = stage.clientHeight || 1;

            // 100% = fit-to-stage (no upscaling by default)
            const fit = Math.min(stageW / __att.imgW, stageH / __att.imgH);
            __att.baseScale = Math.min(1, fit);

            __att.isReady = true;
            __att.zoomPct = 100;
            __updateAttachmentZoomLabel();
            __syncAttachmentModeButtons();

            __attApplyZoom(100, { keepCenter: false });
          }catch(e){ console.error(e); }
        };

        img.onerror = () => {
          __showAttachmentImgControls(false);
          if(fb) fb.classList.remove("hidden");
        };

        img.src = url;
      }
      return;
    }

    // fallback: no preview
    __showAttachmentImgControls(false);
    if(fb){
      fb.classList.remove("hidden");
    } else {
      window.open(url, "_blank", "noopener");
    }
  }catch(e){
    console.error("openAttachmentViewer error:", e);
    try{ window.open(url, "_blank", "noopener"); }catch(_){}
  }
}

function closeAttachmentViewer(){
  const modal = document.getElementById("modal-attachment-viewer");
  if(modal) modal.classList.add("hidden");
  __resetAttachmentViewer();
  __unlockScrollForModal();
}

document.addEventListener("DOMContentLoaded", () => {
  const fitBtn = document.getElementById("attachment-fit-btn");
  const actBtn = document.getElementById("attachment-actual-btn");
  const zin = document.getElementById("attachment-zoom-in");
  const zout = document.getElementById("attachment-zoom-out");

  if(fitBtn) fitBtn.onclick = () => __setAttachmentMode("fit");
  if(actBtn) actBtn.onclick = () => __setAttachmentMode("actual");

  // Step = 25% => 100 -> 125 -> 150 ...
  if(zin) zin.onclick = () => __setAttachmentZoom(25);
  if(zout) zout.onclick = () => __setAttachmentZoom(-25);

  // Drag-to-pan (by scrolling the stage)
  const stage = document.getElementById("attachment-stage");
  if(stage){
    let isDown = false, pid = null, sx = 0, sy = 0, sl = 0, st = 0;

    stage.addEventListener("pointerdown", (e) => {
      if(__att.kind !== "image") return;
      // left mouse / touch / pen
      if(e.pointerType === "mouse" && e.button !== 0) return;

      isDown = true;
      pid = e.pointerId;
      sx = e.clientX;
      sy = e.clientY;
      sl = stage.scrollLeft;
      st = stage.scrollTop;

      try{ stage.setPointerCapture(pid); }catch(_){}
      stage.classList.add("is-panning");
      e.preventDefault();
    });

    stage.addEventListener("pointermove", (e) => {
      if(!isDown || pid !== e.pointerId) return;
      stage.scrollLeft = sl - (e.clientX - sx);
      stage.scrollTop  = st - (e.clientY - sy);
      e.preventDefault();
    });

    const endPan = () => {
      isDown = false;
      pid = null;
      stage.classList.remove("is-panning");
    };

    stage.addEventListener("pointerup", endPan);
    stage.addEventListener("pointercancel", endPan);
    stage.addEventListener("pointerleave", endPan);
  }
});

document.addEventListener("keydown", (e) => {
  if(e.key === "Escape"){
    const modal = document.getElementById("modal-attachment-viewer");
    if(modal && !modal.classList.contains("hidden")) closeAttachmentViewer();
  }
});


// --- Project gallery viewer state (prev/next navigation) ---
let __galleryState = null;

function __isGalleryOpen(){
  const modal = document.getElementById("modal-gallery");
  return !!(modal && !modal.classList.contains("opacity-0") && !modal.classList.contains("pointer-events-none"));
}

function __setGalleryButtonLabels(){
  const prevBtn = document.getElementById("gallery-prev");
  const nextBtn = document.getElementById("gallery-next");
  const lang = (typeof currentLang !== "undefined" ? currentLang : (localStorage.getItem("bton_lang") || "en"));
  const isTR = (lang === "tr");
  const prevTxt = isTR ? "Ã–nceki" : "Previous";
  const nextTxt = isTR ? "Sonraki" : "Next";
  if(prevBtn){ prevBtn.setAttribute("aria-label", prevTxt); prevBtn.title = prevTxt; }
  if(nextBtn){ nextBtn.setAttribute("aria-label", nextTxt); nextBtn.title = nextTxt; }
}

function __renderGalleryIndex(idx){
  if(!__galleryState) return;
  const { title, urls } = __galleryState;
  const mainImg = document.getElementById("gallery-main-img");
  const caption = document.getElementById("gallery-caption");
  const thumbs = document.getElementById("gallery-thumbs");
  const prevBtn = document.getElementById("gallery-prev");
  const nextBtn = document.getElementById("gallery-next");

  const total = urls.length || 0;
  if(!total) return;

  // clamp + wrap
  let i = idx;
  if(i < 0) i = total - 1;
  if(i >= total) i = 0;
  __galleryState.idx = i;

  if(mainImg){
    mainImg.onerror = () => { try{ mainImg.onerror=null; }catch(e){} };
    mainImg.src = urls[i];
    // click image -> next (nice UX)
    mainImg.style.cursor = total > 1 ? "pointer" : "default";
    mainImg.onclick = total > 1 ? () => __stepGallery(1) : null;
  }
  if(caption) caption.textContent = `${title} (${i + 1}/${total})`;

  // Update thumbs active state
  if(thumbs){
    const kids = [...thumbs.querySelectorAll("img[data-gidx]")];
    kids.forEach(el => {
      const k = parseInt(el.getAttribute("data-gidx") || "0", 10);
      if(k === i){
        el.classList.add("ring-2","ring-white","opacity-100");
        el.classList.remove("opacity-70");
        try{ el.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" }); }catch(e){}
      }else{
        el.classList.remove("ring-2","ring-white");
        el.classList.add("opacity-70");
      }
    });
  }

  // Show/hide arrows if only 1 image
  const showNav = total > 1;
  if(prevBtn) prevBtn.style.display = showNav ? "" : "none";
  if(nextBtn) nextBtn.style.display = showNav ? "" : "none";
}

function __stepGallery(delta){
  if(!__galleryState) return;
  __renderGalleryIndex((__galleryState.idx || 0) + delta);
}

function openGallery(title, urls) {
  const modal = document.getElementById("modal-gallery");
  const mainImg = document.getElementById("gallery-main-img");
  const thumbs = document.getElementById("gallery-thumbs");
  const caption = document.getElementById("gallery-caption");
  const prevBtn = document.getElementById("gallery-prev");
  const nextBtn = document.getElementById("gallery-next");

  if(!modal) return;

  __lockScrollForModal();

  const safeUrls = Array.isArray(urls) ? urls.filter(Boolean) : [];
  __galleryState = { title: title || "", urls: safeUrls, idx: 0 };

  // Buttons
  __setGalleryButtonLabels();
  if(prevBtn) prevBtn.onclick = () => __stepGallery(-1);
  if(nextBtn) nextBtn.onclick = () => __stepGallery(1);

  // Build thumbs
  if(thumbs) thumbs.innerHTML = "";
  safeUrls.forEach((url, index) => {
    const thumb = document.createElement("img");
    thumb.src = url;
    thumb.setAttribute("data-gidx", String(index));
    thumb.className = "w-16 h-12 object-cover rounded-lg cursor-pointer opacity-70 hover:opacity-100 transition";
    thumb.onclick = () => __renderGalleryIndex(index);
    if(thumbs) thumbs.appendChild(thumb);
  });

  // Open with first
  __renderGalleryIndex(0);

  modal.classList.remove("opacity-0", "pointer-events-none");
}

// Keyboard navigation (only when gallery open)
document.addEventListener("keydown", (e) => {
  if(!__isGalleryOpen()) return;
  if(e.key === "Escape") return closeGallery();
  if(e.key === "ArrowLeft") { e.preventDefault(); __stepGallery(-1); }
  if(e.key === "ArrowRight"){ e.preventDefault(); __stepGallery(1); }
});

function closeGallery() {
    const modal = document.getElementById("modal-gallery");
    if(modal) modal.classList.add("opacity-0", "pointer-events-none");
    __galleryState = null;
    __unlockScrollForModal();
}


/* --- SERTÄ°FÄ°KA DOSYA YÃ–NETÄ°MÄ° --- */
let currentCertFile = null;
let existingCertFileUrl = null;

function handleCertFileSelect(input) {
    if (input.files && input.files[0]) {
        if (input.files[0].size > 5 * 1024 * 1024) {
            showToast("Too Large", "Max file size is 5MB.", "error");
            input.value = "";
            return;
        }
        currentCertFile = input.files[0];
        document.getElementById("cert-file-text").textContent = currentCertFile.name;
        document.getElementById("cert-file-label").classList.add("border-BTrustOn-accent", "bg-cyan-50");
    }
}

function removeCertFile() {
    currentCertFile = null;
    existingCertFileUrl = null;
    document.getElementById("cert-file-input").value = "";
    document.getElementById("cert-file-text").textContent = (t("ui_attach_proof_max_5mb_81863c") || "Attach Proof (Max 5MB)");
    document.getElementById("cert-file-label").classList.remove("border-BTrustOn-accent", "bg-cyan-50");
    document.getElementById("btn-remove-cert-file").classList.add("hidden");
    document.getElementById("current-cert-link").classList.add("hidden");
}
async function deleteLogo() {
    const ok = await uiConfirm(
      (t("confirm_remove_logo_msg") || (currentLang==="tr" ? "Åžirket logosunu kaldÄ±rmak istiyor musunuz?" : (currentLang==="es" ? "Â¿Eliminar el logotipo de la empresa?" : "Remove company logo?"))),
      {
        title: (t("confirm_title") || (currentLang==="tr" ? "Onay" : (currentLang==="es" ? "Confirmar" : "Confirm"))),
        okText: (t("confirm_remove") || (currentLang==="tr" ? "KaldÄ±r" : (currentLang==="es" ? "Eliminar" : "Remove"))),
        cancelText: (t("confirm_cancel") || (currentLang==="tr" ? "Ä°ptal" : (currentLang==="es" ? "Cancelar" : "Cancel"))),
        variant: "danger"
      }
    );
    if(!ok) return;

    // UI Temizle
    document.getElementById("edit-logo-img").src = "";
    document.getElementById("edit-logo-img").classList.add("hidden");
    document.getElementById("edit-logo-icon").classList.remove("hidden");
    selectedLogoFile = null; // SeÃ§ili dosyayÄ± iptal et

    // VeritabanÄ±ndan Sil
    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { error } = await supabaseClient
            .from('profiles')
            .update({ logo_url: null, updated_at: nowDate() })
            .eq('id', myCompanyIdOr(user.id));

        if(error) throw error;
        
        // Local hafÄ±zayÄ± gÃ¼ncelle
        if(selectedCompany) selectedCompany.logo_url = null;
        const localC = database.find(c => c.id == myCompanyIdOr(user.id));
        if(localC) localC.logo_url = null;
        
        showToast("Removed", (t("msg_logo_removed") || ((currentLang==="tr") ? "Logo baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±." : "Logo removed successfully.")), "success");

    } catch(e) {
        console.error(e);
        showToast("Error", "Could not remove logo.", "error");
    }
}
let selectedOwnerFile = null;

function toggleOwnerSection() {
    const isChecked = document.getElementById("edit-owner-toggle").checked;
    const box = document.getElementById("owner-inputs");
    if(isChecked) box.classList.remove("hidden");
    else box.classList.add("hidden");
}

function handleOwnerPhoto(input) {
    if (input.files && input.files[0]) {
        selectedOwnerFile = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById("preview-owner-img").src = e.target.result;
            document.getElementById("preview-owner-img").classList.remove("hidden");
            document.getElementById("icon-owner-img").classList.add("hidden");
        }
        reader.readAsDataURL(selectedOwnerFile);
    }
}

function deleteOwnerPhoto() {
    selectedOwnerFile = null;
    document.getElementById("edit-owner-photo").value = "";
    document.getElementById("preview-owner-img").src = "";
    document.getElementById("preview-owner-img").classList.add("hidden");
    document.getElementById("icon-owner-img").classList.remove("hidden");
    // Not: DB'den silme iÅŸlemi "Save" butonuna basÄ±nca yapÄ±lacak
}




/* =========================
   PROJECTS UX IMPROVEMENTS
   - Click any project -> viewer modal
   - Search + Sort (client-side, DOM reorder)
========================= */
let __pvProject = null;

function openProjectViewer(projectId){
  const arr = window.__projectsCache || (selectedCompany ? selectedCompany.projects : []) || [];
  const p = arr.find(x => String(x.id) === String(projectId));
  if(!p) return;

  __pvProject = p;

  const title = p.title || (t("ui_project") || "Project");
  const loc = p.loc || "";
  const desc = (p.desc && String(p.desc).trim()) ? p.desc : (t("ui_no_description") || "No description provided.");
  const coverPlaceholder = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%221200%22%20height%3D%22675%22%20viewBox%3D%220%200%201200%20675%22%3E%3Crect%20width%3D%221200%22%20height%3D%22675%22%20fill%3D%22%23f1f5f9%22/%3E%3Cpath%20d%3D%22M430%20365l130-140%20150%20185%20110-125%20210%20255H350z%22%20fill%3D%22%23e2e8f0%22/%3E%3C/svg%3E";
  const cover = p.cover_url || coverPlaceholder;
  const urls = Array.isArray(p.gallery_urls) ? p.gallery_urls : [];

  const tEl = document.getElementById("pv-title");
  const mEl = document.getElementById("pv-meta");
  const dEl = document.getElementById("pv-desc");
  const cEl = document.getElementById("pv-cover");
  const btnCover = document.getElementById("pv-cover-btn");
  const infoEl = document.getElementById("pv-gallery-info");
  const btnGal = document.getElementById("pv-open-gallery");
  const thumbs = document.getElementById("pv-thumbs");

  if(tEl) tEl.textContent = title;
  if(mEl) {
    const nice = (p.project_date ? new Date(p.project_date).toLocaleDateString((currentLang==="tr" ? "tr-TR" : (currentLang==="es" ? "es-ES" : "en-US")),{year:'numeric',month:'short',day:'2-digit'}) : "");
    if (loc && nice) mEl.textContent = `ðŸ“ ${loc}  â€¢  ðŸ“… ${nice}`;
    else if (loc) mEl.textContent = `ðŸ“ ${loc}`;
    else if (nice) mEl.textContent = `ðŸ“… ${nice}`;
    else mEl.textContent = "";
  }
  if(dEl) dEl.textContent = desc;
  if (cEl) {
    cEl.onerror = () => { try { cEl.onerror = null; cEl.src = coverPlaceholder; } catch(e){} };
    cEl.src = cover;
  }

  if(infoEl) infoEl.textContent = urls.length ? ( (t("ui_gallery_images_n") || "{n} images").replace("{n}", urls.length) ) : (t("ui_no_gallery_images") || "No gallery images.");
if(btnGal){
    if(urls.length) btnGal.classList.remove("hidden");
    else btnGal.classList.add("hidden");
  }

  // Cover click opens gallery only if exists
  if(btnCover){
    if(urls.length){
      btnCover.classList.add("cursor-pointer");
      btnCover.onclick = () => openGallery(title, urls);
      btnCover.title = "Click to view gallery";
    }else{
      btnCover.classList.remove("cursor-pointer");
      btnCover.onclick = null;
      btnCover.title = "";
    }
  }

  if(thumbs){
    thumbs.innerHTML = "";
    if(urls.length){
      urls.slice(0, 12).forEach(u => {
        const b = document.createElement("button");
        b.className = "rounded-lg overflow-hidden border border-gray-200 hover:border-BTrustOn-accent transition";
        b.innerHTML = `<img src="${u}" class="w-full h-16 object-cover">`;
        b.onclick = () => openGallery(title, urls);
        thumbs.appendChild(b);
      });
    }
  }

  const modal = document.getElementById("project-viewer");
  if(modal) modal.classList.remove("hidden");
}

function openProjectViewerGallery(){
  if(!__pvProject) return;
  const urls = Array.isArray(__pvProject.gallery_urls) ? __pvProject.gallery_urls : [];
  if(urls.length) openGallery(__pvProject.title || "Gallery", urls);
}

function closeProjectViewer(){
  const modal = document.getElementById("project-viewer");
  if(modal) modal.classList.add("hidden");
  __pvProject = null;
}

function filterProjectsUI(q){
  q = (q||"").toLowerCase().trim();
  const list = document.getElementById("p-projects-list");
  if(!list) return;
  [...list.children].forEach(card => {
    const hay = (card.dataset && card.dataset.hay ? card.dataset.hay : "").toLowerCase();
    card.style.display = (!q || hay.includes(q)) ? "" : "none";
  });
}

function sortProjectsUI(mode){
  const list = document.getElementById("p-projects-list");
  if(!list) return;

  const cards = [...list.children].filter(el => el.dataset && el.dataset.pid);

  const getTitle = (el) => (el.dataset.title || "").toLowerCase();
  const getCreated = (el) => parseFloat(el.dataset.created || "0") || 0;
  const getPDate = (el) => {
    const d = (el.dataset.pdate || "").trim();
    const ts = Date.parse(d);
    return Number.isFinite(ts) ? ts : getCreated(el);
  };

  if(mode === "az") cards.sort((a,b)=> getTitle(a).localeCompare(getTitle(b)));
  else if(mode === "oldest") cards.sort((a,b)=> getPDate(a) - getPDate(b));
  else cards.sort((a,b)=> getPDate(b) - getPDate(a)); // newest default

  cards.forEach(c => list.appendChild(c));
}


</script>

<div class="hidden fixed inset-0 z-[99990]" id="asset-viewer">
<div class="absolute inset-0 bg-slate-900/60" onclick="closeAssetViewer()"></div>
<div class="relative max-w-3xl mx-auto mt-24 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
<div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
<div class="min-w-0">
<div class="text-sm font-extrabold text-BTrustOn-primary truncate" id="av-title"></div>
<div class="text-[11px] text-gray-400 mt-0.5 truncate" id="av-meta"></div>
</div>
<div class="flex items-center gap-3">
<div id="av-status"></div>
<button class="w-9 h-9 rounded-full hover:bg-gray-100 text-gray-500" onclick="closeAssetViewer()">
<i class="fa-solid fa-xmark"></i>
</button>
</div>
</div>
<div class="p-5">
<div class="grid grid-cols-1 md:grid-cols-12 gap-4">
<div class="md:col-span-8">
<div class="text-xs font-bold text-gray-500 uppercase tracking-wider" data-i18n="lbl_asset_specs">Specs</div>
<div class="mt-1 text-sm text-gray-700 whitespace-pre-wrap break-words bton-wrap-anywhere" id="av-spec"></div>
<div class="mt-5 text-xs font-bold text-gray-500 uppercase tracking-wider" data-i18n="ui_document_094535">Document</div>
<div class="mt-2" id="av-file"></div>
</div>
<div class="md:col-span-4">
<div class="rounded-xl border border-gray-200 bg-slate-50 p-4">
<div class="text-[11px] text-gray-400" data-i18n="ui_quantity_694e8d">Quantity</div>
<div class="text-xl font-extrabold text-gray-800 mt-1" id="av-qty"></div>
<div class="mt-4 text-[11px] text-gray-400" data-i18n="ui_last_updated_ffbb33"></div>
<div class="text-xs font-bold text-gray-700 mt-1" id="av-updated"></div>
</div>
<div class="mt-3 text-[11px] text-gray-400" data-i18n="ui_tip_click_the_document_button_to_8bfdfb">
            Tip: Click the document button to open the attached file (PDF, Excel, etc.).
          </div>
</div>
</div>
</div>
</div>
</div>
<!-- =========================
       ATTACHMENT VIEWER MODAL
       (Assets + Certificates)
  ========================== -->
<div class="hidden fixed inset-0 z-[120000]" id="modal-attachment-viewer">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAttachmentViewer()"></div>
<div class="relative mx-auto w-[95vw] max-w-5xl h-[86vh] mt-[6vh] bg-white rounded-2xl shadow-2xl border border-white/40 overflow-hidden flex flex-col">
<div class="flex items-center justify-between gap-3 px-4 py-3 border-b border-slate-100 bg-white/90">
<div class="min-w-0">
<div class="text-sm font-extrabold text-slate-800 truncate" data-i18n="attachment_title" id="attachment-title">Attachment</div>
<div class="hidden text-[11px] text-slate-500 truncate" id="attachment-sub"></div>
</div>
<div class="flex items-center gap-2 shrink-0">
<!-- Image controls (only shown for images) -->
<div class="hidden flex items-center gap-1 sm:gap-2 mr-1 flex-nowrap whitespace-nowrap" id="attachment-img-controls">
<button class="px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white transition text-xs font-bold" data-i18n="attachment_fit" id="attachment-fit-btn" type="button">
              Fit
            </button>
<button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition text-xs font-bold" data-i18n="attachment_mode_1_1" id="attachment-actual-btn" type="button">
              1:1
            </button>
<div class="hidden sm:flex items-center gap-1">
<button aria-label="Zoom out" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition grid place-items-center" data-i18n-aria="attr_zoom_out_52ebc2" id="attachment-zoom-out" type="button">
<i class="fa-solid fa-minus"></i>
</button>
<div class="min-w-[58px] text-center text-[11px] font-extrabold text-slate-500 select-none" id="attachment-zoom-label">100%</div>
<button aria-label="Zoom in" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition grid place-items-center" data-i18n-aria="attr_zoom_in_7b9115" id="attachment-zoom-in" type="button">
<i class="fa-solid fa-plus"></i>
</button>
</div>
</div>
<a class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white transition text-xs font-bold" href="#" id="attachment-open-newtab" rel="noopener noreferrer" target="_blank">
<i class="fa-solid fa-arrow-up-right-from-square text-[12px]"></i>
<span class="hidden sm:inline" data-i18n="attachment_open">Open</span>
</a>
<button aria-label="Close" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:bg-slate-900 hover:text-white transition grid place-items-center" data-i18n-aria="attr_close_d3d2e6" onclick="closeAttachmentViewer()" type="button">
<i class="fa-solid fa-xmark"></i>
</button>
</div>
</div>
<div class="flex-1 bg-slate-50/60 relative">
<div class="absolute inset-0 p-3 overflow-auto attachment-pan-stage" id="attachment-stage">
<div class="hidden relative mx-auto my-auto" id="attachment-canvas">
<img alt="Attachment preview" class="block w-full h-full object-contain select-none" draggable="false" id="attachment-img">
</img></div>
<iframe class="hidden w-full h-full" data-i18n-title="attr_attachment_preview_68181f" id="attachment-frame" title="Attachment preview"></iframe>
<div class="hidden absolute inset-0 flex items-center justify-center p-6" id="attachment-fallback">
<div class="bg-white/90 border border-slate-200 rounded-2xl p-6 shadow-glass text-center max-w-md">
<div class="w-12 h-12 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center mx-auto mb-3">
<i class="fa-solid fa-file text-slate-500"></i>
</div>
<div class="text-sm font-extrabold text-slate-800 mb-1" data-i18n="attachment_preview_not_available">Preview not available</div>
<div class="text-xs text-slate-500" data-i18n="attachment_to_view_new_tab">Use Open to view this file in a new tab.</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Confirm Modal -->
<div class="hidden fixed inset-0 z-[120000] items-center justify-center" id="confirm-modal">
<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" id="confirm-overlay"></div>
<div class="relative w-[92%] max-w-md rounded-2xl bg-white shadow-2xl border border-slate-200 p-5">
<div class="flex items-start justify-between gap-3">
<div class="min-w-0">
<div class="text-slate-900 font-semibold text-lg" data-i18n="ui_confirm_70d9be" id="confirm-title">Confirm</div>
<div class="text-slate-600 mt-1 text-sm leading-relaxed break-words" id="confirm-message"></div>
</div>
<button class="shrink-0 w-9 h-9 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50" data-i18n="ui_9899bf" id="confirm-x">âœ•</button>
</div>
<div class="mt-5 flex justify-end gap-2">
<button class="px-4 h-10 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50" data-i18n="btn_cancel" id="confirm-cancel">
        Cancel
      </button>
<button class="px-4 h-10 rounded-xl bg-slate-900 text-white hover:opacity-90" data-i18n="upgrade_btn_ok" id="confirm-ok">
        OK
      </button>
</div>
</div>
</div>


<script>
/* MOBILE: keep inbox tabs on one row; shorten INBOX label in Turkish (SAFE: does NOT remove badges/icons) */
(function(){
  const mq = window.matchMedia && window.matchMedia('(max-width: 520px)');

  function getLang(){
    try{
      if (typeof currentLang !== "undefined" && currentLang) return String(currentLang).toLowerCase();
      return String(localStorage.getItem("bton_lang") || localStorage.getItem("lang") || "en").toLowerCase();
    }catch(e){ return "en"; }
  }

  function apply(){
    const btn = document.getElementById("btn-tab-inbox");
    if(!btn) return;

    // only touch the label span; keep icons + badges intact
    const label = btn.querySelector('span[data-i18n]') || btn.querySelector('span');
    if(!label) return;

    // remember desktop label once (after i18n applied, if any)
    if(!label.dataset.desktopLabel) label.dataset.desktopLabel = (label.textContent || "").trim();

    const isMobile = mq ? mq.matches : (window.innerWidth <= 520);
    const lang = getLang();

    if(isMobile && (lang === "tr" || lang.startsWith("tr-"))){
      label.textContent = "GELEN";
    } else {
      label.textContent = label.dataset.desktopLabel || label.textContent;
    }
  }

  // run now + on resize
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", () => setTimeout(apply, 0), { once:true });
  } else {
    setTimeout(apply, 0);
  }

  window.addEventListener("resize", apply);
  if(mq){
    try{ mq.addEventListener("change", apply); } catch(e){ try{ mq.addListener(apply); }catch(_e){} }
  }

  // if your i18n code reruns dynamically, allow it to re-apply the desktop label baseline
  window.addEventListener("bton:i18n_applied", () => {
    try {
      const btn = document.getElementById("btn-tab-inbox");
      const label = btn && (btn.querySelector('span[data-i18n]') || btn.querySelector('span'));
      if(label) label.dataset.desktopLabel = (label.textContent || "").trim();
    } catch(e){}
    apply();
  });
})();
</script>

<script>
/* =========================
   STABILITY: global error guards
   - shows a minimal toast instead of leaving the app in a broken state
========================= */
(function(){
  let lastToastAt = 0;
  function safeToast(title, msg, type){
    const now = Date.now();
    if (now - lastToastAt < 4500) return;
    lastToastAt = now;
    try {
      if (typeof showToast === "function") showToast(title, msg, type || "error");
      else console.error(title, msg);
    } catch(e){ console.error(title, msg, e); }
  }

  window.addEventListener("unhandledrejection", (ev) => {
    try {
      const isTR = (typeof currentLang !== "undefined" && currentLang === "tr");
      const title = isTR ? "Beklenmeyen hata" : "Unexpected error";
      const base = isTR ? "Bir iÅŸlem sÄ±rasÄ±nda hata oluÅŸtu." : "Something went wrong during an action.";
      const detail = (typeof BTON_DEBUG !== "undefined" && BTON_DEBUG) ? (" " + (ev?.reason?.message || String(ev?.reason || ""))) : "";
      safeToast(title, (base + detail).trim(), "error");
    } catch(e){}
  });

  window.addEventListener("error", (ev) => {
    try {
      const isTR = (typeof currentLang !== "undefined" && currentLang === "tr");
      const title = isTR ? "Beklenmeyen hata" : "Unexpected error";
      const base = isTR ? "Sayfa Ã¼zerinde bir hata oluÅŸtu." : "An error occurred on the page.";
      const detail = (typeof BTON_DEBUG !== "undefined" && BTON_DEBUG) ? (" " + (ev?.error?.message || ev?.message || "")) : "";
      safeToast(title, (base + detail).trim(), "error");
    } catch(e){}
  });
})();

/* Floating tooltips for .bton-tip[data-tip] (not clipped by overflow) */
(function(){
  try{
    if (document.getElementById("bton-floating-tooltip")) return;

    const tip = document.createElement("div");
    tip.id = "bton-floating-tooltip";
    document.body.appendChild(tip);

    let activeEl = null;
    let raf = null;

    function setText(msg){
      tip.textContent = msg || "";
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function position(el){
      if (!el) return;
      const msg = el.getAttribute("data-tip");
      if (!msg) return;

      // ensure rendered to measure
      tip.dataset.show = "1";
      tip.style.maxWidth = Math.min(360, window.innerWidth - 24) + "px";
      // allow wrap
      tip.style.whiteSpace = "normal";

      const r = el.getBoundingClientRect();
      const tw = tip.offsetWidth;
      const th = tip.offsetHeight;

      let x = r.left + (r.width / 2) - (tw / 2);
      x = clamp(x, 12, window.innerWidth - tw - 12);

      let y = r.top - th - 10; // above
      if (y < 12) y = r.bottom + 10; // below if no space

      tip.style.left = Math.round(x) + "px";
      tip.style.top  = Math.round(y) + "px";
    }

    function show(el){
      const msg = el.getAttribute("data-tip");
      if (!msg) return;
      activeEl = el;
      setText(msg);
      position(el);
    }
    function hide(el){
      if (activeEl && el && activeEl !== el) return;
      activeEl = null;
      tip.dataset.show = "0";
    }

    function scheduleReposition(){
      if (!activeEl) return;
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => position(activeEl));
    }

    document.addEventListener("pointerenter", (e) => {
      const el = e.target && e.target.closest ? e.target.closest(".bton-tip[data-tip]") : null;
      if (!el) return;
      show(el);
    }, true);

    document.addEventListener("pointerleave", (e) => {
      const el = e.target && e.target.closest ? e.target.closest(".bton-tip[data-tip]") : null;
      if (!el) return;
      hide(el);
    }, true);

    window.addEventListener("scroll", scheduleReposition, true);
    window.addEventListener("resize", scheduleReposition, true);

    document.addEventListener("pointermove", () => {
      // if the cursor is moving with the tooltip shown, keep it placed correctly
      scheduleReposition();
    }, { passive: true });

  }catch(e){}
})();

</script>

<!-- =========================
     Welcome Modal (shown after join)
========================= -->
<div id="bton-welcome-overlay" class="hidden" aria-hidden="true">
  <div class="bton-welcome-backdrop" onclick="btonHideWelcomeModal()"></div>
  <div class="bton-welcome-card" role="dialog" aria-modal="true" aria-labelledby="bton-welcome-title">
    <div class="bton-welcome-top">
      <div class="bton-welcome-badge">
        <span data-i18n="ui_welcome_badge_2aa1d1">BTRUSTON</span>
      </div>
      <button class="bton-welcome-close" type="button" aria-label="Close" onclick="btonHideWelcomeModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="bton-welcome-body">
      <div class="bton-welcome-title" id="bton-welcome-title" data-i18n="ui_welcome_title_bton_9d3e2b">BTrustOn'a hoÅŸ geldiniz</div>
      <div class="bton-welcome-text" data-i18n="ui_welcome_text_boost_1c4f72">HoÅŸ geldiniz. Profiliniz, iÅŸ dÃ¼nyasÄ±ndaki dijital vitrininizdir. Sertifika ve projelerinizle uzmanlÄ±ÄŸÄ±nÄ±zÄ± kanÄ±tlayÄ±n, envanterinizi paylaÅŸarak kapasitenizi sergileyin. BTrustOn aÄŸÄ±nda gÃ¼vene dayalÄ± ve sÃ¼rdÃ¼rÃ¼lebilir iÅŸ ortaklÄ±klarÄ±na bir adÄ±m daha yaklaÅŸÄ±n.</div>
      <div class="bton-welcome-cta">
        <button class="bton-welcome-btn primary" type="button" onclick="btonWelcomeCta()" data-i18n="ui_start_building_profile_7b6a91">KURUMSAL KÄ°MLÄ°ÄžÄ°NÄ° GÃœÃ‡LENDÄ°R</button>
      </div>
    </div>
  </div>
</div>

</body></html>
