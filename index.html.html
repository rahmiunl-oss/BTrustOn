<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BtrustOn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@500;700&display=swap"
    rel="stylesheet"
  />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            BTrustOn: {
              primary: "#0F172A",
              accent: "#06b6d4",
              darkAccent: "#0891b2",
              surface: "#F8FAFC",
              border: "#E2E8F0",
              text: "#334155",
            },
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
            header: ["Oswald", "sans-serif"],
          },
          boxShadow: {
            glass: "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
            float: "0 20px 40px -5px rgba(6, 182, 212, 0.15)",
            glow: "0 0 15px rgba(6, 182, 212, 0.4)",
          },
        },
      },
    };

  </script>
  <style>
    .hidden-view {
      display: none !important;
    }
/* Marka Rengi Stili */
.toast.brand { border-color: #06b6d4 !important; }
.toast.brand i { color: #06b6d4 !important; }
    .fade-in {
      animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .modal {
      transition: opacity 0.25s ease;
    }
    body.modal-active {
      overflow-x: hidden;
      overflow-y: visible !important;
    }
    .dot-map-bg {
      background-image: radial-gradient(#94a3b8 1px, transparent 1px);
      background-size: 30px 30px;
    }
    /* EditÃ¶r input stilleri */
    .input-field:focus {
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.1);
        border-color: #06b6d4;
    }
/* Ã–zel Scrollbar TasarÄ±mÄ± */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
/* TOAST NOTIFICATION STYLES */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      min-width: 300px;
      background: white;
      border-left: 4px solid;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out forwards;
      opacity: 0;
      transform: translateX(100%);
    }

    .toast.success { border-color: #10b981; } /* YeÅŸil */
    .toast.error { border-color: #ef4444; }   /* KÄ±rmÄ±zÄ± */

    .toast i { font-size: 18px; }
    .toast.success i { color: #10b981; }
    .toast.error i { color: #ef4444; }

    .toast-content { flex: 1; }
    .toast-title { font-weight: bold; font-size: 14px; color: #1f2937; display: block; margin-bottom: 2px;}
    .toast-msg { font-size: 12px; color: #6b7280; }

    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(10px); }
    }
/* ... BurasÄ± eski CSS kodlarÄ±nÄ±zÄ±n bittiÄŸi yer ... */

    /* ðŸ‘‡ðŸ‘‡ðŸ‘‡ BURAYA YAPIÅžTIRIN ðŸ‘‡ðŸ‘‡ðŸ‘‡ */

    /* --- SIGNATURE INBOX STYLES --- */
    #inbox-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px); /* Buzlu cam efekti */
      border-left: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: -10px 0 30px rgba(15, 23, 42, 0.15);
      z-index: 9999;
      transform: translateX(100%); /* BaÅŸlangÄ±Ã§ta gizli */
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    #inbox-panel.open {
      transform: translateX(0); /* AÃ§Ä±lÄ±nca gelir */
    }

    .inbox-item {
      position: relative;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .inbox-item:hover {
      background: rgba(6, 182, 212, 0.05); /* Hoverda hafif turkuaz */
    }

    .inbox-item.unread {
      background: white;
      border-left-color: #06b6d4; /* OkunmamÄ±ÅŸsa sol taraf turkuaz */
    }
    
    .inbox-item.unread::after {
      content: '';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 8px;
      height: 8px;
      background: #ef4444; /* KÄ±rmÄ±zÄ± nokta */
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
      animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* ðŸ‘†ðŸ‘†ðŸ‘† BURADA BÄ°TÄ°YOR ðŸ‘†ðŸ‘†ðŸ‘† */

  </style> 
  </style>

  <!-- Supabase Auth client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ncssozhpwzvzeneaumlz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jc3Nvemhwd3p2emVuZWF1bWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzkyMjgsImV4cCI6MjA4MDQxNTIyOH0.pk9p8_KRcmcbzhulo4dA06uk_3FOFXwVT1vNiYOEfck";

    const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

</script>

  <!-- Boot overlay: prevents dashboard flash on refresh -->
  <style>
    html.booting body { overflow: hidden; }

    /* During boot we always prevent Dashboard flash */
    html.booting #view-dashboard,
    html.booting #view-editor,
    html.booting #view-message,
    html.booting #view-admin { display: none !important; }

    /* Only hide profile view on "home boot". On company-route boot we want skeleton to be visible. */
    html.booting:not(.route-company) #view-profile { display: none !important; }

    #boot-overlay {
      position: fixed;
      inset: 0;
      z-index: 999999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: radial-gradient(ellipse at top, rgba(6,182,212,0.10), transparent 55%),
                  linear-gradient(to bottom, rgba(248,250,252,0.92), rgba(255,255,255,0.98));
      backdrop-filter: blur(10px);
    }
    html.booting #boot-overlay { display: flex; }

    .boot-card {
      width: min(520px, 92vw);
      border: 1px solid rgba(226,232,240,0.9);
      background: rgba(255,255,255,0.9);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.12);
      padding: 20px 18px;
    }
    .boot-title {
      font-family: Oswald, sans-serif;
      font-weight: 700;
      letter-spacing: .03em;
      color: #0F172A;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .boot-sub {
      color: #64748B;
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 14px;
    }
    .boot-bar {
      width: 100%;
      height: 8px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }
    .boot-bar::after{
      content:"";
      position:absolute;
      inset:0;
      transform: translateX(-55%);
      background: linear-gradient(90deg, transparent, rgba(6,182,212,0.55), transparent);
      animation: boot-sweep 1.05s ease-in-out infinite;
    }
    @keyframes boot-sweep { to { transform: translateX(55%); } }
  
/* ===== PROFILE SKELETON (BTrustOn O loader) ===== */
#profile-skeleton.hidden { display: none !important; }

#profile-skeleton .skel {
  border-radius: 18px;
  background: linear-gradient(90deg, rgba(15,23,42,.06), rgba(15,23,42,.12), rgba(15,23,42,.06));
  background-size: 200% 100%;
  animation: btonShimmer 1.1s linear infinite;
  border: 1px solid rgba(148,163,184,.25);
  box-shadow: 0 12px 30px rgba(2,6,23,.06);
}
#profile-skeleton .skel-card { background-clip: padding-box; }

@keyframes btonShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* "O" = DOLAN + DÃ–NEN HALKA */
.bton-o { display:inline-flex; width: 1.05em; height: 1.05em; align-items:center; justify-content:center; }
.bton-o-svg { width: 1.05em; height: 1.05em; }
.bton-o-track {
  fill: none;
  stroke: rgba(0, 198, 255, .18);
  stroke-width: 4;
}
.bton-o-prog {
  fill: none;
  stroke: url(#btonGradProfile);
  stroke-width: 4;
  stroke-linecap: round;
  stroke-dasharray: 88;
  stroke-dashoffset: 88;
  transform-origin: 50% 50%;
  will-change: transform, opacity, filter;
  filter: drop-shadow(0 0 6px rgba(0, 198, 255, .22)) drop-shadow(0 0 12px rgba(0, 120, 255, .14));
  animation:
    btonDash 1.35s cubic-bezier(.4,0,.2,1) infinite,
    btonSpin 1.15s cubic-bezier(.4,0,.2,1) infinite,
    btonGlowPulse 1.6s ease-in-out infinite;
}

.bton-on-only{
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:0;
  line-height:1;
}
/* ===== BTrustOn LOADER ALIGNMENT (baseline fix) ===== */
.bton-loader-logo{
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:0;
  line-height:1;
}
.bton-onwrap{
  display:flex;
  align-items:baseline;
}
.bton-o{
  display:inline-flex;
  width:1.05em;
  height:1.05em;
  align-items:center;
  justify-content:center;
  position:relative;
  top:0.06em; /* tiny baseline correction */
}
.bton-o-svg{
  width:1.05em;
  height:1.05em;
  display:block;
}
.bton-n{ line-height:1; }
.bton-o-prog-boot{ stroke: url(#btonGradBoot) !important; }

@keyframes btonSpin { 
  to { transform: rotate(360deg); } 
}

@keyframes btonDash {
  0%   { stroke-dashoffset: 88; opacity: .55; }
  35%  { stroke-dashoffset: 28; opacity: 1; }
  60%  { stroke-dashoffset: 18; opacity: .95; }
  100% { stroke-dashoffset: 88; opacity: .55; }
}

@keyframes btonGlowPulse {
  0%, 100% {
    filter: drop-shadow(0 0 6px rgba(0, 198, 255, .18)) drop-shadow(0 0 12px rgba(0, 120, 255, .10));
  }
  50% {
    filter: drop-shadow(0 0 10px rgba(0, 198, 255, .32)) drop-shadow(0 0 18px rgba(0, 120, 255, .20));
  }
}

@media (prefers-reduced-motion: reduce) {
  .bton-o-prog { 
    animation: none !important; 
    stroke-dashoffset: 40;
  }
}

</style>
  <script>
    (function(){
      try{
        const h = (window.location.hash || "").trim();
        const root = document.documentElement;
        if (h.startsWith("#company=")) root.classList.add('booting','route-company');
        else root.classList.add('booting');
      }catch(e){}
    })();
  </script>

</head>
<body class="bg-gray-50 text-BTrustOn-text font-sans antialiased relative">
<div id="toast-container"></div>

<div id="boot-overlay" aria-live="polite" aria-busy="true">
  <span class="sr-only">Loadingâ€¦</span>
  <div class="bton-on-only text-6xl md:text-7xl font-sans font-bold tracking-tight leading-none select-none" aria-hidden="true">
    <span class="bton-o" aria-hidden="true">
      <svg viewBox="0 0 40 40" class="bton-o-svg">
        <defs>
          <linearGradient id="btonGradBoot" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#00C6FF"/>
            <stop offset="1" stop-color="#0078FF"/>
          </linearGradient>
          <filter id="btonGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="1.6" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <circle class="bton-o-track" cx="20" cy="20" r="14"></circle>
        <circle class="bton-o-prog bton-o-prog-boot" cx="20" cy="20" r="14" filter="url(#btonGlow)"></circle>
      </svg>
    </span>
    <span class="bton-n bg-clip-text text-transparent bg-gradient-to-r from-[#00C6FF] to-[#0078FF]">n</span>
  </div>
</div>


  <div
    class="fixed inset-0 z-[-1] dot-map-bg opacity-[0.4] pointer-events-none"
  ></div>
  <div
    class="fixed inset-0 z-[-2] bg-gradient-to-tr from-blue-50 via-white to-cyan-50/30"
  ></div>

  <nav
    class="sticky top-0 z-40 bg-white/70 backdrop-blur-md border-b border-white/50 h-24 transition-all">
    <div
      class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center"
    >
    <div 
  onclick="showMainView()" 
  class="cursor-pointer select-none flex items-center h-full pr-4 gap-0.5"
>
    <span class="text-4xl font-sans font-bold text-[#0A2A43] tracking-tight leading-none">
        BTrust
    </span>

    <span class="text-4xl font-sans font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#00C6FF] to-[#0078FF] leading-none drop-shadow-sm">
        On
    </span>
</div>

    <div class="flex items-center gap-3 text-sm font-medium">

  <button
    id="back-btn"
    onclick="showMainView()"
    class="hidden hidden-view items-center gap-2 text-gray-500 hover:text-BTrustOn-primary transition px-3 py-2 rounded-lg hover:bg-gray-100"
  >
    <i class="fa-solid fa-arrow-left"></i>
    <span class="hidden md:inline" data-i18n="back">BACK</span>
  </button>

  <div id="guest-actions" class="flex items-center gap-3">
    <button
      id="btn-partner-login"
      onclick="openLoginModal()"
      class="text-gray-600 hover:text-BTrustOn-primary px-3 py-2 transition font-semibold"
    >
      <i class="fa-solid fa-lock mr-2 text-xs text-gray-400"></i>
      Partner Login
    </button>

    <button
      id="btn-join-network"
      onclick="toggleModal('modal-join')"
      class="bg-BTrustOn-primary text-white px-5 py-2.5 rounded-full font-bold hover:bg-BTrustOn-accent transition text-xs shadow-lg shadow-blue-900/20 tracking-wide flex items-center gap-2"
    >
      <i class="fa-solid fa-paper-plane"></i>
      <span data-i18n="join">JOIN NETWORK</span>
    </button>
  </div>

  <div id="user-actions" class="hidden flex items-center gap-3 border-l border-gray-200 pl-4 ml-1">
    
    <button
      id="btn-nav-upgrade"
      onclick="toggleModal('modal-upgrade')"
      class="hidden flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-amber-100 to-amber-200 text-amber-800 border border-amber-300 rounded-lg text-xs font-bold hover:shadow-md hover:scale-105 transition mr-2 animate-pulse-slow"
    >
      <i class="fa-solid fa-crown text-amber-600"></i>
      <span class="hidden md:inline">UPGRADE</span>
    </button>
    <button
      onclick="toggleInbox()"
      class="relative w-10 h-10 rounded-full bg-white border border-gray-100 text-gray-400 hover:text-BTrustOn-accent hover:border-BTrustOn-accent hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] transition-all duration-300 flex items-center justify-center mr-2 group"
    >
      <i class="fa-solid fa-bell text-lg group-hover:animate-swing"></i>
      
      <span id="nav-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white shadow-sm animate-bounce">
        0
      </span>
    </button>
    <button
      id="btn-my-company"
      onclick="openMyCompanyIfExists()"
      class="flex items-center gap-2 px-4 py-2 bg-cyan-50 text-BTrustOn-accent border border-cyan-200 rounded-lg text-xs font-bold hover:bg-cyan-100 hover:border-cyan-300 transition shadow-sm"
    >
      <i class="fa-solid fa-building-user"></i>
      MY COMPANY
    </button>

    <button
      id="btn-admin-panel"
      onclick="showAdminView()"
      class="hidden flex items-center gap-2 px-3 py-2 bg-slate-800 text-white border border-slate-700 rounded-lg text-xs font-bold hover:bg-slate-700 transition shadow-sm mr-2"
    >
      <i class="fa-solid fa-user-shield"></i>
      ADMIN
    </button>

    <button
      id="btn-partner-logout"
      onclick="partnerLogout()"
      class="text-gray-400 hover:text-red-500 transition px-2 py-2"
      title="Logout"
    >
      <i class="fa-solid fa-right-from-bracket text-lg"></i>
    </button>
  </div>

</div>
    </div>
  </nav>

  <div id="view-dashboard" class="fade-in">
    <header class="pt-4 pb-4 px-4 text-center relative overflow-hidden z-10">
      
      <h1
        id="hero-title"
        class="text-4xl md:text-6xl font-header font-bold text-BTrustOn-primary mb-3 leading-tight tracking-tight drop-shadow-sm py-1"
      ></h1>
      
      <p
        id="hero-desc"
        class="text-base md:text-lg text-gray-500 mb-6 max-w-2xl mx-auto font-light leading-relaxed"
      ></p>

      <div class="w-[95%] md:max-w-3xl mx-auto relative mb-6 z-20 transition-all duration-300">
        
        <div class="absolute inset-0 bg-BTrustOn-accent/20 blur-2xl rounded-full opacity-0 hover:opacity-100 transition-opacity duration-500"></div>

        <div
          class="relative bg-white/90 backdrop-blur-xl p-1.5 md:p-2 rounded-full shadow-2xl flex items-center border border-white/80 ring-4 ring-transparent focus-within:ring-cyan-50/50 focus-within:scale-[1.02] transition-all duration-300"
        >
          <div class="pl-4 pr-3 text-BTrustOn-accent shrink-0">
            <i class="fa-solid fa-magnifying-glass text-lg md:text-xl animate-pulse"></i>
          </div>
          
          <input
            type="text"
            id="search-input"
            onkeyup="handleSearchInput(this.value)" 
            onkeydown="if(event.key === 'Enter') { handleSearchInput(this.value); document.querySelector('main').scrollIntoView({ behavior: 'smooth' }); }"
            class="w-full bg-transparent outline-none text-gray-700 text-base md:text-lg placeholder-gray-400 font-light h-10 md:h-12"
            placeholder=""
          />
          
          <button
            onclick="document.querySelector('main').scrollIntoView({ behavior: 'smooth' });"
            class="shrink-0 bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white rounded-full w-10 h-10 md:w-auto md:h-12 md:px-6 font-bold transition shadow-lg shadow-cyan-500/30 flex items-center justify-center gap-2 group"
          >
            <span class="hidden md:inline" data-i18n="btn_discover">DISCOVER</span>
            <i class="fa-solid fa-compass text-lg group-hover:rotate-45 transition-transform duration-300"></i>
          </button>
        </div>
      </div>
      
      </header>

    <main class="max-w-7xl mx-auto px-6 md:px-12 py-6 pb-24">
      
      <div class="flex flex-col gap-4 mb-5 border-b border-gray-200/50 pb-4">
        
        <div class="bg-white/70 border border-white/60 rounded-2xl shadow-glass px-4 py-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-xs font-bold text-gray-600 uppercase tracking-wider flex items-center gap-2">
              <i class="fa-solid fa-star text-amber-400"></i>
              <span data-i18n="top_title">Top Verified Companies by Trust Score</span>
            </h3>
            <span class="text-[11px] text-gray-400" data-i18n="top_sub">Updated in real-time</span>
          </div>
          <div id="top-companies" class="flex gap-4 overflow-x-auto no-scrollbar pb-1"></div>
        </div>
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-4">
            
            <div>
              <span id="result-count" class="text-2xl font-bold text-BTrustOn-primary tracking-tight">Loading...</span>
            </div>

            <div class="flex flex-wrap gap-3">
                
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-layer-group text-gray-400 text-xs"></i>
                    </div>
                    <select 
    id="sector-filter" 
    onchange="filterSector(this.value)"
    class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition min-w-[140px]"
>
    <option value="all">All Sectors</option>
    <option value="construction">Construction & Infrastructure</option>
    <option value="energy">Energy & Oil/Gas</option>
    <option value="mining">Mining & Metals</option>
    <option value="manufacturing">Manufacturing & Machinery</option>
    <option value="technology">Technology & Automation</option>
    <option value="logistics">Logistics & Trade</option>
    <option value="engineering">Engineering & Services</option> </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
                    </div>
                </div>

                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-earth-americas text-gray-400 text-xs"></i>
                    </div>
                    <select 
                        id="country-filter" 
                        onchange="handleCountryChange(this.value)"
                        class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition min-w-[140px]"
                    >
                        <option value="all">All Countries</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
                    </div>
                </div>

                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-arrow-down-short-wide text-gray-400 text-xs"></i>
                    </div>
                    <select 
                        id="sort-select" 
                        onchange="handleSortChange(this.value)"
                        class="appearance-none bg-white border border-gray-200 text-gray-700 text-xs font-bold py-2.5 pl-9 pr-8 rounded-lg shadow-sm hover:border-BTrustOn-accent focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer transition"
                    >
                        <option value="score_desc">Trust Score: High to Low</option>
                        <option value="score_asc">Trust Score: Low to High</option>
                        <option value="year_oldest">Experience: Oldest First</option>
                        <option value="year_newest">Experience: Newest First</option>
                        <option value="name_asc">Name: A to Z</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
                    </div>
                </div>
            </div>
        </div>        
      <div id="card-container" class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-16"></div>

      <section class="mt-4 mb-8">
        <div
          class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8"
        >
          <div>
            <h2
              class="text-2xl md:text-3xl font-header font-bold text-BTrustOn-primary mb-2"
              data-i18n="how_title"
            >
              How Strabon Works
            </h2>
            <p
              class="text-sm text-gray-500 max-w-xl"
              data-i18n="how_sub"
            >
              Create your company profile, verify your references and let your
              Strabon Trust Scoreâ„¢ increase your visibility.
            </p>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="bg-white/80 border border-gray-100 rounded-2xl p-6 shadow-glass">
            <div class="w-9 h-9 rounded-xl bg-cyan-50 flex items-center justify-center mb-4">
              <span class="text-xs font-bold text-BTrustOn-accent">01</span>
            </div>
            <h3 class="text-sm font-bold text-BTrustOn-primary mb-2" data-i18n="how_step1_title">Create your profile</h3>
            <p class="text-xs text-gray-500 leading-relaxed" data-i18n="how_step1_desc">Add your company details, sectors, core services, assets and project highlights.</p>
          </div>
          <div class="bg-white/80 border border-gray-100 rounded-2xl p-6 shadow-glass">
            <div class="w-9 h-9 rounded-xl bg-cyan-50 flex items-center justify-center mb-4">
              <span class="text-xs font-bold text-BTrustOn-accent">02</span>
            </div>
            <h3 class="text-sm font-bold text-BTrustOn-primary mb-2" data-i18n="how_step2_title">Verify references</h3>
            <p class="text-xs text-gray-500 leading-relaxed" data-i18n="how_step2_desc">Send verification requests to past clients and partners to build a verified track record.</p>
          </div>
          <div class="bg-white/80 border border-gray-100 rounded-2xl p-6 shadow-glass">
            <div class="w-9 h-9 rounded-xl bg-cyan-50 flex items-center justify-center mb-4">
              <span class="text-xs font-bold text-BTrustOn-accent">03</span>
            </div>
            <h3 class="text-sm font-bold text-BTrustOn-primary mb-2" data-i18n="how_step3_title">Grow with Trust Scoreâ„¢</h3>
            <p class="text-xs text-gray-500 leading-relaxed" data-i18n="how_step3_desc">Higher Strabon Trust Scores mean higher visibility in search results and more qualified leads.</p>
          </div>
        </div>
      </section>

      <section class="mt-4">
  <div class="text-center mb-6">
          <h2 class="text-2xl md:text-3xl font-header font-bold text-BTrustOn-primary mb-3" data-i18n="pricing_title">Pricing for Industrial Networks</h2>
          <p class="text-sm text-gray-500 max-w-2xl mx-auto" data-i18n="pricing_sub">Start free, then upgrade as your company grows. Every plan includes a public profile and access to the Strabon Trust Scoreâ„¢ framework.</p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="bg-white/90 border border-gray-200 rounded-2xl p-7 shadow-glass flex flex-col">
            <h3 class="text-sm font-bold text-BTrustOn-primary mb-1">Free</h3>
            <p class="text-xs text-gray-500 mb-4" data-i18n="price_free_tag">For small teams getting started.</p>
            <div class="mb-6">
              <span class="text-3xl font-header font-bold text-BTrustOn-primary">$0</span>
              <span class="text-xs text-gray-400 ml-1" data-i18n="price_month">/month</span>
            </div>
            <ul class="text-xs text-gray-600 space-y-2 mb-6">
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_free_1">Public company profile</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_free_2">Up to 3 listed services</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_free_3">Basic Strabon Trust Scoreâ„¢</span></li>
            </ul>
            <button class="mt-auto w-full border border-gray-300 text-xs font-bold text-gray-600 py-3 rounded-xl hover:bg-gray-50 transition" onclick="toggleModal('modal-join')" data-i18n="btn_get_started">GET STARTED</button>
          </div>

          <div class="bg-BTrustOn-primary text-white rounded-2xl p-7 shadow-float relative overflow-hidden flex flex-col">
            <div class="absolute inset-0 bg-gradient-to-br from-BTrustOn-primary via-slate-900 to-cyan-700 opacity-80"></div>
            <div class="relative z-10 flex justify-between items-start mb-4">
              <div>
                <h3 class="text-sm font-bold mb-1">Pro</h3>
                <p class="text-xs text-cyan-200" data-i18n="price_pro_tag">For growth-focused industrial suppliers.</p>
              </div>
              <span class="text-[10px] font-bold bg-amber-400 text-slate-900 px-2 py-1 rounded-full" data-i18n="badge_popular">MOST POPULAR</span>
            </div>
            <div class="relative z-10 mb-6">
              <span class="text-3xl font-header font-bold">$79</span>
              <span class="text-xs text-cyan-100 ml-1" data-i18n="price_month">/month</span>
            </div>
            <ul class="relative z-10 text-xs text-cyan-50 space-y-2 mb-6">
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-400 text-[10px]"></i><span data-i18n="price_pro_1">Unlimited services & assets</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-400 text-[10px]"></i><span data-i18n="price_pro_2">Verified reference module</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-400 text-[10px]"></i><span data-i18n="price_pro_3">Priority ranking in search</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-400 text-[10px]"></i><span data-i18n="price_pro_4">Advanced Trust Scoreâ„¢ insights</span></li>
            </ul>
            <button class="relative z-10 mt-auto w-full bg-white text-BTrustOn-primary text-xs font-bold py-3 rounded-xl hover:bg-cyan-100 transition" onclick="toggleModal('modal-join')" data-i18n="btn_choose_pro">CHOOSE PRO</button>
          </div>

          <div class="bg-white/90 border border-gray-200 rounded-2xl p-7 shadow-glass flex flex-col">
            <h3 class="text-sm font-bold text-BTrustOn-primary mb-1">Enterprise</h3>
            <p class="text-xs text-gray-500 mb-4" data-i18n="price_ent_tag">For EPCs and global industrial groups.</p>
            <div class="mb-6">
              <span class="text-3xl font-header font-bold text-BTrustOn-primary">Custom</span>
            </div>
            <ul class="text-xs text-gray-600 space-y-2 mb-6">
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_ent_1">Multi-user access & SSO</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_ent_2">API access to supplier data</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_ent_3">Dedicated success manager</span></li>
              <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-500 text-[10px]"></i><span data-i18n="price_ent_4">Custom Trust Scoreâ„¢ models</span></li>
            </ul>
            <button class="mt-auto w-full border border-BTrustOn-primary text-xs font-bold text-BTrustOn-primary py-3 rounded-xl hover:bg-BTrustOn-primary hover:text-white transition" onclick="toggleModal('modal-join')" data-i18n="btn_contact_sales">CONTACT SALES</button>
          </div>
        </div>
      </section>
    </main>
  </div>
<div id="view-editor" class="hidden-view fade-in min-h-screen bg-gray-50 pb-20">
     <div class="bg-BTrustOn-primary text-white pt-24 pb-12 px-4">
          <div class="max-w-4xl mx-auto">
              
              <button onclick="openProfile(selectedCompany.id)" class="mb-6 flex items-center gap-2 text-white/60 hover:text-white transition text-xs font-bold tracking-wider group">
                  <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> BACK TO PROFILE
              </button>
              <div class="flex items-center gap-4 mb-4">
                  <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-BTrustOn-accent text-xl">
                      <i class="fa-solid fa-user-pen"></i>
                  </div>
                  <div>
                      <h1 class="text-3xl font-header font-bold">Profile Editor</h1>
                      <p class="text-gray-400 text-sm">Manage your company presence on BTrustOn</p>
                  </div>
              </div>
          </div>
      </div>

      <div class="max-w-4xl mx-auto px-4 -mt-8">
          <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
              <div class="grid grid-cols-1 md:grid-cols-3 min-h-[600px]">
                  
                  <div class="bg-slate-50 border-r border-gray-200 p-6">
                      <nav class="space-y-2 sticky top-6">
                          <button onclick="scrollToSection('section-general')" 
                                  class="w-full text-left px-4 py-3 rounded-lg bg-white shadow-sm border border-gray-200 text-sm font-bold text-BTrustOn-primary border-l-4 border-l-BTrustOn-accent hover:bg-gray-50 transition">
                              <i class="fa-solid fa-building w-6 text-gray-400"></i> General Info
                          </button>

            
                          <div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-100">
                              <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs font-bold text-blue-800">Profile Strength</h4>
                                <span id="status-percent" class="text-xs font-bold text-blue-600">0%</span>
                              </div>
                              <div class="w-full bg-blue-200 h-1.5 rounded-full mb-2 overflow-hidden">
                                  <div id="progress-bar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-700" style="width: 0%"></div>
                              </div>
                              <p id="status-text" class="text-[10px] text-blue-600">Complete all fields to boost your Trust Score.</p>
                          </div>
                      </nav>
                  </div>

                  <div class="col-span-2 p-8">
                      <form id="editor-form" onsubmit="event.preventDefault(); saveProfileData();">

<div class="flex items-center gap-6 mb-8 border-b border-gray-100 pb-6">
    <div id="edit-logo-preview-container" 
         class="w-24 h-24 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center overflow-hidden relative shadow-sm group">
        
        <i id="edit-logo-icon" class="fa-solid fa-building text-3xl text-gray-300"></i>
        
        <img id="edit-logo-img" class="hidden w-full h-full object-cover" />
        
        <div onclick="document.getElementById('edit-logo-input').click()" class="absolute inset-0 bg-slate-900/60 hidden group-hover:flex flex-col items-center justify-center text-white transition-all backdrop-blur-[1px] cursor-pointer z-10">
            <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            <span class="text-[9px] font-bold uppercase tracking-widest">CHANGE</span>
        </div>
    </div>

    <div class="flex flex-col gap-2">
        <div>
            <h4 class="text-sm font-bold text-gray-700">Company Logo</h4>
            <p class="text-xs text-gray-400">Recommended: 400x400px, PNG or JPG.</p>
        </div>
        
        <input type="file" id="edit-logo-input" class="hidden" accept="image/*" onchange="handleLogoSelect(this)">
        
        <div class="flex gap-2">
            <button type="button" onclick="document.getElementById('edit-logo-input').click()" class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 hover:border-gray-400 transition">
                <i class="fa-solid fa-upload mr-1"></i> Upload
            </button>
            
            <button type="button" onclick="deleteLogo()" class="bg-red-50 border border-red-100 text-red-500 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition" title="Remove Logo">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    </div>
</div>

                        <div class="space-y-12"> 
                            
                            <div id="section-general" class="space-y-6 scroll-mt-6">
                                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 pb-2">
                                  General Information
                                </h3>
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
                                      Company Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="edit-name" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 font-bold focus:outline-none transition" placeholder="e.g. Acme Construction" required />
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Country <span class="text-red-500">*</span></label>
                                        <select id="edit-country" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition bg-white" required>
                                             </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">City <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-city" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="e.g. Berlin" required />
                                    </div>
                                </div>
<div class="mt-4">
    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
        Official Address
    </label>
    <textarea 
        id="edit-address" 
        rows="2" 
        class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition resize-none" 
        placeholder="Headquarters full address (Street, No, District...)"
    ></textarea>
</div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Sector <span class="text-red-500">*</span></label>
                                    <select id="edit-sector" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition bg-white" required>
                                        <option value="">Select sectorâ€¦</option>
                                        <option value="construction">Construction & Infrastructure</option>
                                        <option value="energy">Energy & Oil/Gas</option>
                                        <option value="mining">Mining & Metals</option>
                                        <option value="manufacturing">Manufacturing & Machinery</option>
                                        <option value="technology">Technology & Automation</option>
                                        <option value="logistics">Logistics & Trade</option>
                                        <option value="engineering">Engineering & Services</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Tagline (Slogan)</label>
                                    <input type="text" id="edit-tagline" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="e.g. Building the Future" />
                                </div>

<div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Website</label>
      <input type="text" id="edit-website" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="www.example.com" />
    </div>
    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Phone</label>
      <input 
  type="text" 
  id="edit-phone" 
  class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" 
  placeholder="+ (Country Code) Phone Number" 
/>
    </div>
</div>

<div class="mt-4">
    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
        Public Contact Email <span class="text-gray-400 font-normal lowercase">(optional)</span>
    </label>
    <input 
      type="email" 
      id="edit-email" 
      class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" 
      placeholder="info@company.com (If different from login email)" 
    />
</div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Description</label>
                                    <textarea id="edit-desc" rows="4" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="Describe your company's core capabilities..."></textarea>
                                </div>

                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Type</label>
                                      <select id="edit-type" class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-white outline-none text-sm">
    <option value="Operator">Operator / Asset Owner</option>
    <option value="EPC Contractor">EPC / General Contractor</option>
    <option value="Subcontractor">Subcontractor / Specialist</option>
    <option value="Manufacturer">Manufacturer / OEM</option>
    <option value="Distributor">Distributor / Supplier</option>
    <option value="Engineering">Engineering & Consultancy</option>
    <option value="Technology">Technology & Software</option>
</select>
                                    </div>
                                    <div>
                                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Size</label>
                                      <select id="edit-size" class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-white outline-none text-sm">
                                          <option value="1-10 employees">1-10</option>
                                          <option value="10-50 employees">10-50</option>
                                          <option value="50-100 employees">50-100</option>
                                          <option value="100-250 employees">100-250</option>
                                          <option value="250+ employees">250+</option>
                                      </select>
                                    </div>
                                    <div>
                                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Year</label>
                                      <input type="number" id="edit-year" class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none text-sm" placeholder="2012">
                                    </div>
                                </div>
                            </div>

<div id="section-services" class="space-y-6 scroll-mt-6">
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 pb-2">
      Services & Capabilities
    </h3>
    
    <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
          Core Competencies (Tags)
        </label>
        <p class="text-[11px] text-gray-400 mb-2">Comma separated keywords. e.g. EPC, Excavation, Maintenance</p>
        <input type="text" id="edit-services" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="EPC, Excavation, Maintenance..." />
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
          Detailed Service Description
        </label>
        <p class="text-[11px] text-gray-400 mb-2">Explain your capabilities, capacity, and technical approach.</p>
        <textarea id="edit-service-details" rows="5" class="input-field w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:outline-none transition" placeholder="e.g. Our excavation team operates with a capacity of 5000m3/day..."></textarea>
    </div>
</div>                      

<div class="mt-5 pt-5 border-t border-gray-200 mb-6">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-user-tie text-BTrustOn-accent"></i> 
                Key Contact / Owner
            </h3>
            <p class="text-xs text-gray-500 mt-1">Optional: Introduce the person behind the business.</p>
        </div>
        
        <label class="relative inline-flex items-center cursor-pointer group">
            <input type="checkbox" id="edit-owner-toggle" class="sr-only peer" onchange="toggleOwnerSection()">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-BTrustOn-accent shadow-inner"></div>
            <span class="ml-3 text-xs font-bold text-gray-400 group-hover:text-gray-600 transition">Show</span>
        </label>
    </div>

    <div id="owner-inputs" class="hidden space-y-5 bg-white p-6 rounded-2xl border border-gray-200 shadow-sm transition-all relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-gray-50 rounded-bl-full -mr-10 -mt-10 z-0 pointer-events-none"></div>

        <div class="flex flex-col md:flex-row items-start gap-6 relative z-10">
            <div class="shrink-0 flex flex-col items-center gap-2">
                 <div class="w-20 h-20 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group cursor-pointer hover:border-BTrustOn-accent transition-colors" onclick="document.getElementById('edit-owner-photo').click()">
                     <img id="preview-owner-img" class="hidden w-full h-full object-cover">
                     <i id="icon-owner-img" class="fa-solid fa-camera text-gray-300 text-2xl group-hover:text-BTrustOn-accent transition-colors"></i>
                 </div>
                 
                 <input type="file" id="edit-owner-photo" class="hidden" accept="image/*" onchange="handleOwnerPhoto(this)">
                 
                 <button type="button" onclick="deleteOwnerPhoto()" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:underline transition">
                    Remove Photo
                 </button>
            </div>

            <div class="flex-1 w-full space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">Full Name</label>
                        <div class="relative">
                            <i class="fa-solid fa-signature absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="edit-owner-name" class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2.5 text-sm font-semibold text-gray-700 focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" placeholder="e.g. John Doe">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">Role / Title</label>
                        <div class="relative">
                            <i class="fa-solid fa-briefcase absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="edit-owner-role" class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2.5 text-sm text-gray-700 focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" placeholder="e.g. Founder & CEO">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">LinkedIn Profile</label>
                    <div class="relative group/link">
                        <div class="absolute left-3 top-2.5 bg-white rounded-full z-10">
                            <i class="fa-brands fa-linkedin text-blue-600 text-lg"></i>
                        </div>
                        <input type="text" id="edit-owner-linkedin" class="w-full border border-gray-300 rounded-lg pl-10 pr-3 py-2.5 text-sm text-blue-700 font-medium placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" placeholder="https://linkedin.com/in/username">
                        
                        <div class="absolute right-3 top-3 opacity-0 group-hover/link:opacity-100 transition text-[10px] text-gray-400 font-bold pointer-events-none">
                            <i class="fa-solid fa-link"></i> Public URL
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="mt-8 border border-blue-100 rounded-xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md">
    
    <div id="verify-locked-view" class="bg-gradient-to-br from-slate-50 to-white p-6 text-center">
        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
            <i class="fa-solid fa-lock"></i>
        </div>
        <h3 class="text-sm font-bold text-gray-800 mb-2">Get Verified Status</h3>
        <p class="text-xs text-gray-500 mb-5 max-w-xs mx-auto leading-relaxed">
            Gain trust instantly with a <i class="fa-solid fa-circle-check text-blue-500"></i> <strong>Blue Badge</strong>. 
            Exclusive to Pro Plan members.
        </p>
        <button type="button" onclick="handleVerifyClick()" class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-6 py-3 rounded-full text-xs font-bold hover:shadow-lg hover:scale-105 transition transform">
            VERIFY MY BUSINESS
        </button>
    </div>


    <div id="verify-form-view" class="hidden bg-blue-50/50 p-6">
        <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0">
                <i class="fa-solid fa-shield-check"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-sm font-bold text-gray-800 mb-1">Official Verification</h3>
                <p class="text-xs text-gray-500 mb-4">
                    Submit your official tax details. Our compliance team will verify within 24h.
                </p>

                <div id="verify-status-alert" class="hidden mb-4 p-3 rounded-lg text-[11px] font-bold border flex items-center gap-2"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Tax ID / VKN</label>
                        <input type="text" id="edit-tax-id" class="input-field w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" placeholder="Official Tax Number">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">DUNS Number</label>
                        <input type="text" id="edit-duns" class="input-field w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" placeholder="Optional">
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="button" id="btn-verify-submit" onclick="submitVerificationRequest()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 transition">
                        SUBMIT DOCUMENTATION
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

                            <div class="pt-6 border-t border-gray-100 flex items-center justify-end gap-3 sticky bottom-0 bg-white pb-2">
                                <button type="button" onclick="openProfile(selectedCompany.id)" class="px-6 py-3 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition">
                                  Cancel
                                </button>
                                <button type="submit" class="bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-cyan-500/30 transition transform hover:-translate-y-0.5">
                                    <i class="fa-solid fa-save mr-2"></i> Save &amp; Preview
                                </button>
                            </div>
                        </div> 
                      </form>
                  </div> 
              </div> 
          </div>
      </div>
  </div>
  

  <div
    id="view-profile"
    class="hidden-view fade-in min-h-screen bg-white/50 backdrop-blur-sm"
  >
    <!-- âœ… PROFILE SKELETON OVERLAY (BTrustOn 'O' animasyonlu) -->
        <div id="profile-skeleton" class="hidden fixed inset-0 z-[9998] bg-white/90 backdrop-blur-md flex items-center justify-center">
  <span class="sr-only">Loadingâ€¦</span>
  <div class="bton-on-only text-6xl md:text-7xl font-sans font-bold tracking-tight leading-none select-none" aria-hidden="true">
    <span class="bton-o" aria-hidden="true">
      <svg viewBox="0 0 40 40" class="bton-o-svg">
        <defs>
          <linearGradient id="btonGradProfile" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#00C6FF"/>
            <stop offset="1" stop-color="#0078FF"/>
          </linearGradient>
        </defs>
        <circle class="bton-o-track" cx="20" cy="20" r="14"></circle>
        <circle class="bton-o-prog bton-o-prog-profile" cx="20" cy="20" r="14"></circle>
      </svg>
    </span>
    <span class="bton-n bg-clip-text text-transparent bg-gradient-to-r from-[#00C6FF] to-[#0078FF]">n</span>
  </div>
</div>

 <div
    class="bg-gradient-to-r from-slate-50 via-white to-cyan-50/60 border-b border-BTrustOn-border pb-12 pt-12 relative overflow-hidden backdrop-blur-xl"
  >
    <div
      class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row gap-8 items-start relative z-10"
    >
    <div id="p-logo-container" 
     class="w-32 h-32 rounded-2xl border border-white shadow-xl flex items-center justify-center bg-white/90 shrink-0 overflow-hidden relative transition-all">
    
    <i id="p-default-icon" class="fa-solid fa-building text-5xl text-gray-300"></i>
    
    <img id="p-logo-image" class="hidden w-full h-full object-cover" alt="Company Logo" />

    <div id="p-logo-overlay" class="hidden">
        <i class="fa-solid fa-camera text-2xl mb-1"></i>
        <span class="text-[9px] font-bold uppercase tracking-widest">UPDATE</span>
    </div>

    <input type="file" id="profile-logo-input" class="hidden" accept="image/*" onchange="uploadLogoDirectly(this)" onclick="event.stopPropagation()">
</div>

      <div class="flex-grow">
        <div class="flex flex-wrap items-center gap-4 mb-3">
          <h1
            id="p-name"
            class="text-4xl font-header font-bold text-BTrustOn-primary"
          >
            Company Name
          </h1>

          <div class="flex flex-wrap items-center gap-2">
            <div id="p-badge" class="flex flex-wrap gap-2"></div>
            
          </div>
        </div>

        <div
          class="flex flex-wrap items-center gap-2 text-xs text-gray-500 mb-4"
        >
          <span id="p-type-tag" class="font-semibold text-gray-700">
            Industrial Supplier
          </span>
          <span>â€¢</span>
          <span id="p-size-tag">100â€“250 employees</span>
          <span>â€¢</span>
          <span id="p-year-tag">Founded 2012</span>
        </div>

        <div id="p-tagline-container" class="hidden mb-8 relative pl-6 border-l-4 border-BTrustOn-accent/40 mt-2">
            <i class="fa-solid fa-quote-left absolute -top-3 -left-3 text-3xl text-BTrustOn-accent/10 bg-white/50 backdrop-blur-sm p-1 rounded-full"></i>
            
            <p id="p-tagline" class="text-xl md:text-2xl font-serif italic text-slate-700 leading-relaxed tracking-wide">
                </p>
        </div>
        <p
  id="p-desc"
  class="text-BTrustOn-text text-lg mb-6 font-light max-w-3xl leading-relaxed whitespace-pre-line break-words"
>
  Description
</p>

        <div class="flex flex-wrap gap-4 text-sm">
          <span
            class="flex items-center gap-2 bg-white/70 px-4 py-2 rounded-full border border-gray-200 shadow-sm"
          >
            <i class="fa-solid fa-location-dot text-BTrustOn-accent"></i>
            <span id="p-city" class="font-semibold text-gray-700">City</span>
          </span>

          <span
            class="flex items-center gap-2 bg-white/70 px-4 py-2 rounded-full border border-gray-200 shadow-sm"
          >
            <i class="fa-solid fa-layer-group text-BTrustOn-accent"></i>
            <span id="p-sector" class="capitalize font-semibold text-gray-700"
              >Sector</span
            >
          </span>
        </div>
      </div>

      <div class="flex items-center gap-3 shrink-0 relative z-20">
        
        <button
          id="btn-edit-profile"
          onclick="editMyProfile()"
          class="hidden-view w-12 h-12 rounded-full bg-white text-gray-500 border border-gray-200 hover:bg-BTrustOn-accent hover:text-white hover:border-BTrustOn-accent transition shadow-sm flex items-center justify-center text-lg group relative"
          title="Edit Profile"
        >
          <i class="fa-solid fa-pen"></i>
        </button>
        
        <button
  id="btn-req-quote"
  onclick="openQuoteModal(selectedCompany.id, selectedCompany.name)"
  class="bg-BTrustOn-primary text-white px-6 py-3 rounded-xl ... (diÄŸer classlar aynÄ± kalsÄ±n)"
>
  <i class="fa-solid fa-paper-plane"></i>
  <span data-i18n="req_quote">REQUEST QUOTE</span>
</button>

      </div>
    </div>
  </div>
<main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <div class="lg:col-span-8 space-y-8">
        
        <div class="border-b border-gray-200 flex gap-1 text-xs font-bold text-gray-500 overflow-x-auto no-scrollbar">
          <button onclick="switchProfileTab('overview')" id="tab-overview" class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-BTrustOn-accent bg-cyan-50/50 transition whitespace-nowrap">
            <i class="fa-solid fa-building text-[11px]"></i>
            <span data-i18n="tab_overview">OVERVIEW</span>
          </button>
          <button onclick="switchProfileTab('projects')" id="tab-projects" class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap">
            <i class="fa-solid fa-diagram-project text-[11px]"></i>
            <span data-i18n="tab_projects">PROJECTS</span>
          </button>
          <button onclick="switchProfileTab('certs')" id="tab-certs" class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap">
            <i class="fa-solid fa-certificate text-[11px]"></i>
            <span data-i18n="tab_certs">CERTIFICATES</span>
          </button>
          <button onclick="switchProfileTab('assets')" id="tab-assets" class="flex items-center gap-2 px-6 py-3 rounded-t-xl border-b-2 border-transparent hover:bg-cyan-50/40 transition whitespace-nowrap">
            <i class="fa-solid fa-cube text-[11px]"></i>
            <span data-i18n="tab_assets">ASSETS</span>
          </button>
        </div>

        <div id="content-overview">
          <h3 class="font-bold text-BTrustOn-primary mb-4 font-header uppercase text-sm tracking-wider" data-i18n="lbl_services">
            Core Services
          </h3>
          <div id="p-services-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>
	  
        </div>

        
<div id="content-projects" class="hidden-view">
  <div class="flex flex-col gap-3 mb-6 border-b border-gray-100 pb-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h3 class="font-bold text-BTrustOn-primary font-header uppercase text-sm tracking-wider" data-i18n="proj_key_ref">Key Reference Projects</h3>

      <button id="btn-add-project" type="button" onclick="openProjectModal()"
        class="hidden-view items-center gap-2 px-4 py-2 rounded-lg bg-BTrustOn-primary text-white font-bold text-xs hover:bg-BTrustOn-accent transition shadow-lg shadow-blue-900/10">
        <i class="fa-solid fa-plus"></i> <span>ADD NEW PROJECT</span>
      </button>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
        <input id="proj-search" type="text" placeholder="Search projectsâ€¦"
          class="pl-9 pr-3 py-2 rounded-lg border border-gray-200 bg-white text-xs font-semibold w-64
                 focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent"
          oninput="filterProjectsUI(this.value)">
      </div>

      <div class="relative">
        <i class="fa-solid fa-arrow-down-short-wide absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
        <select id="proj-sort"
          class="pl-9 pr-8 py-2 rounded-lg border border-gray-200 bg-white text-xs font-bold text-gray-700
                 focus:outline-none focus:ring-1 focus:ring-BTrustOn-accent cursor-pointer"
          onchange="sortProjectsUI(this.value)">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="az">Title A â†’ Z</option>
        </select>
        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-[10px] pointer-events-none"></i>
      </div>
    </div>
  </div>

  <div id="p-projects-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

        </div>

        <div id="content-certs" class="hidden-view">
  <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
    <div>
      <h3 class="font-bold text-BTrustOn-primary font-header uppercase text-sm tracking-wider" data-i18n="certs_title">Certifications</h3>
      <span class="text-[11px] text-gray-400" data-i18n="certs_sub">Declared certificates</span>
    </div>

    <button id="btn-add-cert" type="button" onclick="openCertModal()" class="hidden-view items-center gap-2 px-4 py-2 rounded-lg bg-BTrustOn-primary text-white font-bold text-xs hover:bg-BTrustOn-accent transition shadow-lg shadow-blue-900/10">
        <i class="fa-solid fa-plus"></i> <span>ADD CERTIFICATE</span>
    </button>
  </div>
  
  <div id="p-certs-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</div>

        <div id="content-assets" class="hidden-view">
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
            
            <div class="flex flex-wrap items-center justify-between px-6 py-5 border-b border-gray-100 bg-gray-50/30">
              <div class="flex flex-col gap-2">
                <h3 class="font-bold text-BTrustOn-primary font-header uppercase text-sm tracking-wider">Equipment & Assets</h3>
               <div class="flex flex-wrap items-center gap-2 text-[10px]">
                   <span class="inline-flex items-center px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-semibold border border-emerald-100">Available</span>
                   
                   <span class="inline-flex items-center px-2 py-1 rounded-full bg-amber-50 text-amber-700 font-semibold border border-amber-100">Under Maintenance</span>
                   
                   <span class="inline-flex items-center px-2 py-1 rounded-full bg-rose-50 text-rose-700 font-semibold border border-rose-100">Out of Service</span>
                </div>
              </div>
              <button id="btn-add-asset" type="button" onclick="openAssetModal()" class="hidden-view items-center gap-2 px-4 py-2 rounded-lg bg-BTrustOn-primary text-white font-bold text-xs hover:bg-BTrustOn-accent transition shadow-lg shadow-blue-900/10">
                <i class="fa-solid fa-plus"></i> <span>ADD NEW ASSET</span>
              </button>
            </div>

            <div class="overflow-x-auto max-h-[500px] overflow-y-auto custom-scrollbar relative">
              <table class="min-w-full text-sm text-left border-collapse">
                <thead class="bg-gray-50 text-gray-400 uppercase font-bold text-[10px] tracking-wider sticky top-0 z-10 shadow-sm">
                  <tr>
                    <th class="py-3 px-6 bg-gray-50">Item Name</th>
                    <th class="py-3 px-6 bg-gray-50">Specs</th>
                    <th class="py-3 px-6 bg-gray-50 text-center">Qty</th>
                    <th class="py-3 px-6 bg-gray-50">Location</th>
                    <th class="py-3 px-6 bg-gray-50">Status</th>
                    <th class="py-3 px-6 bg-gray-50 text-right w-24">Actions</th>
                  </tr>
                </thead>
                <tbody id="p-assets-list" class="divide-y divide-gray-100 bg-white"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div> <div class="lg:col-span-4 space-y-6">
        
        <div class="sticky top-28 space-y-6">

            <div id="profile-verify-widget" class="hidden bg-white border border-blue-100 rounded-2xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md relative group">
                <div id="widget-locked-view" class="bg-gradient-to-br from-slate-50 to-white p-5 text-center relative">
                    <div class="absolute top-2 right-2 text-gray-300"><i class="fa-solid fa-crown"></i></div>
                    <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm">
                        <i class="fa-solid fa-lock text-sm"></i>
                    </div>
                    <h3 class="text-xs font-bold text-gray-800 mb-1">Get Verified Badge</h3>
                    <p class="text-[10px] text-gray-500 mb-3 leading-relaxed px-2">
                        Unlock the <i class="fa-solid fa-circle-check text-blue-500"></i> badge. Exclusive to Pro members.
                    </p>
                    <button onclick="handleVerifyClick()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-[10px] font-bold transition shadow-lg shadow-blue-600/20">
                        VERIFY MY BUSINESS
                    </button>
                </div>

                <div id="widget-form-view" class="hidden bg-white p-5">
                    <div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-shield-check text-sm"></i>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-gray-800">Official Verification</h3>
                            <p class="text-[9px] text-gray-400">Submit tax details.</p>
                        </div>
                    </div>

                    <div id="widget-status-alert" class="hidden mb-3 p-2 rounded-lg text-[10px] font-bold border flex items-center gap-2"></div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-1">Tax ID / VKN</label>
                            <input type="text" id="widget-tax-id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="Official Tax Number">
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-1">DUNS Number</label>
                            <input type="text" id="widget-duns" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="Optional">
                        </div>
                        <button type="button" id="btn-widget-submit" onclick="submitVerificationRequest('widget')" class="w-full bg-slate-800 text-white py-2.5 rounded-lg text-[10px] font-bold hover:bg-slate-900 transition">
                            SUBMIT
                        </button>
                    </div>
                </div>
            </div>

            <div id="profile-analytics-card" class="hidden bg-white rounded-2xl p-6 shadow-[0_10px_40px_-15px_rgba(0,0,0,0.1)] border border-gray-100 relative overflow-visible group hover:shadow-[0_20px_50px_-20px_rgba(6,182,212,0.15)] transition-all duration-500">
                <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-50/50 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                          <i class="fa-solid fa-chart-line text-BTrustOn-accent"></i>
                          Profile Analytics
                        </h3>
                        <button id="btn-card-upgrade" onclick="toggleModal('modal-upgrade')" class="hidden bg-amber-100 hover:bg-amber-200 text-amber-800 text-[10px] font-bold px-2 py-1 rounded border border-amber-200 transition shadow-sm items-center gap-1">
                            <i class="fa-solid fa-bolt"></i> GO PRO
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative group/list">
                            <div class="bg-gradient-to-br from-white to-cyan-50 border border-cyan-100 p-4 rounded-xl text-center cursor-default transition hover:border-cyan-300 hover:shadow-md">
                                <div class="text-3xl font-header font-bold text-BTrustOn-primary mb-1" id="stat-partner-count">-</div>
                                <div class="text-[10px] font-bold text-cyan-600 uppercase tracking-wide">Partners</div>
                                <div class="text-[9px] text-gray-400 mt-1">Registered Companies</div>
                            </div>
                            <div class="absolute left-0 bottom-full mb-3 w-64 bg-white/95 backdrop-blur-xl border border-gray-200 rounded-xl shadow-2xl opacity-0 invisible group-hover/list:opacity-100 group-hover/list:visible transition-all duration-300 transform translate-y-2 group-hover/list:translate-y-0 z-50 overflow-hidden">
                                <div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Recent Viewers</span>
                                    <i class="fa-solid fa-eye text-cyan-400 text-xs"></i>
                                </div>
                                <div id="stat-partner-list" class="max-h-48 overflow-y-auto custom-scrollbar p-1">
                                    <div class="p-3 text-center text-[10px] text-gray-400 italic">No views yet.</div>
                                </div>
                                <div class="absolute -bottom-2 left-8 w-4 h-4 bg-white border-b border-r border-gray-200 transform rotate-45"></div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-100 p-4 rounded-xl text-center">
                            <div class="text-3xl font-header font-bold text-gray-400 mb-1" id="stat-guest-count">-</div>
                            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Guests</div>
                            <div class="text-[9px] text-gray-400 mt-1">Unregistered Users</div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-5 leading-relaxed text-center">
                        Verified profiles rank higher in search results. 
                        <span class="text-BTrustOn-accent font-bold">Upgrade to Pro</span> 
                        to maximize your visibility and reach more partners.
                    </p>                    
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Contact Info</h4>
                <div class="space-y-4 text-sm text-gray-600">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <a id="p-website-link" href="#" target="_blank" class="text-BTrustOn-accent font-semibold hover:underline truncate flex-1 min-w-0">-</a>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <span id="p-email-text" class="truncate flex-1 min-w-0">-</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-phone"></i>
                        </div>
                        <span id="p-phone-text" class="truncate flex-1 min-w-0">-</span>
                    </div>
                    <div class="flex items-start gap-3 pt-3 border-t border-gray-100 mt-3 hidden">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 shrink-0 mt-0.5">
                            <i class="fa-solid fa-map-location-dot"></i>
                        </div>
                        <span id="p-address-text" class="text-xs text-gray-500 leading-relaxed italic flex-1 break-words min-w-0">
                            -
                        </span>
                    </div>
                </div>
            </div>

            <div id="sidebar-owner-view" class="hidden animate-fade-in">
                </div>

        </div> 
      </div>
        
      </main>
  
  </div>

  <div
    id="modal-join"
    class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"
  >
    <div
      class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm"
    ></div>
    <div
      class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in"
    >
      <div class="py-8 px-8">
        <div
          class="flex justify-between items-center pb-4 border-b border-gray-100 mb-6"
        >
          <div>
            <p
              class="text-2xl font-header font-bold text-BTrustOn-primary"
              data-i18n="join_title"
            >
              Join the Network
            </p>
            <p
              class="text-[11px] text-gray-500 mt-1"
              data-i18n="join_desc"
            >
              Create your company profile. Verification usually takes 24
              hours.
            </p>
          </div>
          <div
            class="cursor-pointer z-50"
            onclick="toggleModal('modal-join')"
          >
            <i
              class="fa-solid fa-xmark text-gray-400 hover:text-red-500 text-xl"
            ></i>
          </div>
        </div>
        <form id="join-form" onsubmit="event.preventDefault(); handleJoin();" class="space-y-5">
  <div>
    <label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_company">Company Name</label>
    <input type="text" id="join-companyName" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" required />
  </div>

  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-xs font-bold text-gray-600 mb-1.5">Email</label>
      <input type="email" id="join-email" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" required />
    </div>
    <div>
      <label class="block text-xs font-bold text-gray-600 mb-1.5">Password</label>
      <input type="password" id="join-password" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" placeholder="******" required />
    </div>
  </div>

  <div class="grid grid-cols-2 gap-4">
    
    <div>
      <label class="block text-xs font-bold text-gray-600 mb-1.5">Primary Sector</label>
      <select id="join-sector" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700">
    <option value="construction">Construction & Infrastructure</option>
    <option value="energy">Energy & Oil/Gas</option>
    <option value="mining">Mining & Metals</option>
    <option value="manufacturing">Manufacturing & Machinery</option>
    <option value="technology">Technology & Automation</option>
    <option value="logistics">Logistics & Trade</option>
    <option value="engineering">Engineering & Services</option>
</select>

      <p class="text-[10px] text-gray-400 mt-1 leading-tight">Select your main field of activity.</p>
    </div>
    
    <div>
      <label class="block text-xs font-bold text-gray-600 mb-1.5">Business Type</label>
      <select id="join-type" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700">
    <option value="Operator">Operator / Asset Owner</option>
    <option value="EPC Contractor">EPC / General Contractor</option>
    <option value="Subcontractor">Subcontractor / Specialist</option>
    <option value="Manufacturer">Manufacturer / OEM</option>
    <option value="Distributor">Distributor / Supplier</option>
    <option value="Engineering">Engineering & Consultancy</option>
    <option value="Technology">Technology & Software</option>
</select>
      <p class="text-[10px] text-gray-400 mt-1 leading-tight">Select your role in the supply chain.</p>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-4 mt-4">
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1.5">Country</label>
        <select id="join-country" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none cursor-pointer text-gray-700" required>
            </select>
    </div>
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_city">City</label>
        <input type="text" id="join-city" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" placeholder="e.g. Istanbul" required />
    </div>
</div>

  <div>
    <label class="block text-xs font-bold text-gray-600 mb-1.5" data-i18n="field_services">Core Services</label>
    <textarea id="join-services" rows="2" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none" placeholder="EPC, Excavation..."></textarea>
  </div>
<div class="flex items-start gap-3 mt-4 mb-2">
    <div class="flex items-center h-5">
      <input 
        id="join-terms" 
        type="checkbox" 
        required 
        class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-blue-300 focus:ring-opacity-50 transition cursor-pointer"
      >
    </div>
    <label for="join-terms" class="text-xs text-gray-500 leading-snug">
      I agree to the 
      <a href="javascript:void(0)" onclick="toggleModal('modal-terms')" class="text-BTrustOn-accent font-bold hover:underline">Terms of Service</a> 
      and 
      <a href="javascript:void(0)" onclick="toggleModal('modal-terms')" class="text-BTrustOn-accent font-bold hover:underline">Privacy Policy</a>.
      I acknowledge that BTrustOn is a verification platform and does not guarantee the performance of any listed company.
    </label>
  </div>
  <div class="pt-2">
    <button type="submit" class="w-full bg-BTrustOn-primary text-white font-bold py-4 rounded-xl hover:bg-BTrustOn-accent transition">
      CREATE ACCOUNT & PROFILE
    </button>
  </div>
  <p id="join-error" class="text-xs text-red-500 text-center hidden"></p>
</form>
      </div>
    </div>
  </div>

  <div
    id="modal-quote"
    class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"
  >
    <div
      class="modal-overlay absolute w-full h-full bg-slate-900/60 backdrop-blur-sm"
    ></div>
    <div
      class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in"
    >
      <div class="py-8 px-8">
        <div
          class="flex justify-between items-center pb-4 border-b border-gray-100 mb-6"
        >
          <div class="flex flex-col">
            <p
              class="text-2xl font-header font-bold text-BTrustOn-primary"
              data-i18n="quote_title"
            >
              Request Quote
            </p>
            <p
              class="text-xs text-BTrustOn-accent font-bold mt-1"
              id="quote-target-company"
            >
              Target Company
            </p>
          </div>
          <div
            class="cursor-pointer z-50"
            onclick="toggleModal('modal-quote')"
          >
            <i
              class="fa-solid fa-xmark text-gray-400 hover:text-red-500 text-xl"
            ></i>
          </div>
        </div>
        <form onsubmit="event.preventDefault(); handleQuoteSubmit();" class="space-y-5">
<input type="hidden" id="input-target-id" />          
<input type="hidden" name="form_type" value="Quote_Request" />
          <input
            type="hidden"
            name="target_company"
            id="input-target-company"
          />
          <div>
            <label
              class="block text-xs font-bold text-gray-600 mb-1.5"
              data-i18n="field_your_name"
              >Your Name</label
            >
            <input
              type="text"
              name="name"
              class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none"
              required
            />
          </div>
          <div>
            <label
              class="block text-xs font-bold text-gray-600 mb-1.5"
              >Email</label
            >
            <input
              type="email"
              name="email"
              class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none"
              required
            />
          </div>

<div>
  <label class="block text-xs font-bold text-gray-600 mb-1.5">Subject</label>
  <input 
    type="text" 
    name="subject" 
    id="quote-subject" 
    class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none font-bold text-gray-700" 
    placeholder="e.g. Excavator Rental Request" 
    required 
  />
</div>
          <div>
            <label
              class="block text-xs font-bold text-gray-600 mb-1.5"
              
              >Details</label
            >
            <textarea
              name="message"
              rows="4"
              class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 outline-none"
              required
            ></textarea>
          </div>
<div class="mt-3">
    <label class="block text-xs font-bold text-gray-600 mb-1.5">
        <i class="fa-solid fa-paperclip mr-1 text-gray-400"></i> Attach Document (Optional)
    </label>
    <div class="flex items-center gap-3">
        <label class="cursor-pointer bg-white border border-gray-200 rounded-lg px-4 py-2 text-xs font-bold text-gray-500 hover:bg-gray-50 hover:border-BTrustOn-accent transition flex items-center gap-2">
            <span>Select File</span>
            <input type="file" id="quote-file" class="hidden" onchange="document.getElementById('quote-file-name').textContent = this.files[0]?.name || ''">
        </label>
        <span id="quote-file-name" class="text-[10px] text-gray-400 italic truncate max-w-[150px]"></span>
    </div>
</div>
          <div class="pt-2">
            <button
              type="submit"
              class="w-full bg-BTrustOn-accent text-white font-bold py-4 rounded-xl hover:bg-blue-600 transition"
              data-i18n="btn_send_quote"
            >
              SEND REQUEST
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="border-t border-gray-200 bg-white/80 mt-4">
    <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-gray-500">
      
      <div class="flex items-center gap-2">
        <span class="font-header font-bold text-BTrustOn-primary text-sm">BTrustOn</span>
        <span class="text-gray-300">|</span>
        <span>Â© <span id="year-span"></span> Â· <span data-i18n="footer_rights">All rights reserved.</span></span>
      </div>

      <div class="flex items-center gap-6 md:gap-8">
        <a href="javascript:void(0)" onclick="toggleModal('modal-about')" class="hover:text-BTrustOn-primary transition" data-i18n="footer_about">About</a>

        <a href="javascript:void(0)" onclick="toggleModal('modal-join')" class="hover:text-BTrustOn-primary transition" data-i18n="footer_pricing">Pricing</a>

        <a href="javascript:void(0)" onclick="toggleModal('modal-terms')" class="hover:text-BTrustOn-primary transition" data-i18n="footer_privacy">Privacy</a>

        <a href="javascript:void(0)" onclick="toggleModal('modal-terms')" class="hover:text-BTrustOn-primary transition" data-i18n="footer_terms">Terms</a>
      </div>

    </div>
  </footer>

<!-- Partner Login Modal -->
<div
  id="login-modal"
  class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50"
>
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
    <h2 class="text-lg font-bold mb-4">Partner Login</h2>

    <form id="login-form" class="space-y-3">
      <div>
        <label class="block text-sm mb-1">Email</label>
        <input
          type="email"
          name="email"
          required
          class="w-full border rounded px-3 py-2 text-sm"
        />
      </div>

      <div>
        <label class="block text-sm mb-1">Password</label>
        <input
          type="password"
          name="password"
          required
          class="w-full border rounded px-3 py-2 text-sm"
        />
      </div>

      <p id="login-error" class="text-xs text-red-500 hidden"></p>

      <div class="flex justify-end gap-2 mt-4">
        <button
          type="button"
          onclick="closeLoginModal()"
          class="text-sm px-3 py-2"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="text-sm px-4 py-2 rounded bg-blue-600 text-white"
        >
          Login
        </button>
      </div>
    </form>
  </div>
</div>
<div id="asset-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAssetModal()"></div>
  
  <div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
    <div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
      <h3 id="asset-modal-title" class="font-bold font-header tracking-wide">Add New Asset</h3>
      <button onclick="closeAssetModal()" class="text-white/70 hover:text-white transition">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    
    <div class="p-6">
  <form id="asset-form" onsubmit="event.preventDefault(); saveAsset();" class="space-y-4">
    
    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Item Name</label>
      <input 
        type="text" 
        id="asset-item" 
        class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" 
        placeholder="e.g. Liebherr LR 11000 Crawler Crane" 
        required
      >
    </div>

    <div class="grid grid-cols-3 gap-4">
      <div class="col-span-2">
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Specs</label>
        <input type="text" id="asset-specs" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" placeholder="e.g. 1000 Ton Capacity, 2023 Model">
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Qty</label>
        <input type="number" id="asset-qty" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" value="1">
      </div>
    </div>

    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Location</label>
      <input type="text" id="asset-location" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" placeholder="e.g. Rotterdam Logistics Hub, NL">
    </div>

    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Status</label>
      <select id="asset-status" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm bg-white outline-none transition">
        <option value="Available">Available</option>
        <option value="Under Maintenance">Under Maintenance</option>
        <option value="Out of Service">Out of Service</option>
      </select>
    </div>

<div class="pt-2">
      <div class="flex justify-between items-center mb-1">
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">
          Technical Document <span class="text-gray-300 font-normal lowercase">(pdf, img)</span>
        </label>
        
        <span id="asset-file-pro-badge" class="hidden bg-amber-100 text-amber-700 text-[9px] font-bold px-1.5 py-0.5 rounded border border-amber-200">
          <i class="fa-solid fa-crown"></i> PRO FEATURE
        </span>
      </div>

      <div class="flex items-center gap-3">
         <label id="asset-file-label" class="flex-1 cursor-pointer bg-gray-50 border border-dashed border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-2 hover:bg-gray-100 hover:border-BTrustOn-accent transition group relative overflow-hidden">
            <input type="file" id="asset-file-input" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="handleAssetFileSelect(this)">
            
            <i class="fa-solid fa-cloud-arrow-up text-gray-400 group-hover:text-BTrustOn-accent"></i>
            <span id="asset-file-text" class="text-xs font-bold text-gray-500 group-hover:text-gray-700 truncate">Attach File (Max 5MB)</span>
            
            <div id="asset-file-lock" class="hidden absolute inset-0 bg-gray-100/80 flex items-center justify-center cursor-not-allowed">
                <i class="fa-solid fa-lock text-gray-400"></i>
            </div>
         </label>

         <button type="button" id="btn-remove-asset-file" onclick="removeAssetFile()" class="hidden w-10 h-10 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition" title="Remove File">
            <i class="fa-solid fa-trash text-xs"></i>
         </button>
      </div>
      
      <a id="current-asset-link" href="#" target="_blank" class="hidden text-[10px] text-BTrustOn-accent font-bold mt-1 hover:underline flex items-center gap-1">
          <i class="fa-solid fa-paperclip"></i> <span>View Current File</span>
      </a>
    </div>

    <div class="pt-4 flex gap-3">
      <button type="button" onclick="closeAssetModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold text-xs hover:bg-gray-50 transition">
        CANCEL
      </button>
      <button type="submit" class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20">
        SAVE ASSET
      </button>
    </div>

  </form>
</div>
  </div>
</div>
<div id="project-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeProjectModal()"></div>
  
  <div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
    <div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
      <h3 id="project-modal-title" class="font-bold font-header tracking-wide">Add New Project</h3>
      <button onclick="closeProjectModal()" class="text-white/70 hover:text-white transition">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    
    <div class="p-6">
  <form id="project-form" onsubmit="event.preventDefault(); saveProject();" class="space-y-4">
    
    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Project Title</label>
      <input type="text" id="proj-title" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" placeholder="e.g. Offshore Wind Farm Installation" required>
    </div>

    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Location</label>
      <input type="text" id="proj-loc" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" placeholder="e.g. North Sea, Netherlands" required>
    </div>

    <div>
      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Description</label>
      <textarea id="proj-desc" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" placeholder="e.g. EPC delivery of 50 turbines (12MW) and subsea cabling works..."></textarea>
    </div>

<div class="space-y-3 pt-2">
      
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Cover Image</label>
        <div class="flex items-center gap-3">
            <div id="cover-preview" class="relative w-16 h-12 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden group">
                <i class="fa-solid fa-image text-gray-400"></i>
                <button type="button" onclick="removeProjectCover()" class="hidden absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" title="Remove Cover">
                   <i class="fa-solid fa-trash text-xs"></i>
                </button>
            </div>
            
            <div class="flex flex-col gap-1">
                <label class="cursor-pointer bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-50 transition inline-flex items-center">
                    <i class="fa-solid fa-upload mr-1"></i> Change Cover
                    <input type="file" id="proj-cover-input" class="hidden" accept="image/*" onchange="handleProjectCover(this)">
                </label>
            </div>
        </div>
      </div>

      <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl relative overflow-hidden">
         
         <div class="flex justify-between items-center mb-2">
            <label class="text-xs font-bold text-gray-600 flex items-center gap-2">
                <i class="fa-solid fa-images text-BTrustOn-accent"></i> Project Gallery
            </label>
            <span id="proj-gallery-badge" class="bg-amber-100 text-amber-700 text-[9px] font-bold px-1.5 py-0.5 rounded border border-amber-200">PRO</span>
         </div>

         <div id="existing-gallery-preview" class="flex gap-2 mb-2 overflow-x-auto pb-1 custom-scrollbar min-h-[0px] transition-all">
             </div>

         <div class="flex items-center gap-2">
            <label id="proj-gallery-label" class="flex-1 cursor-pointer bg-white border border-dashed border-gray-300 rounded-lg px-3 py-2 text-center hover:border-BTrustOn-accent transition">
                <span class="text-[10px] text-gray-500 font-bold block">+ Add More Photos</span>
                <input type="file" id="proj-gallery-input" class="hidden" accept="image/*" multiple onchange="handleProjectGallery(this)">
            </label>
            <span id="gallery-count-text" class="text-[10px] text-gray-400 font-bold"></span>
         </div>

         <div id="proj-gallery-lock" class="absolute inset-0 bg-slate-100/60 backdrop-blur-[1px] flex flex-col items-center justify-center z-10 cursor-pointer hidden" onclick="toggleModal('modal-upgrade')">
             <div class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center mb-1">
                 <i class="fa-solid fa-lock text-gray-400 text-xs"></i>
             </div>
             <span class="text-[9px] font-bold text-gray-500 bg-white px-2 py-0.5 rounded-full shadow-sm">Upgrade</span>
         </div>

      </div>
    </div>

    <div class="pt-4 flex gap-3">
      <button type="button" onclick="closeProjectModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold text-xs hover:bg-gray-50 transition">
        CANCEL
      </button>
      <button type="submit" class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20">
        SAVE PROJECT
      </button>
    </div>

  </form>
</div>
  </div>
</div>

<div id="cert-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCertModal()"></div>
  
  <div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all">
    <div class="bg-BTrustOn-primary text-white px-6 py-4 flex justify-between items-center">
      <h3 id="cert-modal-title" class="font-bold font-header tracking-wide">Add Certificate</h3>
      <button onclick="closeCertModal()" class="text-white/70 hover:text-white transition">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    
    <div class="p-6">
      <form id="cert-form" onsubmit="event.preventDefault(); saveCert();" class="space-y-4">
        
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Certificate Name <span class="text-red-500">*</span></label>
          <input type="text" id="cert-name" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent outline-none transition" placeholder="e.g. ISO 9001:2015" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Issuer / Org.</label>
              <input type="text" id="cert-issuer" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition" placeholder="e.g. TUV NORD">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Expiry Date</label>
              <input type="date" id="cert-date" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm outline-none transition text-gray-600">
            </div>
        </div>

        <div class="pt-2">
            <div class="flex justify-between items-center mb-1">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">
                  Proof Document <span class="text-gray-300 font-normal lowercase">(pdf, img)</span>
                </label>
                <span id="cert-file-pro-badge" class="hidden bg-amber-100 text-amber-700 text-[9px] font-bold px-1.5 py-0.5 rounded border border-amber-200 animate-pulse">
                  <i class="fa-solid fa-crown"></i> PRO ONLY
                </span>
            </div>

            <div class="flex items-center gap-3">
                <label id="cert-file-label" class="flex-1 cursor-pointer bg-gray-50 border border-dashed border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-2 hover:bg-gray-100 hover:border-BTrustOn-accent transition group relative overflow-hidden">
                    <input type="file" id="cert-file-input" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="handleCertFileSelect(this)">
                    
                    <i class="fa-solid fa-cloud-arrow-up text-gray-400 group-hover:text-BTrustOn-accent"></i>
                    <span id="cert-file-text" class="text-xs font-bold text-gray-500 group-hover:text-gray-700 truncate">Attach Proof (Max 5MB)</span>
                    
                    <div id="cert-file-lock" class="hidden absolute inset-0 bg-gray-100/90 flex items-center justify-center cursor-not-allowed z-10">
                        <div class="flex items-center gap-1 text-gray-400 text-xs font-bold">
                            <i class="fa-solid fa-lock"></i> <span>Upgrade to Upload</span>
                        </div>
                    </div>
                </label>

                <button type="button" id="btn-remove-cert-file" onclick="removeCertFile()" class="hidden w-10 h-10 rounded-lg border border-red-200 text-red-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition" title="Remove File">
                    <i class="fa-solid fa-trash text-xs"></i>
                </button>
            </div>
            
            <a id="current-cert-link" href="#" target="_blank" class="hidden text-[10px] text-BTrustOn-accent font-bold mt-1.5 hover:underline flex items-center gap-1 inline-block">
                <i class="fa-solid fa-paperclip"></i> <span>View Current File</span>
            </a>
        </div>

        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeCertModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition">
            CANCEL
          </button>
          <button type="submit" class="flex-1 px-4 py-3 rounded-xl bg-BTrustOn-accent text-white font-bold text-xs hover:bg-BTrustOn-darkAccent transition shadow-lg shadow-cyan-500/20">
            SAVE CERTIFICATE
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<div id="delete-modal" class="fixed inset-0 z-[20000] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
  
  <div class="bg-white w-full max-w-sm mx-4 rounded-2xl shadow-2xl z-20 overflow-hidden transform transition-all scale-95" id="delete-modal-content">
    <div class="p-6 text-center">
      
      <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i>
      </div>

      <h3 class="text-lg font-bold text-gray-800 mb-2">Are you sure?</h3>
      <p id="delete-modal-msg" class="text-sm text-gray-500 mb-6 leading-relaxed">
        Do you really want to delete this item? This process cannot be undone.
      </p>

      <div class="flex gap-3">
        <button onclick="closeDeleteModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition">
          CANCEL
        </button>
        <button id="btn-confirm-delete" class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-bold text-xs hover:bg-red-600 transition shadow-lg shadow-red-500/30">
          YES, DELETE
        </button>
      </div>

    </div>
  </div>
</div>

<div id="inbox-overlay" onclick="toggleInbox()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[2px] z-[9990] hidden transition-opacity opacity-0"></div>
<div id="inbox-panel" class="flex flex-col">
    <div class="bg-gradient-to-r from-BTrustOn-primary to-slate-800 flex flex-col pt-6 px-6 shadow-lg relative overflow-hidden shrink-0 z-20">
        <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
        
        <div class="relative z-10 flex justify-between items-center mb-4">
            <div>
                <h2 class="text-white font-header text-xl tracking-wide flex items-center gap-2">
                    MESSAGES
                    <span id="inbox-badge-count" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-glow hidden">0</span>
                </h2>
            </div>
            <button onclick="toggleInbox()" class="text-white/60 hover:text-white hover:rotate-90 transition transform">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex items-center gap-6 relative z-10 text-xs font-bold text-white/50">
            <button onclick="switchInboxView('inbox')" id="btn-tab-inbox" class="pb-3 border-b-2 border-BTrustOn-accent text-white transition-all flex items-center gap-2">
                INBOX
            </button>
            <button onclick="switchInboxView('sent')" id="btn-tab-sent" class="pb-3 border-b-2 border-transparent hover:text-white transition-all flex items-center gap-2">
                SENT <i class="fa-solid fa-paper-plane text-[10px]"></i>
            </button>
        </div>
        </div>

    <div id="inbox-content" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2 bg-slate-50/50">
    </div>

    <div class="p-4 border-t border-gray-200 bg-white/90 backdrop-blur-sm grid grid-cols-2 gap-3 shrink-0">
        <button onclick="markAllInboxRead()" class="py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-bold hover:bg-white hover:border-BTrustOn-accent hover:text-BTrustOn-accent transition flex items-center justify-center gap-2 group">
            <i class="fa-solid fa-check-double text-gray-400 group-hover:text-BTrustOn-accent"></i> 
            MARK READ
        </button>

        <button onclick="deleteAllInbox()" class="py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-bold hover:bg-red-50 hover:border-red-200 hover:text-red-500 transition flex items-center justify-center gap-2 group">
            <i class="fa-solid fa-trash text-gray-400 group-hover:text-red-500"></i> 
            DELETE ALL
        </button>
    </div>
</div>

<div id="view-message" class="hidden-view fixed inset-0 z-[10000] bg-slate-50 flex flex-col h-[100dvh]">
    
    <div class="shrink-0 bg-white border-b border-gray-200 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
            <button onclick="closeMessageView()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            
            <div id="msg-logo" class="w-10 h-10 rounded-lg bg-cyan-50 border border-cyan-100 flex items-center justify-center text-lg font-bold text-BTrustOn-accent shrink-0">
                A
            </div>
            
            <div class="min-w-0">
                <h1 id="msg-subject" class="text-sm md:text-base font-bold text-gray-800 truncate">Subject</h1>
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <span id="msg-company" class="truncate font-medium">Company Name</span>
                    <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                    <span id="msg-type-badge" class="font-semibold text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">MESSAGE</span>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2 shrink-0">
            <button onclick="markAsUnreadCurrentMessage()" class="w-9 h-9 rounded-full border border-gray-200 text-gray-400 hover:text-BTrustOn-accent hover:bg-cyan-50 hover:border-BTrustOn-accent transition flex items-center justify-center" title="Mark Unread">
                <i class="fa-solid fa-envelope-open text-sm"></i>
            </button>
            <button onclick="deleteCurrentMessage()" class="w-9 h-9 rounded-full border border-gray-200 text-gray-400 hover:text-red-500 hover:bg-red-50 hover:border-red-200 transition flex items-center justify-center" title="Delete Conversation">
                <i class="fa-solid fa-trash-can text-sm"></i>
            </button>
        </div>
    </div>

    <div id="message-thread-container" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-4 bg-[#e5ddd5]/10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="flex justify-center mt-10">
            <span class="bg-gray-200 text-gray-600 text-[10px] px-3 py-1 rounded-full uppercase tracking-wide font-bold">Loading Chat...</span>
        </div>
    </div>

    <div class="shrink-0 bg-white border-t border-gray-200 p-3 md:p-4 z-20">
        
        <div id="attachment-preview" class="hidden mb-2 flex items-center justify-between bg-cyan-50 border border-cyan-100 rounded-lg p-2 mx-1">
            <div class="flex items-center gap-2 overflow-hidden">
                <div class="w-8 h-8 rounded bg-white flex items-center justify-center text-BTrustOn-accent shadow-sm shrink-0">
                    <i class="fa-solid fa-file-lines"></i>
                </div>
                <div class="min-w-0">
                    <p id="attachment-name" class="text-xs font-bold text-gray-700 truncate">filename.pdf</p>
                    <p id="attachment-size" class="text-[9px] text-gray-400">0 KB</p>
                </div>
            </div>
            <button type="button" onclick="removeAttachment()" class="w-6 h-6 rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500 flex items-center justify-center transition">
                <i class="fa-solid fa-xmark text-xs"></i>
            </button>
        </div>

        <div class="flex items-end gap-2 md:gap-3 max-w-5xl mx-auto">
            <input type="file" id="reply-file-input" style="display: none;" onchange="handleFileSelect(this)" />
            <button type="button" onclick="document.getElementById('reply-file-input').click()" class="h-10 w-10 md:w-12 rounded-xl bg-gray-50 text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition flex items-center justify-center border border-gray-200 shrink-0">
                <i class="fa-solid fa-paperclip text-lg"></i>
            </button>

            <textarea id="reply-input" rows="1" class="flex-1 bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl px-4 py-2.5 focus:outline-none focus:bg-white focus:border-BTrustOn-accent focus:ring-1 focus:ring-BTrustOn-accent transition resize-none max-h-32 min-h-[44px]" placeholder="Type a message..."></textarea>
            
            <button onclick="sendReply()" class="h-10 px-4 md:px-6 bg-BTrustOn-accent hover:bg-BTrustOn-darkAccent text-white rounded-xl font-bold text-xs tracking-wide transition shadow-lg shadow-cyan-500/20 shrink-0 flex items-center gap-2">
                <span>SEND</span>
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
</div> </div> 

<div id="view-admin" class="hidden-view fade-in min-h-screen bg-slate-100 pb-20">
    <div class="bg-slate-900 text-white pt-24 pb-12 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-header font-bold flex items-center gap-3">
                    <i class="fa-solid fa-shield-cat text-emerald-400"></i> Admin Dashboard
                </h1>
                <p class="text-slate-400 text-sm mt-2">Manage verifications and subscriptions.</p>
            </div>
            <div class="flex gap-4">
                 <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <span class="block text-[10px] text-slate-400 uppercase">Pending Requests</span>
                    <span id="admin-pending-count" class="text-2xl font-bold text-white">0</span>
                 </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 -mt-6">
        <div class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h3 class="font-bold text-gray-700">Verification Requests</h3>
                <button onclick="loadAdminData()" class="text-xs text-BTrustOn-accent font-bold hover:underline">
                    <i class="fa-solid fa-rotate"></i> Refresh
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-400 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4">Company</th>
                            <th class="px-6 py-4">Tax ID / Info</th>
                            <th class="px-6 py-4">Submitted At</th>
                            <th class="px-6 py-4">Document</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-request-list" class="divide-y divide-gray-100">
                        <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">Loading requests...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="modal-about" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">  <div class="modal-overlay absolute w-full h-full bg-slate-900/80 backdrop-blur-sm" onclick="toggleModal('modal-about')"></div>
  <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col">
    
    <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
      <h2 class="text-2xl font-header font-bold text-BTrustOn-primary">About BTrustOn</h2>
      <button onclick="toggleModal('modal-about')" class="text-gray-400 hover:text-red-500 transition">
        <i class="fa-solid fa-xmark text-2xl"></i>
      </button>
    </div>

    <div class="p-8 text-gray-600 leading-relaxed space-y-6 text-sm">
      <p class="text-lg font-light text-BTrustOn-primary">
        BTrustOn is the premier digital ecosystem designed to bridge the gap between industrial capability and global opportunity. We replace uncertainty with verified data.
      </p>

      <div>
        <h3 class="font-bold text-BTrustOn-primary mb-2">Our Mission</h3>
        <p>To create a transparent, merit-based industrial network where companies are judged by their proven track record, assets, and verified references rather than marketing noise.</p>
      </div>

      <div>
        <h3 class="font-bold text-BTrustOn-primary mb-2">Who We Are</h3>
        <p>Born from the needs of the construction, mining, and energy sectors, BTrustOn acts as a central registry and verification body. We enable EPC contractors, asset owners, and suppliers to discover trusted partners, verify capabilities instantly, and reduce supply chain risks.</p>
      </div>

      <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
        <h3 class="font-bold text-BTrustOn-primary mb-2 text-xs uppercase tracking-wider">The Trust Scoreâ„¢ Engine</h3>
        <p class="text-xs">Our proprietary algorithm aggregates data from declared assets, completed projects, client verifications, and financial health indicators to assign a dynamic Trust Score. This allows for objective comparison of suppliers worldwide.</p>
      </div>
    </div>
  </div>
</div>

<div id="modal-terms" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
  <div class="modal-overlay absolute w-full h-full bg-slate-900/80 backdrop-blur-sm" onclick="toggleModal('modal-terms')"></div>
  <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] animate-fade-in flex flex-col">
    
    <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
      <div>
        <h2 class="text-2xl font-header font-bold text-BTrustOn-primary">Terms of Service</h2>
        <p class="text-xs text-gray-400">Last Updated: December 2025</p>
      </div>
      <button onclick="toggleModal('modal-terms')" class="text-gray-400 hover:text-red-500 transition">
        <i class="fa-solid fa-xmark text-2xl"></i>
      </button>
    </div>

    <div class="p-8 text-gray-600 leading-relaxed space-y-6 text-xs md:text-sm text-justify">
      
      <div class="p-4 bg-amber-50 border border-amber-100 rounded-lg text-amber-800 text-xs font-bold">
        IMPORTANT: BTrustOn is a data aggregator and networking platform. We do not guarantee the quality, safety, or legality of the services provided by listed companies.
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">1. Acceptance of Terms</h4>
        <p>By accessing or using BTrustOn, you agree to be bound by these Terms. If you represent a company, you certify that you have the authority to bind that entity to these Terms.</p>
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">2. Verification & Data Accuracy</h4>
        <p>While BTrustOn employs rigorous verification processes (including the Trust Scoreâ„¢), we rely on data provided by users and third parties. BTrustOn <strong>does not warrant</strong> the accuracy, completeness, or reliability of any company profile, asset list, or project reference. Users are responsible for conducting their own due diligence before entering into contracts.</p>
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">3. Limitation of Liability (Crucial)</h4>
        <p>To the fullest extent permitted by law, BTrustOn (and its officers, employees, and agents) shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including loss of profits, data, or business reputation. Our total liability for any claim arising out of these terms or the platform use is limited to the amount you paid us (if any) in the past 12 months.</p>
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">4. Indemnification</h4>
        <p>You agree to indemnify and hold BTrustOn harmless from any claims, damages, liabilities, costs, and expenses (including legal fees) arising from: (a) your use of the platform; (b) any content you upload (including logos, details); (c) your violation of any third-party rights or laws.</p>
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">5. International Use & Compliance</h4>
        <p>BTrustOn operates globally. Users are responsible for complying with all local laws and regulations applicable to their jurisdiction. Use of this platform in jurisdictions where its content is illegal is prohibited.</p>
      </div>

      <div>
        <h4 class="font-bold text-BTrustOn-primary uppercase mb-1">6. Governing Law & Dispute Resolution</h4>
        <p>These Terms are governed by the laws of the Republic of Turkey. Any disputes arising from these Terms shall be resolved exclusively in the courts of Istanbul (Ã‡aÄŸlayan), Turkey, without regard to conflict of law principles.</p>
      </div>

    </div>
    
    <div class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end">
        <button onclick="toggleModal('modal-terms')" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg text-xs transition">CLOSE</button>
    </div>

  </div>
</div> 
<div id="modal-upgrade" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[9999]">
  <div class="modal-overlay absolute w-full h-full bg-slate-900/80 backdrop-blur-sm" onclick="toggleModal('modal-upgrade')"></div>
  
  <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden animate-fade-in transform scale-100">
    
    <div class="bg-gradient-to-br from-slate-900 to-BTrustOn-primary p-5 text-center relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
        
        <div class="w-14 h-14 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 border border-white/20 shadow-lg">
            <i class="fa-solid fa-crown text-2xl text-amber-400"></i>
        </div>
        
        <h3 class="text-lg font-header font-bold text-white">Upgrade to Pro</h3>
        <p class="text-cyan-100 text-[10px] uppercase tracking-wider font-bold">Unlock Full Potential</p>
    </div>

    <div class="p-6">
        
        <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-5">
            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3 border-b border-gray-200 pb-2">
                What you get with Pro:
            </h4>
            <ul class="space-y-3">
                <li class="flex items-start gap-3">
                    <div class="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center shrink-0 mt-0.5">
                        <i class="fa-solid fa-circle-check text-blue-600 text-[10px]"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-700">Official Verification Badge</p>
                        <p class="text-[10px] text-gray-500 leading-tight">Build immediate trust with clients.</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <div class="w-5 h-5 rounded-full bg-emerald-100 flex items-center justify-center shrink-0 mt-0.5">
                        <i class="fa-solid fa-infinity text-emerald-600 text-[10px]"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-700">Unlimited Projects & Assets</p>
                        <p class="text-[10px] text-gray-500 leading-tight">Remove limits. Showcase everything.</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <div class="w-5 h-5 rounded-full bg-purple-100 flex items-center justify-center shrink-0 mt-0.5">
                        <i class="fa-solid fa-arrow-trend-up text-purple-600 text-[10px]"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-700">Higher Visibility</p>
                        <p class="text-[10px] text-gray-500 leading-tight">Rank higher in search results.</p>
                    </div>
                </li>
            </ul>
        </div>

        <div class="bg-amber-50 border border-amber-100 rounded-lg p-2.5 mb-5 flex items-center gap-2 justify-center text-[10px] text-amber-800 font-bold">
            <i class="fa-solid fa-gift text-amber-500"></i> 
            <span>6-Month Free Trial. No payment required.</span>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="toggleModal('modal-upgrade')" class="py-3 rounded-xl border border-gray-200 text-gray-500 font-bold text-xs hover:bg-gray-50 transition">
                NO, THANKS
            </button>
            <button onclick="upgradeToPro()" class="py-3 rounded-xl bg-gradient-to-r from-BTrustOn-accent to-blue-600 text-white font-bold text-xs shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:scale-[1.02] transition transform flex items-center justify-center gap-2">
                <span>START FREE TRIAL</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
  </div>
</div>

<div id="modal-celebration" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[10000]">
  <div class="modal-overlay absolute w-full h-full bg-slate-900/90 backdrop-blur-md transition-opacity duration-500"></div>
  
  <div class="modal-container relative bg-white w-11/12 md:max-w-sm mx-auto rounded-3xl shadow-2xl overflow-hidden transform scale-90 transition-all duration-500 ease-out" id="celebration-card">
    
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-40 bg-gradient-to-b from-blue-500/20 to-transparent blur-3xl pointer-events-none"></div>

    <div class="p-8 text-center relative z-10">
        
        <div class="mb-6 relative inline-block">
            <div class="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
            <div class="relative w-24 h-24 bg-gradient-to-tr from-blue-600 to-cyan-400 rounded-full flex items-center justify-center text-white text-5xl shadow-lg shadow-blue-500/40 animate-bounce-slow">
                <i class="fa-solid fa-check"></i>
            </div>
            <i class="fa-solid fa-star text-amber-400 absolute -top-2 -right-2 text-xl animate-spin-slow"></i>
            <i class="fa-solid fa-star text-amber-400 absolute bottom-0 -left-2 text-lg animate-ping"></i>
        </div>

        <h2 class="text-2xl font-header font-bold text-slate-800 mb-2">You are Verified!</h2>
        <p class="text-sm text-gray-500 leading-relaxed mb-8">
            Congratulations! Your business documentation has been approved. You now have the <strong class="text-blue-600">Blue Badge</strong>.
        </p>

        <button onclick="closeCelebration()" class="w-full py-4 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 hover:scale-[1.02] transition transform shadow-xl">
            AWESOME, THANKS!
        </button>
    </div>
  </div>
</div>

<style>
/* Ã–zel Animasyonlar */
/* --- 1. KUTLAMA ANÄ°MASYONLARI (MODAL Ä°Ã‡Ä°N) --- */
    @keyframes bounce-slow {
      0%, 100% { transform: translateY(-5%); }
      50% { transform: translateY(5%); }
    }
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }

    /* --- 2. HATA TÄ°TREMESÄ° (KIRMIZI - SHAKE) --- */
    @keyframes shake-error {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-6px) rotate(-1deg); }
      30% { transform: translateX(6px) rotate(1deg); }
      45% { transform: translateX(-4px); }
      60% { transform: translateX(4px); }
    }
    .shake-input {
      animation: shake-error 0.5s cubic-bezier(.36,.07,.19,.97) both !important;
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
      background-color: #fef2f2 !important;
    }

    /* --- 3. DÄ°KKAT Ã‡EKME (MAVÄ° TÄ°TREME - FOCUS) --- */
    /* --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž (AMA NAZÄ°K) DÄ°KKAT Ã‡EKME EFEKTÄ° --- */
@keyframes strong-shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-4px); }
  40% { transform: translateX(4px); }
  60% { transform: translateX(-2px); }
  80% { transform: translateX(2px); }
}

/* Class tanÄ±mÄ± aynÄ± kalabilir, sadece animasyonun sÃ¼resini kÄ±salttÄ±k (0.8s -> 0.5s) */
.attention-grabber {
  animation: strong-shake 0.5s cubic-bezier(.36,.07,.19,.97) both !important;
  
  /* GÃ¶rÃ¼nÃ¼m deÄŸiÅŸimi */
  box-shadow: 0 0 20px rgba(6, 182, 212, 0.4) !important; /* Daha soft parlama */
  border: 2px solid #06b6d4 !important; 
  background-color: #ecfeff !important; 
  
  position: relative;
  z-index: 50;
}

    /* --- 4. ZÄ°L SALLANMASI (FIX: GROUP HOVER) --- */
    @keyframes swing {
      20% { transform: rotate(15deg); }
      40% { transform: rotate(-10deg); }
      60% { transform: rotate(5deg); }
      80% { transform: rotate(-5deg); }
      100% { transform: rotate(0deg); }
    }
    /* DÃœZELTME: Tailwind'in yapamadÄ±ÄŸÄ±nÄ± manuel CSS ile yapÄ±yoruz */
    .group:hover .fa-bell {
      animation: swing 2s ease-in-out infinite;
      transform-origin: top center;
    }

    /* --- 5. TAÃ‡ Ä°KONU (NEFES ALMA) --- */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .animate-pulse-slow {
      animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<div id="modal-gallery" class="modal opacity-0 pointer-events-none fixed inset-0 z-[99999] flex items-center justify-center bg-black/90 backdrop-blur-md transition-all duration-300">
  
  <button onclick="closeGallery()" class="absolute top-5 right-5 text-white/70 hover:text-white text-3xl z-50">
      <i class="fa-solid fa-xmark"></i>
  </button>

  <div class="w-full h-full flex flex-col items-center justify-center p-4">
      
      <img id="gallery-main-img" src="" class="max-h-[80vh] max-w-full object-contain rounded-lg shadow-2xl mb-4 animate-fade-in">
      
      <div id="gallery-thumbs" class="flex gap-2 overflow-x-auto max-w-2xl pb-2 custom-scrollbar">
          </div>
      
      <p id="gallery-caption" class="text-white/80 text-sm font-bold mt-2"></p>
  </div>
</div>

<div id="modal-cropper" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm transition-all duration-300">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
      
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 class="font-bold text-gray-800">Adjust Image</h3>
          <button onclick="closeCropper()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div class="relative w-full h-[400px] bg-black flex items-center justify-center">
          <img id="cropper-img" src="" class="max-w-full max-h-full block">
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-between items-center gap-3">
          <button onclick="closeCropper()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition text-sm">Cancel</button>
          <button onclick="cropImage()" class="px-6 py-2 rounded-lg bg-BTrustOn-accent text-white font-bold hover:brightness-110 transition shadow-md shadow-blue-500/30 flex items-center gap-2 text-sm">
              <i class="fa-solid fa-crop-simple"></i> CROP & USE
          </button>
      </div>
  </div>
</div>

<script>
  // Login modalÄ±nÄ± aÃ§/kapat
  function openLoginModal() {
    const modal = document.getElementById("login-modal");
    if (!modal) return;
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    const err = document.getElementById("login-error");
    if (err) {
      err.classList.add("hidden");
      err.textContent = "";
    }
  }

  function closeLoginModal() {
    const modal = document.getElementById("login-modal");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");

    const err = document.getElementById("login-error");
    if (err) {
      err.classList.add("hidden");
      err.textContent = "";
    }
  }

  
  // Sayfa yÃ¼klendiÄŸinde login formunu hazÄ±rla
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("login-form");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = new FormData(form);
      const email = data.get("email");
      const password = data.get("password");

      const err = document.getElementById("login-error");
      if (err) {
        err.classList.add("hidden");
        err.textContent = "";
      }

      const { data: authData, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        if (err) {
          err.textContent = error.message || "Login failed";
          err.classList.remove("hidden");
        }
        return;
      }

      // âœ… Login baÅŸarÄ±lÄ± â†’ modalÄ± kapat ve "benim ÅŸirketimi" aÃ§
      closeLoginModal();
      checkUserAndOpenProfile(true);
    });
  });

  // Logout
  /* --- GÃœNCELLENMÄ°Åž: partnerLogout (Sessiz ve Temiz) --- */
async function partnerLogout() {
  try {
    // Varsa mesaj dinlemeyi durdur (Hata vermemesi iÃ§in)
    if (typeof messageChannel !== 'undefined' && messageChannel) {
        supabaseClient.removeChannel(messageChannel);
    }

    // 1. Supabase oturumunu kapat
    await supabaseClient.auth.signOut();
    
    // 2. HafÄ±zayÄ± temizle
    localStorage.removeItem("BTrustOn_my_company_id");
    if(typeof selectedCompany !== 'undefined') selectedCompany = null;

    // 3. Bildirim gÃ¶stermeden direkt ana sayfaya dÃ¶n
    window.location.href = "/";

  } catch (err) {
    console.error("Logout error:", err);
    window.location.href = "/"; // Hata olsa bile sayfayÄ± yenile
  }
}
</script>


  <script>
    const translations = {
      en: {
        hero_title:
          "Source Smarter. <br> <span class='text-transparent bg-clip-text bg-gradient-to-r from-BTrustOn-accent to-blue-600'>Build Faster.</span>",
        hero_desc:
          "Discover verified industrial companies, trust scores and real project references â€“ all on a single screen.",
        search_ph:
          "Search companies, equipment & services...",
        btn_discover: "DISCOVER",
        join: "JOIN NETWORK",
        tab_certs: "CERTIFICATES",
        no_certs: "No certificates listed for this company.",
        asset_categories: "Asset categories:",
        join_title: "Join the Network",
        proj_key_ref: "Key Reference Projects",
        proj_selected_from_supplier: "Selected projects from this supplier",
        join_desc:
          "Create your company profile. Verification usually takes 24 hours.",
        quote_title: "Request Quote",
        btn_submit: "SUBMIT APPLICATION",
        btn_send_quote: "SEND REQUEST",
        back: "BACK TO LIST",
        req_quote: "REQUEST QUOTE",
        sec_all: "All Sectors",
        sec_const: "Construction",
        sec_mine: "Mining",
        sec_energy: "Energy",
        sec_drill: "Drilling",
        sec_manu: "Manufacturing",
        sec_tech: "Technology",
        sec_logi: "Logistics",
        sec_equip: "Equipment",
        tab_overview: "OVERVIEW",
        tab_projects: "PROJECTS",
        tab_certs: "CERTIFICATES",
        certs_title: "Certifications & Compliance",
        certs_sub: "Declared certificates of this company",
        tab_assets: "ASSETS",
        lbl_services: "Core Services",
        th_item: "Item",
        th_specs: "Specs",
        th_status: "Status",
        btn_view: "INSPECT",
        results_label: "Results",
        live_db: "Live Database",
        how_title: "How BTrustOn Works",
        how_sub:
          "Create your company profile, verify your references and let your BTrustOn Scoreâ„¢ increase your visibility.",
        how_step1_title: "Create your profile",
        how_step1_desc:
          "Add your company details, sectors, core services, assets and project highlights.",
        how_step2_title: "Verify references",
        how_step2_desc:
          "Send verification requests to past clients and partners to build a verified track record.",
        how_step3_title: "Grow with Trust Scoreâ„¢",
        how_step3_desc:
          "Higher BTrustOn Scores mean higher visibility in search results and more qualified leads.",
        pricing_title: "Pricing for Industrial Networks",
        pricing_sub:
          "Start free, then upgrade as your company grows. Every plan includes a public profile and access to the BTrustOn Scoreâ„¢ framework.",
        price_free_tag: "For small teams getting started.",
        price_pro_tag: "For growth-focused industrial suppliers.",
        price_ent_tag: "For EPCs and global industrial groups.",
        price_month: "/month",
        price_free_1: "Public company profile",
        price_free_2: "Up to 3 listed services",
        price_free_3: "Basic BTrustOn Scoreâ„¢",
        price_pro_1: "Unlimited services & assets",
        price_pro_2: "Verified reference module",
        price_pro_3: "Priority ranking in search",
        price_pro_4: "Advanced Trust Scoreâ„¢ insights",
        price_ent_1: "Multi-user access & SSO",
        price_ent_2: "API access to supplier data",
        price_ent_3: "Dedicated success manager",
        price_ent_4: "Custom Trust Scoreâ„¢ models",
        btn_get_started: "GET STARTED",
        btn_choose_pro: "CHOOSE PRO",
        btn_contact_sales: "CONTACT SALES",
        badge_popular: "MOST POPULAR",
        top_title: "Top Verified Companies",
        top_sub: "Updated in real-time",
        score_info_main:
          "Calculated from verified references, delivery performance, company age and digital signals.",
        score_info_verify:
          "Verified data can increase your score and ranking.",
        field_company: "Company Name",
        field_sector: "Sector",
        field_city: "City",
        field_website: "Website",
        field_size: "Company Size",
        field_services: "Core Services / Focus",
        field_note: "Additional Notes",
        field_your_name: "Your Name",
        field_project: "Project Details",
        footer_rights: "All rights reserved.",
        footer_about: "About",
        footer_pricing: "Pricing",
        footer_privacy: "Privacy",
        footer_terms: "Terms",
      },
      tr: {
        hero_title:
          "AkÄ±llÄ± Kaynak. <br> <span class='text-transparent bg-clip-text bg-gradient-to-r from-BTrustOn-accent to-blue-600'>HÄ±zlÄ± Ã‡Ã¶zÃ¼m.</span>",
        hero_desc:
          "EndÃ¼striyel ÅŸirketleri tek ekranda toplayÄ±n; gÃ¶rÃ¼nÃ¼rlÃ¼klerini, gÃ¼ven skorlarÄ±nÄ± ve doÄŸrulanmÄ±ÅŸ referanslarÄ±nÄ± birlikte gÃ¶rÃ¼n.",
        search_ph:
         "Firma, ekipman ve hizmet ara...",
        btn_discover: "KEÅžFET",
        join: "AÄžA KATIL",
        asset_categories: "VarlÄ±k kategorileri:",
        proj_key_ref: "Ã–ne Ã‡Ä±kan Referans Projeler",
        proj_selected_from_supplier: "Bu tedarikÃ§iden seÃ§ilmiÅŸ projeler",
        join_title: "AÄŸa KatÄ±lÄ±n",
        join_desc:
          "Firma profilinizi oluÅŸturun. DoÄŸrulama genelde 24 saat sÃ¼rer.",
        quote_title: "Teklif Ä°ste",
        btn_submit: "BAÅžVURUYU GÃ–NDER",
        btn_send_quote: "TALEBÄ° GÃ–NDER",
        back: "LÄ°STEYE DÃ–N",
        req_quote: "TEKLÄ°F Ä°STE",
        sec_all: "TÃ¼m SektÃ¶rler",
        sec_const: "Ä°nÅŸaat",
        sec_mine: "Maden",
        sec_energy: "Enerji",
        sec_drill: "Sondaj",
        sec_manu: "Ãœretim",
        sec_tech: "Teknoloji",
        sec_logi: "Lojistik",
        sec_equip: "Ekipman",
        tab_certs: "SERTÄ°FÄ°KALAR",
        no_certs: "Bu tedarikÃ§i iÃ§in listelenen sertifika yok.",
        sec_energy: "Enerji",
        sec_drill: "Sondaj",
        sec_equip: "Ekipman",
        tab_certs: "SERTÄ°FÄ°KALAR",
        tab_overview: "GENEL BAKIÅž",
        tab_projects: "PROJELER",
        tab_assets: "VARLIKLAR",
        lbl_services: "Hizmetler",
        th_item: "Ekipman",
        th_specs: "Ã–zellik",
        th_status: "Durum",
        btn_view: "Ä°NCELE",
        results_label: "SonuÃ§",
        live_db: "CanlÄ± VeritabanÄ±",
        certs_title: "Sertifikalar ve Uyum",
        certs_sub: "Bu tedarikÃ§inin beyan ettiÄŸi sertifikalar",
        how_title: "BTrustOn NasÄ±l Ã‡alÄ±ÅŸÄ±r?",
        how_sub:
          "Firma profilinizi oluÅŸturun, referanslarÄ±nÄ±zÄ± doÄŸrulatÄ±n ve BTrustOn Scoreâ„¢ ile gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼zÃ¼ artÄ±rÄ±n.",
        how_step1_title: "Profilinizi oluÅŸturun",
        how_step1_desc:
          "Firma bilgilerinizi, sektÃ¶rlerinizi, temel hizmetlerinizi, varlÄ±klarÄ±nÄ±zÄ± ve Ã¶ne Ã§Ä±kan projelerinizi ekleyin.",
        how_step2_title: "ReferanslarÄ± doÄŸrulayÄ±n",
        how_step2_desc:
          "GeÃ§miÅŸ iÅŸ ortaklarÄ±nÄ±za doÄŸrulama isteÄŸi gÃ¶ndererek doÄŸrulanmÄ±ÅŸ bir geÃ§miÅŸ oluÅŸturun.",
        how_step3_title: "Trust Scoreâ„¢ ile bÃ¼yÃ¼yÃ¼n",
        how_step3_desc:
          "YÃ¼ksek BTrustOn Score, arama sonuÃ§larÄ±nda daha yÃ¼ksek gÃ¶rÃ¼nÃ¼rlÃ¼k ve daha nitelikli talepler demektir.",
        pricing_title: "EndÃ¼striyel AÄŸlar iÃ§in FiyatlandÄ±rma",
        pricing_sub:
          "Ãœcretsiz baÅŸlayÄ±n, ÅŸirketiniz bÃ¼yÃ¼dÃ¼kÃ§e yÃ¼kseltin. TÃ¼m paketlerde herkese aÃ§Ä±k profil ve BTrustOn Scoreâ„¢ altyapÄ±sÄ± dahildir.",
        price_free_tag: "Yeni baÅŸlayan kÃ¼Ã§Ã¼k ekipler iÃ§in.",
        price_pro_tag: "BÃ¼yÃ¼me odaklÄ± tedarikÃ§iler iÃ§in.",
        price_ent_tag: "EPC'ler ve global endÃ¼striyel gruplar iÃ§in.",
        price_month: "/ay",
        price_free_1: "Herkese aÃ§Ä±k firma profili",
        price_free_2: "En fazla 3 hizmet giriÅŸi",
        price_free_3: "Temel BTrustOn Scoreâ„¢",
        price_pro_1: "SÄ±nÄ±rsÄ±z hizmet ve varlÄ±k giriÅŸi",
        price_pro_2: "DoÄŸrulanmÄ±ÅŸ referans modÃ¼lÃ¼",
        price_pro_3: "Aramalarda Ã¶ncelikli sÄ±ralama",
        price_pro_4: "GeliÅŸmiÅŸ Trust Scoreâ„¢ iÃ§gÃ¶rÃ¼leri",
        price_ent_1: "Ã‡ok kullanÄ±cÄ±lÄ± eriÅŸim ve SSO",
        price_ent_2: "TedarikÃ§i verisine API eriÅŸimi",
        price_ent_3: "Ã–zel mÃ¼ÅŸteri yÃ¶neticisi",
        price_ent_4: "Kuruma Ã¶zel Trust Scoreâ„¢ modelleri",
        btn_get_started: "BAÅžLA",
        btn_choose_pro: "PRO PAKETÄ° SEÃ‡",
        btn_contact_sales: "SATIÅž ile Ä°LETÄ°ÅžÄ°ME GEÃ‡",
        badge_popular: "EN POPÃœLER",
        top_title: "Trust Score'a GÃ¶re Ã–ne Ã‡Ä±kan Firmalar",
        top_sub: "GerÃ§ek zamanlÄ± gÃ¼ncellenir",
        score_info_main:
          "DoÄŸrulanmÄ±ÅŸ referanslar, teslimat performansÄ±, ÅŸirket yaÅŸÄ± ve dijital sinyallerden hesaplanÄ±r.",
        score_info_verify:
          "DoÄŸrulanmÄ±ÅŸ veriler skorunuzu ve sÄ±ralamanÄ±zÄ± artÄ±rabilir.",
        field_company: "Firma AdÄ±",
        field_sector: "SektÃ¶r",
        field_city: "Åžehir",
        field_website: "Web Sitesi",
        field_size: "Firma BÃ¼yÃ¼klÃ¼ÄŸÃ¼",
        field_services: "Temel Hizmetler / Odak AlanÄ±",
        field_note: "Ek Notlar",
        field_your_name: "Ä°sminiz",
        field_project: "Proje DetaylarÄ±",
        footer_rights: "TÃ¼m haklarÄ± saklÄ±dÄ±r.",
        footer_about: "HakkÄ±nda",
        footer_pricing: "FiyatlandÄ±rma",
        footer_privacy: "Gizlilik",
        footer_terms: "Åžartlar",
      },
    };

    let currentLang = "en";
    let currentSector = "all";
    let selectedCompany = null;
    const ADMIN_EMAIL = "rahmiunl@gmail.com"; // BURAYI KENDÄ° MAÄ°LÄ°NÄ°ZLE DEÄžÄ°ÅžTÄ°RÄ°N
/* --- YENÄ° EKLENEN DEÄžÄ°ÅžKENLER (DOSYA Ä°Ã‡Ä°N) --- */
let currentAssetFile = null; // Yeni yÃ¼klenecek dosyayÄ± tutar
let existingAssetFileUrl = null; // Zaten yÃ¼klÃ¼ olan dosyanÄ±n linkini tutar
let existingAssetFileName = null; // Zaten yÃ¼klÃ¼ olan dosyanÄ±n adÄ±nÄ± tutar

// Dosya SeÃ§ilince Ã‡alÄ±ÅŸÄ±r (Input Change)
function handleAssetFileSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        // Boyut KontrolÃ¼ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showToast("File too large", "Max file size is 5MB.", "error");
            input.value = ""; // SÄ±fÄ±rla
            return;
        }
        currentAssetFile = file;
        
        // Label'Ä± gÃ¼ncelle (Dosya ismini yaz)
        const textEl = document.getElementById("asset-file-text");
        const labelEl = document.getElementById("asset-file-label");
        
        if(textEl) textEl.textContent = file.name;
        if(labelEl) labelEl.classList.add("border-BTrustOn-accent", "bg-cyan-50");
    }
}

// SeÃ§ilen/Mevcut DosyayÄ± Ä°ptal Et (Ã‡Ã¶p Kutusu Butonu)
function removeAssetFile() {
    currentAssetFile = null;
    existingAssetFileUrl = null;
    existingAssetFileName = null;
    
    // Inputu ve gÃ¶rseli sÄ±fÄ±rla
    const inputEl = document.getElementById("asset-file-input");
    const textEl = document.getElementById("asset-file-text");
    const labelEl = document.getElementById("asset-file-label");
    const removeBtn = document.getElementById("btn-remove-asset-file");
    const linkEl = document.getElementById("current-asset-link");

    if(inputEl) inputEl.value = "";
    if(textEl) textEl.textContent = "Attach File (Max 5MB)";
    if(labelEl) labelEl.classList.remove("border-BTrustOn-accent", "bg-cyan-50");
    if(removeBtn) removeBtn.classList.add("hidden");
    if(linkEl) linkEl.classList.add("hidden");
}

/* --- PROJE RESÄ°M YÃ–NETÄ°MÄ° --- */
let currentProjCover = null;       // Yeni seÃ§ilen kapak dosyasÄ±
let shouldRemoveCover = false;     // "KapaÄŸÄ± Sil"e basÄ±ldÄ± mÄ±?
let currentProjGalleryFiles = [];  // Yeni seÃ§ilen galeri dosyalarÄ± (File objeleri)
let tempExistingGalleryUrls = [];  // DÃ¼zenleme modunda: VeritabanÄ±ndaki mevcut URL'ler
let cropperInstance = null; // KÄ±rpma aracÄ±nÄ± tutacak

// 1. Kapak SeÃ§imi
/* --- GÃœNCELLENMÄ°Åž: handleProjectCover (CROPPER Ä°LE) --- */
function handleProjectCover(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // 1. Resmi oku ve KÄ±rpma ModalÄ±nÄ± aÃ§
        const reader = new FileReader();
        reader.onload = (e) => {
            openCropper(e.target.result);
        };
        reader.readAsDataURL(file);
        
        // Input'u sÄ±fÄ±rla ki aynÄ± resmi seÃ§ince tekrar tetiklensin
        input.value = ""; 
    }
}

// --- CROPPER FONKSÄ°YONLARI ---

function openCropper(imageSrc) {
    const modal = document.getElementById("modal-cropper");
    const image = document.getElementById("cropper-img");
    
    // Resmi yÃ¼kle
    image.src = imageSrc;
    
    // ModalÄ± gÃ¶ster
    modal.classList.remove("opacity-0", "pointer-events-none");

    // EÄŸer eski bir cropper varsa yok et (memory leak olmasÄ±n)
    if (cropperInstance) {
        cropperInstance.destroy();
    }

    // Yeni Cropper baÅŸlat
    // aspectRatio: 16/9 -> DikdÃ¶rtgen kapak iÃ§in ideal oran
    cropperInstance = new Cropper(image, {
        aspectRatio: 16 / 9, 
        viewMode: 1, 
        autoCropArea: 1,
        dragMode: 'move',
        guides: true,
        center: true,
        background: false
    });
}

function closeCropper() {
    const modal = document.getElementById("modal-cropper");
    modal.classList.add("opacity-0", "pointer-events-none");
    if (cropperInstance) {
        cropperInstance.destroy();
        cropperInstance = null;
    }
}

function cropImage() {
    if (!cropperInstance) return;

    // 1. KÄ±rpÄ±lmÄ±ÅŸ hali Canvas olarak al
    const canvas = cropperInstance.getCroppedCanvas({
        width: 800,  // Resmi optimize et (Ã§ok bÃ¼yÃ¼k olmasÄ±n)
        height: 450, // 16:9 oranÄ±nda
    });

    // 2. Canvas'Ä± Blob'a (Dosyaya) Ã§evir
    canvas.toBlob((blob) => {
        // Blob'u sanki bir File objesiymiÅŸ gibi paketle
        // Supabase'e yÃ¼klerken 'name' lazÄ±m olacak
        const file = new File([blob], "cropped_cover.jpg", { type: "image/jpeg" });

        // 3. Bizim ana deÄŸiÅŸkene ata (saveProject bunu kullanacak)
        currentProjCover = file;
        shouldRemoveCover = false;

        // 4. Ã–nizleme kutusunu gÃ¼ncelle (Modal iÃ§indeki kÃ¼Ã§Ã¼k kutu)
        const previewDiv = document.getElementById("cover-preview");
        previewDiv.innerHTML = `
            <img src="${canvas.toDataURL()}" class="w-full h-full object-cover">
            <button type="button" onclick="removeProjectCover()" class="absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition cursor-pointer">
               <i class="fa-solid fa-trash text-xs"></i>
            </button>
        `;

        // 5. KÄ±rpÄ±cÄ±yÄ± kapat
        closeCropper();
        showToast("Image Cropped", "Cover image updated.", "success");
    }, 'image/jpeg', 0.85); // %85 kalite ile sÄ±kÄ±ÅŸtÄ±r
}

// 2. KapaÄŸÄ± Silme Fonksiyonu
function removeProjectCover() {
    currentProjCover = null;
    shouldRemoveCover = true; // Kaydederken 'null' gÃ¶ndereceÄŸiz
    
    // UI'Ä± sÄ±fÄ±rla
    const div = document.getElementById("cover-preview");
    div.innerHTML = `<i class="fa-solid fa-image text-gray-400"></i>`;
}

// 3. Galeriye YENÄ° Dosya Ekleme
function handleProjectGallery(input) {
    if (input.files) {
        // Yeni dosyalarÄ± mevcutlarÄ±n Ã¼zerine ekle (Append)
        const newFiles = Array.from(input.files);
        currentProjGalleryFiles = [...currentProjGalleryFiles, ...newFiles];
        
        // Metni gÃ¼ncelle
        updateGalleryCountText();
    }
}

// 4. Galeri Metni GÃ¼ncelleme Helper
function updateGalleryCountText() {
    const total = tempExistingGalleryUrls.length + currentProjGalleryFiles.length;
    const txt = document.getElementById("gallery-count-text");
    if(total > 0) txt.textContent = `${currentProjGalleryFiles.length} new, ${tempExistingGalleryUrls.length} existing`;
    else txt.textContent = "";
}

// 5. Mevcut Galeri Resmini Listeden Ã‡Ä±karma (UI'dan silme)
function removeExistingGalleryImage(url) {
    // Listeden Ã§Ä±kar
    tempExistingGalleryUrls = tempExistingGalleryUrls.filter(u => u !== url);
    // UI'Ä± gÃ¼ncelle (Yeniden Ã§iz)
    renderExistingGalleryPreviews();
    updateGalleryCountText();
}

// 6. Galeri Ã–nizlemelerini Ã‡izme (Modal AÃ§Ä±lÄ±nca)
function renderExistingGalleryPreviews() {
    const container = document.getElementById("existing-gallery-preview");
    container.innerHTML = "";
    
    if (tempExistingGalleryUrls.length === 0) {
        container.style.display = "none"; // BoÅŸsa gizle
        return;
    }
    container.style.display = "flex";

    tempExistingGalleryUrls.forEach(url => {
        const div = document.createElement("div");
        div.className = "relative flex-shrink-0 w-12 h-12 rounded border border-gray-200 overflow-hidden group";
        div.innerHTML = `
            <img src="${url}" class="w-full h-full object-cover">
            <button type="button" onclick="removeExistingGalleryImage('${url}')" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center rounded-bl text-[8px] hover:bg-red-600 transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

/* --- STEP 5: PLAN LÄ°MÄ°TLERÄ° VE KONTROLÃœ --- */
const PLAN_LIMITS = {
    free: { projects: 2, assets: 3, certs: 2 },
    pro: { projects: 9999, assets: 9999, certs: 9999 }
};

function checkPlanLimit(type) {
    // Åžirket verisi yoksa veya tier bilgisi yoksa 'free' varsay
    const tier = (selectedCompany && selectedCompany.subscription_tier) ? selectedCompany.subscription_tier : 'free';
    
    // Pro ise sÄ±nÄ±r yok, geÃ§
    if (tier === 'pro') return true;

    // Mevcut sayÄ±larÄ± kontrol et
    let currentCount = 0;
    const limit = PLAN_LIMITS.free[type];

    if (selectedCompany) {
        if (type === 'projects') currentCount = (selectedCompany.projects || []).length;
        if (type === 'assets') currentCount = (selectedCompany.assets || []).length;
        if (type === 'certs') currentCount = (selectedCompany.certificates || []).length;
    }

    // Limit dolduysa uyarÄ± ver ve false dÃ¶ndÃ¼r
    if (currentCount >= limit) {
        showToast("Limit Reached", `Free plan limit: ${limit} items. Upgrade to add more.`, "error");
        return false;
    }
    return true; // Limit dolmadÄ±ysa true dÃ¶ndÃ¼r
}
/* --- GENÄ°ÅžLETÄ°LMÄ°Åž ÃœLKE LÄ°STESÄ° --- */
const countryList = [
    // Asya & Pasifik
    "Afghanistan", "Australia", "Bangladesh", "China", "India", "Indonesia", "Japan", 
    "Kazakhstan", "Malaysia", "Mongolia", "New Zealand", "Pakistan", "Philippines", 
    "Singapore", "South Korea", "Thailand", "Turkmenistan", "Uzbekistan", "Vietnam",
    
    // Avrupa
    "Albania", "Austria", "Belgium", "Bosnia and Herzegovina", "Bulgaria", "Croatia", 
    "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", 
    "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Netherlands", "Norway", 
    "Poland", "Portugal", "Romania", "Russia", "Serbia", "Spain", "Sweden", 
    "Switzerland", "Ukraine", "United Kingdom",
    
    // Orta DoÄŸu & Afrika
    "Algeria", "Azerbaijan", "Bahrain", "Egypt", "Georgia", "Iran", "Iraq", "Israel", 
    "Jordan", "Kuwait", "Lebanon", "Libya", "Morocco", "Nigeria", "Oman", "Qatar", 
    "Saudi Arabia", "South Africa", "Tunisia", "UAE",
    
    // Amerika
    "Argentina", "Brazil", "Canada", "Chile", "Colombia", "Mexico", "Peru", "USA", "Venezuela"
].sort(); // Ã–nce hepsini alfabetik diziyoruz

// Sayfa aÃ§Ä±lÄ±nca kutularÄ± dolduran fonksiyon (TÃœRKÄ°YE Ã–NCELÄ°KLÄ°)
function populateCountrySelects() {
    const selects = ["join-country", "edit-country"];
    
    selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        
        el.innerHTML = '<option value="">Select Country...</option>';
        
        // 1. TÃœRKÄ°YE'YÄ° EN BAÅžA SABÄ°TLE (KolaylÄ±k olsun)
        const trOption = document.createElement("option");
        trOption.value = "Turkey";
        trOption.textContent = "Turkey";
        el.appendChild(trOption);

        // Araya Ã§izgi (Separator) atalÄ±m
        const separator = document.createElement("option");
        separator.disabled = true;
        separator.textContent = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";
        el.appendChild(separator);

        // 2. DÄ°ÄžER ÃœLKELERÄ° ALFABETÄ°K EKLE
        countryList.forEach(c => {
            // Listede Turkey varsa tekrar ekleme (zaten baÅŸa koyduk)
            if (c !== "Turkey") {
                const option = document.createElement("option");
                option.value = c;
                option.textContent = c;
                el.appendChild(option);
            }
        });
        
        // Listenin sonuna "Other" ekle
        const otherOpt = document.createElement("option");
        otherOpt.value = "Other";
        otherOpt.textContent = "Other / Not Listed";
        el.appendChild(otherOpt);
    });
}

    // Top band animasyon & canlÄ± gÃ¶rÃ¼nÃ¼m iÃ§in
    let topCompaniesOrder = [];
    let topScrollInterval = null;
    let topRotateInterval = null;

    // Ana grid iÃ§in hafif "canlÄ±lÄ±k" (boÅŸ aramada hafif shuffle)
    let gridShuffleInterval = null;

    // *** DATABASE: TAM LÄ°STE ***
    const database = [
      {
        id: 101,
        name: "RÃ¶nesans Holding",
        city: "Ankara, TR",
        sector: "construction",
        type: "contractor",
        trust: "global",
        meta: {
          references: 96,
          delivery: 94,
          years: 90,
          financial: 92,
          digital: 85,
        },
        desc:
          "Global contractor in large-scale infrastructure, industrial and healthcare projects.",
        desc_tr:
          "BÃ¼yÃ¼k Ã¶lÃ§ekli altyapÄ±, endÃ¼striyel tesis ve saÄŸlÄ±k projelerinde faaliyet gÃ¶steren global yÃ¼klenici.",
        services: ["EPC Contracts", "Healthcare Projects", "Industrial Facilities"],
        services_tr: ["EPC SÃ¶zleÅŸmeleri", "SaÄŸlÄ±k Projeleri", "EndÃ¼striyel Tesisler"],
        certificates: ["ISO 9001:2015", "ISO 14001:2015", "ISO 45001:2018", "LEED Platinum"],
        projects: [
          {
            title: "Yamal LNG",
            title_tr: "Yamal LNG",
            loc: "Russia",
            loc_tr: "Rusya",
            desc: "Mega-scale LNG plant project in the Arctic region.",
            desc_tr: "Arktik bÃ¶lgede mega Ã¶lÃ§ekli LNG tesis projesi.",
          },
        ],
        assets: [
          {
            type: "Tower Crane Fleet",
            type_tr: "Kule vinÃ§ filosu",
            spec: "Liebherr & Terex, >30 units",
            spec_tr: "Liebherr & Terex, 30+ Ã¼nite",
            status: "Available",
            status_tr: "MÃ¼sait",
          },
        ],
      },
      {
        id: 102,
        name: "Bechtel Corporation",
        city: "USA",
        sector: "construction",
        type: "contractor",
        trust: "global",
        meta: {
          references: 98,
          delivery: 96,
          years: 95,
          financial: 95,
          digital: 88,
        },
        desc:
          "US-based engineering and construction company delivering complex megaprojects worldwide.",
        desc_tr:
          "DÃ¼nya genelinde karmaÅŸÄ±k mega projeler gerÃ§ekleÅŸtiren ABD merkezli mÃ¼hendislik ve inÅŸaat ÅŸirketi.",
        certificates: ["ASME N-Stamp", "ISO 9001", "ISO 14001", "OSHA VPP Star"],
        services: ["Nuclear Power", "Infrastructure EPC", "Rail & Transit"],
        services_tr: [
          "NÃ¼kleer enerji santralleri",
          "AltyapÄ± EPC projeleri",
          "Demiryolu ve ulaÅŸÄ±m projeleri",
        ],
        projects: [
          {
            title: "Hoover Dam",
            title_tr: "Hoover BarajÄ±",
            loc: "USA",
            loc_tr: "ABD",
            desc: "Iconic hydroelectric dam and infrastructure project.",
            desc_tr: "Ä°konik hidroelektrik baraj ve altyapÄ± projesi.",
          },
        ],
        assets: [],
      },
      {
        id: 103,
        name: "Rio Tinto",
        city: "UK/AUS",
        sector: "mining",
        type: "operator",
        trust: "global",
        meta: {
          references: 97,
          delivery: 94,
          years: 95,
          financial: 96,
          digital: 82,
        },
        desc:
          "Global mining corporation with diversified portfolio across iron ore, copper and more.",
        desc_tr:
          "Demir cevheri, bakÄ±r ve diÄŸer emtialarda Ã§eÅŸitlendirilmiÅŸ portfÃ¶ye sahip global madencilik ÅŸirketi.",
        services: ["Copper Operations", "Iron Ore", "Project Development"],
        services_tr: ["BakÄ±r iÅŸletmeleri", "Demir cevheri", "Proje geliÅŸtirme"],
        certificates: ["The Copper Mark", "ICMM Member", "ISO 14001", "TSM Protocol"],
        projects: [
          {
            title: "Oyu Tolgoi",
            title_tr: "Oyu Tolgoi",
            loc: "Mongolia",
            loc_tr: "MoÄŸolistan",
            desc: "World-class copper-gold mine development.",
            desc_tr: "DÃ¼nya Ã¶lÃ§eÄŸinde bakÄ±r-altÄ±n madeni geliÅŸtirme projesi.",
          },
        ],
        assets: [],
      },
      {
        id: 104,
        name: "Schlumberger",
        city: "USA/FR",
        sector: "drilling",
        type: "tech",
        trust: "global",
        meta: {
          references: 94,
          delivery: 93,
          years: 90,
          financial: 92,
          digital: 90,
        },
        desc:
          "Technology leader in oilfield services, digital solutions and subsurface data.",
        desc_tr:
          "Sondaj ve petrol sahasÄ± hizmetleri, dijital Ã§Ã¶zÃ¼mler ve yeraltÄ± verilerinde teknoloji lideri.",
        services: ["Directional Drilling", "Digital Oilfield", "Well Logging"],
        services_tr: [
          "YÃ¶nlÃ¼ sondaj hizmetleri",
          "Dijital petrol sahasÄ± Ã§Ã¶zÃ¼mleri",
          "Kuyu loglama hizmetleri",
        ],
        certificates: ["API Spec Q1", "API Spec Q2", "ISO 27001", "ISO 14001"],
        projects: [],
        assets: [],
      },
      {
        id: 105,
        name: "Demir Export",
        city: "Ankara, TR",
        sector: "mining",
        type: "operator",
        trust: "verified",
        meta: {
          references: 90,
          delivery: 88,
          years: 85,
          financial: 86,
          digital: 75,
        },
        desc:
          "Turkish mining operator focused on gold, iron and base metals.",
        desc_tr:
          "AltÄ±n, demir ve baz metaller odaklÄ± faaliyet gÃ¶steren TÃ¼rk madencilik ÅŸirketi.",
        services: ["Gold Mining", "Iron Ore", "Feasibility & Development"],
        services_tr: [
          "AltÄ±n madenciliÄŸi",
          "Demir cevheri Ã¼retimi",
          "Fizibilite ve geliÅŸtirme",
        ],
        certificates: ["ISO 50001", "ISO 14001", "ISO 45001", "Gold Standard"],
        projects: [
          {
            title: "BakÄ±rtepe",
            title_tr: "BakÄ±rtepe",
            loc: "Sivas, TR",
            loc_tr: "Sivas, TÃ¼rkiye",
            desc: "Gold mine operation and development.",
            desc_tr: "AltÄ±n madeni iÅŸletmesi ve geliÅŸtirme projesi.",
          },
        ],
        assets: [],
      },
      {
        id: 106,
        name: "Siemens Energy",
        city: "Germany",
        sector: "energy",
        type: "tech",
        trust: "verified",
        meta: {
          references: 95,
          delivery: 93,
          years: 92,
          financial: 94,
          digital: 88,
        },
        desc:
          "Energy technology company delivering turbines, grid solutions and services.",
        desc_tr:
          "TÃ¼rbinler, ÅŸebeke Ã§Ã¶zÃ¼mleri ve servis hizmetleri sunan enerji teknolojileri ÅŸirketi.",
        services: ["Gas Turbines", "Grid Solutions", "Service & Maintenance"],
        services_tr: [
          "Gaz tÃ¼rbinleri",
          "Åžebeke Ã§Ã¶zÃ¼mleri",
          "Servis ve bakÄ±m hizmetleri",
        ],
        certificates: ["ISO 50001", "ISO 27001", "IEC 62443", "ISO 9001"],
        projects: [],
        assets: [],
      },
      {
        id: 107,
        name: "Borusan CAT",
        city: "Istanbul, TR",
        sector: "equipment",
        type: "manufacturer",
        trust: "verified",
        meta: {
          references: 92,
          delivery: 90,
          years: 88,
          financial: 87,
          digital: 80,
        },
        desc:
          "Authorized CAT dealer for heavy equipment sales, rental and service.",
        desc_tr:
          "AÄŸÄ±r iÅŸ makineleri satÄ±ÅŸ, kiralama ve servisinde yetkili CAT distribÃ¼tÃ¶rÃ¼.",
        services: ["Equipment Sales", "Rental Fleet", "After-Sales Service"],
        services_tr: [
          "Makina satÄ±ÅŸÄ±",
          "Kiralama filosu",
          "SatÄ±ÅŸ sonrasÄ± servis",
        ],
        certificates: ["Caterpillar 5-Star Dealer", "ISO 9001", "ISO 27001", "ISO 14001"],
        projects: [],
        assets: [
          {
            type: "CAT Excavator Fleet",
            type_tr: "CAT ekskavatÃ¶r filosu",
            spec: "CAT 336 / 352",
            spec_tr: "CAT 336 / 352",
            status: "In Stock",
            status_tr: "Stokta",
          },
        ],
      },
      {
        id: 108,
        name: "OrtadoÄŸu Sondaj",
        city: "Ankara, TR",
        sector: "drilling",
        type: "contractor",
        trust: "emerging",
        meta: {
          references: 88,
          delivery: 86,
          years: 82,
          financial: 80,
          digital: 72,
        },
        desc:
          "Drilling contractor specialized in core drilling and geothermal exploration.",
        desc_tr:
          "Karot sondajÄ± ve jeotermal arama projelerinde uzman sondaj yÃ¼klenicisi.",
        services: ["Core Drilling", "Geothermal Wells", "Exploration Support"],
        services_tr: [
          "Karot sondajÄ±",
          "Jeotermal kuyu aÃ§ma",
          "Arama saha desteÄŸi",
        ],
        certificates: ["ISO 9001:2015", "ISO 14001:2015", "OHSAS 18001"],
        projects: [],
        assets: [],
      },
      {
        id: 109,
        name: "Enka Ä°nÅŸaat",
        city: "Istanbul, TR",
        sector: "construction",
        type: "contractor",
        trust: "global",
        meta: {
          references: 97,
          delivery: 95,
          years: 93,
          financial: 94,
          digital: 86,
        },
        desc:
          "Engineering and construction company active in power, infrastructure and industrial plants.",
        desc_tr:
          "Enerji santralleri, altyapÄ± ve endÃ¼striyel tesis projelerinde faaliyet gÃ¶steren mÃ¼hendislik ve inÅŸaat ÅŸirketi.",
        services: ["Power Plants", "Infrastructure EPC", "Industrial Projects"],
        services_tr: [
          "Enerji santrali projeleri",
          "AltyapÄ± EPC projeleri",
          "EndÃ¼striyel tesis projeleri",
        ],
        certificates: ["ASME S/U/PP Stamps", "ISO 9001", "ISO 14001", "OHSAS 18001"],
        projects: [],
        assets: [],
      },
      {
        id: 110,
        name: "Sandvik Mining",
        city: "Sweden",
        sector: "equipment",
        type: "manufacturer",
        trust: "premium",
        meta: {
          references: 95,
          delivery: 93,
          years: 91,
          financial: 92,
          digital: 84,
        },
        desc:
          "Manufacturer of mining equipment including crushers and underground drills.",
        desc_tr:
          "KÄ±rÄ±cÄ±lar ve yeraltÄ± delici makineler dahil madencilik ekipmanlarÄ± Ã¼reticisi.",
        services: ["Crushers", "Underground Drills", "OEM Parts"],
        services_tr: [
          "KÄ±rÄ±cÄ± ekipmanlar",
          "YeraltÄ± delici makineler",
          "Orijinal yedek parÃ§a (OEM)",
        ],
        certificates: ["ISO 9001", "CE Marking", "EcoVadis Gold", "ISO 45001"],
        projects: [],
        assets: [],
      },
      {
        id: 111,
        name: "HÄ°DROMEK",
        city: "Ankara, TR",
        sector: "equipment",
        type: "manufacturer",
        trust: "verified",
        meta: {
          references: 90,
          delivery: 88,
          years: 86,
          financial: 85,
          digital: 78,
        },
        desc:
          "Construction machinery manufacturer with backhoe loaders and motor graders.",
        desc_tr:
          "KazÄ±cÄ± yÃ¼kleyici ve greyder Ã¼retiminde uzman inÅŸaat makinalarÄ± Ã¼reticisi.",
        services: ["Backhoe Loaders", "Motor Graders", "Excavators"],
        services_tr: [
          "KazÄ±cÄ± yÃ¼kleyiciler",
          "Greyderler",
          "EkskavatÃ¶rler",
        ],
        certificates: ["ISO 9001", "TSE-ISO-EN 9000", "Turquality"],
        projects: [],
        assets: [],
      },
// const database = [ dizisinin iÃ§ine, diÄŸer ÅŸirketlerin altÄ±na virgÃ¼l koyup bunlarÄ± ekle:

      {
        id: 112,
        name: "ABB Industrial",
        city: "Zurich, CH",
        sector: "technology",  // YENÄ° SEKTÃ–R
        type: "tech",
        trust: "global",
        meta: { references: 96, delivery: 95, years: 98, financial: 94, digital: 92 },
        desc: "Industrial automation, robotics and electrification technology leader.",
        services: ["Robotics", "Automation", "Electrification"],
        certificates: ["ISO 9001", "ISO 14001", "IEC 62443"],
        projects: [],
        assets: []
      },
      {
        id: 113,
        name: "Kuehne+Nagel",
        city: "Hamburg, DE",
        sector: "logistics", // YENÄ° SEKTÃ–R
        type: "service",
        trust: "global",
        meta: { references: 94, delivery: 98, years: 95, financial: 92, digital: 88 },
        desc: "Global transport and logistics company specialized in sea and air freight.",
        services: ["Project Logistics", "Sea Freight", "Heavy Lift Transport"],
        certificates: ["ISO 9001", "AEO Status", "IATA Agent"],
        projects: [],
        assets: []
      },
      {
        id: 114,
        name: "ArcelorMittal",
        city: "Luxembourg",
        sector: "manufacturing", // YENÄ° SEKTÃ–R
        type: "manufacturer",
        trust: "global",
        meta: { references: 95, delivery: 92, years: 94, financial: 90, digital: 85 },
        desc: "The world's leading steel and mining company.",
        services: ["Steel Production", "Mining", "R&D"],
        certificates: ["IATF 16949", "ISO 14001", "ResponsibleSteel"],
        projects: [],
        assets: []
      },
    ];

    function t(key) {
      return translations[currentLang][key] || translations.en[key] || "";
    }

    function computeScore(meta) {
      const sum =
        meta.references +
        meta.delivery +
        meta.years +
        meta.financial +
        meta.digital;
      return Math.round(sum / 5);
    }

    /* --- YENÄ° ROZET SÄ°STEMÄ° (SADECE MAVÄ° TÄ°K) --- */
function getTrustBadge(company) {
  // Sadece 'verified' ise rozet gÃ¶ster, yoksa boÅŸ dÃ¶n.
  // Not: Supabase'den gelen veri 'verification_status' sÃ¼tununda duruyor.
  // Ancak biz frontend'de bunu 'trust' deÄŸiÅŸkenine map ediyor olabiliriz veya direkt bakabiliriz.
  // Garanti olsun diye hem 'trust' alanÄ±na hem yeni statÃ¼ye bakÄ±yoruz.
  
  const isVerified = String(company.verification_status || '').toLowerCase() === 'verified';

  if (isVerified) {
    return `
      <span class="bg-blue-50 text-blue-600 border border-blue-200 text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm" title="Officially Verified Company">
        <i class="fa-solid fa-circle-check"></i>
        <span>VERIFIED</span>
      </span>
    `;
  }
  
  return ""; // OnaylÄ± deÄŸilse hiÃ§biÅŸi gÃ¶sterme (Temiz gÃ¶rÃ¼nÃ¼m)
}

// ðŸ‘‡ YENÄ° FONKSÄ°YON: Åžirket Tipine GÃ¶re Rozet Ãœretir ðŸ‘‡
    /* --- GÃœNCELLENMÄ°Åž: getCompanyTypeBadge (YENÄ° TÄ°PLER) --- */
function getCompanyTypeBadge(rawType) {
  const type = (rawType || "company").toLowerCase();
  let label = rawType;
  let icon = "fa-building";
  // VarsayÄ±lan Renk (Gri)
  let colorClass = "bg-gray-50 text-gray-500 border-gray-200";

  // 1. Ãœreticiler (Mor)
  if (type.includes("manufacturer") || type.includes("oem")) {
    label = "Manufacturer / OEM";
    icon = "fa-industry";
    colorClass = "bg-purple-50 text-purple-700 border-purple-100";
  } 
  // 2. Ana YÃ¼kleniciler (Turuncu - Koyu)
  else if (type.includes("epc") || type.includes("general contractor")) {
    label = "EPC Contractor";
    icon = "fa-helmet-safety";
    colorClass = "bg-orange-100 text-orange-800 border-orange-200";
  } 
  // 3. Alt YÃ¼kleniciler (Turuncu - AÃ§Ä±k)
  else if (type.includes("subcontractor") || type.includes("specialist")) {
    label = "Specialist / Sub";
    icon = "fa-screwdriver-wrench";
    colorClass = "bg-orange-50 text-orange-600 border-orange-100";
  }
  // 4. TedarikÃ§iler (Ä°ndigo)
  else if (type.includes("distributor") || type.includes("supplier")) {
    label = "Distributor / Supplier";
    icon = "fa-truck-ramp-box";
    colorClass = "bg-indigo-50 text-indigo-700 border-indigo-100";
  } 
  // 5. Teknoloji (Mavi)
  else if (type.includes("tech") || type.includes("software")) {
    label = "Tech & Software";
    icon = "fa-microchip";
    colorClass = "bg-blue-50 text-blue-700 border-blue-100";
  } 
  // 6. MÃ¼hendislik (Cam GÃ¶beÄŸi / Teal)
  else if (type.includes("engineering") || type.includes("consultancy")) {
    label = "Engineering & Consult.";
    icon = "fa-drafting-compass";
    colorClass = "bg-teal-50 text-teal-700 border-teal-100";
  }
  // 7. Ä°ÅŸletmeciler / Maden Sahipleri (ZÃ¼mrÃ¼t YeÅŸili)
  else if (type.includes("operator") || type.includes("asset") || type.includes("mining")) {
    label = "Operator / Asset Owner";
    icon = "fa-gem";
    colorClass = "bg-emerald-50 text-emerald-700 border-emerald-100";
  }

  return `
    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-[10px] font-bold border ${colorClass} uppercase tracking-wide whitespace-nowrap">
       <i class="fa-solid ${icon}"></i> ${label}
    </span>
  `;
}

    function getScoreLabel(score) {
      if (currentLang === "tr") {
        if (score >= 95) return "MÃœKEMMEL";
        if (score >= 90) return "GÃœÃ‡LÃœ";
        if (score >= 80) return "SAÄžLAM";
        return "GELÄ°ÅžMEKTE";
      } else {
        if (score >= 95) return "EXCELLENT";
        if (score >= 90) return "STRONG";
        if (score >= 80) return "SOLID";
        return "GROWING";
      }
    }

    function sectorToTr(sector) {
      if (currentLang === "en") {
        // Ä°ngilizce modda baÅŸ harfi bÃ¼yÃ¼tÃ¼p dÃ¶ndÃ¼rÃ¼r
        if (sector === "manufacturing") return "Manufacturing";
        if (sector === "technology") return "Technology";
        if (sector === "logistics") return "Logistics";
        return sector.charAt(0).toUpperCase() + sector.slice(1);
      }
      
      // TÃ¼rkÃ§e mod iÃ§in karÅŸÄ±lÄ±klar
      if (sector === "construction") return "Ä°nÅŸaat";
      if (sector === "mining") return "Maden";
      if (sector === "energy") return "Enerji";
      if (sector === "drilling") return "Sondaj";
      if (sector === "equipment") return "Ekipman";
      if (sector === "manufacturing") return "Ãœretim & Sanayi";
      if (sector === "technology") return "Teknoloji";
      if (sector === "logistics") return "Lojistik";
      
      return sector;
    }

    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (!key) return;
        const value = t(key);
        if (value) {
          el.innerHTML = value;
        }
      });

      const heroTitle = document.getElementById("hero-title");
      const heroDesc = document.getElementById("hero-desc");
      if (heroTitle) heroTitle.innerHTML = t("hero_title");
      if (heroDesc) heroDesc.innerHTML = t("hero_desc");

      const searchInput = document.getElementById("search-input");
      if (searchInput) searchInput.placeholder = t("search_ph");

      const yearSpan = document.getElementById("year-span");
      if (yearSpan) yearSpan.textContent = new Date().getFullYear().toString();
    }

    // TOP COMPANIES BAND

    // TOP COMPANIES (AKILLI ROTASYON MANTIÄžI)
    function initTopCompaniesOrder() {
      // 1. ADIM: HAVUZU OLUÅžTUR (Kriterlere uyan herkesi al)
      let qualifiedCompanies = database.filter(company => {
          const score = computeScore(company.meta);
          
          // Kriter 1: PuanÄ± 80 ve Ã¼zeri olsun (BarajÄ± biraz esnetebiliriz)
          if (score < 80) return false;

          // Kriter 2: StatÃ¼sÃ¼ gÃ¼venilir olsun
          const validTrustLevels = ["verified", "premium", "global"];
          if (!validTrustLevels.includes(company.trust)) return false;

          return true; 
      });

      // GÃ¼venlik Ã–nlemi: EÄŸer veritabanÄ± Ã§ok yeniyse ve kimse kriteri geÃ§emediyse,
      // vitrin boÅŸ kalmasÄ±n diye en yÃ¼ksek puanlÄ±larÄ± mecburen al.
      if (qualifiedCompanies.length < 5) {
         qualifiedCompanies = [...database].sort((a, b) => computeScore(b.meta) - computeScore(a.meta));
      }

      // 2. ADIM: KARIÅžTIR (SHUFFLE)
      // Bu sayede her sayfa yenilemede farklÄ± firmalar ÅŸans bulur.
      qualifiedCompanies.sort(() => Math.random() - 0.5);

      // 3. ADIM: LÄ°MÄ°TLE (Performans Ä°Ã§in)
      // Havuzda 1000 kiÅŸi olsa bile o an sadece ÅŸanslÄ± 30 kiÅŸiyi gÃ¶ster.
      // Bir sonraki giren kiÅŸi diÄŸer 30'u gÃ¶recek.
      topCompaniesOrder = qualifiedCompanies.slice(0, 30);
    }

function renderTopCompanies() {
      const container = document.getElementById("top-companies");
      if (!container) return;
      container.innerHTML = "";

      if (!topCompaniesOrder.length) {
        initTopCompaniesOrder();
      }

      // AKILLI LÄ°STELEME MANTIÄžI:
      // EÄŸer veritabanÄ±nda az ÅŸirket varsa (10'dan az), ekran dolsun ve animasyon aksÄ±n diye listeyi Ã§oÄŸaltÄ±yoruz.
      // EÄŸer zaten Ã§ok ÅŸirket varsa, sistemi yormamak iÃ§in olduÄŸu gibi bÄ±rakÄ±yoruz.
      let topList;
      if (topCompaniesOrder.length < 10) {
         const baseTop = topCompaniesOrder.slice(0, 5); // En iyi 5 ÅŸirketi al
         topList = [...baseTop, ...baseTop, ...baseTop, ...baseTop]; // 4 kere arka arkaya ekle
      } else {
         topList = topCompaniesOrder.slice(0, 20); // Zaten Ã§ok varsa ilk 20 tanesi yeter
      }

      topList.forEach((company) => {
        const score = computeScore(company.meta);
        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const card = document.createElement("button");
        // Mobilde ve PC'de dÃ¼zgÃ¼n durmasÄ± iÃ§in geniÅŸlik ayarÄ±
        card.className =
          "min-w-[260px] bg-slate-900 text-white rounded-xl px-4 py-3 flex flex-col justify-between shadow-md hover:shadow-lg hover:-translate-y-0.5 transition transform border border-slate-700/50";
        card.onclick = () => openProfile(company.id);

        card.innerHTML = `
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-[13px] font-bold line-clamp-1 text-cyan-50">
              ${company.name}
            </span>
            <span class="text-[11px] font-semibold bg-cyan-900/50 text-cyan-200 px-2 py-0.5 rounded-full border border-cyan-800">
              ${score}
            </span>
          </div>
          <p class="text-[11px] text-slate-400 line-clamp-2 mb-2 text-left font-light leading-relaxed">
            ${desc}
          </p>
          <div class="flex items-center justify-between mt-auto w-full">
            <span class="flex items-center gap-1.5 text-[10px] text-slate-500">
              <i class="fa-solid fa-location-dot"></i>
              <span class="line-clamp-1 max-w-[80px]">${company.city}</span>
            </span>
            <span class="text-[10px] font-bold text-emerald-400 flex items-center gap-1">
              <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
              ${getScoreLabel(score)}
            </span>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function rotateTopCompanies() {
      if (!topCompaniesOrder.length) return;
      const first = topCompaniesOrder.shift();
      topCompaniesOrder.push(first);
      renderTopCompanies();
    }

    function startTopAnimations() {
      const container = document.getElementById("top-companies");
      if (!container) return;

      const scrollSpeed = 30; // Kayma hÄ±zÄ± (dÃ¼ÅŸÃ¼k = hÄ±zlÄ±, yÃ¼ksek = yavaÅŸ)

      // --- Ä°Ã‡ FONKSÄ°YON: OYNAT ---
      function playAnimations() {
        // Ã–nce eski zamanlayÄ±cÄ±lar varsa temizle (Ã¼st Ã¼ste binmesin)
        if (topScrollInterval) clearInterval(topScrollInterval);
        if (topRotateInterval) clearInterval(topRotateInterval);

        // 1. KaydÄ±rma (Scroll) BaÅŸlat
        topScrollInterval = setInterval(() => {
          if (!container) return;
          container.scrollLeft += 1; 

          // Sona gelince baÅŸa sar
          if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 1) {
            container.scrollLeft = 0;
          }
        }, scrollSpeed);

        // 2. KartlarÄ± KarÄ±ÅŸtÄ±rma BaÅŸlat (Okurken deÄŸiÅŸmesin diye bunu da durduruyoruz)
        topRotateInterval = setInterval(() => {
          rotateTopCompanies();
        }, 10000);
      }

      // --- Ä°Ã‡ FONKSÄ°YON: DURDUR ---
      function pauseAnimations() {
        if (topScrollInterval) clearInterval(topScrollInterval);
        if (topRotateInterval) clearInterval(topRotateInterval);
      }

      // --- EVENT LISTENERLAR (Olay Dinleyicileri) ---
      // Mouse Ã¼zerine gelince DURDUR
      container.onmouseenter = () => {
        pauseAnimations();
        // KullanÄ±cÄ± durduÄŸunu anlasÄ±n diye cursor stilini deÄŸiÅŸtirebiliriz (opsiyonel)
        container.style.cursor = "paused"; 
      };

      // Mouse gidince DEVAM ET
      container.onmouseleave = () => {
        playAnimations();
        container.style.cursor = "default";
      };

      // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda baÅŸlat
      playAnimations();
    }

    // MAIN GRID

    function renderCards(searchQuery = "") {
      const container = document.getElementById("card-container");
      const resultCount = document.getElementById("result-count");
      if (!container) return;
      container.innerHTML = "";

      const query = (searchQuery || "").toLowerCase().trim();

      let filtered = getSearchableCompanies().filter((company) => {
      if (company.email === ADMIN_EMAIL || company.contact_email === ADMIN_EMAIL) {
        return false; 
      }
        if (currentSector !== "all" && company.sector !== currentSector) {
          return false;
        }

        if (!query) return true;

        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const services =
          currentLang === "tr" && company.services_tr
            ? company.services_tr
            : company.services;

        const haystack = [
          company.name,
          company.city,
          company.sector,
          desc,
          ...(services || []),
        ]
          .join(" ")
          .toLowerCase();

        return haystack.includes(query);
      });

      if (resultCount) {
        resultCount.textContent = `${filtered.length} ${t("results_label")}`;
      }

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.className =
          "col-span-full text-center text-sm text-gray-500";
        empty.textContent =
          currentLang === "tr"
            ? "Kriterlere uygun firma bulunamadÄ±."
            : "No companies match the selected filters.";
        container.appendChild(empty);
        return;
      }

      filtered.forEach((company) => {
        const score = computeScore(company.meta);
        const desc =
          currentLang === "tr" && company.desc_tr
            ? company.desc_tr
            : company.desc;

        const services =
          currentLang === "tr" && company.services_tr
            ? company.services_tr
            : company.services;

        const card = document.createElement("div");
        card.className =
          "bg-white/90 border border-gray-100 rounded-2xl p-5 shadow-glass flex flex-col justify-between hover:border-BTrustOn-accent hover:shadow-lg hover:-translate-y-1 transition cursor-pointer";
        card.onclick = () => openProfile(company.id);

        card.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-3">
            <div>
              <h3 class="text-sm font-bold text-BTrustOn-primary mb-0.5 line-clamp-1">
                ${company.name}
              </h3>
              <p class="text-[11px] text-gray-400 mb-1 line-clamp-1">
                ${company.city}
              </p>
            </div>
            <div class="text-right">
              <div class="text-xs font-header font-bold text-BTrustOn-primary leading-none">
                ${score}<span class="text-[10px] text-gray-400">/100</span>
              </div>
              <div class="text-[10px] text-emerald-500 font-semibold mt-0.5">
                ${getScoreLabel(score)}
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-600 mb-3 line-clamp-3">
            ${desc}
          </p>
          <div class="flex flex-wrap gap-1.5 mb-3">
            ${(services || [])
              .slice(0, 3)
              .map(
                (s) => `
              <span class="text-[10px] px-2 py-1 rounded-full bg-slate-50 border border-slate-200 text-slate-600">
                ${s}
              </span>
            `
              )
              .join("")}
          </div>
          <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-100">
            <div class="flex items-center gap-2">
              ${getTrustBadge(company)}
            </div>
            <button
              class="text-[11px] font-bold text-BTrustOn-accent flex items-center gap-1"
              type="button"
            >
              <span>${t("btn_view")}</span>
              <i class="fa-solid fa-arrow-right text-[10px]"></i>
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Hafif "canlÄ±lÄ±k": sadece default durumda (tÃ¼m sektÃ¶rler + boÅŸ arama) diziyi shuffle et
    function startGridShuffle() {
      const searchInput = document.getElementById("search-input");

      if (gridShuffleInterval) clearInterval(gridShuffleInterval);

      gridShuffleInterval = setInterval(() => {
        if (!searchInput) return;
        const query = (searchInput.value || "").trim();
        if (query !== "" || currentSector !== "all") {
          return; // kullanÄ±cÄ± filtre kullanÄ±yorsa karÄ±ÅŸmasÄ±n
        }

        // Rastgele hafif karÄ±ÅŸtÄ±r
        database.sort(() => Math.random() - 0.5);
        renderCards("");
      }, 15000); // 15 sn'de bir hafif deÄŸiÅŸim
    }

function filterSector(sector, btnEl) {
      currentSector = sector;

      // 1. ButonlarÄ±n renklerini sÄ±fÄ±rla/ayarla
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.classList.remove("border-BTrustOn-accent", "bg-BTrustOn-accent/10", "text-BTrustOn-accent", "shadow-glow");
        btn.classList.add("border-gray-300", "bg-transparent", "text-gray-500");
      });

      // TÄ±klanan butonu boya
      if (btnEl) {
        btnEl.classList.remove("border-gray-300", "bg-transparent", "text-gray-500");
        btnEl.classList.add("border-BTrustOn-accent", "bg-BTrustOn-accent/10", "text-BTrustOn-accent", "shadow-glow");
      }

      // 2. Arama ve Listeleme MantÄ±ÄŸÄ±
      const searchInput = document.getElementById("search-input");
      const value = searchInput ? searchInput.value : "";
      
      if (sector === "all" && value.trim() === "") {
          isSearchActive = false;
          renderShowcase();
      } else {
          isSearchActive = true;
          renderSearchResults(value);
      }

      // 3. ðŸ‘‡ AÅžAÄžI KAYDIRMA KODU (YENÄ° EKLENDÄ°) ðŸ‘‡
      // SonuÃ§larÄ±n olduÄŸu ana kÄ±sma yumuÅŸakÃ§a in
      const mainSection = document.querySelector("main");
      if(mainSection) {
          // Biraz gecikmeli yapÄ±yoruz ki Ã¶nce filtreleme iÅŸlemi bitsin, gÃ¶z yormasÄ±n
          setTimeout(() => {
              mainSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
      }
    }
    // Status badge renkleri (Available / Under Maintenance / Out of Service)
    function getStatusBadge(baseStatusRaw, displayStatus) {
      const base = (baseStatusRaw || "").toLowerCase();
      const disp = (displayStatus || baseStatusRaw || "").toLowerCase();

      let classes = "bg-slate-50 text-slate-600";

      // Available / MÃ¼sait â†’ YeÅŸil
      if (base.includes("available") || disp.includes("mÃ¼sait")) {
        classes = "bg-emerald-50 text-emerald-700";
      }
      // Under Maintenance / bakÄ±m â†’ SarÄ±
      else if (
        base.includes("maintenance") ||
        base.includes("maint") ||
        disp.includes("bakÄ±m")
      ) {
        classes = "bg-amber-50 text-amber-700";
      }
      // Out of Service / Servis dÄ±ÅŸÄ± â†’ KÄ±rmÄ±zÄ±
      else if (
        base.includes("out of service") ||
        base.includes("oos") ||
        disp.includes("servis dÄ±ÅŸÄ±")
      ) {
        classes = "bg-rose-50 text-rose-700";
      }

      const label = displayStatus || baseStatusRaw || "";

      return `
        <span class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-semibold ${classes}">
          ${label}
        </span>
      `;
    }

/* --- GÃœNCELLENMÄ°Åž: renderCertificates (RENKLÄ° BUTONLAR) --- */
function renderCertificates(company) {
  const certList = document.getElementById("p-certs-list");
  const btnAddCert = document.getElementById("btn-add-cert");
  const myId = localStorage.getItem("BTrustOn_my_company_id");
  const isOwner = (myId && String(company.id) === String(myId));

  if (btnAddCert) {
     if (isOwner) btnAddCert.classList.remove("hidden-view");
     else btnAddCert.classList.add("hidden-view");
  }

  if (!certList) return;
  certList.innerHTML = "";

  const certs = company.certificates || [];

  if (certs.length === 0) {
    certList.innerHTML = `<div class="col-span-2 py-8 text-center text-gray-400 text-xs italic bg-gray-50 rounded-xl border border-dashed border-gray-200">No certificates listed.</div>`;
    return;
  }

  certs.forEach((cert, index) => {
    let name = typeof cert === 'string' ? cert : cert.name;
    let issuer = typeof cert === 'object' ? cert.issuer : "";
    let date = typeof cert === 'object' ? cert.expiry_date : null;
    let fileUrl = typeof cert === 'object' ? cert.file_url : null;
    let id = typeof cert === 'object' ? cert.id : -1;

    // Durum Rozeti
    let statusBadge = "";
    if (date) {
        const expiry = new Date(date);
        const now = new Date();
        const isExpired = expiry < now;
        
        if (isExpired) {
            statusBadge = `<span class="ml-2 inline-flex items-center gap-1 bg-red-50 text-red-600 text-[9px] font-bold px-1.5 py-0.5 rounded border border-red-100 uppercase"><i class="fa-solid fa-circle-exclamation"></i> Expired</span>`;
        } else {
            statusBadge = `<span class="ml-2 inline-flex items-center gap-1 bg-emerald-50 text-emerald-600 text-[9px] font-bold px-1.5 py-0.5 rounded border border-emerald-100 uppercase"><i class="fa-solid fa-circle-check"></i> Valid</span>`;
        }
    }

    // Dosya Butonu
    let fileBtn = "";
    if (fileUrl) {
        fileBtn = `
            <a href="${fileUrl}" target="_blank" class="ml-auto flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-bold hover:bg-blue-600 hover:text-white transition" title="View Document">
                <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">View Doc</span>
            </a>
        `;
    }

    // --- YÃ–NETÄ°M BUTONLARI (RENKLENDÄ°RÄ°LDÄ°) ---
    let ownerActions = "";
    if(isOwner) {
        ownerActions = `
          <div class="flex gap-2 ml-2 pl-2 border-l border-gray-100">
            <button onclick="openCertModal(${id})" class="w-7 h-7 rounded-lg bg-cyan-50 text-BTrustOn-accent border border-cyan-100 hover:bg-BTrustOn-accent hover:text-white flex items-center justify-center transition shadow-sm" title="Edit">
                <i class="fa-solid fa-pen text-[10px]"></i>
            </button>
            
            <button onclick="deleteCert(${id}, '${name}')" class="w-7 h-7 rounded-lg bg-red-50 text-red-500 border border-red-100 hover:bg-red-500 hover:text-white flex items-center justify-center transition shadow-sm" title="Delete">
                <i class="fa-solid fa-trash text-[10px]"></i>
            </button>
          </div>
        `;
    }

    certList.innerHTML += `
      <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm flex items-center gap-3 hover:shadow-md transition group">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-50 to-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-slate-400">
           <i class="fa-solid fa-certificate text-lg"></i>
        </div>
        
        <div class="min-w-0 flex-1">
          <div class="flex items-center flex-wrap gap-1">
              <span class="font-bold text-gray-800 text-sm truncate">${name}</span>
              ${statusBadge}
          </div>
          <div class="text-[10px] text-gray-400 mt-0.5 flex items-center gap-2">
            <span>${issuer || 'Unknown Issuer'}</span>
            ${date ? `<span class="text-gray-300">â€¢</span> <span>Exp: ${date}</span>` : ''}
          </div>
        </div>

        ${fileBtn}
        ${ownerActions}
      </div>`;
  });
}

/* --- YENÄ°: PROFÄ°L ANALÄ°TÄ°ÄžÄ° SÄ°STEMÄ° (GÃœNDE 1 KEZ SAYMA) --- */

// 1. ZÄ°YARETÄ° KAYDET (SPAM KORUMALI)
async function trackProfileView(targetProfileId) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    
    // A. Kendi profilime bakÄ±yorsam HÄ°Ã‡BÄ°R ÅžEY YAPMA
    if (user && user.id === targetProfileId) return;

    // B. SPAM KONTROLÃœ (LOCAL STORAGE)
    // Anahtar: "view_PROFILID_TARIH" (Ã–rn: view_12345_2025-12-12)
    const today = new Date().toISOString().split('T')[0]; 
    const storageKey = `BTrustOn_view_${targetProfileId}_${today}`;

    // EÄŸer tarayÄ±cÄ±da "BugÃ¼n baktÄ±" iÅŸareti varsa dur (VeritabanÄ±na gitme)
    if (localStorage.getItem(storageKey)) {
        console.log("Bu profile bugÃ¼n zaten bakÄ±ldÄ±, sayaÃ§ artÄ±rÄ±lmadÄ±.");
        return;
    }

    // C. VeritabanÄ±na Kaydet
    const viewerId = user ? user.id : null; // Ãœye ise ID, deÄŸilse NULL (Misafir)
    
    const { error } = await supabaseClient.from('profile_views').insert([{
        profile_id: targetProfileId,
        viewer_id: viewerId
    }]);

    // D. BaÅŸarÄ±lÄ±ysa TarayÄ±cÄ±ya "BugÃ¼n BaktÄ±" Ä°ÅŸaretini Koy
    if (!error) {
        localStorage.setItem(storageKey, "true");
        console.log("Yeni ziyaret kaydedildi.");
    }
}

// 2. Ä°STATÄ°STÄ°KLERÄ° Ã‡EK VE GÃ–STER
async function loadProfileAnalytics(profileId) {
    // A. UI SÄ±fÄ±rla (YÃ¼kleniyor...)
    document.getElementById("stat-partner-count").textContent = "-";
    document.getElementById("stat-guest-count").textContent = "-";
    document.getElementById("stat-partner-list").innerHTML = '<div class="p-3 text-center"><i class="fa-solid fa-spinner fa-spin text-cyan-500"></i></div>';

    // B. Tarih HesabÄ± (Son 90 GÃ¼n)
    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

    // C. Verileri Ã‡ek
    const { data: views, error } = await supabaseClient
        .from('profile_views')
        .select('viewer_id, viewed_at')
        .eq('profile_id', profileId)
        .gte('viewed_at', ninetyDaysAgo.toISOString())
        .order('viewed_at', { ascending: false });

    if (error || !views) {
        console.error("Analytics Error:", error);
        document.getElementById("stat-partner-count").textContent = "0";
        document.getElementById("stat-guest-count").textContent = "0";
        document.getElementById("stat-partner-list").innerHTML = '<div class="p-3 text-center text-[10px] text-gray-400">No data.</div>';
        return;
    }

    // D. AyrÄ±ÅŸtÄ±r (Partner vs Guest)
    let guestCount = 0;
    let partnerMap = new Map(); // AynÄ± ÅŸirket birden fazla baktÄ±ysa son tarihini tut

    views.forEach(v => {
        if (v.viewer_id) {
            // Partner (Ãœye)
            if (!partnerMap.has(v.viewer_id)) {
                partnerMap.set(v.viewer_id, v.viewed_at);
            }
        } else {
            // Guest (Misafir)
            guestCount++;
        }
    });

    // E. SayÄ±larÄ± Animasyonla Bas
    animateValue("stat-partner-count", 0, partnerMap.size, 800);
    animateValue("stat-guest-count", 0, guestCount, 800);

    // F. Partner Listesini Doldur (Ä°simleri Ã‡ekmek Ä°Ã§in)
    const listContainer = document.getElementById("stat-partner-list");
    listContainer.innerHTML = "";

    if (partnerMap.size === 0) {
        listContainer.innerHTML = '<div class="p-4 text-center text-[10px] text-gray-400 italic">No registered views yet.</div>';
        return;
    }

    // ID'lere gÃ¶re profil bilgilerini Ã§ek
    const { data: profiles } = await supabaseClient
        .from('profiles')
        .select('id, company_name, logo_url, city')
        .in('id', Array.from(partnerMap.keys()));

    if (profiles) {
        profiles.forEach(p => {
            const viewTime = partnerMap.get(p.id);
            const dateStr = new Date(viewTime).toLocaleDateString();
            const logoLetter = p.company_name.charAt(0).toUpperCase();

            const item = document.createElement("div");
            item.className = "flex items-center gap-3 p-2 hover:bg-cyan-50 rounded-lg transition cursor-pointer border-b border-gray-50 last:border-0";
            item.onclick = () => openProfile(p.id); // TÄ±klayÄ±nca o ÅŸirkete git

            item.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center text-BTrustOn-accent font-bold text-xs shadow-sm shrink-0 overflow-hidden">
                    ${p.logo_url ? `<img src="${p.logo_url}" class="w-full h-full object-cover">` : logoLetter}
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-[11px] font-bold text-gray-700 truncate">${p.company_name}</div>
                    <div class="text-[9px] text-gray-400 flex justify-between">
                        <span class="truncate max-w-[80px]">${p.city || 'Unknown'}</span>
                        <span>${dateStr}</span>
                    </div>
                </div>
            `;
            listContainer.appendChild(item);
        });
    }
}

// YardÄ±mcÄ±: SayÄ± Animasyonu
function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    if (start === end) { obj.textContent = end; return; }
    
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

    /* --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž OPEN PROFILE (OTOMATÄ°K VERÄ° Ã‡EKME + EKRAN YÃ–NETÄ°MÄ°) --- */
/* --- GÃœNCELLENMÄ°Åž: openProfile (RENKLÄ° STATUS + ÅžIK BUTONLAR) --- */
async function openProfile(companyId) {

  // --- ROUTE + FAST UI SWITCH (prevents 1-2s dashboard flash on refresh) ---
  try { localStorage.setItem("BTrustOn_last_route", `company:${companyId}`); } catch(e) {}

  // Keep URL in sync (so refresh stays on the same company)
// - Restore (refresh) sÄ±rasÄ±nda replaceState (history ÅŸiÅŸmesin)
// - KullanÄ±cÄ± tÄ±klayÄ±nca pushState (browser Back ile listeye dÃ¶nebilsin)
try {
  const newHash = `#company=${encodeURIComponent(companyId)}`;
  if (window.location.hash !== newHash) {
    const st = { view: "profile", id: String(companyId), t: Date.now() };
    if (history && history.pushState && !window.__routeRestoring) history.pushState(st, "", newHash);
    else if (history && history.replaceState) history.replaceState(st, "", newHash);
    else window.location.hash = newHash;
  }
} catch(e) {}

  // Immediately switch to Profile view shell (even if data must load)
  const _vd = document.getElementById("view-dashboard");
  const _vp = document.getElementById("view-profile");
  const _ve = document.getElementById("view-editor");
  const _vm = document.getElementById("view-message");
  const _bb = document.getElementById("back-btn");

  if (_vd) _vd.classList.add("hidden-view");
  if (_ve) _ve.classList.add("hidden-view");
  if (_vm) _vm.classList.add("hidden-view");
  if (_vp) _vp.classList.remove("hidden-view");
  if (_bb) _bb.classList.remove("hidden", "hidden-view");

  // âœ… Always start profile at top (prevents "1 page down" offset)
  try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch(e) { try { window.scrollTo(0,0); } catch(_) {} }


  // âœ… Show skeleton while profile data loads
  try { showProfileSkeleton(); } catch(e) {}


  // 1. Ã–nce veritabanÄ±nda var mÄ±?
  let company = database.find((c) => c.id == companyId);

  // 2. Yoksa Supabase'den Ã§ek
  if (!company) {
      if (!(window.__routeRestoring === true)) {
        showToast("Loading...", "Fetching company profile...", "info");
      }
      try {
          const { data: profile, error } = await supabaseClient
              .from('profiles')
              .select('*')
              .eq('id', companyId)
              .single();

          if (error || !profile) {
              showToast("Error", "Profile not found or deleted.", "error");
              try { hideProfileSkeleton(); } catch(e) {}
              return;
          }

          company = {
              id: profile.id,
              name: profile.company_name || "Unknown",
              city: profile.city || "No Location",
              tagline: profile.tagline || "",
              sector: profile.sector || "construction",
              desc: profile.description || "",
              type_label: profile.company_type || "Industrial Supplier",
              size_label: profile.company_size || "Size N/A",
              year_label: profile.founded_year || "",
              services: profile.services ? profile.services.split(',') : [],
              logo_url: profile.logo_url || null,
              website: profile.website || "",
              phone: profile.phone || "",
              contact_email: profile.contact_email || "",
              trust: "verified",
              meta: { references: 50, delivery: 50, years: 1, financial: 50, digital: 50 },
              certificates: profile.certificates || [],
              assets: profile.assets || [],
              projects: profile.projects || []
          };
          database.push(company);
      } catch (err) {
          console.error(err);
          showToast("Error", "Connection failed.", "error");
          try { hideProfileSkeleton(); } catch(e) {}
          return;
      }
  }

  selectedCompany = company;

  // 3. EKRAN GEÃ‡Ä°ÅžLERÄ°
  const viewDashboard = document.getElementById("view-dashboard");
  const viewProfile = document.getElementById("view-profile");
  const viewEditor = document.getElementById("view-editor");
  const viewMessage = document.getElementById("view-message"); 
  const backBtn = document.getElementById("back-btn");

  if (viewDashboard) viewDashboard.classList.add("hidden-view");
  if (viewEditor) viewEditor.classList.add("hidden-view");
  if (viewMessage) viewMessage.classList.add("hidden-view"); 
  
  if (viewProfile) viewProfile.classList.remove("hidden-view");
  if (backBtn) backBtn.classList.remove("hidden", "hidden-view");
  
  window.scrollTo(0, 0);
  document.body.style.overflow = "auto"; 

  // 4. VERÄ°LERÄ° DOLDUR
  // Logo
  const pLogoImg = document.getElementById("p-logo-image");
  const pDefaultIcon = document.getElementById("p-default-icon");
  if (pLogoImg && pDefaultIcon) {
      if (company.logo_url) {
          pLogoImg.src = company.logo_url;
          pLogoImg.classList.remove("hidden");
          pDefaultIcon.classList.add("hidden");
      } else {
          pLogoImg.classList.add("hidden");
          pDefaultIcon.classList.remove("hidden");
      }
  }

  // Metinler
  const nameEl = document.getElementById("p-name");
  const descEl = document.getElementById("p-desc");
  const cityEl = document.getElementById("p-city");
  const sectorEl = document.getElementById("p-sector");
  const pType = document.getElementById("p-type-tag");
  const pSize = document.getElementById("p-size-tag");
  const pYear = document.getElementById("p-year-tag");

  // --- YENÄ° EKLENEN KISIM: Ä°SÄ°M + AKILLI ROZET SÄ°STEMÄ° ---
if (nameEl) {
    // 1. Ã–nce sadece ismi yaz
    nameEl.innerHTML = company.name;

    // 2. Kontrolleri Yap
    const ADMIN_MAIL = "rahmiunl@gmail.com"; // Senin mailin
    const isAdmin = (company.email === ADMIN_MAIL || company.contact_email === ADMIN_MAIL);
    const isVerified = String(company.verification_status || '').toLowerCase() === 'verified';

    // 3. Rozet SeÃ§imi
    if (isAdmin) {
        // --- ADMIN Ä°Ã‡Ä°N: ALTIN TAÃ‡ VE Ã–ZEL ETÄ°KET ---
        nameEl.innerHTML += `
            <span class="inline-flex items-center gap-1.5 ml-3 px-2 py-0.5 rounded bg-amber-100 border border-amber-200 align-middle">
                <i class="fa-solid fa-crown text-amber-600 text-sm animate-pulse"></i>
                <span class="text-[10px] font-bold text-amber-700 uppercase tracking-wide">BTrustOn Official</span>
            </span>
        `;
    } 
    else if (isVerified) {
            // ðŸ’Ž ONAYLI ÃœYE: LIQUID CRYSTAL MAVÄ° TÄ°K (EN HAVALISI)
            nameEl.innerHTML += `
                <span class="group relative inline-flex items-center justify-center ml-2 align-middle cursor-help select-none" title="Officially Verified Partner">
                    
                    <span class="absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-20 animate-ping duration-[3s]"></span>
                    
                    <span class="absolute inline-flex h-[80%] w-[80%] rounded-full bg-blue-500 blur-md opacity-40"></span>
                    
                    <span class="relative z-10 bg-white rounded-full w-5 h-5 flex items-center justify-center"></span>

                    <i class="fa-solid fa-circle-check text-2xl relative z-20 -ml-5" 
                       style="
                           background: linear-gradient(135deg, #1d4ed8 0%, #06b6d4 100%); /* Derin Mavi -> Parlak Cam GÃ¶beÄŸi */
                           -webkit-background-clip: text;
                           -webkit-text-fill-color: transparent;
                           filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3)); /* 3D GÃ¶lge */
                       ">
                    </i>
                </span>
            `;
        }
}
// --- BÄ°TÄ°Åž ---
// Location (City, Country)
if (cityEl) {
    const city = (company.city || "").trim();
    const country = (company.country || "").trim();
    let loc = "";

    if (city && country) {
        // Avoid duplicates like "Ankara, Turkey, Turkey"
        if (city.toLowerCase().includes(country.toLowerCase())) loc = city;
        else loc = `${city}, ${country}`;
    } else {
        loc = city || country || ((typeof currentLang !== 'undefined' && currentLang === 'tr') ? "Konum Yok" : "Location N/A");
    }

    cityEl.textContent = loc;
}

  
  // SektÃ¶r (Dil DesteÄŸi)
  if (sectorEl) {
      if (typeof currentLang !== 'undefined' && currentLang === 'tr') {
          const sectorMap = {
              "construction": "Ä°nÅŸaat ve AltyapÄ±",
              "mining": "Madencilik ve Metal",
              "energy": "Enerji ve Petrol/Gaz",
              "manufacturing": "Ãœretim ve Makine",
              "technology": "Teknoloji ve Otomasyon",
              "logistics": "Lojistik ve Ticaret",
              "engineering": "MÃ¼hendislik ve Hizmetler"
          };
          sectorEl.textContent = sectorMap[company.sector] || (company.sector.charAt(0).toUpperCase() + company.sector.slice(1));
      } else {
          sectorEl.textContent = company.sector.charAt(0).toUpperCase() + company.sector.slice(1);
      }
  }
  
  if (pType) pType.textContent = company.type_label || "Industrial Supplier";
  if (pSize) pSize.textContent = company.size_label || "Size N/A";
  if (pYear) pYear.textContent = company.year_label ? `Founded ${company.year_label}` : "";
  
  // AÃ§Ä±klama (Dil DesteÄŸi)
  if (descEl) {
      if (typeof currentLang !== 'undefined' && currentLang === 'tr' && company.desc_tr) {
          descEl.textContent = company.desc_tr;
      } else {
          descEl.textContent = company.desc;
      }
  }

  // Slogan
  const taglineContainer = document.getElementById("p-tagline-container");
  const taglineText = document.getElementById("p-tagline");
  if (taglineContainer && taglineText) {
      if (company.tagline && company.tagline.trim() !== "") {
          taglineText.textContent = `"${company.tagline}"`; 
          taglineContainer.classList.remove("hidden");
      } else {
          taglineContainer.classList.add("hidden");
      }
  }

  // Skor
  const score = computeScore(company.meta);
  const pScore = document.getElementById("p-score");
  const pScoreLabel = document.getElementById("p-score-label");
  const pScoreRing = document.getElementById("p-score-ring");

  if (pScore) pScore.textContent = score.toString();
  if (pScoreLabel) pScoreLabel.textContent = getScoreLabel(score);
  if (pScoreRing) {
      const circumference = 263.89;
      const offset = circumference - (score / 100) * circumference;
      setTimeout(() => { pScoreRing.style.strokeDashoffset = offset; }, 100);
  }

  // Ä°letiÅŸim
  const pWebsite = document.getElementById("p-website-link");
  const pEmail = document.getElementById("p-email-text");
  const pPhone = document.getElementById("p-phone-text");

  if (pWebsite) {
      if (company.website) {
          let href = company.website.startsWith("http") ? company.website : "https://" + company.website;
          pWebsite.href = href;
          pWebsite.textContent = company.website.replace(/^https?:\/\//, '').replace(/\/$/, '');
          pWebsite.classList.remove("text-gray-400", "italic", "pointer-events-none");
          pWebsite.classList.add("text-BTrustOn-accent", "hover:underline");
      } else {
          pWebsite.textContent = "-";
          pWebsite.removeAttribute("href");
          pWebsite.classList.add("text-gray-400", "italic", "pointer-events-none");
          pWebsite.classList.remove("text-BTrustOn-accent", "hover:underline");
      }
  }
  if (pEmail) {
      const displayEmail = company.contact_email || company.email || "-";
      pEmail.textContent = displayEmail;
      if(displayEmail !== "-") {
          pEmail.parentElement.onclick = () => window.location.href = "mailto:" + displayEmail;
          pEmail.parentElement.classList.remove("text-gray-400");
          pEmail.parentElement.classList.add("cursor-pointer", "hover:bg-gray-50", "text-gray-700");
      } else {
           pEmail.parentElement.onclick = null;
           pEmail.parentElement.classList.remove("cursor-pointer", "hover:bg-gray-50", "text-gray-700");
           pEmail.parentElement.classList.add("text-gray-400");
      }
  }
  if (pPhone) pPhone.textContent = company.phone || "-";
// âœ… YENÄ°: ADRES GÃ–STERÄ°MÄ°
  const pAddress = document.getElementById("p-address-text");
  if (pAddress) {
      if (company.address && company.address.trim() !== "") {
          pAddress.textContent = company.address;
          // Ä°konun olduÄŸu kapsayÄ±cÄ±yÄ± gÃ¶ster (gizliyse)
          pAddress.parentElement.classList.remove("hidden");
      } else {
          pAddress.textContent = "No official address listed.";
          // Ä°sterseniz boÅŸsa gizleyebilirsiniz:
          // pAddress.parentElement.classList.add("hidden");
      }
  }

  // Hizmetler
  /* --- GÃœNCELLENMÄ°Åž HÄ°ZMET GÃ–RÃœNÃœMÃœ (Modern Tags + AÃ§Ä±klama) --- */
const servicesGrid = document.getElementById("p-services-grid");
if (servicesGrid) {
  // Ã–nce iÃ§eriÄŸi temizle
  servicesGrid.innerHTML = "";
  
  // 1. Dil kontrolÃ¼ ve servis listesi
  let displayServices = company.services || [];
  if (typeof currentLang !== 'undefined' && currentLang === 'tr' && company.services_tr && company.services_tr.length > 0) {
      displayServices = company.services_tr;
  }

  // --- BÃ–LÃœM 1: ETÄ°KETLER (GRID YERÄ°NE FLEX WRAP) ---
  // Grid yapÄ±sÄ±nÄ± kaldÄ±rÄ±p 'flex-wrap' yapÄ±yoruz ki yan yana ÅŸÄ±k dursunlar
  servicesGrid.className = "flex flex-wrap gap-3 mb-6"; 

  if (displayServices.length === 0) {
    servicesGrid.innerHTML = '<div class="w-full py-4 text-center border border-dashed border-gray-200 rounded-xl bg-gray-50"><p class="text-sm text-gray-400 italic">No services listed.</p></div>';
  } else {
    displayServices.forEach((s) => {
      // TasarÄ±m: Mavi/Cam GÃ¶beÄŸi tonlarÄ±nda, hap ÅŸeklinde (Pill), Check ikonlu
      servicesGrid.innerHTML += `
        <div class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-br from-white to-cyan-50 border border-cyan-100 rounded-lg shadow-sm hover:shadow-md hover:border-cyan-300 transition-all cursor-default group">
          <div class="w-5 h-5 rounded-full bg-cyan-100 text-cyan-600 flex items-center justify-center shrink-0 group-hover:bg-BTrustOn-accent group-hover:text-white transition-colors">
             <i class="fa-solid fa-check text-[10px]"></i>
          </div>
          <span class="text-xs font-bold text-gray-700 group-hover:text-cyan-800 transition-colors">${s}</span>
        </div>`;
    });
  }

  // --- BÃ–LÃœM 2: DETAY AÃ‡IKLAMASI (DÃœZELTÄ°LMÄ°Åž) ---
  if (company.service_details && company.service_details.trim() !== "") {
      const detailsDiv = document.createElement("div");
      // w-full: GeniÅŸliÄŸi doldur
      // max-w-full: TaÅŸmayÄ± engelle
      detailsDiv.className = "w-full max-w-full mt-2 animate-fade-in";
      
      // NOT: .replace(/\n/g, '<br>') kodunu kaldÄ±rdÄ±k. 
      // AÅŸaÄŸÄ±daki 'whitespace-pre-wrap' sÄ±nÄ±fÄ± bunu otomatik yapar.

      detailsDiv.innerHTML = `
        <div class="relative bg-slate-50 rounded-2xl p-6 border border-slate-100 overflow-hidden">
           <i class="fa-solid fa-quote-left absolute top-4 left-4 text-slate-200 text-2xl"></i>
           
           <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 pl-6">Technical Capability Statement</h4>
           
           <div class="text-sm text-gray-600 leading-relaxed pl-6 font-light break-words whitespace-pre-wrap font-sans">
              ${company.service_details}
           </div>
        </div>
      `;
      servicesGrid.appendChild(detailsDiv);
  }
}

// --- BÃ–LÃœM 3: OWNER / YETKÄ°LÄ° KARTI (SIDEBAR Ä°Ã‡Ä°N YENÄ° VERSÄ°YON) ---
  
  // 1. Yeni hedef kutuyu bul (sidebar'daki)
  const sidebarOwnerContainer = document.getElementById("sidebar-owner-view");

  // 2. EÄŸer eski kutu kaldÄ±ysa onu temizle (Ã‡akÄ±ÅŸma olmasÄ±n)
  const oldOwnerContainer = document.getElementById("p-owner-view");
  if (oldOwnerContainer) oldOwnerContainer.innerHTML = "";

  if (sidebarOwnerContainer) {
      sidebarOwnerContainer.innerHTML = ""; // Temizle
      
      // Veri kontrolÃ¼: Ä°sim veya Rol varsa gÃ¶ster
      if (company.owner_name || company.owner_role) {
          
          const photoSrc = company.owner_photo_url 
            ? `<img src="${company.owner_photo_url}" class="w-full h-full object-cover hover:scale-110 transition duration-500">`
            : `<div class="w-full h-full bg-slate-100 flex items-center justify-center text-slate-300"><i class="fa-solid fa-user text-lg"></i></div>`;
          
          const linkedinBtn = company.owner_linkedin 
            ? `<a href="${company.owner_linkedin}" target="_blank" class="flex items-center justify-center gap-2 w-full py-2.5 mt-4 rounded-xl bg-[#0077b5]/10 text-[#0077b5] text-xs font-bold hover:bg-[#0077b5] hover:text-white transition-all group/btn">
                 <i class="fa-brands fa-linkedin text-sm"></i> <span>Connect on LinkedIn</span>
               </a>`
            : ``;

          sidebarOwnerContainer.innerHTML = `
              <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm relative overflow-hidden group hover:shadow-md transition-all duration-300">
                  <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-BTrustOn-accent/10 to-transparent rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110"></div>

                  <div class="relative z-10">
                      <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                          <i class="fa-solid fa-certificate text-BTrustOn-accent"></i> Key Contact
                      </h4>

                      <div class="flex items-center gap-4">
                          <div class="w-14 h-14 rounded-full border-[3px] border-white shadow-md overflow-hidden shrink-0 bg-gray-50">
                              ${photoSrc}
                          </div>
                          <div class="min-w-0 flex-1">
                              <h5 class="text-sm font-bold text-gray-800 truncate leading-tight mb-0.5">
                                  ${company.owner_name || 'Company Rep.'}
                              </h5>
                              <p class="text-[11px] text-gray-500 font-medium truncate">
                                  ${company.owner_role || 'Authorized Person'}
                              </p>
                          </div>
                      </div>
                      ${linkedinBtn}
                  </div>
              </div>
          `;
          
          sidebarOwnerContainer.classList.remove("hidden");
      } else {
          sidebarOwnerContainer.classList.add("hidden");
      }
  }

  // Yetki KontrolÃ¼
  const myCurrentId = localStorage.getItem("BTrustOn_my_company_id");
  const isMyProfile = (myCurrentId && String(company.id) === String(myCurrentId));
  
  const btnEdit = document.getElementById("btn-edit-profile");
  const btnAddAsset = document.getElementById("btn-add-asset");
  const btnQuote = document.getElementById("btn-req-quote");
  const btnAddProject = document.getElementById("btn-add-project");
  const btnAddCert = document.getElementById("btn-add-cert");
  const logoContainer = document.getElementById("p-logo-container");
  const logoOverlay = document.getElementById("p-logo-overlay");

  if (isMyProfile) {
      if(btnEdit) btnEdit.classList.remove("hidden-view");
      if(btnAddAsset) btnAddAsset.classList.remove("hidden-view");
      if(btnAddProject) btnAddProject.classList.remove("hidden-view");
      if(btnAddCert) btnAddCert.classList.remove("hidden-view");
      if(btnQuote) btnQuote.classList.add("hidden-view");

      if (logoContainer) {
          logoContainer.classList.add("cursor-pointer", "group"); 
          logoContainer.setAttribute("onclick", "triggerProfileLogoUpload()");
      }
      if (logoOverlay) {
          logoOverlay.classList.remove("hidden");
          logoOverlay.className = "absolute inset-0 bg-slate-900/30 backdrop-blur-sm flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-500 z-20"; 
      }
  } else {
      if(btnEdit) btnEdit.classList.add("hidden-view");
      if(btnAddAsset) btnAddAsset.classList.add("hidden-view");
      if(btnAddProject) btnAddProject.classList.add("hidden-view");
      if(btnAddCert) btnAddCert.classList.add("hidden-view");
      if(btnQuote) btnQuote.classList.remove("hidden-view");

      if (logoContainer) {
          logoContainer.classList.remove("cursor-pointer", "group");
          logoContainer.removeAttribute("onclick");
      }
      if (logoOverlay) {
          logoOverlay.classList.add("hidden");
      }
  }

  switchProfileTab("overview");
  
  // --- PROJELER (TIKLANABÄ°LÄ°R KART + GÄ°ZLÄ° BUTONLAR) ---
  const projList = document.getElementById("p-projects-list");
  window.__projectsCache = (company.projects || []);
  if (projList) {
      projList.innerHTML = "";
      
      if (!company.projects || company.projects.length === 0) {
          projList.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-12 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-300 mb-3">
                    <i class="fa-solid fa-diagram-project text-2xl"></i>
                </div>
                <p class="text-sm text-gray-500 font-medium">No projects listed yet.</p>
            </div>`;
      } else {
          company.projects.forEach(p => {
              const hasGallery = p.gallery_urls && p.gallery_urls.length > 0;
              const cover = p.cover_url || "https://placehold.co/800x450/f1f5f9/94a3b8?text=Project+Image";
              // Kart artÄ±k her zaman "Detay" aÃ§ar. Galeri varsa detay iÃ§inden aÃ§Ä±lÄ±r.
              let cardClickAction = `onclick="openProjectViewer(${p.id})"`;
              let cursorClass = "cursor-pointer";
              let galleryBadge = "";

              if (hasGallery) {
                  // Sol Ã¼stte kÃ¼Ã§Ã¼k "foto sayÄ±sÄ±" etiketi
                  galleryBadge = `
                    <div class="absolute top-3 left-3 bg-black/45 text-white text-[11px] px-2 py-1 rounded-lg flex items-center gap-1.5 z-10 border border-white/10 shadow-sm">
                         <i class="fa-solid fa-camera"></i> ${p.gallery_urls.length}
                    </div>
                  `;
              }

              const actionBtns = isMyProfile ? `
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20">
                    <button onclick="event.stopPropagation(); openProjectModal(${p.id})" class="w-8 h-8 rounded-full bg-white/90 backdrop-blur-sm text-slate-600 hover:text-BTrustOn-accent hover:bg-white shadow-lg flex items-center justify-center transition transform hover:scale-105" title="Edit Project">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteProject(${p.id})" class="w-8 h-8 rounded-full bg-white/90 backdrop-blur-sm text-slate-600 hover:text-red-500 hover:bg-white shadow-lg flex items-center justify-center transition transform hover:scale-105" title="Delete Project">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
              ` : "";

              const card = document.createElement("div");
              card.className = "bg-white border border-gray-100 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group relative flex flex-col h-full";
              
              const hay = `${p.title || ""} ${p.loc || ""} ${p.desc || ""}`.trim();
              card.dataset.hay = hay;
              card.dataset.pid = String(p.id || "");
              card.dataset.title = p.title || "";
              card.dataset.created = String(p.id || "");

              card.innerHTML = `
                <div class="relative h-48 overflow-hidden bg-gray-100 shrink-0 ${cursorClass} group/img" ${cardClickAction}>
                    <img src="${cover}" class="w-full h-full object-cover group-hover/img:scale-105 transition-transform duration-700">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/20 to-transparent opacity-90"></div>
                    
                    ${galleryBadge}
                    
                    <div class="absolute bottom-0 left-0 p-4 w-full text-white z-10">
                        <h4 class="font-bold text-lg leading-tight mb-1 shadow-sm truncate pr-2">${p.title}</h4>
                        <div class="flex items-center gap-1.5 text-xs text-slate-300 font-medium">
                            <i class="fa-solid fa-location-dot text-BTrustOn-accent"></i>
                            <span class="truncate">${p.loc || 'Unknown Location'}</span>
                        </div>
                    </div>
                    
                    ${actionBtns}
                </div>

                <div class="p-5 flex flex-col flex-1">
                    <p class="text-sm text-gray-600 leading-relaxed line-clamp-4">
                        ${p.desc || 'No description provided.'}
                    </p>
                </div>
              `;
              projList.appendChild(card);
          });
      }
  }

  
  // Sertifikalar
  renderCertificates(company);

  // --- VARLIKLAR (DOSYA Ä°KONLU) ---
  const assetList = document.getElementById("p-assets-list");
  if (assetList) {
      assetList.innerHTML = "";
      if (!company.assets || company.assets.length === 0) {
          assetList.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-xs text-gray-400 italic">No assets listed.</td></tr>`;
      } else {
          company.assets.forEach(a => {
             const btns = isMyProfile ? `
                <div class="flex gap-2 justify-end">
                    <button onclick="openAssetModal(${a.id})" class="w-7 h-7 rounded-lg bg-cyan-50 text-BTrustOn-accent hover:bg-BTrustOn-accent hover:text-white flex items-center justify-center transition shadow-sm" title="Edit">
                        <i class="fa-solid fa-pen text-[10px]"></i>
                    </button>
                    <button onclick="deleteAsset(${a.id})" class="w-7 h-7 rounded-lg bg-red-50 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition shadow-sm" title="Delete">
                        <i class="fa-solid fa-trash text-[10px]"></i>
                    </button>
                </div>
             ` : "";
             
             // --- DOSYA Ä°KONU MANTIÄžI ---
             let fileIcon = "";
             if (a.file_url) {
                 // Ä°kon seÃ§imi (PDF mi Resim mi?)
                 let iconClass = "fa-file-lines";
                 if(a.file_name && a.file_name.match(/\.(jpg|jpeg|png)$/i)) iconClass = "fa-image";
                 if(a.file_name && a.file_name.match(/\.(pdf)$/i)) iconClass = "fa-file-pdf";
                 
                 fileIcon = `
                    <a href="${a.file_url}" target="_blank" class="ml-2 inline-flex items-center justify-center w-5 h-5 rounded bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition" title="View Document: ${a.file_name || 'File'}">
                        <i class="fa-solid ${iconClass} text-[10px]"></i>
                    </a>
                 `;
             }

             const row = document.createElement("tr");
             row.innerHTML = `
                <td class="py-3 px-6 text-xs font-bold text-gray-700">
                    <div class="flex items-center">
                        ${a.type} ${fileIcon}
                    </div>
                </td>
                <td class="px-6 text-xs text-gray-500">${a.spec}</td>
                <td class="px-6 text-xs text-gray-500 text-center">${a.qty}</td>
                <td class="px-6 text-xs text-gray-500">${a.location || '-'}</td>
                <td class="px-6">${getStatusBadge(a.status)}</td> 
                <td class="px-6 text-right">${btns}</td>
             `;
             assetList.appendChild(row);
          });
      }
  }
// ðŸ‘‡ GÃœNCELLENMÄ°Åž ANALÄ°TÄ°K YÃ–NETÄ°MÄ° (GÄ°ZLÄ°LÄ°K AYARLI) ðŸ‘‡
  
  // 1. Ziyaret SayacÄ±: Herkes iÃ§in Ã§alÄ±ÅŸÄ±r (Arka planda kaydeder)
  trackProfileView(company.id);

  // 2. Analitik KartÄ± GÃ¶sterimi: SADECE SAHÄ°BÄ°NE
  const analyticsCard = document.getElementById("profile-analytics-card");
  
  if (analyticsCard) {
      if (isMyProfile) {
          // A. Benim profilimse kartÄ± gÃ¶ster (Hidden sÄ±nÄ±fÄ±nÄ± kaldÄ±r)
          analyticsCard.classList.remove("hidden");
          
          // B. Verileri veritabanÄ±ndan Ã§ek ve doldur
          loadProfileAnalytics(company.id);
      } else {
          // A. BaÅŸkasÄ±nÄ±n profiliyse kartÄ± gizle
          analyticsCard.classList.add("hidden");
          
          // B. Veri Ã§ekme iÅŸlemini yapma (Gereksiz yÃ¼k olmasÄ±n)
      }
  }
// ðŸ‘‡ YENÄ°: PROFÄ°L WIDGET YÃ–NETÄ°MÄ° (Buraya Ekleyin) ðŸ‘‡
  const profileWidget = document.getElementById("profile-verify-widget");
  const widgetTax = document.getElementById("widget-tax-id");
  const widgetDuns = document.getElementById("widget-duns");

  if (profileWidget) {
      if (isMyProfile) {
          // 1. Profil sahibi ise Widget'Ä± gÃ¶ster
          profileWidget.classList.remove("hidden");
          
          // 2. KutularÄ± veritabanÄ± verisiyle doldur
          if(widgetTax) widgetTax.value = company.tax_id || "";
          if(widgetDuns) widgetDuns.value = company.duns_number || "";
          
          // 3. Durumu (Kilitli/AÃ§Ä±k/SarÄ±/YeÅŸil) gÃ¼ncelle
          updateVerificationUI(company.verification_status);
      } else {
          // BaÅŸkasÄ± bakÄ±yorsa Widget'Ä± gizle
          profileWidget.classList.add("hidden");
      }
  }
    
  // âœ… Hide skeleton once profile UI is ready
  try { hideProfileSkeleton(); } catch(e) {}
}

   // âœ… YENÄ° KAYDETME FONKSÄ°YONU (Supabase Uyumlu)
// âœ… 1. GÃœNCELLENMÄ°Åž KAYDETME FONKSÄ°YONU
/* --- %100 GARANTÄ°LÄ° KAYDETME FONKSÄ°YONU (SÄ°LME SORUNU Ã‡Ã–ZÃœLDÃœ) --- */
async function saveProfileData() {
  const btn = document.querySelector("#editor-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Uploading...";
  btn.disabled = true;

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("No active session found!");

    // --- 1. ÅžÄ°RKET LOGOSU ---
    let finalLogoUrl = selectedCompany.logo_url || null;
    if (typeof selectedLogoFile !== 'undefined' && selectedLogoFile) {
        const fileExt = selectedLogoFile.name.split('.').pop();
        const filePath = `${user.id}-${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabaseClient.storage.from('logos').upload(filePath, selectedLogoFile);
        if (uploadError) throw uploadError;
        const { data } = supabaseClient.storage.from('logos').getPublicUrl(filePath);
        finalLogoUrl = data.publicUrl;
    } else {
        if (document.getElementById("edit-logo-img").classList.contains("hidden")) {
            finalLogoUrl = null;
        }
    }

    // --- 2. DÄ°ÄžER STANDART VERÄ°LER ---
    const name = document.getElementById("edit-name").value.trim();
    const city = document.getElementById("edit-city").value.trim();
    const country = document.getElementById("edit-country").value;
    const address = document.getElementById("edit-address").value.trim();
    const sector = document.getElementById("edit-sector").value;
    const desc = document.getElementById("edit-desc").value.trim();
    const servicesStr = document.getElementById("edit-services").value.trim();
    const serviceDetails = document.getElementById("edit-service-details").value.trim();
    const website = document.getElementById("edit-website").value.trim();
    const phone = document.getElementById("edit-phone").value.trim();
    const contactEmail = document.getElementById("edit-email").value.trim();
    const typeVal = document.getElementById("edit-type").value;
    const sizeVal = document.getElementById("edit-size").value;
    const yearVal = document.getElementById("edit-year").value;
    const tagline = document.getElementById("edit-tagline").value.trim();

    // --- 3. OWNER VERÄ°LERÄ° (KRÄ°TÄ°K DÃœZELTME BURADA) ---
    // Toggle (Anahtar) aÃ§Ä±k mÄ±?
    const isOwnerActive = document.getElementById("edit-owner-toggle").checked;

    // DeÄŸiÅŸkenleri varsayÄ±lan olarak NULL (BOÅž) yapÄ±yoruz
    let ownerName = null;
    let ownerRole = null;
    let ownerLink = null;
    let finalOwnerPhotoUrl = null;

    // SADECE Anahtar AÃ‡IKSA verileri dolduruyoruz
    if (isOwnerActive) {
        ownerName = document.getElementById("edit-owner-name").value.trim();
        ownerRole = document.getElementById("edit-owner-role").value.trim();
        ownerLink = document.getElementById("edit-owner-linkedin").value.trim();
        
        // FotoÄŸraf MantÄ±ÄŸÄ±
        finalOwnerPhotoUrl = selectedCompany.owner_photo_url || null;
        
        if (typeof selectedOwnerFile !== 'undefined' && selectedOwnerFile) {
            const fileExt = selectedOwnerFile.name.split('.').pop();
            const filePath = `owner-${user.id}-${Date.now()}.${fileExt}`;
            const { error: upErr } = await supabaseClient.storage.from('logos').upload(filePath, selectedOwnerFile);
            if (!upErr) {
                const { data } = supabaseClient.storage.from('logos').getPublicUrl(filePath);
                finalOwnerPhotoUrl = data.publicUrl;
            }
        }
        
        const isOwnerImgVisible = !document.getElementById("preview-owner-img").classList.contains("hidden");
        if (!isOwnerImgVisible && (typeof selectedOwnerFile === 'undefined' || !selectedOwnerFile)) {
            finalOwnerPhotoUrl = null;
        }
    } 
    // EÄžER KAPALIYSA HÄ°Ã‡BÄ°R ÅžEY YAPMIYORUZ, YUKARIDA ZATEN NULL TANIMLADIK.
    // BÃ¶ylece input iÃ§inde yazÄ± kalsa bile biz onu 'null' olarak kaydediyoruz.

    // --- 4. GÃœNCELLEME PAKETÄ° ---
    const updates = {
      company_name: name,
      city: city,
      country: country,
      address: address,
      tagline: tagline,
      sector: sector,
      description: desc,
      services: servicesStr,
      service_details: serviceDetails,
      website: website,
      phone: phone,
      contact_email: contactEmail,
      company_type: typeVal,
      company_size: sizeVal,
      founded_year: yearVal,
      logo_url: finalLogoUrl,
      
      // Owner verileri (Ya dolu gelir ya da NULL gelir)
      owner_name: ownerName,
      owner_role: ownerRole,
      owner_linkedin: ownerLink,
      owner_photo_url: finalOwnerPhotoUrl,

      updated_at: new Date(),
    };

    // --- 5. DB GÃ–NDER ---
    const { error } = await supabaseClient
      .from('profiles')
      .update(updates)
      .eq('id', user.id);

    if (error) throw error;

    showToast("Success", "Profile updated successfully!", "success");

    // --- 6. LOCAL HAFIZAYI GÃœNCELLE ---
    const localCompany = database.find(c => c.id == user.id);
    if (localCompany) {
        Object.assign(localCompany, {
            name, city, sector, desc, tagline,
            website, phone, contact_email: contactEmail,
            address, type_label: typeVal, size_label: sizeVal, year_label: yearVal,
            logo_url: finalLogoUrl,
            services: servicesStr.split(',').map(s => s.trim()).filter(s => s),
            service_details: serviceDetails,
            
            // BURASI Ã‡OK Ã–NEMLÄ°: Hesaplanan (veya null olan) deÄŸerleri basÄ±yoruz
            owner_name: ownerName,
            owner_role: ownerRole,
            owner_linkedin: ownerLink,
            owner_photo_url: finalOwnerPhotoUrl
        });
    }

    openProfile(user.id);
    
    document.getElementById("view-editor").classList.add("hidden-view");
    document.getElementById("view-profile").classList.remove("hidden-view");
    document.getElementById("back-btn").classList.remove("hidden", "hidden-view");

  } catch (error) {
    console.error("Error:", error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

    
function showProfileSkeleton() {
  const el = document.getElementById("profile-skeleton");
  if (!el) return;
  el.classList.remove("hidden");
  // toast yerine skeleton kullan
  window.__suppressProfileLoadingToasts = true;
}
function hideProfileSkeleton() {
  const el = document.getElementById("profile-skeleton");
  if (!el) return;
  el.classList.add("hidden");
  window.__suppressProfileLoadingToasts = false;
}

function showMainView() {

      // Ensure profile loader is off on Home
      try { hideProfileSkeleton(); } catch(e) {}
      // Remember last view (prevents "random" landing on refresh)
      try { localStorage.setItem("BTrustOn_last_route", "home"); } catch(e) {}

      // Clear any company route from the URL (clean + professional)
// - KullanÄ±cÄ± UI ile listeye dÃ¶nÃ¼yorsa pushState (browser Back/Forward tutarlÄ±)
// - Restore sÄ±rasÄ±nda replaceState
try {
  const base = window.location.pathname + window.location.search;
  const hadHash = !!window.location.hash;
  const st = { view: "home", t: Date.now() };
  if (history && history.pushState && hadHash && !window.__routeRestoring) {
    history.pushState(st, "", base);
  } else if (history && history.replaceState) {
    history.replaceState(st, "", base);
  } else {
    window.location.hash = "";
  }
} catch(e) {}

      const viewDashboard = document.getElementById("view-dashboard");
      const viewProfile = document.getElementById("view-profile");
      const viewEditor = document.getElementById("view-editor");
      const backBtn = document.getElementById("back-btn");

      if (viewDashboard) viewDashboard.classList.remove("hidden-view");
      if (viewProfile) viewProfile.classList.add("hidden-view");
      if (viewEditor) viewEditor.classList.add("hidden-view");
      if (backBtn) backBtn.classList.add("hidden", "hidden-view");

      // âœ… Always start Home at top
      try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch(e) { try { window.scrollTo(0,0); } catch(_) {} }

    }
/* --- EKSÄ°K OLAN FONKSÄ°YON: EditÃ¶r EkranÄ±nÄ± GÃ¶ster --- */
function showEditorView() {
  const viewDashboard = document.getElementById("view-dashboard");
  const viewProfile = document.getElementById("view-profile");
  const viewEditor = document.getElementById("view-editor");
  const viewMessage = document.getElementById("view-message"); 
  const backBtn = document.getElementById("back-btn");

  // 1. DiÄŸer tÃ¼m ekranlarÄ± gizle
  if (viewDashboard) viewDashboard.classList.add("hidden-view");
  if (viewProfile) viewProfile.classList.add("hidden-view");
  if (viewMessage) viewMessage.classList.add("hidden-view");
  
  // 2. EditÃ¶r ekranÄ±nÄ± aÃ§
  if (viewEditor) viewEditor.classList.remove("hidden-view");
  
  // 3. Back butonunu gizle (EditÃ¶rde kendi Cancel butonu var)
  if (backBtn) backBtn.classList.add("hidden", "hidden-view"); 

  // 4. SayfayÄ± en Ã¼ste kaydÄ±r
  window.scrollTo(0, 0);
}
    function toggleModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.toggle("opacity-0");
      modal.classList.toggle("pointer-events-none");
      document.body.classList.toggle("modal-active");
    }

    function openQuoteModal(companyName) {
      const targetEl = document.getElementById("quote-target-company");
      const inputTarget = document.getElementById("input-target-company");
      if (targetEl) targetEl.textContent = companyName || "";
      if (inputTarget) inputTarget.value = companyName || "";
      toggleModal("modal-quote");
    }

    function switchProfileTab(tab) {
      const tabs = ["overview", "projects", "certs", "assets"];
      tabs.forEach((tName) => {
        const btn = document.getElementById(`tab-${tName}`);
        const content = document.getElementById(`content-${tName}`);
        if (!btn || !content) return;

        if (tName === tab) {
          btn.classList.add(
            "border-BTrustOn-accent",
            "text-BTrustOn-primary",
            "bg-cyan-50/50"
          );
          btn.classList.remove("border-transparent");
          content.classList.remove("hidden-view");
        } else {
          btn.classList.remove(
            "border-BTrustOn-accent",
            "text-BTrustOn-primary",
            "bg-cyan-50/50"
          );
          btn.classList.add("border-transparent");
          content.classList.add("hidden-view");
        }
      });
    }

    function switchLanguage(lang) {
      currentLang = lang === "tr" ? "tr" : "en";

      const btnEn = document.getElementById("lang-en");
      const btnTr = document.getElementById("lang-tr");

      if (btnEn && btnTr) {
        if (currentLang === "en") {
          btnEn.classList.add("bg-white", "text-BTrustOn-primary", "shadow-sm");
          btnEn.classList.remove("text-gray-500");
          btnTr.classList.remove(
            "bg-white",
            "text-BTrustOn-primary",
            "shadow-sm"
          );
          btnTr.classList.add("text-gray-500");
        } else {
          btnTr.classList.add("bg-white", "text-BTrustOn-primary", "shadow-sm");
          btnTr.classList.remove("text-gray-500");
          btnEn.classList.remove(
            "bg-white",
            "text-BTrustOn-primary",
            "shadow-sm"
          );
          btnEn.classList.add("text-gray-500");
        }
      }

      applyTranslations();
      renderTopCompanies();
      const searchInput = document.getElementById("search-input");
      const value = searchInput ? searchInput.value : "";
      renderCards(value);

        // Åžu an profil ekranÄ±nda mÄ±yÄ±z, kontrol et
  const viewProfile = document.getElementById("view-profile");
  const isProfileVisible =
    viewProfile && !viewProfile.classList.contains("hidden-view");

  // Sadece profil ekranÄ±ndaysak ilgili ÅŸirket profilini yeniden Ã§iz
  if (isProfileVisible && selectedCompany) {
    openProfile(selectedCompany.id);
  }

    }
      
    document.addEventListener("DOMContentLoaded", () => {
      applyTranslations();
      initTopCompaniesOrder();
      renderTopCompanies();
      

      startTopAnimations();
      

      switchLanguage("en");
      // initRealData(); // disabled to prevent double-loading

      initShowcaseSystem();
    });
/* --- GELÄ°ÅžMÄ°Åž ASSET YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingAssetId = null;

// 1. MODALI AÃ‡ (Ekleme veya DÃ¼zenleme)
// MODALI AÃ‡ (Ekleme veya DÃ¼zenleme)
/* --- GÃœNCELLENMÄ°Åž: openAssetModal (DOSYA YÃ–NETÄ°MLÄ°) --- */
function openAssetModal(assetId = null) {
  // Pro Plan KontrolÃ¼ (Sadece YENÄ° eklerken sÄ±nÄ±r kontrolÃ¼ yapar, dÃ¼zenlerken deÄŸil)
  if (!assetId) { 
      if (!checkPlanLimit('assets')) return; 
  }

  const modal = document.getElementById("asset-modal");
  const form = document.getElementById("asset-form");
  const title = document.getElementById("asset-modal-title");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  
  if(form) form.reset();
  removeAssetFile(); // Dosya seÃ§imlerini sÄ±fÄ±rla

  // --- PRO KULLANICI KONTROLÃœ ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const fileLabel = document.getElementById("asset-file-label");
  const fileLock = document.getElementById("asset-file-lock");
  const proBadge = document.getElementById("asset-file-pro-badge");
  const fileInput = document.getElementById("asset-file-input");

  if (isPro) {
      // Pro ise kilidi aÃ§
      if(fileLabel) { fileLabel.classList.remove("opacity-60"); fileLabel.onclick = null; }
      if(fileLock) fileLock.classList.add("hidden");
      if(proBadge) proBadge.classList.add("hidden");
      if(fileInput) fileInput.disabled = false;
  } else {
      // Free ise kilitle ve Upgrade'e yÃ¶nlendir
      if(fileLabel) { 
          fileLabel.classList.add("opacity-60"); 
          // TÄ±klayÄ±nca Upgrade aÃ§sÄ±n
          fileLabel.onclick = (e) => { e.preventDefault(); toggleModal('modal-upgrade'); };
      }
      if(fileLock) fileLock.classList.remove("hidden");
      if(proBadge) proBadge.classList.remove("hidden");
      if(fileInput) fileInput.disabled = true;
  }

  // --- DÃœZENLEME MANTIÄžI ---
  if (assetId) {
    currentEditingAssetId = assetId;
    if(title) title.textContent = "Edit Asset Details";
    
    const asset = selectedCompany.assets.find(a => a.id === assetId);
    if (asset) {
        document.getElementById("asset-item").value = asset.type || "";
        document.getElementById("asset-specs").value = asset.spec || "";
        document.getElementById("asset-qty").value = asset.qty || "1";
        document.getElementById("asset-location").value = asset.location || "";
        document.getElementById("asset-status").value = asset.status || "Available";

        // Varsa DosyayÄ± GÃ¶ster
        if (asset.file_url) {
            existingAssetFileUrl = asset.file_url;
            existingAssetFileName = asset.file_name || "Attached Document";
            
            document.getElementById("current-asset-link").href = asset.file_url;
            document.getElementById("current-asset-link").querySelector("span").textContent = existingAssetFileName;
            document.getElementById("current-asset-link").classList.remove("hidden");
            
            // Silme butonunu aÃ§
            document.getElementById("btn-remove-asset-file").classList.remove("hidden");
            
            // Texti gÃ¼ncelle
            document.getElementById("asset-file-text").textContent = "Change File";
        }
    }
  } else {
    currentEditingAssetId = null;
    if(title) title.textContent = "Add New Asset";
  }
}
function closeAssetModal() {
  const modal = document.getElementById("asset-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingAssetId = null;
}

// 2. KAYDET (Hem Yeni Ekleme Hem GÃ¼ncelleme)
// 2. KAYDET (ASSET - ENGLISH)
/* --- GÃœNCELLENMÄ°Åž: saveAsset (DOSYA YÃœKLEMELÄ°) --- */
async function saveAsset() {
  const btn = document.querySelector("#asset-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Uploading...";
  btn.disabled = true;

  try {
    const item = document.getElementById("asset-item").value.trim();
    const specs = document.getElementById("asset-specs").value.trim();
    const qty = document.getElementById("asset-qty").value.trim();
    const location = document.getElementById("asset-location").value.trim();
    const status = document.getElementById("asset-status").value;

    if (!item) { showToast("Missing Info", "Please enter an item name.", "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("No session.");

    // --- DOSYA YÃœKLEME Ä°ÅžLEMÄ° ---
    let finalFileUrl = existingAssetFileUrl; // VarsayÄ±lan: eski dosya kalsÄ±n
    let finalFileName = existingAssetFileName;

    // EÄŸer yeni dosya seÃ§ildiyse yÃ¼kle
    if (currentAssetFile) {
        const fileExt = currentAssetFile.name.split('.').pop();
        const cleanName = currentAssetFile.name.replace(/[^a-zA-Z0-9]/g, '_');
        const filePath = `${user.id}/${Date.now()}_${cleanName}.${fileExt}`;

        // 'asset-docs' bucketÄ±na yÃ¼kle (AdÄ±m 1'de oluÅŸturduÄŸumuz yer)
        const { error: uploadError } = await supabaseClient.storage
            .from('asset-docs')
            .upload(filePath, currentAssetFile);

        if (uploadError) throw uploadError;

        // Public URL al
        const { data } = supabaseClient.storage.from('asset-docs').getPublicUrl(filePath);
        finalFileUrl = data.publicUrl;
        finalFileName = currentAssetFile.name;
    }
    
    // EÄŸer kullanÄ±cÄ± dosyayÄ± sildiyse (removeAssetFile Ã§alÄ±ÅŸtÄ±ysa)
    if (!currentAssetFile && !existingAssetFileUrl) {
        finalFileUrl = null;
        finalFileName = null;
    }

    // --- VERÄ° HAZIRLAMA ---
    let currentAssets = [...(selectedCompany.assets || [])];

    const assetObj = {
        type: item, 
        spec: specs, 
        qty: qty, 
        location: location, 
        status: status,
        file_url: finalFileUrl, // Yeni alan
        file_name: finalFileName, // Yeni alan
        updated_at: new Date().toISOString()
    };

    if (currentEditingAssetId) {
        const index = currentAssets.findIndex(a => a.id === currentEditingAssetId);
        if (index > -1) {
            currentAssets[index] = { ...currentAssets[index], ...assetObj };
        }
    } else {
        currentAssets.push({ id: Date.now(), ...assetObj, date_added: new Date().toISOString() });
    }

    // --- DB UPDATE ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ assets: currentAssets, updated_at: new Date() })
      .eq('id', user.id);

    if (error) throw error;

    selectedCompany.assets = currentAssets;
    const localRef = database.find(c => c.id == user.id);
    if(localRef) localRef.assets = currentAssets;

    openProfile(user.id);
    switchProfileTab('assets');
    closeAssetModal();
    showToast("Success", "Asset saved successfully.", "success");

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}
// 3. SÄ°LME (ASSET - ENGLISH)
// 3. SÄ°LME (ASSET) - YENÄ° MODAL Ä°LE
function deleteAsset(assetId) {
    openDeleteModal("Are you sure you want to remove this asset from inventory?", async () => {
        try {
            let currentAssets = selectedCompany.assets.filter(a => a.id !== assetId);

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ assets: currentAssets, updated_at: new Date() })
                .eq('id', user.id);

            if (error) throw error;

            selectedCompany.assets = currentAssets;
            const localRef = database.find(c => c.id == user.id);
            if(localRef) localRef.assets = currentAssets;

            openProfile(user.id);
            switchProfileTab('assets');
            showToast("Deleted", "Asset removed successfully.", "success");

        } catch (error) {
            showToast("Error", error.message, "error");
        }
    });
}
/* --- PROJECT YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingProjectId = null;

// 1. MODALI AÃ‡
/* --- GÃœNCELLENMÄ°Åž: openProjectModal (RESÄ°M YÃ–NETÄ°MLÄ°) --- */
function openProjectModal(projectId = null) {
  if (!projectId) { if (!checkPlanLimit('projects')) return; }

  const modal = document.getElementById("project-modal");
  const form = document.getElementById("project-form");
  const title = document.getElementById("project-modal-title");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  if(form) form.reset();

  // --- SIFIRLAMA ---
  currentProjCover = null;
  shouldRemoveCover = false;
  currentProjGalleryFiles = [];
  tempExistingGalleryUrls = [];
  
  // UI SÄ±fÄ±rlama
  document.getElementById("cover-preview").innerHTML = '<i class="fa-solid fa-image text-gray-400"></i>';
  document.getElementById("existing-gallery-preview").innerHTML = ""; 
  document.getElementById("gallery-count-text").textContent = "";

  // --- PRO KONTROLÃœ ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const galleryLock = document.getElementById("proj-gallery-lock");
  const galleryInput = document.getElementById("proj-gallery-input");
  
  if (isPro) {
      if(galleryLock) galleryLock.classList.add("hidden");
      if(galleryInput) galleryInput.disabled = false;
  } else {
      if(galleryLock) galleryLock.classList.remove("hidden");
      if(galleryInput) galleryInput.disabled = true;
  }

  // --- DÃœZENLEME MODU ---
  if (projectId) {
    currentEditingProjectId = projectId;
    if(title) title.textContent = "Edit Project";
    
    const proj = selectedCompany.projects.find(p => p.id === projectId);
    if (proj) {
        document.getElementById("proj-title").value = proj.title || "";
        document.getElementById("proj-loc").value = proj.loc || "";
        document.getElementById("proj-desc").value = proj.desc || "";
        
        // 1. Kapak Resmi Varsa GÃ¶ster (Ve silme butonu koy)
        if (proj.cover_url) {
            document.getElementById("cover-preview").innerHTML = `
                <img src="${proj.cover_url}" class="w-full h-full object-cover">
                <button type="button" onclick="removeProjectCover()" class="absolute inset-0 bg-red-500/80 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition cursor-pointer">
                   <i class="fa-solid fa-trash text-xs"></i>
                </button>
            `;
        }

        // 2. Galeri Resimlerini YÃ¼kle
        if (proj.gallery_urls && Array.isArray(proj.gallery_urls)) {
            tempExistingGalleryUrls = [...proj.gallery_urls]; // KopyasÄ±nÄ± al
            renderExistingGalleryPreviews();
        }
    }
  } else {
    // --- YENÄ° EKLEME MODU ---
    currentEditingProjectId = null;
    if(title) title.textContent = "Add New Project";
  }
}

function closeProjectModal() {
  const modal = document.getElementById("project-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingProjectId = null;
}

// 2. KAYDET (Supabase)
// 2. KAYDET (PROJECT - ENGLISH)
/* --- GÃœNCELLENMÄ°Åž: saveProject (SÄ°LME MANTIKLI) --- */
async function saveProject() {
  const btn = document.querySelector("#project-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Saving...";
  btn.disabled = true;

  try {
    const title = document.getElementById("proj-title").value.trim();
    const loc = document.getElementById("proj-loc").value.trim();
    const desc = document.getElementById("proj-desc").value.trim();

    if (!title) { showToast("Missing Info", "Title required.", "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();

    // Mevcut verileri bul
    let currentProjects = [...(selectedCompany.projects || [])];
    let existingData = {};
    if (currentEditingProjectId) {
        existingData = currentProjects.find(p => p.id === currentEditingProjectId) || {};
    }

    // --- KAPAK FOTOÄžRAFI MANTIÄžI ---
    let finalCoverUrl = existingData.cover_url; // VarsayÄ±lan: eskisi kalsÄ±n

    if (shouldRemoveCover) {
        finalCoverUrl = null; // KullanÄ±cÄ± sildi
    }
    
    if (currentProjCover) {
        // Yeni resim yÃ¼kleniyor
        const path = `${user.id}/cover_${Date.now()}_${currentProjCover.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
        await supabaseClient.storage.from('project-gallery').upload(path, currentProjCover);
        const { data } = supabaseClient.storage.from('project-gallery').getPublicUrl(path);
        finalCoverUrl = data.publicUrl;
    }

    // --- GALERÄ° MANTIÄžI ---
    // BaÅŸlangÄ±Ã§: DÃ¼zenleme ekranÄ±nda "SilmediÄŸimiz" eski resimler
    let finalGallery = [...tempExistingGalleryUrls];

    // Ãœzerine: Yeni seÃ§ilen dosyalarÄ± yÃ¼kle ve ekle
    if (currentProjGalleryFiles.length > 0) {
        const uploadPromises = currentProjGalleryFiles.map(async (file) => {
            const path = `${user.id}/gallery_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            await supabaseClient.storage.from('project-gallery').upload(path, file);
            const { data } = supabaseClient.storage.from('project-gallery').getPublicUrl(path);
            return data.publicUrl;
        });
        
        const newUrls = await Promise.all(uploadPromises);
        finalGallery = [...finalGallery, ...newUrls];
    }

    // --- VERÄ° HAZIRLAMA ---
    const projObj = {
        id: currentEditingProjectId || Date.now(),
        title: title,
        loc: loc,
        desc: desc,
        cover_url: finalCoverUrl,
        gallery_urls: finalGallery,
        updated_at: new Date().toISOString()
    };

    if (currentEditingProjectId) {
        const index = currentProjects.findIndex(p => p.id === currentEditingProjectId);
        if (index > -1) currentProjects[index] = projObj;
    } else {
        currentProjects.push(projObj);
    }

    // --- DB KAYIT ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ projects: currentProjects, updated_at: new Date() })
      .eq('id', user.id);

    if (error) throw error;

    // Local State GÃ¼ncelle
    selectedCompany.projects = currentProjects;
    const localRef = database.find(c => c.id == user.id);
    if(localRef) localRef.projects = currentProjects;

    openProfile(user.id);
    switchProfileTab('projects');
    closeProjectModal();
    showToast("Success", "Project saved!", "success");

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// 3. SÄ°LME (PROJECT - ENGLISH)
// 3. SÄ°LME (PROJECT) - YENÄ° MODAL Ä°LE
function deleteProject(projectId) {
    openDeleteModal("Are you sure you want to delete this project?", async () => {
        try {
            let currentProjects = (selectedCompany.projects || []).filter(p => p.id !== projectId);
            
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error("No session.");

            const { error } = await supabaseClient
                .from('profiles')
                .update({ projects: currentProjects, updated_at: new Date() })
                .eq('id', user.id);

            if (error) throw error;

            selectedCompany.projects = currentProjects;
            const localRef = database.find(c => c.id == user.id);
            if(localRef) localRef.projects = currentProjects;

            openProfile(user.id);
            switchProfileTab('projects');
            showToast("Deleted", "Project removed successfully.", "success");

        } catch (error) {
            showToast("Error", error.message, "error");
        }
    });
}
// 3. SÄ°LME (CERTIFICATE) - YENÄ° MODAL Ä°LE
function deleteCert(certId, certName) {
    // TarayÄ±cÄ± confirm'i yerine kendi modalÄ±mÄ±zÄ± Ã§aÄŸÄ±rÄ±yoruz
    openDeleteModal(`Are you sure you want to delete "${certName}"?`, async () => {
        
        // --- ASIL SÄ°LME Ä°ÅžLEMÄ° BURADA BAÅžLIYOR ---
        try {
            let currentCerts = [];
            
            if (certId === -1) {
                currentCerts = selectedCompany.certificates.filter(c => c !== certName);
            } else {
                currentCerts = selectedCompany.certificates.filter(c => c.id !== certId);
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ certificates: currentCerts, updated_at: new Date() })
                .eq('id', user.id);

            if (error) throw error;

            selectedCompany.certificates = currentCerts;
            const localRef = database.find(c => c.id == user.id);
            if(localRef) localRef.certificates = currentCerts;

            openProfile(user.id);
            showToast("Deleted", "Certificate removed successfully.", "success");
            
        } catch (error) {
            showToast("Error", "Delete failed: " + error.message, "error");
        }
    });
}
  </script>

<!-- âœ… PROJECT VIEWER MODAL (click any project card) -->
<div id="project-viewer" class="hidden fixed inset-0 z-[99990]">
  <div class="absolute inset-0 bg-slate-900/60" onclick="closeProjectViewer()"></div>

  <div class="relative max-w-4xl mx-auto mt-24 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
      <div>
        <div id="pv-title" class="text-sm font-extrabold text-BTrustOn-primary"></div>
        <div id="pv-meta" class="text-[11px] text-gray-400 mt-0.5"></div>
      </div>
      <button class="w-9 h-9 rounded-full hover:bg-gray-100 text-gray-500" onclick="closeProjectViewer()" aria-label="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="p-5">
      <button id="pv-cover-btn" class="w-full rounded-xl overflow-hidden border border-gray-200 bg-slate-50 focus:outline-none">
        <img id="pv-cover" class="w-full h-[320px] object-cover" alt="Project cover">
      </button>

      <div id="pv-desc" class="text-sm text-gray-600 mt-4 whitespace-pre-wrap"></div>

      <div class="mt-4 flex items-center justify-between">
        <div id="pv-gallery-info" class="text-[11px] text-gray-400"></div>
        <button id="pv-open-gallery"
          class="hidden px-4 py-2 rounded-lg bg-BTrustOn-primary text-white text-xs font-bold hover:bg-BTrustOn-accent transition"
          onclick="openProjectViewerGallery()">
          <i class="fa-solid fa-images mr-2"></i> VIEW GALLERY
        </button>
      </div>

      <div id="pv-thumbs" class="mt-4 grid grid-cols-3 md:grid-cols-6 gap-2"></div>
    </div>
  </div>
</div>


<script>
// 1. YENÄ° KAYIT (JOIN) Ä°ÅžLEMÄ°
// GÃœNCELLENMÄ°Åž KAYIT FONKSÄ°YONU (Type Bilgisini Kaydeder)
/* --- GÃœNCELLENMÄ°Åž handleJoin (Toast'lÄ±) --- */
async function handleJoin() {
  const btn = document.querySelector("#join-form button");
  const originalText = btn.textContent;
  btn.textContent = "Processing...";
  btn.disabled = true;

  try {
    const email = document.getElementById("join-email").value;
    const password = document.getElementById("join-password").value;
    const companyName = document.getElementById("join-companyName").value;
    const sector = document.getElementById("join-sector").value;
    const typeVal = document.getElementById("join-type").value;
    const city = document.getElementById("join-city").value;
    const country = document.getElementById("join-country").value; // YENÄ°
    const services = document.getElementById("join-services").value;
    const errEl = document.getElementById("join-error");

    if(errEl) errEl.classList.add("hidden");

    const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
    if (authError) throw authError;

    const { error: dbError } = await supabaseClient.from('profiles').insert([
      {
        id: authData.user.id,
        email: email,
        company_name: companyName,
        sector: sector,
        company_type: typeVal,
        city: city,
        country: country, // YENÄ° SÃœTUN
        services: services,
        description: "",
        size: "1-10"
      }
    ]);

    if (dbError) throw dbError;

    toggleModal('modal-join');
    showToast("Welcome!", "Registration successful. Profile created.", "success");
    checkUserAndOpenProfile();

  } catch (error) {
    const errEl = document.getElementById("join-error");
    if(errEl) {
      errEl.textContent = "Error: " + (error.message || error);
      errEl.classList.remove("hidden");
    }
    showToast("Registration Failed", error.message || "Please check details.", "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}
// --- YENÄ° EKLENECEK FONKSÄ°YON BAÅžLANGIÃ‡ ---
async function fetchAllPublicProfiles() {
  // 1. Supabase'den profilleri Ã§ek
  const { data: profiles, error } = await supabaseClient
    .from('profiles')
    .select('*');

  if (error || !profiles) {
    console.log("HenÃ¼z kayÄ±tlÄ± ÅŸirket yok veya hata oluÅŸtu.");
    return;
  }

  // 2. Gelen veriyi site formatÄ±na uydur
  profiles.forEach(profile => {
if (profile.email === ADMIN_EMAIL) {
        return; // Admin maili ise bu turu atla, listeye ekleme!
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† --------------------------- ðŸ‘†ðŸ‘†ðŸ‘†
    // Listede zaten var mÄ±? Varsa Ã¼stÃ¼ne yazmayalÄ±m, sadece eksikleri gÃ¼ncelleyelim.
    const exists = database.find(c => c.id == profile.id);
    
    const formattedProfile = {
      id: profile.id,
      name: profile.company_name || "New Company",
      city: profile.city || "Konum Yok",
      country: profile.country || "Turkey",
      address: profile.address || "",
      email: profile.email || "",
      subscription_tier: profile.subscription_tier || "free",
      verification_status: profile.verification_status || "none",
      tax_id: profile.tax_id || "",
      duns_number: profile.duns_number || "",

      tagline: profile.tagline || "",
      sector: profile.sector || "construction",
      desc: profile.description || "",
      type_label: profile.company_type || "Industrial Supplier", // Type verisi buradan geliyor
      size_label: profile.company_size || "Size N/A",
      year_label: profile.founded_year || "",
      services: profile.services ? profile.services.split(',') : [],
      logo_url: profile.logo_url || null,
      website: profile.website || "",
      phone: profile.phone || "",
      contact_email: profile.contact_email || "",
      trust: "emerging", 
      meta: { references: 60, delivery: 70, years: 1, financial: 60, digital: 50 }, 
      certificates: profile.certificates || [],
      assets: profile.assets || [],
      projects: profile.projects || [] 
    };

    if (exists) {
        // Varsa gÃ¼ncelle
        Object.assign(exists, formattedProfile);
    } else {
        // Yoksa ekle
        database.unshift(formattedProfile);
    }
  });


  // Deduplicate demo/real collisions
  dedupeDatabasePreferReal();
  // 3. EKRANI YENÄ°LE (DÃœZELTME BURADA YAPILDI)
  // Eski renderCards("") yerine akÄ±llÄ± vitrini Ã§aÄŸÄ±rÄ±yoruz.
  if (typeof isSearchActive !== 'undefined' && !isSearchActive) {
      renderShowcase(); // Rozetleri destekleyen fonksiyon
  } else {
      // EÄŸer kullanÄ±cÄ± o sÄ±rada arama yapÄ±yorsa arama sonucunu gÃ¼ncelle
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      renderSearchResults(q);
  }
  
  renderTopCompanies();
}
// --- YENÄ° EKLENECEK FONKSÄ°YON BÄ°TÄ°Åž ---
/* --- DÃœZELTÄ°LMÄ°Åž: checkUserAndOpenProfile --- */
async function checkUserAndOpenProfile(forceOpen = false) {
  // 1. Oturumu Kontrol Et
  const { data: { session } } = await supabaseClient.auth.getSession();
  
  // GruplarÄ± SeÃ§
  const guestGroup = document.getElementById("guest-actions"); 
  const userGroup = document.getElementById("user-actions");

  // 2. UI'I ANINDA GÃœNCELLE
  if (!session) {
    if(guestGroup) { guestGroup.classList.remove("hidden"); guestGroup.classList.add("flex"); }
    if(userGroup) { userGroup.classList.add("hidden"); userGroup.classList.remove("flex"); }
    return; 
  } else {
    if(guestGroup) { guestGroup.classList.add("hidden"); guestGroup.classList.remove("flex"); }
    if(userGroup) { userGroup.classList.remove("hidden"); userGroup.classList.add("flex"); }
    
    fetchInboxMessages();
    subscribeToMessages();
  }

  // 3. PROFÄ°L VERÄ°SÄ°NÄ° Ã‡EK
  const { data: profile, error } = await supabaseClient
    .from('profiles')
    .select('*')
    .eq('id', session.user.id)
    .single();

  if (error || !profile) { console.log("Profil verisi Ã§ekilemedi."); return; }

  // 4. VERÄ°YÄ° FORMATLA
  const mappedProfile = {
    id: profile.id,
    email: profile.email,
    name: profile.company_name,
    city: profile.city,
    country: profile.country || "Turkey",
    address: profile.address || "",
    subscription_tier: profile.subscription_tier || 'free', 
    verification_status: profile.verification_status || 'none',
    tax_id: profile.tax_id || "",
    duns_number: profile.duns_number || "",  
    tagline: profile.tagline || "",
    sector: profile.sector || "construction",
    desc: profile.description || "",
    type_label: profile.company_type || "Industrial Supplier",
    size_label: profile.company_size || "Size N/A",
    year_label: profile.founded_year || "",
    services: profile.services ? profile.services.split(',') : [],
    logo_url: profile.logo_url || null,
    website: profile.website || "",
    phone: profile.phone || "",
    contact_email: profile.contact_email || "",
    service_details: profile.service_details || "", 
    owner_name: profile.owner_name || null,
    owner_role: profile.owner_role || null,
    owner_linkedin: profile.owner_linkedin || null,
    owner_photo_url: profile.owner_photo_url || null,
    trust: "verified",
    meta: { references: 50, delivery: 50, years: 1, financial: 50, digital: 50 },
    certificates: profile.certificates || [],
    assets: profile.assets || [],
    projects: profile.projects || [] 
  };

  if (typeof database !== 'undefined') {
      const idx = database.findIndex(c => c.id == profile.id);
      if (idx > -1) { database[idx] = mappedProfile; } 
      else { database.unshift(mappedProfile); }
      
      localStorage.setItem("BTrustOn_my_company_id", profile.id);

      if (forceOpen === true) { openProfile(profile.id); }
  }

  // Kutlama kontrolÃ¼ yap
  checkAndTriggerCelebration(mappedProfile);

  // Admin KontrolÃ¼
  checkAdminAccess();

  // --- UPGRADE BUTONLARI YÃ–NETÄ°MÄ° ---
  const navUpgradeBtn = document.getElementById("btn-nav-upgrade");
  const cardUpgradeBtn = document.getElementById("btn-card-upgrade");
  
  // EÄŸer kullanÄ±cÄ± 'free' ise butonlarÄ± gÃ¶ster, 'pro' ise gizle
  if (mappedProfile.subscription_tier === 'pro') {
      if(navUpgradeBtn) {
          navUpgradeBtn.classList.add("hidden"); 
          navUpgradeBtn.classList.remove("flex");
      }
      if(cardUpgradeBtn) {
          cardUpgradeBtn.classList.add("hidden");
          cardUpgradeBtn.classList.remove("flex");
      }
  } else {
      // Free kullanÄ±cÄ±, butonlarÄ± gÃ¶rsÃ¼n
      if(navUpgradeBtn) {
          navUpgradeBtn.classList.remove("hidden");
          navUpgradeBtn.classList.add("flex");
      }
      if(cardUpgradeBtn) {
          cardUpgradeBtn.classList.remove("hidden");
          cardUpgradeBtn.classList.add("flex");
      }
  }
}
// 3. SAYFA YÃœKLENÄ°NCE Ã‡ALIÅžTIR
/* --- SAYFA BAÅžLANGIÃ‡ AYARLARI (GECÄ°KMESÄ°Z) --- */

/* --- ROUTE RESTORE (NO FLASH) --- */
function _getCompanyIdFromHash() {
  try {
    const h = window.location.hash || "";
    const m = h.match(/^#company=([^&]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  } catch(e) { return null; }
}

function _getCompanyIdFromLastRoute() {
  try {
    const last = localStorage.getItem("BTrustOn_last_route") || "";
    if (last.startsWith("company:")) return last.slice("company:".length);
  } catch(e) {}
  return null;
}

// Runs first: decides which view should be visible before the homepage renders.
async function restoreInitialRoute() {
  const companyId = _getCompanyIdFromHash() || _getCompanyIdFromLastRoute();
  if (companyId) {
    // Don't wait: openProfile will load data; we just avoid homepage flash
    window.__routeRestoring = true;
    try {
      await openProfile(companyId);
    } finally {
      window.__routeRestoring = false;
    }
return;
  }
  // Default: dashboard (home)
  showMainView();
}


// Keep browser Back/Forward (popstate) and hash changes perfectly in sync with the UI
(function () {
  let syncing = false;

  async function syncRoute() {
    if (syncing) return;
    syncing = true;
    try {
      const hasCompany = /^#company=/.test(window.location.hash || "");
      try {
        if (hasCompany) showProfileSkeleton();
        else hideProfileSkeleton();
      } catch(e) {}
      await restoreInitialRoute();
    } finally {
      syncing = false;
    }
  }

  window.addEventListener("popstate", syncRoute);
  window.addEventListener("hashchange", syncRoute);
})();


// Runs last: reveals the UI (removes boot overlay)
function finishBoot() {
  try { document.documentElement.classList.remove("booting","route-company"); } catch(e) {}
  try {
    const overlay = document.getElementById("boot-overlay");
    if (overlay) overlay.remove();
  } catch(e) {}
}

document.addEventListener("DOMContentLoaded", async () => {
  populateCountrySelects(); // Country dropdowns

  // 0) Restore last view FIRST (prevents dashboard flash)
  await restoreInitialRoute();
  finishBoot();

  // 1) Start static systems
  applyTranslations();
  initTopCompaniesOrder();
  renderTopCompanies();
  startTopAnimations();
  switchLanguage("en");
  initRealData();
  initShowcaseSystem();

  // 2) Fetch public profiles (can run after correct view is already visible)
  // fetchAllPublicProfiles(); // disabled (initRealData handles public profiles)
 

  // 3) User session check (refresh user UI / My Company button etc.)
  checkUserAndOpenProfile();
});
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
// Oturum durumu deÄŸiÅŸirse (Login/Logout) anÄ±nda tepki ver
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
    // GiriÅŸ yapÄ±ldÄ±ysa
    if (typeof closeLoginModal === "function") closeLoginModal();
    
    // 1. Ã–nce Admin mi diye bak (Bunu ekleyin)
    if (typeof checkAdminAccess === "function") checkAdminAccess();

    // 2. Sonra profili Ã§ek
    checkUserAndOpenProfile(); 
  } 
  else if (event === 'SIGNED_OUT') {
    // Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ysa temizle
    localStorage.removeItem("BTrustOn_my_company_id");
    window.location.href = "/"; 
  }
});

/* --- MY COMPANY BUTONU DÃœZELTME --- */

// Eski fonksiyonu bununla deÄŸiÅŸtiriyoruz/eziyoruz:
function openMyCompanyIfExists() {
  // 1. LocalStorage'dan ID'yi al
  const myId = localStorage.getItem("BTrustOn_my_company_id");
  
  if (!myId) {
    console.warn("KayÄ±tlÄ± ÅŸirket ID'si bulunamadÄ±, oturum kontrol ediliyor...");
    checkUserAndOpenProfile(); // ID yoksa tekrar giriÅŸ kontrolÃ¼ yap
    return;
  }

  console.log("Åžirket profili aÃ§Ä±lÄ±yor, ID:", myId);

  // 2. EÄŸer bu ÅŸirket veritabanÄ± listemizde yoksa (Sayfa yenilendiyse kaybolmuÅŸ olabilir)
  // Ã–nce listeye ekleyip sonra aÃ§mamÄ±z gerekebilir.
  // Ama checkUserAndOpenProfile zaten Ã§alÄ±ÅŸÄ±p eklemiÅŸ olmalÄ±.
  
  const companyExists = typeof database !== 'undefined' && database.find(c => c.id == myId);

  if (companyExists) {
    // Åžirket listede var, direkt aÃ§
    openProfile(myId);
  } else {
    // Åžirket listede yoksa, verileri tekrar Ã§ekip aÃ§masÄ± iÃ§in checkUser'Ä± tetikle
    checkUserAndOpenProfile();
  }
}

/* --- PROFÄ°L DÃœZENLEME FONKSÄ°YONLARI --- */
/* =========================================
   1. GÃœNCELLENMÄ°Åž EDÄ°TÃ–R AÃ‡MA FONKSÄ°YONU
   ========================================= */
/* =========================================
   GÃœNCELLENMÄ°Åž EDÄ°TÃ–R FONKSÄ°YONU (SertifikasÄ±z & Temiz)
   ========================================= */
/* --- A. EDÄ°TÃ–RÃœ DOLDURMA (GÃœNCEL) --- */
/* --- GÃœNCELLENMÄ°Åž: editMyProfile (ÃœLKE VE ÅžEHÄ°R DESTEKLÄ°) --- */
function editMyProfile() {
  if (!selectedCompany) return;

  // 1. Mevcut verileri kutulara doldur
  document.getElementById("edit-name").value = selectedCompany.name || "";
  document.getElementById("edit-tagline").value = selectedCompany.tagline || "";
  document.getElementById("edit-desc").value = selectedCompany.desc || "";
  
  // --- YENÄ° EKLENEN KISIM (Ãœlke ve Åžehir) ---
  document.getElementById("edit-city").value = selectedCompany.city || "";
  
  // âœ… Ä°ÅžTE BURASI: EÄŸer veri yoksa otomatik 'Turkey' seÃ§er
  document.getElementById("edit-country").value = selectedCompany.country || "Turkey";
document.getElementById("edit-address").value = selectedCompany.address || ""; 

  // Logo GÃ¶sterimi
  const logoUrl = selectedCompany.logo_url;
  if (logoUrl) {
      document.getElementById("edit-logo-img").src = logoUrl;
      document.getElementById("edit-logo-img").classList.remove("hidden");
      document.getElementById("edit-logo-icon").classList.add("hidden");
  } else {
      document.getElementById("edit-logo-img").src = "";
      document.getElementById("edit-logo-img").classList.add("hidden");
      document.getElementById("edit-logo-icon").classList.remove("hidden");
  }
  selectedLogoFile = null; 

  // Ä°letiÅŸim Bilgileri
  document.getElementById("edit-website").value = selectedCompany.website || "";
  document.getElementById("edit-phone").value = selectedCompany.phone || "";
  document.getElementById("edit-email").value = selectedCompany.contact_email || selectedCompany.email || "";

  // SektÃ¶r ve Tip SeÃ§imi
  const sectorSelect = document.getElementById("edit-sector");
  if(sectorSelect) sectorSelect.value = selectedCompany.sector;

  const typeEl = document.getElementById("edit-type");
  const sizeEl = document.getElementById("edit-size");
  const yearEl = document.getElementById("edit-year");

  if(typeEl) typeEl.value = selectedCompany.type_label || "Operator"; // VarsayÄ±lanÄ± gÃ¼ncelledik
  if(sizeEl) sizeEl.value = selectedCompany.size_label || "1-10 employees";
  if(yearEl) yearEl.value = selectedCompany.year_label || "";

  // Hizmetler
  const services = selectedCompany.services || []; 
  document.getElementById("edit-services").value = Array.isArray(services) ? services.join(", ") : services;
  document.getElementById("edit-tax-id").value = selectedCompany.tax_id || "";
  document.getElementById("edit-duns").value = selectedCompany.duns_number || "";
  document.getElementById("edit-service-details").value = selectedCompany.service_details || ""; // <-- BU SATIRI EKLE 

  // ðŸ‘‡ðŸ‘‡ðŸ‘‡ D ADIMI: OWNER VERÄ°LERÄ°NÄ° KUTULARA DOLDUR ðŸ‘‡ðŸ‘‡ðŸ‘‡
  
  // 1. Ã–nce "Bu ÅŸirketin bir yetkili kaydÄ± var mÄ±?" diye bakÄ±yoruz
  const hasOwner = selectedCompany.owner_name || selectedCompany.owner_role;
  
  // 2. Varsa anahtarÄ± (toggle) aÃ§Ä±yoruz
  document.getElementById("edit-owner-toggle").checked = !!hasOwner;
  toggleOwnerSection(); // Kutuyu aÃ§ veya kapa
  
  // 3. Ä°sim, Rol ve LinkedIn linkini dolduruyoruz
  document.getElementById("edit-owner-name").value = selectedCompany.owner_name || "";
  document.getElementById("edit-owner-role").value = selectedCompany.owner_role || "";
  document.getElementById("edit-owner-linkedin").value = selectedCompany.owner_linkedin || "";
  
  // 4. FotoÄŸraf varsa gÃ¶steriyoruz, yoksa temizliyoruz
  if (selectedCompany.owner_photo_url) {
      document.getElementById("preview-owner-img").src = selectedCompany.owner_photo_url;
      document.getElementById("preview-owner-img").classList.remove("hidden");
      document.getElementById("icon-owner-img").classList.add("hidden");
  } else {
      // EÄŸer fotoÄŸraf yoksa, temizleme fonksiyonunu Ã§aÄŸÄ±rÄ±p ikon haline dÃ¶ndÃ¼rÃ¼yoruz
      if(typeof deleteOwnerPhoto === "function") deleteOwnerPhoto(); 
  } 

  updateVerificationUI(selectedCompany.verification_status);

  // EditÃ¶rÃ¼ AÃ§
  showEditorView();
  
  // Profil doluluk oranÄ±nÄ± hesapla
  setTimeout(initEditorListeners, 100); 
}
/* =========================================
   2. YENÄ° EKLENEN FONKSÄ°YONLAR (AltÄ±na Gelecek)
   ========================================= */

// A. Sol menÃ¼den tÄ±klayÄ±nca ilgili yere kaydÄ±rma
/* --- PROFILE STRENGTH HESAPLAMA (GÃœNCEL) --- */
function calculateProfileStatus() {
  // 1. ADIM: FORM ALANLARINI KONTROL ET
  // Yeni eklenen "edit-website" ve "edit-phone" listeye eklendi
  const fields = [
    "edit-name", "edit-city", "edit-sector", "edit-desc", 
    "edit-services", "edit-type", "edit-size", "edit-year",
    "edit-website", "edit-phone" 
  ];

  let filledCount = 0;
  fields.forEach(id => {
    const el = document.getElementById(id);
    // BoÅŸluklarÄ± temizle ve dolu mu bak
    if (el && el.value && el.value.trim().length > 0) {
      filledCount++;
    }
  });
  
  // Form puanÄ± (Toplam skorun %60'Ä± formdan gelir)
  const formScore = Math.round((filledCount / fields.length) * 60);

  // 2. ADIM: PROJE VE VARLIK KONTROLÃœ
  let projectScore = 0;
  let assetScore = 0;

  if (selectedCompany) {
      // En az 1 proje varsa +20 Puan
      if (selectedCompany.projects && selectedCompany.projects.length > 0) {
          projectScore = 20;
      }
      // En az 1 varlÄ±k varsa +20 Puan
      if (selectedCompany.assets && selectedCompany.assets.length > 0) {
          assetScore = 20;
      }
  }

  // TOPLAM PUAN
  const totalPercent = formScore + projectScore + assetScore;

  // UI GÃœNCELLEME
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("status-percent");
  const msg = document.getElementById("status-text");

  if (bar) bar.style.width = `${totalPercent}%`;
  if (text) text.textContent = `${totalPercent}%`;

  // RENK VE MESAJ AYARLARI
  if (totalPercent >= 100) {
      if(msg) msg.textContent = "Excellent! Your profile is fully optimized.";
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
      if(text) text.classList.replace("text-blue-600", "text-emerald-600");
  } else if (totalPercent >= 70) {
      if(msg) msg.textContent = "Strong profile. Fill missing info to reach 100%.";
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-blue-600";
  } else {
      if(msg) msg.textContent = "Low trust score. Add projects & assets to boost visibility.";
      if(bar) bar.className = "h-1.5 rounded-full transition-all duration-700 bg-amber-500";
      if(text) text.classList.replace("text-blue-600", "text-amber-600");
  }
}
// C. EditÃ¶r aÃ§Ä±ldÄ±ÄŸÄ±nda ve yazÄ± yazÄ±ldÄ±ÄŸÄ±nda hesaplamayÄ± tetikle
function initEditorListeners() {
  const inputs = document.querySelectorAll("#editor-form input, #editor-form select, #editor-form textarea");
  inputs.forEach(input => {
    // Her tuÅŸa basÄ±ldÄ±ÄŸÄ±nda veya seÃ§im deÄŸiÅŸtiÄŸinde hesapla
    input.addEventListener("input", calculateProfileStatus);
    input.addEventListener("change", calculateProfileStatus);
  });
  
  // Ä°lk aÃ§Ä±lÄ±ÅŸta bir kere hesapla
  calculateProfileStatus();
}
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (En alta ekleyin) --- */
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (GÃœNCELLENMÄ°Åž HALÄ°) --- */
/* --- TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (TIKLANABÄ°LÄ°R VERSÄ°YON) --- */
function showToast(title, message, type = 'success', onClick = null) {
  // âœ… Skeleton aÃ§Ä±kken profil yÃ¼kleme toast'larÄ±nÄ± bastÄ±r (refresh + normal geÃ§iÅŸ)
  if (window.__suppressProfileLoadingToasts) {
    const t = String(title || "").toLowerCase();
    const m = String(message || "").toLowerCase();
    if (t.includes("loading") || m.includes("loading") || m.includes("fetching") || m.includes("profile")) {
      return;
    }
  }

  const container = document.getElementById('toast-container');
  if (!container) return;

  const toast = document.createElement('div');
  
  // TÄ±klanabilir ise mouse imleci el iÅŸareti olsun
  const cursorClass = onClick ? 'cursor-pointer hover:bg-gray-50' : '';
  toast.className = `toast ${type} ${cursorClass}`;
  
  // Ä°kon SeÃ§imi
  let icon = 'fa-circle-check'; 
  if (type === 'error') icon = 'fa-circle-xmark';
  if (type === 'brand') icon = 'fa-bell'; 

  toast.innerHTML = `
    <i class="fa-solid ${icon}"></i>
    <div class="toast-content">
      <span class="toast-title">${title}</span>
      <span class="toast-msg">${message}</span>
    </div>
    <button id="close-toast-btn" class="text-gray-400 hover:text-gray-600 z-50 p-1">
      <i class="fa-solid fa-xmark text-sm"></i>
    </button>
  `;

  // TIKLAMA OLAYI
  toast.onclick = (e) => {
    // EÄŸer kapatma butonuna (veya ikonuna) basÄ±ldÄ±ysa mesajÄ± aÃ§ma, sadece kapat
    if (e.target.closest('#close-toast-btn')) {
        toast.remove();
        return;
    }
    
    // EÄŸer tÄ±klama aksiyonu varsa Ã§alÄ±ÅŸtÄ±r
    if (onClick) {
        onClick();
        toast.remove(); // TÄ±klayÄ±nca bildirimi ekrandan kaldÄ±r
    }
  };

  // Kapatma butonu iÃ§in Ã¶zel dinleyici (Garanti olsun diye)
  const closeBtn = toast.querySelector('#close-toast-btn');
  if(closeBtn) {
      closeBtn.onclick = (e) => {
          e.stopPropagation(); // TÄ±klamayÄ± yukarÄ± geÃ§irme
          toast.remove();
      };
  }

  container.appendChild(toast);

  // 4 saniye sonra otomatik sil
  setTimeout(() => {
    if (toast.parentNode) { // Hala ekrandaysa
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
    }
  }, 4000);
}
/* --- SÄ°LME ONAY SÄ°STEMÄ° --- */
let pendingDeleteAction = null; // Silme fonksiyonunu burada tutacaÄŸÄ±z

function openDeleteModal(message, actionCallback) {
  const modal = document.getElementById("delete-modal");
  const msgEl = document.getElementById("delete-modal-msg");
  const btn = document.getElementById("btn-confirm-delete");

  if (!modal) return;

  // MesajÄ± ayarla
  if(msgEl) msgEl.textContent = message;

  // YapÄ±lacak iÅŸlemi hafÄ±zaya al
  pendingDeleteAction = actionCallback;

  // Butona tÄ±klanÄ±nca iÅŸlemi Ã§alÄ±ÅŸtÄ±r
  btn.onclick = () => {
    if (pendingDeleteAction) pendingDeleteAction();
    closeDeleteModal();
  };

  // ModalÄ± gÃ¶ster
  modal.classList.remove("pointer-events-none", "opacity-0");
  document.getElementById("delete-modal-content").classList.remove("scale-95");
  document.getElementById("delete-modal-content").classList.add("scale-100");
}

function closeDeleteModal() {
  const modal = document.getElementById("delete-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  
  // Efekt sÄ±fÄ±rlama
  const content = document.getElementById("delete-modal-content");
  if(content) {
      content.classList.remove("scale-100");
      content.classList.add("scale-95");
  }
  
  pendingDeleteAction = null;
}

/* --- YENÄ° EKLENECEK KODLAR --- */

// Hangi sekmedeyiz? (VarsayÄ±lan: inbox)
let currentInboxView = 'inbox'; 

// Sekme DeÄŸiÅŸtirme Fonksiyonu
function switchInboxView(view) {
    currentInboxView = view;
    
    // UI GÃ¼ncelleme (Border ve Renkler)
    const btnInbox = document.getElementById("btn-tab-inbox");
    const btnSent = document.getElementById("btn-tab-sent");

    if (view === 'inbox') {
        // Inbox Aktif
        btnInbox.classList.add("border-BTrustOn-accent", "text-white");
        btnInbox.classList.remove("border-transparent", "text-white/50"); 
        
        // Sent Pasif
        btnSent.classList.remove("border-BTrustOn-accent", "text-white");
        btnSent.classList.add("border-transparent", "text-white/50");
    } else {
        // Sent Aktif
        btnSent.classList.add("border-BTrustOn-accent", "text-white");
        btnSent.classList.remove("border-transparent", "text-white/50");
        
        // Inbox Pasif
        btnInbox.classList.remove("border-BTrustOn-accent", "text-white");
        btnInbox.classList.add("border-transparent", "text-white/50");
    }

    // Listeyi yeniden Ã§iz (Filtreleyerek)
    renderInboxItems();
}
/* --- PREMIUM INBOX ENGINE (EN ALTA EKLE) --- */
// ðŸ‘‡ YENÄ° EKLENECEK KISIM ðŸ‘‡

// Inbox verisini artÄ±k canlÄ± tutacaÄŸÄ±z, demo veriyi sildik, boÅŸ baÅŸlattÄ±k.
let inboxData = []; 

// Tarih formatlayÄ±cÄ± (Ã–rn: "2 hours ago" yazar)
function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " mins ago";
    return "Just now";
}
/* --- GÃœNCELLENMÄ°Åž: fetchInboxMessages (Kesin Filtreleme) --- */
async function fetchInboxMessages() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // 1. TÃ¼m mesajlarÄ± Ã§ek
    const { data: rawMessages, error } = await supabaseClient
        .from('messages')
        .select('*')
        .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Fetch Error:", error);
        return;
    }

    // 2. ðŸ‘‡ FÄ°LTRELEME: Silinenleri Kesin Olarak Gizle ðŸ‘‡
    const messages = rawMessages.filter(m => {
        // GÃ–NDEREN BEN Ä°SEM (Sent Kutusu):
        // sender_delete 'true' ise gizle.
        if (m.sender_id === user.id && m.sender_delete === true) return false;
        
        // ALICI BEN Ä°SEM (Inbox Kutusu):
        // receiver_delete 'true' ise gizle.
        if (m.receiver_id === user.id && m.receiver_delete === true) return false;

        return true; // DiÄŸer durumlarda gÃ¶ster
    });

    const groupedMap = new Map();
    const partnersToFetch = new Set();

    // ðŸ‘‡ messages.forEach bloÄŸunu tamamen bununla deÄŸiÅŸtirin ðŸ‘‡
    messages.forEach(msg => {
        // Konu baÅŸlÄ±ÄŸÄ±nÄ± temizle (Re: kÄ±sÄ±mlarÄ±nÄ± at)
        const cleanSubject = msg.subject ? msg.subject.replace(/^(Re:\s*)+/i, '').trim() : "No Subject";
        const isMeSender = (msg.sender_id === user.id);
        
        // âœ… DEÄžÄ°ÅžÄ°KLÄ°K 1: EÄŸer sender_id yoksa (Misafir), partnerId'yi string 'null' yap
        const partnerId = isMeSender ? msg.receiver_id : (msg.sender_id || 'null');
        
        const groupKey = cleanSubject + "_" + partnerId;

        if (!groupedMap.has(groupKey)) {
            let displayCompany = "Loading...";
            let logoChar = "P";

            // âœ… DEÄžÄ°ÅžÄ°KLÄ°K 2: MÄ°SAFÄ°R KONTROLÃœ
            if (partnerId === 'null') {
                displayCompany = "Guest User";
                logoChar = "G";

                // EÄŸer mesajda "Ahmet (Guest)" gibi bir isim saklÄ±ysa onu al
                if (msg.related_company_name) {
                    displayCompany = msg.related_company_name;
                    // BaÅŸ harfini logo yap (Ã–rn: Ahmet -> A)
                    // Parantez iÃ§ini temizleyip saf ismi almaya Ã§alÄ±ÅŸalÄ±m
                    const nameMatch = displayCompany.match(/^(.*?)\s*\(/);
                    if(nameMatch) logoChar = nameMatch[1].charAt(0).toUpperCase();
                    else logoChar = displayCompany.charAt(0).toUpperCase();
                }
            } 
            else {
                // --- NORMAL ÅžÄ°RKET BULMA MANTIÄžI (Eskisi Gibi) ---
                const localPartner = database.find(c => c.id == partnerId);
                if (localPartner) {
                    displayCompany = localPartner.name;
                    logoChar = displayCompany.charAt(0).toUpperCase();
                } else {
                    if (!isMeSender && msg.related_company_name) {
                        const match = msg.related_company_name.match(/\((.+)\)$/);
                        displayCompany = match ? match[1] : msg.related_company_name;
                        logoChar = displayCompany.charAt(0).toUpperCase();
                    } else {
                        displayCompany = "Company ID: " + partnerId.substr(0,4) + "...";
                        partnersToFetch.add(partnerId);
                    }
                }
            }

            groupedMap.set(groupKey, {
                id: msg.id,
                count: 1,
                partner_id: partnerId,
                company: displayCompany,
                title: cleanSubject,
                desc: isMeSender ? `You: ${msg.content}` : msg.content,
                time: timeAgo(msg.created_at),
                unread: !msg.is_read && !isMeSender,
                type: msg.msg_type,
                logo: logoChar,
                isSentByMe: isMeSender 
            });
        } else {
            const existing = groupedMap.get(groupKey);
            existing.count += 1;
            if (!msg.is_read && !isMeSender) existing.unread = true;
        }
    });
    // ðŸ‘† messages.forEach bloÄŸu burada bitiyor ðŸ‘†

    // Eksik isimleri veritabanÄ±ndan tamamla
    if (partnersToFetch.size > 0) {
        const { data: profiles } = await supabaseClient
            .from('profiles')
            .select('id, company_name')
            .in('id', Array.from(partnersToFetch));
        
        if (profiles) {
            groupedMap.forEach((val) => {
                const found = profiles.find(p => p.id === val.partner_id);
                if (found) {
                    val.company = found.company_name;
                    val.logo = found.company_name.charAt(0).toUpperCase();
                }
            });
        }
    }

    inboxData = Array.from(groupedMap.values());
    renderInboxItems();
}
/* --- YENÄ° YARDIMCI: AnlÄ±k Liste GÃ¼ncelleyici (Gecikmeyi Ã–nler) --- */
function manualInboxUpdate(partnerId, subject, content, isQuote = false) {
    // 1. Konu baÅŸlÄ±ÄŸÄ±nÄ± temizle
    const cleanSubject = subject.replace(/^(Re:\s*)+/i, '').trim();
    
    // 2. Partnerin (AlÄ±cÄ±nÄ±n) Ä°smini Bul
    let partnerName = "Loading...";
    // VeritabanÄ± listesinden bulmaya Ã§alÄ±ÅŸ
    const partnerProfile = database.find(c => c.id == partnerId);
    if (partnerProfile) {
        partnerName = partnerProfile.name;
    } else {
        // Bulamazsak inputlardan veya mevcut ekrandan almaya Ã§alÄ±ÅŸ
        const msgHeaderName = document.getElementById("quote-target-company");
        if(msgHeaderName && msgHeaderName.textContent) partnerName = msgHeaderName.textContent;
    }

    // 3. Listede bu konuÅŸma var mÄ±?
    const existingIndex = inboxData.findIndex(item => 
        String(item.partner_id) === String(partnerId) && item.title === cleanSubject
    );

    // 4. Yeni veri objesi
    const newItem = {
        id: Date.now(), // GeÃ§ici ID (Ekran iÃ§in yeterli)
        count: existingIndex > -1 ? inboxData[existingIndex].count + 1 : 1,
        partner_id: partnerId,
        company: partnerName,
        title: cleanSubject,
        desc: "You: " + content, // "You" ekledik ki Sent formatÄ±na uysun
        time: "Just now",
        unread: false,
        type: isQuote ? 'quote' : 'message',
        logo: partnerName.charAt(0).toUpperCase(),
        isSentByMe: true // Kilit nokta: SENT kutusunda gÃ¶rÃ¼nmesini saÄŸlar
    };

    // 5. Eski kaydÄ± listeden Ã§Ä±kar (Varsa)
    if (existingIndex > -1) {
        inboxData.splice(existingIndex, 1);
    }

    // 6. Yeni kaydÄ± EN BAÅžA ekle
    inboxData.unshift(newItem);

    // 7. Listeyi hemen boya (HiÃ§ beklemeden)
    renderInboxItems();
}
// Realtime Abonelik BaÅŸlat (Sayfa aÃ§Ä±lÄ±nca Ã§aÄŸÄ±rÄ±lmalÄ±)
// âœ… DÃœZELTÄ°LMÄ°Åž ABONELÄ°K (Kendi mesajÄ±na bildirim vermez)
/* --- GERÃ‡EK ZAMANLI DÄ°NLEME (REALTIME) --- */
// âœ… Mesajlar ve Teklifler iÃ§in DoÄŸru Real-time Dinleyicisi
// âœ… Mesajlar ve Teklifler (Ä°ngilizce + Mavi Logo Rengi)
// âœ… Mesajlar ve Teklifler (TÄ±klayÄ±nca Mesaja Gitme Ã–zellikli)
let messageChannel = null;
/* --- GÃœNCELLENMÄ°Åž: subscribeToMessages (CanlÄ± KÄ±rmÄ±zÄ± IÅŸÄ±k) --- */
function subscribeToMessages() {
  if (messageChannel) { supabaseClient.removeChannel(messageChannel); messageChannel = null; }

  messageChannel = supabaseClient
    .channel('public:messages')
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'messages' },
      async (payload) => {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        // Sadece mesaj BANA (receiver_id) geldiyse Ã§alÄ±ÅŸ
        if (!user || payload.new.receiver_id !== user.id) return;

        // 1. INBOX LÄ°STESÄ°NÄ° VE KIRMIZI ROZETÄ° YENÄ°LE
        await fetchInboxMessages(); 

        // 2. TOAST BÄ°LDÄ°RÄ°MÄ° GÃ–STER (Åžirket AdÄ±nÄ± AyÄ±kla)
        const rawName = payload.new.related_company_name || "Unknown";
        // "Ahmet (RÃ¶nesans)" iÃ§inden parantezdeki ÅŸirketi al
        const match = rawName.match(/\((.+)\)$/);
        const companyName = match ? match[1] : rawName;

        const isQuote = payload.new.msg_type === 'quote';
        const title = isQuote ? "New Quote Request" : "New Message";
        const body = `${companyName} sent you a request.`;

        // Inbox kapalÄ±ysa bildirim gÃ¶ster, tÄ±klayÄ±nca mesajÄ± aÃ§
        const panel = document.getElementById("inbox-panel");
        if (panel && !panel.classList.contains("open")) {
            showToast(title, body, "brand", () => openMessage(payload.new.id));
        }
      }
    )
    .subscribe();
}
function toggleInbox() {
  const panel = document.getElementById("inbox-panel");
  const overlay = document.getElementById("inbox-overlay");
  
  if (!panel || !overlay) return;

  const isOpen = panel.classList.contains("open");

  if (isOpen) {
    // Kapat
    panel.classList.remove("open");
    overlay.classList.remove("opacity-100");
    overlay.classList.add("opacity-0");
    setTimeout(() => overlay.classList.add("hidden"), 300);
  } else {
    // AÃ§
    renderInboxItems(); // Verileri tazeleyerek aÃ§
    overlay.classList.remove("hidden");
    // Animasyon iÃ§in minik gecikme
    setTimeout(() => {
        overlay.classList.remove("opacity-0");
        overlay.classList.add("opacity-100");
        panel.classList.add("open");
    }, 10);
  }
}
/* --- GÃœNCELLENMÄ°Åž: renderInboxItems (RENKLÄ° LEAD DESTEKLÄ°) --- */
function renderInboxItems() {
  const container = document.getElementById("inbox-content");
  const badgeNav = document.getElementById("nav-badge");
  const badgeHeader = document.getElementById("inbox-badge-count");
  
  if (!container) return;
  container.innerHTML = "";

  // 1. TOPLAM OKUNMAMIÅž SAYISI
  let totalUnreadCount = 0;
  inboxData.forEach(item => { if(item.unread) totalUnreadCount++; });

  // 2. FÄ°LTRELEME
  const filteredData = inboxData.filter(item => {
      if (currentInboxView === 'inbox') {
          return item.isSentByMe === false; 
      } else {
          return item.isSentByMe === true; 
      }
  });

  // BoÅŸ durum mesajÄ±
  if (filteredData.length === 0) {
      const msg = currentInboxView === 'inbox' ? "No received messages." : "No sent messages.";
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fa-solid ${currentInboxView === 'inbox' ? 'fa-inbox' : 'fa-paper-plane'} text-4xl mb-3 opacity-20"></i>
            <p class="text-xs">${msg}</p>
        </div>`;
      
      updateBadges(totalUnreadCount);
      return;
  }

  // KartlarÄ± OluÅŸtur
  filteredData.forEach(item => {
    const safeTitle = item.title.replace(/'/g, "\\'");
    const directionLabel = currentInboxView === 'sent' ? 'To:' : 'From:';
    const previewText = item.desc.replace(/^You:\s*/, '');

    // --- RENK VE STÄ°L AYARI ---
    // 'G' logosu veya 'null' ID, bunun bir Misafir/Lead olduÄŸunu gÃ¶sterir.
    const isLead = (item.logo === 'G') || (item.partner_id === 'null') || (item.partner_id === null);

    let cardClasses = "";
    let iconBg = "";
    let iconName = "";

    if (isLead) {
        // --- LEAD (TURUNCU/AMBER) TASARIMI ---
        // OkunmamÄ±ÅŸsa daha koyu, okunmuÅŸsa ÅŸeffaf turuncu
        const bg = item.unread ? "bg-amber-50 border-l-4 border-l-amber-500 shadow-sm" : "bg-amber-50/50 border-l-4 border-l-transparent opacity-90";
        cardClasses = `inbox-item relative p-4 mb-2 rounded-xl border-y border-r border-amber-100 ${bg} hover:border-amber-300 transition-all duration-200 cursor-pointer group`;
        
        iconBg = "bg-amber-100 text-amber-600";
        iconName = "fa-user-clock"; // Lead iÃ§in Ã¶zel ikon
    } 
    else {
        // --- STANDART (BEYAZ/GRÄ°) TASARIMI ---
        const bg = item.unread ? "bg-white unread shadow-sm" : "bg-white/60 opacity-90";
        cardClasses = `inbox-item relative p-4 mb-2 rounded-xl border border-transparent hover:border-gray-200 ${bg} transition-all duration-200 cursor-pointer group`;
        
        iconBg = "bg-gray-100 text-gray-500";
        iconName = "fa-building";
        
        // EÄŸer Teklif ise (Lead deÄŸil ama kayÄ±tlÄ± Ã¼yeden teklif)
        if(item.type === 'quote') { 
            iconBg = "bg-cyan-50 text-BTrustOn-accent"; 
            iconName = "fa-file-invoice-dollar"; 
        }
    }

    const countBadge = item.count > 1 
        ? `<span class="ml-2 bg-gray-100 text-gray-500 text-[9px] font-bold px-1.5 py-0.5 rounded-full">+${item.count - 1}</span>` 
        : '';

    const card = document.createElement("div");
    card.className = cardClasses;
    card.onclick = () => openMessage(item.id); 

    card.innerHTML = `
      <button 
          onclick="deleteThread(${item.id}, '${safeTitle}', '${item.partner_id}', event)" 
          class="absolute top-2 right-2 w-7 h-7 rounded-lg bg-white/80 text-gray-300 hover:text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 shadow-sm"
          title="Delete Thread"
      >
          <i class="fa-solid fa-trash-can text-[10px]"></i>
      </button>

      <div class="flex gap-3 pointer-events-none"> 
        <div class="w-10 h-10 rounded-xl ${iconBg} flex items-center justify-center shrink-0 shadow-sm relative mt-1">
           <i class="fa-solid ${iconName}"></i>
           ${item.unread ? '<span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full"></span>' : ''}
        </div>

        <div class="flex-1 min-w-0">
           
           <div class="flex justify-between items-start mb-1 pr-6"> 
              <div class="flex items-center min-w-0">
                  <h4 class="text-xs font-bold text-gray-800 leading-tight truncate pr-1">${item.title}</h4>
                  ${countBadge}
              </div>
              <span class="text-[9px] text-gray-400 whitespace-nowrap ml-2 shrink-0">${item.time}</span>
           </div>

           <div class="flex items-center gap-1.5 mb-1.5">
              <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wide">${directionLabel}</span>
              <span class="text-xs font-bold ${isLead ? 'text-amber-600' : 'text-BTrustOn-accent'} truncate">
                 ${item.company} 
              </span>
           </div>
           
           <p class="text-[10px] text-gray-500 leading-relaxed line-clamp-1 italic border-l-2 ${isLead ? 'border-amber-200' : 'border-gray-200'} pl-2">
             "${previewText}"
           </p>
           
        </div>
      </div>
    `;
    container.appendChild(card);
  });

  updateBadges(totalUnreadCount);
}
// YardÄ±mcÄ± Badge Fonksiyonu (EÄŸer yoksa bunu da ekle, varsa gerek yok)
function updateBadges(count) {
  const badgeNav = document.getElementById("nav-badge");
  const badgeHeader = document.getElementById("inbox-badge-count");

  if(badgeNav) {
      if(count > 0) {
          badgeNav.textContent = count;
          badgeNav.classList.remove("hidden");
      } else {
          badgeNav.classList.add("hidden");
      }
  }
  if(badgeHeader) {
      if(count > 0) {
        badgeHeader.textContent = `${count} NEW`;
        badgeHeader.classList.remove("hidden");
      } else {
        badgeHeader.classList.add("hidden");
      }
  }
}
// Sayfa aÃ§Ä±lÄ±nca badge'i kontrol et
document.addEventListener("DOMContentLoaded", () => {
    // Hafif bir gecikmeyle Ã§alÄ±ÅŸtÄ±r ki diÄŸer yÃ¼klemeler bitsin
    setTimeout(renderInboxItems, 800);
});
/* --- MESSAGE READER LOGIC (YENÄ° EKLENECEK KISIM) --- */


/* --- GERÃ‡EK MESAJLAÅžMA SÄ°STEMÄ° (Supabase Entegreli) --- */

let currentMessageContext = null; // Hangi mesajÄ± cevaplÄ±yoruz?

// 1. MESAJI AÃ‡MA FONKSÄ°YONU
/* --- GÃœNCELLENMÄ°Åž SOHBET AÃ‡MA (TIKLANABÄ°LÄ°R BAÅžLIK) --- */
let currentPartnerId = null; // Global deÄŸiÅŸken
let currentSubject = null;
let currentOpenMessageId = null;
/* --- GÃœNCELLENMÄ°Åž: openMessage (BaÅŸlÄ±k Ä°sim Garantili) --- */
async function openMessage(itemId) {
    const item = inboxData.find(m => m.id === itemId);
    if (!item) return;

    currentPartnerId = item.partner_id;
    currentSubject = item.title;
    currentOpenMessageId = itemId;

    // --- KRÄ°TÄ°K DÃœZELTME: BAÅžLIK Ä°SMÄ°NÄ° CANLI VERÄ°DEN AL ---
    // Inbox listesindeki isme gÃ¼venmek yerine, veritabanÄ± (database) hafÄ±zasÄ±ndaki 
    // gÃ¼ncel ÅŸirket kartÄ±nÄ± bulup ismini oradan Ã§ekiyoruz.
    let fixedHeaderName = item.company; // VarsayÄ±lan (EÄŸer bulamazsa)
    
    // VeritabanÄ± listesinden ID ile gerÃ§ek profili bul
    const liveProfile = database.find(c => c.id == currentPartnerId);
    if (liveProfile) {
        fixedHeaderName = liveProfile.name;
    }
    // -------------------------------------------------------

    // Okundu Yapma Ä°ÅŸlemleri
    if (item.unread) {
        item.unread = false;
        renderInboxItems(); // Soldaki listeyi gÃ¼ncelle
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        if(user) {
            supabaseClient.from('messages').update({ is_read: true })
                .eq('receiver_id', user.id).eq('sender_id', currentPartnerId)
                .ilike('subject', `%${item.title}%`).then(()=>{});
        }
    }

    // 1. KONU BAÅžLIÄžI
    document.getElementById("msg-subject").textContent = item.title;

    // 2. ÅžÄ°RKET Ä°SMÄ° (SabitlenmiÅŸ Ä°sim KullanÄ±lÄ±yor)
    // 2. ÅžÄ°RKET Ä°SMÄ° (Misafir KontrolÃ¼ EklenmiÅŸ Hali)
    let companyHeaderHtml = "";
    
    // EÄŸer partnerId 'null' ise veya tanÄ±msÄ±zsa (Yani Misafir ise)
    if (!currentPartnerId || currentPartnerId === 'null' || currentPartnerId === 'undefined') {
        // MÄ°SAFÄ°R Ä°SE: TÄ±klanamayan dÃ¼z yazÄ± ve 'Guest User' etiketi
        companyHeaderHtml = `
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 font-normal uppercase tracking-wider">Guest User</span>
                <span class="text-left font-bold text-gray-800 text-sm flex items-center gap-1.5 cursor-default">
                    <i class="fa-solid fa-user-clock text-amber-500"></i>
                    ${fixedHeaderName} 
                </span>
            </div>
        `;
    } else {
        // KAYITLI ÅžÄ°RKET Ä°SE: TÄ±klanabilir Profil Linki (Eski hali)
        companyHeaderHtml = `
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 font-normal uppercase tracking-wider">Conversation with</span>
                <button onclick="openProfile('${currentPartnerId}')" 
                        class="text-left font-bold text-BTrustOn-accent hover:text-blue-700 hover:underline transition text-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-building-user"></i>
                    ${fixedHeaderName} 
                </button>
            </div>
        `;
    }

    // HTML'i sayfaya bas
    document.getElementById("msg-company").innerHTML = companyHeaderHtml;

    // 3. LOGO (SabitlenmiÅŸ Ä°smin BaÅŸ Harfi)
    const logoEl = document.getElementById("msg-logo");
    if(logoEl) {
        logoEl.textContent = fixedHeaderName.charAt(0).toUpperCase();
        logoEl.className = "w-10 h-10 rounded-lg bg-BTrustOn-accent text-white flex items-center justify-center text-lg font-bold shrink-0 shadow-md border-0";
    }

    // EkranÄ± AÃ§
    const viewer = document.getElementById("view-message");
    if(viewer) viewer.classList.remove("hidden-view");
    document.body.style.overflow = "hidden";
    toggleInbox(); 
    
    // Sohbeti YÃ¼kle
    await loadMessageThread(item.title, currentPartnerId);
// Cevap yazma kutusunu (input area) seÃ§
    const replyInputArea = document.querySelector("#view-message .border-t"); 
    
    // EÄŸer partner ID yoksa veya 'null'/'undefined' stringi ise bu bir misafirdir
    if (!currentPartnerId || currentPartnerId === 'null' || currentPartnerId === 'undefined') {
        
        // 1. Input alanÄ±nÄ± GÄ°ZLE
        if(replyInputArea) replyInputArea.classList.add("hidden");

        // 2. UyarÄ± mesajÄ± GÃ–STER (Daha Ã¶nce eklenmediyse ekle)
        const warningBanner = document.getElementById("guest-reply-warning");
        if (!warningBanner) {
            const warning = document.createElement("div");
            warning.id = "guest-reply-warning";
            warning.className = "p-4 bg-amber-50 border-t border-amber-100 text-center animate-fade-in";
            warning.innerHTML = `
                <div class="flex flex-col items-center gap-2">
                    <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center">
                        <i class="fa-solid fa-user-clock text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-amber-800 uppercase tracking-wide">Guest User</p>
                        <p class="text-[11px] text-amber-700 mt-0.5">
                            This request is from an unregistered guest. You cannot reply via chat.
                            <br>Please reply via email using the contact details above.
                        </p>
                    </div>
                </div>
            `;
            // Mesaj ekranÄ±nÄ±n en altÄ±na (inputun olduÄŸu yere) ekle
            document.getElementById("view-message").appendChild(warning);
        } else {
            // Zaten varsa gÃ¶rÃ¼nÃ¼r yap
            warningBanner.classList.remove("hidden");
        }

    } else {
        // --- NORMAL KULLANICI Ä°SE ---
        
        // Inputu GÃ–STER
        if(replyInputArea) replyInputArea.classList.remove("hidden");
        
        // UyarÄ±yÄ± GÄ°ZLE
        const warningBanner = document.getElementById("guest-reply-warning");
        if (warningBanner) warningBanner.classList.add("hidden");
    }
}
/* --- GÃœNCELLENMÄ°Åž: loadMessageThread (MÄ°SAFÄ°R HATASI GÄ°DERÄ°LMÄ°Åž) --- */
async function loadMessageThread(cleanSubject, partnerId) {
    const container = document.getElementById("message-thread-container");
    container.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-spinner fa-spin text-BTrustOn-accent"></i></div>';

    const { data: { user } } = await supabaseClient.auth.getUser();
    if(!user) return;

    let fixedPartnerName = "Partner";
    
    // Partner ismini bulmaya Ã§alÄ±ÅŸ (Misafir ise 'Guest User' kalÄ±r veya related_company_name'den gelir)
    if (partnerId && partnerId !== 'null') {
        const partnerProfile = database.find(c => c.id == partnerId);
        if (partnerProfile) fixedPartnerName = partnerProfile.name;
    }

    // --- SORGULAMA MANTIÄžI DEÄžÄ°ÅžTÄ° ---
    let query = supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true });

    // EÄŸer Partner ID 'null' ise (MÄ°SAFÄ°R SENARYOSU)
    if (!partnerId || partnerId === 'null' || partnerId === 'undefined') {
        // "GÃ¶nderen BOÅž (null) VE AlÄ±cÄ± BEN olan mesajlarÄ± getir"
        query = query
            .is('sender_id', null)       // Sender ID NULL olmalÄ±
            .eq('receiver_id', user.id)  // AlÄ±cÄ± BEN olmalÄ±yÄ±m
            .ilike('subject', `%${cleanSubject}%`); // Konu baÅŸlÄ±ÄŸÄ± uymalÄ±
    } 
    else {
        // NORMAL KULLANICI SENARYOSU (Eski MantÄ±k)
        // "Benim gÃ¶nderdiÄŸim VEYA bana gelen mesajlarÄ± getir"
        query = query
            .or(`and(sender_id.eq.${user.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${user.id})`)
            .ilike('subject', `%${cleanSubject}%`);
    }

    const { data: thread, error } = await query;

    if (error) {
        console.error("Load Thread Error:", error);
        container.innerHTML = '<p class="text-red-500 text-xs text-center mt-4">Error loading history.</p>';
        return;
    }
    
    container.innerHTML = ""; 

    if(!thread || thread.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-xs text-center italic mt-10">Start the conversation...</p>';
        return;
    }

    thread.forEach(m => {
        const isMe = m.sender_id === user.id; // MesajÄ± ben mi attÄ±m?
        
        // Misafir ismini mesajÄ±n iÃ§inden (related_company_name) Ã§ekmeye Ã§alÄ±ÅŸ
        let senderDisplayName = fixedPartnerName;
        if (!isMe && m.related_company_name) {
             // "Rahmi (Guest)" ÅŸeklindeki isimleri temizle, sadece ismi al
             senderDisplayName = m.related_company_name.split('(')[0].trim(); 
        }

        let displayNameHtml = isMe 
            ? `<span class="text-[10px] font-bold text-BTrustOn-accent">ME</span>`
            : `<span class="text-[10px] font-bold text-gray-600 uppercase tracking-wide cursor-default">${senderDisplayName}</span>`;
            // Misafir olduÄŸu iÃ§in isme tÄ±klama (cursor-default) Ã¶zelliÄŸi verdik

        let cleanContent = m.content || "";

        // --- DOSYA KARTI OLUÅžTURMA (Ã–nceki Ä°ndirme Logic'i Korundu) ---
        cleanContent = cleanContent.replace(/\[FILE_ATTACHMENT\|(.*?)\|(.*?)\]/g, function(match, fileName, fileUrl) {
            
            let icon = "fa-file-lines";
            if(fileName.match(/\.(jpg|jpeg|png|gif)$/i)) icon = "fa-image";
            if(fileName.match(/\.(pdf)$/i)) icon = "fa-file-pdf";
            if(fileName.match(/\.(doc|docx)$/i)) icon = "fa-file-word";
            if(fileName.match(/\.(xls|xlsx)$/i)) icon = "fa-file-excel";

            // Ä°ndirme butonu sadece alÄ±cÄ±ya (Bana) gÃ¶rÃ¼nsÃ¼n
            const downloadBtnHtml = !isMe ? `
                <button onclick="downloadFile('${fileUrl}', '${fileName}')" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-400 hover:text-BTrustOn-accent flex items-center justify-center transition" title="Download File">
                    <i class="fa-solid fa-download"></i>
                </button>
            ` : '';

            const actionText = isMe ? "Click to verify upload" : "Click to view";

            return `
                <div class="mt-3 group">
                    <div class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-xl hover:border-BTrustOn-accent hover:shadow-md transition-all">
                        <div onclick="window.open('${fileUrl}', '_blank')" class="cursor-pointer w-10 h-10 rounded-lg bg-gray-50 text-BTrustOn-accent flex items-center justify-center text-lg group-hover:bg-BTrustOn-accent group-hover:text-white transition-colors">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div onclick="window.open('${fileUrl}', '_blank')" class="cursor-pointer flex-1 min-w-0">
                            <p class="text-xs font-bold text-gray-700 truncate group-hover:text-BTrustOn-accent transition-colors" title="${fileName}">${fileName}</p>
                            <p class="text-[10px] text-gray-400">${actionText}</p>
                        </div>
                        ${downloadBtnHtml}
                    </div>
                </div>
            `;
        });

        cleanContent = cleanContent.replace(/\n/g, '<br>');

        const bubble = document.createElement("div");
        bubble.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;
        
        bubble.innerHTML = `
            <div class="max-w-[85%] ${isMe ? 'bg-cyan-50 border border-cyan-100 rounded-tr-none' : 'bg-white border border-gray-200 rounded-tl-none'} p-4 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-1 gap-4">
                    ${displayNameHtml}
                    <span class="text-[9px] text-gray-400">${new Date(m.created_at).toLocaleString([], { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="text-sm text-gray-700 leading-relaxed break-words">
                    ${cleanContent}
                </div>
            </div>
        `;
        container.appendChild(bubble);
        
        // MesajÄ± okundu iÅŸaretle
        if (!isMe && !m.is_read) {
            supabaseClient.from('messages').update({ is_read: true }).eq('id', m.id).then(()=>{});
        }
    });

    container.scrollTop = container.scrollHeight;
}
// 2. MESAJI KAPATMA
function closeMessageView() {
    const viewer = document.getElementById("view-message");
    if(viewer) viewer.classList.add("hidden-view");
    document.body.style.overflow = "auto";
}
/* --- GÃœNCELLENMÄ°Åž: sendReply (ROKET HIZI - SIFIR GECÄ°KME) --- */
async function sendReply() {
    const inputEl = document.getElementById("reply-input");
    const content = inputEl.value.trim();
    const btn = document.querySelector("#view-message button[onclick='sendReply()']") || document.querySelector("button[onclick='sendReply()']");

    if (!content && !currentAttachmentFile) {
        showToast("Warning", "Please write a message.", "error");
        return;
    }

    if (!currentPartnerId || !currentSubject) {
        showToast("Error", "Chat connection lost.", "error");
        return;
    }

    const originalText = btn ? btn.innerHTML : "SEND";
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; }

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Please login again.");

        let myDisplayName = "My Company"; 
        const { data: profile } = await supabaseClient.from('profiles').select('company_name').eq('id', user.id).single();
        if (profile && profile.company_name) myDisplayName = profile.company_name;

        const replySubject = currentSubject.startsWith("Re:") ? currentSubject : "Re: " + currentSubject;
        
        let finalContent = content;

        // Dosya varsa Ã¶nce onu yÃ¼kle (BurasÄ± mecbur bekleyecek, dosya yÃ¼klenmeden mesaj gitmez)
        if (currentAttachmentFile) {
             const publicUrl = await uploadFileToSupabase(currentAttachmentFile, 'chat');
             finalContent += `\n\n[FILE_ATTACHMENT|${currentAttachmentFile.name}|${publicUrl}]`;
        }

        // --- HIZLANDIRMA BURADA BAÅžLIYOR ---

        // 1. ANINDA GÃ–RÃœNTÃœ (Optimistic UI)
        // VeritabanÄ±nÄ± beklemeden ekranÄ± gÃ¼ncelle
        inputEl.value = ""; // Kutuyu temizle
        if (typeof removeAttachment === "function") removeAttachment(); 

        // SaÄŸdaki sohbete balonu ekle
        appendLocalMessage(finalContent); 
        
        // Soldaki listeyi gÃ¼ncelle
        manualInboxUpdate(currentPartnerId, currentSubject, finalContent, false); 


        // 2. ARKA PLANDA GÃ–NDER (KullanÄ±cÄ± beklemez)
        const { error } = await supabaseClient.from('messages').insert([{
            sender_id: user.id,
            receiver_id: currentPartnerId,
            content: finalContent,
            subject: replySubject,
            related_company_name: myDisplayName,
            msg_type: 'message',
            is_read: false
        }]);

        if (error) {
            // Hata olursa kullanÄ±cÄ±yÄ± uyar (Ã‡ok nadir olur)
            showToast("Error", "Message failed to send!", "error");
            console.error(error);
        }

    } catch (error) {
        console.error(error);
        showToast("Error", "Failed to send: " + error.message, "error");
    } finally {
        if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
    }
}
// 1. MEVCUT MESAJI SÄ°L
// 1. MEVCUT MESAJI SÄ°L (PROFESYONEL MODAL Ä°LE)
// MEVCUT MESAJI SÄ°L (HEM EKRANDAN HEM VERÄ°TABANINDAN)
// 1. MEVCUT MESAJI SÄ°L (HEM EKRANDAN HEM VERÄ°TABANINDAN)
/* --- GÃœNCELLENMÄ°Åž SÄ°LME VE OKUNMADI Ä°ÅžLEMLERÄ° --- */

// 1. MESAJI (SOHBETÄ°) SÄ°L
/* --- deleteCurrentMessage (TEK MESAJI BENDEN GÄ°ZLE) --- */
function deleteCurrentMessage() {
    if (!currentOpenMessageId) return;

    openDeleteModal("Remove this conversation from your view?", async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            // Bu mesajÄ±n detayÄ±nÄ± bul (GÃ¶nderen ben miyim alÄ±cÄ± mÄ±?)
            // ID'den mesajÄ± Ã§ekip bakabiliriz ama thread'i komple sildiÄŸimiz iÃ§in
            // deleteThread fonksiyonunu Ã§aÄŸÄ±rmak daha mantÄ±klÄ±.
            // Ancak tek mesaj silme butonu detay sayfasÄ±nda olduÄŸu iÃ§in:
            
            const item = inboxData.find(m => m.id === currentOpenMessageId);
            if (item) {
                // Thread silme fonksiyonunu kullan (daha temiz)
                await deleteThread(null, item.title, item.partner_id, null);
                closeMessageView();
            } else {
                // EÄŸer listede yoksa manuel update dene (Yedek plan)
                await supabaseClient.from('messages').update({ sender_delete: true }).eq('id', currentOpenMessageId).eq('sender_id', user.id);
                await supabaseClient.from('messages').update({ receiver_delete: true }).eq('id', currentOpenMessageId).eq('receiver_id', user.id);
                
                closeMessageView();
                fetchInboxMessages(); // Listeyi tazele
            }

        } catch (error) {
            console.error("Delete error:", error);
            showToast("Error", "Could not delete.", "error");
        }
    });
}
// 2. OKUNMADI OLARAK Ä°ÅžARETLE
/* --- TEK MESAJI OKUNMADI YAP --- */
async function markAsUnreadCurrentMessage() {
    // ID kontrolÃ¼ (Ã–nceki adÄ±mda openMessage iÃ§inde bunu tanÄ±mlamÄ±ÅŸtÄ±k)
    if (!currentOpenMessageId) {
        showToast("Error", "No message selected.", "error");
        return;
    }

    try {
        // 1. DB GÃ¼ncelle: Bu ID'li mesajÄ± 'okunmadÄ±' (false) yap
        const { error } = await supabaseClient
            .from("messages")
            .update({ is_read: false })
            .eq("id", currentOpenMessageId);

        if (error) throw error;

        // 2. Local Listeyi GÃ¼ncelle (KÄ±rmÄ±zÄ± noktayÄ± geri getir)
        const item = inboxData.find(m => m.id === currentOpenMessageId);
        if(item) {
            item.unread = true;
        }

        // 3. EkranÄ± Yenile
        renderInboxItems(); // Sol menÃ¼deki kÄ±rmÄ±zÄ±yÄ± yakar
        
        // Mesaj ekranÄ±nÄ± kapatÄ±p listeye dÃ¶n (KullanÄ±cÄ± deÄŸiÅŸimi gÃ¶rsÃ¼n diye)
        closeMessageView();
        
        showToast("Marked Unread", "Conversation marked as unread.", "success");

    } catch (e) {
        console.error("Unread error:", e);
        showToast("Error", "Failed to update status.", "error");
    }
}
/* --- DOSYA EKLEME YÃ–NETÄ°MÄ° --- */

let currentAttachmentFile = null; // SeÃ§ilen dosyayÄ± hafÄ±zada tut

// 1. DOSYA SEÃ‡Ä°LÄ°NCE Ã‡ALIÅžIR
function handleFileSelect(input) {
    if (input.files && input.files[0]) {
        currentAttachmentFile = input.files[0];
        
        // Ã–nizleme alanÄ±nÄ± doldur
        const preview = document.getElementById("attachment-preview");
        const nameEl = document.getElementById("attachment-name");
        const sizeEl = document.getElementById("attachment-size");
        
        if (preview && nameEl) {
            nameEl.textContent = currentAttachmentFile.name;
            // Boyutu hesapla (KB veya MB)
            let size = currentAttachmentFile.size / 1024;
            let label = " KB";
            if(size > 1024) { size = size / 1024; label = " MB"; }
            
            if(sizeEl) sizeEl.textContent = size.toFixed(1) + label;

            // Kutuyu gÃ¶ster
            preview.classList.remove("hidden");
        }
    }
}

// 2. DOSYAYI KALDIR (X Butonu)
function removeAttachment() {
    currentAttachmentFile = null;
    document.getElementById("reply-file-input").value = ""; // Inputu sÄ±fÄ±rla
    
    // Kutuyu gizle
    const preview = document.getElementById("attachment-preview");
    if (preview) preview.classList.add("hidden");
}
let selectedLogoFile = null; // SeÃ§ilen dosyayÄ± tutar

function handleLogoSelect(input) {
  if (input.files && input.files[0]) {
    selectedLogoFile = input.files[0];
    
    // TarayÄ±cÄ±da Ã¶nizleme yap (Server'a gitmeden)
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById("edit-logo-img").src = e.target.result;
      document.getElementById("edit-logo-img").classList.remove("hidden");
      document.getElementById("edit-logo-icon").classList.add("hidden");
    }
    reader.readAsDataURL(selectedLogoFile);
  }
}
/* --- PROFÄ°L EKRANINDAN HIZLI LOGO DEÄžÄ°ÅžTÄ°RME --- */

async function uploadLogoDirectly(input) {
  if (!input.files || !input.files[0]) return;

  const file = input.files[0];
  
  // 1. KullanÄ±cÄ±ya hemen Ã¶nizleme gÃ¶ster (Bekletme)
  const reader = new FileReader();
  reader.onload = function(e) {
      const img = document.getElementById("p-logo-image");
      const icon = document.getElementById("p-default-icon");
      if(img) { img.src = e.target.result; img.classList.remove("hidden"); }
      if(icon) icon.classList.add("hidden");
  }
  reader.readAsDataURL(file);

  // 2. YÃ¼kleme Ä°ÅŸlemi BaÅŸlasÄ±n
  showToast("Uploading...", "Updating your logo...", "info");

  try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) throw new Error("Login required");

      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}-${Date.now()}.${fileExt}`;
      const filePath = `${fileName}`;

      // A. Storage'a YÃ¼kle
      const { error: uploadError } = await supabaseClient.storage
          .from('logos')
          .upload(filePath, file);

      if (uploadError) throw uploadError;

      // B. Public URL Al
      const { data: { publicUrl } } = supabaseClient.storage
          .from('logos')
          .getPublicUrl(filePath);

      // C. Sadece Profil Tablosundaki 'logo_url' alanÄ±nÄ± gÃ¼ncelle
      const { error: dbError } = await supabaseClient
          .from('profiles')
          .update({ logo_url: publicUrl, updated_at: new Date() })
          .eq('id', user.id);

      if (dbError) throw dbError;

      // D. BaÅŸarÄ±lÄ±
      showToast("Success", "Logo updated successfully!", "success");

      // E. Local Database'i GÃ¼ncelle (Sayfa yenilenmeden hafÄ±zada kalsÄ±n)
      const localCompany = database.find(c => c.id == user.id);
      if (localCompany) {
          localCompany.logo_url = publicUrl;
      }

  } catch (error) {
      console.error(error);
      showToast("Error", "Logo upload failed: " + error.message, "error");
      // Hata olursa eski haline dÃ¶ndÃ¼rmek iÃ§in sayfayÄ± yenileyebilir veya eski URL'i geri yÃ¼kleyebiliriz
  }
}
/* --- SERTÄ°FÄ°KA YÃ–NETÄ°MÄ° (EKLE - DÃœZENLE - SÄ°L) --- */

let currentEditingCertId = null;

// 1. MODALI AÃ‡
/* --- GÃœNCELLENMÄ°Åž: openCertModal (PRO LOCK + DATE) --- */
function openCertModal(certId = null) {
  // Pro deÄŸilse ve limiti dolduysa engelle (Sadece yeni eklemede)
  if ((!certId || certId === -1)) {
      if (!checkPlanLimit('certs')) return;
  }

  const modal = document.getElementById("cert-modal");
  const form = document.getElementById("cert-form");
  const title = document.getElementById("cert-modal-title");
  
  if (!modal) return;
  modal.classList.remove("pointer-events-none", "opacity-0");
  if(form) form.reset();
  removeCertFile(); // DosyayÄ± temizle

  // --- PRO KONTROLÃœ (KÄ°LÄ°T MEKANÄ°ZMASI) ---
  const isPro = (selectedCompany && selectedCompany.subscription_tier === 'pro');
  const fileLock = document.getElementById("cert-file-lock");
  const fileInput = document.getElementById("cert-file-input");
  const proBadge = document.getElementById("cert-file-pro-badge");
  const fileLabel = document.getElementById("cert-file-label");

  if (isPro) {
      if(fileLock) fileLock.classList.add("hidden"); // Kilidi aÃ§
      if(proBadge) proBadge.classList.add("hidden"); 
      if(fileInput) fileInput.disabled = false;
      if(fileLabel) fileLabel.onclick = null;
  } else {
      if(fileLock) fileLock.classList.remove("hidden"); // Kilitle
      if(proBadge) proBadge.classList.remove("hidden");
      if(fileInput) fileInput.disabled = true;
      // Kilitli alana tÄ±klayÄ±nca Upgrade'i aÃ§
      if(fileLabel) fileLabel.onclick = (e) => { e.preventDefault(); toggleModal('modal-upgrade'); };
  }

  // --- DÃœZENLEME MODU ---
  if (certId && certId !== -1) {
    currentEditingCertId = certId;
    if(title) title.textContent = "Edit Certificate";
    
    const cert = selectedCompany.certificates.find(c => c.id === certId);
    if (cert) {
        document.getElementById("cert-name").value = cert.name || "";
        document.getElementById("cert-issuer").value = cert.issuer || "";
        document.getElementById("cert-date").value = cert.expiry_date || ""; // Tarihi doldur

        // Varsa DosyayÄ± GÃ¶ster
        if (cert.file_url) {
            existingCertFileUrl = cert.file_url;
            const linkEl = document.getElementById("current-cert-link");
            linkEl.href = cert.file_url;
            linkEl.classList.remove("hidden");
            document.getElementById("btn-remove-cert-file").classList.remove("hidden");
            document.getElementById("cert-file-text").textContent = "Change File";
        }
    }
  } else {
    currentEditingCertId = null;
    if(title) title.textContent = "Add New Certificate";
  }
}

function closeCertModal() {
  const modal = document.getElementById("cert-modal");
  if (modal) modal.classList.add("pointer-events-none", "opacity-0");
  currentEditingCertId = null;
}

// 2. KAYDET (Supabase)
/* --- GÃœNCELLENMÄ°Åž: saveCert (SEKME SORUNU Ã‡Ã–ZÃœLDÃœ) --- */
async function saveCert() {
  const btn = document.querySelector("#cert-form button[type='submit']");
  const originalText = btn.textContent;
  btn.textContent = "Saving...";
  btn.disabled = true;

  try {
    const name = document.getElementById("cert-name").value.trim();
    const issuer = document.getElementById("cert-issuer").value.trim();
    const date = document.getElementById("cert-date").value;

    if (!name) { showToast("Missing Info", "Certificate name required.", "error"); return; }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("Session expired.");

    // --- DOSYA YÃœKLEME ---
    let finalUrl = existingCertFileUrl;
    
    if (currentCertFile) {
        if (selectedCompany.subscription_tier === 'pro') {
            const fileExt = currentCertFile.name.split('.').pop();
            const filePath = `${user.id}/cert_${Date.now()}.${fileExt}`;
            
            const { error: uploadError } = await supabaseClient.storage
                .from('certificate-docs')
                .upload(filePath, currentCertFile);

            if (uploadError) throw uploadError;
            
            const { data } = supabaseClient.storage.from('certificate-docs').getPublicUrl(filePath);
            finalUrl = data.publicUrl;
        }
    }
    
    if (!currentCertFile && !existingCertFileUrl) finalUrl = null;

    // --- VERÄ° HAZIRLAMA ---
    const certObj = {
        name: name,
        issuer: issuer,
        expiry_date: date,
        file_url: finalUrl,
        updated_at: new Date().toISOString()
    };

    let currentCerts = [...(selectedCompany.certificates || [])];

    if (currentEditingCertId) {
        const index = currentCerts.findIndex(c => c.id === currentEditingCertId);
        if (index > -1) {
            currentCerts[index] = { ...currentCerts[index], ...certObj };
        }
    } else {
        currentCerts.push({ id: Date.now(), ...certObj });
    }

    // --- DB GÃœNCELLEME ---
    const { error } = await supabaseClient
      .from('profiles')
      .update({ certificates: currentCerts, updated_at: new Date() })
      .eq('id', user.id);

    if (error) throw error;

    selectedCompany.certificates = currentCerts;
    const localRef = database.find(c => c.id == user.id);
    if(localRef) localRef.certificates = currentCerts;

    // --- KRÄ°TÄ°K DÃœZELTME BURADA ---
    openProfile(user.id);      // Profili yÃ¼kle
    switchProfileTab('certs'); // HIZLICA SERTÄ°FÄ°KA SEKMESÄ°NE DÃ–N
    
    showToast("Success", "Certificate saved!", "success");
    closeCertModal();

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// 3. SÄ°LME
// 3. SÄ°LME (CERTIFICATE) - YENÄ° MODAL Ä°LE
function deleteCert(certId, certName) {
    // TarayÄ±cÄ± confirm'i yerine kendi modalÄ±mÄ±zÄ± Ã§aÄŸÄ±rÄ±yoruz
    openDeleteModal(`Are you sure you want to delete "${certName}"?`, async () => {
        
        // --- ASIL SÄ°LME Ä°ÅžLEMÄ° BURADA BAÅžLIYOR ---
        try {
            let currentCerts = [];
            
            if (certId === -1) {
                currentCerts = selectedCompany.certificates.filter(c => c !== certName);
            } else {
                currentCerts = selectedCompany.certificates.filter(c => c.id !== certId);
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({ certificates: currentCerts, updated_at: new Date() })
                .eq('id', user.id);

            if (error) throw error;

            selectedCompany.certificates = currentCerts;
            const localRef = database.find(c => c.id == user.id);
            if(localRef) localRef.certificates = currentCerts;

            openProfile(user.id);
            showToast("Deleted", "Certificate removed successfully.", "success");
            
        } catch (error) {
            showToast("Error", "Delete failed: " + error.message, "error");
        }
    });
}
// --- VERÄ°TABANINDAN GÃœNCEL VERÄ°LERÄ° Ã‡EKME ---
/* --- GÃœNCELLENMÄ°Åž: initRealData (COUNTRY VERÄ°SÄ° EKLENDÄ°) --- */
async function initRealData() {
  console.log("Supabase'den veriler Ã§ekiliyor...");
  
  // 1. Supabase'den tÃ¼m profilleri al
  const { data: profiles, error } = await supabaseClient
    .from('profiles')
    .select('*');

  if (error) { console.error("Veri Ã§ekme hatasÄ±:", error); return; }
  if (!profiles) return;

  // 2. Verileri formatla
  profiles.forEach(p => {
// ðŸ‘‡ðŸ‘‡ðŸ‘‡ BURASI YENÄ°: EÄžER BU PROFÄ°L ADMÄ°N Ä°SE LÄ°STEYE EKLEME ðŸ‘‡ðŸ‘‡ðŸ‘‡
    if (p.email === ADMIN_EMAIL) {
        return; // DÃ¶ngÃ¼yÃ¼ burada kes, bu ÅŸirketi listeye alma
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† ---------------------------------------------------- ðŸ‘†ðŸ‘†ðŸ‘†
    const pId = p.id;
    const realData = {
      id: pId,
      name: p.company_name || "New Company",
      city: p.city || "Konum Yok",
      
      // âœ… Ä°ÅžTE EKSÄ°K OLAN SATIR BUYDU:
      country: p.country || "Turkey",
address: p.address || "", // âœ… BU SATIRI EKLEYÄ°N
      email: p.email || "", 
service_details: p.service_details || "",
owner_name: p.owner_name,
      owner_role: p.owner_role,
      owner_linkedin: p.owner_linkedin,
      owner_photo_url: p.owner_photo_url,
      
      sector: p.sector || "construction",
      desc: p.description || "",
      tagline: p.tagline || "",
      type_label: p.company_type, 
      size_label: p.company_size,
      year_label: p.founded_year,
      services: p.services ? p.services.split(',').map(s=>s.trim()) : [],
      logo_url: p.logo_url,
      website: p.website,
      phone: p.phone,
      contact_email: p.contact_email,
      certificates: p.certificates || [],
      projects: p.projects || [],
      assets: p.assets || [],
      trust: "verified",
      meta: { references: 80, delivery: 85, years: 5, financial: 80, digital: 70 }
    };

    const existingIndex = database.findIndex(c => c.id == pId);
    if (existingIndex > -1) {
      database[existingIndex] = { ...database[existingIndex], ...realData };
    } else {
      database.unshift(realData);
    }
  });

  // 3. Filtreleri ve EkranÄ± Yenile
  dedupeDatabasePreferReal();
  populateCountryFilter(); // <-- ArtÄ±k verilerde 'country' olduÄŸu iÃ§in burasÄ± Ã§alÄ±ÅŸacak
  
  if (typeof isSearchActive !== 'undefined' && !isSearchActive) {
      renderShowcase(); 
  } else {
      const q = document.getElementById("search-input") ? document.getElementById("search-input").value : "";
      renderSearchResults(q);
  }
  
  renderTopCompanies();

  // AÃ§Ä±k profil varsa gÃ¼ncelle
  if (selectedCompany) {
      const updatedCompany = database.find(c => c.id === selectedCompany.id);
      if(updatedCompany) {
          selectedCompany = updatedCompany;
          openProfile(selectedCompany.id);
      }
  }
}
// TÃœMÃœNÃœ OKUNDU OLARAK Ä°ÅžARETLE
/* --- TÃœMÃœNÃœ OKUNDU YAP (GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž) --- */
/* --- TÃœMÃœNÃœ OKUNDU YAP (AKILLI KONTROL) --- */
async function markAllInboxRead() {
  const btn = document.querySelector("#inbox-panel button[onclick='markAllInboxRead()']");
  
  // 1. Ã–NCE KONTROL ET: HiÃ§ okunmamÄ±ÅŸ mesaj var mÄ±?
  // inboxData listesindeki 'unread' olanlarÄ± sayÄ±yoruz
  const unreadExists = inboxData.some(item => item.unread === true);

  if (!unreadExists) {
      // EÄŸer hepsi zaten okunmuÅŸsa, boÅŸuna sunucuya gitme ve "Success" deme.
      // Sadece kullanÄ±cÄ±ya bilgi ver ve fonksiyondan Ã§Ä±k.
      showToast("Up to date", "All messages are already read.", "info");
      return; 
  }

  // --- Buradan sonrasÄ± aynÄ±, iÅŸlem baÅŸlÄ±yor ---
  if(btn) btn.disabled = true;

  try {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("Login required");

    // 1. VeritabanÄ±nÄ± GÃ¼ncelle
    const { error } = await supabaseClient
      .from("messages")
      .update({ is_read: true })
      .eq("receiver_id", user.id)
      .eq("is_read", false);

    if (error) throw error;

    // 2. Yerel listeyi gÃ¼ncelle
    inboxData.forEach(item => item.unread = false);
    renderInboxItems();

    // 3. BaÅŸarÄ±lÄ± MesajÄ± (Sadece gerÃ§ekten bir ÅŸeyler deÄŸiÅŸtiyse Ã§Ä±kar)
    showToast("Success", "All messages marked as read.", "success");

  } catch (e) {
    console.error("Mark all read error:", e);
    showToast("Error", "Could not update status.", "error");
  } finally {
    if(btn) btn.disabled = false;
  }
}

/* --- EKSÄ°K OLAN FONKSÄ°YON: TÃœMÃœNÃœ SÄ°L --- */
function deleteAllInbox() {
    // 1. Hangi kutuda olduÄŸumuzu kontrol et
    const isInbox = currentInboxView === 'inbox';
    const label = isInbox ? "received messages" : "sent messages";

    // 2. Onay ModalÄ± AÃ§
    openDeleteModal(`Are you sure you want to delete all ${label}?`, async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error("Login required");

            // 3. VeritabanÄ± Ä°ÅŸlemi (Soft Delete)
            let query = supabaseClient.from('messages');
            
            if (isInbox) {
                // Gelen Kutusunu Temizle (receiver_delete = true)
                query = query.update({ receiver_delete: true }).eq('receiver_id', user.id);
            } else {
                // GÃ¶nderilenleri Temizle (sender_delete = true)
                query = query.update({ sender_delete: true }).eq('sender_id', user.id);
            }

            const { error } = await query;
            if (error) throw error;

            // 4. Yerel Listeyi GÃ¼ncelle
            // SildiÄŸimiz kutuya ait olmayanlarÄ± tut, diÄŸerlerini at
            inboxData = inboxData.filter(item => {
                if (isInbox) {
                    return item.isSentByMe === true; // Inbox siliyorsak, Sent'ler kalsÄ±n
                } else {
                    return item.isSentByMe === false; // Sent siliyorsak, Inbox'lar kalsÄ±n
                }
            });

            // 5. EkranÄ± Yenile
            renderInboxItems();
            showToast("Cleared", `All ${label} deleted successfully.`, "success");

        } catch (error) {
            console.error("Delete All Error:", error);
            showToast("Error", "Failed to delete: " + error.message, "error");
        }
    });
}

/* --- AKILLI VÄ°TRÄ°N VE ARAMA SÄ°STEMÄ° --- */

    let showcaseInterval = null; // 5 saniyelik zamanlayÄ±cÄ±
    let isSearchActive = false;  // Arama modunda mÄ±yÄ±z?

    // 1. ANA RENDER FONKSÄ°YONU (KartlarÄ± Ã‡izer)
    // Bu fonksiyon sadece "Verilen Listeyi Ekrana Basmakla" gÃ¶revlidir.
    // 1. ANA RENDER FONKSÄ°YONU (KartlarÄ± Ã‡izer) - DÃœZELTÄ°LMÄ°Åž VERSÄ°YON
    // 1. ANA RENDER FONKSÄ°YONU (GÃœNCELLENMÄ°Åž - TÄ°P ROZETLÄ°)
    function drawCardsToScreen(companyList, mode = "showcase") {
        const container = document.getElementById("card-container");
        const resultCount = document.getElementById("result-count");
        
        if (!container) return;
        container.innerHTML = "";

        // BaÅŸlÄ±k ve SayÄ± GÃ¼ncelleme
        if (resultCount) {
            if (mode === "search") {
                resultCount.innerHTML = `
                    <span class="text-sm text-gray-500 font-normal">Search Results:</span> 
                    <span class="text-BTrustOn-accent">${companyList.length}</span> 
                    <span class="text-sm text-gray-500 font-normal">companies found</span>`;
            } else {
                resultCount.innerHTML = `
                    <span class="text-sm text-gray-500 font-normal">Live Showcase:</span> 
                    <span class="text-emerald-600 animate-pulse">Active</span> 
                    <span class="text-[10px] text-gray-400 ml-2">(Refreshing every 5s)</span>`;
            }
        }

        if (companyList.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-gray-500">No companies found matching your criteria.</p>
                </div>`;
            return;
        }

        companyList.forEach((company) => {
if (company.email === ADMIN_EMAIL || company.contact_email === ADMIN_EMAIL) {
                return; // Admin ise bu turu pas geÃ§, ekrana Ã§izme
            }
            const score = computeScore(company.meta);
            const desc = currentLang === "tr" && company.desc_tr ? company.desc_tr : company.desc;
            const services = currentLang === "tr" && company.services_tr ? company.services_tr : company.services;
            
            // VeritabanÄ±ndaki "type" veya "type_label" alanÄ±nÄ± kullanÄ±yoruz
            const compType = company.type_label || company.type || "Company";

            const card = document.createElement("div");
            card.className = "bg-white/90 border border-gray-100 rounded-2xl p-5 shadow-glass flex flex-col h-full hover:border-BTrustOn-accent hover:shadow-lg hover:-translate-y-1 transition cursor-pointer fade-in";
            
            card.onclick = () => openProfile(company.id);

            card.innerHTML = `
              <div class="flex-1 flex flex-col gap-3"> 
                  <div class="flex items-start justify-between gap-2">
                    <div class="flex-1 min-w-0"> <h3 class="text-sm font-bold text-BTrustOn-primary mb-1.5 truncate pr-2">
                        ${company.name}
                      </h3>
                      
                      <div class="flex flex-wrap items-center gap-2 mb-1">
                        ${getCompanyTypeBadge(compType)}
                        <span class="text-[10px] text-gray-400 flex items-center gap-1 shrink-0">
                        <span class="w-1 h-1 rounded-full bg-gray-300"></span> 
                        ${company.city}, ${company.country || "TR"}
                        </span>
                      </div>

                    </div>
                    <div class="text-right shrink-0 pl-2">
                      <div class="text-xs font-header font-bold text-BTrustOn-primary leading-none">
                        ${score}<span class="text-[10px] text-gray-400">/100</span>
                      </div>
                      <div class="text-[10px] text-emerald-500 font-semibold mt-0.5">
                        ${getScoreLabel(score)}
                      </div>
                    </div>
                  </div>

                  <p class="text-xs text-gray-600 line-clamp-3 leading-relaxed">
                    ${desc}
                  </p>

                  <div class="flex flex-wrap gap-1.5">
                    ${(services || []).slice(0, 3).map(s => `
                      <span class="text-[10px] px-2 py-1 rounded-full bg-slate-50 border border-slate-200 text-slate-600">${s}</span>
                    `).join("")}
                  </div>
              </div>

              <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-100">
                <div class="flex items-center gap-2">
                  ${getTrustBadge(company)}
                </div>
                <button class="text-[11px] font-bold text-BTrustOn-accent flex items-center gap-1 group">
                  <span>${t("btn_view")}</span> <i class="fa-solid fa-arrow-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
                </button>
              </div>
            `;
            container.appendChild(card);
        });
    }

    // 2. VÄ°TRÄ°N MODU (Rastgele 12 Åžirket)
    // 2. VÄ°TRÄ°N MODU (Rastgele 12 Åžirket)
    function renderShowcase() {
        // EÄŸer arama yapÄ±lÄ±yorsa vitrin Ã§alÄ±ÅŸmasÄ±n
        if (isSearchActive) return;

        // ðŸ‘‡ðŸ‘‡ðŸ‘‡ BURASI YENÄ°: ADMÄ°NÄ° FÄ°LTRELE ðŸ‘‡ðŸ‘‡ðŸ‘‡
        const cleanList = database.filter(c => 
            c.email !== ADMIN_EMAIL && c.contact_email !== ADMIN_EMAIL
        );
        // ðŸ‘†ðŸ‘†ðŸ‘† -------------------------------- ðŸ‘†ðŸ‘†ðŸ‘†

        // VeritabanÄ±nÄ± karÄ±ÅŸtÄ±r (TemizlenmiÅŸ liste Ã¼zerinden)
        const shuffled = [...cleanList].sort(() => Math.random() - 0.5);
        
        // Ä°lk 12 tanesini al
        const showcaseList = shuffled.slice(0, 12);
        
        drawCardsToScreen(showcaseList, "showcase");
    }

    // 3. ARAMA MODU (Filtreli Liste)
    // 3. ARAMA VE LÄ°STELEME MODU (GÃœNCELLENMÄ°Åž)
   /* --- GÃœNCELLENMÄ°Åž: renderSearchResults (DERÄ°N ARAMA) --- */

/* ===== LIVE DATA HYGIENE: prevent duplicates between demo + real profiles ===== */
function isRealCompany(c){
  // Supabase UUID ids are long strings; demo cards are usually numbers
  return (typeof c?.id === "string" && c.id.length > 20) || !!c?.email;
}

function dedupeDatabasePreferReal(){
  const seen = new Map();
  const out = [];

  const norm = (v) => String(v || "").trim().toLowerCase();

  const score = (c) => {
    let s = 0;
    if (isRealCompany(c)) s += 1000;
    if (c?.verification_status === "verified") s += 100;
    if (c?.subscription_tier && c.subscription_tier !== "free") s += 10;
    if (c?.trust_score) s += Number(c.trust_score) || 0;
    return s;
  };

  for (const c of database){
    const taxKey = c?.tax_id ? ("t:" + norm(c.tax_id)) : "";
    const emailKey = c?.email ? ("e:" + norm(c.email)) : "";
    const cityKey = norm((String(c.city || "").split(",")[0] || "").trim());
    const baseKey = ("n:" + norm(c.name) + "|c:" + cityKey);
    const key = taxKey || emailKey || baseKey;
    if (!key.trim()) { out.push(c); continue; }

    if (!seen.has(key)){
      seen.set(key, c);
      out.push(c);
      continue;
    }

    const prev = seen.get(key);
    if (score(c) > score(prev)){
      const idx = out.indexOf(prev);
      if (idx > -1) out[idx] = c;
      seen.set(key, c);
    }
    // else ignore c
  }

  // mutate const array in-place
  database.length = 0;
  database.push(...out);
}

function getSearchableCompanies(){
  const clean = database.filter(c => c.email !== ADMIN_EMAIL && c.contact_email !== ADMIN_EMAIL);
  const real = clean.filter(isRealCompany);
  // If there are no real profiles yet, fall back to demo cards so UI doesn't look empty
  return real.length ? real : clean;
}

function renderSearchResults(query) {
    const q = (query || "").toLowerCase().trim();

    // âœ… Always keep the list de-duplicated (prevents double cards)
    try { dedupeDatabasePreferReal(); } catch(e) {}

    // A. FÄ°LTRELEME
    let filtered = database.filter((company) => {
        // 1. SektÃ¶r Filtresi (EÄŸer "All" deÄŸilse eÅŸleÅŸmeli)
        if (currentSector !== "all" && company.sector !== currentSector) return false;
        
        // 2. Ãœlke Filtresi (EÄŸer "All" deÄŸilse eÅŸleÅŸmeli)
        // 2. Ãœlke Filtresi (GÃœNCEL - Direkt Veriden)
        if (currentCountryFilter !== "all") {
            // ArtÄ±k ÅŸehri parÃ§alamÄ±yoruz, direkt 'country' sÃ¼tununa bakÄ±yoruz
            if (company.country !== currentCountryFilter) return false;
        }

        // 3. METÄ°N ARAMASI (HAYSTACK MANTIÄžI)
        if (!q) return true; // Arama kutusu boÅŸsa herkesi gÃ¶ster

        // --- DERÄ°N VERÄ° TOPLAMA ---
        
        // a. Temel Bilgiler
        const baseInfo = [
            company.name, 
            company.city, 
            company.sector, 
            company.type_label,
            company.desc, 
            company.tagline
        ].join(" ").toLowerCase();

        // b. Hizmetler (Array)
        const servicesText = (company.services || []).join(" ").toLowerCase();

        // c. VarlÄ±klar (Assets - Obje Dizisi)
        // Asset'in Tipini ve Ã–zelliklerini (Spec) alÄ±yoruz
        const assetsText = (company.assets || []).map(a => 
            `${a.type} ${a.spec} ${a.location}`
        ).join(" ").toLowerCase();

        // d. Projeler (Projects - Obje Dizisi)
        // Proje baÅŸlÄ±ÄŸÄ±nÄ± ve aÃ§Ä±klamasÄ±nÄ± alÄ±yoruz
        const projectsText = (company.projects || []).map(p => 
            `${p.title} ${p.desc} ${p.loc}`
        ).join(" ").toLowerCase();

        // e. Sertifikalar (Certificates)
        // Hem string hem obje formatÄ±nÄ± destekleyelim
        const certsText = (company.certificates || []).map(c => {
            if (typeof c === 'string') return c;
            return `${c.name} ${c.issuer}`;
        }).join(" ").toLowerCase();

        // --- DEVASA ARAMA HAVUZU (HAYSTACK) ---
        // TÃ¼m verileri tek bir uzun metinde birleÅŸtir
        const fullHaystack = `
            ${baseInfo} 
            ${servicesText} 
            ${assetsText} 
            ${projectsText} 
            ${certsText}
        `;

        // Aranan kelime bu dev metnin iÃ§inde geÃ§iyor mu?
        return fullHaystack.includes(q);
    });

    // B. SIRALAMA
    filtered = sortCompanyList(filtered);

    // C. EKRANA BASMA
    drawCardsToScreen(filtered, "search");
}

    // 4. BAÅžLATICI VE YÃ–NETÄ°CÄ° (Controller)
    function initShowcaseSystem() {
        // Ä°lk aÃ§Ä±lÄ±ÅŸta bir kere vitrini gÃ¶ster
        renderShowcase();

        // 5 Saniyede bir deÄŸiÅŸtiren zamanlayÄ±cÄ±yÄ± baÅŸlat
        startShowcaseTimer();
    }

    function startShowcaseTimer() {
        if (showcaseInterval) clearInterval(showcaseInterval);
        
        showcaseInterval = setInterval(() => {
            // Sadece arama yapÄ±lmÄ±yorsa vitrini yenile
            if (!isSearchActive) {
                renderShowcase();
            }
        }, 5000); // 5000 ms = 5 saniye
    }

    // Arama kutusuna her basÄ±ldÄ±ÄŸÄ±nda bu Ã§alÄ±ÅŸacak
    // (Eski renderCards yerine bunu kullanacaÄŸÄ±z)
    function handleSearchInput(value) {
        const query = value.trim();

        if (query === "" && currentSector === "all") {
            // Arama kutusu boÅŸaldÄ± -> VÄ°TRÄ°N MODUNA DÃ–N
            isSearchActive = false;
            renderShowcase();
            // ZamanlayÄ±cÄ± devam etsin
        } else {
            // Bir ÅŸeyler yazÄ±ldÄ± -> ARAMA MODUNA GEÃ‡
            isSearchActive = true;
            // Otomatik deÄŸiÅŸtirmeyi durdur (KullanÄ±cÄ± okuyabilsin diye)
            // Ä°sterseniz clearInterval yapabiliriz ama isSearchActive bayraÄŸÄ± yeterli.
            renderSearchResults(query);
        }
    }
    
    // SektÃ¶r ButonlarÄ± iÃ§in GÃ¼ncelleme
    // (Mevcut filterSector fonksiyonunuzun iÃ§inden burayÄ± Ã§aÄŸÄ±racaÄŸÄ±z)
    // AÅŸaÄŸÄ±daki fonksiyonu eskisiyle deÄŸiÅŸtirin veya entegre edin.
/* --- FÄ°LTRELEME VE SIRALAMA SÄ°STEMÄ° (ÃœLKE & SORT) --- */
    
    let currentCountryFilter = "all";
    let currentSortOption = "score_desc";

    // 1. Åžehirden Ãœlkeyi AyÄ±kla (Ã–rn: "Ankara, TR" -> "TR")
    function getCountryFromCity(cityString) {
        if (!cityString) return "";
        if (cityString.includes(",")) {
            return cityString.split(",")[1].trim(); 
        }
        return cityString.trim(); // VirgÃ¼l yoksa direkt kendisini al
    }

    // 2. Ãœlke Kutusunu Doldur
    /* --- GÃœNCELLENMÄ°Åž: populateCountryFilter (DÄ°REKT VERÄ°DEN) --- */
function populateCountryFilter() {
    const countrySet = new Set();
    
    // VeritabanÄ±ndaki "country" alanlarÄ±nÄ± topla
    database.forEach(c => {
        if(c.country) countrySet.add(c.country);
    });

    const select = document.getElementById("country-filter");
    if(select) {
        select.innerHTML = '<option value="all">All Countries</option>';
        
        Array.from(countrySet).sort().forEach(country => {
            const option = document.createElement("option");
            option.value = country;
            option.textContent = country;
            select.appendChild(option);
        });
    }
}

    // 3. Ãœlke DeÄŸiÅŸince Ã‡alÄ±ÅŸÄ±r
    function handleCountryChange(countryVal) {
        currentCountryFilter = countryVal;
        
        // Vitrini durdur, arama moduna geÃ§ (Ã‡Ã¼nkÃ¼ filtreliyoruz)
        isSearchActive = true; 
        
        // Listeyi yenile
        const searchInput = document.getElementById("search-input");
        const query = searchInput ? searchInput.value.trim() : "";
        renderSearchResults(query);
    }

    // 4. SÄ±ralama DeÄŸiÅŸince Ã‡alÄ±ÅŸÄ±r
    function handleSortChange(sortValue) {
        currentSortOption = sortValue;
        
        // Vitrini durdur, arama moduna geÃ§ (SÄ±ralÄ± listeyi gÃ¶rmek istiyor)
        isSearchActive = true;
        
        // Listeyi yenile
        const searchInput = document.getElementById("search-input");
        const query = searchInput ? searchInput.value.trim() : "";
        renderSearchResults(query);
    }

    // 5. Listeyi SÄ±ralayan YardÄ±mcÄ± Fonksiyon
    function sortCompanyList(list) {
        let sorted = [...list]; // KopyasÄ±nÄ± al
        switch (currentSortOption) {
            case "score_desc": // Puan: YÃ¼ksekten DÃ¼ÅŸÃ¼ÄŸe
                sorted.sort((a, b) => computeScore(b.meta) - computeScore(a.meta));
                break;
            case "score_asc": // Puan: DÃ¼ÅŸÃ¼kten YÃ¼kseÄŸe
                sorted.sort((a, b) => computeScore(a.meta) - computeScore(b.meta));
                break;
            case "year_oldest": // YÄ±l: Eskiden Yeniye
                sorted.sort((a, b) => (parseInt(a.year_label)||2023) - (parseInt(b.year_label)||2023));
                break;
            case "year_newest": // YÄ±l: Yeniden Eskiye
                sorted.sort((a, b) => (parseInt(b.year_label)||2023) - (parseInt(a.year_label)||2023));
                break;
            case "name_asc": // Ä°sim: A-Z
                sorted.sort((a, b) => a.name.localeCompare(b.name));
                break;
        }
        return sorted;
    }
// --- TEKLÄ°F FORMU GÃ–NDERME (YENÄ°) ---
// Teklif ModalÄ±nÄ± AÃ§ma (ID parametresi eklendi)
/* --- GÃœNCELLENMÄ°Åž: openQuoteModal (MÄ°SAFÄ°R DOSYA KÄ°LÄ°DÄ° GERÄ° GELDÄ°) --- */
async function openQuoteModal(companyId, companyName) {
  // 1. Hedef bilgilerini doldur
  const targetNameEl = document.getElementById("quote-target-company");
  const inputName = document.getElementById("input-target-company");
  const inputId = document.getElementById("input-target-id");

  if (targetNameEl) targetNameEl.textContent = companyName || "";
  if (inputName) inputName.value = companyName || "";
  if (inputId) inputId.value = companyId || ""; 

  // 2. KULLANICI KONTROLÃœ VE DOSYA KUTUSU AYARI
  const { data: { session } } = await supabaseClient.auth.getSession();
  
  const fileInput = document.getElementById("quote-file");
  const fileLabel = fileInput.closest("label"); // "Select File" butonu
  const fileNameDisplay = document.getElementById("quote-file-name");
  const container = fileLabel.parentElement; // KapsayÄ±cÄ± div

  // UyarÄ± mesajÄ± daha Ã¶nce eklenmemiÅŸse oluÅŸtur (Dinamik Ekleme)
  let warningMsg = document.getElementById("guest-file-warning");
  if (!warningMsg) {
      warningMsg = document.createElement("span");
      warningMsg.id = "guest-file-warning";
      warningMsg.className = "text-[10px] text-amber-600 font-bold ml-2 hidden items-center gap-1";
      // TÄ±klayÄ±nca Ã¶nce Quote modalÄ±nÄ± kapatÄ±r, sonra Join modalÄ±nÄ± aÃ§ar
      warningMsg.innerHTML = '<i class="fa-solid fa-lock"></i> Please <a href="javascript:void(0)" onclick="toggleModal(\'modal-quote\'); setTimeout(() => toggleModal(\'modal-join\'), 200)" class="underline hover:text-amber-800">join to attach files</a>.';
      container.appendChild(warningMsg);
  }

  if (session) {
      // --- ÃœYE Ä°SE: Dosya seÃ§imi SERBEST ---
      fileInput.disabled = false;
      
      // GÃ¶rseli normal hale getir
      fileLabel.classList.remove("opacity-50", "cursor-not-allowed", "bg-gray-100");
      fileLabel.classList.add("cursor-pointer", "hover:bg-gray-50");
      fileLabel.title = ""; 
      
      // UyarÄ±yÄ± gizle
      warningMsg.classList.add("hidden");
      fileNameDisplay.classList.remove("hidden");
  } else {
      // --- MÄ°SAFÄ°R Ä°SE: Dosya seÃ§imi YASAK ---
      fileInput.disabled = true; // TÄ±klamayÄ± engelle
      fileInput.value = ""; // Varsa seÃ§ili dosyayÄ± temizle
      fileNameDisplay.textContent = "";

      // GÃ¶rseli pasif (gri) hale getir
      fileLabel.classList.add("opacity-50", "cursor-not-allowed", "bg-gray-100");
      fileLabel.classList.remove("cursor-pointer", "hover:bg-gray-50");
      fileLabel.title = "Login required to attach files"; 
      
      // UyarÄ±yÄ± gÃ¶ster ve dosya ismini gizle
      warningMsg.classList.remove("hidden");
      fileNameDisplay.classList.add("hidden");
  }

  // 3. ModalÄ± AÃ§
  toggleModal("modal-quote");
}
// Teklifi VeritabanÄ±na GÃ¶nderme
/* --- GÃœNCELLENMÄ°Åž: handleQuoteSubmit (MÄ°SAFÄ°R DESTEKLÄ°) --- */
async function handleQuoteSubmit() {
  const btn = document.querySelector("#modal-quote button[type='submit']");
  const originalText = btn.textContent;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
  btn.disabled = true;

  try {
    // Mevcut oturumu kontrol et
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session ? session.user : null;

    // Form verilerini al
    const targetId = document.getElementById("input-target-id").value;
    const targetName = document.getElementById("input-target-company").value;
    const senderName = document.querySelector("#modal-quote input[name='name']").value.trim(); 
    const senderEmail = document.querySelector("#modal-quote input[name='email']").value.trim(); // Email inputu HTML'de var varsayÄ±yorum
    const subjectRaw = document.getElementById("quote-subject").value.trim();
    const messageRaw = document.querySelector("#modal-quote textarea[name='message']").value;
    const fileInput = document.getElementById("quote-file");

    let finalContent = messageRaw;
    let senderIdToSend = null;
    let displaySenderName = senderName;

    // 1. KULLANICI LOGIC'Ä°
    if (user) {
        // KayÄ±tlÄ± kullanÄ±cÄ±
        senderIdToSend = user.id;
        let myCompanyName = "Private User";
        const { data: profile } = await supabaseClient.from('profiles').select('company_name').eq('id', user.id).single();
        if (profile && profile.company_name) myCompanyName = profile.company_name;
        displaySenderName = `${senderName} (${myCompanyName})`;
    } else {
        // 2. MÄ°SAFÄ°R LOGIC'Ä° (GUEST)
        // Ä°letiÅŸim bilgilerini mesaja ekle
        finalContent = `--- GUEST REQUEST ---\nName: ${senderName}\nEmail: ${senderEmail}\n---------------------\n\n${messageRaw}`;
        displaySenderName = `${senderName} (Guest)`;
        
        // Misafir email girmemiÅŸse uyar
        if(!senderEmail) {
            throw new Error("Please enter your email so they can reply.");
        }
    }

    // Dosya varsa yÃ¼kle
    if (fileInput.files && fileInput.files[0]) {
        // Misafirler iÃ§in de dosya yÃ¼klemeye izin veriyoruz (Supabase bucket policy 'public' ise Ã§alÄ±ÅŸÄ±r)
        // EÄŸer Ã§alÄ±ÅŸmazsa try-catch ile yakalayabiliriz ama genelde auth gerekir. 
        // *GÃ¼venlik notu: Misafir upload'u iÃ§in storage bucket policy'sini de 'public insert' yapmak gerekir.
        // Åžimdilik sadece user varsa yÃ¼klesin diyebiliriz veya bucket ayarÄ±nÄ± aÃ§malÄ±sÄ±nÄ±z.
        if(user) {
            showToast("Uploading...", "Attaching your file...", "info");
            const publicUrl = await uploadFileToSupabase(fileInput.files[0], 'quotes');
            finalContent += `\n\n[FILE_ATTACHMENT|${fileInput.files[0].name}|${publicUrl}]`;
        } else {
             finalContent += `\n\n(File attachment skipped - Login required to attach files)`;
        }
    }

    // MesajÄ± GÃ¶nder
    const { error } = await supabaseClient.from('messages').insert([{
          sender_id: senderIdToSend, // Misafir ise NULL gider
          receiver_id: targetId,
          subject: user ? subjectRaw : `[LEAD] ${subjectRaw}`, // Misafir mesajÄ± belli olsun
          content: finalContent,
          related_company_name: displaySenderName, 
          msg_type: 'quote',
          is_read: false
      }]);

    if (error) throw error;

    showToast("Success", `Request sent to ${targetName}. They will contact you via email.`, "success");
    toggleModal('modal-quote');
    document.querySelector("#modal-quote form").reset();
    document.getElementById('quote-file-name').textContent = ""; 

    // EÄŸer giriÅŸ yapmÄ±ÅŸsa Sent kutusunu gÃ¼ncelle
    if(user) {
        manualInboxUpdate(targetId, subjectRaw, finalContent, true);
        const panel = document.getElementById("inbox-panel");
        if (panel && !panel.classList.contains("open")) toggleInbox();
        switchInboxView('sent');
    }

  } catch (error) {
    console.error(error);
    showToast("Error", error.message, "error");
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}
// 1. TEK BÄ°R SOHBETÄ° SÄ°L (HEM GELENÄ° HEM GÄ°DENÄ° SÄ°LER)
/* --- GÃœNCELLENMÄ°Åž: deleteThread (MÄ°SAFÄ°R SÄ°LME FÄ°XLENDÄ°) --- */
function deleteThread(msgId, title, partnerId, event) {
    if(event) { event.stopPropagation(); event.preventDefault(); }

    openDeleteModal("Remove this conversation view?", async () => {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error("Login required");

            const cleanSearchTitle = title.replace(/^(Re:\s*)+/i, '').trim();

            // Misafir KontrolÃ¼ (ID null mu, 'null' stringi mi?)
            const isGuest = !partnerId || partnerId === 'null' || partnerId === 'undefined';

            // 1. BENÄ°M GÃ–NDERDÄ°KLERÄ°MÄ° SÄ°L (sender_delete = true)
            // (Normalde misafire mesaj atamÄ±yoruz ama sistem tutarlÄ±lÄ±ÄŸÄ± iÃ§in kalsÄ±n)
            let querySent = supabaseClient
                .from('messages')
                .update({ sender_delete: true })
                .eq('sender_id', user.id)
                .ilike('subject', `%${cleanSearchTitle}%`);

            if (isGuest) {
                // EÄŸer alÄ±cÄ± misafirse (teorik olarak), receiver_id NULL'dur
                querySent = querySent.filter('receiver_id', 'is', 'null');
            } else {
                querySent = querySent.eq('receiver_id', partnerId);
            }

            // 2. BANA GELENLERÄ° SÄ°L (receiver_delete = true) -> ASIL Ã–NEMLÄ° KISIM BURASI
            let queryReceived = supabaseClient
                .from('messages')
                .update({ receiver_delete: true })
                .eq('receiver_id', user.id)
                .ilike('subject', `%${cleanSearchTitle}%`);

            if (isGuest) {
                // âœ… DÃœZELTME: .eq('sender_id', 'null') YERÄ°NE .filter('sender_id', 'is', 'null')
                // Bu sayede veritabanÄ± "UUID hatasÄ±" vermez, boÅŸ olanlarÄ± bulur.
                queryReceived = queryReceived.filter('sender_id', 'is', 'null');
            } else {
                queryReceived = queryReceived.eq('sender_id', partnerId);
            }

            // Ä°ki iÅŸlemi de paralel Ã§alÄ±ÅŸtÄ±r
            const [res1, res2] = await Promise.all([querySent, queryReceived]);

            if (res1.error) throw res1.error;
            if (res2.error) throw res2.error;

            // Ekran listesinden anÄ±nda kaldÄ±r
            inboxData = inboxData.filter(m => {
                // EÄŸer bu satÄ±rÄ±n partnerId'si bizim silmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zla aynÄ±ysa LÄ°STEDEN AT
                // Hem 'null' string hem de null deÄŸer kontrolÃ¼ yapÄ±yoruz
                const itemPartnerId = m.partner_id || 'null';
                const targetPartnerId = partnerId || 'null';
                
                // BaÅŸlÄ±k ve ID eÅŸleÅŸiyorsa filtrele (yani sil)
                if (String(itemPartnerId) === String(targetPartnerId) && m.title === title) {
                    return false; 
                }
                return true;
            });
            
            renderInboxItems();
            showToast("Removed", "Conversation removed.", "success");

        } catch (error) {
            console.error("Delete Error Details:", error);
            showToast("Error", "Could not remove thread: " + error.message, "error");
        }
    });
}
/* --- YENÄ° YARDIMCI FONKSÄ°YON: Dosya YÃ¼kle ve Link Al --- */
async function uploadFileToSupabase(file, folder = 'uploads') {
    if (!file) return null;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) throw new Error("User not logged in");

    // Benzersiz dosya ismi oluÅŸtur: user_id + timestamp + orjinal isim
    const fileExt = file.name.split('.').pop();
    const cleanName = file.name.replace(/[^a-zA-Z0-9]/g, '_'); // TÃ¼rkÃ§e karakter sorununu Ã¶nlemek iÃ§in
    const filePath = `${folder}/${user.id}-${Date.now()}-${cleanName}.${fileExt}`;

    // 1. Storage'a YÃ¼kle (Bucket adÄ± 'logos' veya 'files' olmalÄ±. 
    // Sizin kodunuzda 'logos' bucket'Ä± var gibi gÃ¶rÃ¼nÃ¼yor, onu kullanalÄ±m)
    const { error: uploadError } = await supabaseClient.storage
        .from('logos') 
        .upload(filePath, file);

    if (uploadError) throw uploadError;

    // 2. Public URL Al (TÄ±klanabilir Link)
    const { data } = supabaseClient.storage
        .from('logos')
        .getPublicUrl(filePath);

    return data.publicUrl;
}
/* --- EKSÄ°K OLAN FONKSÄ°YON: Profil Logosuna TÄ±klama --- */
function triggerProfileLogoUpload() {
    // GÃ¼venlik KontrolÃ¼: Åžu an ekranda aÃ§Ä±k olan ÅŸirket benim ÅŸirketim mi?
    const myId = localStorage.getItem("BTrustOn_my_company_id");
    
    if (selectedCompany && String(selectedCompany.id) === String(myId)) {
        // Gizli inputa tÄ±kla
        document.getElementById('profile-logo-input').click();
    } else {
        // BaÅŸkasÄ±nÄ±n profili ise tÄ±klanmasÄ±n (Opsiyonel: FotoÄŸrafÄ± bÃ¼yÃ¼tebilirsiniz)
        console.log("Cannot edit another company's logo.");
    }
}
/* --- YENÄ° YARDIMCI: Sohbet Balonunu AnÄ±nda Ekrana Bas --- */
function appendLocalMessage(content) {
    const container = document.getElementById("message-thread-container");
    if (!container) return;

    // EÄŸer "Start conversation..." yazÄ±sÄ± varsa temizle
    if (container.innerHTML.includes("Start the conversation")) container.innerHTML = "";

    // Tarih
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // SatÄ±r baÅŸlarÄ±nÄ± <br> yap
    let cleanContent = content.replace(/\n/g, '<br>');
    
    // Dosya eki formatÄ±nÄ± gÃ¶rselleÅŸtir (Opsiyonel)
    if (cleanContent.includes("[FILE_ATTACHMENT")) {
        cleanContent = cleanContent.replace(/\[FILE_ATTACHMENT\|(.*?)\|(.*?)\]/g, 
            '<div class="flex items-center gap-2 mt-2 p-2 bg-white border rounded-lg"><i class="fa-solid fa-paperclip text-BTrustOn-accent"></i> <span class="text-xs font-bold">$1</span></div>'
        );
    }

    const bubble = document.createElement("div");
    bubble.className = `flex justify-end mb-4 animate-fade-in`; // Biz gÃ¶nderdiÄŸimiz iÃ§in hep saÄŸda (justify-end)
    
    bubble.innerHTML = `
        <div class="max-w-[85%] bg-cyan-50 border border-cyan-100 rounded-tr-none p-4 rounded-xl shadow-sm">
            <div class="flex justify-between items-center mb-1 gap-4">
                <span class="text-[10px] font-bold text-BTrustOn-accent">ME</span>
                <span class="text-[9px] text-gray-400">${time}</span>
            </div>
            <div class="text-sm text-gray-700 leading-relaxed break-words">
                ${cleanContent}
            </div>
        </div>
    `;
    
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight; // En alta kaydÄ±r
}
/* --- YENÄ° YARDIMCI: DosyayÄ± Ä°ndirmeye Zorla --- */
async function downloadFile(fileUrl, fileName) {
    // TÄ±klama olayÄ±nÄ±n yukarÄ± (karta) gitmesini engelle (eÄŸer iÃ§ iÃ§e ise)
    if(event) { event.stopPropagation(); event.preventDefault(); }

    showToast("Downloading...", "Please wait while the file is prepared.", "info");

    try {
        // 1. DosyayÄ± veritabanÄ±ndan Ã§ek
        const response = await fetch(fileUrl);
        if (!response.ok) throw new Error("Network response was not ok");
        
        // 2. Veriyi Blob formatÄ±na Ã§evir
        const blob = await response.blob();
        
        // 3. GeÃ§ici bir indirme linki oluÅŸtur
        const blobUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = fileName; // Ä°ndirilecek dosyanÄ±n adÄ±
        
        // 4. Linke tÄ±kla ve temizle
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(blobUrl);

        showToast("Saved", "File downloaded successfully.", "success");

    } catch (error) {
        console.error("Download failed:", error);
        // Hata olursa kullanÄ±cÄ±yÄ± uyar ve yeni sekmede aÃ§mayÄ± dene (Yedek plan)
        showToast("Error", "Download failed, opening in new tab...", "error");
        window.open(fileUrl, '_blank');
    }
}
/* --- STATUS RENGÄ°NÄ° AYARLAYAN FONKSÄ°YON --- */
function getStatusBadge(status) {
    const s = (status || "").toLowerCase();
    
    // VarsayÄ±lan (Gri)
    let classes = "bg-gray-50 text-gray-600 border-gray-200"; 

    // 1. MÃ¼sait (YeÅŸil)
    if (s.includes("available") || s.includes("mÃ¼sait")) {
        classes = "bg-emerald-50 text-emerald-700 border-emerald-200";
    } 
    // 2. BakÄ±mda (SarÄ±/Turuncu)
    else if (s.includes("maintenance") || s.includes("bakÄ±m")) {
        classes = "bg-amber-50 text-amber-700 border-amber-200";
    } 
    // 3. Servis DÄ±ÅŸÄ± (KÄ±rmÄ±zÄ±)
    else if (s.includes("out") || s.includes("servis")) {
        classes = "bg-rose-50 text-rose-700 border-rose-200";
    }

    return `
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-[10px] font-bold border ${classes} uppercase tracking-wide whitespace-nowrap">
            ${status}
        </span>
    `;
}
/* --- DOÄžRULAMA SÄ°STEMÄ° MANTIÄžI --- */
/* --- Ã‡Ä°FT TARAFLI DOÄžRULAMA YÃ–NETÄ°MÄ° (EDÄ°TÃ–R + PROFÄ°L) --- */

// 1. BUTONA TIKLANINCA (Upgrade KontrolÃ¼)
/* --- GÃœNCELLENMÄ°Åž: handleVerifyClick (GARANTÄ°LÄ° Ã‡Ã–ZÃœM) --- */
function handleVerifyClick() {
    // Veri yoksa hata vermesin diye kontrol
    if (!selectedCompany) return;

    const tier = selectedCompany.subscription_tier || 'free';
    
    // 1. KullanÄ±cÄ± PRO ise formu aÃ§
    if (tier === 'pro') {
        toggleVerifyVisibility('unlocked');
        
        // 2. TarayÄ±cÄ±nÄ±n "hidden" sÄ±nÄ±fÄ±nÄ± kaldÄ±rmasÄ±nÄ± bekle (100ms)
        setTimeout(() => {
            // Hangi ekranÄ±n aÃ§Ä±k olduÄŸunu sÄ±nÄ±f kontrolÃ¼yle anla
            const editorView = document.getElementById("view-editor");
            // EÄŸer view-editor'de 'hidden-view' yoksa, editÃ¶rdeyiz demektir.
            const isEditorActive = editorView && !editorView.classList.contains("hidden-view");

            let targetContainer = null;
            let targetInput = null;

            if (isEditorActive) {
                // EditÃ¶rdeki kutuyu hedefle
                targetContainer = document.getElementById("verify-form-view");
                targetInput = document.getElementById("edit-tax-id");
            } else {
                // Profildeki (Widget) kutuyu hedefle
                targetContainer = document.getElementById("widget-form-view");
                targetInput = document.getElementById("widget-tax-id");
            }

            // Hedef bulunduysa iÅŸlemi yap
            if (targetContainer && targetInput) {
                // A. SayfayÄ± oraya kaydÄ±r (Ortalayarak)
                targetInput.scrollIntoView({ behavior: "smooth", block: "center" });

                // B. Ä°mleci iÃ§ine koy
                targetInput.focus({ preventScroll: true });

                // C. Animasyonu SÄ±fÄ±rla ve Yeniden BaÅŸlat (Reflow Trigger)
                targetContainer.classList.remove("attention-grabber");
                
                // Bu satÄ±r sihirli: TarayÄ±cÄ±yÄ± deÄŸiÅŸikliÄŸi fark etmeye zorlar
                void targetContainer.offsetWidth; 
                
                targetContainer.classList.add("attention-grabber");

                // D. 1 saniye sonra efekti kaldÄ±r (Tekrar basÄ±lÄ±rsa Ã§alÄ±ÅŸsÄ±n diye)
                setTimeout(() => {
                    targetContainer.classList.remove("attention-grabber");
                }, 1000);
            }
        }, 100); 

    } 
    // Free ise YÃ¼kseltme ModalÄ±nÄ± AÃ§
    else {
        toggleModal('modal-upgrade');
    }
}
// 2. GÃ–RÃœNÃœMÃœ GÃœNCELLE (YardÄ±mcÄ± Fonksiyon)
function toggleVerifyVisibility(mode) {
    // EditÃ¶r Elementleri
    const editLock = document.getElementById("verify-locked-view");
    const editForm = document.getElementById("verify-form-view");
    
    // Profil Widget Elementleri
    const widgetLock = document.getElementById("widget-locked-view");
    const widgetForm = document.getElementById("widget-form-view");

    if (mode === 'unlocked') {
        if(editLock) editLock.classList.add("hidden");
        if(editForm) editForm.classList.remove("hidden");
        if(widgetLock) widgetLock.classList.add("hidden");
        if(widgetForm) widgetForm.classList.remove("hidden");
    } else {
        if(editLock) editLock.classList.remove("hidden");
        if(editForm) editForm.classList.add("hidden");
        if(widgetLock) widgetLock.classList.remove("hidden");
        if(widgetForm) widgetForm.classList.add("hidden");
    }
}

// 3. FORM GÃ–NDERME (Kaynaktan BaÄŸÄ±msÄ±z)
async function submitVerificationRequest(source = 'editor') {
    // Hangi butona basÄ±ldÄ±ysa onu yÃ¼kleniyor yap
    const btnId = source === 'widget' ? "btn-widget-submit" : "btn-verify-submit";
    const btn = document.getElementById(btnId);
    
    // Veriyi doÄŸru inputtan al
    let taxId, duns;
    if (source === 'widget') {
        taxId = document.getElementById("widget-tax-id").value.trim();
        duns = document.getElementById("widget-duns").value.trim();
    } else {
        taxId = document.getElementById("edit-tax-id").value.trim();
        duns = document.getElementById("edit-duns").value.trim();
    }

    if (!taxId) { 
  showToast("Missing Info", "Enter Tax ID.", "error"); 
  handleVerifyClick(source === 'widget');   // âœ… boÅŸsa VKN alanÄ±nÄ± sallayÄ±p fokuslar
  return; 
}


    if(btn) { btn.textContent = "Wait..."; btn.disabled = true; }

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        const { error } = await supabaseClient.from('profiles')
            .update({ tax_id: taxId, duns_number: duns, verification_status: 'pending' })
            .eq('id', user.id);

        if (error) throw error;

        // HafÄ±zayÄ± GÃ¼ncelle
        selectedCompany.verification_status = 'pending';
        selectedCompany.tax_id = taxId;
        selectedCompany.duns_number = duns;

        // HER Ä°KÄ° TARAFI DA GÃœNCELLE (Sync)
        updateVerificationUI('pending');
        
        // InputlarÄ± da eÅŸitle (DiÄŸer tarafa da yaz)
        const eTax = document.getElementById("edit-tax-id");
        const wTax = document.getElementById("widget-tax-id");
        const eDuns = document.getElementById("edit-duns");
        const wDuns = document.getElementById("widget-duns");
        
        if(eTax) eTax.value = taxId;
        if(wTax) wTax.value = taxId;
        if(eDuns) eDuns.value = duns;
        if(wDuns) wDuns.value = duns;

        showToast("Success", "Request sent for review.", "success");

    } catch (err) {
        showToast("Error", err.message, "error");
        if(btn) { btn.disabled = false; btn.textContent = "SUBMIT"; }
    }
}

// 4. UI DURUMUNU GÃœNCELLE (Her Ä°ki Yeri De Boyar)
/* --- GÃœNCELLENMÄ°Åž: updateVerificationUI (ONAYLANINCA KUTULARI GÄ°ZLER) --- */
function updateVerificationUI(status) {
    const tier = selectedCompany.subscription_tier || 'free';
    
    // Pro ise veya iÅŸlem baÅŸladÄ±ysa formu aÃ§
    if (tier === 'pro' || status === 'pending' || status === 'verified') {
        toggleVerifyVisibility('unlocked');
    } else {
        toggleVerifyVisibility('locked');
        return; 
    }

    // --- EDÄ°TÃ–R TARAFI ---
    const editAlert = document.getElementById("verify-status-alert");
    // EditÃ¶rdeki inputlarÄ±n olduÄŸu kapsayÄ±cÄ± (.grid)
    const editInputBox = document.querySelector("#verify-form-view .grid"); 
    // EditÃ¶rdeki butonun olduÄŸu kapsayÄ±cÄ± (.mt-4)
    const editBtnBox = document.querySelector("#verify-form-view .mt-4");

    // --- WIDGET (PROFÄ°L) TARAFI ---
    const widgetAlert = document.getElementById("widget-status-alert");
    // Widget'taki inputlar ve butonun olduÄŸu kapsayÄ±cÄ± (.space-y-3)
    const widgetMainBox = document.querySelector("#widget-form-view .space-y-3");
    // Widget butonu (Pending durumunda sadece butonu gizlemek iÃ§in lazÄ±m)
    const widgetBtn = document.getElementById("btn-widget-submit");

    // YardÄ±mcÄ± Fonksiyon: Duruma GÃ¶re GÃ¶ster/Gizle
    const setStatus = (alertEl, inputBox, btnBox, specificBtn, type) => {
        if(!alertEl) return;
        
        // Alert Stili (Ortak)
        alertEl.className = "mb-3 p-3 rounded-lg text-[10px] font-bold border flex items-center gap-2";

        if (type === 'verified') {
            // âœ… DURUM 1: ONAYLI (Sadece Mesaj KalsÄ±n, Formlar UÃ§sun)
            alertEl.classList.add("bg-emerald-50", "border-emerald-200", "text-emerald-700");
            alertEl.innerHTML = '<i class="fa-solid fa-circle-check"></i> Verified. Badge active.';
            alertEl.classList.remove("hidden");

            // Form elemanlarÄ±nÄ± komple GÄ°ZLE
            if(inputBox) inputBox.classList.add("hidden");
            if(btnBox) btnBox.classList.add("hidden");
            
            // Widget iÃ§in mainBox gizlenince iÃ§indeki buton da otomatik gizlenir
            if(specificBtn) specificBtn.parentElement.classList.add("hidden"); 

        } else if (type === 'pending') {
            // âœ… DURUM 2: BEKLEMEDE (Mesaj Var, Inputlar Pasif, Buton Yok)
            alertEl.classList.add("bg-amber-50", "border-amber-200", "text-amber-700");
            alertEl.innerHTML = '<i class="fa-solid fa-clock"></i> Review pending (24h).';
            alertEl.classList.remove("hidden");

            // InputlarÄ± gÃ¶ster ama kilitle
            if(inputBox) {
                inputBox.classList.remove("hidden");
                const inputs = inputBox.querySelectorAll("input");
                inputs.forEach(i => i.disabled = true);
            }

            // Kaydet butonunu gizle (Zaten gÃ¶nderildi)
            if(btnBox) btnBox.classList.add("hidden");
            if(specificBtn) specificBtn.classList.add("hidden");

        } else {
            // âœ… DURUM 3: HÄ°Ã‡BÄ°RÄ° (Form AÃ§Ä±k, Mesaj Yok)
            alertEl.classList.add("hidden"); // UyarÄ± yok

            if(inputBox) {
                inputBox.classList.remove("hidden");
                const inputs = inputBox.querySelectorAll("input");
                inputs.forEach(i => i.disabled = false);
            }

            if(btnBox) btnBox.classList.remove("hidden");
            if(specificBtn) specificBtn.classList.remove("hidden");
        }
    };

    // EditÃ¶r UI GÃ¼ncelle
    setStatus(editAlert, editInputBox, editBtnBox, null, status);
    
    // Widget (Profil) UI GÃ¼ncelle
    setStatus(widgetAlert, widgetMainBox, null, widgetBtn, status);
}
/* --- ADMIN PANEL SÄ°STEMÄ° --- */

// 1. AYARLAR


// 2. ADMIN KONTROLÃœ (GiriÅŸ yapÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r)
async function checkAdminAccess() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    const adminBtn = document.getElementById("btn-admin-panel");
    
    if (user && user.email === ADMIN_EMAIL) {
        if(adminBtn) adminBtn.classList.remove("hidden");
    } else {
        if(adminBtn) adminBtn.classList.add("hidden");
    }
}

// checkUserAndOpenProfile fonksiyonunun en sonuna ÅŸu satÄ±rÄ± ekleyin:
// checkAdminAccess(); 
// (Bunu manuel eklemeyi unutmayÄ±n, yoksa buton Ã§Ä±kmaz)


// 3. ADMIN PANELÄ°NÄ° AÃ‡MA
function showAdminView() {
    // DiÄŸer ekranlarÄ± gizle
    document.getElementById("view-dashboard").classList.add("hidden-view");
    document.getElementById("view-profile").classList.add("hidden-view");
    document.getElementById("view-editor").classList.add("hidden-view");
    document.getElementById("view-admin").classList.remove("hidden-view");
    
    // Verileri yÃ¼kle
    loadAdminData();
}


// 4. BEKLEYEN Ä°STEKLERÄ° Ã‡EKME
async function loadAdminData() {
    const listContainer = document.getElementById("admin-request-list");
    const countBadge = document.getElementById("admin-pending-count");
    
    listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-gray-300"></i></td></tr>';

    // Supabase'den 'pending' olanlarÄ± Ã§ek
    const { data: requests, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('verification_status', 'pending')
        .order('updated_at', { ascending: false });

    if (error) {
        console.error(error);
        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>';
        return;
    }

    if (countBadge) countBadge.textContent = requests.length;

    if (requests.length === 0) {
        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No pending requests found.</td></tr>';
        return;
    }

    listContainer.innerHTML = "";

    requests.forEach(req => {
        // Belge Linki (Varsa)
        let docLink = '<span class="text-gray-300 text-xs">No file</span>';
        if (req.verification_docs_url) {
            docLink = `<a href="${req.verification_docs_url}" target="_blank" class="flex items-center gap-1 text-blue-600 hover:underline font-bold text-xs"><i class="fa-solid fa-file-pdf"></i> View Doc</a>`;
        } else if (req.duns_number) {
             docLink = `<span class="text-xs text-gray-500">DUNS: ${req.duns_number}</span>`;
        }

        const dateStr = new Date(req.updated_at).toLocaleDateString() + " " + new Date(req.updated_at).toLocaleTimeString();

        const row = document.createElement("tr");
        row.className = "hover:bg-slate-50 transition";
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gray-200 flex items-center justify-center font-bold text-gray-500">
                        ${req.company_name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">${req.company_name}</div>
                        <div class="text-[10px] text-gray-400">${req.email}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="font-mono text-xs bg-gray-100 px-2 py-1 rounded inline-block text-gray-600">
                    ${req.tax_id || 'N/A'}
                </div>
            </td>
            <td class="px-6 py-4 text-xs text-gray-500">${dateStr}</td>
            <td class="px-6 py-4">${docLink}</td>
            <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                    <button onclick="processVerification('${req.id}', 'reject')" class="w-8 h-8 rounded-lg border border-red-200 text-red-500 hover:bg-red-50 transition flex items-center justify-center" title="Reject">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <button onclick="processVerification('${req.id}', 'approve')" class="px-4 py-2 rounded-lg bg-emerald-500 text-white font-bold text-xs hover:bg-emerald-600 transition shadow-lg shadow-emerald-500/20 flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> APPROVE (Pro)
                    </button>
                </div>
            </td>
        `;
        listContainer.appendChild(row);
    });
}


// 5. ONAYLAMA / REDDETME Ä°ÅžLEMÄ°
async function processVerification(userId, action) {
    // KullanÄ±cÄ±ya sor
    if (!confirm(`Are you sure you want to ${action} this company?`)) return;

    let updates = {};

    if (action === 'approve') {
        // 3 Ay sonrasÄ±nÄ± hesapla
        const endDate = new Date();
        endDate.setMonth(endDate.getMonth() + 3);

        updates = {
            verification_status: 'verified',
            subscription_tier: 'pro',
            subscription_status: 'active_trial',
            trial_end_date: endDate.toISOString()
        };
    } else {
        updates = {
            verification_status: 'rejected',
            // Reddedilince Pro'yu almÄ±yoruz, sadece doÄŸrulamayÄ± reddediyoruz.
            // Ama isterseniz subscription_tier: 'free' de yapabilirsiniz.
        };
    }

    // VeritabanÄ±nÄ± gÃ¼ncelle
    const { error } = await supabaseClient
        .from('profiles')
        .update(updates)
        .eq('id', userId);

    if (error) {
        alert("Error: " + error.message);
    } else {
        showToast("Success", `Company ${action}d successfully.`, "success");
        loadAdminData(); // Listeyi yenile
    }
}

/* --- GÃœNCELLENMÄ°Åž: upgradeToPro (ANINDA BUTON GÄ°ZLEME) --- */
async function upgradeToPro() {
    const btn = document.querySelector("#modal-upgrade button:last-child");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
    btn.disabled = true;

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Please login first.");

        // --- TARÄ°H HESAPLAMA ---
        const now = new Date();
        const endDate = new Date();
        endDate.setMonth(now.getMonth() + 6); // 6 AY EKLE

        // 1. VeritabanÄ± GÃ¼ncellemesi
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                subscription_tier: 'pro',
                subscription_status: 'active_trial',
                trial_start_date: now.toISOString(),
                trial_end_date: endDate.toISOString(),
                updated_at: now
            })
            .eq('id', user.id);

        if (error) throw error;

        // 2. Yerel HafÄ±zayÄ± GÃ¼ncelle
        if (selectedCompany) {
            selectedCompany.subscription_tier = 'pro';
        }

        // 3. ModalÄ± Kapat
        toggleModal('modal-upgrade'); 

        // 4. â­ SÄ°HÄ°RLÄ° DOKUNUÅž: UPGRADE BUTONLARINI ANINDA GÄ°ZLE â­
        const navBtn = document.getElementById("btn-nav-upgrade");
        const cardBtn = document.getElementById("btn-card-upgrade");
        
        // Header'daki TacÄ± Gizle
        if (navBtn) {
            navBtn.classList.add("hidden");
            navBtn.classList.remove("flex");
        }
        // Profil KartÄ±ndaki "Go Pro"yu Gizle
        if (cardBtn) {
            cardBtn.classList.add("hidden");
            cardBtn.classList.remove("flex");
        }

        // 5. Verify KutularÄ±nÄ±n Kilidini AÃ§ (ArtÄ±k Pro olduÄŸu iÃ§in)
        // EÄŸer verification durumu yoksa 'none' gÃ¶nderiyoruz
        updateVerificationUI(selectedCompany.verification_status || 'none');
        
        // 6. KullanÄ±cÄ±yÄ± Bilgilendir
        const niceDate = endDate.toLocaleDateString(); 
        showToast("Welcome to Pro!", `Trial active until ${niceDate}`, "success");
        
        // 7. Profili Yeniden Ã‡iz (Rozetler vs. iÃ§in)
        openProfile(user.id);
	setTimeout(() => handleVerifyClick(true), 700);
    } catch (err) {
        console.error(err);
        showToast("Error", "Upgrade failed: " + err.message, "error");
    } finally {
        if(btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

/* --- KUTLAMA MANTIÄžI --- */

// 1. Durumu Kontrol Et ve Kutla
function checkAndTriggerCelebration(company) {
    // Sadece 'verified' statÃ¼sÃ¼ndekiler iÃ§in
    if (company.verification_status === 'verified') {
        
        // Daha Ã¶nce kutladÄ±k mÄ±? (TarayÄ±cÄ± hafÄ±zasÄ±na bak)
        const hasSeen = localStorage.getItem(`celebrated_${company.id}`);
        
        // EÄŸer daha Ã¶nce gÃ¶rmediyse KUTLA!
        if (!hasSeen) {
            openCelebrationModal();
        }
    }
}

// 2. ModalÄ± AÃ§ ve Konfeti Patlat
/* --- GÃœNCELLENMÄ°Åž: openCelebrationModal (SADE VE KURUMSAL) --- */
function openCelebrationModal() {
    const modal = document.getElementById("modal-celebration");
    const card = document.getElementById("celebration-card");
    
    if(!modal) return;

    // ModalÄ± GÃ¶ster
    modal.classList.remove("opacity-0", "pointer-events-none");
    if(card) {
        card.classList.remove("scale-90");
        card.classList.add("scale-100");
    }

    // BURADAKÄ° KONFETÄ° KODLARINI SÄ°LDÄ°K (Daha profesyonel durmasÄ± iÃ§in)
}
// 3. ModalÄ± Kapat ve Kaydet
function closeCelebration() {
    const modal = document.getElementById("modal-celebration");
    if(modal) modal.classList.add("opacity-0", "pointer-events-none");
    
    // HafÄ±zaya kaydet ki tekrar tekrar Ã§Ä±kmasÄ±n
    if(selectedCompany) {
        localStorage.setItem(`celebrated_${selectedCompany.id}`, "true");
    }
}

// --- GALERÄ° (LIGHTBOX) FONKSÄ°YONLARI ---
function openGallery(title, urls) {
    const modal = document.getElementById("modal-gallery");
    const mainImg = document.getElementById("gallery-main-img");
    const thumbs = document.getElementById("gallery-thumbs");
    const caption = document.getElementById("gallery-caption");

    if(!modal) return;
    
    // Ä°lk resmi aÃ§
    mainImg.src = urls[0];
    caption.textContent = `${title} (1/${urls.length})`;

    // KÃ¼Ã§Ã¼k resimleri oluÅŸtur
    thumbs.innerHTML = "";
    urls.forEach((url, index) => {
        const thumb = document.createElement("img");
        thumb.src = url;
        thumb.className = "h-16 w-24 object-cover rounded cursor-pointer border-2 border-transparent hover:border-white transition opacity-70 hover:opacity-100";
        
        // TÄ±klayÄ±nca ana resmi deÄŸiÅŸtir
        thumb.onclick = () => {
            mainImg.src = url;
            caption.textContent = `${title} (${index + 1}/${urls.length})`;
        };
        thumbs.appendChild(thumb);
    });

    modal.classList.remove("opacity-0", "pointer-events-none");
}

function closeGallery() {
    const modal = document.getElementById("modal-gallery");
    if(modal) modal.classList.add("opacity-0", "pointer-events-none");
}

/* --- SERTÄ°FÄ°KA DOSYA YÃ–NETÄ°MÄ° --- */
let currentCertFile = null;
let existingCertFileUrl = null;

function handleCertFileSelect(input) {
    if (input.files && input.files[0]) {
        if (input.files[0].size > 5 * 1024 * 1024) {
            showToast("Too Large", "Max file size is 5MB.", "error");
            input.value = "";
            return;
        }
        currentCertFile = input.files[0];
        document.getElementById("cert-file-text").textContent = currentCertFile.name;
        document.getElementById("cert-file-label").classList.add("border-BTrustOn-accent", "bg-cyan-50");
    }
}

function removeCertFile() {
    currentCertFile = null;
    existingCertFileUrl = null;
    document.getElementById("cert-file-input").value = "";
    document.getElementById("cert-file-text").textContent = "Attach Proof (Max 5MB)";
    document.getElementById("cert-file-label").classList.remove("border-BTrustOn-accent", "bg-cyan-50");
    document.getElementById("btn-remove-cert-file").classList.add("hidden");
    document.getElementById("current-cert-link").classList.add("hidden");
}
async function deleteLogo() {
    if(!confirm("Remove company logo?")) return;

    // UI Temizle
    document.getElementById("edit-logo-img").src = "";
    document.getElementById("edit-logo-img").classList.add("hidden");
    document.getElementById("edit-logo-icon").classList.remove("hidden");
    selectedLogoFile = null; // SeÃ§ili dosyayÄ± iptal et

    // VeritabanÄ±ndan Sil
    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { error } = await supabaseClient
            .from('profiles')
            .update({ logo_url: null, updated_at: new Date() })
            .eq('id', user.id);

        if(error) throw error;
        
        // Local hafÄ±zayÄ± gÃ¼ncelle
        if(selectedCompany) selectedCompany.logo_url = null;
        const localC = database.find(c => c.id == user.id);
        if(localC) localC.logo_url = null;
        
        showToast("Removed", "Logo removed successfully.", "success");

    } catch(e) {
        console.error(e);
        showToast("Error", "Could not remove logo.", "error");
    }
}
let selectedOwnerFile = null;

function toggleOwnerSection() {
    const isChecked = document.getElementById("edit-owner-toggle").checked;
    const box = document.getElementById("owner-inputs");
    if(isChecked) box.classList.remove("hidden");
    else box.classList.add("hidden");
}

function handleOwnerPhoto(input) {
    if (input.files && input.files[0]) {
        selectedOwnerFile = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById("preview-owner-img").src = e.target.result;
            document.getElementById("preview-owner-img").classList.remove("hidden");
            document.getElementById("icon-owner-img").classList.add("hidden");
        }
        reader.readAsDataURL(selectedOwnerFile);
    }
}

function deleteOwnerPhoto() {
    selectedOwnerFile = null;
    document.getElementById("edit-owner-photo").value = "";
    document.getElementById("preview-owner-img").src = "";
    document.getElementById("preview-owner-img").classList.add("hidden");
    document.getElementById("icon-owner-img").classList.remove("hidden");
    // Not: DB'den silme iÅŸlemi "Save" butonuna basÄ±nca yapÄ±lacak
}




/* =========================
   PROJECTS UX IMPROVEMENTS
   - Click any project -> viewer modal
   - Search + Sort (client-side, DOM reorder)
========================= */
let __pvProject = null;

function openProjectViewer(projectId){
  const arr = window.__projectsCache || (selectedCompany ? selectedCompany.projects : []) || [];
  const p = arr.find(x => String(x.id) === String(projectId));
  if(!p) return;

  __pvProject = p;

  const title = p.title || "Project";
  const loc = p.loc || "";
  const desc = (p.desc && String(p.desc).trim()) ? p.desc : "No description provided.";
  const cover = p.cover_url || "https://placehold.co/1200x675/f1f5f9/94a3b8?text=Project+Image";
  const urls = Array.isArray(p.gallery_urls) ? p.gallery_urls : [];

  const tEl = document.getElementById("pv-title");
  const mEl = document.getElementById("pv-meta");
  const dEl = document.getElementById("pv-desc");
  const cEl = document.getElementById("pv-cover");
  const btnCover = document.getElementById("pv-cover-btn");
  const infoEl = document.getElementById("pv-gallery-info");
  const btnGal = document.getElementById("pv-open-gallery");
  const thumbs = document.getElementById("pv-thumbs");

  if(tEl) tEl.textContent = title;
  if(mEl) mEl.textContent = loc ? `ðŸ“ ${loc}` : "";
  if(dEl) dEl.textContent = desc;
  if(cEl) cEl.src = cover;

  if(infoEl) infoEl.textContent = urls.length ? `${urls.length} images` : "No gallery images.";
  if(btnGal){
    if(urls.length) btnGal.classList.remove("hidden");
    else btnGal.classList.add("hidden");
  }

  // Cover click opens gallery only if exists
  if(btnCover){
    if(urls.length){
      btnCover.classList.add("cursor-pointer");
      btnCover.onclick = () => openGallery(title, urls);
      btnCover.title = "Click to view gallery";
    }else{
      btnCover.classList.remove("cursor-pointer");
      btnCover.onclick = null;
      btnCover.title = "";
    }
  }

  if(thumbs){
    thumbs.innerHTML = "";
    if(urls.length){
      urls.slice(0, 12).forEach(u => {
        const b = document.createElement("button");
        b.className = "rounded-lg overflow-hidden border border-gray-200 hover:border-BTrustOn-accent transition";
        b.innerHTML = `<img src="${u}" class="w-full h-16 object-cover">`;
        b.onclick = () => openGallery(title, urls);
        thumbs.appendChild(b);
      });
    }
  }

  const modal = document.getElementById("project-viewer");
  if(modal) modal.classList.remove("hidden");
}

function openProjectViewerGallery(){
  if(!__pvProject) return;
  const urls = Array.isArray(__pvProject.gallery_urls) ? __pvProject.gallery_urls : [];
  if(urls.length) openGallery(__pvProject.title || "Gallery", urls);
}

function closeProjectViewer(){
  const modal = document.getElementById("project-viewer");
  if(modal) modal.classList.add("hidden");
  __pvProject = null;
}

function filterProjectsUI(q){
  q = (q||"").toLowerCase().trim();
  const list = document.getElementById("p-projects-list");
  if(!list) return;
  [...list.children].forEach(card => {
    const hay = (card.dataset && card.dataset.hay ? card.dataset.hay : "").toLowerCase();
    card.style.display = (!q || hay.includes(q)) ? "" : "none";
  });
}

function sortProjectsUI(mode){
  const list = document.getElementById("p-projects-list");
  if(!list) return;
  const cards = [...list.children].filter(el => el.dataset && el.dataset.pid);
  const getTitle = (el) => (el.dataset.title || "").toLowerCase();
  const getCreated = (el) => parseFloat(el.dataset.created || "0") || 0;

  if(mode === "az") cards.sort((a,b)=> getTitle(a).localeCompare(getTitle(b)));
  else if(mode === "oldest") cards.sort((a,b)=> getCreated(a) - getCreated(b));
  else cards.sort((a,b)=> getCreated(b) - getCreated(a)); // newest default

  cards.forEach(c => list.appendChild(c));
}


</script>
</html>